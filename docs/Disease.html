<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Disease-spatial patterns | Spatio-Temporal Methods in Environmental Epidemiology with R</title>
  <meta name="description" content="Chapter 9 Disease-spatial patterns | Spatio-Temporal Methods in Environmental Epidemiology with R" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Disease-spatial patterns | Spatio-Temporal Methods in Environmental Epidemiology with R" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/img/cover.jpg" />
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Disease-spatial patterns | Spatio-Temporal Methods in Environmental Epidemiology with R" />
  
  
  <meta name="twitter:image" content="/img/cover.jpg" />

<meta name="author" content="Gavin Shaddick, James V. Zidek, and Alexandra M. Schmidt" />


<meta name="date" content="2023-07-05" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<link rel="prev" href="trusted.html"/>
<link rel="next" href="hazards.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatio-temporal methods in environmental epidemiology</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="preface-2nd-edition.html"><a href="preface-2nd-edition.html"><i class="fa fa-check"></i>Preface (2nd edition)</a></li>
<li class="chapter" data-level="1" data-path="why.html"><a href="why.html"><i class="fa fa-check"></i><b>1</b> Why spatio-temporal epidemiology?</a></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> Epidemiology-the basics</a>
<ul>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.7-estimating-the-smr-using-a-poisson-glm"><i class="fa fa-check"></i>Example 2.7: Estimating the SMR using a Poisson GLM</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.8-estimating-the-smr-using-quasi-likelihood"><i class="fa fa-check"></i>Example 2.8: Estimating the SMR using quasi-likelihood</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.9-modelling-differences-in-smrs-in-relation-to-differences-in-exposures"><i class="fa fa-check"></i>Example 2.9: Modelling differences in SMRs in relation to differences in exposures</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.10-modelling-the-risks-associated-with-lagged-effects-of-air-pollution"><i class="fa fa-check"></i>Example 2.10: Modelling the risks associated with lagged effects of air pollution</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.10-estimating-the-odds-ratio-in-a-case-control-study-using-a-logistic-model"><i class="fa fa-check"></i>Example 2.10: Estimating the odds ratio in a case-control study using a logistic model</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.11-estimating-the-odds-ratio-of-asthma-associated-with-proximity-to-roads"><i class="fa fa-check"></i>Example 2.11: Estimating the odds ratio of asthma associated with proximity to roads</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="uncertainty.html"><a href="uncertainty.html"><i class="fa fa-check"></i><b>3</b> Uncertainty and its reduction</a>
<ul>
<li class="chapter" data-level="" data-path="uncertainty.html"><a href="uncertainty.html#supplementary-material"><i class="fa fa-check"></i>Supplementary Material</a>
<ul>
<li class="chapter" data-level="" data-path="uncertainty.html"><a href="uncertainty.html#more-on-qualitative-uncertainty"><i class="fa fa-check"></i>More on qualitative uncertainty</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>4</b> Data: increasing information and reducing uncertainty</a>
<ul>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#getting-to-know-the-structure-of-dataframes"><i class="fa fa-check"></i>Getting to know the structure of dataframes</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#extracting-and-creating-variables"><i class="fa fa-check"></i>Extracting and creating variables</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="embracing.html"><a href="embracing.html"><i class="fa fa-check"></i><b>5</b> Embracing uncertainty: the Bayesian approach</a></li>
<li class="chapter" data-level="6" data-path="tactics.html"><a href="tactics.html"><i class="fa fa-check"></i><b>6</b> Tactics-implementing uncertainty models</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.2-chronic-obstructive-pulmonary-disease-copd-in-england"><i class="fa fa-check"></i>Example 6.2: Chronic obstructive pulmonary disease (COPD) in England</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-the-raw-standardized-mortality-rates-smrs"><i class="fa fa-check"></i>Modelling the raw standardized mortality rates (SMRs)</a></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-a-poisson-gamma-with-an-mcmc-implemented-in-r"><i class="fa fa-check"></i>Modelling a Poisson-Gamma with an MCMC implemented in <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.3-fitting-a-poisson-regression-model"><i class="fa fa-check"></i>Example 6.3: Fitting a Poisson regression model</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#nimble"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#stan"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Strategies.html"><a href="Strategies.html"><i class="fa fa-check"></i><b>7</b> Strategies implementing uncertainty models</a>
<ul>
<li class="chapter" data-level="" data-path="Strategies.html"><a href="Strategies.html#example-7.6-model-choice-in-studies-of-air-pollution-and-health"><i class="fa fa-check"></i>Example 7.6 Model choice in studies of air pollution and health</a>
<ul>
<li class="chapter" data-level="" data-path="Strategies.html"><a href="Strategies.html#nimble-1"><i class="fa fa-check"></i>Nimble</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="trusted.html"><a href="trusted.html"><i class="fa fa-check"></i><b>8</b> But can the data be trusted</a>
<ul>
<li class="chapter" data-level="" data-path="trusted.html"><a href="trusted.html#solutions-to-selected-exercises"><i class="fa fa-check"></i>Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="trusted.html"><a href="trusted.html#placeholder-repeat-the-black-smoke-analysis-conducted-in-watson-et-al.-2019.-in-the-naive-model."><i class="fa fa-check"></i>PLACEHOLDER: Repeat the Black Smoke analysis conducted in Watson et al. 2019. in the “naive” model.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="Disease.html"><a href="Disease.html"><i class="fa fa-check"></i><b>9</b> Disease-spatial patterns</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010"><i class="fa fa-check"></i>Example 9.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-2"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-1"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-stan"><i class="fa fa-check"></i>Example 9.3: Fitting a conditional spatial model in <code>nimble</code> and <code>stan</code></a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-3"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-2"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.4-fitting-a-conditional-spatial-model-using-carbayes"><i class="fa fa-check"></i>Example 9.4: Fitting a conditional spatial model using CARBayes</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.5-fitting-a-conditional-model-using-inla"><i class="fa fa-check"></i>Example 9.5: Fitting a conditional model using INLA</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="hazards.html"><a href="hazards.html"><i class="fa fa-check"></i><b>10</b> Environmental hazards-spatial models</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.1-spatial-patterns-in-lead-concentrations-in-the-soil-of-the-meuse-river-flood-plain"><i class="fa fa-check"></i>Example 10.1 Spatial patterns in lead concentrations in the soil of the Meuse River flood plain</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.2-examining-the-log-concentrations-of-lead-in-the-meuse-river-flood-plain"><i class="fa fa-check"></i>Example 10.2: Examining the log concentrations of lead in the Meuse River flood plain</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state"><i class="fa fa-check"></i>Example 10.3: Mapping the locations of ozone monitoring sites in New York State</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.6-spatial-prediction-of-temperatures-in-california"><i class="fa fa-check"></i>Example 10.6: Spatial prediction of temperatures in California</a></li>
<li class="chapter" data-level="10.1" data-path="hazards.html"><a href="hazards.html#example-10.8-spatial-prediction-of-no2-in-europe"><i class="fa fa-check"></i><b>10.1</b> Example 10.8 Spatial prediction of NO2 in Europe</a></li>
<li class="chapter" data-level="10.2" data-path="hazards.html"><a href="hazards.html#example-10.12-plotting-directional-variograms-for-temperatures-in-california"><i class="fa fa-check"></i><b>10.2</b> Example 10.12 Plotting directional variograms for temperatures in California</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.14-spatial-modeling-of-malaria-in-gambia"><i class="fa fa-check"></i>Example 10.14: Spatial modeling of malaria in Gambia</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-4"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-3"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#supplementary-material-1"><i class="fa fa-check"></i>Supplementary Material</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada"><i class="fa fa-check"></i>Extra 10.1: Spatial patterns of benzene concentrations in Montreal, QC, Canada</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.2-examining-the-log-concentrations-of-benzene-in-montreal"><i class="fa fa-check"></i>Extra 10.2: Examining the log concentrations of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.5-variogram"><i class="fa fa-check"></i>Extra 10.5: Variogram</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal"><i class="fa fa-check"></i>Extra 10.6 Basic spatial modelling and prediction of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.8-spatial-modelling-of-benzene-in-montreal"><i class="fa fa-check"></i>Extra 10.8 Spatial modelling of Benzene in Montreal</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-5"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-4"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.9-spatial-predictions"><i class="fa fa-check"></i>Extra 10.9: Spatial predictions</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-6"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-5"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.10-inla-creating-a-mesh"><i class="fa fa-check"></i>Extra 10.10: INLA, creating a mesh</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal"><i class="fa fa-check"></i>Extra 10.12: Fitting an SPDE model using R–INLA: benzene concentration in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.13-directional-variograms"><i class="fa fa-check"></i>Extra 10.13: Directional variograms</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="Time.html"><a href="Time.html"><i class="fa fa-check"></i><b>11</b> Time-why it also matters</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.1-ground-level-ozone-concentrations"><i class="fa fa-check"></i>Example 11.1 Ground level ozone concentrations</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.2-low-pass-filtering-of-carbon-monoxide-levels-using-the-moving-average"><i class="fa fa-check"></i>Example 11.2 Low-pass filtering of carbon monoxide levels using the moving average</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.13-forecasting-ozone-levels"><i class="fa fa-check"></i>Example 11.13 Forecasting ozone levels</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.14-forecasting-volcanic-ash"><i class="fa fa-check"></i>Example 11.14 Forecasting volcanic ash</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="exposure.html"><a href="exposure.html"><i class="fa fa-check"></i><b>12</b> Exposure assessment-over space and time</a>
<ul>
<li class="chapter" data-level="" data-path="exposure.html"><a href="exposure.html#example-idk-spatio-temporal-model-for-the-uk-ozone-data"><i class="fa fa-check"></i>Example IDK: Spatio-temporal model for the UK ozone data</a>
<ul>
<li class="chapter" data-level="" data-path="exposure.html"><a href="exposure.html#nimble-7"><i class="fa fa-check"></i>Nimble</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="causality.html"><a href="causality.html"><i class="fa fa-check"></i><b>13</b> Causality-roadblocks on the way to it</a>
<ul>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#solutions-to-selected-exercises-1"><i class="fa fa-check"></i>Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.16-load-the-italy-and-china-data-described-in-example-13.3-and-included-in-the-supplementary-bookdown-material-into-r."><i class="fa fa-check"></i>Question 13.16: Load the Italy and China data, described in Example 13.3, and included in the supplementary Bookdown material into R.</a></li>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.17-using-the-italy-and-china-data-stratified-by-the-age-groups-70-and-geq-70-obtain-empirical-estimates-of-p_1-and-p_2-as-defined-in-an-sdis.-in-the-following-questions-assume-that-p_1-and-p_2-are-the-population-values."><i class="fa fa-check"></i>Question 13.17: Using the Italy and China data stratified by the age groups <span class="math inline">\(&lt;70\)</span> and <span class="math inline">\(\geq 70\)</span>, obtain empirical estimates of <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span>, as defined in an SDis. In the following questions, assume that <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> are the population values.</a></li>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.18-stratify-the-italy-and-china-data-by-the-age-groups-50-and-geq-50.-display-the-corresponding-contingency-tables."><i class="fa fa-check"></i>Question 13.18: Stratify the Italy and China data by the age groups <span class="math inline">\(&lt;50\)</span> and <span class="math inline">\(\geq 50\)</span>. Display the corresponding contingency tables.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="monitoring.html"><a href="monitoring.html"><i class="fa fa-check"></i><b>14</b> Better monitoring network design-getting better measurements</a></li>
<li class="chapter" data-level="15" data-path="frontiers.html"><a href="frontiers.html"><i class="fa fa-check"></i><b>15</b> Current frontiers</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html"><i class="fa fa-check"></i>Course</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatio-Temporal Methods in Environmental Epidemiology with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="Disease" class="section level1 hasAnchor" number="9">
<h1><span class="header-section-number">Chapter 9</span> Disease-spatial patterns<a href="Disease.html#Disease" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter introduces disease mapping and contains the theory for spatial lattice processes and models for performing smoothing of risks over space. From this chapter, the reader will have gained an understanding of the following topics:</p>
<ul>
<li>Disease mapping, where we have seen how to improve estimates of risk by borrowing strength from adjacent regions which can reduce the instability inherent in risk estimates (SMRs) based on small expected numbers.</li>
<li>Seen how smoothing can be performed using either the empirical Bayes or fully Bayesian approaches.</li>
<li>Been introduced to computational methods for handling areal data.</li>
<li>Learned about Besag’s seminal contributions to the field of spatial statistics including the very important concept of a Markov random field.</li>
<li>Explored approaches to modelling a real data including the conditional auto regressive models.</li>
<li>Seen how Bayesian spatial models for lattice data use <code>nimble</code>, <code>stan</code>, <code>R</code> and <code>R–INLA</code>.</li>
</ul>
<div id="example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010" class="section level2 unnumbered hasAnchor">
<h2>Example 9.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010<a href="Disease.html#example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This example uses the <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/englandlocalauthority.shp">englandlocalauthority.shp</a>, <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityobserved.csv">copdmortalityobserved.csv</a>, and
<a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityexpected.csv">copdmortalityexpected.csv</a> datasets from Chapter 6.</p>
<div id="nimble-2" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="Disease.html#nimble-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Following Example 6.2 we look back at the hospital admission rates for COPD, in England for 2010. We can implement the same model we used on Example 6.2 using <code>nimble</code>.</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="Disease.html#cb123-1" tabindex="-1"></a><span class="co"># Load nimble</span></span>
<span id="cb123-2"><a href="Disease.html#cb123-2" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb123-3"><a href="Disease.html#cb123-3" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># to read shapefile</span></span>
<span id="cb123-4"><a href="Disease.html#cb123-4" tabindex="-1"></a></span>
<span id="cb123-5"><a href="Disease.html#cb123-5" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb123-6"><a href="Disease.html#cb123-6" tabindex="-1"></a><span class="co"># Reading in borders</span></span>
<span id="cb123-7"><a href="Disease.html#cb123-7" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/copd/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb123-8"><a href="Disease.html#cb123-8" tabindex="-1"></a><span class="co"># Reading in data</span></span>
<span id="cb123-9"><a href="Disease.html#cb123-9" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb123-10"><a href="Disease.html#cb123-10" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb123-11"><a href="Disease.html#cb123-11" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb123-12"><a href="Disease.html#cb123-12" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityexpected.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>The following is the code for the Poisson-Gamma model implemented in <code>nimble</code>.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="Disease.html#cb124-1" tabindex="-1"></a>Example9_1Nimble <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb124-2"><a href="Disease.html#cb124-2" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb124-3"><a href="Disease.html#cb124-3" tabindex="-1"></a>    Y[i] <span class="sc">~</span> <span class="fu">dpois</span>(mu[i])</span>
<span id="cb124-4"><a href="Disease.html#cb124-4" tabindex="-1"></a>    <span class="co"># REVIEW: There is an intercept in the book, </span></span>
<span id="cb124-5"><a href="Disease.html#cb124-5" tabindex="-1"></a>    <span class="co"># but then we wouldn&#39;t be able to compare it to example 5.2</span></span>
<span id="cb124-6"><a href="Disease.html#cb124-6" tabindex="-1"></a>    mu[i] <span class="ot">&lt;-</span> E[i]<span class="sc">*</span><span class="fu">exp</span>(beta0)<span class="sc">*</span> theta[i]</span>
<span id="cb124-7"><a href="Disease.html#cb124-7" tabindex="-1"></a>    <span class="co">#mu[i] &lt;- E[i]* theta[i]</span></span>
<span id="cb124-8"><a href="Disease.html#cb124-8" tabindex="-1"></a>    <span class="co"># REVIEW: Same as before, the example in the book has theta[i] ~ Ga(a,a)</span></span>
<span id="cb124-9"><a href="Disease.html#cb124-9" tabindex="-1"></a>    theta[i] <span class="sc">~</span> <span class="fu">dgamma</span>(a, a)</span>
<span id="cb124-10"><a href="Disease.html#cb124-10" tabindex="-1"></a>    Y.fit[i] <span class="sc">~</span> <span class="fu">dpois</span>(mu[i])</span>
<span id="cb124-11"><a href="Disease.html#cb124-11" tabindex="-1"></a>  }</span>
<span id="cb124-12"><a href="Disease.html#cb124-12" tabindex="-1"></a>  <span class="co"># Priors</span></span>
<span id="cb124-13"><a href="Disease.html#cb124-13" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb124-14"><a href="Disease.html#cb124-14" tabindex="-1"></a>  beta0 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb124-15"><a href="Disease.html#cb124-15" tabindex="-1"></a></span>
<span id="cb124-16"><a href="Disease.html#cb124-16" tabindex="-1"></a>})</span>
<span id="cb124-17"><a href="Disease.html#cb124-17" tabindex="-1"></a></span>
<span id="cb124-18"><a href="Disease.html#cb124-18" tabindex="-1"></a><span class="co"># Define the constants, data and initials lists for the `nimble` model.</span></span>
<span id="cb124-19"><a href="Disease.html#cb124-19" tabindex="-1"></a></span>
<span id="cb124-20"><a href="Disease.html#cb124-20" tabindex="-1"></a><span class="co"># observations</span></span>
<span id="cb124-21"><a href="Disease.html#cb124-21" tabindex="-1"></a>y <span class="ot">&lt;-</span> observed<span class="sc">$</span>Y2010</span>
<span id="cb124-22"><a href="Disease.html#cb124-22" tabindex="-1"></a><span class="co"># offset</span></span>
<span id="cb124-23"><a href="Disease.html#cb124-23" tabindex="-1"></a>E <span class="ot">&lt;-</span> expected<span class="sc">$</span>E2010</span>
<span id="cb124-24"><a href="Disease.html#cb124-24" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb124-25"><a href="Disease.html#cb124-25" tabindex="-1"></a><span class="co"># constants list</span></span>
<span id="cb124-26"><a href="Disease.html#cb124-26" tabindex="-1"></a>constants <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb124-27"><a href="Disease.html#cb124-27" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb124-28"><a href="Disease.html#cb124-28" tabindex="-1"></a>  <span class="at">E =</span> E</span>
<span id="cb124-29"><a href="Disease.html#cb124-29" tabindex="-1"></a>)</span>
<span id="cb124-30"><a href="Disease.html#cb124-30" tabindex="-1"></a><span class="co"># data list</span></span>
<span id="cb124-31"><a href="Disease.html#cb124-31" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Y =</span> y)</span>
<span id="cb124-32"><a href="Disease.html#cb124-32" tabindex="-1"></a><span class="co"># initial values list</span></span>
<span id="cb124-33"><a href="Disease.html#cb124-33" tabindex="-1"></a>inits <span class="ot">&lt;-</span></span>
<span id="cb124-34"><a href="Disease.html#cb124-34" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb124-35"><a href="Disease.html#cb124-35" tabindex="-1"></a>      <span class="at">theta =</span> <span class="fu">rgamma</span>(N, <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb124-36"><a href="Disease.html#cb124-36" tabindex="-1"></a>      <span class="at">a =</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb124-37"><a href="Disease.html#cb124-37" tabindex="-1"></a>      <span class="at">beta0 =</span> <span class="dv">0</span>,</span>
<span id="cb124-38"><a href="Disease.html#cb124-38" tabindex="-1"></a>      <span class="at">Y.fit =</span> <span class="fu">rpois</span>(N, E)</span>
<span id="cb124-39"><a href="Disease.html#cb124-39" tabindex="-1"></a>    )</span>
<span id="cb124-40"><a href="Disease.html#cb124-40" tabindex="-1"></a><span class="co"># parameters to monitor</span></span>
<span id="cb124-41"><a href="Disease.html#cb124-41" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>, <span class="st">&quot;a&quot;</span>, <span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;Y.fit&quot;</span>)</span>
<span id="cb124-42"><a href="Disease.html#cb124-42" tabindex="-1"></a></span>
<span id="cb124-43"><a href="Disease.html#cb124-43" tabindex="-1"></a><span class="co"># Run model in nimble</span></span>
<span id="cb124-44"><a href="Disease.html#cb124-44" tabindex="-1"></a>mcmc.out <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb124-45"><a href="Disease.html#cb124-45" tabindex="-1"></a>  <span class="at">code =</span> Example9_1Nimble,</span>
<span id="cb124-46"><a href="Disease.html#cb124-46" tabindex="-1"></a>  <span class="at">constants =</span> constants,</span>
<span id="cb124-47"><a href="Disease.html#cb124-47" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb124-48"><a href="Disease.html#cb124-48" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb124-49"><a href="Disease.html#cb124-49" tabindex="-1"></a>  <span class="at">monitors =</span> params,</span>
<span id="cb124-50"><a href="Disease.html#cb124-50" tabindex="-1"></a>  <span class="at">niter =</span> <span class="dv">50000</span>,</span>
<span id="cb124-51"><a href="Disease.html#cb124-51" tabindex="-1"></a>  <span class="at">nburnin =</span> <span class="dv">20000</span>,</span>
<span id="cb124-52"><a href="Disease.html#cb124-52" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">14</span>,</span>
<span id="cb124-53"><a href="Disease.html#cb124-53" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb124-54"><a href="Disease.html#cb124-54" tabindex="-1"></a>  <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb124-55"><a href="Disease.html#cb124-55" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb124-56"><a href="Disease.html#cb124-56" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb124-57"><a href="Disease.html#cb124-57" tabindex="-1"></a>)</span></code></pre></div>
<p>Show the WAIC, effective sample size, and trace plots for some of the parameters.</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="Disease.html#cb125-1" tabindex="-1"></a>mcmc.out<span class="sc">$</span>WAIC</span></code></pre></div>
<pre><code>## nimbleList object of type waicList
## Field &quot;WAIC&quot;:
## [1] 2422.955
## Field &quot;lppd&quot;:
## [1] -1061.414
## Field &quot;pWAIC&quot;:
## [1] 150.0635</code></pre>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="Disease.html#cb127-1" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(mcmc.out<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 873.7203</code></pre>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="Disease.html#cb129-1" tabindex="-1"></a>mvSamples <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>samples</span>
<span id="cb129-2"><a href="Disease.html#cb129-2" tabindex="-1"></a></span>
<span id="cb129-3"><a href="Disease.html#cb129-3" tabindex="-1"></a><span class="co"># trace plot of a</span></span>
<span id="cb129-4"><a href="Disease.html#cb129-4" tabindex="-1"></a><span class="fu">plot</span>(mvSamples[, <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20nimble%20WAIC,%20ESS%20and%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="Disease.html#cb130-1" tabindex="-1"></a><span class="co"># trace plot of beta0</span></span>
<span id="cb130-2"><a href="Disease.html#cb130-2" tabindex="-1"></a><span class="fu">plot</span>(mvSamples[, <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20nimble%20WAIC,%20ESS%20and%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="Disease.html#cb131-1" tabindex="-1"></a><span class="co"># trace plots of theta</span></span>
<span id="cb131-2"><a href="Disease.html#cb131-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb131-3"><a href="Disease.html#cb131-3" tabindex="-1"></a>  <span class="fu">plot</span>(mvSamples[, <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">&quot;theta[&quot;</span>, i, <span class="st">&quot;]&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>))], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20nimble%20WAIC,%20ESS%20and%20traceplots-3.png" width="672" /><img src="_main_files/figure-html/Ex%209.1%20nimble%20WAIC,%20ESS%20and%20traceplots-4.png" width="672" /><img src="_main_files/figure-html/Ex%209.1%20nimble%20WAIC,%20ESS%20and%20traceplots-5.png" width="672" /></p>
<p>Now that we have checked the convergence of the chains we can plot the posterior mean and 95% CIs for each of the parameters.</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="Disease.html#cb132-1" tabindex="-1"></a><span class="co"># Print posterior summary for parameters a and b</span></span>
<span id="cb132-2"><a href="Disease.html#cb132-2" tabindex="-1"></a><span class="fu">summary</span>(mvSamples[, <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;beta0&quot;</span>)])</span></code></pre></div>
<pre><code>## 
## Iterations = 1:2142
## Thinning interval = 1 
## Number of chains = 2 
## Sample size per chain = 2142 
## 
## 1. Empirical mean and standard deviation for each variable,
##    plus standard error of the mean:
## 
##           Mean      SD Naive SE Time-series SE
## a     12.99093 1.20015 0.018336      0.0193625
## beta0 -0.03077 0.01715 0.000262      0.0005806
## 
## 2. Quantiles for each variable:
## 
##           2.5%      25%      50%      75%     97.5%
## a     10.75130 12.15487 12.95729 13.77618 15.477421
## beta0 -0.06441 -0.04214 -0.03104 -0.01967  0.003427</code></pre>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="Disease.html#cb134-1" tabindex="-1"></a><span class="co"># posterior summaries of theta_i</span></span>
<span id="cb134-2"><a href="Disease.html#cb134-2" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>summary<span class="sc">$</span>all.chains <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb134-3"><a href="Disease.html#cb134-3" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="st">&quot;variable&quot;</span>)</span>
<span id="cb134-4"><a href="Disease.html#cb134-4" tabindex="-1"></a><span class="co"># plot the mean and 95% CIs for the thetas</span></span>
<span id="cb134-5"><a href="Disease.html#cb134-5" tabindex="-1"></a>post_theta <span class="ot">&lt;-</span></span>
<span id="cb134-6"><a href="Disease.html#cb134-6" tabindex="-1"></a>  post_summary[<span class="fu">grepl</span>(<span class="st">&quot;theta</span><span class="sc">\\</span><span class="st">[&quot;</span>, post_summary<span class="sc">$</span>variable),]</span>
<span id="cb134-7"><a href="Disease.html#cb134-7" tabindex="-1"></a></span>
<span id="cb134-8"><a href="Disease.html#cb134-8" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb134-9"><a href="Disease.html#cb134-9" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb134-10"><a href="Disease.html#cb134-10" tabindex="-1"></a>  post_theta<span class="sc">$</span>Mean,</span>
<span id="cb134-11"><a href="Disease.html#cb134-11" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb134-12"><a href="Disease.html#cb134-12" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.8</span>,</span>
<span id="cb134-13"><a href="Disease.html#cb134-13" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb134-14"><a href="Disease.html#cb134-14" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Borough&quot;</span>,</span>
<span id="cb134-15"><a href="Disease.html#cb134-15" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Posterior Summary Rate&quot;</span>,</span>
<span id="cb134-16"><a href="Disease.html#cb134-16" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>), <span class="fu">max</span>(post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>))</span>
<span id="cb134-17"><a href="Disease.html#cb134-17" tabindex="-1"></a>)</span>
<span id="cb134-18"><a href="Disease.html#cb134-18" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb134-19"><a href="Disease.html#cb134-19" tabindex="-1"></a>  <span class="fu">segments</span>(i, post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>[i], i, post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>[i])</span>
<span id="cb134-20"><a href="Disease.html#cb134-20" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20nimble%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="Disease.html#cb135-1" tabindex="-1"></a><span class="co"># posterior summary of fitted values</span></span>
<span id="cb135-2"><a href="Disease.html#cb135-2" tabindex="-1"></a>post_fitted <span class="ot">&lt;-</span></span>
<span id="cb135-3"><a href="Disease.html#cb135-3" tabindex="-1"></a>  post_summary[<span class="fu">grepl</span>(<span class="st">&quot;Y.fit</span><span class="sc">\\</span><span class="st">[&quot;</span>, post_summary<span class="sc">$</span>variable),]</span>
<span id="cb135-4"><a href="Disease.html#cb135-4" tabindex="-1"></a><span class="co"># plot mean and 95% CIs for the fitted values</span></span>
<span id="cb135-5"><a href="Disease.html#cb135-5" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb135-6"><a href="Disease.html#cb135-6" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb135-7"><a href="Disease.html#cb135-7" tabindex="-1"></a>  y,</span>
<span id="cb135-8"><a href="Disease.html#cb135-8" tabindex="-1"></a>  post_fitted<span class="sc">$</span>Mean,</span>
<span id="cb135-9"><a href="Disease.html#cb135-9" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>), <span class="fu">max</span>(post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>)),</span>
<span id="cb135-10"><a href="Disease.html#cb135-10" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Observed&quot;</span>,</span>
<span id="cb135-11"><a href="Disease.html#cb135-11" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Fitted&quot;</span>,</span>
<span id="cb135-12"><a href="Disease.html#cb135-12" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb135-13"><a href="Disease.html#cb135-13" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.7</span>,</span>
<span id="cb135-14"><a href="Disease.html#cb135-14" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span></span>
<span id="cb135-15"><a href="Disease.html#cb135-15" tabindex="-1"></a>)</span>
<span id="cb135-16"><a href="Disease.html#cb135-16" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb135-17"><a href="Disease.html#cb135-17" tabindex="-1"></a>  <span class="fu">segments</span>(y[i], post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>[i], y[i], post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>[i])</span>
<span id="cb135-18"><a href="Disease.html#cb135-18" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20nimble%20posterior%20summary-2.png" width="672" /></p>
</div>
<div id="stan-1" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="Disease.html#stan-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="Disease.html#cb136-1" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb136-2"><a href="Disease.html#cb136-2" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># to read shapefile</span></span>
<span id="cb136-3"><a href="Disease.html#cb136-3" tabindex="-1"></a><span class="fu">library</span>(loo) <span class="co"># To calculate WAIC</span></span>
<span id="cb136-4"><a href="Disease.html#cb136-4" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb136-5"><a href="Disease.html#cb136-5" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb136-6"><a href="Disease.html#cb136-6" tabindex="-1"></a></span>
<span id="cb136-7"><a href="Disease.html#cb136-7" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb136-8"><a href="Disease.html#cb136-8" tabindex="-1"></a><span class="co"># Reading in borders</span></span>
<span id="cb136-9"><a href="Disease.html#cb136-9" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/copd/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb136-10"><a href="Disease.html#cb136-10" tabindex="-1"></a><span class="co"># Reading in data</span></span>
<span id="cb136-11"><a href="Disease.html#cb136-11" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb136-12"><a href="Disease.html#cb136-12" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb136-13"><a href="Disease.html#cb136-13" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb136-14"><a href="Disease.html#cb136-14" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityexpected.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>Write the <code>stan</code> model. This model is in a separate file called <code>Example8_1.stan</code> that will be called later.</p>
<pre><code>data {
  int&lt;lower=0&gt; N;
  real&lt;lower=0&gt; E[N]; // need to indicate that variable is strictly positive
  int&lt;lower=0&gt; Y[N];
}

parameters {
  real&lt;lower=0&gt; theta[N];
  real&lt;lower=0&gt; a;
}

transformed parameters{
  real &lt;lower=0&gt; mu[N];
  
  for(i in 1:N){
    mu[i]=E[i]*theta[i];
  }
  
}

model {
  // likelihood function and prior for theta
  for(i in 1:N){
    Y[i] ~ poisson(mu[i]);
    theta[i]~gamma(a,a);
  }
  a~gamma(1, 1);
}

generated quantities {
  vector [N] log_lik;
  int&lt;lower=0&gt; yfit [N];
  
  //computing the log_likelihood for each value of the mean mu and the fitted values
  for(i in 1:N){
    log_lik[i]=poisson_lpmf(Y[i] |mu[i]);
    yfit[i]=poisson_rng(mu[i]);
  }
  
}</code></pre>
<p>Define the data for the model, similar to <code>nimble</code>.</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="Disease.html#cb138-1" tabindex="-1"></a><span class="co"># observations</span></span>
<span id="cb138-2"><a href="Disease.html#cb138-2" tabindex="-1"></a>y <span class="ot">&lt;-</span> observed<span class="sc">$</span>Y2010</span>
<span id="cb138-3"><a href="Disease.html#cb138-3" tabindex="-1"></a><span class="co"># offset</span></span>
<span id="cb138-4"><a href="Disease.html#cb138-4" tabindex="-1"></a>E <span class="ot">&lt;-</span> expected<span class="sc">$</span>E2010</span>
<span id="cb138-5"><a href="Disease.html#cb138-5" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb138-6"><a href="Disease.html#cb138-6" tabindex="-1"></a><span class="co"># data list</span></span>
<span id="cb138-7"><a href="Disease.html#cb138-7" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb138-8"><a href="Disease.html#cb138-8" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">length</span>(y),</span>
<span id="cb138-9"><a href="Disease.html#cb138-9" tabindex="-1"></a>  <span class="at">Y =</span> y,</span>
<span id="cb138-10"><a href="Disease.html#cb138-10" tabindex="-1"></a>  <span class="at">E =</span> E</span>
<span id="cb138-11"><a href="Disease.html#cb138-11" tabindex="-1"></a>)</span>
<span id="cb138-12"><a href="Disease.html#cb138-12" tabindex="-1"></a><span class="co"># Run the model in Stan</span></span>
<span id="cb138-13"><a href="Disease.html#cb138-13" tabindex="-1"></a>Ex9_1Stan <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb138-14"><a href="Disease.html#cb138-14" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example9_1.stan&quot;</span>,</span>
<span id="cb138-15"><a href="Disease.html#cb138-15" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb138-16"><a href="Disease.html#cb138-16" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb138-17"><a href="Disease.html#cb138-17" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb138-18"><a href="Disease.html#cb138-18" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">3000</span>,</span>
<span id="cb138-19"><a href="Disease.html#cb138-19" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">14</span>,</span>
<span id="cb138-20"><a href="Disease.html#cb138-20" tabindex="-1"></a>  <span class="co"># QUESTION: should we explain this?</span></span>
<span id="cb138-21"><a href="Disease.html#cb138-21" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.8</span>, <span class="at">max_treedepth =</span> <span class="dv">15</span>),</span>
<span id="cb138-22"><a href="Disease.html#cb138-22" tabindex="-1"></a>  <span class="at">init =</span> <span class="st">&quot;random&quot;</span>,</span>
<span id="cb138-23"><a href="Disease.html#cb138-23" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;theta&quot;</span>, <span class="st">&quot;log_lik&quot;</span>, <span class="st">&quot;yfit&quot;</span>),</span>
<span id="cb138-24"><a href="Disease.html#cb138-24" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb138-25"><a href="Disease.html#cb138-25" tabindex="-1"></a>)</span></code></pre></div>
<p>Compute the WAIC, show the trace plots and posterior summaries of the parameters.</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="Disease.html#cb139-1" tabindex="-1"></a>loglik0 <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(Ex9_1Stan)</span>
<span id="cb139-2"><a href="Disease.html#cb139-2" tabindex="-1"></a>waic0 <span class="ot">&lt;-</span> <span class="fu">waic</span>(loglik0)</span>
<span id="cb139-3"><a href="Disease.html#cb139-3" tabindex="-1"></a>waic0</span></code></pre></div>
<pre><code>## 
## Computed from 1500 by 324 log-likelihood matrix
## 
##           Estimate   SE
## elpd_waic  -1212.1  7.5
## p_waic       150.3  3.7
## waic        2424.2 15.1
## 
## 180 (55.6%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="Disease.html#cb141-1" tabindex="-1"></a><span class="co"># traceplots of parameters a and b</span></span>
<span id="cb141-2"><a href="Disease.html#cb141-2" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Ex9_1Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20stan%20waic%20and%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="Disease.html#cb142-1" tabindex="-1"></a><span class="co"># traceplots of parameter theta</span></span>
<span id="cb142-2"><a href="Disease.html#cb142-2" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Ex9_1Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;theta[1]&quot;</span>, <span class="st">&quot;theta[2]&quot;</span>, <span class="st">&quot;theta[3]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20stan%20waic%20and%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="Disease.html#cb143-1" tabindex="-1"></a>summary_theta <span class="ot">&lt;-</span></span>
<span id="cb143-2"><a href="Disease.html#cb143-2" tabindex="-1"></a>  <span class="fu">summary</span>(Ex9_1Stan,</span>
<span id="cb143-3"><a href="Disease.html#cb143-3" tabindex="-1"></a>          <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>),</span>
<span id="cb143-4"><a href="Disease.html#cb143-4" tabindex="-1"></a>          <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>))<span class="sc">$</span>summary <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb143-5"><a href="Disease.html#cb143-5" tabindex="-1"></a></span>
<span id="cb143-6"><a href="Disease.html#cb143-6" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb143-7"><a href="Disease.html#cb143-7" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb143-8"><a href="Disease.html#cb143-8" tabindex="-1"></a>  summary_theta<span class="sc">$</span>mean,</span>
<span id="cb143-9"><a href="Disease.html#cb143-9" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb143-10"><a href="Disease.html#cb143-10" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.8</span>,</span>
<span id="cb143-11"><a href="Disease.html#cb143-11" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb143-12"><a href="Disease.html#cb143-12" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Borough&quot;</span>,</span>
<span id="cb143-13"><a href="Disease.html#cb143-13" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Posterior Summary Rate&quot;</span>,</span>
<span id="cb143-14"><a href="Disease.html#cb143-14" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>), <span class="fu">max</span>(summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>))</span>
<span id="cb143-15"><a href="Disease.html#cb143-15" tabindex="-1"></a>)</span>
<span id="cb143-16"><a href="Disease.html#cb143-16" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb143-17"><a href="Disease.html#cb143-17" tabindex="-1"></a>  <span class="fu">segments</span>(i, summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>[i], i, summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>[i])</span>
<span id="cb143-18"><a href="Disease.html#cb143-18" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20stan%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="Disease.html#cb144-1" tabindex="-1"></a><span class="co"># Posterior summary of fitted values</span></span>
<span id="cb144-2"><a href="Disease.html#cb144-2" tabindex="-1"></a>summary_fit <span class="ot">&lt;-</span></span>
<span id="cb144-3"><a href="Disease.html#cb144-3" tabindex="-1"></a>  <span class="fu">summary</span>(Ex9_1Stan,</span>
<span id="cb144-4"><a href="Disease.html#cb144-4" tabindex="-1"></a>          <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;yfit&quot;</span>),</span>
<span id="cb144-5"><a href="Disease.html#cb144-5" tabindex="-1"></a>          <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>))<span class="sc">$</span>summary <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb144-6"><a href="Disease.html#cb144-6" tabindex="-1"></a><span class="co"># Plot mean and 95% CIs for the fitted values</span></span>
<span id="cb144-7"><a href="Disease.html#cb144-7" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb144-8"><a href="Disease.html#cb144-8" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb144-9"><a href="Disease.html#cb144-9" tabindex="-1"></a>  y,</span>
<span id="cb144-10"><a href="Disease.html#cb144-10" tabindex="-1"></a>  summary_fit<span class="sc">$</span>mean,</span>
<span id="cb144-11"><a href="Disease.html#cb144-11" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>), <span class="fu">max</span>(summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>)),</span>
<span id="cb144-12"><a href="Disease.html#cb144-12" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Observed&quot;</span>,</span>
<span id="cb144-13"><a href="Disease.html#cb144-13" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Fitted&quot;</span>,</span>
<span id="cb144-14"><a href="Disease.html#cb144-14" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb144-15"><a href="Disease.html#cb144-15" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.7</span>,</span>
<span id="cb144-16"><a href="Disease.html#cb144-16" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span></span>
<span id="cb144-17"><a href="Disease.html#cb144-17" tabindex="-1"></a>)</span>
<span id="cb144-18"><a href="Disease.html#cb144-18" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb144-19"><a href="Disease.html#cb144-19" tabindex="-1"></a>  <span class="fu">segments</span>(y[i], summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>[i], y[i], summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>[i])</span>
<span id="cb144-20"><a href="Disease.html#cb144-20" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20stan%20posterior%20summary-2.png" width="672" /></p>
</div>
</div>
<div id="example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-stan" class="section level2 unnumbered hasAnchor">
<h2>Example 9.3: Fitting a conditional spatial model in <code>nimble</code> and <code>stan</code><a href="Disease.html#example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-stan" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This example uses the <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/englandlocalauthority.shp">englandlocalauthority.shp</a>, <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityobserved.csv">copdmortalityobserved.csv</a>, and
<a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityexpected.csv">copdmortalityexpected.csv</a> datasets from Chapter 6.</p>
<div id="nimble-3" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="Disease.html#nimble-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In this example we revisit the COPD data from example 6.3.</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="Disease.html#cb145-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2) <span class="co"># to plot map</span></span>
<span id="cb145-2"><a href="Disease.html#cb145-2" tabindex="-1"></a><span class="fu">library</span>(spdep) <span class="co"># read the shapefile (read_sf) and build neighbors list (poly2nb)</span></span>
<span id="cb145-3"><a href="Disease.html#cb145-3" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb145-4"><a href="Disease.html#cb145-4" tabindex="-1"></a></span>
<span id="cb145-5"><a href="Disease.html#cb145-5" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb145-6"><a href="Disease.html#cb145-6" tabindex="-1"></a><span class="co"># Reading in borders</span></span>
<span id="cb145-7"><a href="Disease.html#cb145-7" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/copd/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb145-8"><a href="Disease.html#cb145-8" tabindex="-1"></a><span class="co"># Reading in data</span></span>
<span id="cb145-9"><a href="Disease.html#cb145-9" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb145-10"><a href="Disease.html#cb145-10" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb145-11"><a href="Disease.html#cb145-11" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb145-12"><a href="Disease.html#cb145-12" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityexpected.csv&quot;</span>)</span>
<span id="cb145-13"><a href="Disease.html#cb145-13" tabindex="-1"></a>covariates <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdavgscore.csv&quot;</span>)</span>
<span id="cb145-14"><a href="Disease.html#cb145-14" tabindex="-1"></a><span class="co"># Merge everything into one data frame</span></span>
<span id="cb145-15"><a href="Disease.html#cb145-15" tabindex="-1"></a>copd_df <span class="ot">&lt;-</span></span>
<span id="cb145-16"><a href="Disease.html#cb145-16" tabindex="-1"></a>  <span class="fu">cbind</span>(observed,  expected) <span class="sc">|&gt;</span> <span class="fu">merge</span>(</span>
<span id="cb145-17"><a href="Disease.html#cb145-17" tabindex="-1"></a>    covariates,</span>
<span id="cb145-18"><a href="Disease.html#cb145-18" tabindex="-1"></a>    <span class="at">by.x =</span> <span class="st">&quot;code&quot;</span>,</span>
<span id="cb145-19"><a href="Disease.html#cb145-19" tabindex="-1"></a>    <span class="at">by.y =</span> <span class="st">&quot;LA.CODE&quot;</span>,</span>
<span id="cb145-20"><a href="Disease.html#cb145-20" tabindex="-1"></a>    <span class="at">all.x =</span> <span class="cn">TRUE</span>,</span>
<span id="cb145-21"><a href="Disease.html#cb145-21" tabindex="-1"></a>    <span class="at">all.y =</span> <span class="cn">FALSE</span></span>
<span id="cb145-22"><a href="Disease.html#cb145-22" tabindex="-1"></a>  )</span></code></pre></div>
<p>Analyze the relationship between COPD data and the average deprivation score which is a measure of the socioeconomic status of the patients.</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="Disease.html#cb146-1" tabindex="-1"></a>copd_df<span class="sc">$</span>SMR2010 <span class="ot">=</span> copd_df<span class="sc">$</span>Y2010 <span class="sc">/</span> copd_df<span class="sc">$</span>E2010</span>
<span id="cb146-2"><a href="Disease.html#cb146-2" tabindex="-1"></a></span>
<span id="cb146-3"><a href="Disease.html#cb146-3" tabindex="-1"></a><span class="fu">ggplot</span>(copd_df) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> Average.Score, <span class="at">y =</span> SMR2010)) <span class="sc">+</span> </span>
<span id="cb146-4"><a href="Disease.html#cb146-4" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;SMR 2010&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Average deprivation score&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.3%20plot%20copd%20and%20avg%20score-1.png" width="672" /></p>
<p>Define a function to obtain the number of neighbors.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="Disease.html#cb147-1" tabindex="-1"></a>adjlist <span class="ot">=</span> <span class="cf">function</span>(W, N) {</span>
<span id="cb147-2"><a href="Disease.html#cb147-2" tabindex="-1"></a>  adj <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb147-3"><a href="Disease.html#cb147-3" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb147-4"><a href="Disease.html#cb147-4" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb147-5"><a href="Disease.html#cb147-5" tabindex="-1"></a>      <span class="cf">if</span> (W[i, j] <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb147-6"><a href="Disease.html#cb147-6" tabindex="-1"></a>        adj <span class="ot">=</span> <span class="fu">append</span>(adj, j)</span>
<span id="cb147-7"><a href="Disease.html#cb147-7" tabindex="-1"></a>      }</span>
<span id="cb147-8"><a href="Disease.html#cb147-8" tabindex="-1"></a>    }</span>
<span id="cb147-9"><a href="Disease.html#cb147-9" tabindex="-1"></a>  }</span>
<span id="cb147-10"><a href="Disease.html#cb147-10" tabindex="-1"></a>  adj <span class="ot">=</span> adj[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb147-11"><a href="Disease.html#cb147-11" tabindex="-1"></a>  <span class="fu">return</span>(adj)</span>
<span id="cb147-12"><a href="Disease.html#cb147-12" tabindex="-1"></a>}</span></code></pre></div>
<p>Define the adjacency matrix and indexes for <code>stan</code> using the <code>nb2mat</code> and <code>adjlist</code></p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="Disease.html#cb148-1" tabindex="-1"></a><span class="co"># Create the neighborhood</span></span>
<span id="cb148-2"><a href="Disease.html#cb148-2" tabindex="-1"></a>W.nb <span class="ot">&lt;-</span></span>
<span id="cb148-3"><a href="Disease.html#cb148-3" tabindex="-1"></a>  <span class="fu">poly2nb</span>(england, <span class="at">row.names =</span> <span class="fu">rownames</span>(england))</span>
<span id="cb148-4"><a href="Disease.html#cb148-4" tabindex="-1"></a><span class="co"># Creates a matrix for following function call</span></span>
<span id="cb148-5"><a href="Disease.html#cb148-5" tabindex="-1"></a>W.mat <span class="ot">&lt;-</span> <span class="fu">nb2mat</span>(W.nb, <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span>
<span id="cb148-6"><a href="Disease.html#cb148-6" tabindex="-1"></a><span class="co"># Define the spatial structure to use in stan</span></span>
<span id="cb148-7"><a href="Disease.html#cb148-7" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(england<span class="sc">$</span>ID))</span>
<span id="cb148-8"><a href="Disease.html#cb148-8" tabindex="-1"></a>neigh  <span class="ot">&lt;-</span> <span class="fu">adjlist</span>(W.mat, N)</span>
<span id="cb148-9"><a href="Disease.html#cb148-9" tabindex="-1"></a>numneigh  <span class="ot">&lt;-</span> <span class="fu">apply</span>(W.mat,<span class="dv">2</span>,sum)</span></code></pre></div>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="Disease.html#cb149-1" tabindex="-1"></a>Example9_3Nimble <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb149-2"><a href="Disease.html#cb149-2" tabindex="-1"></a>  <span class="co"># Likelihood</span></span>
<span id="cb149-3"><a href="Disease.html#cb149-3" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb149-4"><a href="Disease.html#cb149-4" tabindex="-1"></a>    y[i] <span class="sc">~</span> <span class="fu">dpois</span>(lambda[i])</span>
<span id="cb149-5"><a href="Disease.html#cb149-5" tabindex="-1"></a>    <span class="fu">log</span>(lambda[i]) <span class="ot">&lt;-</span> <span class="fu">log</span>(E[i]) <span class="sc">+</span> b[i] <span class="sc">+</span> beta0 <span class="sc">+</span> beta1<span class="sc">*</span>x[i]</span>
<span id="cb149-6"><a href="Disease.html#cb149-6" tabindex="-1"></a>  }</span>
<span id="cb149-7"><a href="Disease.html#cb149-7" tabindex="-1"></a>  </span>
<span id="cb149-8"><a href="Disease.html#cb149-8" tabindex="-1"></a>  <span class="co"># Priors</span></span>
<span id="cb149-9"><a href="Disease.html#cb149-9" tabindex="-1"></a>  beta0 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb149-10"><a href="Disease.html#cb149-10" tabindex="-1"></a>  beta1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb149-11"><a href="Disease.html#cb149-11" tabindex="-1"></a>  b[<span class="dv">1</span><span class="sc">:</span>N] <span class="sc">~</span> <span class="fu">dcar_normal</span>(adj[<span class="dv">1</span><span class="sc">:</span>L], weights[<span class="dv">1</span><span class="sc">:</span>L], num[<span class="dv">1</span><span class="sc">:</span>N], tau, <span class="at">zero_mean =</span> <span class="dv">1</span>)</span>
<span id="cb149-12"><a href="Disease.html#cb149-12" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (sigma_b <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb149-13"><a href="Disease.html#cb149-13" tabindex="-1"></a>  sigma_b <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>), <span class="dv">0</span>,)</span>
<span id="cb149-14"><a href="Disease.html#cb149-14" tabindex="-1"></a>  <span class="co"># Fitted values and likelihood for WAIC</span></span>
<span id="cb149-15"><a href="Disease.html#cb149-15" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb149-16"><a href="Disease.html#cb149-16" tabindex="-1"></a>    fitted[i] <span class="sc">~</span> <span class="fu">dpois</span>(lambda[i])</span>
<span id="cb149-17"><a href="Disease.html#cb149-17" tabindex="-1"></a>  }</span>
<span id="cb149-18"><a href="Disease.html#cb149-18" tabindex="-1"></a>})</span>
<span id="cb149-19"><a href="Disease.html#cb149-19" tabindex="-1"></a></span>
<span id="cb149-20"><a href="Disease.html#cb149-20" tabindex="-1"></a><span class="co">#  Define the constants, data and initial values lists and run the model. </span></span>
<span id="cb149-21"><a href="Disease.html#cb149-21" tabindex="-1"></a></span>
<span id="cb149-22"><a href="Disease.html#cb149-22" tabindex="-1"></a><span class="co"># constants list</span></span>
<span id="cb149-23"><a href="Disease.html#cb149-23" tabindex="-1"></a>constants <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb149-24"><a href="Disease.html#cb149-24" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb149-25"><a href="Disease.html#cb149-25" tabindex="-1"></a>  <span class="at">E =</span> copd_df<span class="sc">$</span>E2010,</span>
<span id="cb149-26"><a href="Disease.html#cb149-26" tabindex="-1"></a>  <span class="at">L =</span> <span class="fu">length</span>(neigh),</span>
<span id="cb149-27"><a href="Disease.html#cb149-27" tabindex="-1"></a>  <span class="at">adj =</span> neigh,</span>
<span id="cb149-28"><a href="Disease.html#cb149-28" tabindex="-1"></a>  <span class="at">weights =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(neigh)),</span>
<span id="cb149-29"><a href="Disease.html#cb149-29" tabindex="-1"></a>  <span class="at">num =</span> <span class="fu">as.vector</span>(numneigh),</span>
<span id="cb149-30"><a href="Disease.html#cb149-30" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">3</span></span>
<span id="cb149-31"><a href="Disease.html#cb149-31" tabindex="-1"></a>)</span>
<span id="cb149-32"><a href="Disease.html#cb149-32" tabindex="-1"></a><span class="co"># data list</span></span>
<span id="cb149-33"><a href="Disease.html#cb149-33" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span></span>
<span id="cb149-34"><a href="Disease.html#cb149-34" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">y =</span> copd_df<span class="sc">$</span>Y2010, </span>
<span id="cb149-35"><a href="Disease.html#cb149-35" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(copd_df<span class="sc">$</span>Average.Score))) <span class="co"># vector of covariates</span></span>
<span id="cb149-36"><a href="Disease.html#cb149-36" tabindex="-1"></a>inits <span class="ot">&lt;-</span>  <span class="fu">list</span>(</span>
<span id="cb149-37"><a href="Disease.html#cb149-37" tabindex="-1"></a>  <span class="at">beta0 =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>),</span>
<span id="cb149-38"><a href="Disease.html#cb149-38" tabindex="-1"></a>  <span class="at">beta1 =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>),</span>
<span id="cb149-39"><a href="Disease.html#cb149-39" tabindex="-1"></a>  <span class="at">fitted =</span> <span class="fu">rpois</span>(N, <span class="dv">2</span>),</span>
<span id="cb149-40"><a href="Disease.html#cb149-40" tabindex="-1"></a>  <span class="at">sigma_b =</span> <span class="dv">1</span>,</span>
<span id="cb149-41"><a href="Disease.html#cb149-41" tabindex="-1"></a>  <span class="at">b =</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb149-42"><a href="Disease.html#cb149-42" tabindex="-1"></a>)</span>
<span id="cb149-43"><a href="Disease.html#cb149-43" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta1&quot;</span>, <span class="st">&quot;fitted&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;tau&quot;</span>)</span>
<span id="cb149-44"><a href="Disease.html#cb149-44" tabindex="-1"></a><span class="co"># Run model in nimble</span></span>
<span id="cb149-45"><a href="Disease.html#cb149-45" tabindex="-1"></a>mcmc.out <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb149-46"><a href="Disease.html#cb149-46" tabindex="-1"></a>  <span class="at">code =</span> Example9_3Nimble,</span>
<span id="cb149-47"><a href="Disease.html#cb149-47" tabindex="-1"></a>  <span class="at">constants =</span> constants,</span>
<span id="cb149-48"><a href="Disease.html#cb149-48" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb149-49"><a href="Disease.html#cb149-49" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb149-50"><a href="Disease.html#cb149-50" tabindex="-1"></a>  <span class="at">monitors =</span> params,</span>
<span id="cb149-51"><a href="Disease.html#cb149-51" tabindex="-1"></a>  <span class="at">niter =</span> <span class="dv">40000</span>,</span>
<span id="cb149-52"><a href="Disease.html#cb149-52" tabindex="-1"></a>  <span class="at">nburnin =</span> <span class="dv">20000</span>,</span>
<span id="cb149-53"><a href="Disease.html#cb149-53" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">80</span>,</span>
<span id="cb149-54"><a href="Disease.html#cb149-54" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb149-55"><a href="Disease.html#cb149-55" tabindex="-1"></a>  <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb149-56"><a href="Disease.html#cb149-56" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb149-57"><a href="Disease.html#cb149-57" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb149-58"><a href="Disease.html#cb149-58" tabindex="-1"></a>)</span></code></pre></div>
<p>Show the WAIC, effective sample size, and trace plots for some of the parameters.</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="Disease.html#cb150-1" tabindex="-1"></a>mcmc.out<span class="sc">$</span>WAIC</span></code></pre></div>
<pre><code>## nimbleList object of type waicList
## Field &quot;WAIC&quot;:
## [1] 2390.229
## Field &quot;lppd&quot;:
## [1] -1079.614
## Field &quot;pWAIC&quot;:
## [1] 115.5007</code></pre>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="Disease.html#cb152-1" tabindex="-1"></a><span class="co"># min(coda::effectiveSize(mcmc.out$samples))</span></span>
<span id="cb152-2"><a href="Disease.html#cb152-2" tabindex="-1"></a><span class="co"># plot(mcmc.out$samples[, c(&quot;beta0&quot;)], bty = &quot;n&quot;, main = &quot;beta0&quot;)</span></span>
<span id="cb152-3"><a href="Disease.html#cb152-3" tabindex="-1"></a><span class="co"># plot(mcmc.out$samples[, c(&quot;beta1&quot;)], bty = &quot;n&quot;)</span></span>
<span id="cb152-4"><a href="Disease.html#cb152-4" tabindex="-1"></a><span class="co"># plot(mcmc.out$samples[, c(&quot;b[2]&quot;)], bty = &quot;n&quot;)</span></span>
<span id="cb152-5"><a href="Disease.html#cb152-5" tabindex="-1"></a><span class="co"># plot(mcmc.out$samples[, c(&quot;tau&quot;)], bty = &quot;n&quot;)</span></span></code></pre></div>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="Disease.html#cb153-1" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb153-2"><a href="Disease.html#cb153-2" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta1&quot;</span>,<span class="st">&quot;tau&quot;</span>)</span>
<span id="cb153-3"><a href="Disease.html#cb153-3" tabindex="-1"></a>summary_CAR_nimble <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>summary<span class="sc">$</span>all.chains</span>
<span id="cb153-4"><a href="Disease.html#cb153-4" tabindex="-1"></a>summary_CAR_nimble[variables,]</span></code></pre></div>
<pre><code>##              Mean      Median     St.Dev.   95%CI_low   95%CI_upp
## beta0 -0.06939286 -0.06926006 0.007375274 -0.08342067 -0.05498754
## beta1  0.18147895  0.18106966 0.012254519  0.15800950  0.20442849
## tau   15.12970586 14.81443048 2.445113457 11.10376297 20.24953767</code></pre>
<p>Map the mean of the posterior estimate for the latent effect.</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="Disease.html#cb155-1" tabindex="-1"></a>samples_CAR_b <span class="ot">&lt;-</span></span>
<span id="cb155-2"><a href="Disease.html#cb155-2" tabindex="-1"></a>  summary_CAR_nimble[<span class="fu">grepl</span>(<span class="st">&quot;b</span><span class="sc">\\</span><span class="st">[&quot;</span>, <span class="fu">rownames</span>(summary_CAR_nimble)), ] <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb155-3"><a href="Disease.html#cb155-3" tabindex="-1"></a>observed <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(observed, <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb155-4"><a href="Disease.html#cb155-4" tabindex="-1"></a>samples_CAR_b<span class="sc">$</span>ID <span class="ot">&lt;-</span> observed<span class="sc">$</span>ID</span>
<span id="cb155-5"><a href="Disease.html#cb155-5" tabindex="-1"></a>CAR_nimble_merge <span class="ot">&lt;-</span> <span class="fu">merge</span>(england, samples_CAR_b, <span class="at">by =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb155-6"><a href="Disease.html#cb155-6" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb155-7"><a href="Disease.html#cb155-7" tabindex="-1"></a>  <span class="co"># Choose spatial object and column for plotting</span></span>
<span id="cb155-8"><a href="Disease.html#cb155-8" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CAR_nimble_merge, <span class="fu">aes</span>(<span class="at">fill =</span> Mean)) <span class="sc">+</span></span>
<span id="cb155-9"><a href="Disease.html#cb155-9" tabindex="-1"></a>  <span class="co"># Change legend&#39;s label</span></span>
<span id="cb155-10"><a href="Disease.html#cb155-10" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&#39;Latent effects nimble&#39;</span>) <span class="sc">+</span></span>
<span id="cb155-11"><a href="Disease.html#cb155-11" tabindex="-1"></a>  <span class="co"># Clear background and plot borders</span></span>
<span id="cb155-12"><a href="Disease.html#cb155-12" tabindex="-1"></a> <span class="fu">theme_void</span>()</span></code></pre></div>
</div>
<div id="stan-2" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="Disease.html#stan-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here, we implement the CAR model using <code>stan</code>.</p>
<p>This example uses the <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/englandlocalauthority.shp">englandlocalauthority.shp</a>, <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityobserved.csv">copdmortalityobserved.csv</a>, and
<a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityexpected.csv">copdmortalityexpected.csv</a> datasets from Chapter 6.</p>
<p>We will need two functions to structure the matrix of neighbors that will be needed in <code>stan</code>.</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="Disease.html#cb156-1" tabindex="-1"></a>adjlist <span class="ot">=</span> <span class="cf">function</span>(W, N) {</span>
<span id="cb156-2"><a href="Disease.html#cb156-2" tabindex="-1"></a>  adj <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb156-3"><a href="Disease.html#cb156-3" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb156-4"><a href="Disease.html#cb156-4" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb156-5"><a href="Disease.html#cb156-5" tabindex="-1"></a>      <span class="cf">if</span> (W[i, j] <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb156-6"><a href="Disease.html#cb156-6" tabindex="-1"></a>        adj <span class="ot">=</span> <span class="fu">append</span>(adj, j)</span>
<span id="cb156-7"><a href="Disease.html#cb156-7" tabindex="-1"></a>      }</span>
<span id="cb156-8"><a href="Disease.html#cb156-8" tabindex="-1"></a>    }</span>
<span id="cb156-9"><a href="Disease.html#cb156-9" tabindex="-1"></a>  }</span>
<span id="cb156-10"><a href="Disease.html#cb156-10" tabindex="-1"></a>  adj <span class="ot">=</span> adj[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb156-11"><a href="Disease.html#cb156-11" tabindex="-1"></a>  <span class="fu">return</span>(adj)</span>
<span id="cb156-12"><a href="Disease.html#cb156-12" tabindex="-1"></a>}</span>
<span id="cb156-13"><a href="Disease.html#cb156-13" tabindex="-1"></a></span>
<span id="cb156-14"><a href="Disease.html#cb156-14" tabindex="-1"></a>mungeCARdata4stan <span class="ot">=</span> <span class="cf">function</span>(adjBUGS, numBUGS) {</span>
<span id="cb156-15"><a href="Disease.html#cb156-15" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">length</span>(numBUGS)</span>
<span id="cb156-16"><a href="Disease.html#cb156-16" tabindex="-1"></a>  nn <span class="ot">=</span> numBUGS</span>
<span id="cb156-17"><a href="Disease.html#cb156-17" tabindex="-1"></a>  N_edges <span class="ot">=</span> <span class="fu">length</span>(adjBUGS) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb156-18"><a href="Disease.html#cb156-18" tabindex="-1"></a>  node1 <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;numeric&quot;</span>, <span class="at">length =</span> N_edges)</span>
<span id="cb156-19"><a href="Disease.html#cb156-19" tabindex="-1"></a>  node2 <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;numeric&quot;</span>, <span class="at">length =</span> N_edges)</span>
<span id="cb156-20"><a href="Disease.html#cb156-20" tabindex="-1"></a>  iAdj <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb156-21"><a href="Disease.html#cb156-21" tabindex="-1"></a>  iEdge <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb156-22"><a href="Disease.html#cb156-22" tabindex="-1"></a>  </span>
<span id="cb156-23"><a href="Disease.html#cb156-23" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb156-24"><a href="Disease.html#cb156-24" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nn[i]) {</span>
<span id="cb156-25"><a href="Disease.html#cb156-25" tabindex="-1"></a>      iAdj <span class="ot">=</span> iAdj <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb156-26"><a href="Disease.html#cb156-26" tabindex="-1"></a>      <span class="cf">if</span> (i <span class="sc">&lt;</span> adjBUGS[iAdj]) {</span>
<span id="cb156-27"><a href="Disease.html#cb156-27" tabindex="-1"></a>        iEdge <span class="ot">=</span> iEdge <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb156-28"><a href="Disease.html#cb156-28" tabindex="-1"></a>        node1[iEdge] <span class="ot">=</span> i</span>
<span id="cb156-29"><a href="Disease.html#cb156-29" tabindex="-1"></a>        node2[iEdge] <span class="ot">=</span> adjBUGS[iAdj]</span>
<span id="cb156-30"><a href="Disease.html#cb156-30" tabindex="-1"></a>      }</span>
<span id="cb156-31"><a href="Disease.html#cb156-31" tabindex="-1"></a>    }</span>
<span id="cb156-32"><a href="Disease.html#cb156-32" tabindex="-1"></a>  }</span>
<span id="cb156-33"><a href="Disease.html#cb156-33" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">list</span>(</span>
<span id="cb156-34"><a href="Disease.html#cb156-34" tabindex="-1"></a>    <span class="st">&quot;N&quot;</span> <span class="ot">=</span> N,</span>
<span id="cb156-35"><a href="Disease.html#cb156-35" tabindex="-1"></a>    <span class="st">&quot;N_edges&quot;</span> <span class="ot">=</span> N_edges,</span>
<span id="cb156-36"><a href="Disease.html#cb156-36" tabindex="-1"></a>    <span class="st">&quot;node1&quot;</span> <span class="ot">=</span> node1,</span>
<span id="cb156-37"><a href="Disease.html#cb156-37" tabindex="-1"></a>    <span class="st">&quot;node2&quot;</span> <span class="ot">=</span> node2</span>
<span id="cb156-38"><a href="Disease.html#cb156-38" tabindex="-1"></a>  ))</span>
<span id="cb156-39"><a href="Disease.html#cb156-39" tabindex="-1"></a>  </span>
<span id="cb156-40"><a href="Disease.html#cb156-40" tabindex="-1"></a>}</span></code></pre></div>
<p>This model is in a separate file called <code>Example8_3.stan</code> that will be called later.</p>
<pre><code>data {
  int&lt;lower=1&gt; N;
  int&lt;lower=1&gt; N_edges;
  int&lt;lower=1&gt; p;
  matrix[N,p] X;   
  int&lt;lower=1, upper=N&gt; node1[N_edges];  // node1[i] adjacent to node2[i]
  int&lt;lower=1, upper=N&gt; node2[N_edges];  // and node1[i] &lt; node2[i]
  int&lt;lower=0&gt; y[N];              // count outcomes
  vector&lt;lower=0&gt;[N] E;           // exposure 
}

transformed data {
  vector[N] log_E = log(E);
}

parameters {
  real beta0;            // intercept
  vector[p] beta;
  vector[N] s;         // spatial effects
  real&lt;lower=0&gt; sigma_s;        // marginal standard deviation of spatial effects
}

transformed parameters {
  vector[N] b; // latent effect
  b =  sigma_s*s;
}

model {
  y ~ poisson_log(log_E + beta0 + X*beta + b); 
  // This is the prior for s! (up to proportionality)
  target += -0.5 * dot_self(s[node1] - s[node2]);
  sum(s) ~ normal(0, 0.001 * N); 
  
  beta0 ~ normal(0.0, 10.0);
 for(j in 1:p){
    beta[j] ~ normal(0.0, 10.0);
  }
    sigma_s ~ normal(0.0,1.0);
}

generated quantities {
  vector[N] mu=exp(log_E + beta0  + X*beta + b);
  vector[N] lik;
  vector[N] log_lik;
  
  for(i in 1:N){
    lik[i] = exp(poisson_lpmf(y[i] | mu[i] ));
    log_lik[i] = poisson_lpmf(y[i] | mu[i] );
  }
}</code></pre>
<!-- REVIEW: I am missing the adjacency matrix but I calculated like they did for the CARBayes example, is that right? -->
<p>Define the adjacency matrix and indexes for <code>stan</code> using the <code>nb2mat</code> and <code>adjlist</code></p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="Disease.html#cb158-1" tabindex="-1"></a><span class="co"># Create the neighborhood</span></span>
<span id="cb158-2"><a href="Disease.html#cb158-2" tabindex="-1"></a>W.nb <span class="ot">&lt;-</span></span>
<span id="cb158-3"><a href="Disease.html#cb158-3" tabindex="-1"></a>  <span class="fu">poly2nb</span>(england, <span class="at">row.names =</span> <span class="fu">rownames</span>(england))</span>
<span id="cb158-4"><a href="Disease.html#cb158-4" tabindex="-1"></a><span class="co"># Creates a matrix for following function call</span></span>
<span id="cb158-5"><a href="Disease.html#cb158-5" tabindex="-1"></a>W.mat <span class="ot">&lt;-</span> <span class="fu">nb2mat</span>(W.nb, <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span>
<span id="cb158-6"><a href="Disease.html#cb158-6" tabindex="-1"></a></span>
<span id="cb158-7"><a href="Disease.html#cb158-7" tabindex="-1"></a><span class="co"># Define the spatial structure to use in stan</span></span>
<span id="cb158-8"><a href="Disease.html#cb158-8" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(england<span class="sc">$</span>ID))</span>
<span id="cb158-9"><a href="Disease.html#cb158-9" tabindex="-1"></a>neigh <span class="ot">&lt;-</span> <span class="fu">adjlist</span>(W.mat, N)</span>
<span id="cb158-10"><a href="Disease.html#cb158-10" tabindex="-1"></a>numneigh  <span class="ot">&lt;-</span>  <span class="fu">apply</span>(W.mat, <span class="dv">2</span>, sum)</span>
<span id="cb158-11"><a href="Disease.html#cb158-11" tabindex="-1"></a>nbs <span class="ot">&lt;-</span> <span class="fu">mungeCARdata4stan</span>(neigh, numneigh)</span>
<span id="cb158-12"><a href="Disease.html#cb158-12" tabindex="-1"></a></span>
<span id="cb158-13"><a href="Disease.html#cb158-13" tabindex="-1"></a></span>
<span id="cb158-14"><a href="Disease.html#cb158-14" tabindex="-1"></a><span class="co"># Define data and variables for Stan model</span></span>
<span id="cb158-15"><a href="Disease.html#cb158-15" tabindex="-1"></a>y <span class="ot">&lt;-</span> copd_df<span class="sc">$</span>Y2010</span>
<span id="cb158-16"><a href="Disease.html#cb158-16" tabindex="-1"></a>E <span class="ot">&lt;-</span> copd_df<span class="sc">$</span>E2010</span>
<span id="cb158-17"><a href="Disease.html#cb158-17" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(copd_df<span class="sc">$</span>Average.Score))</span>
<span id="cb158-18"><a href="Disease.html#cb158-18" tabindex="-1"></a></span>
<span id="cb158-19"><a href="Disease.html#cb158-19" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb158-20"><a href="Disease.html#cb158-20" tabindex="-1"></a>  <span class="at">N =</span>  nbs<span class="sc">$</span>N,</span>
<span id="cb158-21"><a href="Disease.html#cb158-21" tabindex="-1"></a>  <span class="at">y =</span> y,</span>
<span id="cb158-22"><a href="Disease.html#cb158-22" tabindex="-1"></a>  <span class="at">E =</span> E,</span>
<span id="cb158-23"><a href="Disease.html#cb158-23" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">1</span>,</span>
<span id="cb158-24"><a href="Disease.html#cb158-24" tabindex="-1"></a>  <span class="at">X =</span> <span class="fu">as.matrix</span>(X),</span>
<span id="cb158-25"><a href="Disease.html#cb158-25" tabindex="-1"></a>  <span class="at">N_edges =</span> nbs<span class="sc">$</span>N_edges,</span>
<span id="cb158-26"><a href="Disease.html#cb158-26" tabindex="-1"></a>  <span class="at">node1 =</span> nbs<span class="sc">$</span>node1,</span>
<span id="cb158-27"><a href="Disease.html#cb158-27" tabindex="-1"></a>  <span class="at">node2 =</span> nbs<span class="sc">$</span>node2</span>
<span id="cb158-28"><a href="Disease.html#cb158-28" tabindex="-1"></a>)</span>
<span id="cb158-29"><a href="Disease.html#cb158-29" tabindex="-1"></a></span>
<span id="cb158-30"><a href="Disease.html#cb158-30" tabindex="-1"></a>Example9_3Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb158-31"><a href="Disease.html#cb158-31" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example9_3.stan&quot;</span>,</span>
<span id="cb158-32"><a href="Disease.html#cb158-32" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb158-33"><a href="Disease.html#cb158-33" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">10000</span>,</span>
<span id="cb158-34"><a href="Disease.html#cb158-34" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">20000</span>,</span>
<span id="cb158-35"><a href="Disease.html#cb158-35" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb158-36"><a href="Disease.html#cb158-36" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb158-37"><a href="Disease.html#cb158-37" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma_s&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;log_lik&quot;</span>),</span>
<span id="cb158-38"><a href="Disease.html#cb158-38" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb158-39"><a href="Disease.html#cb158-39" tabindex="-1"></a>)</span></code></pre></div>
<p>Show traceplots.</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="Disease.html#cb159-1" tabindex="-1"></a><span class="co">#computing WAIC using the package loo</span></span>
<span id="cb159-2"><a href="Disease.html#cb159-2" tabindex="-1"></a></span>
<span id="cb159-3"><a href="Disease.html#cb159-3" tabindex="-1"></a>loglikcar <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(Example9_3Stan)</span>
<span id="cb159-4"><a href="Disease.html#cb159-4" tabindex="-1"></a>waiccar <span class="ot">&lt;-</span> <span class="fu">waic</span>(loglikcar)</span></code></pre></div>
<pre><code>## Warning: 
## 89 (27.5%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="Disease.html#cb161-1" tabindex="-1"></a>waiccar</span></code></pre></div>
<pre><code>## 
## Computed from 2000 by 324 log-likelihood matrix
## 
##           Estimate   SE
## elpd_waic  -1195.1 14.2
## p_waic       115.8  7.1
## waic        2390.2 28.4
## 
## 89 (27.5%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="Disease.html#cb163-1" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example9_3Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma_s&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.3%20stan%20CAR%20traceplots-1.png" width="672" /></p>
<p>Show the posterior summary for the parameters if interest.
Keep in mind that in the stan model the we are sampling the standard deviation of the random effect unlike <code>CARBayes</code> where the variance is obtained.</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="Disease.html#cb164-1" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb164-2"><a href="Disease.html#cb164-2" tabindex="-1"></a>summary_CAR_stan <span class="ot">&lt;-</span></span>
<span id="cb164-3"><a href="Disease.html#cb164-3" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb164-4"><a href="Disease.html#cb164-4" tabindex="-1"></a>    Example9_3Stan,</span>
<span id="cb164-5"><a href="Disease.html#cb164-5" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma_s&quot;</span>),</span>
<span id="cb164-6"><a href="Disease.html#cb164-6" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb164-7"><a href="Disease.html#cb164-7" tabindex="-1"></a>  )</span>
<span id="cb164-8"><a href="Disease.html#cb164-8" tabindex="-1"></a></span>
<span id="cb164-9"><a href="Disease.html#cb164-9" tabindex="-1"></a>summary_CAR_stan<span class="sc">$</span>summary</span></code></pre></div>
<pre><code>##                mean      se_mean          sd        2.5%       97.5%    n_eff
## beta0   -0.06896897 0.0001634880 0.007487734 -0.08337321 -0.05406075 2097.630
## beta[1]  0.18192275 0.0002938688 0.012404484  0.15732535  0.20552801 1781.765
## sigma_s  0.25869937 0.0005111474 0.020640043  0.21940587  0.30151565 1630.530
##             Rhat
## beta0   1.000813
## beta[1] 1.002448
## sigma_s 1.001970</code></pre>
<p>Map the mean of the posterior estimate for the latent effect.</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="Disease.html#cb166-1" tabindex="-1"></a>summary_CAR_stan_b <span class="ot">&lt;-</span></span>
<span id="cb166-2"><a href="Disease.html#cb166-2" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb166-3"><a href="Disease.html#cb166-3" tabindex="-1"></a>    Example9_3Stan,</span>
<span id="cb166-4"><a href="Disease.html#cb166-4" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;b&quot;</span>),</span>
<span id="cb166-5"><a href="Disease.html#cb166-5" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb166-6"><a href="Disease.html#cb166-6" tabindex="-1"></a>  )</span>
<span id="cb166-7"><a href="Disease.html#cb166-7" tabindex="-1"></a></span>
<span id="cb166-8"><a href="Disease.html#cb166-8" tabindex="-1"></a>observed <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(observed, <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb166-9"><a href="Disease.html#cb166-9" tabindex="-1"></a></span>
<span id="cb166-10"><a href="Disease.html#cb166-10" tabindex="-1"></a>summary_CAR_stan_b<span class="sc">$</span>ID <span class="ot">&lt;-</span> observed<span class="sc">$</span>ID</span>
<span id="cb166-11"><a href="Disease.html#cb166-11" tabindex="-1"></a></span>
<span id="cb166-12"><a href="Disease.html#cb166-12" tabindex="-1"></a>CAR_stan_merge <span class="ot">&lt;-</span> <span class="fu">merge</span>(england, summary_CAR_stan_b, <span class="at">by =</span> <span class="st">&quot;ID&quot;</span>) </span>
<span id="cb166-13"><a href="Disease.html#cb166-13" tabindex="-1"></a></span>
<span id="cb166-14"><a href="Disease.html#cb166-14" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb166-15"><a href="Disease.html#cb166-15" tabindex="-1"></a>  <span class="co"># Choose spatial object and column for plotting</span></span>
<span id="cb166-16"><a href="Disease.html#cb166-16" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CAR_stan_merge, <span class="fu">aes</span>(<span class="at">fill =</span> summary.mean)) <span class="sc">+</span> </span>
<span id="cb166-17"><a href="Disease.html#cb166-17" tabindex="-1"></a>  <span class="co"># Change legend&#39;s label</span></span>
<span id="cb166-18"><a href="Disease.html#cb166-18" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&#39;Latent effects stan&#39;</span>) <span class="sc">+</span></span>
<span id="cb166-19"><a href="Disease.html#cb166-19" tabindex="-1"></a>  <span class="co"># Clear background and plot borders</span></span>
<span id="cb166-20"><a href="Disease.html#cb166-20" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.3%20plot%20map%20stan-1.png" width="672" /></p>
<!-- IDEA: Maybe we should agree on what output we will show for every method -->
</div>
</div>
<div id="example-9.4-fitting-a-conditional-spatial-model-using-carbayes" class="section level2 unnumbered hasAnchor">
<h2>Example 9.4: Fitting a conditional spatial model using CARBayes<a href="Disease.html#example-9.4-fitting-a-conditional-spatial-model-using-carbayes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Load the necessary libraries and the COPD data: <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/englandlocalauthority.shp">englandlocalauthority.shp</a>, <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityobserved.csv">copdmortalityobserved.csv</a>, and <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityexpected.csv">copdmortalityexpected.csv</a> datasets from Chapter 6.</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="Disease.html#cb167-1" tabindex="-1"></a><span class="fu">library</span>(CARBayes)</span>
<span id="cb167-2"><a href="Disease.html#cb167-2" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb167-3"><a href="Disease.html#cb167-3" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb167-4"><a href="Disease.html#cb167-4" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb167-5"><a href="Disease.html#cb167-5" tabindex="-1"></a></span>
<span id="cb167-6"><a href="Disease.html#cb167-6" tabindex="-1"></a><span class="co"># Reading in borders</span></span>
<span id="cb167-7"><a href="Disease.html#cb167-7" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/copd/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb167-8"><a href="Disease.html#cb167-8" tabindex="-1"></a><span class="co"># Reading in data</span></span>
<span id="cb167-9"><a href="Disease.html#cb167-9" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb167-10"><a href="Disease.html#cb167-10" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb167-11"><a href="Disease.html#cb167-11" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb167-12"><a href="Disease.html#cb167-12" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityexpected.csv&quot;</span>)</span>
<span id="cb167-13"><a href="Disease.html#cb167-13" tabindex="-1"></a>covariates <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdavgscore.csv&quot;</span>) </span>
<span id="cb167-14"><a href="Disease.html#cb167-14" tabindex="-1"></a><span class="co"># Merge everything into one data frame</span></span>
<span id="cb167-15"><a href="Disease.html#cb167-15" tabindex="-1"></a>copd_df <span class="ot">&lt;-</span></span>
<span id="cb167-16"><a href="Disease.html#cb167-16" tabindex="-1"></a>  <span class="fu">cbind</span>(observed,  expected) <span class="sc">|&gt;</span> <span class="fu">merge</span>(</span>
<span id="cb167-17"><a href="Disease.html#cb167-17" tabindex="-1"></a>    covariates,</span>
<span id="cb167-18"><a href="Disease.html#cb167-18" tabindex="-1"></a>    <span class="at">by.x =</span> <span class="st">&quot;code&quot;</span>,</span>
<span id="cb167-19"><a href="Disease.html#cb167-19" tabindex="-1"></a>    <span class="at">by.y =</span> <span class="st">&quot;LA.CODE&quot;</span>,</span>
<span id="cb167-20"><a href="Disease.html#cb167-20" tabindex="-1"></a>    <span class="at">all.x =</span> <span class="cn">TRUE</span>,</span>
<span id="cb167-21"><a href="Disease.html#cb167-21" tabindex="-1"></a>    <span class="at">all.y =</span> <span class="cn">FALSE</span></span>
<span id="cb167-22"><a href="Disease.html#cb167-22" tabindex="-1"></a>  )</span>
<span id="cb167-23"><a href="Disease.html#cb167-23" tabindex="-1"></a>copd_df<span class="sc">$</span>Average.Score <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(copd_df<span class="sc">$</span>Average.Score))</span></code></pre></div>
<p>To calculate the smoother SMRs, we first need to create a <em>neighborhood</em> structure. The functions <code>poly2nb()</code> and <code>nb2mat()</code> from the <code>spdep</code> package can be used to create this</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="Disease.html#cb168-1" tabindex="-1"></a><span class="co"># Create the neighborhood</span></span>
<span id="cb168-2"><a href="Disease.html#cb168-2" tabindex="-1"></a>W.nb <span class="ot">&lt;-</span></span>
<span id="cb168-3"><a href="Disease.html#cb168-3" tabindex="-1"></a>  <span class="fu">poly2nb</span>(england, <span class="at">row.names =</span> <span class="fu">rownames</span>(england))</span>
<span id="cb168-4"><a href="Disease.html#cb168-4" tabindex="-1"></a></span>
<span id="cb168-5"><a href="Disease.html#cb168-5" tabindex="-1"></a><span class="co"># Creates a matrix for following function call</span></span>
<span id="cb168-6"><a href="Disease.html#cb168-6" tabindex="-1"></a>W.mat <span class="ot">&lt;-</span> <span class="fu">nb2mat</span>(W.nb, <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span></code></pre></div>
<p>Here, we use <em>first neighbors</em> to define the structure, so any local authority sharing a border are considered neighbors.</p>
<p>The function <code>S.CARleroux()</code> allows us to use the neighborhood structure and performs a Bayesian analysis to create a smoothed set of observed values.</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="Disease.html#cb169-1" tabindex="-1"></a><span class="co"># Running smoothing model</span></span>
<span id="cb169-2"><a href="Disease.html#cb169-2" tabindex="-1"></a>Ex9_4 <span class="ot">&lt;-</span></span>
<span id="cb169-3"><a href="Disease.html#cb169-3" tabindex="-1"></a>  <span class="fu">S.CARleroux</span>(</span>
<span id="cb169-4"><a href="Disease.html#cb169-4" tabindex="-1"></a>    <span class="co"># Model Formula</span></span>
<span id="cb169-5"><a href="Disease.html#cb169-5" tabindex="-1"></a>    <span class="at">formula =</span> Y2010 <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(E2010)) <span class="sc">+</span> Average.Score,</span>
<span id="cb169-6"><a href="Disease.html#cb169-6" tabindex="-1"></a>    <span class="co"># data frame with data</span></span>
<span id="cb169-7"><a href="Disease.html#cb169-7" tabindex="-1"></a>    <span class="at">data =</span> copd_df,</span>
<span id="cb169-8"><a href="Disease.html#cb169-8" tabindex="-1"></a>    <span class="co"># Choosing Poisson Regression</span></span>
<span id="cb169-9"><a href="Disease.html#cb169-9" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>,</span>
<span id="cb169-10"><a href="Disease.html#cb169-10" tabindex="-1"></a>    <span class="co"># Neighborhood matrix</span></span>
<span id="cb169-11"><a href="Disease.html#cb169-11" tabindex="-1"></a>    <span class="at">W =</span> W.mat,</span>
<span id="cb169-12"><a href="Disease.html#cb169-12" tabindex="-1"></a>    <span class="co"># Number of burn in samples</span></span>
<span id="cb169-13"><a href="Disease.html#cb169-13" tabindex="-1"></a>    <span class="at">burnin =</span> <span class="dv">20000</span>,</span>
<span id="cb169-14"><a href="Disease.html#cb169-14" tabindex="-1"></a>    <span class="co"># Number of MCMC samples</span></span>
<span id="cb169-15"><a href="Disease.html#cb169-15" tabindex="-1"></a>    <span class="at">n.sample =</span> <span class="dv">100000</span>,</span>
<span id="cb169-16"><a href="Disease.html#cb169-16" tabindex="-1"></a>    <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb169-17"><a href="Disease.html#cb169-17" tabindex="-1"></a>    <span class="at">rho =</span> <span class="dv">1</span></span>
<span id="cb169-18"><a href="Disease.html#cb169-18" tabindex="-1"></a>  )</span></code></pre></div>
<p>We can extract the new smoother values from the model output and divide them by the expected values in order to compare both methods.</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r foldable"><code class="sourceCode r"><span id="cb170-1"><a href="Disease.html#cb170-1" tabindex="-1"></a><span class="co"># Creating a dataset with smoothed SMRs in 2010</span></span>
<span id="cb170-2"><a href="Disease.html#cb170-2" tabindex="-1"></a>SMR2010 <span class="ot">&lt;-</span> Ex9_4<span class="sc">$</span>fitted.values <span class="sc">/</span>  copd_df<span class="sc">$</span>E2010</span>
<span id="cb170-3"><a href="Disease.html#cb170-3" tabindex="-1"></a>SMR_smooth <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(SMR2010, <span class="at">row.names =</span> <span class="fu">rownames</span>(observed))</span>
<span id="cb170-4"><a href="Disease.html#cb170-4" tabindex="-1"></a><span class="co"># Printing first six rows of smoothed SMRs</span></span>
<span id="cb170-5"><a href="Disease.html#cb170-5" tabindex="-1"></a><span class="fu">head</span>(SMR_smooth)</span></code></pre></div>
<pre><code>##        SMR2010
## 00AA 0.6760759
## 00AB 1.3185626
## 00AC 0.6659953
## 00AD 0.9438893
## 00AE 0.7487042
## 00AF 0.8297144</code></pre>
<div class="sourceCode" id="cb172"><pre class="sourceCode r foldable"><code class="sourceCode r"><span id="cb172-1"><a href="Disease.html#cb172-1" tabindex="-1"></a><span class="co"># Summarizing smoothed SMRs</span></span>
<span id="cb172-2"><a href="Disease.html#cb172-2" tabindex="-1"></a><span class="fu">summary</span>(SMR_smooth)</span></code></pre></div>
<pre><code>##     SMR2010      
##  Min.   :0.6020  
##  1st Qu.:0.7913  
##  Median :0.9018  
##  Mean   :0.9638  
##  3rd Qu.:1.0805  
##  Max.   :1.7960</code></pre>
<div class="sourceCode" id="cb174"><pre class="sourceCode r foldable"><code class="sourceCode r"><span id="cb174-1"><a href="Disease.html#cb174-1" tabindex="-1"></a><span class="co"># Summary of the parameters under the CAR model.</span></span>
<span id="cb174-2"><a href="Disease.html#cb174-2" tabindex="-1"></a>Ex9_4<span class="sc">$</span>summary.results[]</span></code></pre></div>
<pre><code>##                  Mean    2.5%   97.5% n.sample % accept n.effective Geweke.diag
## (Intercept)   -0.0688 -0.0840 -0.0534     8000     38.9      7806.4         0.9
## Average.Score  0.1814  0.1569  0.2069     8000     38.9      2471.8         1.1
## tau2           0.0646  0.0460  0.0872     8000    100.0      3362.7         1.8
## rho            1.0000  1.0000  1.0000       NA       NA          NA          NA</code></pre>
<!-- QUESTION: What do we want the latent effect or the fitted values? -->
<p>Use <code>ggplot()</code> and <code>geom_sf()</code> to plot the map of the latent spatial effect.</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode r foldable"><code class="sourceCode r"><span id="cb176-1"><a href="Disease.html#cb176-1" tabindex="-1"></a>observed <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(observed, <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb176-2"><a href="Disease.html#cb176-2" tabindex="-1"></a>phi_car <span class="ot">&lt;-</span>  Ex9_4<span class="sc">$</span>samples<span class="sc">$</span>phi</span>
<span id="cb176-3"><a href="Disease.html#cb176-3" tabindex="-1"></a></span>
<span id="cb176-4"><a href="Disease.html#cb176-4" tabindex="-1"></a>latent_car_df  <span class="ot">&lt;-</span>  <span class="fu">data.frame</span>(</span>
<span id="cb176-5"><a href="Disease.html#cb176-5" tabindex="-1"></a>  <span class="at">phi_mean =</span> <span class="fu">apply</span>(phi_car, <span class="dv">2</span>, mean),</span>
<span id="cb176-6"><a href="Disease.html#cb176-6" tabindex="-1"></a>  <span class="at">phi_sd =</span> <span class="fu">apply</span>(phi_car, <span class="dv">2</span>, sd)</span>
<span id="cb176-7"><a href="Disease.html#cb176-7" tabindex="-1"></a>)</span>
<span id="cb176-8"><a href="Disease.html#cb176-8" tabindex="-1"></a><span class="co"># Combine latent spatial effect with england dataset</span></span>
<span id="cb176-9"><a href="Disease.html#cb176-9" tabindex="-1"></a>latent_car_df<span class="sc">$</span>ID <span class="ot">&lt;-</span> observed<span class="sc">$</span>ID</span>
<span id="cb176-10"><a href="Disease.html#cb176-10" tabindex="-1"></a>latent_car_england <span class="ot">&lt;-</span>  <span class="fu">merge</span>(england, latent_car_df, <span class="at">by =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb176-11"><a href="Disease.html#cb176-11" tabindex="-1"></a><span class="co"># Creating map of smoothed SMRs in England in 2010</span></span>
<span id="cb176-12"><a href="Disease.html#cb176-12" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb176-13"><a href="Disease.html#cb176-13" tabindex="-1"></a>  <span class="co"># Choose spatial object and column for plotting</span></span>
<span id="cb176-14"><a href="Disease.html#cb176-14" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> latent_car_england, <span class="fu">aes</span>(<span class="at">fill =</span> phi_mean)) <span class="sc">+</span></span>
<span id="cb176-15"><a href="Disease.html#cb176-15" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&#39;Latent effects CARbayes&#39;</span>) <span class="sc">+</span></span>
<span id="cb176-16"><a href="Disease.html#cb176-16" tabindex="-1"></a>  <span class="co"># Clear background and plot borders</span></span>
<span id="cb176-17"><a href="Disease.html#cb176-17" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.4%20carbayes%20map%20smoothed%20SMRs-1.png" width="672" /></p>
</div>
<div id="example-9.5-fitting-a-conditional-model-using-inla" class="section level2 unnumbered hasAnchor">
<h2>Example 9.5: Fitting a conditional model using INLA<a href="Disease.html#example-9.5-fitting-a-conditional-model-using-inla" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This example uses the <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/englandlocalauthority.shp">englandlocalauthority.shp</a>, <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityobserved.csv">copdmortalityobserved.csv</a>, and
<a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityexpected.csv">copdmortalityexpected.csv</a> datasets from Chapter 6.</p>
<!-- TODO: Show output for this model  -->
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="Disease.html#cb177-1" tabindex="-1"></a><span class="co"># run the INLA model</span></span>
<span id="cb177-2"><a href="Disease.html#cb177-2" tabindex="-1"></a>Ex9_5 <span class="ot">&lt;-</span> <span class="fu">inla</span>(</span>
<span id="cb177-3"><a href="Disease.html#cb177-3" tabindex="-1"></a>  Y2010 <span class="sc">~</span> Average.Score <span class="sc">+</span> <span class="fu">f</span>(ID  , <span class="at">model =</span> <span class="st">&quot;besag&quot;</span>, <span class="at">graph =</span> <span class="st">&quot;UK.adj&quot;</span>),</span>
<span id="cb177-4"><a href="Disease.html#cb177-4" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>,</span>
<span id="cb177-5"><a href="Disease.html#cb177-5" tabindex="-1"></a>  <span class="at">E =</span> E2010,</span>
<span id="cb177-6"><a href="Disease.html#cb177-6" tabindex="-1"></a>  <span class="at">data =</span> copd_df,</span>
<span id="cb177-7"><a href="Disease.html#cb177-7" tabindex="-1"></a>  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>)</span>
<span id="cb177-8"><a href="Disease.html#cb177-8" tabindex="-1"></a>)</span></code></pre></div>
<p>Summarize the results</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="Disease.html#cb178-1" tabindex="-1"></a><span class="co"># Summarizing smoothed SMRs</span></span>
<span id="cb178-2"><a href="Disease.html#cb178-2" tabindex="-1"></a><span class="fu">summary</span>(Ex9_5)</span></code></pre></div>
<pre><code>## 
## Call:
##    c(&quot;inla.core(formula = formula, family = family, contrasts = contrasts, 
##    &quot;, &quot; data = data, quantiles = quantiles, E = E, offset = offset, &quot;, &quot; 
##    scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
##    &quot;, &quot; lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
##    verbose, &quot;, &quot; lincomb = lincomb, selection = selection, control.compute 
##    = control.compute, &quot;, &quot; control.predictor = control.predictor, 
##    control.family = control.family, &quot;, &quot; control.inla = control.inla, 
##    control.fixed = control.fixed, &quot;, &quot; control.mode = control.mode, 
##    control.expert = control.expert, &quot;, &quot; control.hazard = control.hazard, 
##    control.lincomb = control.lincomb, &quot;, &quot; control.update = 
##    control.update, control.lp.scale = control.lp.scale, &quot;, &quot; 
##    control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
##    &quot;, &quot; inla.call = inla.call, inla.arg = inla.arg, num.threads = 
##    num.threads, &quot;, &quot; blas.num.threads = blas.num.threads, keep = keep, 
##    working.directory = working.directory, &quot;, &quot; silent = silent, inla.mode 
##    = inla.mode, safe = FALSE, debug = debug, &quot;, &quot; .parent.frame = 
##    .parent.frame)&quot;) 
## Time used:
##     Pre = 0.577, Running = 0.314, Post = 0.0489, Total = 0.94 
## Fixed effects:
##                 mean    sd 0.025quant 0.5quant 0.975quant   mode kld
## (Intercept)   -0.069 0.008     -0.084   -0.069     -0.054 -0.069   0
## Average.Score  0.182 0.012      0.158    0.182      0.206  0.182   0
## 
## Random effects:
##   Name     Model
##     ID Besags ICAR model
## 
## Model hyperparameters:
##                   mean   sd 0.025quant 0.5quant 0.975quant  mode
## Precision for ID 15.94 2.62      11.52    15.70      21.75 15.23
## 
## Marginal log-Likelihood:  -1493.27 
##  is computed 
## Posterior summaries for the linear predictor and the fitted values are computed
## (Posterior marginals needs also &#39;control.compute=list(return.marginals.predictor=TRUE)&#39;)</code></pre>
<div class="sourceCode" id="cb180"><pre class="sourceCode r foldable"><code class="sourceCode r"><span id="cb180-1"><a href="Disease.html#cb180-1" tabindex="-1"></a>observed <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(observed, <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb180-2"><a href="Disease.html#cb180-2" tabindex="-1"></a>phi_car <span class="ot">&lt;-</span>  Ex9_5<span class="sc">$</span>summary.random<span class="sc">$</span>ID</span>
<span id="cb180-3"><a href="Disease.html#cb180-3" tabindex="-1"></a></span>
<span id="cb180-4"><a href="Disease.html#cb180-4" tabindex="-1"></a>latent_car_df  <span class="ot">&lt;-</span>  <span class="fu">data.frame</span>(</span>
<span id="cb180-5"><a href="Disease.html#cb180-5" tabindex="-1"></a>  <span class="at">phi_mean =</span> phi_car<span class="sc">$</span>mean,</span>
<span id="cb180-6"><a href="Disease.html#cb180-6" tabindex="-1"></a>  <span class="at">phi_sd =</span> phi_car<span class="sc">$</span>sd</span>
<span id="cb180-7"><a href="Disease.html#cb180-7" tabindex="-1"></a>)</span>
<span id="cb180-8"><a href="Disease.html#cb180-8" tabindex="-1"></a><span class="co"># Combine latent spatial effect with england dataset</span></span>
<span id="cb180-9"><a href="Disease.html#cb180-9" tabindex="-1"></a>latent_car_df<span class="sc">$</span>ID <span class="ot">&lt;-</span> observed<span class="sc">$</span>ID</span>
<span id="cb180-10"><a href="Disease.html#cb180-10" tabindex="-1"></a>latent_car_england <span class="ot">&lt;-</span>  <span class="fu">merge</span>(england, latent_car_df, <span class="at">by =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb180-11"><a href="Disease.html#cb180-11" tabindex="-1"></a><span class="co"># Creating map of smoothed SMRs in England in 2010</span></span>
<span id="cb180-12"><a href="Disease.html#cb180-12" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb180-13"><a href="Disease.html#cb180-13" tabindex="-1"></a>  <span class="co"># Choose spatial object and column for plotting</span></span>
<span id="cb180-14"><a href="Disease.html#cb180-14" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> latent_car_england, <span class="fu">aes</span>(<span class="at">fill =</span> phi_mean)) <span class="sc">+</span></span>
<span id="cb180-15"><a href="Disease.html#cb180-15" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&#39;Latent effects INLA&#39;</span>) <span class="sc">+</span></span>
<span id="cb180-16"><a href="Disease.html#cb180-16" tabindex="-1"></a>  <span class="co"># Clear background and plot borders</span></span>
<span id="cb180-17"><a href="Disease.html#cb180-17" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.5%20inla%20smoothed%20SMRs-1.png" width="672" /></p>
<!-- ## Example 9.6: Fitting a Leroux Model using Nimble, Stan and CARBayes -->
<!-- This example uses the [englandlocalauthority.shp](https://github.com/spacetime-environ/stepi2/blob/main/data/copd/englandlocalauthority.shp), [copdmortalityobserved.csv](https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityobserved.csv), and -->
<!-- [copdmortalityexpected.csv](https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityexpected.csv) datasets from Chapter 6. -->
<!-- ### Nimble -->
<!-- ```{r Ex 9.6 nimble clean, include = FALSE} -->
<!-- rm(list=ls()) -->
<!-- ``` -->
<!-- ```{r Ex 9.6 nimble load, message=FALSE, warning=FALSE, message= FALSE} -->
<!-- library(ggplot2) # to plot map -->
<!-- library(spdep) # read the shapefile (read_sf) and build neighbors list (poly2nb) -->
<!-- library(nimble) -->
<!-- # Load data -->
<!-- # Reading in borders -->
<!-- england <- read_sf("data/copd/englandlocalauthority.shp") -->
<!-- # Reading in data -->
<!-- observed <- -->
<!--   read.csv(file = "data/copd/copdmortalityobserved.csv", row.names = 1) -->
<!-- expected <- -->
<!--   read.csv(file = "data/copd/copdmortalityexpected.csv") -->
<!-- covariates <- read.csv(file = "data/copd/copdavgscore.csv") -->
<!-- # Merge everything into one data frame -->
<!-- copd_df <- -->
<!--   cbind(observed,  expected) |> merge( -->
<!--     covariates, -->
<!--     by.x = "code", -->
<!--     by.y = "LA.CODE", -->
<!--     all.x = TRUE, -->
<!--     all.y = FALSE -->
<!--   ) -->
<!-- ``` -->
<!-- Define a function to obtain the number of neighbors. -->
<!-- ```{r Ex 9.6 nimble munge functions, echo = TRUE} -->
<!-- adjlist = function(W, N) { -->
<!--   adj = 0 -->
<!--   for (i in 1:N) { -->
<!--     for (j in 1:N) { -->
<!--       if (W[i, j] == 1) { -->
<!--         adj = append(adj, j) -->
<!--       } -->
<!--     } -->
<!--   } -->
<!--   adj = adj[-1] -->
<!--   return(adj) -->
<!-- } -->
<!-- ``` -->
<!-- Define the adjacency matrix and indexes for `stan` using the `nb2mat` and `adjlist` -->
<!-- ```{r Ex 9.6 nimble neighborhood} -->
<!-- # Create the neighborhood -->
<!-- W.nb <- -->
<!--   poly2nb(england, row.names = rownames(england)) -->
<!-- # Creates a matrix for following function call -->
<!-- W.mat <- nb2mat(W.nb, zero.policy = TRUE, style = "B") -->
<!-- # Define the spatial structure to use in stan -->
<!-- N <- length(unique(england$ID)) -->
<!-- neigh  <- adjlist(W.mat, N) -->
<!-- numneigh  <- apply(W.mat,2,sum) -->
<!-- # Define the precision matrix of Leroux -->
<!-- Q <- matrix(0, nrow = nrow(W.mat), ncol = ncol(W.mat)) -->
<!-- diag(Q) <- apply(W.mat, 1, sum) -->
<!-- Q <- Q - W.mat -->
<!-- ``` -->
<!-- ```{r Ex 9.6 nimble leroux model, warning=FALSE, message = FALSE, results='hide'} -->
<!-- Example9_6Nimble <- nimbleCode({ -->
<!--   # Likelihood -->
<!--   for (i in 1:N) { -->
<!--     y[i] ~ dpois(lambda[i]) -->
<!--     log(lambda[i]) <- log(E[i]) + b[i]  -->
<!--     mean_b[i] <- beta0 + beta1*x[i] -->
<!--    # b_centered[i] <- b[i] - b_mean -->
<!--   } -->
<!--   PrecMat[1:N, 1:N] <- tau*(rho*Q[1:N, 1:N] + (1-rho)*diag(N)) -->
<!--   # mean_b[1:N] <- nimRep(beta0, N) -->
<!--  # b_mean <- sum(b[1:N])/N -->
<!--     # Priors -->
<!--   beta0 ~ dnorm(0, sd = 1) -->
<!--   beta1 ~ dnorm(0, sd = 1) -->
<!--   b[1:N] ~ dmnorm(mean = mean_b[1:N], prec = PrecMat[1:N, 1:N]) -->
<!--   tau <- 1 / (sigma_b ^ 2) -->
<!--   sigma_b ~ T(dt(0,1,1),0,) -->
<!--   rho ~ dunif(0, 1) -->
<!--   # Fitted values and likelihood for WAIC -->
<!--   # for (i in 1:N) { -->
<!--   #   fitted[i] ~ dpois(lambda[i]) -->
<!--   # } -->
<!-- }) -->
<!-- #  Define the constants, data and initial values lists and run the model. -->
<!-- # constants list -->
<!-- constants <- list( -->
<!--   N = N, -->
<!--   E = copd_df$E2010, -->
<!--   Q = Q -->
<!-- ) -->
<!-- # data list -->
<!-- ex.data <- -->
<!--   list(y = copd_df$Y2010, -->
<!--        x = as.vector(scale(copd_df$Average.Score))) # vector of covariates -->
<!-- inits <-  list( -->
<!--   beta0 = rnorm(1), -->
<!--   beta1 = rnorm(1), -->
<!-- #  fitted = rpois(N, 2), -->
<!--   sigma_b = 1, -->
<!--   b = rnorm(N), -->
<!--   rho = 0.5 -->
<!-- ) -->
<!-- params <- c("beta0", "beta1", "b", "sigma_b", "tau" ,"rho") -->
<!-- # Run model in nimble -->
<!-- mcmc.out <- nimbleMCMC( -->
<!--   code = Example9_6Nimble, -->
<!--   constants = constants, -->
<!--   data = ex.data, -->
<!--   inits = inits, -->
<!--   monitors = params, -->
<!--   niter = 80000, -->
<!--   nburnin = 40000, -->
<!--   thin = 15, -->
<!--   WAIC = TRUE, -->
<!--   nchains = 2, -->
<!--   summary = TRUE, -->
<!--   samplesAsCodaMCMC = TRUE -->
<!-- ) -->
<!-- ``` -->
<!-- Show the WAIC, effective sample size, and trace plots for some of the parameters. -->
<!-- ```{r Ex 9.6 WAIC, ESS and traceplots } -->
<!-- mcmc.out$WAIC -->
<!-- min(coda::effectiveSize(mcmc.out$samples)) -->
<!-- plot(mcmc.out$samples[, c("beta0")], bty = "n", main = "beta0") -->
<!-- plot(mcmc.out$samples[, c("beta1")], bty = "n",  main = "beta1") -->
<!-- plot(mcmc.out$samples[, c("b[2]")], bty = "n",  main = "b[2]") -->
<!-- plot(mcmc.out$samples[, c("sigma_b")], bty = "n", main = "sigma_b") -->
<!-- ``` -->
<!-- ```{r Ex 9.6 nimble leroux summary, echo = TRUE} -->
<!-- # Extract samples -->
<!-- variables <- c("beta0", "beta1","sigma_b", "rho") -->
<!-- summary_nimble <- mcmc.out$summary$all.chains -->
<!-- summary_nimble[variables,] -->
<!-- ``` -->
<!-- Map the mean of the posterior estimate for the latent effect. -->
<!-- ```{r Ex 9.6 plot map nimble} -->
<!-- samples_Leroux_b <- -->
<!--   summary_Leroux_nimble[grepl("b\\[", rownames(summary_CAR_nimble)), ] |> as.data.frame() -->
<!-- observed <- tibble::rownames_to_column(observed, "ID") -->
<!-- samples_Leroux_b$ID <- observed$ID -->
<!-- CAR_nimble_merge <- merge(england, samples_CAR_b, by = "ID") -->
<!-- ggplot() + -->
<!--   # Choose spatial object and column for plotting -->
<!--   geom_sf(data = Leroux_nimble_merge, aes(fill = Mean)) + -->
<!--   # Change legend's label -->
<!--   labs(fill = 'Latent effects nimble') + -->
<!--   # Clear background and plot borders -->
<!--  theme_void() -->
<!-- ``` -->
<!-- ### Stan -->
<!-- Here, we implement the CAR model using `stan`. -->
<!-- ```{r Ex 9.6 stan clean, include = FALSE} -->
<!-- rm(list=ls()) -->
<!-- ``` -->
<!-- ```{r Ex 9.6 stan load, message=FALSE, echo = FALSE, warning=FALSE, message= FALSE} -->
<!-- library(ggplot2) -->
<!-- library(loo) # To calculate WAIC and loo later -->
<!-- library(rstan) -->
<!-- library(spdep) -->
<!-- # Additional settings for stan -->
<!-- options(mc.cores = parallel::detectCores()) -->
<!-- rstan_options(auto_write = TRUE) -->
<!-- # Load data -->
<!-- # Reading in borders -->
<!-- england <- read_sf("data/copd/englandlocalauthority.shp") -->
<!-- # Reading in data -->
<!-- observed <- -->
<!--   read.csv(file = "data/copd/copdmortalityobserved.csv", row.names = 1) -->
<!-- expected <- -->
<!--   read.csv(file = "data/copd/copdmortalityexpected.csv") -->
<!-- covariates <- read.csv(file = "data/copd/copdavgscore.csv") -->
<!-- # Merge everything into one data frame -->
<!-- copd_df <- -->
<!--   cbind(observed,  expected) |> merge( -->
<!--     covariates, -->
<!--     by.x = "code", -->
<!--     by.y = "LA.CODE", -->
<!--     all.x = TRUE, -->
<!--     all.y = FALSE -->
<!--   ) -->
<!-- ``` -->
<!-- We will need two functions to structure the matrix of neighbors that will be needed in `stan`. -->
<!-- ```{r Ex 9.6 stan munge functions, echo = TRUE} -->
<!-- adjlist = function(W, N) { -->
<!--   adj = 0 -->
<!--   for (i in 1:N) { -->
<!--     for (j in 1:N) { -->
<!--       if (W[i, j] == 1) { -->
<!--         adj = append(adj, j) -->
<!--       } -->
<!--     } -->
<!--   } -->
<!--   adj = adj[-1] -->
<!--   return(adj) -->
<!-- } -->
<!-- mungeCARdata4stan = function(adjBUGS, numBUGS) { -->
<!--   N = length(numBUGS) -->
<!--   nn = numBUGS -->
<!--   N_edges = length(adjBUGS) / 2 -->
<!--   node1 = vector(mode = "numeric", length = N_edges) -->
<!--   node2 = vector(mode = "numeric", length = N_edges) -->
<!--   iAdj = 0 -->
<!--   iEdge = 0 -->
<!--   for (i in 1:N) { -->
<!--     for (j in 1:nn[i]) { -->
<!--       iAdj = iAdj + 1 -->
<!--       if (i < adjBUGS[iAdj]) { -->
<!--         iEdge = iEdge + 1 -->
<!--         node1[iEdge] = i -->
<!--         node2[iEdge] = adjBUGS[iAdj] -->
<!--       } -->
<!--     } -->
<!--   } -->
<!--   return (list( -->
<!--     "N" = N, -->
<!--     "N_edges" = N_edges, -->
<!--     "node1" = node1, -->
<!--     "node2" = node2 -->
<!--   )) -->
<!-- } -->
<!-- ``` -->
<!-- This model is in a separate file called `Example8_3.stan` that will be called later. -->
<!-- ```{r engine='bash', comment='', echo = FALSE} -->
<!-- cat functions/Example9_6.stan -->
<!-- ``` -->
<!-- <!-- REVIEW: I am missing the adjacency matrix but I calculated like they did for the CARBayes example, is that right? -->
<p>–&gt;</p>
<!-- Define the adjacency matrix and indexes for `stan` using the `nb2mat` and `adjlist` -->
<!-- ```{r Ex 9.6 stan car effects, warning=FALSE, results='hide', message = FALSE, cache=TRUE} -->
<!-- # Create the neighborhood -->
<!-- W.nb <- -->
<!--   poly2nb(england, row.names = rownames(england)) -->
<!-- # Creates a matrix for following function call -->
<!-- W.mat <- nb2mat(W.nb, style = "B") -->
<!-- # Define the spatial structure to use in stan -->
<!-- N <- length(unique(england$ID)) -->
<!-- neigh <- adjlist(W.mat, N) -->
<!-- numneigh  <-  apply(W.mat, 2, sum) -->
<!-- nbs <- mungeCARdata4stan(neigh, numneigh) -->
<!-- # Define data and variables for Stan model -->
<!-- y <- copd_df$Y2010 -->
<!-- E <- copd_df$E2010 -->
<!-- X <- as.numeric(scale(copd_df$Average.Score)) -->
<!-- # Obtain cumulative number of neighbors -->
<!-- N1=N+1 -->
<!-- C=numeric()  -->
<!-- C[1]=0 -->
<!-- for (j in 2:N1)  -->
<!--   C[j]=C[j-1]+ numneigh[j-1] # cumulative number of neighbours -->
<!-- ex.data <- list( -->
<!--   N = nbs$N, -->
<!--   y = y, -->
<!--   E = E, -->
<!--   p = 1, -->
<!--   C = C, -->
<!--   d = numneigh, -->
<!--   X = as.matrix(X), -->
<!--   N_edges = nbs$N_edges, -->
<!--   node1 = nbs$node1, -->
<!--   node2 = nbs$node2 -->
<!-- ) -->
<!-- Example9_6Stan  <- stan( -->
<!--   file = "functions/Example9_6.stan", -->
<!--   data = ex.data, -->
<!--   warmup = 10000, -->
<!--   iter = 20000, -->
<!--   chains = 2, -->
<!--   thin = 10, -->
<!--   pars = c("beta0", "beta","sigma_s", "b", "log_lik", "rho"), -->
<!--   include = TRUE -->
<!-- ) -->
<!-- ``` -->
<!-- Show traceplots. -->
<!-- ```{r Ex 9.6 stan CAR traceplots} -->
<!-- #computing WAIC using the package loo -->
<!-- loglikcar <- extract_log_lik(Example9_6Stan) -->
<!-- waiccar <- waic(loglikcar) -->
<!-- waiccar -->
<!-- rstan::traceplot(Example9_6Stan, pars = c("beta0","beta","sigma_s")) -->
<!-- ``` -->
<!-- Show the posterior summary for the parameters if interest. -->
<!-- Keep in mind that in the stan model the we are sampling the standard deviation of the random effect unlike `CARBayes` where the variance is obtained. -->
<!-- ```{r Ex 9.6 stan CAR results, echo = TRUE} -->
<!-- # Extract samples -->
<!-- summary_CAR_stan <- -->
<!--   summary( -->
<!--     Example9_6Stan, -->
<!--     pars = c("beta0", "beta","sigma_s"), -->
<!--     probs = c(0.025, 0.975) -->
<!--   ) -->
<!-- summary_CAR_stan$summary -->
<!-- ``` -->
<!-- Map the mean of the posterior estimate for the latent effect. -->
<!-- ```{r Ex 9.6 plot map stan} -->
<!-- summary_CAR_stan_b <- -->
<!--   summary( -->
<!--     Example9_6Stan, -->
<!--     pars = c("b"), -->
<!--     probs = c(0.025, 0.975) -->
<!--   ) -->
<!-- observed <- tibble::rownames_to_column(observed, "ID") -->
<!-- summary_CAR_stan_b$ID <- observed$ID -->
<!-- CAR_stan_merge <- merge(england, summary_CAR_stan_b, by = "ID") -->
<!-- ggplot() + -->
<!--   # Choose spatial object and column for plotting -->
<!--   geom_sf(data = CAR_stan_merge, aes(fill = summary.mean)) + -->
<!--   # Change legend's label -->
<!--   labs(fill = 'Latent effects stan') + -->
<!--   # Clear background and plot borders -->
<!--   theme_void() -->
<!-- ``` -->
<!-- ### CARBayes -->
<!-- ```{r Ex 9.6 clean, include=FALSE} -->
<!-- rm(list=ls()) -->
<!-- ``` -->
<!-- ```{r Ex 9.6 carbayes load, message=FALSE, warning=FALSE, message= FALSE} -->
<!-- library(CARBayes) -->
<!-- library(ggplot2) -->
<!-- library(sf) -->
<!-- library(spdep) -->
<!-- # Reading in borders -->
<!-- england <- read_sf("data/copd/englandlocalauthority.shp") -->
<!-- # Reading in data -->
<!-- observed <- -->
<!--   read.csv(file = "data/copd/copdmortalityobserved.csv", row.names = 1) -->
<!-- expected <- -->
<!--   read.csv(file = "data/copd/copdmortalityexpected.csv") -->
<!-- covariates <- read.csv(file = "data/copd/copdavgscore.csv") -->
<!-- # Merge everything into one data frame -->
<!-- copd_df <- -->
<!--   cbind(observed,  expected) |> merge( -->
<!--     covariates, -->
<!--     by.x = "code", -->
<!--     by.y = "LA.CODE", -->
<!--     all.x = TRUE, -->
<!--     all.y = FALSE -->
<!--   ) -->
<!-- copd_df$Average.Score <- as.numeric(scale(copd_df$Average.Score)) -->
<!-- ``` -->
<!-- ```{r Ex 9.6 carbayes neighborhood} -->
<!-- # Create the neighborhood -->
<!-- W.nb <- -->
<!--   poly2nb(england, row.names = rownames(england)) -->
<!-- # Creates a matrix for following function call -->
<!-- W.mat <- nb2mat(W.nb, style = "B") -->
<!-- ``` -->
<!-- ```{r Ex 9.6 carbayes run, results='hide', message = FALSE, cache = TRUE} -->
<!-- # Running smoothing model -->
<!-- Ex9_6 <- -->
<!--   S.CARleroux( -->
<!--     # Model Formula -->
<!--     formula = Y2010 ~ offset(log(E2010)) + Average.Score, -->
<!--     # data frame with data -->
<!--     data = copd_df, -->
<!--     # Choosing Poisson Regression -->
<!--     family = "poisson", -->
<!--     # Neighborhood matrix -->
<!--     W = W.mat, -->
<!--     # Number of burn in samples -->
<!--     burnin = 20000, -->
<!--     # Number of MCMC samples -->
<!--     n.sample = 100000, -->
<!--     thin = 10 -->
<!--     # Note that here we don't set rho to any value as it need to be estimated -->
<!--   ) -->
<!-- ``` -->
<!-- We can extract the new smoother values from the model output and divide them by the expected values in order to compare both methods. -->
<!-- ```{r Ex 9.6 carbayes smoothed SMRs, class.source = 'foldable' } -->
<!-- # Creating a dataset with smoothed SMRs in 2010 -->
<!-- SMR2010 <- Ex9_6$fitted.values /  copd_df$E2010 -->
<!-- SMR_smooth <- as.data.frame(SMR2010, row.names = rownames(observed)) -->
<!-- # Printing first six rows of smoothed SMRs -->
<!-- head(SMR_smooth) -->
<!-- # Summarizing smoothed SMRs -->
<!-- summary(SMR_smooth) -->
<!-- # Summary of the parameters under the CAR model. -->
<!-- Ex9_6$summary.results[] -->
<!-- ``` -->
<!-- <!-- QUESTION: What do we want the latent effect or the fitted values? -->
<p>–&gt;</p>
<!-- Use `ggplot()` and `geom_sf()` to plot the map of the latent spatial effect. -->
<!-- ```{r Ex 9.6 carbayes map smoothed SMRs, class.source = 'foldable'} -->
<!-- observed <- tibble::rownames_to_column(observed, "ID") -->
<!-- phi_car <-  Ex9_6$samples$phi -->
<!-- latent_car_df  <-  data.frame( -->
<!--   phi_mean = apply(phi_car, 2, mean), -->
<!--   phi_sd = apply(phi_car, 2, sd) -->
<!-- ) -->
<!-- # Combine latent spatial effect with england dataset -->
<!-- latent_car_df$ID <- observed$ID -->
<!-- latent_car_england <-  merge(england, latent_car_df, by = "ID") -->
<!-- # Creating map of smoothed SMRs in England in 2010 -->
<!-- ggplot() + -->
<!--   # Choose spatial object and column for plotting -->
<!--   geom_sf(data = latent_car_england, aes(fill = phi_mean)) + -->
<!--   labs(fill = 'Latent effects CARbayes Leroux model') + -->
<!--   # Clear background and plot borders -->
<!--   theme_void() -->
<!-- ``` -->

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="trusted.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="hazards.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/09-Chpt9.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
