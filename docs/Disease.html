<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Disease-spatial patterns | Spatio-Temporal Methods in Environmental Epidemiology with R. Second Edition</title>
  <meta name="description" content="Chapter 9 Disease-spatial patterns | Spatio-Temporal Methods in Environmental Epidemiology with R. Second Edition" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Disease-spatial patterns | Spatio-Temporal Methods in Environmental Epidemiology with R. Second Edition" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/img/cover.jpg" />
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Disease-spatial patterns | Spatio-Temporal Methods in Environmental Epidemiology with R. Second Edition" />
  
  
  <meta name="twitter:image" content="/img/cover.jpg" />

<meta name="author" content="Gavin Shaddick, James V. Zidek, and Alexandra M. Schmidt" />


<meta name="date" content="2023-08-28" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<link rel="prev" href="trusted.html"/>
<link rel="next" href="hazards.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatio-temporal methods in environmental epidemiology</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="preface-to-second-edition.html"><a href="preface-to-second-edition.html"><i class="fa fa-check"></i>PREFACE TO SECOND EDITION</a></li>
<li class="chapter" data-level="1" data-path="why.html"><a href="why.html"><i class="fa fa-check"></i><b>1</b> An overview of spatio-temporal epidemiology and knowledge discovery?</a></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> An introduction to modelling health risks and impacts</a>
<ul>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.7-estimating-the-smr-using-a-poisson-glm"><i class="fa fa-check"></i>Example 2.7: Estimating the SMR using a Poisson GLM</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.8-estimating-the-smr-using-quasi-likelihood"><i class="fa fa-check"></i>Example 2.8: Estimating the SMR using quasi-likelihood</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.9-modelling-differences-in-smrs-in-relation-to-differences-in-exposures"><i class="fa fa-check"></i>Example 2.9: Modelling differences in SMRs in relation to differences in exposures</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.10-modelling-the-risks-associated-with-lagged-effects-of-air-pollution"><i class="fa fa-check"></i>Example 2.10: Modelling the risks associated with lagged effects of air pollution</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.10-estimating-the-odds-ratio-in-a-case-control-study-using-a-logistic-model"><i class="fa fa-check"></i>Example 2.10: Estimating the odds ratio in a case-control study using a logistic model</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.11-estimating-the-odds-ratio-of-asthma-associated-with-proximity-to-roads"><i class="fa fa-check"></i>Example 2.11: Estimating the odds ratio of asthma associated with proximity to roads</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="uncertainty.html"><a href="uncertainty.html"><i class="fa fa-check"></i><b>3</b> The importance of uncertainty: assessment and quantification</a>
<ul>
<li class="chapter" data-level="" data-path="uncertainty.html"><a href="uncertainty.html#supplementary-material"><i class="fa fa-check"></i>Supplementary Material</a>
<ul>
<li class="chapter" data-level="" data-path="uncertainty.html"><a href="uncertainty.html#more-on-qualitative-uncertainty"><i class="fa fa-check"></i>More on qualitative uncertainty</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>4</b> Extracting information from data</a>
<ul>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#getting-to-know-the-structure-of-dataframes"><i class="fa fa-check"></i>Getting to know the structure of dataframes</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#extracting-and-creating-variables"><i class="fa fa-check"></i>Extracting and creating variables</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#simple-manipulations-using-tidyverse"><i class="fa fa-check"></i>Simple manipulations using Tidyverse</a>
<ul>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#filter-rows-in-tidyverse"><i class="fa fa-check"></i>Filter rows in Tidyverse</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#sorting-rows-in-tidyverse"><i class="fa fa-check"></i>Sorting rows in Tidyverse</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#select-columns-in-tidyverse"><i class="fa fa-check"></i>Select columns in Tidyverse</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#adding-columns"><i class="fa fa-check"></i>Adding columns</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#pipes"><i class="fa fa-check"></i>Pipes</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#chaining-pipes"><i class="fa fa-check"></i>Chaining pipes</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#grouping-and-summarizing"><i class="fa fa-check"></i>Grouping and summarizing</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#summarize"><i class="fa fa-check"></i>Summarize</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#example-4.1-health-impacts-associated-with-outdoor-air-pollution"><i class="fa fa-check"></i>Example 4.1: Health impacts associated with outdoor air pollution</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#example-4.3.-mapping-cancer-incidence-in-southern-and-eastern-serbia"><i class="fa fa-check"></i>Example 4.3. Mapping cancer incidence in Southern and Eastern Serbia</a>
<ul>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#creating-maps-of-southern-and-eastern-serbia"><i class="fa fa-check"></i>Creating maps of Southern and Eastern Serbia</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#example-4.4-cancer-in-bor"><i class="fa fa-check"></i>Example 4.4 Cancer in Bor</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#calculating-smrs"><i class="fa fa-check"></i>Calculating SMRs</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="embracing.html"><a href="embracing.html"><i class="fa fa-check"></i><b>5</b> Embracing uncertainty: the Bayesian approach</a></li>
<li class="chapter" data-level="6" data-path="computation.html"><a href="computation.html"><i class="fa fa-check"></i><b>6</b> Approaches to Bayesian Computation</a>
<ul>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#example-6.2-gibbs-sampling-with-a-poisson-gamma-model---hospital-admissions-for-chronic-obstructive-pulmonary-disease-copd-for-england-between-2001-2010"><i class="fa fa-check"></i>Example 6.2: Gibbs sampling with a Poisson-Gamma model - hospital admissions for chronic obstructive pulmonary disease (COPD) for England between 2001-2010</a>
<ul>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#modelling-the-raw-standardized-mortality-rates-smrs"><i class="fa fa-check"></i>Modelling the raw standardized mortality rates (SMRs)</a></li>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#mcmc-implementation-of-the-poisson-gamma-model-in-r"><i class="fa fa-check"></i>MCMC implementation of the Poisson-Gamma model in <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#code-for-the-poisson-gamma-model-in-nimble"><i class="fa fa-check"></i>Code for the Poisson-Gamma model in Nimble</a></li>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#example-6.3-fitting-a-poisson-regression-model"><i class="fa fa-check"></i>Example 6.3: Fitting a Poisson regression model</a>
<ul>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#nimble"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#stan"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Strategies.html"><a href="Strategies.html"><i class="fa fa-check"></i><b>7</b> Strategies for modelling</a>
<ul>
<li class="chapter" data-level="" data-path="Strategies.html"><a href="Strategies.html#example-7.6-variable-selection-in-land-use-regression-using-lasso-and-horseshoe-priors"><i class="fa fa-check"></i>Example 7.6 Variable selection in land use regression using lasso and horseshoe priors</a>
<ul>
<li class="chapter" data-level="" data-path="Strategies.html"><a href="Strategies.html#nimble-1"><i class="fa fa-check"></i>Nimble</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="trusted.html"><a href="trusted.html"><i class="fa fa-check"></i><b>8</b> The challenges of working with real-world data</a>
<ul>
<li class="chapter" data-level="" data-path="trusted.html"><a href="trusted.html#solutions-to-selected-exercises"><i class="fa fa-check"></i>Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="trusted.html"><a href="trusted.html#placeholder-repeat-the-black-smoke-analysis-conducted-in-watson-et-al.-2019.-in-the-naive-model."><i class="fa fa-check"></i>PLACEHOLDER: Repeat the Black Smoke analysis conducted in Watson et al. 2019. in the “naive” model.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="Disease.html"><a href="Disease.html"><i class="fa fa-check"></i><b>9</b> Disease-spatial patterns</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010"><i class="fa fa-check"></i>Example 9.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010</a>
<ul>
<li class="chapter" data-level="9.0.1" data-path="Disease.html"><a href="Disease.html#empirical-bayes-estimate-using-spatialepi"><i class="fa fa-check"></i><b>9.0.1</b> Empirical Bayes estimate using <code>SpatialEpi</code></a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-2"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-1"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-rstan"><i class="fa fa-check"></i>Example 9.3: Fitting a conditional spatial model in <code>NIMBLE</code> and <code>RStan</code></a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-3"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-2"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.4-fitting-a-conditional-spatial-model-using-carbayes"><i class="fa fa-check"></i>Example 9.4: Fitting a conditional spatial model using CARBayes</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.5-fitting-a-conditional-model-using-inla"><i class="fa fa-check"></i>Example 9.5: Fitting a conditional model using INLA</a></li>
<li class="chapter" data-level="9.1" data-path="Disease.html"><a href="Disease.html#supplementary-example-fitting-a-leroux-model-to-the-copd-dataset-using-nimble-stan-and-carbayes"><i class="fa fa-check"></i><b>9.1</b> Supplementary Example: Fitting a Leroux model to the COPD dataset using Nimble, Stan and CARBayes</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="hazards.html"><a href="hazards.html"><i class="fa fa-check"></i><b>10</b> Environmental hazards-spatial models</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.1-spatial-patterns-in-lead-concentrations-in-the-soil-of-the-meuse-river-flood-plain"><i class="fa fa-check"></i>Example 10.1 Spatial patterns in lead concentrations in the soil of the Meuse River flood plain</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.2-examining-the-log-concentrations-of-lead-in-the-meuse-river-flood-plain"><i class="fa fa-check"></i>Example 10.2: Examining the log concentrations of lead in the Meuse River flood plain</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state"><i class="fa fa-check"></i>Example 10.3: Mapping the locations of ozone monitoring sites in New York State</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.5-spatial-prediction-of-temperatures-in-california"><i class="fa fa-check"></i>Example 10.5: Spatial prediction of temperatures in California</a></li>
<li class="chapter" data-level="10.1" data-path="hazards.html"><a href="hazards.html#example-10.6-fitting-a-bayesian-exponential-spatial-model-using-nimble"><i class="fa fa-check"></i><b>10.1</b> Example 10.6 Fitting a Bayesian exponential spatial model using NIMBLE</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.7-spatial-prediction-of-pm_2.5-in-europe"><i class="fa fa-check"></i>Example 10.7 Spatial prediction of <span class="math inline">\(PM_{2.5}\)</span> in Europe</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.10-creating-a-mesh-black-smoke-monitoring-locations-in-the-uk"><i class="fa fa-check"></i>Example 10.10 Creating a mesh: black smoke monitoring locations in the UK</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.12-plotting-directional-variograms-for-temperatures-in-california"><i class="fa fa-check"></i>Example 10.12 Plotting directional variograms for temperatures in California</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.14-spatial-modeling-of-malaria-in-gambia"><i class="fa fa-check"></i>Example 10.14: Spatial modeling of malaria in Gambia</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-4"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-3"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#supplementary-material-1"><i class="fa fa-check"></i>Supplementary Material</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-analysis-of-benzene-concentrations-across-montreal-qc-canada"><i class="fa fa-check"></i>Example: Analysis of benzene concentrations across Montreal, QC, Canada</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.2-examining-the-log-concentrations-of-benzene-in-montreal"><i class="fa fa-check"></i>Extra 10.2: Examining the log concentrations of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.5-variogram"><i class="fa fa-check"></i>Extra 10.5: Variogram</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal"><i class="fa fa-check"></i>Extra 10.6 Basic spatial modelling and prediction of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.8-spatial-modelling-of-benzene-in-montreal"><i class="fa fa-check"></i>Extra 10.8 Spatial modelling of Benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.9-spatial-predictions"><i class="fa fa-check"></i>Extra 10.9: Spatial predictions</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.10-inla-creating-a-mesh"><i class="fa fa-check"></i>Extra 10.10: INLA, creating a mesh</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal"><i class="fa fa-check"></i>Extra 10.12: Fitting an SPDE model using R–INLA: benzene concentration in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.13-directional-variograms"><i class="fa fa-check"></i>Extra 10.13: Directional variograms</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="Time.html"><a href="Time.html"><i class="fa fa-check"></i><b>11</b> Modelling temporal data: time series analysis and forecasting</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.1-ground-level-ozone-concentrations"><i class="fa fa-check"></i>Example 11.1 Ground level ozone concentrations</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.2-low-pass-filtering-of-ozone-levels-using-the-moving-average"><i class="fa fa-check"></i>Example 11.2 Low-pass filtering of ozone levels using the moving average</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.12-forecasting-ozone-levels"><i class="fa fa-check"></i>Example 11.12 Forecasting ozone levels</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.13-forecasting-volcanic-ash"><i class="fa fa-check"></i>Example 11.13 Forecasting volcanic ash</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="exposure.html"><a href="exposure.html"><i class="fa fa-check"></i><b>12</b> Exposure assessment-over space and time</a>
<ul>
<li class="chapter" data-level="" data-path="exposure.html"><a href="exposure.html#example-idk-spatio-temporal-model-for-the-uk-ozone-data"><i class="fa fa-check"></i>Example IDK: Spatio-temporal model for the UK ozone data</a>
<ul>
<li class="chapter" data-level="" data-path="exposure.html"><a href="exposure.html#nimble-7"><i class="fa fa-check"></i>Nimble</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="causality.html"><a href="causality.html"><i class="fa fa-check"></i><b>13</b> Causality-roadblocks on the way to it</a>
<ul>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#solutions-to-selected-exercises-1"><i class="fa fa-check"></i>Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.16-load-the-italy-and-china-data-described-in-example-13.3-and-included-in-the-supplementary-bookdown-material-into-r."><i class="fa fa-check"></i>Question 13.16: Load the Italy and China data, described in Example 13.3, and included in the supplementary Bookdown material into R.</a></li>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.17-using-the-italy-and-china-data-stratified-by-the-age-groups-70-and-geq-70-obtain-empirical-estimates-of-p_1-and-p_2-as-defined-in-an-sdis.-in-the-following-questions-assume-that-p_1-and-p_2-are-the-population-values."><i class="fa fa-check"></i>Question 13.17: Using the Italy and China data stratified by the age groups <span class="math inline">\(&lt;70\)</span> and <span class="math inline">\(\geq 70\)</span>, obtain empirical estimates of <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span>, as defined in an SDis. In the following questions, assume that <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> are the population values.</a></li>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.18-stratify-the-italy-and-china-data-by-the-age-groups-50-and-geq-50.-display-the-corresponding-contingency-tables."><i class="fa fa-check"></i>Question 13.18: Stratify the Italy and China data by the age groups <span class="math inline">\(&lt;50\)</span> and <span class="math inline">\(\geq 50\)</span>. Display the corresponding contingency tables.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="monitoring.html"><a href="monitoring.html"><i class="fa fa-check"></i><b>14</b> Better monitoring network design-getting better measurements</a></li>
<li class="chapter" data-level="15" data-path="frontiers.html"><a href="frontiers.html"><i class="fa fa-check"></i><b>15</b> Current frontiers</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html"><i class="fa fa-check"></i>Course</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatio-Temporal Methods in Environmental Epidemiology with R. Second Edition</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="Disease" class="section level1 hasAnchor" number="9">
<h1><span class="header-section-number">Chapter 9</span> Disease-spatial patterns<a href="Disease.html#Disease" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter contains an introduction to different types of spatial data, the theory of spatial lattice processes and introduces disease mapping and models for performing smoothing of risks over space. The reader will have gained an understanding of the following topics:</p>
<p>disease mapping and how to improve estimates of risk by borrowing strength from adjacent regions which can reduce the instability inherent in risk estimates based on small (expected) numbers;</p>
<ul>
<li>how smoothing can be performed using either the empirical Bayes or fully Bayesian approaches;</li>
<li>computational methods for handling areal data;</li>
<li>Besag’s seminal contributions to the field of spatial statistics including the very important concept of a Markov random field;</li>
<li>approaches to modelling areal data including conditional autoregressive models;</li>
<li>how Bayesian spatial models for lattice data can be fit using NIMBLE, RStan and R–INLA.</li>
</ul>
<div id="example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010" class="section level2 unnumbered hasAnchor">
<h2>Example 9.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010<a href="Disease.html#example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Here we consider hospitalization for a respiratory condition, chronic obstructive pulmonary disease (COPD), in England in 2010. There are <span class="math inline">\(N_l=324\)</span> local authority administrative areas each with an observed, <span class="math inline">\(Y_l\)</span> and expected, <span class="math inline">\(E_l\)</span>, number of cases, <span class="math inline">\(l=1,...,324\)</span>. As described in
Section 2.4 the expected numbers were calculated using indirect standardization by applying the
age–sex specific rates for the whole of England to the age–sex population profile of each of the areas. In order to perform empirical Bayes smoothing, we will use the <code>eBayes</code> function in the <code>SpatialEpi</code> package.
This example uses the <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/englandlocalauthority.shp">englandlocalauthority.shp</a>, <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityobserved.csv">copdmortalityobserved.csv</a>, and
<a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityexpected.csv">copdmortalityexpected.csv</a> datasets.</p>
<div id="empirical-bayes-estimate-using-spatialepi" class="section level3 hasAnchor" number="9.0.1">
<h3><span class="header-section-number">9.0.1</span> Empirical Bayes estimate using <code>SpatialEpi</code><a href="Disease.html#empirical-bayes-estimate-using-spatialepi" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="Disease.html#cb231-1" tabindex="-1"></a><span class="co"># requires SpatialEpi package</span></span>
<span id="cb231-2"><a href="Disease.html#cb231-2" tabindex="-1"></a><span class="fu">library</span> (SpatialEpi)</span>
<span id="cb231-3"><a href="Disease.html#cb231-3" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># package used to read shapefiles</span></span>
<span id="cb231-4"><a href="Disease.html#cb231-4" tabindex="-1"></a><span class="co"># Laoding the borders of England</span></span>
<span id="cb231-5"><a href="Disease.html#cb231-5" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/copd/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb231-6"><a href="Disease.html#cb231-6" tabindex="-1"></a><span class="co"># Loading the data</span></span>
<span id="cb231-7"><a href="Disease.html#cb231-7" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb231-8"><a href="Disease.html#cb231-8" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb231-9"><a href="Disease.html#cb231-9" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb231-10"><a href="Disease.html#cb231-10" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityexpected.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb231-11"><a href="Disease.html#cb231-11" tabindex="-1"></a><span class="co">#observed data</span></span>
<span id="cb231-12"><a href="Disease.html#cb231-12" tabindex="-1"></a>Y <span class="ot">&lt;-</span> observed<span class="sc">$</span>Y2010</span>
<span id="cb231-13"><a href="Disease.html#cb231-13" tabindex="-1"></a><span class="co"># offset</span></span>
<span id="cb231-14"><a href="Disease.html#cb231-14" tabindex="-1"></a>E <span class="ot">&lt;-</span> expected<span class="sc">$</span>E2010</span>
<span id="cb231-15"><a href="Disease.html#cb231-15" tabindex="-1"></a></span>
<span id="cb231-16"><a href="Disease.html#cb231-16" tabindex="-1"></a>RRs <span class="ot">=</span> <span class="fu">eBayes</span> (Y , E )</span>
<span id="cb231-17"><a href="Disease.html#cb231-17" tabindex="-1"></a><span class="fu">plot</span> ( RRs <span class="sc">$</span> SMR , RRs <span class="sc">$</span> RR , <span class="at">xlim =</span> <span class="fu">c</span> (<span class="dv">0</span> ,<span class="dv">2</span>) , <span class="at">ylim =</span> <span class="fu">c</span> (<span class="dv">0</span> ,<span class="dv">2</span>) , <span class="at">xlab =</span> <span class="st">&quot;</span></span>
<span id="cb231-18"><a href="Disease.html#cb231-18" tabindex="-1"></a><span class="st">SMRs &quot;</span> , <span class="at">ylab =</span> <span class="st">&quot; RRs &quot;</span> )</span>
<span id="cb231-19"><a href="Disease.html#cb231-19" tabindex="-1"></a><span class="fu">abline</span> ( <span class="at">a =</span><span class="dv">0</span> , <span class="at">b =</span><span class="dv">1</span> , <span class="at">col =</span> <span class="st">&quot; red &quot;</span> , <span class="at">lwd =</span><span class="dv">3</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20SpatialEpi-1.png" width="672" /></p>
<p>The smoothing can be seen with lower and higher SMRs being brought close to the overall average, <span class="math inline">\(\mu\)</span> which in this case is <span class="math inline">\(\exp(-0.0309) = 0.9696\)</span>. Note that in this example, the areas are relatively large and would be expected to have substantial populations, so the effect of the smoothing is limited. In this example, <span class="math inline">\(\alpha\)</span> was estimated to be 14.6. For a fully Bayesian, rather than empirical Bayes, analysis we can use NIMBLE; and this is what we present next.</p>
</div>
<div id="nimble-2" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="Disease.html#nimble-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<!--- ```{r Ex 9.1 nimble load, echo=TRUE, message=FALSE, warning=FALSE}

# Load nimble
library(nimble)
library(sf) # package used to read shapefiles
```
--->
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="Disease.html#cb232-1" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb232-2"><a href="Disease.html#cb232-2" tabindex="-1"></a></span>
<span id="cb232-3"><a href="Disease.html#cb232-3" tabindex="-1"></a></span>
<span id="cb232-4"><a href="Disease.html#cb232-4" tabindex="-1"></a>Example9_1Nimble <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb232-5"><a href="Disease.html#cb232-5" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb232-6"><a href="Disease.html#cb232-6" tabindex="-1"></a>    Y[i] <span class="sc">~</span> <span class="fu">dpois</span>(mu[i])</span>
<span id="cb232-7"><a href="Disease.html#cb232-7" tabindex="-1"></a>    <span class="co"># REVIEW: There is an intercept in the book, </span></span>
<span id="cb232-8"><a href="Disease.html#cb232-8" tabindex="-1"></a>    <span class="co"># but then we wouldn&#39;t be able to compare it to example 5.2</span></span>
<span id="cb232-9"><a href="Disease.html#cb232-9" tabindex="-1"></a>    mu[i] <span class="ot">&lt;-</span> E[i]<span class="sc">*</span><span class="fu">exp</span>(beta0)<span class="sc">*</span> theta[i]</span>
<span id="cb232-10"><a href="Disease.html#cb232-10" tabindex="-1"></a>    <span class="co">#mu[i] &lt;- E[i]* theta[i]</span></span>
<span id="cb232-11"><a href="Disease.html#cb232-11" tabindex="-1"></a>    <span class="co"># REVIEW: Same as before, the example in the book has theta[i] ~ Ga(a,a)</span></span>
<span id="cb232-12"><a href="Disease.html#cb232-12" tabindex="-1"></a>    theta[i] <span class="sc">~</span> <span class="fu">dgamma</span>(a, a)</span>
<span id="cb232-13"><a href="Disease.html#cb232-13" tabindex="-1"></a>    Y.fit[i] <span class="sc">~</span> <span class="fu">dpois</span>(mu[i])</span>
<span id="cb232-14"><a href="Disease.html#cb232-14" tabindex="-1"></a>  }</span>
<span id="cb232-15"><a href="Disease.html#cb232-15" tabindex="-1"></a>  <span class="co"># Priors</span></span>
<span id="cb232-16"><a href="Disease.html#cb232-16" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb232-17"><a href="Disease.html#cb232-17" tabindex="-1"></a>  beta0 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb232-18"><a href="Disease.html#cb232-18" tabindex="-1"></a></span>
<span id="cb232-19"><a href="Disease.html#cb232-19" tabindex="-1"></a>})</span>
<span id="cb232-20"><a href="Disease.html#cb232-20" tabindex="-1"></a></span>
<span id="cb232-21"><a href="Disease.html#cb232-21" tabindex="-1"></a><span class="co"># Define the constants, data and initials lists for the `nimble` model.</span></span>
<span id="cb232-22"><a href="Disease.html#cb232-22" tabindex="-1"></a></span>
<span id="cb232-23"><a href="Disease.html#cb232-23" tabindex="-1"></a><span class="co"># observations</span></span>
<span id="cb232-24"><a href="Disease.html#cb232-24" tabindex="-1"></a>y <span class="ot">&lt;-</span> observed<span class="sc">$</span>Y2010</span>
<span id="cb232-25"><a href="Disease.html#cb232-25" tabindex="-1"></a><span class="co"># offset</span></span>
<span id="cb232-26"><a href="Disease.html#cb232-26" tabindex="-1"></a>E <span class="ot">&lt;-</span> expected<span class="sc">$</span>E2010</span>
<span id="cb232-27"><a href="Disease.html#cb232-27" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb232-28"><a href="Disease.html#cb232-28" tabindex="-1"></a><span class="co"># constants list</span></span>
<span id="cb232-29"><a href="Disease.html#cb232-29" tabindex="-1"></a>constants <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb232-30"><a href="Disease.html#cb232-30" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb232-31"><a href="Disease.html#cb232-31" tabindex="-1"></a>  <span class="at">E =</span> E</span>
<span id="cb232-32"><a href="Disease.html#cb232-32" tabindex="-1"></a>)</span>
<span id="cb232-33"><a href="Disease.html#cb232-33" tabindex="-1"></a><span class="co"># data list</span></span>
<span id="cb232-34"><a href="Disease.html#cb232-34" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Y =</span> y)</span>
<span id="cb232-35"><a href="Disease.html#cb232-35" tabindex="-1"></a><span class="co"># initial values list</span></span>
<span id="cb232-36"><a href="Disease.html#cb232-36" tabindex="-1"></a>inits <span class="ot">&lt;-</span></span>
<span id="cb232-37"><a href="Disease.html#cb232-37" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb232-38"><a href="Disease.html#cb232-38" tabindex="-1"></a>      <span class="at">theta =</span> <span class="fu">rgamma</span>(N, <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb232-39"><a href="Disease.html#cb232-39" tabindex="-1"></a>      <span class="at">a =</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb232-40"><a href="Disease.html#cb232-40" tabindex="-1"></a>      <span class="at">beta0 =</span> <span class="dv">0</span>,</span>
<span id="cb232-41"><a href="Disease.html#cb232-41" tabindex="-1"></a>      <span class="at">Y.fit =</span> <span class="fu">rpois</span>(N, E)</span>
<span id="cb232-42"><a href="Disease.html#cb232-42" tabindex="-1"></a>    )</span>
<span id="cb232-43"><a href="Disease.html#cb232-43" tabindex="-1"></a><span class="co"># parameters to monitor</span></span>
<span id="cb232-44"><a href="Disease.html#cb232-44" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>, <span class="st">&quot;a&quot;</span>, <span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;Y.fit&quot;</span>)</span>
<span id="cb232-45"><a href="Disease.html#cb232-45" tabindex="-1"></a></span>
<span id="cb232-46"><a href="Disease.html#cb232-46" tabindex="-1"></a><span class="co"># Run model in nimble</span></span>
<span id="cb232-47"><a href="Disease.html#cb232-47" tabindex="-1"></a>mcmc.out <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb232-48"><a href="Disease.html#cb232-48" tabindex="-1"></a>  <span class="at">code =</span> Example9_1Nimble,</span>
<span id="cb232-49"><a href="Disease.html#cb232-49" tabindex="-1"></a>  <span class="at">constants =</span> constants,</span>
<span id="cb232-50"><a href="Disease.html#cb232-50" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb232-51"><a href="Disease.html#cb232-51" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb232-52"><a href="Disease.html#cb232-52" tabindex="-1"></a>  <span class="at">monitors =</span> params,</span>
<span id="cb232-53"><a href="Disease.html#cb232-53" tabindex="-1"></a>  <span class="at">niter =</span> <span class="dv">50000</span>,</span>
<span id="cb232-54"><a href="Disease.html#cb232-54" tabindex="-1"></a>  <span class="at">nburnin =</span> <span class="dv">20000</span>,</span>
<span id="cb232-55"><a href="Disease.html#cb232-55" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">14</span>,</span>
<span id="cb232-56"><a href="Disease.html#cb232-56" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb232-57"><a href="Disease.html#cb232-57" tabindex="-1"></a>  <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb232-58"><a href="Disease.html#cb232-58" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb232-59"><a href="Disease.html#cb232-59" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb232-60"><a href="Disease.html#cb232-60" tabindex="-1"></a>)</span></code></pre></div>
<p>Effective sample size is checked through the minimum value among all the samples available. This is to check if this minimum is acceptable. We also provide trace plots of the chains for some of the parameters. We provide the command to obtain WAIC in case model comparison will be performed in a later stage. <!---Show the WAIC, effective sample size, and trace plots for some of the parameters.---></p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="Disease.html#cb233-1" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(mcmc.out<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 948.4589</code></pre>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="Disease.html#cb235-1" tabindex="-1"></a>mcmc.out<span class="sc">$</span>WAIC</span></code></pre></div>
<pre><code>## nimbleList object of type waicList
## Field &quot;WAIC&quot;:
## [1] 2422.992
## Field &quot;lppd&quot;:
## [1] -1061.364
## Field &quot;pWAIC&quot;:
## [1] 150.132</code></pre>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="Disease.html#cb237-1" tabindex="-1"></a><span class="co">#storing the samples from the posterior distribution in mvSamples</span></span>
<span id="cb237-2"><a href="Disease.html#cb237-2" tabindex="-1"></a>mvSamples <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>samples</span>
<span id="cb237-3"><a href="Disease.html#cb237-3" tabindex="-1"></a></span>
<span id="cb237-4"><a href="Disease.html#cb237-4" tabindex="-1"></a><span class="co"># trace plot of a</span></span>
<span id="cb237-5"><a href="Disease.html#cb237-5" tabindex="-1"></a><span class="fu">plot</span>(mvSamples[, <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20nimble%20WAIC,%20ESS%20and%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="Disease.html#cb238-1" tabindex="-1"></a><span class="co"># trace plot of beta0</span></span>
<span id="cb238-2"><a href="Disease.html#cb238-2" tabindex="-1"></a><span class="fu">plot</span>(mvSamples[, <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20nimble%20WAIC,%20ESS%20and%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="Disease.html#cb239-1" tabindex="-1"></a><span class="co"># trace plots of theta</span></span>
<span id="cb239-2"><a href="Disease.html#cb239-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb239-3"><a href="Disease.html#cb239-3" tabindex="-1"></a>  <span class="fu">plot</span>(mvSamples[, <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">&quot;theta[&quot;</span>, i, <span class="st">&quot;]&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>))], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20nimble%20WAIC,%20ESS%20and%20traceplots-3.png" width="672" /><img src="_main_files/figure-html/Ex%209.1%20nimble%20WAIC,%20ESS%20and%20traceplots-4.png" width="672" /><img src="_main_files/figure-html/Ex%209.1%20nimble%20WAIC,%20ESS%20and%20traceplots-5.png" width="672" /></p>
<p>Now that we have checked the convergence of the chains we can plot the posterior mean and 95% CIs for each of the parameters.</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="Disease.html#cb240-1" tabindex="-1"></a><span class="co"># Print posterior summary for parameters a and b</span></span>
<span id="cb240-2"><a href="Disease.html#cb240-2" tabindex="-1"></a><span class="fu">summary</span>(mvSamples[, <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;beta0&quot;</span>)])</span></code></pre></div>
<pre><code>## 
## Iterations = 1:2142
## Thinning interval = 1 
## Number of chains = 2 
## Sample size per chain = 2142 
## 
## 1. Empirical mean and standard deviation for each variable,
##    plus standard error of the mean:
## 
##           Mean      SD  Naive SE Time-series SE
## a     12.97734 1.23282 0.0188354      0.0193663
## beta0 -0.03137 0.01673 0.0002556      0.0005469
## 
## 2. Quantiles for each variable:
## 
##          2.5%     25%      50%      75%     97.5%
## a     10.7242 12.1384 12.92600 13.75815 15.546804
## beta0 -0.0642 -0.0427 -0.03132 -0.02042  0.001347</code></pre>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="Disease.html#cb242-1" tabindex="-1"></a><span class="co"># posterior summaries of theta_i</span></span>
<span id="cb242-2"><a href="Disease.html#cb242-2" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>summary<span class="sc">$</span>all.chains <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb242-3"><a href="Disease.html#cb242-3" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="st">&quot;variable&quot;</span>)</span>
<span id="cb242-4"><a href="Disease.html#cb242-4" tabindex="-1"></a><span class="co"># plot the mean and 95% CIs for the thetas</span></span>
<span id="cb242-5"><a href="Disease.html#cb242-5" tabindex="-1"></a>post_theta <span class="ot">&lt;-</span></span>
<span id="cb242-6"><a href="Disease.html#cb242-6" tabindex="-1"></a>  post_summary[<span class="fu">grepl</span>(<span class="st">&quot;theta</span><span class="sc">\\</span><span class="st">[&quot;</span>, post_summary<span class="sc">$</span>variable),]</span>
<span id="cb242-7"><a href="Disease.html#cb242-7" tabindex="-1"></a></span>
<span id="cb242-8"><a href="Disease.html#cb242-8" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb242-9"><a href="Disease.html#cb242-9" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb242-10"><a href="Disease.html#cb242-10" tabindex="-1"></a>  post_theta<span class="sc">$</span>Mean,</span>
<span id="cb242-11"><a href="Disease.html#cb242-11" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb242-12"><a href="Disease.html#cb242-12" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.8</span>,</span>
<span id="cb242-13"><a href="Disease.html#cb242-13" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb242-14"><a href="Disease.html#cb242-14" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Borough&quot;</span>,</span>
<span id="cb242-15"><a href="Disease.html#cb242-15" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Posterior Summary Rate&quot;</span>,</span>
<span id="cb242-16"><a href="Disease.html#cb242-16" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>), <span class="fu">max</span>(post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>))</span>
<span id="cb242-17"><a href="Disease.html#cb242-17" tabindex="-1"></a>)</span>
<span id="cb242-18"><a href="Disease.html#cb242-18" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb242-19"><a href="Disease.html#cb242-19" tabindex="-1"></a>  <span class="fu">segments</span>(i, post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>[i], i, post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>[i])</span>
<span id="cb242-20"><a href="Disease.html#cb242-20" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20nimble%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="Disease.html#cb243-1" tabindex="-1"></a><span class="co"># posterior summary of fitted values</span></span>
<span id="cb243-2"><a href="Disease.html#cb243-2" tabindex="-1"></a>post_fitted <span class="ot">&lt;-</span></span>
<span id="cb243-3"><a href="Disease.html#cb243-3" tabindex="-1"></a>  post_summary[<span class="fu">grepl</span>(<span class="st">&quot;Y.fit</span><span class="sc">\\</span><span class="st">[&quot;</span>, post_summary<span class="sc">$</span>variable),]</span>
<span id="cb243-4"><a href="Disease.html#cb243-4" tabindex="-1"></a><span class="co"># plot mean and 95% CIs for the fitted values</span></span>
<span id="cb243-5"><a href="Disease.html#cb243-5" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb243-6"><a href="Disease.html#cb243-6" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb243-7"><a href="Disease.html#cb243-7" tabindex="-1"></a>  y,</span>
<span id="cb243-8"><a href="Disease.html#cb243-8" tabindex="-1"></a>  post_fitted<span class="sc">$</span>Mean,</span>
<span id="cb243-9"><a href="Disease.html#cb243-9" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>), <span class="fu">max</span>(post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>)),</span>
<span id="cb243-10"><a href="Disease.html#cb243-10" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Observed&quot;</span>,</span>
<span id="cb243-11"><a href="Disease.html#cb243-11" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Fitted&quot;</span>,</span>
<span id="cb243-12"><a href="Disease.html#cb243-12" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb243-13"><a href="Disease.html#cb243-13" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.7</span>,</span>
<span id="cb243-14"><a href="Disease.html#cb243-14" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span></span>
<span id="cb243-15"><a href="Disease.html#cb243-15" tabindex="-1"></a>)</span>
<span id="cb243-16"><a href="Disease.html#cb243-16" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb243-17"><a href="Disease.html#cb243-17" tabindex="-1"></a>  <span class="fu">segments</span>(y[i], post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>[i], y[i], post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>[i])</span>
<span id="cb243-18"><a href="Disease.html#cb243-18" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20nimble%20posterior%20summary-2.png" width="672" /></p>
<p>Now we present the code for the same model in {}. We start by cleaning the ´R environment`.</p>
</div>
<div id="stan-1" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="Disease.html#stan-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="Disease.html#cb244-1" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb244-2"><a href="Disease.html#cb244-2" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># to read shapefile</span></span>
<span id="cb244-3"><a href="Disease.html#cb244-3" tabindex="-1"></a><span class="fu">library</span>(loo) <span class="co"># To calculate WAIC</span></span>
<span id="cb244-4"><a href="Disease.html#cb244-4" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb244-5"><a href="Disease.html#cb244-5" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb244-6"><a href="Disease.html#cb244-6" tabindex="-1"></a></span>
<span id="cb244-7"><a href="Disease.html#cb244-7" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb244-8"><a href="Disease.html#cb244-8" tabindex="-1"></a><span class="co"># Reading in borders</span></span>
<span id="cb244-9"><a href="Disease.html#cb244-9" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/copd/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb244-10"><a href="Disease.html#cb244-10" tabindex="-1"></a><span class="co"># Reading in data</span></span>
<span id="cb244-11"><a href="Disease.html#cb244-11" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb244-12"><a href="Disease.html#cb244-12" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb244-13"><a href="Disease.html#cb244-13" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb244-14"><a href="Disease.html#cb244-14" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityexpected.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>The <code>Stan</code> model is in a separate file called <code>Example9_1.stan</code> that will be called later.</p>
<pre><code>data {
  int&lt;lower=0&gt; N;
  real&lt;lower=0&gt; E[N]; // need to indicate that variable is strictly positive
  int&lt;lower=0&gt; Y[N];
}

parameters {
  real&lt;lower=0&gt; theta[N];
  real&lt;lower=0&gt; a;
  real beta0;
}

transformed parameters{
  real &lt;lower=0&gt; mu[N];
  
  for(i in 1:N){
    mu[i]=E[i]*theta[i]*exp(beta0);
  }
  
}

model {
  // likelihood function and prior for theta
  for(i in 1:N){
    Y[i] ~ poisson(mu[i]);
    theta[i]~gamma(a,a);
  }
  a~gamma(1, 1);
  beta0~normal(0,10);
}

generated quantities {
  vector [N] log_lik;
  int&lt;lower=0&gt; yfit [N];
  
  //computing the log_likelihood for each value of the mean mu and the fitted values
  for(i in 1:N){
    log_lik[i]=poisson_lpmf(Y[i] |mu[i]);
    yfit[i]=poisson_rng(mu[i]);
  }
  
}</code></pre>
<p>Similarly to <code>NIMBLE</code>, we now define the different objects that will contain information about the data.</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="Disease.html#cb246-1" tabindex="-1"></a><span class="co"># observations</span></span>
<span id="cb246-2"><a href="Disease.html#cb246-2" tabindex="-1"></a>y <span class="ot">&lt;-</span> observed<span class="sc">$</span>Y2010</span>
<span id="cb246-3"><a href="Disease.html#cb246-3" tabindex="-1"></a><span class="co"># offset</span></span>
<span id="cb246-4"><a href="Disease.html#cb246-4" tabindex="-1"></a>E <span class="ot">&lt;-</span> expected<span class="sc">$</span>E2010</span>
<span id="cb246-5"><a href="Disease.html#cb246-5" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb246-6"><a href="Disease.html#cb246-6" tabindex="-1"></a><span class="co"># data list</span></span>
<span id="cb246-7"><a href="Disease.html#cb246-7" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb246-8"><a href="Disease.html#cb246-8" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">length</span>(y),</span>
<span id="cb246-9"><a href="Disease.html#cb246-9" tabindex="-1"></a>  <span class="at">Y =</span> y,</span>
<span id="cb246-10"><a href="Disease.html#cb246-10" tabindex="-1"></a>  <span class="at">E =</span> E</span>
<span id="cb246-11"><a href="Disease.html#cb246-11" tabindex="-1"></a>)</span>
<span id="cb246-12"><a href="Disease.html#cb246-12" tabindex="-1"></a><span class="co"># Run the model in Stan</span></span>
<span id="cb246-13"><a href="Disease.html#cb246-13" tabindex="-1"></a>Ex9_1Stan <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb246-14"><a href="Disease.html#cb246-14" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example9_1.stan&quot;</span>,</span>
<span id="cb246-15"><a href="Disease.html#cb246-15" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb246-16"><a href="Disease.html#cb246-16" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb246-17"><a href="Disease.html#cb246-17" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb246-18"><a href="Disease.html#cb246-18" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">3000</span>,</span>
<span id="cb246-19"><a href="Disease.html#cb246-19" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">14</span>,</span>
<span id="cb246-20"><a href="Disease.html#cb246-20" tabindex="-1"></a>  <span class="co"># QUESTION: should we explain this?</span></span>
<span id="cb246-21"><a href="Disease.html#cb246-21" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.8</span>, <span class="at">max_treedepth =</span> <span class="dv">15</span>),</span>
<span id="cb246-22"><a href="Disease.html#cb246-22" tabindex="-1"></a>  <span class="at">init =</span> <span class="st">&quot;random&quot;</span>,</span>
<span id="cb246-23"><a href="Disease.html#cb246-23" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>,<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;theta&quot;</span>, <span class="st">&quot;log_lik&quot;</span>, <span class="st">&quot;yfit&quot;</span>),</span>
<span id="cb246-24"><a href="Disease.html#cb246-24" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb246-25"><a href="Disease.html#cb246-25" tabindex="-1"></a>)</span></code></pre></div>
<p>We now check the trace plots of some of the parameters, check the effective sample size. Once convergence has been checked we obtain the posterior summaries of some of the parameters. <!---Compute the WAIC, show the trace plots and posterior summaries of the parameters.---></p>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="Disease.html#cb247-1" tabindex="-1"></a><span class="co"># traceplots of parameters a and b</span></span>
<span id="cb247-2"><a href="Disease.html#cb247-2" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Ex9_1Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>,<span class="st">&quot;beta0&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20stan%20waic%20and%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="Disease.html#cb248-1" tabindex="-1"></a><span class="co"># traceplots of parameter theta</span></span>
<span id="cb248-2"><a href="Disease.html#cb248-2" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Ex9_1Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;theta[1]&quot;</span>, <span class="st">&quot;theta[2]&quot;</span>, <span class="st">&quot;theta[3]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20stan%20waic%20and%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="Disease.html#cb249-1" tabindex="-1"></a><span class="co"># posterior summaries together with Rhat</span></span>
<span id="cb249-2"><a href="Disease.html#cb249-2" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Ex9_1Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>,<span class="st">&quot;theta[1]&quot;</span>, <span class="st">&quot;theta[2]&quot;</span>, <span class="st">&quot;theta[3]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20stan%20waic%20and%20traceplots-3.png" width="672" /></p>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="Disease.html#cb250-1" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">summary</span>(Ex9_1Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>,<span class="st">&quot;theta[1]&quot;</span>, <span class="st">&quot;theta[2]&quot;</span>, <span class="st">&quot;theta[3]&quot;</span>))</span></code></pre></div>
<pre><code>## $summary
##                mean     se_mean         sd       2.5%        25%        50%
## a        12.9490131 0.030133132 1.21097052 10.7279153 12.1160782 12.8953865
## theta[1]  0.8681535 0.005872796 0.22967964  0.4789593  0.6960057  0.8597968
## theta[2]  1.3269027 0.004045516 0.14569941  1.0538612  1.2254400  1.3209029
## theta[3]  0.7293979 0.002208173 0.07439276  0.5962105  0.6774943  0.7211274
##                75%      97.5%    n_eff      Rhat
## a        13.729623 15.3851313 1615.023 0.9998414
## theta[1]  1.016351  1.3539740 1529.520 0.9999455
## theta[2]  1.419336  1.6207442 1297.083 1.0004835
## theta[3]  0.777150  0.8885225 1134.998 1.0007149
## 
## $c_summary
## , , chains = chain:1
## 
##           stats
## parameter        mean         sd       2.5%        25%        50%        75%
##   a        12.9391260 1.20688131 10.6647963 12.1367051 12.8610229 13.7066434
##   theta[1]  0.8544009 0.21847768  0.4610477  0.7025649  0.8516174  0.9842713
##   theta[2]  1.3309053 0.14915119  1.0589718  1.2319590  1.3220494  1.4277758
##   theta[3]  0.7328573 0.07826966  0.5966028  0.6769945  0.7249705  0.7835412
##           stats
## parameter       97.5%
##   a        15.5179697
##   theta[1]  1.3197144
##   theta[2]  1.6162752
##   theta[3]  0.8917676
## 
## , , chains = chain:2
## 
##           stats
## parameter        mean         sd       2.5%        25%        50%        75%
##   a        12.9631607 1.23242884 10.7069049 12.1322796 12.9113706 13.7432376
##   theta[1]  0.8706192 0.23177021  0.4891381  0.6946233  0.8573132  1.0206591
##   theta[2]  1.3338165 0.14394937  1.0460653  1.2392597  1.3249056  1.4239841
##   theta[3]  0.7297883 0.07502032  0.5907728  0.6779665  0.7205219  0.7788053
##           stats
## parameter       97.5%
##   a        15.3983920
##   theta[1]  1.3767840
##   theta[2]  1.6308883
##   theta[3]  0.8904337
## 
## , , chains = chain:3
## 
##           stats
## parameter        mean         sd       2.5%        25%        50%        75%
##   a        12.9447526 1.19560290 10.7837245 12.0674517 12.9678053 13.7452054
##   theta[1]  0.8794403 0.23811021  0.4884869  0.6921386  0.8671821  1.0340745
##   theta[2]  1.3159863 0.14359380  1.0602166  1.2078908  1.3137105  1.4073229
##   theta[3]  0.7255480 0.06959774  0.6008815  0.6771501  0.7190926  0.7718208
##           stats
## parameter       97.5%
##   a        15.2901383
##   theta[1]  1.3849875
##   theta[2]  1.6040231
##   theta[3]  0.8703692</code></pre>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="Disease.html#cb252-1" tabindex="-1"></a><span class="co"># To be able to compute the WAIC in Stan, we need to define the log_lik quantity in the generated quantities block</span></span>
<span id="cb252-2"><a href="Disease.html#cb252-2" tabindex="-1"></a><span class="co"># Compute WAIC</span></span>
<span id="cb252-3"><a href="Disease.html#cb252-3" tabindex="-1"></a>loglik0 <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(Ex9_1Stan)</span>
<span id="cb252-4"><a href="Disease.html#cb252-4" tabindex="-1"></a>waic0 <span class="ot">&lt;-</span> <span class="fu">waic</span>(loglik0)</span>
<span id="cb252-5"><a href="Disease.html#cb252-5" tabindex="-1"></a>waic0</span></code></pre></div>
<pre><code>## 
## Computed from 1500 by 324 log-likelihood matrix
## 
##           Estimate   SE
## elpd_waic  -1210.4  8.0
## p_waic       149.3  3.9
## waic        2420.8 16.0
## 
## 176 (54.3%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
<p>Note that the ´summary<code>function of a</code>RStan` object provides the effective sample size and Rhat. We now plot the posterior summaries of <span class="math inline">\(\theta_i\)</span> and each of the fitted values with their respective 95% posterior credible intervals.</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="Disease.html#cb254-1" tabindex="-1"></a>summary_theta <span class="ot">&lt;-</span></span>
<span id="cb254-2"><a href="Disease.html#cb254-2" tabindex="-1"></a>  <span class="fu">summary</span>(Ex9_1Stan,</span>
<span id="cb254-3"><a href="Disease.html#cb254-3" tabindex="-1"></a>          <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>),</span>
<span id="cb254-4"><a href="Disease.html#cb254-4" tabindex="-1"></a>          <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>))<span class="sc">$</span>summary <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb254-5"><a href="Disease.html#cb254-5" tabindex="-1"></a></span>
<span id="cb254-6"><a href="Disease.html#cb254-6" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb254-7"><a href="Disease.html#cb254-7" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb254-8"><a href="Disease.html#cb254-8" tabindex="-1"></a>  summary_theta<span class="sc">$</span>mean,</span>
<span id="cb254-9"><a href="Disease.html#cb254-9" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb254-10"><a href="Disease.html#cb254-10" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.8</span>,</span>
<span id="cb254-11"><a href="Disease.html#cb254-11" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb254-12"><a href="Disease.html#cb254-12" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Borough&quot;</span>,</span>
<span id="cb254-13"><a href="Disease.html#cb254-13" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Posterior Summary Rate&quot;</span>,</span>
<span id="cb254-14"><a href="Disease.html#cb254-14" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>), <span class="fu">max</span>(summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>))</span>
<span id="cb254-15"><a href="Disease.html#cb254-15" tabindex="-1"></a>)</span>
<span id="cb254-16"><a href="Disease.html#cb254-16" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb254-17"><a href="Disease.html#cb254-17" tabindex="-1"></a>  <span class="fu">segments</span>(i, summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>[i], i, summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>[i])</span>
<span id="cb254-18"><a href="Disease.html#cb254-18" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20stan%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="Disease.html#cb255-1" tabindex="-1"></a><span class="co"># Posterior summary of fitted values</span></span>
<span id="cb255-2"><a href="Disease.html#cb255-2" tabindex="-1"></a>summary_fit <span class="ot">&lt;-</span></span>
<span id="cb255-3"><a href="Disease.html#cb255-3" tabindex="-1"></a>  <span class="fu">summary</span>(Ex9_1Stan,</span>
<span id="cb255-4"><a href="Disease.html#cb255-4" tabindex="-1"></a>          <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;yfit&quot;</span>),</span>
<span id="cb255-5"><a href="Disease.html#cb255-5" tabindex="-1"></a>          <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>))<span class="sc">$</span>summary <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb255-6"><a href="Disease.html#cb255-6" tabindex="-1"></a><span class="co"># Plot mean and 95% CIs for the fitted values</span></span>
<span id="cb255-7"><a href="Disease.html#cb255-7" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb255-8"><a href="Disease.html#cb255-8" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb255-9"><a href="Disease.html#cb255-9" tabindex="-1"></a>  y,</span>
<span id="cb255-10"><a href="Disease.html#cb255-10" tabindex="-1"></a>  summary_fit<span class="sc">$</span>mean,</span>
<span id="cb255-11"><a href="Disease.html#cb255-11" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>), <span class="fu">max</span>(summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>)),</span>
<span id="cb255-12"><a href="Disease.html#cb255-12" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Observed&quot;</span>,</span>
<span id="cb255-13"><a href="Disease.html#cb255-13" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Fitted&quot;</span>,</span>
<span id="cb255-14"><a href="Disease.html#cb255-14" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb255-15"><a href="Disease.html#cb255-15" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.7</span>,</span>
<span id="cb255-16"><a href="Disease.html#cb255-16" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span></span>
<span id="cb255-17"><a href="Disease.html#cb255-17" tabindex="-1"></a>)</span>
<span id="cb255-18"><a href="Disease.html#cb255-18" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb255-19"><a href="Disease.html#cb255-19" tabindex="-1"></a>  <span class="fu">segments</span>(y[i], summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>[i], y[i], summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>[i])</span>
<span id="cb255-20"><a href="Disease.html#cb255-20" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20stan%20posterior%20summary-2.png" width="672" /></p>
</div>
</div>
<div id="example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-rstan" class="section level2 unnumbered hasAnchor">
<h2>Example 9.3: Fitting a conditional spatial model in <code>NIMBLE</code> and <code>RStan</code><a href="Disease.html#example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-rstan" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this example, we see how to fit the Poisson log–normal model seen in Section 9.4 with spatial random effects coming from the ICAR model described in Section 9.3.1.</p>
<p>This example uses the <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/englandlocalauthority.shp">englandlocalauthority.shp</a>, <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityobserved.csv">copdmortalityobserved.csv</a>, and
<a href="https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityexpected.csv">copdmortalityexpected.csv</a> datasets.</p>
<div id="nimble-3" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="Disease.html#nimble-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In this example, we see how to fit the Poisson log–normal model seen in Section 9.4 with spatial random effects coming from the ICAR model described in Section 9.3.1.</p>
<p>We start by loading some packages and the data.</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="Disease.html#cb256-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2) <span class="co"># to plot map</span></span>
<span id="cb256-2"><a href="Disease.html#cb256-2" tabindex="-1"></a><span class="fu">library</span>(spdep) <span class="co"># read the shapefile (read_sf) and build neighbors list (poly2nb)</span></span>
<span id="cb256-3"><a href="Disease.html#cb256-3" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb256-4"><a href="Disease.html#cb256-4" tabindex="-1"></a></span>
<span id="cb256-5"><a href="Disease.html#cb256-5" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb256-6"><a href="Disease.html#cb256-6" tabindex="-1"></a><span class="co"># Reading in borders</span></span>
<span id="cb256-7"><a href="Disease.html#cb256-7" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/copd/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb256-8"><a href="Disease.html#cb256-8" tabindex="-1"></a><span class="co"># Reading in data</span></span>
<span id="cb256-9"><a href="Disease.html#cb256-9" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb256-10"><a href="Disease.html#cb256-10" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb256-11"><a href="Disease.html#cb256-11" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb256-12"><a href="Disease.html#cb256-12" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityexpected.csv&quot;</span>)</span>
<span id="cb256-13"><a href="Disease.html#cb256-13" tabindex="-1"></a>covariates <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdavgscore.csv&quot;</span>)</span>
<span id="cb256-14"><a href="Disease.html#cb256-14" tabindex="-1"></a><span class="co"># Merge everything into one data frame</span></span>
<span id="cb256-15"><a href="Disease.html#cb256-15" tabindex="-1"></a>copd_df <span class="ot">&lt;-</span></span>
<span id="cb256-16"><a href="Disease.html#cb256-16" tabindex="-1"></a>  <span class="fu">cbind</span>(observed,  expected) <span class="sc">|&gt;</span> <span class="fu">merge</span>(</span>
<span id="cb256-17"><a href="Disease.html#cb256-17" tabindex="-1"></a>    covariates,</span>
<span id="cb256-18"><a href="Disease.html#cb256-18" tabindex="-1"></a>    <span class="at">by.x =</span> <span class="st">&quot;code&quot;</span>,</span>
<span id="cb256-19"><a href="Disease.html#cb256-19" tabindex="-1"></a>    <span class="at">by.y =</span> <span class="st">&quot;LA.CODE&quot;</span>,</span>
<span id="cb256-20"><a href="Disease.html#cb256-20" tabindex="-1"></a>    <span class="at">all.x =</span> <span class="cn">TRUE</span>,</span>
<span id="cb256-21"><a href="Disease.html#cb256-21" tabindex="-1"></a>    <span class="at">all.y =</span> <span class="cn">FALSE</span></span>
<span id="cb256-22"><a href="Disease.html#cb256-22" tabindex="-1"></a>  )</span></code></pre></div>
<p>The following command provides a scatter plot of the average deprivation score and the estimated SMR for 2010. The plot suggests that as deprivation increases so does the SMR for 2010.</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="Disease.html#cb257-1" tabindex="-1"></a>copd_df<span class="sc">$</span>SMR2010 <span class="ot">=</span> copd_df<span class="sc">$</span>Y2010 <span class="sc">/</span> copd_df<span class="sc">$</span>E2010</span>
<span id="cb257-2"><a href="Disease.html#cb257-2" tabindex="-1"></a></span>
<span id="cb257-3"><a href="Disease.html#cb257-3" tabindex="-1"></a><span class="fu">ggplot</span>(copd_df) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> Average.Score, <span class="at">y =</span> SMR2010)) <span class="sc">+</span> </span>
<span id="cb257-4"><a href="Disease.html#cb257-4" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;SMR 2010&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Average deprivation score&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.3%20plot%20copd%20and%20avg%20score-1.png" width="672" /></p>
<p>To fit the ICAR model in <code>Nimble</code> we need to obtain the neighborhood matrix <span class="math inline">\(W\)</span>. We start by defining a function that computes the number of neighbors for each
area.</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="Disease.html#cb258-1" tabindex="-1"></a>adjlist <span class="ot">=</span> <span class="cf">function</span>(W, N) {</span>
<span id="cb258-2"><a href="Disease.html#cb258-2" tabindex="-1"></a>  adj <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb258-3"><a href="Disease.html#cb258-3" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb258-4"><a href="Disease.html#cb258-4" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb258-5"><a href="Disease.html#cb258-5" tabindex="-1"></a>      <span class="cf">if</span> (W[i, j] <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb258-6"><a href="Disease.html#cb258-6" tabindex="-1"></a>        adj <span class="ot">=</span> <span class="fu">append</span>(adj, j)</span>
<span id="cb258-7"><a href="Disease.html#cb258-7" tabindex="-1"></a>      }</span>
<span id="cb258-8"><a href="Disease.html#cb258-8" tabindex="-1"></a>    }</span>
<span id="cb258-9"><a href="Disease.html#cb258-9" tabindex="-1"></a>  }</span>
<span id="cb258-10"><a href="Disease.html#cb258-10" tabindex="-1"></a>  adj <span class="ot">=</span> adj[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb258-11"><a href="Disease.html#cb258-11" tabindex="-1"></a>  <span class="fu">return</span>(adj)</span>
<span id="cb258-12"><a href="Disease.html#cb258-12" tabindex="-1"></a>}</span></code></pre></div>
<p>Next we obtain the adjacency matrix, W,Define the adjacency matrix and indexes for <code>stan</code> using the functions <code>nb2mat</code> and <code>adjlist</code> from package <code>spdep</code>.</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="Disease.html#cb259-1" tabindex="-1"></a><span class="co"># Create the neighborhood</span></span>
<span id="cb259-2"><a href="Disease.html#cb259-2" tabindex="-1"></a>W.nb <span class="ot">&lt;-</span><span class="fu">poly2nb</span>(england, <span class="at">row.names =</span> <span class="fu">rownames</span>(england))</span>
<span id="cb259-3"><a href="Disease.html#cb259-3" tabindex="-1"></a><span class="co"># Creates a matrix for following function call</span></span>
<span id="cb259-4"><a href="Disease.html#cb259-4" tabindex="-1"></a>W.mat <span class="ot">&lt;-</span> <span class="fu">nb2mat</span>(W.nb, <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span>
<span id="cb259-5"><a href="Disease.html#cb259-5" tabindex="-1"></a><span class="co"># Define the spatial structure to use in stan</span></span>
<span id="cb259-6"><a href="Disease.html#cb259-6" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(england<span class="sc">$</span>ID))</span>
<span id="cb259-7"><a href="Disease.html#cb259-7" tabindex="-1"></a><span class="co">#creating a vector listing the ID numbers of the adjacent areas for each area</span></span>
<span id="cb259-8"><a href="Disease.html#cb259-8" tabindex="-1"></a>neigh  <span class="ot">&lt;-</span> <span class="fu">adjlist</span>(W.mat, N)</span>
<span id="cb259-9"><a href="Disease.html#cb259-9" tabindex="-1"></a><span class="co"># computing a vector of length N (the total number of areas) giving the number of neighbors for each area.</span></span>
<span id="cb259-10"><a href="Disease.html#cb259-10" tabindex="-1"></a>numneigh  <span class="ot">&lt;-</span> <span class="fu">apply</span>(W.mat,<span class="dv">2</span>,sum)</span></code></pre></div>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="Disease.html#cb260-1" tabindex="-1"></a>Example9_3Nimble <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb260-2"><a href="Disease.html#cb260-2" tabindex="-1"></a>  <span class="co"># Likelihood</span></span>
<span id="cb260-3"><a href="Disease.html#cb260-3" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb260-4"><a href="Disease.html#cb260-4" tabindex="-1"></a>    y[i] <span class="sc">~</span> <span class="fu">dpois</span>(lambda[i])</span>
<span id="cb260-5"><a href="Disease.html#cb260-5" tabindex="-1"></a>    <span class="fu">log</span>(lambda[i]) <span class="ot">&lt;-</span> <span class="fu">log</span>(E[i]) <span class="sc">+</span> b[i] <span class="sc">+</span> beta0 <span class="sc">+</span> beta1<span class="sc">*</span>x[i]</span>
<span id="cb260-6"><a href="Disease.html#cb260-6" tabindex="-1"></a>  }</span>
<span id="cb260-7"><a href="Disease.html#cb260-7" tabindex="-1"></a>  </span>
<span id="cb260-8"><a href="Disease.html#cb260-8" tabindex="-1"></a>  <span class="co"># Priors</span></span>
<span id="cb260-9"><a href="Disease.html#cb260-9" tabindex="-1"></a>  beta0 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb260-10"><a href="Disease.html#cb260-10" tabindex="-1"></a>  beta1 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb260-11"><a href="Disease.html#cb260-11" tabindex="-1"></a>  b[<span class="dv">1</span><span class="sc">:</span>N] <span class="sc">~</span> <span class="fu">dcar_normal</span>(adj[<span class="dv">1</span><span class="sc">:</span>L], weights[<span class="dv">1</span><span class="sc">:</span>L], num[<span class="dv">1</span><span class="sc">:</span>N], tau, <span class="at">zero_mean =</span> <span class="dv">1</span>)</span>
<span id="cb260-12"><a href="Disease.html#cb260-12" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (sigma_b <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb260-13"><a href="Disease.html#cb260-13" tabindex="-1"></a>  <span class="co">#prior for sigma_b is a half-normal distribution</span></span>
<span id="cb260-14"><a href="Disease.html#cb260-14" tabindex="-1"></a>  sigma_b <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>), <span class="dv">0</span>,)</span>
<span id="cb260-15"><a href="Disease.html#cb260-15" tabindex="-1"></a>  <span class="co"># Fitted values and likelihood for WAIC</span></span>
<span id="cb260-16"><a href="Disease.html#cb260-16" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb260-17"><a href="Disease.html#cb260-17" tabindex="-1"></a>    fitted[i] <span class="sc">~</span> <span class="fu">dpois</span>(lambda[i])</span>
<span id="cb260-18"><a href="Disease.html#cb260-18" tabindex="-1"></a>  }</span>
<span id="cb260-19"><a href="Disease.html#cb260-19" tabindex="-1"></a>})</span>
<span id="cb260-20"><a href="Disease.html#cb260-20" tabindex="-1"></a></span>
<span id="cb260-21"><a href="Disease.html#cb260-21" tabindex="-1"></a><span class="co">#  Define the constants, data and initial values lists and run the model. </span></span>
<span id="cb260-22"><a href="Disease.html#cb260-22" tabindex="-1"></a></span>
<span id="cb260-23"><a href="Disease.html#cb260-23" tabindex="-1"></a><span class="co"># constants list</span></span>
<span id="cb260-24"><a href="Disease.html#cb260-24" tabindex="-1"></a>constants <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb260-25"><a href="Disease.html#cb260-25" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb260-26"><a href="Disease.html#cb260-26" tabindex="-1"></a>  <span class="at">E =</span> copd_df<span class="sc">$</span>E2010,</span>
<span id="cb260-27"><a href="Disease.html#cb260-27" tabindex="-1"></a>  <span class="at">L =</span> <span class="fu">length</span>(neigh),</span>
<span id="cb260-28"><a href="Disease.html#cb260-28" tabindex="-1"></a>  <span class="at">adj =</span> neigh,</span>
<span id="cb260-29"><a href="Disease.html#cb260-29" tabindex="-1"></a>  <span class="at">weights =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(neigh)),</span>
<span id="cb260-30"><a href="Disease.html#cb260-30" tabindex="-1"></a>  <span class="at">num =</span> <span class="fu">as.vector</span>(numneigh),</span>
<span id="cb260-31"><a href="Disease.html#cb260-31" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">3</span></span>
<span id="cb260-32"><a href="Disease.html#cb260-32" tabindex="-1"></a>)</span>
<span id="cb260-33"><a href="Disease.html#cb260-33" tabindex="-1"></a><span class="co"># data list</span></span>
<span id="cb260-34"><a href="Disease.html#cb260-34" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span></span>
<span id="cb260-35"><a href="Disease.html#cb260-35" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">y =</span> copd_df<span class="sc">$</span>Y2010, </span>
<span id="cb260-36"><a href="Disease.html#cb260-36" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">as.vector</span>(copd_df<span class="sc">$</span>Average.Score)) <span class="co"># vector of covariates</span></span>
<span id="cb260-37"><a href="Disease.html#cb260-37" tabindex="-1"></a>inits <span class="ot">&lt;-</span>  <span class="fu">list</span>(</span>
<span id="cb260-38"><a href="Disease.html#cb260-38" tabindex="-1"></a>  <span class="at">beta0 =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>),</span>
<span id="cb260-39"><a href="Disease.html#cb260-39" tabindex="-1"></a>  <span class="at">beta1 =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>),</span>
<span id="cb260-40"><a href="Disease.html#cb260-40" tabindex="-1"></a>  <span class="at">fitted =</span> <span class="fu">rpois</span>(N, <span class="dv">2</span>),</span>
<span id="cb260-41"><a href="Disease.html#cb260-41" tabindex="-1"></a>  <span class="at">sigma_b =</span> <span class="dv">1</span>,</span>
<span id="cb260-42"><a href="Disease.html#cb260-42" tabindex="-1"></a>  <span class="at">b =</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb260-43"><a href="Disease.html#cb260-43" tabindex="-1"></a>)</span>
<span id="cb260-44"><a href="Disease.html#cb260-44" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta1&quot;</span>, <span class="st">&quot;fitted&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;tau&quot;</span>)</span>
<span id="cb260-45"><a href="Disease.html#cb260-45" tabindex="-1"></a><span class="co"># Run model in nimble</span></span>
<span id="cb260-46"><a href="Disease.html#cb260-46" tabindex="-1"></a>mcmc.out <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb260-47"><a href="Disease.html#cb260-47" tabindex="-1"></a>  <span class="at">code =</span> Example9_3Nimble,</span>
<span id="cb260-48"><a href="Disease.html#cb260-48" tabindex="-1"></a>  <span class="at">constants =</span> constants,</span>
<span id="cb260-49"><a href="Disease.html#cb260-49" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb260-50"><a href="Disease.html#cb260-50" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb260-51"><a href="Disease.html#cb260-51" tabindex="-1"></a>  <span class="at">monitors =</span> params,</span>
<span id="cb260-52"><a href="Disease.html#cb260-52" tabindex="-1"></a>  <span class="at">niter =</span> <span class="dv">40000</span>,</span>
<span id="cb260-53"><a href="Disease.html#cb260-53" tabindex="-1"></a>  <span class="at">nburnin =</span> <span class="dv">20000</span>,</span>
<span id="cb260-54"><a href="Disease.html#cb260-54" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">20</span>,</span>
<span id="cb260-55"><a href="Disease.html#cb260-55" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb260-56"><a href="Disease.html#cb260-56" tabindex="-1"></a>  <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb260-57"><a href="Disease.html#cb260-57" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb260-58"><a href="Disease.html#cb260-58" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb260-59"><a href="Disease.html#cb260-59" tabindex="-1"></a>)</span></code></pre></div>
<p>Next we double-check convergence of the chains through trace plots and the effective sample sizes for some of the parameters.</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="Disease.html#cb261-1" tabindex="-1"></a> <span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(mcmc.out<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 106.484</code></pre>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="Disease.html#cb263-1" tabindex="-1"></a> <span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta0&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.3%20ESS%20and%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="Disease.html#cb264-1" tabindex="-1"></a> <span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta1&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.3%20ESS%20and%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="Disease.html#cb265-1" tabindex="-1"></a> <span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[2]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.3%20ESS%20and%20traceplots-3.png" width="672" /></p>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="Disease.html#cb266-1" tabindex="-1"></a> <span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.3%20ESS%20and%20traceplots-4.png" width="672" /></p>
<p>Posterior summaries of the intercept, the fixed effect for average deprivation index and the precision of the ICAR prior distribution.</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="Disease.html#cb267-1" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb267-2"><a href="Disease.html#cb267-2" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta1&quot;</span>,<span class="st">&quot;tau&quot;</span>)</span>
<span id="cb267-3"><a href="Disease.html#cb267-3" tabindex="-1"></a>summary_CAR_nimble <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>summary<span class="sc">$</span>all.chains</span>
<span id="cb267-4"><a href="Disease.html#cb267-4" tabindex="-1"></a>summary_CAR_nimble[variables,]</span></code></pre></div>
<pre><code>##              Mean      Median     St.Dev.   95%CI_low   95%CI_upp
## beta0 -0.48208299 -0.48319524 0.029720605 -0.54251409 -0.42199775
## beta1  0.02158382  0.02160515 0.001446477  0.01868493  0.02446601
## tau   15.38297154 15.18218615 2.462509582 11.19231669 20.87252479</code></pre>
<p>Map of the posterior mean of the latent effects.</p>
<div class="sourceCode" id="cb269"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb269-1"><a href="Disease.html#cb269-1" tabindex="-1"></a>samples_CAR_b <span class="ot">&lt;-</span></span>
<span id="cb269-2"><a href="Disease.html#cb269-2" tabindex="-1"></a>  summary_CAR_nimble[<span class="fu">grepl</span>(<span class="st">&quot;b</span><span class="sc">\\</span><span class="st">[&quot;</span>, <span class="fu">rownames</span>(summary_CAR_nimble)), ] <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb269-3"><a href="Disease.html#cb269-3" tabindex="-1"></a>observed <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(observed, <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb269-4"><a href="Disease.html#cb269-4" tabindex="-1"></a>samples_CAR_b<span class="sc">$</span>ID <span class="ot">&lt;-</span> observed<span class="sc">$</span>ID</span>
<span id="cb269-5"><a href="Disease.html#cb269-5" tabindex="-1"></a>CAR_nimble_merge <span class="ot">&lt;-</span> <span class="fu">merge</span>(england, samples_CAR_b, <span class="at">by =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb269-6"><a href="Disease.html#cb269-6" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb269-7"><a href="Disease.html#cb269-7" tabindex="-1"></a>  <span class="co"># Choose spatial object and column for plotting</span></span>
<span id="cb269-8"><a href="Disease.html#cb269-8" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CAR_nimble_merge, <span class="fu">aes</span>(<span class="at">fill =</span> Mean)) <span class="sc">+</span></span>
<span id="cb269-9"><a href="Disease.html#cb269-9" tabindex="-1"></a>  <span class="co"># Change legend&#39;s label</span></span>
<span id="cb269-10"><a href="Disease.html#cb269-10" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&#39;Latent effects under Nimble&#39;</span>) <span class="sc">+</span></span>
<span id="cb269-11"><a href="Disease.html#cb269-11" tabindex="-1"></a>  <span class="co"># Clear background and plot borders</span></span>
<span id="cb269-12"><a href="Disease.html#cb269-12" tabindex="-1"></a> <span class="fu">theme_void</span>()</span></code></pre></div>
<p>Now we perform the same analysis using <code>Stan</code>. Note that, different from <code>Nimble</code>, the sum-to-zero constraint in <code>Stan</code> is a soft one.</p>
</div>
<div id="stan-2" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="Disease.html#stan-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As <code>Stan</code> does not have a specific function for the ICAR prior we need to compute the neighborhood structure through the following functions which were obtained from <a href="https://mc-stan.org/users/documentation/case-studies/icar_stan.html">this site</a>:</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="Disease.html#cb270-1" tabindex="-1"></a>adjlist <span class="ot">=</span> <span class="cf">function</span>(W, N) {</span>
<span id="cb270-2"><a href="Disease.html#cb270-2" tabindex="-1"></a>  adj <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-3"><a href="Disease.html#cb270-3" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb270-4"><a href="Disease.html#cb270-4" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb270-5"><a href="Disease.html#cb270-5" tabindex="-1"></a>      <span class="cf">if</span> (W[i, j] <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb270-6"><a href="Disease.html#cb270-6" tabindex="-1"></a>        adj <span class="ot">=</span> <span class="fu">append</span>(adj, j)</span>
<span id="cb270-7"><a href="Disease.html#cb270-7" tabindex="-1"></a>      }</span>
<span id="cb270-8"><a href="Disease.html#cb270-8" tabindex="-1"></a>    }</span>
<span id="cb270-9"><a href="Disease.html#cb270-9" tabindex="-1"></a>  }</span>
<span id="cb270-10"><a href="Disease.html#cb270-10" tabindex="-1"></a>  adj <span class="ot">=</span> adj[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb270-11"><a href="Disease.html#cb270-11" tabindex="-1"></a>  <span class="fu">return</span>(adj)</span>
<span id="cb270-12"><a href="Disease.html#cb270-12" tabindex="-1"></a>}</span>
<span id="cb270-13"><a href="Disease.html#cb270-13" tabindex="-1"></a></span>
<span id="cb270-14"><a href="Disease.html#cb270-14" tabindex="-1"></a>mungeCARdata4stan <span class="ot">=</span> <span class="cf">function</span>(adjBUGS, numBUGS) {</span>
<span id="cb270-15"><a href="Disease.html#cb270-15" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">length</span>(numBUGS)</span>
<span id="cb270-16"><a href="Disease.html#cb270-16" tabindex="-1"></a>  nn <span class="ot">=</span> numBUGS</span>
<span id="cb270-17"><a href="Disease.html#cb270-17" tabindex="-1"></a>  N_edges <span class="ot">=</span> <span class="fu">length</span>(adjBUGS) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb270-18"><a href="Disease.html#cb270-18" tabindex="-1"></a>  node1 <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;numeric&quot;</span>, <span class="at">length =</span> N_edges)</span>
<span id="cb270-19"><a href="Disease.html#cb270-19" tabindex="-1"></a>  node2 <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;numeric&quot;</span>, <span class="at">length =</span> N_edges)</span>
<span id="cb270-20"><a href="Disease.html#cb270-20" tabindex="-1"></a>  iAdj <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-21"><a href="Disease.html#cb270-21" tabindex="-1"></a>  iEdge <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb270-22"><a href="Disease.html#cb270-22" tabindex="-1"></a>  </span>
<span id="cb270-23"><a href="Disease.html#cb270-23" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb270-24"><a href="Disease.html#cb270-24" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nn[i]) {</span>
<span id="cb270-25"><a href="Disease.html#cb270-25" tabindex="-1"></a>      iAdj <span class="ot">=</span> iAdj <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb270-26"><a href="Disease.html#cb270-26" tabindex="-1"></a>      <span class="cf">if</span> (i <span class="sc">&lt;</span> adjBUGS[iAdj]) {</span>
<span id="cb270-27"><a href="Disease.html#cb270-27" tabindex="-1"></a>        iEdge <span class="ot">=</span> iEdge <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb270-28"><a href="Disease.html#cb270-28" tabindex="-1"></a>        node1[iEdge] <span class="ot">=</span> i</span>
<span id="cb270-29"><a href="Disease.html#cb270-29" tabindex="-1"></a>        node2[iEdge] <span class="ot">=</span> adjBUGS[iAdj]</span>
<span id="cb270-30"><a href="Disease.html#cb270-30" tabindex="-1"></a>      }</span>
<span id="cb270-31"><a href="Disease.html#cb270-31" tabindex="-1"></a>    }</span>
<span id="cb270-32"><a href="Disease.html#cb270-32" tabindex="-1"></a>  }</span>
<span id="cb270-33"><a href="Disease.html#cb270-33" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">list</span>(</span>
<span id="cb270-34"><a href="Disease.html#cb270-34" tabindex="-1"></a>    <span class="st">&quot;N&quot;</span> <span class="ot">=</span> N,</span>
<span id="cb270-35"><a href="Disease.html#cb270-35" tabindex="-1"></a>    <span class="st">&quot;N_edges&quot;</span> <span class="ot">=</span> N_edges,</span>
<span id="cb270-36"><a href="Disease.html#cb270-36" tabindex="-1"></a>    <span class="st">&quot;node1&quot;</span> <span class="ot">=</span> node1,</span>
<span id="cb270-37"><a href="Disease.html#cb270-37" tabindex="-1"></a>    <span class="st">&quot;node2&quot;</span> <span class="ot">=</span> node2</span>
<span id="cb270-38"><a href="Disease.html#cb270-38" tabindex="-1"></a>  ))</span>
<span id="cb270-39"><a href="Disease.html#cb270-39" tabindex="-1"></a>  </span>
<span id="cb270-40"><a href="Disease.html#cb270-40" tabindex="-1"></a>}</span></code></pre></div>
<p>This model is in a separate file called <code>Example9_3.stan</code> that will be called later.</p>
<pre><code>data {
  int&lt;lower=1&gt; N;
  int&lt;lower=1&gt; N_edges;
  int&lt;lower=1&gt; p;
  matrix[N,p] X;   
  int&lt;lower=1, upper=N&gt; node1[N_edges];  // node1[i] adjacent to node2[i]
  int&lt;lower=1, upper=N&gt; node2[N_edges];  // and node1[i] &lt; node2[i]
  int&lt;lower=0&gt; y[N];              // count outcomes
  vector&lt;lower=0&gt;[N] E;           // exposure 
}

transformed data {
  vector[N] log_E = log(E);
  
}

parameters {
  real beta0;            // intercept
  vector[p] beta;
  vector[N] s;         // spatial effects
  real&lt;lower=0&gt; sigma_s;        // marginal standard deviation of spatial effects
}

transformed parameters {
  vector[N] b; // latent effect
  real &lt;lower=0&gt; riskdep = exp(beta[1]);
  
  b =  sigma_s*s;
}

model {
  y ~ poisson_log(log_E + beta0 + X*beta + b); 
  // This is the prior for s! (up to proportionality)
  target += -0.5 * dot_self(s[node1] - s[node2]);
  //soft sum-to-zero constraint
  sum(s) ~ normal(0, 0.001 * N); 
  
  beta0 ~ normal(0.0, 10.0);
 for(j in 1:p){
    beta[j] ~ normal(0.0, 10.0);
  }
    sigma_s ~ normal(0.0,1.0);
}

generated quantities {
  vector[N] mu=exp(log_E + beta0  + X*beta + b);
  vector[N] lik;
  vector[N] log_lik;
  
  for(i in 1:N){
    lik[i] = exp(poisson_lpmf(y[i] | mu[i] ));
    log_lik[i] = poisson_lpmf(y[i] | mu[i] );
  }
}</code></pre>
<!-- REVIEW: I am missing the adjacency matrix but I calculated like they did for the CARBayes example, is that right? -->
<p>Define the adjacency matrix and the set of indices of the neighboring areas using functions <code>nb2mat</code> and <code>adjlist</code>:</p>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb272-1"><a href="Disease.html#cb272-1" tabindex="-1"></a><span class="co"># Create the neighborhood</span></span>
<span id="cb272-2"><a href="Disease.html#cb272-2" tabindex="-1"></a>W.nb <span class="ot">&lt;-</span></span>
<span id="cb272-3"><a href="Disease.html#cb272-3" tabindex="-1"></a>  <span class="fu">poly2nb</span>(england, <span class="at">row.names =</span> <span class="fu">rownames</span>(england))</span>
<span id="cb272-4"><a href="Disease.html#cb272-4" tabindex="-1"></a><span class="co"># Creates a matrix for following function call</span></span>
<span id="cb272-5"><a href="Disease.html#cb272-5" tabindex="-1"></a>W.mat <span class="ot">&lt;-</span> <span class="fu">nb2mat</span>(W.nb, <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span>
<span id="cb272-6"><a href="Disease.html#cb272-6" tabindex="-1"></a></span>
<span id="cb272-7"><a href="Disease.html#cb272-7" tabindex="-1"></a><span class="co"># Define the spatial structure to use in stan</span></span>
<span id="cb272-8"><a href="Disease.html#cb272-8" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(england<span class="sc">$</span>ID))</span>
<span id="cb272-9"><a href="Disease.html#cb272-9" tabindex="-1"></a>neigh <span class="ot">&lt;-</span> <span class="fu">adjlist</span>(W.mat, N)</span>
<span id="cb272-10"><a href="Disease.html#cb272-10" tabindex="-1"></a>numneigh  <span class="ot">&lt;-</span>  <span class="fu">apply</span>(W.mat, <span class="dv">2</span>, sum)</span>
<span id="cb272-11"><a href="Disease.html#cb272-11" tabindex="-1"></a>nbs <span class="ot">&lt;-</span> <span class="fu">mungeCARdata4stan</span>(neigh, numneigh)</span>
<span id="cb272-12"><a href="Disease.html#cb272-12" tabindex="-1"></a></span>
<span id="cb272-13"><a href="Disease.html#cb272-13" tabindex="-1"></a></span>
<span id="cb272-14"><a href="Disease.html#cb272-14" tabindex="-1"></a><span class="co"># Define data and variables for Stan model</span></span>
<span id="cb272-15"><a href="Disease.html#cb272-15" tabindex="-1"></a>y <span class="ot">&lt;-</span> copd_df<span class="sc">$</span>Y2010</span>
<span id="cb272-16"><a href="Disease.html#cb272-16" tabindex="-1"></a>E <span class="ot">&lt;-</span> copd_df<span class="sc">$</span>E2010</span>
<span id="cb272-17"><a href="Disease.html#cb272-17" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(copd_df<span class="sc">$</span>Average.Score)</span>
<span id="cb272-18"><a href="Disease.html#cb272-18" tabindex="-1"></a></span>
<span id="cb272-19"><a href="Disease.html#cb272-19" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb272-20"><a href="Disease.html#cb272-20" tabindex="-1"></a>  <span class="at">N =</span>  nbs<span class="sc">$</span>N,</span>
<span id="cb272-21"><a href="Disease.html#cb272-21" tabindex="-1"></a>  <span class="at">y =</span> y,</span>
<span id="cb272-22"><a href="Disease.html#cb272-22" tabindex="-1"></a>  <span class="at">E =</span> E,</span>
<span id="cb272-23"><a href="Disease.html#cb272-23" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">1</span>,</span>
<span id="cb272-24"><a href="Disease.html#cb272-24" tabindex="-1"></a>  <span class="at">X =</span> <span class="fu">as.matrix</span>(X),</span>
<span id="cb272-25"><a href="Disease.html#cb272-25" tabindex="-1"></a>  <span class="at">N_edges =</span> nbs<span class="sc">$</span>N_edges,</span>
<span id="cb272-26"><a href="Disease.html#cb272-26" tabindex="-1"></a>  <span class="at">node1 =</span> nbs<span class="sc">$</span>node1,</span>
<span id="cb272-27"><a href="Disease.html#cb272-27" tabindex="-1"></a>  <span class="at">node2 =</span> nbs<span class="sc">$</span>node2</span>
<span id="cb272-28"><a href="Disease.html#cb272-28" tabindex="-1"></a>)</span>
<span id="cb272-29"><a href="Disease.html#cb272-29" tabindex="-1"></a></span>
<span id="cb272-30"><a href="Disease.html#cb272-30" tabindex="-1"></a>Example9_3Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb272-31"><a href="Disease.html#cb272-31" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example9_3.stan&quot;</span>,</span>
<span id="cb272-32"><a href="Disease.html#cb272-32" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb272-33"><a href="Disease.html#cb272-33" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">2000</span>,</span>
<span id="cb272-34"><a href="Disease.html#cb272-34" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb272-35"><a href="Disease.html#cb272-35" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb272-36"><a href="Disease.html#cb272-36" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">8</span>,</span>
<span id="cb272-37"><a href="Disease.html#cb272-37" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma_s&quot;</span>, <span class="st">&quot;riskdep&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;log_lik&quot;</span>),</span>
<span id="cb272-38"><a href="Disease.html#cb272-38" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb272-39"><a href="Disease.html#cb272-39" tabindex="-1"></a>)</span></code></pre></div>
<p>Trace plots of the posterior samples for some of the parameters.</p>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="Disease.html#cb273-1" tabindex="-1"></a><span class="co">#traceplots of some parameters</span></span>
<span id="cb273-2"><a href="Disease.html#cb273-2" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example9_3Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma_s&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.3%20stan%20CAR%20traceplots-1.png" width="672" /></p>
<p>We now obtain the posterior summaries of the intercept, the fixed effect associated with the deprivation score and the standard deviation of the random effect. The quantity <code>riskdep</code> shows the relative risk associated with an one unit increase in deprivation.
<!---Show the posterior summary for the parameters if interest. 
Keep in mind that in the stan model the we are sampling the standard deviation of the random effect unlike `CARBayes` where the variance is obtained.---></p>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb274-1"><a href="Disease.html#cb274-1" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb274-2"><a href="Disease.html#cb274-2" tabindex="-1"></a>summary_CAR_stan <span class="ot">&lt;-</span></span>
<span id="cb274-3"><a href="Disease.html#cb274-3" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb274-4"><a href="Disease.html#cb274-4" tabindex="-1"></a>    Example9_3Stan,</span>
<span id="cb274-5"><a href="Disease.html#cb274-5" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma_s&quot;</span>,<span class="st">&quot;riskdep&quot;</span>),</span>
<span id="cb274-6"><a href="Disease.html#cb274-6" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb274-7"><a href="Disease.html#cb274-7" tabindex="-1"></a>  )</span>
<span id="cb274-8"><a href="Disease.html#cb274-8" tabindex="-1"></a></span>
<span id="cb274-9"><a href="Disease.html#cb274-9" tabindex="-1"></a>summary_CAR_stan<span class="sc">$</span>summary</span></code></pre></div>
<pre><code>##               mean      se_mean          sd        2.5%       97.5%    n_eff
## beta0   -0.4831513 7.614790e-04 0.029746646 -0.54094962 -0.42631806 1526.020
## beta[1]  0.0216228 3.757970e-05 0.001446513  0.01884916  0.02450198 1481.623
## sigma_s  0.2581699 5.230906e-04 0.021200471  0.21816947  0.30228148 1642.621
## riskdep  1.0218593 3.840191e-05 0.001478135  1.01902793  1.02480462 1481.572
##             Rhat
## beta0   1.000210
## beta[1] 1.000255
## sigma_s 1.000640
## riskdep 1.000257</code></pre>
<p>The result suggests that an one unit increase in deprivation, increases the relative risk by 2.2%. Recall that the standard deviation of the ICAR prior refers to the standard deviation of a conditional distribution.</p>
<p>We now plot the posterior means of the latent effects</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb276-1"><a href="Disease.html#cb276-1" tabindex="-1"></a>summary_CAR_stan_b <span class="ot">&lt;-</span></span>
<span id="cb276-2"><a href="Disease.html#cb276-2" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb276-3"><a href="Disease.html#cb276-3" tabindex="-1"></a>    Example9_3Stan,</span>
<span id="cb276-4"><a href="Disease.html#cb276-4" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;b&quot;</span>),</span>
<span id="cb276-5"><a href="Disease.html#cb276-5" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb276-6"><a href="Disease.html#cb276-6" tabindex="-1"></a>  )</span>
<span id="cb276-7"><a href="Disease.html#cb276-7" tabindex="-1"></a></span>
<span id="cb276-8"><a href="Disease.html#cb276-8" tabindex="-1"></a>observed <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(observed, <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb276-9"><a href="Disease.html#cb276-9" tabindex="-1"></a></span>
<span id="cb276-10"><a href="Disease.html#cb276-10" tabindex="-1"></a>summary_CAR_stan_b<span class="sc">$</span>ID <span class="ot">&lt;-</span> observed<span class="sc">$</span>ID</span>
<span id="cb276-11"><a href="Disease.html#cb276-11" tabindex="-1"></a></span>
<span id="cb276-12"><a href="Disease.html#cb276-12" tabindex="-1"></a>CAR_stan_merge <span class="ot">&lt;-</span> <span class="fu">merge</span>(england, summary_CAR_stan_b, <span class="at">by =</span> <span class="st">&quot;ID&quot;</span>) </span>
<span id="cb276-13"><a href="Disease.html#cb276-13" tabindex="-1"></a></span>
<span id="cb276-14"><a href="Disease.html#cb276-14" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb276-15"><a href="Disease.html#cb276-15" tabindex="-1"></a>  <span class="co"># Choose spatial object and column for plotting</span></span>
<span id="cb276-16"><a href="Disease.html#cb276-16" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CAR_stan_merge, <span class="fu">aes</span>(<span class="at">fill =</span> summary.mean)) <span class="sc">+</span> </span>
<span id="cb276-17"><a href="Disease.html#cb276-17" tabindex="-1"></a>  <span class="co"># Change legend&#39;s label</span></span>
<span id="cb276-18"><a href="Disease.html#cb276-18" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&#39;Latent effects stan&#39;</span>) <span class="sc">+</span></span>
<span id="cb276-19"><a href="Disease.html#cb276-19" tabindex="-1"></a>  <span class="co"># Clear background and plot borders</span></span>
<span id="cb276-20"><a href="Disease.html#cb276-20" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.3%20plot%20map%20stan-1.png" width="672" /></p>
<!-- IDEA: Maybe we should agree on what output we will show for every method -->
</div>
</div>
<div id="example-9.4-fitting-a-conditional-spatial-model-using-carbayes" class="section level2 unnumbered hasAnchor">
<h2>Example 9.4: Fitting a conditional spatial model using CARBayes<a href="Disease.html#example-9.4-fitting-a-conditional-spatial-model-using-carbayes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Here we consider fitting the Poisson log–normal model with spatial effects to the data for respiratory admissions seen in Example 9.3 using the R package <code>CARBayes</code>. The adjacency matrix is obtained using functions of the package <code>spdep</code>.</p>
<p><code>CARBayes</code> performs MCMC simulation similar to NIMBLE but has the distinct advantage that you just call specific functions to run the model.</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb277-1"><a href="Disease.html#cb277-1" tabindex="-1"></a><span class="fu">library</span>(CARBayes)</span>
<span id="cb277-2"><a href="Disease.html#cb277-2" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb277-3"><a href="Disease.html#cb277-3" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb277-4"><a href="Disease.html#cb277-4" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb277-5"><a href="Disease.html#cb277-5" tabindex="-1"></a></span>
<span id="cb277-6"><a href="Disease.html#cb277-6" tabindex="-1"></a><span class="co"># Reading in borders</span></span>
<span id="cb277-7"><a href="Disease.html#cb277-7" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/copd/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb277-8"><a href="Disease.html#cb277-8" tabindex="-1"></a><span class="co"># Reading in data</span></span>
<span id="cb277-9"><a href="Disease.html#cb277-9" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb277-10"><a href="Disease.html#cb277-10" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb277-11"><a href="Disease.html#cb277-11" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb277-12"><a href="Disease.html#cb277-12" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdmortalityexpected.csv&quot;</span>)</span>
<span id="cb277-13"><a href="Disease.html#cb277-13" tabindex="-1"></a>covariates <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copd/copdavgscore.csv&quot;</span>) </span>
<span id="cb277-14"><a href="Disease.html#cb277-14" tabindex="-1"></a><span class="co"># Merge everything into one data frame</span></span>
<span id="cb277-15"><a href="Disease.html#cb277-15" tabindex="-1"></a>copd_df <span class="ot">&lt;-</span></span>
<span id="cb277-16"><a href="Disease.html#cb277-16" tabindex="-1"></a>  <span class="fu">cbind</span>(observed,  expected) <span class="sc">|&gt;</span> <span class="fu">merge</span>(</span>
<span id="cb277-17"><a href="Disease.html#cb277-17" tabindex="-1"></a>    covariates,</span>
<span id="cb277-18"><a href="Disease.html#cb277-18" tabindex="-1"></a>    <span class="at">by.x =</span> <span class="st">&quot;code&quot;</span>,</span>
<span id="cb277-19"><a href="Disease.html#cb277-19" tabindex="-1"></a>    <span class="at">by.y =</span> <span class="st">&quot;LA.CODE&quot;</span>,</span>
<span id="cb277-20"><a href="Disease.html#cb277-20" tabindex="-1"></a>    <span class="at">all.x =</span> <span class="cn">TRUE</span>,</span>
<span id="cb277-21"><a href="Disease.html#cb277-21" tabindex="-1"></a>    <span class="at">all.y =</span> <span class="cn">FALSE</span></span>
<span id="cb277-22"><a href="Disease.html#cb277-22" tabindex="-1"></a>  )</span>
<span id="cb277-23"><a href="Disease.html#cb277-23" tabindex="-1"></a>copd_df<span class="sc">$</span>Average.Score <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(copd_df<span class="sc">$</span>Average.Score))</span></code></pre></div>
<p>Next we compute the neighborhood matrix through <code>poly2nb()</code> and <code>nb2mat()</code> from the <code>spdep</code>.</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="Disease.html#cb278-1" tabindex="-1"></a><span class="co"># Create the neighborhood</span></span>
<span id="cb278-2"><a href="Disease.html#cb278-2" tabindex="-1"></a>W.nb <span class="ot">&lt;-</span><span class="fu">poly2nb</span>(england, <span class="at">row.names =</span> <span class="fu">rownames</span>(england))</span>
<span id="cb278-3"><a href="Disease.html#cb278-3" tabindex="-1"></a></span>
<span id="cb278-4"><a href="Disease.html#cb278-4" tabindex="-1"></a><span class="co"># Creates a matrix for following function call</span></span>
<span id="cb278-5"><a href="Disease.html#cb278-5" tabindex="-1"></a>W.mat <span class="ot">&lt;-</span>  <span class="fu">nb2mat</span>(W.nb, <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span></code></pre></div>
<p>The function <code>S.CARleroux()</code> allows us to use the neighborhood structure and performs a Bayesian analysis assuming a CAR prior distribution to the random effects. This is obtained by setting the parameter rho equals 1 in the call of <code>S.CARleroux()</code>.</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb279-1"><a href="Disease.html#cb279-1" tabindex="-1"></a><span class="co"># Running smoothing model</span></span>
<span id="cb279-2"><a href="Disease.html#cb279-2" tabindex="-1"></a>Ex9_4 <span class="ot">&lt;-</span></span>
<span id="cb279-3"><a href="Disease.html#cb279-3" tabindex="-1"></a>  <span class="fu">S.CARleroux</span>(</span>
<span id="cb279-4"><a href="Disease.html#cb279-4" tabindex="-1"></a>    <span class="co"># Model Formula</span></span>
<span id="cb279-5"><a href="Disease.html#cb279-5" tabindex="-1"></a>    <span class="at">formula =</span> Y2010 <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(E2010)) <span class="sc">+</span> Average.Score,</span>
<span id="cb279-6"><a href="Disease.html#cb279-6" tabindex="-1"></a>    <span class="co"># data frame with data</span></span>
<span id="cb279-7"><a href="Disease.html#cb279-7" tabindex="-1"></a>    <span class="at">data =</span> copd_df,</span>
<span id="cb279-8"><a href="Disease.html#cb279-8" tabindex="-1"></a>    <span class="co"># Choosing Poisson Regression</span></span>
<span id="cb279-9"><a href="Disease.html#cb279-9" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>,</span>
<span id="cb279-10"><a href="Disease.html#cb279-10" tabindex="-1"></a>    <span class="co"># Neighborhood matrix</span></span>
<span id="cb279-11"><a href="Disease.html#cb279-11" tabindex="-1"></a>    <span class="at">W =</span> W.mat,</span>
<span id="cb279-12"><a href="Disease.html#cb279-12" tabindex="-1"></a>    <span class="co"># Number of burn in samples</span></span>
<span id="cb279-13"><a href="Disease.html#cb279-13" tabindex="-1"></a>    <span class="at">burnin =</span> <span class="dv">20000</span>,</span>
<span id="cb279-14"><a href="Disease.html#cb279-14" tabindex="-1"></a>    <span class="co"># Number of MCMC samples</span></span>
<span id="cb279-15"><a href="Disease.html#cb279-15" tabindex="-1"></a>    <span class="at">n.sample =</span> <span class="dv">100000</span>,</span>
<span id="cb279-16"><a href="Disease.html#cb279-16" tabindex="-1"></a>    <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb279-17"><a href="Disease.html#cb279-17" tabindex="-1"></a>    <span class="co">#ICAR model given a 0-1 neighborhood structure</span></span>
<span id="cb279-18"><a href="Disease.html#cb279-18" tabindex="-1"></a>    <span class="at">rho =</span> <span class="dv">1</span></span>
<span id="cb279-19"><a href="Disease.html#cb279-19" tabindex="-1"></a>  )</span></code></pre></div>
<p>Using <code>ggplot()</code> and <code>geom_sf()</code> to plot the map of the latent spatial effects.</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode r foldable"><code class="sourceCode r"><span id="cb280-1"><a href="Disease.html#cb280-1" tabindex="-1"></a>observed <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(observed, <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb280-2"><a href="Disease.html#cb280-2" tabindex="-1"></a>phi_car <span class="ot">&lt;-</span>  Ex9_4<span class="sc">$</span>samples<span class="sc">$</span>phi</span>
<span id="cb280-3"><a href="Disease.html#cb280-3" tabindex="-1"></a></span>
<span id="cb280-4"><a href="Disease.html#cb280-4" tabindex="-1"></a>latent_car_df  <span class="ot">&lt;-</span>  <span class="fu">data.frame</span>(</span>
<span id="cb280-5"><a href="Disease.html#cb280-5" tabindex="-1"></a>  <span class="at">phi_mean =</span> <span class="fu">apply</span>(phi_car, <span class="dv">2</span>, mean),</span>
<span id="cb280-6"><a href="Disease.html#cb280-6" tabindex="-1"></a>  <span class="at">phi_sd =</span> <span class="fu">apply</span>(phi_car, <span class="dv">2</span>, sd)</span>
<span id="cb280-7"><a href="Disease.html#cb280-7" tabindex="-1"></a>)</span>
<span id="cb280-8"><a href="Disease.html#cb280-8" tabindex="-1"></a><span class="co"># Combine latent spatial effect with england dataset</span></span>
<span id="cb280-9"><a href="Disease.html#cb280-9" tabindex="-1"></a>latent_car_df<span class="sc">$</span>ID <span class="ot">&lt;-</span> observed<span class="sc">$</span>ID</span>
<span id="cb280-10"><a href="Disease.html#cb280-10" tabindex="-1"></a>latent_car_england <span class="ot">&lt;-</span>  <span class="fu">merge</span>(england, latent_car_df, <span class="at">by =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb280-11"><a href="Disease.html#cb280-11" tabindex="-1"></a><span class="co"># Creating map of smoothed SMRs in England in 2010</span></span>
<span id="cb280-12"><a href="Disease.html#cb280-12" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb280-13"><a href="Disease.html#cb280-13" tabindex="-1"></a>  <span class="co"># Choose spatial object and column for plotting</span></span>
<span id="cb280-14"><a href="Disease.html#cb280-14" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> latent_car_england, <span class="fu">aes</span>(<span class="at">fill =</span> phi_mean)) <span class="sc">+</span></span>
<span id="cb280-15"><a href="Disease.html#cb280-15" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&#39;Latent effects CARbayes&#39;</span>) <span class="sc">+</span></span>
<span id="cb280-16"><a href="Disease.html#cb280-16" tabindex="-1"></a>  <span class="co"># Clear background and plot borders</span></span>
<span id="cb280-17"><a href="Disease.html#cb280-17" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.4%20carbayes%20map%20smoothed%20SMRs-1.png" width="672" /></p>
</div>
<div id="example-9.5-fitting-a-conditional-model-using-inla" class="section level2 unnumbered hasAnchor">
<h2>Example 9.5: Fitting a conditional model using INLA<a href="Disease.html#example-9.5-fitting-a-conditional-model-using-inla" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now we fit the Poisson log–normal model with spatial effects to the data for respiratory admissions seen in Example 9.3 using <code>R-INLA</code>. Recall that <code>R-INLA</code> approximates the resultant posterior distribution using an integrated nested Laplace approximation. The call to fit the model using <code>R-INLA</code> is very similar to the one when fitting a <code>glm</code>. The latent effects are introduced through the function <code>f(.)</code>.</p>
<!-- TODO: Show output for this model  -->
<div class="sourceCode" id="cb281"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb281-1"><a href="Disease.html#cb281-1" tabindex="-1"></a><span class="co"># run the INLA model</span></span>
<span id="cb281-2"><a href="Disease.html#cb281-2" tabindex="-1"></a>Ex9_5 <span class="ot">&lt;-</span> <span class="fu">inla</span>(</span>
<span id="cb281-3"><a href="Disease.html#cb281-3" tabindex="-1"></a>  Y2010 <span class="sc">~</span> Average.Score <span class="sc">+</span> <span class="fu">f</span>(ID  , <span class="at">model =</span> <span class="st">&quot;besag&quot;</span>, <span class="at">graph =</span> <span class="st">&quot;UK.adj&quot;</span>),</span>
<span id="cb281-4"><a href="Disease.html#cb281-4" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>,</span>
<span id="cb281-5"><a href="Disease.html#cb281-5" tabindex="-1"></a>  <span class="at">E =</span> E2010,</span>
<span id="cb281-6"><a href="Disease.html#cb281-6" tabindex="-1"></a>  <span class="at">data =</span> copd_df,</span>
<span id="cb281-7"><a href="Disease.html#cb281-7" tabindex="-1"></a>  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>)</span>
<span id="cb281-8"><a href="Disease.html#cb281-8" tabindex="-1"></a>)</span></code></pre></div>
<p>Summarize the results</p>
<div class="sourceCode" id="cb282"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb282-1"><a href="Disease.html#cb282-1" tabindex="-1"></a><span class="co"># Summarizing smoothed SMRs</span></span>
<span id="cb282-2"><a href="Disease.html#cb282-2" tabindex="-1"></a><span class="fu">summary</span>(Ex9_5)</span></code></pre></div>
<pre><code>## 
## Call:
##    c(&quot;inla.core(formula = formula, family = family, contrasts = contrasts, 
##    &quot;, &quot; data = data, quantiles = quantiles, E = E, offset = offset, &quot;, &quot; 
##    scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, 
##    &quot;, &quot; lp.scale = lp.scale, link.covariates = link.covariates, verbose = 
##    verbose, &quot;, &quot; lincomb = lincomb, selection = selection, control.compute 
##    = control.compute, &quot;, &quot; control.predictor = control.predictor, 
##    control.family = control.family, &quot;, &quot; control.inla = control.inla, 
##    control.fixed = control.fixed, &quot;, &quot; control.mode = control.mode, 
##    control.expert = control.expert, &quot;, &quot; control.hazard = control.hazard, 
##    control.lincomb = control.lincomb, &quot;, &quot; control.update = 
##    control.update, control.lp.scale = control.lp.scale, &quot;, &quot; 
##    control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, 
##    &quot;, &quot; inla.call = inla.call, inla.arg = inla.arg, num.threads = 
##    num.threads, &quot;, &quot; blas.num.threads = blas.num.threads, keep = keep, 
##    working.directory = working.directory, &quot;, &quot; silent = silent, inla.mode 
##    = inla.mode, safe = FALSE, debug = debug, &quot;, &quot; .parent.frame = 
##    .parent.frame)&quot;) 
## Time used:
##     Pre = 0.966, Running = 0.272, Post = 0.0733, Total = 1.31 
## Fixed effects:
##                 mean    sd 0.025quant 0.5quant 0.975quant   mode kld
## (Intercept)   -0.069 0.008     -0.084   -0.069     -0.054 -0.069   0
## Average.Score  0.182 0.012      0.158    0.182      0.206  0.182   0
## 
## Random effects:
##   Name     Model
##     ID Besags ICAR model
## 
## Model hyperparameters:
##                   mean   sd 0.025quant 0.5quant 0.975quant  mode
## Precision for ID 15.94 2.62      11.52    15.70      21.75 15.23
## 
## Marginal log-Likelihood:  -1493.27 
##  is computed 
## Posterior summaries for the linear predictor and the fitted values are computed
## (Posterior marginals needs also &#39;control.compute=list(return.marginals.predictor=TRUE)&#39;)</code></pre>
<div class="sourceCode" id="cb284"><pre class="sourceCode r foldable"><code class="sourceCode r"><span id="cb284-1"><a href="Disease.html#cb284-1" tabindex="-1"></a>observed <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(observed, <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb284-2"><a href="Disease.html#cb284-2" tabindex="-1"></a>phi_car <span class="ot">&lt;-</span>  Ex9_5<span class="sc">$</span>summary.random<span class="sc">$</span>ID</span>
<span id="cb284-3"><a href="Disease.html#cb284-3" tabindex="-1"></a></span>
<span id="cb284-4"><a href="Disease.html#cb284-4" tabindex="-1"></a>latent_car_df  <span class="ot">&lt;-</span>  <span class="fu">data.frame</span>(</span>
<span id="cb284-5"><a href="Disease.html#cb284-5" tabindex="-1"></a>  <span class="at">phi_mean =</span> phi_car<span class="sc">$</span>mean,</span>
<span id="cb284-6"><a href="Disease.html#cb284-6" tabindex="-1"></a>  <span class="at">phi_sd =</span> phi_car<span class="sc">$</span>sd</span>
<span id="cb284-7"><a href="Disease.html#cb284-7" tabindex="-1"></a>)</span>
<span id="cb284-8"><a href="Disease.html#cb284-8" tabindex="-1"></a><span class="co"># Combine latent spatial effect with england dataset</span></span>
<span id="cb284-9"><a href="Disease.html#cb284-9" tabindex="-1"></a>latent_car_df<span class="sc">$</span>ID <span class="ot">&lt;-</span> observed<span class="sc">$</span>ID</span>
<span id="cb284-10"><a href="Disease.html#cb284-10" tabindex="-1"></a>latent_car_england <span class="ot">&lt;-</span>  <span class="fu">merge</span>(england, latent_car_df, <span class="at">by =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb284-11"><a href="Disease.html#cb284-11" tabindex="-1"></a><span class="co"># Creating map of smoothed SMRs in England in 2010</span></span>
<span id="cb284-12"><a href="Disease.html#cb284-12" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb284-13"><a href="Disease.html#cb284-13" tabindex="-1"></a>  <span class="co"># Choose spatial object and column for plotting</span></span>
<span id="cb284-14"><a href="Disease.html#cb284-14" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> latent_car_england, <span class="fu">aes</span>(<span class="at">fill =</span> phi_mean)) <span class="sc">+</span></span>
<span id="cb284-15"><a href="Disease.html#cb284-15" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&#39;Latent effects INLA&#39;</span>) <span class="sc">+</span></span>
<span id="cb284-16"><a href="Disease.html#cb284-16" tabindex="-1"></a>  <span class="co"># Clear background and plot borders</span></span>
<span id="cb284-17"><a href="Disease.html#cb284-17" tabindex="-1"></a>  <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.5%20inla%20smoothed%20SMRs-1.png" width="672" /></p>
</div>
<div id="supplementary-example-fitting-a-leroux-model-to-the-copd-dataset-using-nimble-stan-and-carbayes" class="section level2 hasAnchor" number="9.1">
<h2><span class="header-section-number">9.1</span> Supplementary Example: Fitting a Leroux model to the COPD dataset using Nimble, Stan and CARBayes<a href="Disease.html#supplementary-example-fitting-a-leroux-model-to-the-copd-dataset-using-nimble-stan-and-carbayes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!-- ## Example 9.6: Fitting a Leroux Model using Nimble, Stan and CARBayes -->
<!-- This example uses the [englandlocalauthority.shp](https://github.com/spacetime-environ/stepi2/blob/main/data/copd/englandlocalauthority.shp), [copdmortalityobserved.csv](https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityobserved.csv), and -->
<!-- [copdmortalityexpected.csv](https://github.com/spacetime-environ/stepi2/blob/main/data/copd/copdmortalityexpected.csv) datasets from Chapter 6. -->
<!-- ### Nimble -->
<!-- ```{r Ex 9.6 nimble clean, include = FALSE} -->
<!-- rm(list=ls()) -->
<!-- ``` -->
<!-- ```{r Ex 9.6 nimble load, message=FALSE, warning=FALSE, message= FALSE} -->
<!-- library(ggplot2) # to plot map -->
<!-- library(spdep) # read the shapefile (read_sf) and build neighbors list (poly2nb) -->
<!-- library(nimble) -->
<!-- # Load data -->
<!-- # Reading in borders -->
<!-- england <- read_sf("data/copd/englandlocalauthority.shp") -->
<!-- # Reading in data -->
<!-- observed <- -->
<!--   read.csv(file = "data/copd/copdmortalityobserved.csv", row.names = 1) -->
<!-- expected <- -->
<!--   read.csv(file = "data/copd/copd   mortalityexpected.csv") -->
<!-- covariates <- read.csv(file = "data/copd/copdavgscore.csv") -->
<!-- # Merge everything into one data frame -->
<!-- copd_df <- -->
<!--   cbind(observed,  expected) |> merge( -->
<!--     covariates, -->
<!--     by.x = "code", -->
<!--     by.y = "LA.CODE", -->
<!--     all.x = TRUE, -->
<!--     all.y = FALSE -->
<!--   ) -->
<!-- ``` -->
<!-- Define a function to obtain the number of neighbors. -->
<!-- ```{r Ex 9.6 nimble munge functions, echo = TRUE} -->
<!-- adjlist = function(W, N) { -->
<!--   adj = 0 -->
<!--   for (i in 1:N) { -->
<!--     for (j in 1:N) { -->
<!--       if (W[i, j] == 1) { -->
<!--         adj = append(adj, j) -->
<!--       } -->
<!--     } -->
<!--   } -->
<!--   adj = adj[-1] -->
<!--   return(adj) -->
<!-- } -->
<!-- ``` -->
<!-- Define the adjacency matrix and indexes for `stan` using the `nb2mat` and `adjlist` -->
<!-- ```{r Ex 9.6 nimble neighborhood} -->
<!-- # Create the neighborhood -->
<!-- W.nb <- -->
<!--   poly2nb(england, row.names = rownames(england)) -->
<!-- # Creates a matrix for following function call -->
<!-- W.mat <- nb2mat(W.nb, zero.policy = TRUE, style = "B") -->
<!-- # Define the spatial structure to use in stan -->
<!-- N <- length(unique(england$ID)) -->
<!-- neigh  <- adjlist(W.mat, N) -->
<!-- numneigh  <- apply(W.mat,2,sum) -->
<!-- # Define the precision matrix of Leroux -->
<!-- Q <- matrix(0, nrow = nrow(W.mat), ncol = ncol(W.mat)) -->
<!-- diag(Q) <- apply(W.mat, 1, sum) -->
<!-- Q <- Q - W.mat -->
<!-- ``` -->
<!-- ```{r Ex 9.6 nimble leroux model, warning=FALSE, message = FALSE, results='hide'} -->
<!-- Example9_6Nimble <- nimbleCode({ -->
<!--   # Likelihood -->
<!--   for (i in 1:N) { -->
<!--     y[i] ~ dpois(lambda[i]) -->
<!--     log(lambda[i]) <- log(E[i]) + b[i]  -->
<!--     mean_b[i] <- beta0 + beta1*x[i] -->
<!--    # b_centered[i] <- b[i] - b_mean -->
<!--   } -->
<!--   PrecMat[1:N, 1:N] <- tau*(rho*Q[1:N, 1:N] + (1-rho)*diag(N)) -->
<!--   # mean_b[1:N] <- nimRep(beta0, N) -->
<!--  # b_mean <- sum(b[1:N])/N -->
<!--     # Priors -->
<!--   beta0 ~ dnorm(0, sd = 1) -->
<!--   beta1 ~ dnorm(0, sd = 1) -->
<!--   b[1:N] ~ dmnorm(mean = mean_b[1:N], prec = PrecMat[1:N, 1:N]) -->
<!--   tau <- 1 / (sigma_b ^ 2) -->
<!--   sigma_b ~ T(dt(0,1,1),0,) -->
<!--   rho ~ dunif(0, 1) -->
<!--   # Fitted values and likelihood for WAIC -->
<!--   # for (i in 1:N) { -->
<!--   #   fitted[i] ~ dpois(lambda[i]) -->
<!--   # } -->
<!-- }) -->
<!-- #  Define the constants, data and initial values lists and run the model. -->
<!-- # constants list -->
<!-- constants <- list( -->
<!--   N = N, -->
<!--   E = copd_df$E2010, -->
<!--   Q = Q -->
<!-- ) -->
<!-- # data list -->
<!-- ex.data <- -->
<!--   list(y = copd_df$Y2010, -->
<!--        x = as.vector(scale(copd_df$Average.Score))) # vector of covariates -->
<!-- inits <-  list( -->
<!--   beta0 = rnorm(1), -->
<!--   beta1 = rnorm(1), -->
<!-- #  fitted = rpois(N, 2), -->
<!--   sigma_b = 1, -->
<!--   b = rnorm(N), -->
<!--   rho = 0.5 -->
<!-- ) -->
<!-- params <- c("beta0", "beta1", "b", "sigma_b", "tau" ,"rho") -->
<!-- # Run model in nimble -->
<!-- mcmc.out <- nimbleMCMC( -->
<!--   code = Example9_6Nimble, -->
<!--   constants = constants, -->
<!--   data = ex.data, -->
<!--   inits = inits, -->
<!--   monitors = params, -->
<!--   niter = 80000, -->
<!--   nburnin = 40000, -->
<!--   thin = 15, -->
<!--   WAIC = TRUE, -->
<!--   nchains = 2, -->
<!--   summary = TRUE, -->
<!--   samplesAsCodaMCMC = TRUE -->
<!-- ) -->
<!-- ``` -->
<!-- Show the WAIC, effective sample size, and trace plots for some of the parameters. -->
<!-- ```{r Ex 9.6 WAIC, ESS and traceplots } -->
<!-- mcmc.out$WAIC -->
<!-- min(coda::effectiveSize(mcmc.out$samples)) -->
<!-- plot(mcmc.out$samples[, c("beta0")], bty = "n", main = "beta0") -->
<!-- plot(mcmc.out$samples[, c("beta1")], bty = "n",  main = "beta1") -->
<!-- plot(mcmc.out$samples[, c("b[2]")], bty = "n",  main = "b[2]") -->
<!-- plot(mcmc.out$samples[, c("sigma_b")], bty = "n", main = "sigma_b") -->
<!-- ``` -->
<!-- ```{r Ex 9.6 nimble leroux summary, echo = TRUE} -->
<!-- # Extract samples -->
<!-- variables <- c("beta0", "beta1","sigma_b", "rho") -->
<!-- summary_nimble <- mcmc.out$summary$all.chains -->
<!-- summary_nimble[variables,] -->
<!-- ``` -->
<!-- Map the mean of the posterior estimate for the latent effect. -->
<!-- ```{r Ex 9.6 plot map nimble} -->
<!-- samples_Leroux_b <- -->
<!--   summary_Leroux_nimble[grepl("b\\[", rownames(summary_CAR_nimble)), ] |> as.data.frame() -->
<!-- observed <- tibble::rownames_to_column(observed, "ID") -->
<!-- samples_Leroux_b$ID <- observed$ID -->
<!-- CAR_nimble_merge <- merge(england, samples_CAR_b, by = "ID") -->
<!-- ggplot() + -->
<!--   # Choose spatial object and column for plotting -->
<!--   geom_sf(data = Leroux_nimble_merge, aes(fill = Mean)) + -->
<!--   # Change legend's label -->
<!--   labs(fill = 'Latent effects nimble') + -->
<!--   # Clear background and plot borders -->
<!--  theme_void() -->
<!-- ``` -->
<!-- ### Stan -->
<!-- Here, we implement the CAR model using `stan`. -->
<!-- ```{r Ex 9.6 stan clean, include = FALSE} -->
<!-- rm(list=ls()) -->
<!-- ``` -->
<!-- ```{r Ex 9.6 stan load, message=FALSE, echo = FALSE, warning=FALSE, message= FALSE} -->
<!-- library(ggplot2) -->
<!-- library(loo) # To calculate WAIC and loo later -->
<!-- library(rstan) -->
<!-- library(spdep) -->
<!-- # Additional settings for stan -->
<!-- options(mc.cores = parallel::detectCores()) -->
<!-- rstan_options(auto_write = TRUE) -->
<!-- # Load data -->
<!-- # Reading in borders -->
<!-- england <- read_sf("data/copd/englandlocalauthority.shp") -->
<!-- # Reading in data -->
<!-- observed <- -->
<!--   read.csv(file = "data/copd/copdmortalityobserved.csv", row.names = 1) -->
<!-- expected <- -->
<!--   read.csv(file = "data/copd/copdmortalityexpected.csv") -->
<!-- covariates <- read.csv(file = "data/copd/copdavgscore.csv") -->
<!-- # Merge everything into one data frame -->
<!-- copd_df <- -->
<!--   cbind(observed,  expected) |> merge( -->
<!--     covariates, -->
<!--     by.x = "code", -->
<!--     by.y = "LA.CODE", -->
<!--     all.x = TRUE, -->
<!--     all.y = FALSE -->
<!--   ) -->
<!-- ``` -->
<!-- We will need two functions to structure the matrix of neighbors that will be needed in `stan`. -->
<!-- ```{r Ex 9.6 stan munge functions, echo = TRUE} -->
<!-- adjlist = function(W, N) { -->
<!--   adj = 0 -->
<!--   for (i in 1:N) { -->
<!--     for (j in 1:N) { -->
<!--       if (W[i, j] == 1) { -->
<!--         adj = append(adj, j) -->
<!--       } -->
<!--     } -->
<!--   } -->
<!--   adj = adj[-1] -->
<!--   return(adj) -->
<!-- } -->
<!-- mungeCARdata4stan = function(adjBUGS, numBUGS) { -->
<!--   N = length(numBUGS) -->
<!--   nn = numBUGS -->
<!--   N_edges = length(adjBUGS) / 2 -->
<!--   node1 = vector(mode = "numeric", length = N_edges) -->
<!--   node2 = vector(mode = "numeric", length = N_edges) -->
<!--   iAdj = 0 -->
<!--   iEdge = 0 -->
<!--   for (i in 1:N) { -->
<!--     for (j in 1:nn[i]) { -->
<!--       iAdj = iAdj + 1 -->
<!--       if (i < adjBUGS[iAdj]) { -->
<!--         iEdge = iEdge + 1 -->
<!--         node1[iEdge] = i -->
<!--         node2[iEdge] = adjBUGS[iAdj] -->
<!--       } -->
<!--     } -->
<!--   } -->
<!--   return (list( -->
<!--     "N" = N, -->
<!--     "N_edges" = N_edges, -->
<!--     "node1" = node1, -->
<!--     "node2" = node2 -->
<!--   )) -->
<!-- } -->
<!-- ``` -->
<!-- This model is in a separate file called `Example8_3.stan` that will be called later. -->
<!-- ```{r engine='bash', comment='', echo = FALSE} -->
<!-- cat functions/Example9_6.stan -->
<!-- ``` -->
<!-- <!-- REVIEW: I am missing the adjacency matrix but I calculated like they did for the CARBayes example, is that right? -->
<p>–&gt;</p>
<!-- Define the adjacency matrix and indexes for `stan` using the `nb2mat` and `adjlist` -->
<!-- ```{r Ex 9.6 stan car effects, warning=FALSE, results='hide', message = FALSE, cache=TRUE} -->
<!-- # Create the neighborhood -->
<!-- W.nb <- -->
<!--   poly2nb(england, row.names = rownames(england)) -->
<!-- # Creates a matrix for following function call -->
<!-- W.mat <- nb2mat(W.nb, style = "B") -->
<!-- # Define the spatial structure to use in stan -->
<!-- N <- length(unique(england$ID)) -->
<!-- neigh <- adjlist(W.mat, N) -->
<!-- numneigh  <-  apply(W.mat, 2, sum) -->
<!-- nbs <- mungeCARdata4stan(neigh, numneigh) -->
<!-- # Define data and variables for Stan model -->
<!-- y <- copd_df$Y2010 -->
<!-- E <- copd_df$E2010 -->
<!-- X <- as.numeric(scale(copd_df$Average.Score)) -->
<!-- # Obtain cumulative number of neighbors -->
<!-- N1=N+1 -->
<!-- C=numeric()  -->
<!-- C[1]=0 -->
<!-- for (j in 2:N1)  -->
<!--   C[j]=C[j-1]+ numneigh[j-1] # cumulative number of neighbours -->
<!-- ex.data <- list( -->
<!--   N = nbs$N, -->
<!--   y = y, -->
<!--   E = E, -->
<!--   p = 1, -->
<!--   C = C, -->
<!--   d = numneigh, -->
<!--   X = as.matrix(X), -->
<!--   N_edges = nbs$N_edges, -->
<!--   node1 = nbs$node1, -->
<!--   node2 = nbs$node2 -->
<!-- ) -->
<!-- Example9_6Stan  <- stan( -->
<!--   file = "functions/Example9_6.stan", -->
<!--   data = ex.data, -->
<!--   warmup = 10000, -->
<!--   iter = 20000, -->
<!--   chains = 2, -->
<!--   thin = 10, -->
<!--   pars = c("beta0", "beta","sigma_s", "b", "log_lik", "rho"), -->
<!--   include = TRUE -->
<!-- ) -->
<!-- ``` -->
<!-- Show traceplots. -->
<!-- ```{r Ex 9.6 stan CAR traceplots} -->
<!-- #computing WAIC using the package loo -->
<!-- loglikcar <- extract_log_lik(Example9_6Stan) -->
<!-- waiccar <- waic(loglikcar) -->
<!-- waiccar -->
<!-- rstan::traceplot(Example9_6Stan, pars = c("beta0","beta","sigma_s")) -->
<!-- ``` -->
<!-- Show the posterior summary for the parameters if interest. -->
<!-- Keep in mind that in the stan model the we are sampling the standard deviation of the random effect unlike `CARBayes` where the variance is obtained. -->
<!-- ```{r Ex 9.6 stan CAR results, echo = TRUE} -->
<!-- # Extract samples -->
<!-- summary_CAR_stan <- -->
<!--   summary( -->
<!--     Example9_6Stan, -->
<!--     pars = c("beta0", "beta","sigma_s"), -->
<!--     probs = c(0.025, 0.975) -->
<!--   ) -->
<!-- summary_CAR_stan$summary -->
<!-- ``` -->
<!-- Map the mean of the posterior estimate for the latent effect. -->
<!-- ```{r Ex 9.6 plot map stan} -->
<!-- summary_CAR_stan_b <- -->
<!--   summary( -->
<!--     Example9_6Stan, -->
<!--     pars = c("b"), -->
<!--     probs = c(0.025, 0.975) -->
<!--   ) -->
<!-- observed <- tibble::rownames_to_column(observed, "ID") -->
<!-- summary_CAR_stan_b$ID <- observed$ID -->
<!-- CAR_stan_merge <- merge(england, summary_CAR_stan_b, by = "ID") -->
<!-- ggplot() + -->
<!--   # Choose spatial object and column for plotting -->
<!--   geom_sf(data = CAR_stan_merge, aes(fill = summary.mean)) + -->
<!--   # Change legend's label -->
<!--   labs(fill = 'Latent effects stan') + -->
<!--   # Clear background and plot borders -->
<!--   theme_void() -->
<!-- ``` -->
<!-- ### CARBayes -->
<!-- ```{r Ex 9.6 clean, include=FALSE} -->
<!-- rm(list=ls()) -->
<!-- ``` -->
<!-- ```{r Ex 9.6 carbayes load, message=FALSE, warning=FALSE, message= FALSE} -->
<!-- library(CARBayes) -->
<!-- library(ggplot2) -->
<!-- library(sf) -->
<!-- library(spdep) -->
<!-- # Reading in borders -->
<!-- england <- read_sf("data/copd/englandlocalauthority.shp") -->
<!-- # Reading in data -->
<!-- observed <- -->
<!--   read.csv(file = "data/copd/copdmortalityobserved.csv", row.names = 1) -->
<!-- expected <- -->
<!--   read.csv(file = "data/copd/copdmortalityexpected.csv") -->
<!-- covariates <- read.csv(file = "data/copd/copdavgscore.csv") -->
<!-- # Merge everything into one data frame -->
<!-- copd_df <- -->
<!--   cbind(observed,  expected) |> merge( -->
<!--     covariates, -->
<!--     by.x = "code", -->
<!--     by.y = "LA.CODE", -->
<!--     all.x = TRUE, -->
<!--     all.y = FALSE -->
<!--   ) -->
<!-- copd_df$Average.Score <- as.numeric(scale(copd_df$Average.Score)) -->
<!-- ``` -->
<!-- ```{r Ex 9.6 carbayes neighborhood} -->
<!-- # Create the neighborhood -->
<!-- W.nb <- -->
<!--   poly2nb(england, row.names = rownames(england)) -->
<!-- # Creates a matrix for following function call -->
<!-- W.mat <- nb2mat(W.nb, style = "B") -->
<!-- ``` -->
<!-- ```{r Ex 9.6 carbayes run, results='hide', message = FALSE, cache = TRUE} -->
<!-- # Running smoothing model -->
<!-- Ex9_6 <- -->
<!--   S.CARleroux( -->
<!--     # Model Formula -->
<!--     formula = Y2010 ~ offset(log(E2010)) + Average.Score, -->
<!--     # data frame with data -->
<!--     data = copd_df, -->
<!--     # Choosing Poisson Regression -->
<!--     family = "poisson", -->
<!--     # Neighborhood matrix -->
<!--     W = W.mat, -->
<!--     # Number of burn in samples -->
<!--     burnin = 20000, -->
<!--     # Number of MCMC samples -->
<!--     n.sample = 100000, -->
<!--     thin = 10 -->
<!--     # Note that here we don't set rho to any value as it need to be estimated -->
<!--   ) -->
<!-- ``` -->
<!-- We can extract the new smoother values from the model output and divide them by the expected values in order to compare both methods. -->
<!-- ```{r Ex 9.6 carbayes smoothed SMRs, class.source = 'foldable' } -->
<!-- # Creating a dataset with smoothed SMRs in 2010 -->
<!-- SMR2010 <- Ex9_6$fitted.values /  copd_df$E2010 -->
<!-- SMR_smooth <- as.data.frame(SMR2010, row.names = rownames(observed)) -->
<!-- # Printing first six rows of smoothed SMRs -->
<!-- head(SMR_smooth) -->
<!-- # Summarizing smoothed SMRs -->
<!-- summary(SMR_smooth) -->
<!-- # Summary of the parameters under the CAR model. -->
<!-- Ex9_6$summary.results[] -->
<!-- ``` -->
<!-- <!-- QUESTION: What do we want the latent effect or the fitted values? -->
<p>–&gt;</p>
<!-- Use `ggplot()` and `geom_sf()` to plot the map of the latent spatial effect. -->
<!-- ```{r Ex 9.6 carbayes map smoothed SMRs, class.source = 'foldable'} -->
<!-- observed <- tibble::rownames_to_column(observed, "ID") -->
<!-- phi_car <-  Ex9_6$samples$phi -->
<!-- latent_car_df  <-  data.frame( -->
<!--   phi_mean = apply(phi_car, 2, mean), -->
<!--   phi_sd = apply(phi_car, 2, sd) -->
<!-- ) -->
<!-- # Combine latent spatial effect with england dataset -->
<!-- latent_car_df$ID <- observed$ID -->
<!-- latent_car_england <-  merge(england, latent_car_df, by = "ID") -->
<!-- # Creating map of smoothed SMRs in England in 2010 -->
<!-- ggplot() + -->
<!--   # Choose spatial object and column for plotting -->
<!--   geom_sf(data = latent_car_england, aes(fill = phi_mean)) + -->
<!--   labs(fill = 'Latent effects CARbayes Leroux model') + -->
<!--   # Clear background and plot borders -->
<!--   theme_void() -->
<!-- ``` -->

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="trusted.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="hazards.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/09-Chpt9.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
