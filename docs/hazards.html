<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 10 Environmental hazards-spatial models | Spatio-temporal methods in environmental epidemiology</title>
  <meta name="description" content="Chapter 10 Environmental hazards-spatial models | Spatio-temporal methods in environmental epidemiology" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 10 Environmental hazards-spatial models | Spatio-temporal methods in environmental epidemiology" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/img/cover.jpg" />
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 10 Environmental hazards-spatial models | Spatio-temporal methods in environmental epidemiology" />
  
  
  <meta name="twitter:image" content="/img/cover.jpg" />

<meta name="author" content="Gavin Shaddick, James V. Zidek, and Alexandra M. Schmidt" />


<meta name="date" content="2023-04-21" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="Disease.html"/>
<link rel="next" href="Time.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatio-temporal methods in environmental epidemiology</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="preface-2nd-edition.html"><a href="preface-2nd-edition.html"><i class="fa fa-check"></i>Preface (2nd edition)</a></li>
<li class="chapter" data-level="1" data-path="why.html"><a href="why.html"><i class="fa fa-check"></i><b>1</b> Why spatio-temporal epidemiology?</a>
<ul>
<li class="chapter" data-level="" data-path="why.html"><a href="why.html#example-1.5"><i class="fa fa-check"></i>Example 1.5</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> Epidemiology-the basics</a>
<ul>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.9-estimating-the-smr-using-a-poisson-glm"><i class="fa fa-check"></i>Example 2.9: Estimating the SMR using a Poisson GLM</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.10-estimating-the-smr-using-quasi-likelihood"><i class="fa fa-check"></i>Example 2.10: Estimating the SMR using quasi-likelihood</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.11-modelling-differences-in-smrs-in-relation-to-differences-in-exposures"><i class="fa fa-check"></i>Example 2.11: Modelling differences in SMRs in relation to differences in exposures</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.12-modelling-the-risks-associated-with-lagged-effects-of-air-pollution"><i class="fa fa-check"></i>Example 2.12: Modelling the risks associated with lagged effects of air pollution</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.13-estimating-the-odds-ratio-in-a-case-control-study-using-a-logistic-model"><i class="fa fa-check"></i>Example 2.13: Estimating the odds ratio in a case-control study using a logistic model</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.14-estimating-the-odds-ratio-of-asthma-associated-with-proximity-to-roads"><i class="fa fa-check"></i>Example 2.14: Estimating the odds ratio of asthma associated with proximity to roads</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="uncertainty.html"><a href="uncertainty.html"><i class="fa fa-check"></i><b>3</b> Uncertainty and its reduction</a></li>
<li class="chapter" data-level="4" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>4</b> Data: increasing information and reducing uncertainty</a></li>
<li class="chapter" data-level="5" data-path="embracing.html"><a href="embracing.html"><i class="fa fa-check"></i><b>5</b> Embracing uncertainty: the Bayesian approach</a></li>
<li class="chapter" data-level="6" data-path="tactics.html"><a href="tactics.html"><i class="fa fa-check"></i><b>6</b> Tactics-implementing uncertainty models</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.2-chronic-obstructive-pulmonary-disease-copd-in-england"><i class="fa fa-check"></i>Example 6.2: Chronic obstructive pulmonary disease (COPD) in England</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-the-raw-standardized-mortality-rates-smrs"><i class="fa fa-check"></i>Modelling the raw standardized mortality rates (SMRs)</a></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-a-poisson-gamma-with-an-mcmc-implemented-in-r"><i class="fa fa-check"></i>Modelling a Poisson-Gamma with an MCMC implemented in <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.3-fitting-a-poisson-regression-model"><i class="fa fa-check"></i>Example 6.3: Fitting a Poisson regression model</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#nimble"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#stan"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Strategies.html"><a href="Strategies.html"><i class="fa fa-check"></i><b>7</b> Strategies implementing uncertainty models</a></li>
<li class="chapter" data-level="8" data-path="trusted.html"><a href="trusted.html"><i class="fa fa-check"></i><b>8</b> But can the data be trusted</a>
<ul>
<li class="chapter" data-level="" data-path="trusted.html"><a href="trusted.html#solutions-to-selected-exercises"><i class="fa fa-check"></i>Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="trusted.html"><a href="trusted.html#placeholder-repeat-the-black-smoke-analysis-conducted-in-watson-et-al.-2019.-in-the-naive-model."><i class="fa fa-check"></i>PLACEHOLDER: Repeat the Black Smoke analysis conducted in Watson et al. 2019. in the “naive” model.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="Disease.html"><a href="Disease.html"><i class="fa fa-check"></i><b>9</b> Disease-spatial patterns</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010"><i class="fa fa-check"></i>Example 9.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-1"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-1"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-stan"><i class="fa fa-check"></i>Example 9.3: Fitting a conditional spatial model in <code>nimble</code> and <code>stan</code></a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-2"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-2"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.4-fitting-a-conditional-spatial-model-using-carbayes"><i class="fa fa-check"></i>Example 9.4: Fitting a conditional spatial model using CARBayes</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.5-fitting-a-conditional-model-using-inla"><i class="fa fa-check"></i>Example 9.5: Fitting a conditional model using INLA</a></li>
<li class="chapter" data-level="9.1" data-path="Disease.html"><a href="Disease.html#example-9.6-fitting-a-leroux-model-using-nimble-stan-and-carbayes"><i class="fa fa-check"></i><b>9.1</b> Example 9.6: Fitting a Leroux Model using Nimble, Stan and CARBayes</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="Disease.html"><a href="Disease.html#nimble-3"><i class="fa fa-check"></i><b>9.1.1</b> Nimble</a></li>
<li class="chapter" data-level="9.1.2" data-path="Disease.html"><a href="Disease.html#stan-3"><i class="fa fa-check"></i><b>9.1.2</b> Stan</a></li>
<li class="chapter" data-level="9.1.3" data-path="Disease.html"><a href="Disease.html#carbayes"><i class="fa fa-check"></i><b>9.1.3</b> CARBayes</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="hazards.html"><a href="hazards.html"><i class="fa fa-check"></i><b>10</b> Environmental hazards-spatial models</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada"><i class="fa fa-check"></i>Example 10.1 Spatial patterns of benzene concentrations in Montreal, QC, Canada</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.2-examining-the-log-concentrations-of-benzene-in-montreal"><i class="fa fa-check"></i>Example 10.2: Examining the log concentrations of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state"><i class="fa fa-check"></i>Example 10.3: Mapping the locations of ozone monitoring sites in New York State</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.5-variogram"><i class="fa fa-check"></i>Example 10.5: Variogram</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal"><i class="fa fa-check"></i>Example 10.6 Basic spatial modelling and prediction of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.9-spatial-modelling-of-benzene-in-montreal"><i class="fa fa-check"></i>Example 10.9 Spatial modelling of Benzene in Montreal</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-4"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-4"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.10-spatial-predictions"><i class="fa fa-check"></i>Example 10.10: Spatial predictions</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-5"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-5"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.11-inla-creating-a-mesh"><i class="fa fa-check"></i>Example 10.11: INLA, creating a mesh</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal"><i class="fa fa-check"></i>Example 10.12: Fitting an SPDE model using R–INLA: benzene concentration in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.13-directional-variograms"><i class="fa fa-check"></i>Example 10.13: Directional variograms</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.14-spatial-modeling-of-malaria-in-gambia"><i class="fa fa-check"></i>Example 10.14: Spatial modeling of malaria in Gambia</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-6"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-6"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="Time.html"><a href="Time.html"><i class="fa fa-check"></i><b>11</b> Time-why it also matters</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.1-ground-level-ozone-concentrations"><i class="fa fa-check"></i>Example 11.1 Ground level ozone concentrations</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.2-low-pass-filtering-of-carbon-monoxide-levels-using-the-moving-average"><i class="fa fa-check"></i>Example 11.2 Low-pass filtering of carbon monoxide levels using the moving average</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.13-forecasting-ozone-levels"><i class="fa fa-check"></i>Example 11.13 Forecasting ozone levels</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.14-forecasting-volcanic-ash"><i class="fa fa-check"></i>Example 11.14 Forecasting volcanic ash</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.16-fitting-a-random-walk-model-to-pm10-concentrations-in-london"><i class="fa fa-check"></i>Example 11.16 Fitting a random walk model to PM10 concentrations in London</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#nimble-7"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#stan-7"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.16-extra-implementation-of-a-dynamic-linear-model-uk-ozone-data"><i class="fa fa-check"></i>Example 11.16 EXTRA Implementation of a dynamic linear model: UK ozone data</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#nimble-8"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#stan-8"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#solutions-to-selected-exercises-1"><i class="fa fa-check"></i>Solutions to Selected Exercises</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#exercise-11.11"><i class="fa fa-check"></i>Exercise 11.11</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="exposure.html"><a href="exposure.html"><i class="fa fa-check"></i><b>12</b> Exposure assessment-over space and time</a></li>
<li class="chapter" data-level="13" data-path="causality.html"><a href="causality.html"><i class="fa fa-check"></i><b>13</b> Causality-roadblocks on the way to it</a>
<ul>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#solutions-to-selected-exercises-2"><i class="fa fa-check"></i>Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.16-load-the-italy-and-china-data-described-in-example-13.3-and-included-in-the-supplementary-bookdown-material-into-r."><i class="fa fa-check"></i>Question 13.16: Load the Italy and China data, described in Example 13.3, and included in the supplementary Bookdown material into R.</a></li>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.17-using-the-italy-and-china-data-stratified-by-the-age-groups-70-and-geq-70-obtain-empirical-estimates-of-p_1-and-p_2-as-defined-in-an-sdis.-in-the-following-questions-assume-that-p_1-and-p_2-are-the-population-values."><i class="fa fa-check"></i>Question 13.17: Using the Italy and China data stratified by the age groups <span class="math inline">\(&lt;70\)</span> and <span class="math inline">\(\geq 70\)</span>, obtain empirical estimates of <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span>, as defined in an SDis. In the following questions, assume that <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> are the population values.</a></li>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.18-stratify-the-italy-and-china-data-by-the-age-groups-50-and-geq-50.-display-the-corresponding-contingency-tables."><i class="fa fa-check"></i>Question 13.18: Stratify the Italy and China data by the age groups <span class="math inline">\(&lt;50\)</span> and <span class="math inline">\(\geq 50\)</span>. Display the corresponding contingency tables.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="monitoring.html"><a href="monitoring.html"><i class="fa fa-check"></i><b>14</b> Better monitoring network design-getting better measurements</a></li>
<li class="chapter" data-level="15" data-path="frontiers.html"><a href="frontiers.html"><i class="fa fa-check"></i><b>15</b> Current frontiers</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html"><i class="fa fa-check"></i>Course</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatio-temporal methods in environmental epidemiology</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="hazards" class="section level1 hasAnchor" number="10">
<h1><span class="header-section-number">Chapter 10</span> Environmental hazards-spatial models<a href="hazards.html#hazards" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter contains the basic theory for spatial processes and a number of approaches to modelling point-referenced spatial data. From this chapter, the reader will have gained an understanding of the following topics:</p>
<ul>
<li>Visualization techniques needed for both exploring and analyzing spatial data and communicating its features through the use of maps.</li>
<li>Exploring the underlying structure of spatial data and methods for characterizing dependence over space.</li>
<li>Second-order theory for spatial processes including the covariance. The variogram for measuring spatial associations.</li>
<li>Stationarity and isotropy.</li>
<li>Methods for spatial prediction, using both classical methods (kriging) as well as modern methods (Bayesian kriging).</li>
<li>Non-stationarity fields.</li>
</ul>
<!-- NOTE: Unlike some of the other chapters you have to run this code sequentially -->
<div id="example-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada" class="section level2 unnumbered hasAnchor">
<h2>Example 10.1 Spatial patterns of benzene concentrations in Montreal, QC, Canada<a href="hazards.html#example-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Map the locations of the monitoring stations in Montreal.</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="hazards.html#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb159-2"><a href="hazards.html#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb159-3"><a href="hazards.html#cb159-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggmap)</span>
<span id="cb159-4"><a href="hazards.html#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb159-5"><a href="hazards.html#cb159-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data on benzene concentration in Montreal</span></span>
<span id="cb159-6"><a href="hazards.html#cb159-6" aria-hidden="true" tabindex="-1"></a>benzene <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb159-7"><a href="hazards.html#cb159-7" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Add description of the data, this is the April campaign</span></span></code></pre></div>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="hazards.html#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb160-2"><a href="hazards.html#cb160-2" aria-hidden="true" tabindex="-1"></a>benzene_geo <span class="ot">&lt;-</span> benzene</span>
<span id="cb160-3"><a href="hazards.html#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb160-4"><a href="hazards.html#cb160-4" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb160-5"><a href="hazards.html#cb160-5" aria-hidden="true" tabindex="-1"></a><span class="co"># specify the bounding box</span></span>
<span id="cb160-6"><a href="hazards.html#cb160-6" aria-hidden="true" tabindex="-1"></a>latLongBox <span class="ot">=</span> <span class="fu">bbox</span>(benzene_geo)</span>
<span id="cb160-7"><a href="hazards.html#cb160-7" aria-hidden="true" tabindex="-1"></a>location <span class="ot">=</span> <span class="fu">c</span>(latLongBox[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb160-8"><a href="hazards.html#cb160-8" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb160-9"><a href="hazards.html#cb160-9" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.1</span>,</span>
<span id="cb160-10"><a href="hazards.html#cb160-10" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.05</span>)</span>
<span id="cb160-11"><a href="hazards.html#cb160-11" aria-hidden="true" tabindex="-1"></a><span class="co"># create map with location dots marked on it in</span></span>
<span id="cb160-12"><a href="hazards.html#cb160-12" aria-hidden="true" tabindex="-1"></a>MontrelBenzeneMap <span class="ot">&lt;-</span></span>
<span id="cb160-13"><a href="hazards.html#cb160-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_stamenmap</span>(<span class="at">bbox =</span>  location,</span>
<span id="cb160-14"><a href="hazards.html#cb160-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">zoom =</span> <span class="dv">10</span>)</span>
<span id="cb160-15"><a href="hazards.html#cb160-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggmap</span>(MontrelBenzeneMap) <span class="sc">+</span> <span class="fu">geom_point</span>(</span>
<span id="cb160-16"><a href="hazards.html#cb160-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> benzene,</span>
<span id="cb160-17"><a href="hazards.html#cb160-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> lon,</span>
<span id="cb160-18"><a href="hazards.html#cb160-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> lat,</span>
<span id="cb160-19"><a href="hazards.html#cb160-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> Benzene),</span>
<span id="cb160-20"><a href="hazards.html#cb160-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">&quot;#011f4b&quot;</span>,</span>
<span id="cb160-21"><a href="hazards.html#cb160-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="fl">0.45</span></span>
<span id="cb160-22"><a href="hazards.html#cb160-22" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.1%20map%20data-1.png" width="672" /></p>
<p>Using the <code>geoR</code> package we can also plot the following:</p>
<ul>
<li>the locations of the sampling sites</li>
<li>the concentrations of ozone in relation to the x and y coordinates</li>
<li>and a histogram of the concentrations indicating the distribution of concentrations together with an estimate of the density.</li>
</ul>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="hazards.html#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert data to utm coordinates</span></span>
<span id="cb161-2"><a href="hazards.html#cb161-2" aria-hidden="true" tabindex="-1"></a>benzene_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_geo,</span>
<span id="cb161-3"><a href="hazards.html#cb161-3" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb161-4"><a href="hazards.html#cb161-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb161-5"><a href="hazards.html#cb161-5" aria-hidden="true" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_utm)</span>
<span id="cb161-6"><a href="hazards.html#cb161-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(benzene_utm_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Benzene&quot;</span>, <span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>)</span>
<span id="cb161-7"><a href="hazards.html#cb161-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Save as geodata to generate the geodata plot</span></span>
<span id="cb161-8"><a href="hazards.html#cb161-8" aria-hidden="true" tabindex="-1"></a>benzene_geodata <span class="ot">&lt;-</span> <span class="fu">as.geodata</span>(benzene_utm_df,</span>
<span id="cb161-9"><a href="hazards.html#cb161-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">coords.col =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">data.col =</span> <span class="dv">1</span>)</span>
<span id="cb161-10"><a href="hazards.html#cb161-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(benzene_geodata)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.1%20geoR%20plot-1.png" width="672" /></p>
</div>
<div id="example-10.2-examining-the-log-concentrations-of-benzene-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Example 10.2: Examining the log concentrations of benzene in Montreal<a href="hazards.html#example-10.2-examining-the-log-concentrations-of-benzene-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="hazards.html#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram for the log of the benzene concentration</span></span>
<span id="cb162-2"><a href="hazards.html#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb162-3"><a href="hazards.html#cb162-3" aria-hidden="true" tabindex="-1"></a>log_histogram <span class="ot">&lt;-</span></span>
<span id="cb162-4"><a href="hazards.html#cb162-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hist</span>(<span class="fu">log</span>(benzene<span class="sc">$</span>Benzene), <span class="at">main =</span> <span class="st">&quot;&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;log(Benzene)&quot;</span>)</span>
<span id="cb162-5"><a href="hazards.html#cb162-5" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(<span class="fu">log</span>(benzene<span class="sc">$</span>Benzene), <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb162-6"><a href="hazards.html#cb162-6" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(<span class="fu">log</span>(benzene<span class="sc">$</span>Benzene))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.2%20plot%20hist%20and%20qqplot%20log-1.png" width="672" />
<!-- NOTE: I don't know how to generate the plot in Figure 9.4 --></p>
</div>
<div id="example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state" class="section level2 unnumbered hasAnchor">
<h2>Example 10.3: Mapping the locations of ozone monitoring sites in New York State<a href="hazards.html#example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="hazards.html#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the metadata giving the site coordinates </span></span>
<span id="cb163-2"><a href="hazards.html#cb163-2" aria-hidden="true" tabindex="-1"></a>ny_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/NY_metadata.txt&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb163-3"><a href="hazards.html#cb163-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Now copy ny_data into ny_data_sp and convert data to &quot;sp&quot; format</span></span>
<span id="cb163-4"><a href="hazards.html#cb163-4" aria-hidden="true" tabindex="-1"></a>ny_data_sp <span class="ot">&lt;-</span> ny_data</span>
<span id="cb163-5"><a href="hazards.html#cb163-5" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(ny_data_sp) <span class="ot">&lt;-</span> <span class="er">~</span> Longitude <span class="sc">+</span> Latitude</span>
<span id="cb163-6"><a href="hazards.html#cb163-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-7"><a href="hazards.html#cb163-7" aria-hidden="true" tabindex="-1"></a><span class="co"># assign a reference system to ny_data_sp</span></span>
<span id="cb163-8"><a href="hazards.html#cb163-8" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(ny_data_sp) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +ellps=WGS84&quot;</span>)</span>
<span id="cb163-9"><a href="hazards.html#cb163-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-10"><a href="hazards.html#cb163-10" aria-hidden="true" tabindex="-1"></a><span class="co"># We next specify a bounding box - a 2 x 2 matrix of corners of the geographic</span></span>
<span id="cb163-11"><a href="hazards.html#cb163-11" aria-hidden="true" tabindex="-1"></a><span class="co"># area. Then specify the range of locations within the box.</span></span>
<span id="cb163-12"><a href="hazards.html#cb163-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: location must bounding box format be in left -bottom -right -top</span></span>
<span id="cb163-13"><a href="hazards.html#cb163-13" aria-hidden="true" tabindex="-1"></a>latLongBox  <span class="ot">&lt;-</span>  <span class="fu">bbox</span>(ny_data_sp)</span>
<span id="cb163-14"><a href="hazards.html#cb163-14" aria-hidden="true" tabindex="-1"></a>location <span class="ot">&lt;-</span>  <span class="fu">c</span>(latLongBox [<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.2</span> ,</span>
<span id="cb163-15"><a href="hazards.html#cb163-15" aria-hidden="true" tabindex="-1"></a>               latLongBox [<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.2</span>,</span>
<span id="cb163-16"><a href="hazards.html#cb163-16" aria-hidden="true" tabindex="-1"></a>               latLongBox [<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.2</span> ,</span>
<span id="cb163-17"><a href="hazards.html#cb163-17" aria-hidden="true" tabindex="-1"></a>               latLongBox [<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.2</span>)</span>
<span id="cb163-18"><a href="hazards.html#cb163-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-19"><a href="hazards.html#cb163-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Now create the map with location dots</span></span>
<span id="cb163-20"><a href="hazards.html#cb163-20" aria-hidden="true" tabindex="-1"></a>NYmap <span class="ot">&lt;-</span> <span class="fu">get_stamenmap</span>(<span class="at">bbox =</span> location, <span class="at">zoom =</span> <span class="dv">8</span>)</span>
<span id="cb163-21"><a href="hazards.html#cb163-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-22"><a href="hazards.html#cb163-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggmap</span>(NYmap) <span class="sc">+</span> <span class="fu">geom_point</span>(</span>
<span id="cb163-23"><a href="hazards.html#cb163-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ny_data,</span>
<span id="cb163-24"><a href="hazards.html#cb163-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> Longitude , <span class="at">y =</span> Latitude),</span>
<span id="cb163-25"><a href="hazards.html#cb163-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb163-26"><a href="hazards.html#cb163-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">color =</span> <span class="st">&quot;darkred&quot;</span></span>
<span id="cb163-27"><a href="hazards.html#cb163-27" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.3%20plot%20ozone%20sites%20NY-1.png" width="672" /></p>
</div>
<div id="example-10.5-variogram" class="section level2 unnumbered hasAnchor">
<h2>Example 10.5: Variogram<a href="hazards.html#example-10.5-variogram" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="hazards.html#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gstat)</span>
<span id="cb164-2"><a href="hazards.html#cb164-2" aria-hidden="true" tabindex="-1"></a>benzene_utm_geo <span class="ot">&lt;-</span> benzene_utm_df</span>
<span id="cb164-3"><a href="hazards.html#cb164-3" aria-hidden="true" tabindex="-1"></a><span class="co"># get the coordinates in kms and turn into a Spatial object</span></span>
<span id="cb164-4"><a href="hazards.html#cb164-4" aria-hidden="true" tabindex="-1"></a>benzene_utm_geo[,<span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>)] <span class="ot">&lt;-</span> benzene_utm_geo[,<span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>)]<span class="sc">/</span><span class="dv">1000</span></span>
<span id="cb164-5"><a href="hazards.html#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_utm_geo) <span class="ot">&lt;-</span> <span class="er">~</span> X <span class="sc">+</span> Y</span>
<span id="cb164-6"><a href="hazards.html#cb164-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate variogram intercept only</span></span>
<span id="cb164-7"><a href="hazards.html#cb164-7" aria-hidden="true" tabindex="-1"></a>benzene_inter_vgm <span class="ot">&lt;-</span> <span class="fu">variogram</span>(<span class="fu">log</span>(Benzene) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb164-8"><a href="hazards.html#cb164-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> benzene_utm_geo,</span>
<span id="cb164-9"><a href="hazards.html#cb164-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">cutoff =</span> <span class="dv">20</span>,<span class="co"># cutoff distance</span></span>
<span id="cb164-10"><a href="hazards.html#cb164-10" aria-hidden="true" tabindex="-1"></a>                               <span class="at">width =</span> <span class="dv">20</span> <span class="sc">/</span> <span class="dv">10</span>) <span class="co"># bins width </span></span>
<span id="cb164-11"><a href="hazards.html#cb164-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-12"><a href="hazards.html#cb164-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-13"><a href="hazards.html#cb164-13" aria-hidden="true" tabindex="-1"></a>benzene_inter_vgm_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(benzene_inter_vgm,</span>
<span id="cb164-14"><a href="hazards.html#cb164-14" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">model =</span> <span class="fu">vgm</span>(<span class="fl">0.1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">15</span>, <span class="fl">0.02</span>))</span>
<span id="cb164-15"><a href="hazards.html#cb164-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-16"><a href="hazards.html#cb164-16" aria-hidden="true" tabindex="-1"></a>benzene_inter_vgm_fit</span></code></pre></div>
<pre><code>##   model      psill    range
## 1   Nug 0.01616521  0.00000
## 2   Exp 0.17301314 23.97153</code></pre>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="hazards.html#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate variogram using coordinates</span></span>
<span id="cb166-2"><a href="hazards.html#cb166-2" aria-hidden="true" tabindex="-1"></a>benzene_vgm <span class="ot">&lt;-</span> <span class="fu">variogram</span>(<span class="fu">log</span>(Benzene) <span class="sc">~</span> X <span class="sc">+</span> Y, </span>
<span id="cb166-3"><a href="hazards.html#cb166-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> benzene_utm_geo,</span>
<span id="cb166-4"><a href="hazards.html#cb166-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cutoff =</span> <span class="dv">20</span>, <span class="co"># cutoff distance</span></span>
<span id="cb166-5"><a href="hazards.html#cb166-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">width =</span> <span class="dv">20</span> <span class="sc">/</span> <span class="dv">10</span>) <span class="co"># bins width</span></span>
<span id="cb166-6"><a href="hazards.html#cb166-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-7"><a href="hazards.html#cb166-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-8"><a href="hazards.html#cb166-8" aria-hidden="true" tabindex="-1"></a>benzene_vgm_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(benzene_vgm, <span class="at">model =</span> <span class="fu">vgm</span>(<span class="fl">0.1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">3</span>, <span class="fl">0.02</span>))</span>
<span id="cb166-9"><a href="hazards.html#cb166-9" aria-hidden="true" tabindex="-1"></a>benzene_vgm_fit</span></code></pre></div>
<pre><code>##   model      psill    range
## 1   Nug 0.01638881 0.000000
## 2   Exp 0.05598753 7.365469</code></pre>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="hazards.html#cb168-1" aria-hidden="true" tabindex="-1"></a>plot_inter_variog <span class="ot">&lt;-</span> <span class="fu">plot</span>(benzene_inter_vgm, benzene_inter_vgm_fit, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb168-2"><a href="hazards.html#cb168-2" aria-hidden="true" tabindex="-1"></a>plot_coord_variog <span class="ot">&lt;-</span> <span class="fu">plot</span>(benzene_vgm, benzene_vgm_fit, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb168-3"><a href="hazards.html#cb168-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4"><a href="hazards.html#cb168-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_grid</span>(plot_inter_variog, plot_coord_variog, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.5%20plot%20variogram-1.png" width="672" /></p>
</div>
<div id="example-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Example 10.6 Basic spatial modelling and prediction of benzene in Montreal<a href="hazards.html#example-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="hazards.html#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate grid</span></span>
<span id="cb169-2"><a href="hazards.html#cb169-2" aria-hidden="true" tabindex="-1"></a>MtlPred <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="fu">seq</span> (<span class="dv">580</span>, <span class="dv">615</span> , <span class="fl">0.5</span>),</span>
<span id="cb169-3"><a href="hazards.html#cb169-3" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">seq</span> (<span class="dv">5020</span>, <span class="dv">5060</span> , <span class="fl">0.5</span>) )</span>
<span id="cb169-4"><a href="hazards.html#cb169-4" aria-hidden="true" tabindex="-1"></a><span class="co"># change names grid</span></span>
<span id="cb169-5"><a href="hazards.html#cb169-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(MtlPred)[ <span class="fu">names</span>(MtlPred)<span class="sc">==</span><span class="st">&quot;Var1&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;X&quot;</span></span>
<span id="cb169-6"><a href="hazards.html#cb169-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(MtlPred)[ <span class="fu">names</span>(MtlPred)<span class="sc">==</span><span class="st">&quot;Var2&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;Y&quot;</span></span>
<span id="cb169-7"><a href="hazards.html#cb169-7" aria-hidden="true" tabindex="-1"></a><span class="co"># make the grid a Spatial object</span></span>
<span id="cb169-8"><a href="hazards.html#cb169-8" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span> (MtlPred) <span class="ot">=</span> <span class="er">~</span> X <span class="sc">+</span> Y</span>
<span id="cb169-9"><a href="hazards.html#cb169-9" aria-hidden="true" tabindex="-1"></a><span class="fu">gridded</span>(MtlPred) <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb169-10"><a href="hazards.html#cb169-10" aria-hidden="true" tabindex="-1"></a><span class="co"># define the model based on the variogram fit from the previous example</span></span>
<span id="cb169-11"><a href="hazards.html#cb169-11" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">vgm</span> (<span class="fl">0.053</span> , <span class="st">&quot;Exp&quot;</span>, <span class="fl">5.54</span>, <span class="fl">0.0122</span>)</span>
<span id="cb169-12"><a href="hazards.html#cb169-12" aria-hidden="true" tabindex="-1"></a><span class="co"># use ordinary kriging to predict values in the grid</span></span>
<span id="cb169-13"><a href="hazards.html#cb169-13" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">krige</span>(<span class="fu">log</span>(Benzene) <span class="sc">~</span> X <span class="sc">+</span> Y, benzene_utm_geo , MtlPred , <span class="at">model =</span> mod )</span></code></pre></div>
<pre><code>## [using universal kriging]</code></pre>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="hazards.html#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the ordinary kriging predictions and their variance</span></span>
<span id="cb171-2"><a href="hazards.html#cb171-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-3"><a href="hazards.html#cb171-3" aria-hidden="true" tabindex="-1"></a>monitor_loc <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&#39;sp.points&#39;</span>, benzene_utm_geo, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">cex=</span>.<span class="dv">8</span>, <span class="at">col=</span><span class="st">&#39;cornsilk4&#39;</span>)</span>
<span id="cb171-4"><a href="hazards.html#cb171-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-5"><a href="hazards.html#cb171-5" aria-hidden="true" tabindex="-1"></a>krig_pred <span class="ot">&lt;-</span></span>
<span id="cb171-6"><a href="hazards.html#cb171-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb171-7"><a href="hazards.html#cb171-7" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&quot;var1.pred&quot;</span>],</span>
<span id="cb171-8"><a href="hazards.html#cb171-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Ordinary kriging predictions &quot;</span>,</span>
<span id="cb171-9"><a href="hazards.html#cb171-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb171-10"><a href="hazards.html#cb171-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb171-11"><a href="hazards.html#cb171-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.8</span>, <span class="fl">0.02</span>)</span>
<span id="cb171-12"><a href="hazards.html#cb171-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb171-13"><a href="hazards.html#cb171-13" aria-hidden="true" tabindex="-1"></a>krig_var <span class="ot">&lt;-</span></span>
<span id="cb171-14"><a href="hazards.html#cb171-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb171-15"><a href="hazards.html#cb171-15" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&quot;var1.var&quot;</span>],</span>
<span id="cb171-16"><a href="hazards.html#cb171-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Ordinary kriging variance &quot;</span>,</span>
<span id="cb171-17"><a href="hazards.html#cb171-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb171-18"><a href="hazards.html#cb171-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb171-19"><a href="hazards.html#cb171-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span>)</span>
<span id="cb171-20"><a href="hazards.html#cb171-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb171-21"><a href="hazards.html#cb171-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-22"><a href="hazards.html#cb171-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_grid</span>(krig_pred, krig_var, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.6%20kriging%20predictions-1.png" width="672" /></p>
</div>
<div id="example-10.9-spatial-modelling-of-benzene-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Example 10.9 Spatial modelling of Benzene in Montreal<a href="hazards.html#example-10.9-spatial-modelling-of-benzene-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="nimble-4" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="hazards.html#nimble-4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="hazards.html#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb172-2"><a href="hazards.html#cb172-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb172-3"><a href="hazards.html#cb172-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb172-4"><a href="hazards.html#cb172-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb172-5"><a href="hazards.html#cb172-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb172-6"><a href="hazards.html#cb172-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb172-7"><a href="hazards.html#cb172-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span></code></pre></div>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="hazards.html#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data on benzene concentration in Montreal</span></span>
<span id="cb173-2"><a href="hazards.html#cb173-2" aria-hidden="true" tabindex="-1"></a>benzene <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb173-3"><a href="hazards.html#cb173-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb173-4"><a href="hazards.html#cb173-4" aria-hidden="true" tabindex="-1"></a>benzene_geo <span class="ot">&lt;-</span> benzene</span>
<span id="cb173-5"><a href="hazards.html#cb173-5" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb173-6"><a href="hazards.html#cb173-6" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb173-7"><a href="hazards.html#cb173-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-8"><a href="hazards.html#cb173-8" aria-hidden="true" tabindex="-1"></a>benzene_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_geo,</span>
<span id="cb173-9"><a href="hazards.html#cb173-9" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb173-10"><a href="hazards.html#cb173-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb173-11"><a href="hazards.html#cb173-11" aria-hidden="true" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_utm)</span>
<span id="cb173-12"><a href="hazards.html#cb173-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Change coordinates to kilometers and observations to the log scale</span></span>
<span id="cb173-13"><a href="hazards.html#cb173-13" aria-hidden="true" tabindex="-1"></a>Mtl_benzene_sample <span class="ot">&lt;-</span></span>
<span id="cb173-14"><a href="hazards.html#cb173-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb173-15"><a href="hazards.html#cb173-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">log</span>(benzene_utm_df<span class="sc">$</span>Benzene),</span>
<span id="cb173-16"><a href="hazards.html#cb173-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">easting =</span>  benzene_utm_df<span class="sc">$</span>lon <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb173-17"><a href="hazards.html#cb173-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">northing =</span> benzene_utm_df<span class="sc">$</span>lat <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb173-18"><a href="hazards.html#cb173-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb173-19"><a href="hazards.html#cb173-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the distance matrix</span></span>
<span id="cb173-20"><a href="hazards.html#cb173-20" aria-hidden="true" tabindex="-1"></a>obsCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_benzene_sample[,<span class="fu">c</span>(<span class="st">&quot;easting&quot;</span>, <span class="st">&quot;northing&quot;</span>)]))</span>
<span id="cb173-21"><a href="hazards.html#cb173-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-22"><a href="hazards.html#cb173-22" aria-hidden="true" tabindex="-1"></a>obsDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(obsCoords)</span></code></pre></div>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="hazards.html#cb174-1" aria-hidden="true" tabindex="-1"></a>Example10_9Code <span class="ot">&lt;-</span>  <span class="fu">nimbleCode</span> ({</span>
<span id="cb174-2"><a href="hazards.html#cb174-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Covariance matrix spatial effect</span></span>
<span id="cb174-3"><a href="hazards.html#cb174-3" aria-hidden="true" tabindex="-1"></a>  Sigma[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n] <span class="ot">&lt;-</span></span>
<span id="cb174-4"><a href="hazards.html#cb174-4" aria-hidden="true" tabindex="-1"></a>    sigma_sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>distMatrix[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n] <span class="sc">/</span> phi) <span class="sc">+</span> tau_sq <span class="sc">*</span> <span class="fu">identityMatrix</span>(<span class="at">d =</span> n)</span>
<span id="cb174-5"><a href="hazards.html#cb174-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-6"><a href="hazards.html#cb174-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (site <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb174-7"><a href="hazards.html#cb174-7" aria-hidden="true" tabindex="-1"></a>    mean.site[site] <span class="ot">&lt;-</span></span>
<span id="cb174-8"><a href="hazards.html#cb174-8" aria-hidden="true" tabindex="-1"></a>      beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> easting[site] <span class="sc">+</span> beta2 <span class="sc">*</span> northing[site]</span>
<span id="cb174-9"><a href="hazards.html#cb174-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb174-10"><a href="hazards.html#cb174-10" aria-hidden="true" tabindex="-1"></a>  y[<span class="dv">1</span><span class="sc">:</span>n]  <span class="sc">~</span>  <span class="fu">dmnorm</span>(mean.site[<span class="dv">1</span><span class="sc">:</span>n], <span class="at">cov =</span> Sigma[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n])</span>
<span id="cb174-11"><a href="hazards.html#cb174-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set up the priors for the spatial model</span></span>
<span id="cb174-12"><a href="hazards.html#cb174-12" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb174-13"><a href="hazards.html#cb174-13" aria-hidden="true" tabindex="-1"></a>  sigma_sq <span class="ot">&lt;-</span> sigma<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb174-14"><a href="hazards.html#cb174-14" aria-hidden="true" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb174-15"><a href="hazards.html#cb174-15" aria-hidden="true" tabindex="-1"></a>  tau_sq <span class="ot">&lt;-</span> tau<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb174-16"><a href="hazards.html#cb174-16" aria-hidden="true" tabindex="-1"></a>  phi_inv <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="at">shape =</span>  <span class="dv">5</span>, <span class="at">rate =</span> <span class="dv">5</span>)</span>
<span id="cb174-17"><a href="hazards.html#cb174-17" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> phi_inv</span>
<span id="cb174-18"><a href="hazards.html#cb174-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prior for the coefficients</span></span>
<span id="cb174-19"><a href="hazards.html#cb174-19" aria-hidden="true" tabindex="-1"></a>  beta0 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb174-20"><a href="hazards.html#cb174-20" aria-hidden="true" tabindex="-1"></a>  beta1 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb174-21"><a href="hazards.html#cb174-21" aria-hidden="true" tabindex="-1"></a>  beta2 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb174-22"><a href="hazards.html#cb174-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb174-23"><a href="hazards.html#cb174-23" aria-hidden="true" tabindex="-1"></a>}) </span>
<span id="cb174-24"><a href="hazards.html#cb174-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-25"><a href="hazards.html#cb174-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the constants, data, parameters and initial values</span></span>
<span id="cb174-26"><a href="hazards.html#cb174-26" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb174-27"><a href="hazards.html#cb174-27" aria-hidden="true" tabindex="-1"></a>easting_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>easting))</span>
<span id="cb174-28"><a href="hazards.html#cb174-28" aria-hidden="true" tabindex="-1"></a>northing_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>northing))</span>
<span id="cb174-29"><a href="hazards.html#cb174-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-30"><a href="hazards.html#cb174-30" aria-hidden="true" tabindex="-1"></a>constants <span class="ot">&lt;-</span></span>
<span id="cb174-31"><a href="hazards.html#cb174-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">n =</span> <span class="fu">nrow</span>(Mtl_benzene_sample))</span>
<span id="cb174-32"><a href="hazards.html#cb174-32" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span></span>
<span id="cb174-33"><a href="hazards.html#cb174-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">y =</span> Mtl_benzene_sample<span class="sc">$</span>y,</span>
<span id="cb174-34"><a href="hazards.html#cb174-34" aria-hidden="true" tabindex="-1"></a>       <span class="at">easting =</span> easting_scaled,</span>
<span id="cb174-35"><a href="hazards.html#cb174-35" aria-hidden="true" tabindex="-1"></a>       <span class="at">northing =</span> northing_scaled,</span>
<span id="cb174-36"><a href="hazards.html#cb174-36" aria-hidden="true" tabindex="-1"></a>       <span class="at">distMatrix =</span> obsDist)</span>
<span id="cb174-37"><a href="hazards.html#cb174-37" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="st">&quot;beta0&quot;</span>,  <span class="st">&quot;beta1&quot;</span>,<span class="st">&quot;beta2&quot;</span>, <span class="st">&quot;phi&quot;</span>,  <span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>)</span>
<span id="cb174-38"><a href="hazards.html#cb174-38" aria-hidden="true" tabindex="-1"></a>inits <span class="ot">&lt;-</span> <span class="fu">list</span>( <span class="at">sigma =</span> <span class="fl">0.1</span>, <span class="at">phi_inv =</span> <span class="dv">6</span><span class="sc">/</span><span class="fu">max</span>(obsDist), <span class="at">tau =</span> <span class="fl">0.1</span>)</span>
<span id="cb174-39"><a href="hazards.html#cb174-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Run model in nimble</span></span>
<span id="cb174-40"><a href="hazards.html#cb174-40" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb174-41"><a href="hazards.html#cb174-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-42"><a href="hazards.html#cb174-42" aria-hidden="true" tabindex="-1"></a>mcmc.out <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb174-43"><a href="hazards.html#cb174-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">code =</span> Example10_9Code,</span>
<span id="cb174-44"><a href="hazards.html#cb174-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">constants =</span> constants,</span>
<span id="cb174-45"><a href="hazards.html#cb174-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb174-46"><a href="hazards.html#cb174-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb174-47"><a href="hazards.html#cb174-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">monitors =</span> params,</span>
<span id="cb174-48"><a href="hazards.html#cb174-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> <span class="dv">40000</span>,</span>
<span id="cb174-49"><a href="hazards.html#cb174-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> <span class="dv">20000</span>,</span>
<span id="cb174-50"><a href="hazards.html#cb174-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">14</span>,</span>
<span id="cb174-51"><a href="hazards.html#cb174-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb174-52"><a href="hazards.html#cb174-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb174-53"><a href="hazards.html#cb174-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb174-54"><a href="hazards.html#cb174-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb174-55"><a href="hazards.html#cb174-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb174-56"><a href="hazards.html#cb174-56" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb174-57"><a href="hazards.html#cb174-57" aria-hidden="true" tabindex="-1"></a>run_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb174-58"><a href="hazards.html#cb174-58" aria-hidden="true" tabindex="-1"></a>run_time</span></code></pre></div>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="hazards.html#cb175-1" aria-hidden="true" tabindex="-1"></a>mcmc.out<span class="sc">$</span>WAIC</span></code></pre></div>
<pre><code>## nimbleList object of type waicList
## Field &quot;WAIC&quot;:
## [1] -32.37684
## Field &quot;lppd&quot;:
## [1] 19.03084
## Field &quot;pWAIC&quot;:
## [1] 2.842421</code></pre>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="hazards.html#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(mcmc.out<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 985.2176</code></pre>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="hazards.html#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta0&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="hazards.html#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta1&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta1&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="hazards.html#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta2&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta2&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-3.png" width="672" /></p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="hazards.html#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;sigma&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;sigma&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-4.png" width="672" /></p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="hazards.html#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;tau&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-5.png" width="672" /></p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="hazards.html#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;phi&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-6.png" width="672" /></p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="hazards.html#cb185-1" aria-hidden="true" tabindex="-1"></a>mcmc.out<span class="sc">$</span>summary<span class="sc">$</span>all.chains[<span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta1&quot;</span>, <span class="st">&quot;beta2&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;phi&quot;</span>), ]</span></code></pre></div>
<pre><code>##                 Mean     Median     St.Dev.     95%CI_low  95%CI_upp
## beta0    0.143589662 0.15187505 0.081381727 -4.284934e-02 0.27866526
## beta1    0.051028164 0.04806334 0.060619017 -6.338295e-02 0.17328888
## beta2    0.077775628 0.08250220 0.068519017 -7.013084e-02 0.20323633
## sigma_sq 0.056087887 0.05202343 0.022624353  2.770244e-02 0.11140808
## tau_sq   0.009128758 0.00841011 0.006709036  5.744089e-05 0.02380432
## phi      3.697646345 3.09115863 2.228726265  1.463844e+00 9.40053808</code></pre>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="hazards.html#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain coordinates for predictions </span></span>
<span id="cb187-2"><a href="hazards.html#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="co"># note that we are using the same coordinates as the one generated for </span></span>
<span id="cb187-3"><a href="hazards.html#cb187-3" aria-hidden="true" tabindex="-1"></a><span class="co"># the kriging example</span></span>
<span id="cb187-4"><a href="hazards.html#cb187-4" aria-hidden="true" tabindex="-1"></a>Mtl_centroids_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(MtlPred)</span>
<span id="cb187-5"><a href="hazards.html#cb187-5" aria-hidden="true" tabindex="-1"></a>predCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_centroids_df))</span></code></pre></div>
<p>Following the posterior predictive distribution we have to define a model for the predictions.</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="hazards.html#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract samples from nimble model</span></span>
<span id="cb188-2"><a href="hazards.html#cb188-2" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>samples <span class="sc">|&gt;</span> <span class="fu">tidy_draws</span>()</span>
<span id="cb188-3"><a href="hazards.html#cb188-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-4"><a href="hazards.html#cb188-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract posterior samples for each of the parameters of interest</span></span>
<span id="cb188-5"><a href="hazards.html#cb188-5" aria-hidden="true" tabindex="-1"></a>post_beta0 <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>beta0</span>
<span id="cb188-6"><a href="hazards.html#cb188-6" aria-hidden="true" tabindex="-1"></a>post_beta1 <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>beta1</span>
<span id="cb188-7"><a href="hazards.html#cb188-7" aria-hidden="true" tabindex="-1"></a>post_beta2 <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>beta2</span>
<span id="cb188-8"><a href="hazards.html#cb188-8" aria-hidden="true" tabindex="-1"></a>post_sigmasq <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>sigma_sq</span>
<span id="cb188-9"><a href="hazards.html#cb188-9" aria-hidden="true" tabindex="-1"></a>post_phi <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>phi</span>
<span id="cb188-10"><a href="hazards.html#cb188-10" aria-hidden="true" tabindex="-1"></a>post_tausq <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>tau_sq</span>
<span id="cb188-11"><a href="hazards.html#cb188-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-12"><a href="hazards.html#cb188-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale coordinates for predictive locations</span></span>
<span id="cb188-13"><a href="hazards.html#cb188-13" aria-hidden="true" tabindex="-1"></a>predCoords_sc <span class="ot">&lt;-</span> predCoords </span>
<span id="cb188-14"><a href="hazards.html#cb188-14" aria-hidden="true" tabindex="-1"></a>predCoords_sc[,<span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb188-15"><a href="hazards.html#cb188-15" aria-hidden="true" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>easting)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>easting)</span>
<span id="cb188-16"><a href="hazards.html#cb188-16" aria-hidden="true" tabindex="-1"></a>predCoords_sc[,<span class="dv">2</span>] <span class="ot">&lt;-</span> </span>
<span id="cb188-17"><a href="hazards.html#cb188-17" aria-hidden="true" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>northing)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>northing)</span>
<span id="cb188-18"><a href="hazards.html#cb188-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb188-19"><a href="hazards.html#cb188-19" aria-hidden="true" tabindex="-1"></a>n0 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(predCoords_sc)</span>
<span id="cb188-20"><a href="hazards.html#cb188-20" aria-hidden="true" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="fu">length</span>(post_tausq)</span>
<span id="cb188-21"><a href="hazards.html#cb188-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-22"><a href="hazards.html#cb188-22" aria-hidden="true" tabindex="-1"></a>obsMu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, easting_scaled, northing_scaled) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(post_beta0, post_beta1, post_beta2))</span>
<span id="cb188-23"><a href="hazards.html#cb188-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-24"><a href="hazards.html#cb188-24" aria-hidden="true" tabindex="-1"></a>predMu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, <span class="fu">as.matrix</span>(predCoords_sc)) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(post_beta0, post_beta1, post_beta2))</span>
<span id="cb188-25"><a href="hazards.html#cb188-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-26"><a href="hazards.html#cb188-26" aria-hidden="true" tabindex="-1"></a>pred2obsDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(predCoords, obsCoords)</span>
<span id="cb188-27"><a href="hazards.html#cb188-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-28"><a href="hazards.html#cb188-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-29"><a href="hazards.html#cb188-29" aria-hidden="true" tabindex="-1"></a>Rcpp<span class="sc">::</span><span class="fu">sourceCpp</span>(<span class="st">&quot;functions/prediction_marginal_gp12.cpp&quot;</span>)</span>
<span id="cb188-30"><a href="hazards.html#cb188-30" aria-hidden="true" tabindex="-1"></a><span class="fu">args</span>(prediction_marginal_gp12)</span></code></pre></div>
<pre><code>## function (y, obsMu, predMu, obsDistMat, pred2ObsDistMat, sigmasq, 
##     phi, tausq, iterprint) 
## NULL</code></pre>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="hazards.html#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb190-2"><a href="hazards.html#cb190-2" aria-hidden="true" tabindex="-1"></a>  pred_samples <span class="ot">&lt;-</span> <span class="fu">prediction_marginal_gp12</span>(</span>
<span id="cb190-3"><a href="hazards.html#cb190-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> Mtl_benzene_sample<span class="sc">$</span>y,</span>
<span id="cb190-4"><a href="hazards.html#cb190-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">obsMu =</span> obsMu,</span>
<span id="cb190-5"><a href="hazards.html#cb190-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">predMu =</span> predMu,</span>
<span id="cb190-6"><a href="hazards.html#cb190-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">obsDistMat =</span> obsDist,</span>
<span id="cb190-7"><a href="hazards.html#cb190-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred2ObsDistMat =</span> pred2obsDist,</span>
<span id="cb190-8"><a href="hazards.html#cb190-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigmasq =</span> post_sigmasq,</span>
<span id="cb190-9"><a href="hazards.html#cb190-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> post_phi,</span>
<span id="cb190-10"><a href="hazards.html#cb190-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">tausq =</span> post_tausq,</span>
<span id="cb190-11"><a href="hazards.html#cb190-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">iterprint =</span> <span class="dv">1000</span></span>
<span id="cb190-12"><a href="hazards.html#cb190-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb190-13"><a href="hazards.html#cb190-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Prediction upto the 0th MCMC sample is completed
## Prediction upto the 1000th MCMC sample is completed
## Prediction upto the 2000th MCMC sample is completed</code></pre>
<pre><code>##    user  system elapsed 
##  155.79    0.56  299.03</code></pre>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="hazards.html#cb193-1" aria-hidden="true" tabindex="-1"></a>predict_res_dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb193-2"><a href="hazards.html#cb193-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">xcoord =</span> predCoords[, <span class="dv">1</span>],</span>
<span id="cb193-3"><a href="hazards.html#cb193-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">ycoord =</span> predCoords[, <span class="dv">2</span>],</span>
<span id="cb193-4"><a href="hazards.html#cb193-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">post.mean =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, mean),</span>
<span id="cb193-5"><a href="hazards.html#cb193-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">post.var =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, var),</span>
<span id="cb193-6"><a href="hazards.html#cb193-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">q2.5 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb193-7"><a href="hazards.html#cb193-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.025</span>)),</span>
<span id="cb193-8"><a href="hazards.html#cb193-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">q50 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb193-9"><a href="hazards.html#cb193-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.5</span>)),</span>
<span id="cb193-10"><a href="hazards.html#cb193-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">q97.5 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb193-11"><a href="hazards.html#cb193-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.975</span>))</span>
<span id="cb193-12"><a href="hazards.html#cb193-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="hazards.html#cb194-1" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>nimble.pred <span class="ot">&lt;-</span> predict_res_dt<span class="sc">$</span>post.mean</span>
<span id="cb194-2"><a href="hazards.html#cb194-2" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>nimble.var <span class="ot">&lt;-</span> predict_res_dt<span class="sc">$</span>post.var</span>
<span id="cb194-3"><a href="hazards.html#cb194-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-4"><a href="hazards.html#cb194-4" aria-hidden="true" tabindex="-1"></a>nimble_pred <span class="ot">&lt;-</span></span>
<span id="cb194-5"><a href="hazards.html#cb194-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb194-6"><a href="hazards.html#cb194-6" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&quot;nimble.pred&quot;</span>],</span>
<span id="cb194-7"><a href="hazards.html#cb194-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Nimble spatial predictions &quot;</span>,</span>
<span id="cb194-8"><a href="hazards.html#cb194-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb194-9"><a href="hazards.html#cb194-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb194-10"><a href="hazards.html#cb194-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.8</span>, <span class="fl">0.02</span>)</span>
<span id="cb194-11"><a href="hazards.html#cb194-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb194-12"><a href="hazards.html#cb194-12" aria-hidden="true" tabindex="-1"></a>nimble_var <span class="ot">&lt;-</span></span>
<span id="cb194-13"><a href="hazards.html#cb194-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb194-14"><a href="hazards.html#cb194-14" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&quot;nimble.var&quot;</span>],</span>
<span id="cb194-15"><a href="hazards.html#cb194-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Nimble predictions variance &quot;</span>,</span>
<span id="cb194-16"><a href="hazards.html#cb194-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb194-17"><a href="hazards.html#cb194-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb194-18"><a href="hazards.html#cb194-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span>)</span>
<span id="cb194-19"><a href="hazards.html#cb194-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-20"><a href="hazards.html#cb194-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb194-21"><a href="hazards.html#cb194-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-22"><a href="hazards.html#cb194-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_grid</span>(nimble_pred, nimble_var, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20plot%20predictions-1.png" width="672" /></p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="hazards.html#cb195-1" aria-hidden="true" tabindex="-1"></a>predict_res_dt<span class="sc">$</span>post.mean[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>## [1] -0.2748897 -0.2610339 -0.2629892 -0.2617884 -0.2446157</code></pre>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="hazards.html#cb197-1" aria-hidden="true" tabindex="-1"></a>predict_res_dt<span class="sc">$</span>post.var[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>## [1] 0.08898525 0.09035693 0.08581058 0.08874131 0.08585555</code></pre>
</div>
<div id="stan-4" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="hazards.html#stan-4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="hazards.html#cb199-1" aria-hidden="true" tabindex="-1"></a>benzene_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb199-2"><a href="hazards.html#cb199-2" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb199-3"><a href="hazards.html#cb199-3" aria-hidden="true" tabindex="-1"></a>benzene_data_geo <span class="ot">&lt;-</span> benzene_data</span>
<span id="cb199-4"><a href="hazards.html#cb199-4" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_data_geo) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb199-5"><a href="hazards.html#cb199-5" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_data_geo) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb199-6"><a href="hazards.html#cb199-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-7"><a href="hazards.html#cb199-7" aria-hidden="true" tabindex="-1"></a>benzene_data_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_data_geo,</span>
<span id="cb199-8"><a href="hazards.html#cb199-8" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb199-9"><a href="hazards.html#cb199-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb199-10"><a href="hazards.html#cb199-10" aria-hidden="true" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_data_utm)</span>
<span id="cb199-11"><a href="hazards.html#cb199-11" aria-hidden="true" tabindex="-1"></a><span class="co"># change the observed values to the log scale and the coordinates to km&#39;s</span></span>
<span id="cb199-12"><a href="hazards.html#cb199-12" aria-hidden="true" tabindex="-1"></a>Mtl_benzene_sample <span class="ot">&lt;-</span></span>
<span id="cb199-13"><a href="hazards.html#cb199-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb199-14"><a href="hazards.html#cb199-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">log</span>(benzene_utm_df<span class="sc">$</span>Benzene),</span>
<span id="cb199-15"><a href="hazards.html#cb199-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">easting =</span>  benzene_utm_df<span class="sc">$</span>lon <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb199-16"><a href="hazards.html#cb199-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">northing =</span> benzene_utm_df<span class="sc">$</span>lat <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb199-17"><a href="hazards.html#cb199-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb199-18"><a href="hazards.html#cb199-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the distance matrix</span></span>
<span id="cb199-19"><a href="hazards.html#cb199-19" aria-hidden="true" tabindex="-1"></a>obsCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_benzene_sample[,<span class="fu">c</span>(<span class="st">&quot;easting&quot;</span>, <span class="st">&quot;northing&quot;</span>)]))</span>
<span id="cb199-20"><a href="hazards.html#cb199-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-21"><a href="hazards.html#cb199-21" aria-hidden="true" tabindex="-1"></a>obsDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(obsCoords)</span></code></pre></div>
<pre><code>
data {
  int&lt;lower=1&gt; N;
  int&lt;lower=0&gt; p;
  vector[N] y;
  matrix[N,N] dist_matrix;
  matrix[N,p] X; 
}

parameters {
  real&lt;lower=0&gt; phi;
  real&lt;lower=0&gt; tau;
  real&lt;lower=0&gt; sigma;
  vector[p] beta;
  real beta0;

}
transformed parameters{
  real&lt;lower=0&gt; sigma_sq = square(sigma);
  real&lt;lower=0&gt; tau_sq = square(tau);
}
model {
  vector[N] mu;
  matrix[N, N] L;
  matrix[N, N] Sigma;
  
  Sigma = sigma_sq * exp(-dist_matrix/ phi) + tau_sq *diag_matrix(rep_vector(1, N));


  for(i in 1:N) {
    mu[i] = beta0 + X[i,]*beta;
  }
  
  L = cholesky_decompose(Sigma);
  
  beta0 ~ normal(0,10);
  beta ~ normal(0,10);
  phi ~ inv_gamma(5, 5);
  tau ~ cauchy(0,1);
  sigma ~ cauchy(0,1);

  y ~ multi_normal_cholesky(mu, L);
}</code></pre>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="hazards.html#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb201-2"><a href="hazards.html#cb201-2" aria-hidden="true" tabindex="-1"></a>easting_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>easting))</span>
<span id="cb201-3"><a href="hazards.html#cb201-3" aria-hidden="true" tabindex="-1"></a>northing_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>northing))</span>
<span id="cb201-4"><a href="hazards.html#cb201-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-5"><a href="hazards.html#cb201-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(benzene_utm_df)</span>
<span id="cb201-6"><a href="hazards.html#cb201-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Change coordinates to kilometers</span></span>
<span id="cb201-7"><a href="hazards.html#cb201-7" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">easting =</span> easting_scaled,</span>
<span id="cb201-8"><a href="hazards.html#cb201-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">northing =</span> northing_scaled) </span>
<span id="cb201-9"><a href="hazards.html#cb201-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-10"><a href="hazards.html#cb201-10" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb201-11"><a href="hazards.html#cb201-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb201-12"><a href="hazards.html#cb201-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">2</span>,</span>
<span id="cb201-13"><a href="hazards.html#cb201-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span>   <span class="fu">log</span>(benzene_utm_df<span class="sc">$</span>Benzene),</span>
<span id="cb201-14"><a href="hazards.html#cb201-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">dist_matrix =</span> obsDist,</span>
<span id="cb201-15"><a href="hazards.html#cb201-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> <span class="fu">as.matrix</span>(X)</span>
<span id="cb201-16"><a href="hazards.html#cb201-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb201-17"><a href="hazards.html#cb201-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-18"><a href="hazards.html#cb201-18" aria-hidden="true" tabindex="-1"></a>Example10_9Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb201-19"><a href="hazards.html#cb201-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example10_9.stan&quot;</span>,</span>
<span id="cb201-20"><a href="hazards.html#cb201-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb201-21"><a href="hazards.html#cb201-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">10000</span>,</span>
<span id="cb201-22"><a href="hazards.html#cb201-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">20000</span>,</span>
<span id="cb201-23"><a href="hazards.html#cb201-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb201-24"><a href="hazards.html#cb201-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb201-25"><a href="hazards.html#cb201-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;phi&quot;</span>),</span>
<span id="cb201-26"><a href="hazards.html#cb201-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb201-27"><a href="hazards.html#cb201-27" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="hazards.html#cb202-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example10_9Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;phi&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20stan%20exp%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="hazards.html#cb203-1" aria-hidden="true" tabindex="-1"></a>summary_exp_stan <span class="ot">&lt;-</span></span>
<span id="cb203-2"><a href="hazards.html#cb203-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb203-3"><a href="hazards.html#cb203-3" aria-hidden="true" tabindex="-1"></a>    Example10_9Stan,</span>
<span id="cb203-4"><a href="hazards.html#cb203-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>,  <span class="st">&quot;phi&quot;</span>),</span>
<span id="cb203-5"><a href="hazards.html#cb203-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb203-6"><a href="hazards.html#cb203-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb203-7"><a href="hazards.html#cb203-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-8"><a href="hazards.html#cb203-8" aria-hidden="true" tabindex="-1"></a>summary_exp_stan<span class="sc">$</span>summary</span></code></pre></div>
<pre><code>##                 mean      se_mean         sd          2.5%      97.5%
## beta0    0.146457291 0.0018562983 0.07997902 -3.023587e-02 0.28132110
## beta[1]  0.047496231 0.0013261678 0.05957233 -6.496270e-02 0.17626742
## beta[2]  0.080290249 0.0014607308 0.06744570 -5.992676e-02 0.19665262
## sigma_sq 0.055772229 0.0004686651 0.02109726  2.831741e-02 0.10389363
## tau_sq   0.009142795 0.0001523047 0.00674511  6.533636e-05 0.02383244
## phi      3.666760755 0.0513903964 2.24757184  1.501948e+00 9.25712051
##             n_eff      Rhat
## beta0    1856.336 0.9994055
## beta[1]  2017.866 0.9991897
## beta[2]  2131.906 0.9993034
## sigma_sq 2026.408 1.0000657
## tau_sq   1961.335 1.0016241
## phi      1912.772 0.9994019</code></pre>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="hazards.html#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain coordinates for predictions </span></span>
<span id="cb205-2"><a href="hazards.html#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="co"># note that we are using the same coordinates as the one generated for </span></span>
<span id="cb205-3"><a href="hazards.html#cb205-3" aria-hidden="true" tabindex="-1"></a><span class="co"># the kriging example</span></span>
<span id="cb205-4"><a href="hazards.html#cb205-4" aria-hidden="true" tabindex="-1"></a>Mtl_centroids_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(MtlPred)</span>
<span id="cb205-5"><a href="hazards.html#cb205-5" aria-hidden="true" tabindex="-1"></a>predCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_centroids_df))</span></code></pre></div>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="hazards.html#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract samples from nimble model</span></span>
<span id="cb206-2"><a href="hazards.html#cb206-2" aria-hidden="true" tabindex="-1"></a>stan_post_samples <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">extract</span>(Example10_9Stan,</span>
<span id="cb206-3"><a href="hazards.html#cb206-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>))</span>
<span id="cb206-4"><a href="hazards.html#cb206-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-5"><a href="hazards.html#cb206-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract posterior samples for each of the parameters of interest</span></span>
<span id="cb206-6"><a href="hazards.html#cb206-6" aria-hidden="true" tabindex="-1"></a>post_beta0 <span class="ot">&lt;-</span> stan_post_samples<span class="sc">$</span>beta0</span>
<span id="cb206-7"><a href="hazards.html#cb206-7" aria-hidden="true" tabindex="-1"></a>post_beta <span class="ot">&lt;-</span> stan_post_samples<span class="sc">$</span>beta</span>
<span id="cb206-8"><a href="hazards.html#cb206-8" aria-hidden="true" tabindex="-1"></a><span class="co"># post_beta2 &lt;- stan_post_samples$beta2</span></span>
<span id="cb206-9"><a href="hazards.html#cb206-9" aria-hidden="true" tabindex="-1"></a>post_sigmasq <span class="ot">&lt;-</span> stan_post_samples<span class="sc">$</span>sigma_sq</span>
<span id="cb206-10"><a href="hazards.html#cb206-10" aria-hidden="true" tabindex="-1"></a>post_phi <span class="ot">&lt;-</span> stan_post_samples<span class="sc">$</span>phi</span>
<span id="cb206-11"><a href="hazards.html#cb206-11" aria-hidden="true" tabindex="-1"></a>post_tausq <span class="ot">&lt;-</span> stan_post_samples<span class="sc">$</span>tau_sq</span>
<span id="cb206-12"><a href="hazards.html#cb206-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-13"><a href="hazards.html#cb206-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale coordinates for predictive locations</span></span>
<span id="cb206-14"><a href="hazards.html#cb206-14" aria-hidden="true" tabindex="-1"></a>predCoords_sc <span class="ot">&lt;-</span> predCoords </span>
<span id="cb206-15"><a href="hazards.html#cb206-15" aria-hidden="true" tabindex="-1"></a>predCoords_sc[,<span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb206-16"><a href="hazards.html#cb206-16" aria-hidden="true" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>easting)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>easting)</span>
<span id="cb206-17"><a href="hazards.html#cb206-17" aria-hidden="true" tabindex="-1"></a>predCoords_sc[,<span class="dv">2</span>] <span class="ot">&lt;-</span> </span>
<span id="cb206-18"><a href="hazards.html#cb206-18" aria-hidden="true" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>northing)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>northing)</span>
<span id="cb206-19"><a href="hazards.html#cb206-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb206-20"><a href="hazards.html#cb206-20" aria-hidden="true" tabindex="-1"></a>n0 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(predCoords_sc)</span>
<span id="cb206-21"><a href="hazards.html#cb206-21" aria-hidden="true" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="fu">length</span>(post_tausq)</span>
<span id="cb206-22"><a href="hazards.html#cb206-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-23"><a href="hazards.html#cb206-23" aria-hidden="true" tabindex="-1"></a>obsMu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, easting_scaled, northing_scaled) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(post_beta0, post_beta))</span>
<span id="cb206-24"><a href="hazards.html#cb206-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-25"><a href="hazards.html#cb206-25" aria-hidden="true" tabindex="-1"></a>predMu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, <span class="fu">as.matrix</span>(predCoords_sc)) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(post_beta0, post_beta))</span>
<span id="cb206-26"><a href="hazards.html#cb206-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-27"><a href="hazards.html#cb206-27" aria-hidden="true" tabindex="-1"></a>pred2obsDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(predCoords, obsCoords)</span>
<span id="cb206-28"><a href="hazards.html#cb206-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-29"><a href="hazards.html#cb206-29" aria-hidden="true" tabindex="-1"></a>Rcpp<span class="sc">::</span><span class="fu">sourceCpp</span>(<span class="st">&quot;functions/prediction_marginal_gp12.cpp&quot;</span>)</span>
<span id="cb206-30"><a href="hazards.html#cb206-30" aria-hidden="true" tabindex="-1"></a><span class="fu">args</span>(prediction_marginal_gp12)</span></code></pre></div>
<pre><code>## function (y, obsMu, predMu, obsDistMat, pred2ObsDistMat, sigmasq, 
##     phi, tausq, iterprint) 
## NULL</code></pre>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="hazards.html#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb208-2"><a href="hazards.html#cb208-2" aria-hidden="true" tabindex="-1"></a>  pred_samples <span class="ot">&lt;-</span> <span class="fu">prediction_marginal_gp12</span>(</span>
<span id="cb208-3"><a href="hazards.html#cb208-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> Mtl_benzene_sample<span class="sc">$</span>y,</span>
<span id="cb208-4"><a href="hazards.html#cb208-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">obsMu =</span> obsMu,</span>
<span id="cb208-5"><a href="hazards.html#cb208-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">predMu =</span> predMu,</span>
<span id="cb208-6"><a href="hazards.html#cb208-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">obsDistMat =</span> obsDist,</span>
<span id="cb208-7"><a href="hazards.html#cb208-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred2ObsDistMat =</span> pred2obsDist,</span>
<span id="cb208-8"><a href="hazards.html#cb208-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigmasq =</span> post_sigmasq,</span>
<span id="cb208-9"><a href="hazards.html#cb208-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> post_phi,</span>
<span id="cb208-10"><a href="hazards.html#cb208-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">tausq =</span> post_tausq,</span>
<span id="cb208-11"><a href="hazards.html#cb208-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">iterprint =</span> <span class="dv">1000</span></span>
<span id="cb208-12"><a href="hazards.html#cb208-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb208-13"><a href="hazards.html#cb208-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Prediction upto the 0th MCMC sample is completed
## Prediction upto the 1000th MCMC sample is completed</code></pre>
<pre><code>##    user  system elapsed 
##   74.33    0.06  124.85</code></pre>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="hazards.html#cb211-1" aria-hidden="true" tabindex="-1"></a>predict_res_dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb211-2"><a href="hazards.html#cb211-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">xcoord =</span> predCoords[, <span class="dv">1</span>],</span>
<span id="cb211-3"><a href="hazards.html#cb211-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">ycoord =</span> predCoords[, <span class="dv">2</span>],</span>
<span id="cb211-4"><a href="hazards.html#cb211-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">post.mean =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, mean),</span>
<span id="cb211-5"><a href="hazards.html#cb211-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">post.var =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, var),</span>
<span id="cb211-6"><a href="hazards.html#cb211-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">q2.5 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb211-7"><a href="hazards.html#cb211-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.025</span>)),</span>
<span id="cb211-8"><a href="hazards.html#cb211-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">q50 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb211-9"><a href="hazards.html#cb211-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.5</span>)),</span>
<span id="cb211-10"><a href="hazards.html#cb211-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">q97.5 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb211-11"><a href="hazards.html#cb211-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.975</span>))</span>
<span id="cb211-12"><a href="hazards.html#cb211-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="hazards.html#cb212-1" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>stan.pred <span class="ot">&lt;-</span> predict_res_dt<span class="sc">$</span>post.mean</span>
<span id="cb212-2"><a href="hazards.html#cb212-2" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>stan.var <span class="ot">&lt;-</span> predict_res_dt<span class="sc">$</span>post.var</span>
<span id="cb212-3"><a href="hazards.html#cb212-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-4"><a href="hazards.html#cb212-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-5"><a href="hazards.html#cb212-5" aria-hidden="true" tabindex="-1"></a>stan_pred <span class="ot">&lt;-</span></span>
<span id="cb212-6"><a href="hazards.html#cb212-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb212-7"><a href="hazards.html#cb212-7" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&quot;stan.pred&quot;</span>],</span>
<span id="cb212-8"><a href="hazards.html#cb212-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Stan spatial predictions &quot;</span>,</span>
<span id="cb212-9"><a href="hazards.html#cb212-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb212-10"><a href="hazards.html#cb212-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb212-11"><a href="hazards.html#cb212-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.8</span>, <span class="fl">0.02</span>)</span>
<span id="cb212-12"><a href="hazards.html#cb212-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb212-13"><a href="hazards.html#cb212-13" aria-hidden="true" tabindex="-1"></a>stan_var <span class="ot">&lt;-</span></span>
<span id="cb212-14"><a href="hazards.html#cb212-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb212-15"><a href="hazards.html#cb212-15" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&quot;stan.var&quot;</span>],</span>
<span id="cb212-16"><a href="hazards.html#cb212-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Stan predictions variance &quot;</span>,</span>
<span id="cb212-17"><a href="hazards.html#cb212-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb212-18"><a href="hazards.html#cb212-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb212-19"><a href="hazards.html#cb212-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span>)</span>
<span id="cb212-20"><a href="hazards.html#cb212-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb212-21"><a href="hazards.html#cb212-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-22"><a href="hazards.html#cb212-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_grid</span>(stan_pred, stan_var, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20stan%20plot%20predictions-1.png" width="672" /></p>
</div>
</div>
<div id="example-10.10-spatial-predictions" class="section level2 unnumbered hasAnchor">
<h2>Example 10.10: Spatial predictions<a href="hazards.html#example-10.10-spatial-predictions" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>NOTE: To Alex, I just added the spatial predictions for nimble, do we want it for Stan too?
Also note that I am just doing for 5 locations (please double-check my equations) and it instead of running in 2 minutes it runs in 6 (in case you want to highlight that). But we should discuss the order of this cause I am doing the predictions with Paritosh’s code in the previous section.</p>
<div id="nimble-5" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="hazards.html#nimble-5" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="hazards.html#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain coordinates for predictions </span></span>
<span id="cb213-2"><a href="hazards.html#cb213-2" aria-hidden="true" tabindex="-1"></a><span class="co"># note that we are using the same coordinates as the one generated for </span></span>
<span id="cb213-3"><a href="hazards.html#cb213-3" aria-hidden="true" tabindex="-1"></a><span class="co"># the kriging example</span></span>
<span id="cb213-4"><a href="hazards.html#cb213-4" aria-hidden="true" tabindex="-1"></a>Mtl_centroids_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(MtlPred)</span>
<span id="cb213-5"><a href="hazards.html#cb213-5" aria-hidden="true" tabindex="-1"></a>predCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_centroids_df))</span>
<span id="cb213-6"><a href="hazards.html#cb213-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-7"><a href="hazards.html#cb213-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale coordinates for predictive locations</span></span>
<span id="cb213-8"><a href="hazards.html#cb213-8" aria-hidden="true" tabindex="-1"></a>predCoords_sc <span class="ot">&lt;-</span> predCoords </span>
<span id="cb213-9"><a href="hazards.html#cb213-9" aria-hidden="true" tabindex="-1"></a>predCoords_sc[,<span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb213-10"><a href="hazards.html#cb213-10" aria-hidden="true" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>easting)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>easting)</span>
<span id="cb213-11"><a href="hazards.html#cb213-11" aria-hidden="true" tabindex="-1"></a>predCoords_sc[,<span class="dv">2</span>] <span class="ot">&lt;-</span> </span>
<span id="cb213-12"><a href="hazards.html#cb213-12" aria-hidden="true" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>northing)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>northing)</span>
<span id="cb213-13"><a href="hazards.html#cb213-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-14"><a href="hazards.html#cb213-14" aria-hidden="true" tabindex="-1"></a><span class="co"># As an example we are only going to predict 5 locations  </span></span>
<span id="cb213-15"><a href="hazards.html#cb213-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-16"><a href="hazards.html#cb213-16" aria-hidden="true" tabindex="-1"></a>nu <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb213-17"><a href="hazards.html#cb213-17" aria-hidden="true" tabindex="-1"></a>predCoords_five <span class="ot">&lt;-</span> predCoords_sc[<span class="dv">1</span><span class="sc">:</span>nu,]</span>
<span id="cb213-18"><a href="hazards.html#cb213-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-19"><a href="hazards.html#cb213-19" aria-hidden="true" tabindex="-1"></a>obs2predDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(obsCoords, predCoords[<span class="dv">1</span><span class="sc">:</span>nu,])</span>
<span id="cb213-20"><a href="hazards.html#cb213-20" aria-hidden="true" tabindex="-1"></a>pred2predDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(predCoords[<span class="dv">1</span><span class="sc">:</span>nu,])</span></code></pre></div>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="hazards.html#cb214-1" aria-hidden="true" tabindex="-1"></a>Example10_10Code <span class="ot">&lt;-</span>  <span class="fu">nimbleCode</span> ({</span>
<span id="cb214-2"><a href="hazards.html#cb214-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Covariance matrix spatial effect</span></span>
<span id="cb214-3"><a href="hazards.html#cb214-3" aria-hidden="true" tabindex="-1"></a>  Sigma_obs[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n] <span class="ot">&lt;-</span></span>
<span id="cb214-4"><a href="hazards.html#cb214-4" aria-hidden="true" tabindex="-1"></a>    sigma_sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>distMatrix[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n] <span class="sc">/</span> phi) <span class="sc">+</span> tau_sq <span class="sc">*</span> <span class="fu">identityMatrix</span>(<span class="at">d =</span> n)</span>
<span id="cb214-5"><a href="hazards.html#cb214-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-6"><a href="hazards.html#cb214-6" aria-hidden="true" tabindex="-1"></a>  Sigma_pred[<span class="dv">1</span><span class="sc">:</span>nu, <span class="dv">1</span><span class="sc">:</span>nu] <span class="ot">&lt;-</span></span>
<span id="cb214-7"><a href="hazards.html#cb214-7" aria-hidden="true" tabindex="-1"></a>    sigma_sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>distMatrixUnobs[<span class="dv">1</span><span class="sc">:</span>nu, <span class="dv">1</span><span class="sc">:</span>nu] <span class="sc">/</span> phi) <span class="sc">+</span> tau_sq <span class="sc">*</span> <span class="fu">identityMatrix</span>(<span class="at">d =</span> nu)</span>
<span id="cb214-8"><a href="hazards.html#cb214-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-9"><a href="hazards.html#cb214-9" aria-hidden="true" tabindex="-1"></a>  Sigma_obs_pred[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>nu] <span class="ot">&lt;-</span></span>
<span id="cb214-10"><a href="hazards.html#cb214-10" aria-hidden="true" tabindex="-1"></a>    sigma_sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>distMatrixObsUnobs[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>nu] <span class="sc">/</span> phi) </span>
<span id="cb214-11"><a href="hazards.html#cb214-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-12"><a href="hazards.html#cb214-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (site <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb214-13"><a href="hazards.html#cb214-13" aria-hidden="true" tabindex="-1"></a>    mean.site[site] <span class="ot">&lt;-</span></span>
<span id="cb214-14"><a href="hazards.html#cb214-14" aria-hidden="true" tabindex="-1"></a>      beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> easting[site] <span class="sc">+</span> beta2 <span class="sc">*</span> northing[site]</span>
<span id="cb214-15"><a href="hazards.html#cb214-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb214-16"><a href="hazards.html#cb214-16" aria-hidden="true" tabindex="-1"></a>  y[<span class="dv">1</span><span class="sc">:</span>n]  <span class="sc">~</span>  <span class="fu">dmnorm</span>(mean.site[<span class="dv">1</span><span class="sc">:</span>n], <span class="at">cov =</span> Sigma_obs[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n])</span>
<span id="cb214-17"><a href="hazards.html#cb214-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-18"><a href="hazards.html#cb214-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Spatial predictions</span></span>
<span id="cb214-19"><a href="hazards.html#cb214-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-20"><a href="hazards.html#cb214-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (usite <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nu) {</span>
<span id="cb214-21"><a href="hazards.html#cb214-21" aria-hidden="true" tabindex="-1"></a>    mean.pred.site[usite] <span class="ot">&lt;-</span></span>
<span id="cb214-22"><a href="hazards.html#cb214-22" aria-hidden="true" tabindex="-1"></a>      beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> easting_pred[usite] <span class="sc">+</span> beta2 <span class="sc">*</span> northing_pred[usite]</span>
<span id="cb214-23"><a href="hazards.html#cb214-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb214-24"><a href="hazards.html#cb214-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-25"><a href="hazards.html#cb214-25" aria-hidden="true" tabindex="-1"></a>  mean_sigma[<span class="dv">1</span><span class="sc">:</span>nu] <span class="ot">&lt;-</span> <span class="fu">t</span>(Sigma_obs_pred[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>nu])<span class="sc">%*%</span> </span>
<span id="cb214-26"><a href="hazards.html#cb214-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inverse</span>(Sigma_obs[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n])<span class="sc">%*%</span>(y[<span class="dv">1</span><span class="sc">:</span>n] <span class="sc">-</span> mean.site[<span class="dv">1</span><span class="sc">:</span>n])</span>
<span id="cb214-27"><a href="hazards.html#cb214-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-28"><a href="hazards.html#cb214-28" aria-hidden="true" tabindex="-1"></a>  mu_pred[<span class="dv">1</span><span class="sc">:</span>nu] <span class="ot">&lt;-</span></span>
<span id="cb214-29"><a href="hazards.html#cb214-29" aria-hidden="true" tabindex="-1"></a>    mean.pred.site[<span class="dv">1</span><span class="sc">:</span>nu] <span class="sc">+</span> mean_sigma[<span class="dv">1</span><span class="sc">:</span>nu]</span>
<span id="cb214-30"><a href="hazards.html#cb214-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-31"><a href="hazards.html#cb214-31" aria-hidden="true" tabindex="-1"></a>  cov_pred[<span class="dv">1</span><span class="sc">:</span>nu, <span class="dv">1</span><span class="sc">:</span>nu] <span class="ot">&lt;-</span></span>
<span id="cb214-32"><a href="hazards.html#cb214-32" aria-hidden="true" tabindex="-1"></a>    Sigma_pred[<span class="dv">1</span><span class="sc">:</span>nu, <span class="dv">1</span><span class="sc">:</span>nu] <span class="sc">-</span> <span class="fu">t</span>(Sigma_obs_pred[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>nu]) <span class="sc">%*%</span> <span class="fu">inverse</span>(Sigma_obs[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n]) <span class="sc">%*%</span> Sigma_obs_pred[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>nu]</span>
<span id="cb214-33"><a href="hazards.html#cb214-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-34"><a href="hazards.html#cb214-34" aria-hidden="true" tabindex="-1"></a>  y_pred[<span class="dv">1</span><span class="sc">:</span>nu]  <span class="sc">~</span>  <span class="fu">dmnorm</span>(mu_pred[<span class="dv">1</span><span class="sc">:</span>nu], <span class="at">cov =</span> cov_pred[<span class="dv">1</span><span class="sc">:</span>nu, <span class="dv">1</span><span class="sc">:</span>nu])</span>
<span id="cb214-35"><a href="hazards.html#cb214-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-36"><a href="hazards.html#cb214-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set up the priors for the spatial model</span></span>
<span id="cb214-37"><a href="hazards.html#cb214-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-38"><a href="hazards.html#cb214-38" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb214-39"><a href="hazards.html#cb214-39" aria-hidden="true" tabindex="-1"></a>  sigma_sq <span class="ot">&lt;-</span> sigma <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb214-40"><a href="hazards.html#cb214-40" aria-hidden="true" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb214-41"><a href="hazards.html#cb214-41" aria-hidden="true" tabindex="-1"></a>  tau_sq <span class="ot">&lt;-</span> tau <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb214-42"><a href="hazards.html#cb214-42" aria-hidden="true" tabindex="-1"></a>  phi_inv <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="at">shape =</span>  <span class="dv">5</span>, <span class="at">rate =</span> <span class="dv">5</span>)</span>
<span id="cb214-43"><a href="hazards.html#cb214-43" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> phi_inv</span>
<span id="cb214-44"><a href="hazards.html#cb214-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prior for the coefficients</span></span>
<span id="cb214-45"><a href="hazards.html#cb214-45" aria-hidden="true" tabindex="-1"></a>  beta0 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb214-46"><a href="hazards.html#cb214-46" aria-hidden="true" tabindex="-1"></a>  beta1 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb214-47"><a href="hazards.html#cb214-47" aria-hidden="true" tabindex="-1"></a>  beta2 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb214-48"><a href="hazards.html#cb214-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb214-49"><a href="hazards.html#cb214-49" aria-hidden="true" tabindex="-1"></a>}) </span>
<span id="cb214-50"><a href="hazards.html#cb214-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-51"><a href="hazards.html#cb214-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the constants, data, parameters and initial values</span></span>
<span id="cb214-52"><a href="hazards.html#cb214-52" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb214-53"><a href="hazards.html#cb214-53" aria-hidden="true" tabindex="-1"></a>easting_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>easting))</span>
<span id="cb214-54"><a href="hazards.html#cb214-54" aria-hidden="true" tabindex="-1"></a>northing_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>northing))</span>
<span id="cb214-55"><a href="hazards.html#cb214-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-56"><a href="hazards.html#cb214-56" aria-hidden="true" tabindex="-1"></a>constants <span class="ot">&lt;-</span></span>
<span id="cb214-57"><a href="hazards.html#cb214-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">n =</span> <span class="fu">nrow</span>(Mtl_benzene_sample), <span class="at">nu =</span> nu)</span>
<span id="cb214-58"><a href="hazards.html#cb214-58" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span></span>
<span id="cb214-59"><a href="hazards.html#cb214-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb214-60"><a href="hazards.html#cb214-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> Mtl_benzene_sample<span class="sc">$</span>y,</span>
<span id="cb214-61"><a href="hazards.html#cb214-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">easting =</span> easting_scaled,</span>
<span id="cb214-62"><a href="hazards.html#cb214-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">northing =</span> northing_scaled,</span>
<span id="cb214-63"><a href="hazards.html#cb214-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">easting_pred =</span> predCoords_five[,<span class="dv">1</span>],</span>
<span id="cb214-64"><a href="hazards.html#cb214-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">northing_pred =</span> predCoords_five[,<span class="dv">2</span>],</span>
<span id="cb214-65"><a href="hazards.html#cb214-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">distMatrix =</span> obsDist,</span>
<span id="cb214-66"><a href="hazards.html#cb214-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">distMatrixUnobs =</span> pred2predDist,</span>
<span id="cb214-67"><a href="hazards.html#cb214-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">distMatrixObsUnobs =</span> obs2predDist</span>
<span id="cb214-68"><a href="hazards.html#cb214-68" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb214-69"><a href="hazards.html#cb214-69" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span></span>
<span id="cb214-70"><a href="hazards.html#cb214-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,</span>
<span id="cb214-71"><a href="hazards.html#cb214-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;beta1&quot;</span>,</span>
<span id="cb214-72"><a href="hazards.html#cb214-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;beta2&quot;</span>,</span>
<span id="cb214-73"><a href="hazards.html#cb214-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;phi&quot;</span>,</span>
<span id="cb214-74"><a href="hazards.html#cb214-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;tau&quot;</span>,</span>
<span id="cb214-75"><a href="hazards.html#cb214-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;sigma&quot;</span>,</span>
<span id="cb214-76"><a href="hazards.html#cb214-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;tau_sq&quot;</span>,</span>
<span id="cb214-77"><a href="hazards.html#cb214-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;y_pred&quot;</span>,</span>
<span id="cb214-78"><a href="hazards.html#cb214-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;sigma_sq&quot;</span>)</span>
<span id="cb214-79"><a href="hazards.html#cb214-79" aria-hidden="true" tabindex="-1"></a>inits <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">sigma =</span> <span class="fl">0.1</span>,</span>
<span id="cb214-80"><a href="hazards.html#cb214-80" aria-hidden="true" tabindex="-1"></a>              <span class="at">phi_inv =</span> <span class="dv">6</span> <span class="sc">/</span> <span class="fu">max</span>(obsDist),</span>
<span id="cb214-81"><a href="hazards.html#cb214-81" aria-hidden="true" tabindex="-1"></a>              <span class="at">tau =</span> <span class="fl">0.1</span>)</span>
<span id="cb214-82"><a href="hazards.html#cb214-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Run model in nimble</span></span>
<span id="cb214-83"><a href="hazards.html#cb214-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-84"><a href="hazards.html#cb214-84" aria-hidden="true" tabindex="-1"></a>mcmc.out <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb214-85"><a href="hazards.html#cb214-85" aria-hidden="true" tabindex="-1"></a>  <span class="at">code =</span> Example10_10Code,</span>
<span id="cb214-86"><a href="hazards.html#cb214-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">constants =</span> constants,</span>
<span id="cb214-87"><a href="hazards.html#cb214-87" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb214-88"><a href="hazards.html#cb214-88" aria-hidden="true" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb214-89"><a href="hazards.html#cb214-89" aria-hidden="true" tabindex="-1"></a>  <span class="at">monitors =</span> params,</span>
<span id="cb214-90"><a href="hazards.html#cb214-90" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> <span class="dv">40000</span>,</span>
<span id="cb214-91"><a href="hazards.html#cb214-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> <span class="dv">20000</span>,</span>
<span id="cb214-92"><a href="hazards.html#cb214-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">14</span>,</span>
<span id="cb214-93"><a href="hazards.html#cb214-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb214-94"><a href="hazards.html#cb214-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb214-95"><a href="hazards.html#cb214-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb214-96"><a href="hazards.html#cb214-96" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb214-97"><a href="hazards.html#cb214-97" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="hazards.html#cb215-1" aria-hidden="true" tabindex="-1"></a>mcmc.out<span class="sc">$</span>WAIC</span></code></pre></div>
<pre><code>## nimbleList object of type waicList
## Field &quot;WAIC&quot;:
## [1] -32.28445
## Field &quot;lppd&quot;:
## [1] 19.03747
## Field &quot;pWAIC&quot;:
## [1] 2.895244</code></pre>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="hazards.html#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(mcmc.out<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 849.3096</code></pre>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="hazards.html#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta0&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.10%20nimble%20WAIC,%20ESS%20and%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="hazards.html#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta1&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta1&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.10%20nimble%20WAIC,%20ESS%20and%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="hazards.html#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta2&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta2&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.10%20nimble%20WAIC,%20ESS%20and%20traceplots-3.png" width="672" /></p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="hazards.html#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;sigma&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;sigma&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.10%20nimble%20WAIC,%20ESS%20and%20traceplots-4.png" width="672" /></p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="hazards.html#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;tau&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.10%20nimble%20WAIC,%20ESS%20and%20traceplots-5.png" width="672" /></p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="hazards.html#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;phi&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.10%20nimble%20WAIC,%20ESS%20and%20traceplots-6.png" width="672" /></p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="hazards.html#cb225-1" aria-hidden="true" tabindex="-1"></a>mcmc.out<span class="sc">$</span>summary<span class="sc">$</span>all.chains</span></code></pre></div>
<pre><code>##                   Mean       Median     St.Dev.     95%CI_low  95%CI_upp
## beta0      0.143282027  0.151098526 0.080210901 -4.320255e-02 0.28188251
## beta1      0.047132468  0.045714893 0.059074146 -7.036740e-02 0.16808769
## beta2      0.078236153  0.083129502 0.067977770 -6.927811e-02 0.19791770
## phi        3.672082520  3.089047660 2.158752561  1.484596e+00 9.20444422
## sigma      0.233174608  0.227937419 0.040783337  1.687427e-01 0.33073631
## sigma_sq   0.056033096  0.051955467 0.021212336  2.847411e-02 0.10938656
## tau        0.086925465  0.091948800 0.039612987  5.328545e-03 0.15319110
## tau_sq     0.009124676  0.008454582 0.006622246  2.839674e-05 0.02346751
## y_pred[1] -0.255307410 -0.262034854 0.307921711 -8.442072e-01 0.36678929
## y_pred[2] -0.255612451 -0.263067874 0.306518102 -8.718905e-01 0.36502437
## y_pred[3] -0.247526801 -0.251652153 0.299628925 -8.238475e-01 0.37022723
## y_pred[4] -0.248606948 -0.257696742 0.303087157 -8.451291e-01 0.37558929
## y_pred[5] -0.246847841 -0.246510211 0.301927586 -8.437388e-01 0.35702082</code></pre>
</div>
<div id="stan-5" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="hazards.html#stan-5" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="hazards.html#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data predictions</span></span>
<span id="cb227-2"><a href="hazards.html#cb227-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain coordinates for predictions </span></span>
<span id="cb227-3"><a href="hazards.html#cb227-3" aria-hidden="true" tabindex="-1"></a><span class="co"># note that we are using the same coordinates as the one generated for </span></span>
<span id="cb227-4"><a href="hazards.html#cb227-4" aria-hidden="true" tabindex="-1"></a><span class="co"># the kriging example</span></span>
<span id="cb227-5"><a href="hazards.html#cb227-5" aria-hidden="true" tabindex="-1"></a>Mtl_centroids_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(MtlPred)</span>
<span id="cb227-6"><a href="hazards.html#cb227-6" aria-hidden="true" tabindex="-1"></a>predCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_centroids_df))</span>
<span id="cb227-7"><a href="hazards.html#cb227-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-8"><a href="hazards.html#cb227-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale coordinates for predictive locations</span></span>
<span id="cb227-9"><a href="hazards.html#cb227-9" aria-hidden="true" tabindex="-1"></a>predCoords_sc <span class="ot">&lt;-</span> predCoords </span>
<span id="cb227-10"><a href="hazards.html#cb227-10" aria-hidden="true" tabindex="-1"></a>predCoords_sc[,<span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb227-11"><a href="hazards.html#cb227-11" aria-hidden="true" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>easting)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>easting)</span>
<span id="cb227-12"><a href="hazards.html#cb227-12" aria-hidden="true" tabindex="-1"></a>predCoords_sc[,<span class="dv">2</span>] <span class="ot">&lt;-</span> </span>
<span id="cb227-13"><a href="hazards.html#cb227-13" aria-hidden="true" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>northing)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>northing)</span>
<span id="cb227-14"><a href="hazards.html#cb227-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-15"><a href="hazards.html#cb227-15" aria-hidden="true" tabindex="-1"></a><span class="co"># As an example we are only going to predict 5 locations  </span></span>
<span id="cb227-16"><a href="hazards.html#cb227-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-17"><a href="hazards.html#cb227-17" aria-hidden="true" tabindex="-1"></a>nu <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb227-18"><a href="hazards.html#cb227-18" aria-hidden="true" tabindex="-1"></a>predCoords_five <span class="ot">&lt;-</span> predCoords_sc[<span class="dv">1</span><span class="sc">:</span>nu,]</span>
<span id="cb227-19"><a href="hazards.html#cb227-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-20"><a href="hazards.html#cb227-20" aria-hidden="true" tabindex="-1"></a>obs2predDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(obsCoords, predCoords[<span class="dv">1</span><span class="sc">:</span>nu,])</span>
<span id="cb227-21"><a href="hazards.html#cb227-21" aria-hidden="true" tabindex="-1"></a>pred2predDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(predCoords[<span class="dv">1</span><span class="sc">:</span>nu,])</span></code></pre></div>
<pre><code>data {
  int&lt;lower=1&gt; N;
  int&lt;lower = 0&gt; N_pred;
  int&lt;lower=0&gt; p;
  vector[N] y;
  matrix[N,N] obs_dist_matrix;
  matrix[N,N_pred] obs_pred_dist_matrix;
  matrix[N_pred, N_pred] pred_dist_matrix;
  matrix[N,p] X; 
  matrix[N_pred,p] X_pred; 
}
parameters {
  real&lt;lower=0&gt; phi;
  real&lt;lower=0&gt; tau;
  real&lt;lower=0&gt; sigma;
  vector[p] beta;
  real beta0;
}
transformed parameters{
  real&lt;lower=0&gt; sigma_sq = square(sigma);
  real&lt;lower=0&gt; tau_sq = square(tau);
}
model {
  matrix[N, N] L;
  matrix[N, N] Sigma;
  vector[N] mu;

  Sigma = sigma_sq * exp(-obs_dist_matrix/ phi) + tau_sq *diag_matrix(rep_vector(1, N));
   // diagonal elements

  for(i in 1:N) {
    mu[i] = beta0 + X[i,]*beta;
  }
  
  L = cholesky_decompose(Sigma);
  
  beta0 ~ normal(0,10);
  beta ~ normal(0,10);
  phi ~ inv_gamma(5, 5);
  tau ~ cauchy(0,1);
  sigma ~ cauchy(0,1);

  y ~ multi_normal_cholesky(mu, L);
}

generated quantities {
  matrix[N_pred, N_pred] L;
  matrix[N, N] Sigma_obs;
  matrix[N_pred, N_pred] Sigma_pred;
  matrix[N_pred, N_pred] Cov_pred;
  matrix[N, N_pred] Sigma_obs_pred;
  vector[N] mu;
  vector[N_pred] mu_unobs;
  vector[N_pred] mu_pred;
  vector[N_pred] y_pred;

 Sigma_obs = sigma_sq * exp(-obs_dist_matrix/ phi) + tau_sq *diag_matrix(rep_vector(1, N));
 Sigma_pred = sigma_sq * exp(-pred_dist_matrix/ phi) + tau_sq *diag_matrix(rep_vector(1, N_pred));
 Sigma_obs_pred =  sigma_sq * exp(-obs_pred_dist_matrix/ phi);

 for (j in 1:N_pred) {
    mu_unobs[j] = beta0 + X_pred[j,]*beta;
  }
  
  for(i in 1:N) {
    mu[i] = beta0 + X[i,]*beta;
  }
  
  mu_pred = mu_unobs + Sigma_obs_pred&#39;*inverse(Sigma_obs)*(y - mu);
  Cov_pred = Sigma_pred - Sigma_obs_pred&#39;*inverse(Sigma_obs)*Sigma_obs_pred;
  L = cholesky_decompose(Cov_pred);
  y_pred  = multi_normal_cholesky_rng(mu_pred, L);
  
 
  
}</code></pre>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="hazards.html#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb229-2"><a href="hazards.html#cb229-2" aria-hidden="true" tabindex="-1"></a>easting_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>easting))</span>
<span id="cb229-3"><a href="hazards.html#cb229-3" aria-hidden="true" tabindex="-1"></a>northing_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>northing))</span>
<span id="cb229-4"><a href="hazards.html#cb229-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-5"><a href="hazards.html#cb229-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(benzene_utm_df)</span>
<span id="cb229-6"><a href="hazards.html#cb229-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Change coordinates to kilometers</span></span>
<span id="cb229-7"><a href="hazards.html#cb229-7" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">easting =</span> easting_scaled,</span>
<span id="cb229-8"><a href="hazards.html#cb229-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">northing =</span> northing_scaled) </span>
<span id="cb229-9"><a href="hazards.html#cb229-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-10"><a href="hazards.html#cb229-10" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb229-11"><a href="hazards.html#cb229-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb229-12"><a href="hazards.html#cb229-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_pred =</span> <span class="fu">nrow</span>(predCoords_five),</span>
<span id="cb229-13"><a href="hazards.html#cb229-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">2</span>,</span>
<span id="cb229-14"><a href="hazards.html#cb229-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span>   <span class="fu">log</span>(benzene_utm_df<span class="sc">$</span>Benzene),</span>
<span id="cb229-15"><a href="hazards.html#cb229-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">obs_dist_matrix =</span> obsDist,</span>
<span id="cb229-16"><a href="hazards.html#cb229-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">obs_pred_dist_matrix =</span> obs2predDist,</span>
<span id="cb229-17"><a href="hazards.html#cb229-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred_dist_matrix =</span> pred2predDist,</span>
<span id="cb229-18"><a href="hazards.html#cb229-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> <span class="fu">as.matrix</span>(X),</span>
<span id="cb229-19"><a href="hazards.html#cb229-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">X_pred =</span> predCoords_five</span>
<span id="cb229-20"><a href="hazards.html#cb229-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb229-21"><a href="hazards.html#cb229-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-22"><a href="hazards.html#cb229-22" aria-hidden="true" tabindex="-1"></a>Example10_10Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb229-23"><a href="hazards.html#cb229-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example10_10.stan&quot;</span>,</span>
<span id="cb229-24"><a href="hazards.html#cb229-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb229-25"><a href="hazards.html#cb229-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">10000</span>,</span>
<span id="cb229-26"><a href="hazards.html#cb229-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">20000</span>,</span>
<span id="cb229-27"><a href="hazards.html#cb229-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb229-28"><a href="hazards.html#cb229-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb229-29"><a href="hazards.html#cb229-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;y_pred&quot;</span>),</span>
<span id="cb229-30"><a href="hazards.html#cb229-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb229-31"><a href="hazards.html#cb229-31" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="hazards.html#cb230-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example10_10Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;y_pred[1]&quot;</span>, <span class="st">&quot;y_pred[5]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.10%20stan%20exp%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="hazards.html#cb231-1" aria-hidden="true" tabindex="-1"></a>summary_exp_stan <span class="ot">&lt;-</span></span>
<span id="cb231-2"><a href="hazards.html#cb231-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb231-3"><a href="hazards.html#cb231-3" aria-hidden="true" tabindex="-1"></a>    Example10_10Stan,</span>
<span id="cb231-4"><a href="hazards.html#cb231-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>,  <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;y_pred&quot;</span>),</span>
<span id="cb231-5"><a href="hazards.html#cb231-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb231-6"><a href="hazards.html#cb231-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb231-7"><a href="hazards.html#cb231-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-8"><a href="hazards.html#cb231-8" aria-hidden="true" tabindex="-1"></a>summary_exp_stan<span class="sc">$</span>summary</span></code></pre></div>
<pre><code>##                  mean      se_mean          sd          2.5%      97.5%
## beta0      0.15258643 0.0018234279 0.079308240 -2.001743e-02 0.28617872
## beta[1]    0.05045002 0.0014848444 0.060158681 -5.797474e-02 0.17469632
## beta[2]    0.08097296 0.0015480754 0.068716147 -6.234031e-02 0.19892439
## sigma_sq   0.05490898 0.0004512223 0.019765362  2.856358e-02 0.09963885
## tau_sq     0.00908246 0.0001454411 0.006536201  7.628813e-05 0.02330783
## phi        3.53683130 0.0439541748 1.944669225  1.459591e+00 8.51153142
## y_pred[1] -0.27171824 0.0064573238 0.301755582 -8.662022e-01 0.32660398
## y_pred[2] -0.27014241 0.0062501053 0.298996379 -8.465919e-01 0.34943459
## y_pred[3] -0.27137893 0.0065656694 0.304186203 -8.428175e-01 0.36845440
## y_pred[4] -0.26958521 0.0066000702 0.301509144 -8.596208e-01 0.33281974
## y_pred[5] -0.26371260 0.0065379338 0.304303176 -8.687426e-01 0.37264053
##              n_eff      Rhat
## beta0     1891.731 1.0012130
## beta[1]   1641.477 1.0027991
## beta[2]   1970.305 1.0025511
## sigma_sq  1918.794 0.9998376
## tau_sq    2019.653 1.0003639
## phi       1957.452 1.0003897
## y_pred[1] 2183.763 1.0000693
## y_pred[2] 2288.533 0.9998625
## y_pred[3] 2146.451 0.9993365
## y_pred[4] 2086.911 0.9999384
## y_pred[5] 2166.366 1.0000249</code></pre>
</div>
</div>
<div id="example-10.11-inla-creating-a-mesh" class="section level2 unnumbered hasAnchor">
<h2>Example 10.11: INLA, creating a mesh<a href="hazards.html#example-10.11-inla-creating-a-mesh" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="hazards.html#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb233-2"><a href="hazards.html#cb233-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(INLA)</span>
<span id="cb233-3"><a href="hazards.html#cb233-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb233-4"><a href="hazards.html#cb233-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-5"><a href="hazards.html#cb233-5" aria-hidden="true" tabindex="-1"></a>benzene_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb233-6"><a href="hazards.html#cb233-6" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb233-7"><a href="hazards.html#cb233-7" aria-hidden="true" tabindex="-1"></a>benzene_data_loc <span class="ot">&lt;-</span> benzene_data</span>
<span id="cb233-8"><a href="hazards.html#cb233-8" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_data_loc) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb233-9"><a href="hazards.html#cb233-9" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_data_loc) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb233-10"><a href="hazards.html#cb233-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-11"><a href="hazards.html#cb233-11" aria-hidden="true" tabindex="-1"></a>benzene_data_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_data_loc,</span>
<span id="cb233-12"><a href="hazards.html#cb233-12" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb233-13"><a href="hazards.html#cb233-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb233-14"><a href="hazards.html#cb233-14" aria-hidden="true" tabindex="-1"></a>locations_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_data_utm<span class="sc">@</span>coords)</span>
<span id="cb233-15"><a href="hazards.html#cb233-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-16"><a href="hazards.html#cb233-16" aria-hidden="true" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(benzene_data),</span>
<span id="cb233-17"><a href="hazards.html#cb233-17" aria-hidden="true" tabindex="-1"></a>                              <span class="at">X =</span> benzene_data_utm<span class="sc">@</span>coords[,<span class="dv">1</span>]<span class="sc">/</span><span class="dv">1000</span>,</span>
<span id="cb233-18"><a href="hazards.html#cb233-18" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Y =</span> benzene_data_utm<span class="sc">@</span>coords[,<span class="dv">2</span>]<span class="sc">/</span><span class="dv">1000</span>,</span>
<span id="cb233-19"><a href="hazards.html#cb233-19" aria-hidden="true" tabindex="-1"></a>                              <span class="at">logbenzene =</span> <span class="fu">log</span>(benzene_data_utm<span class="sc">$</span>Benzene))</span>
<span id="cb233-20"><a href="hazards.html#cb233-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb233-21"><a href="hazards.html#cb233-21" aria-hidden="true" tabindex="-1"></a><span class="co"># change the observed values to the log scale and the coordinates to km&#39;s</span></span>
<span id="cb233-22"><a href="hazards.html#cb233-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-23"><a href="hazards.html#cb233-23" aria-hidden="true" tabindex="-1"></a>mesh <span class="ot">=</span> <span class="fu">inla.mesh.create</span>(locations_df, <span class="at">cutoff =</span> <span class="fl">0.01</span>, </span>
<span id="cb233-24"><a href="hazards.html#cb233-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">refine =</span>(<span class="fu">list</span>(<span class="at">min.angle =</span><span class="dv">20</span>)))</span>
<span id="cb233-25"><a href="hazards.html#cb233-25" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mesh , <span class="at">col=</span><span class="st">&quot;gray&quot;</span>, <span class="at">main=</span><span class="st">&quot;&quot;</span>) </span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.11%20load%20data%20for%20INLA-1.png" width="672" /></p>
</div>
<div id="example-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Example 10.12: Fitting an SPDE model using R–INLA: benzene concentration in Montreal<a href="hazards.html#example-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="hazards.html#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Field std . dev . for theta =0</span></span>
<span id="cb234-2"><a href="hazards.html#cb234-2" aria-hidden="true" tabindex="-1"></a>sigma0 <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb234-3"><a href="hazards.html#cb234-3" aria-hidden="true" tabindex="-1"></a><span class="co"># find the range of the location data</span></span>
<span id="cb234-4"><a href="hazards.html#cb234-4" aria-hidden="true" tabindex="-1"></a>size <span class="ot">=</span> <span class="fu">min</span>(<span class="fu">c</span>(<span class="fu">diff</span>(<span class="fu">range</span>(mesh<span class="sc">$</span>loc[, <span class="dv">1</span>])),</span>
<span id="cb234-5"><a href="hazards.html#cb234-5" aria-hidden="true" tabindex="-1"></a>             <span class="fu">diff</span> (<span class="fu">range</span>(mesh<span class="sc">$</span>loc[, <span class="dv">2</span>]))))</span>
<span id="cb234-6"><a href="hazards.html#cb234-6" aria-hidden="true" tabindex="-1"></a><span class="co"># A fifth of the approximate domain width .</span></span>
<span id="cb234-7"><a href="hazards.html#cb234-7" aria-hidden="true" tabindex="-1"></a>range0 <span class="ot">=</span> size<span class="sc">/</span><span class="dv">5</span></span>
<span id="cb234-8"><a href="hazards.html#cb234-8" aria-hidden="true" tabindex="-1"></a>kappa0 <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="dv">8</span>)<span class="sc">/</span>range0</span>
<span id="cb234-9"><a href="hazards.html#cb234-9" aria-hidden="true" tabindex="-1"></a>tau0 <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(<span class="fu">sqrt</span> (<span class="dv">4</span><span class="sc">*</span>pi)<span class="sc">*</span>kappa0<span class="sc">*</span>sigma0)</span>
<span id="cb234-10"><a href="hazards.html#cb234-10" aria-hidden="true" tabindex="-1"></a>spde <span class="ot">=</span> <span class="fu">inla.spde2.matern</span> (</span>
<span id="cb234-11"><a href="hazards.html#cb234-11" aria-hidden="true" tabindex="-1"></a>  mesh,</span>
<span id="cb234-12"><a href="hazards.html#cb234-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">B.tau =</span> <span class="fu">cbind</span>(<span class="fu">log</span> (tau0), <span class="sc">-</span><span class="dv">1</span>, <span class="sc">+</span><span class="dv">1</span>),</span>
<span id="cb234-13"><a href="hazards.html#cb234-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">B.kappa =</span> <span class="fu">cbind</span>(<span class="fu">log</span> (kappa0), <span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb234-14"><a href="hazards.html#cb234-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">theta.prior.mean =</span> <span class="fu">c</span>(<span class="dv">0</span> , <span class="dv">0</span>),</span>
<span id="cb234-15"><a href="hazards.html#cb234-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">constr =</span> <span class="cn">TRUE</span></span>
<span id="cb234-16"><a href="hazards.html#cb234-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb234-17"><a href="hazards.html#cb234-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-18"><a href="hazards.html#cb234-18" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">=</span> logbenzene  <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> X <span class="sc">+</span> Y <span class="sc">+</span> <span class="fu">f</span>(ID , <span class="at">model =</span> spde)</span>
<span id="cb234-19"><a href="hazards.html#cb234-19" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> <span class="fu">inla</span>(</span>
<span id="cb234-20"><a href="hazards.html#cb234-20" aria-hidden="true" tabindex="-1"></a>  formula,</span>
<span id="cb234-21"><a href="hazards.html#cb234-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb234-22"><a href="hazards.html#cb234-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> benzene_utm_df ,</span>
<span id="cb234-23"><a href="hazards.html#cb234-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>),</span>
<span id="cb234-24"><a href="hazards.html#cb234-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> <span class="cn">TRUE</span> , <span class="at">config =</span> <span class="cn">TRUE</span>)</span>
<span id="cb234-25"><a href="hazards.html#cb234-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb234-26"><a href="hazards.html#cb234-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-27"><a href="hazards.html#cb234-27" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span>summary.fixed</span></code></pre></div>
<pre><code>##                     mean           sd    0.025quant      0.5quant
## (Intercept)  8.263107109 118.01744834 -189.26686123 -5.4724133487
## X            0.014532810   0.02130267   -0.02563718  0.0132910509
## Y           -0.003363563   0.02371941   -0.06108419 -0.0006481981
##               0.975quant          mode          kld
## (Intercept) 298.73720629 -20.057620990 5.350437e-05
## X             0.06340354   0.011915185 7.755183e-05
## Y             0.03642514   0.002407428 3.418641e-05</code></pre>
</div>
<div id="example-10.13-directional-variograms" class="section level2 unnumbered hasAnchor">
<h2>Example 10.13: Directional variograms<a href="hazards.html#example-10.13-directional-variograms" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="hazards.html#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Compute and plot the directional variogram</span></span>
<span id="cb236-2"><a href="hazards.html#cb236-2" aria-hidden="true" tabindex="-1"></a>CA.geo <span class="ot">&lt;-</span> <span class="fu">as.geodata</span>( benzene_utm_df , <span class="at">coords.col =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span> , <span class="at">data.col=</span><span class="dv">1</span>)</span>
<span id="cb236-3"><a href="hazards.html#cb236-3" aria-hidden="true" tabindex="-1"></a>CA.vario4 <span class="ot">&lt;-</span> <span class="fu">variog4</span>(CA.geo )</span>
<span id="cb236-4"><a href="hazards.html#cb236-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(CA.vario4)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.13%20directional%20variogram-1.png" width="672" /></p>
<!-- REVIEW: I am not sure where this example goes -->
</div>
<div id="example-10.14-spatial-modeling-of-malaria-in-gambia" class="section level2 unnumbered hasAnchor">
<h2>Example 10.14: Spatial modeling of malaria in Gambia<a href="hazards.html#example-10.14-spatial-modeling-of-malaria-in-gambia" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Note: There might be a warning when loading the <span class="math inline">\(\texttt{raster}\)</span> package, if necessary, uninstall and re-install the package.</p>
<p>For this example we are using the same <span class="math inline">\(\texttt{gambia}\)</span> data set from the <span class="math inline">\(\texttt{geoR}\)</span> package but an <span class="math inline">\(\texttt{id_area}\)</span> column was added using QGIS to differentiate the different areas as in the original paper.</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="hazards.html#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># to manipulate the data</span></span>
<span id="cb237-2"><a href="hazards.html#cb237-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geoR) <span class="co"># to get the dataset</span></span>
<span id="cb237-3"><a href="hazards.html#cb237-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggmap) <span class="co"># to plot the map</span></span>
<span id="cb237-4"><a href="hazards.html#cb237-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble) <span class="co"># for modeling</span></span>
<span id="cb237-5"><a href="hazards.html#cb237-5" aria-hidden="true" tabindex="-1"></a><span class="co">#library(raster) # to get the environmental data</span></span>
<span id="cb237-6"><a href="hazards.html#cb237-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rgdal) <span class="co"># for adding and transforming coordinates</span></span>
<span id="cb237-7"><a href="hazards.html#cb237-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># manipulate spatial data</span></span>
<span id="cb237-8"><a href="hazards.html#cb237-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sp) <span class="co"># for manipulating spatial data</span></span>
<span id="cb237-9"><a href="hazards.html#cb237-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr) <span class="co"># to analyze posterior</span></span>
<span id="cb237-10"><a href="hazards.html#cb237-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis) <span class="co"># for a more cheerful color palette</span></span>
<span id="cb237-11"><a href="hazards.html#cb237-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-12"><a href="hazards.html#cb237-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Note, we are using the same Gambia dataset as in the geoR package but an id_area</span></span>
<span id="cb237-13"><a href="hazards.html#cb237-13" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute has been added using QGIS to a</span></span>
<span id="cb237-14"><a href="hazards.html#cb237-14" aria-hidden="true" tabindex="-1"></a>gambia <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/gambia_area.csv&quot;</span>) <span class="co"># gambia dataset from geoR package</span></span></code></pre></div>
<p>Since the data is given at the individual level, we want to aggregate the malaria tests by village.
If we explore the data frame we see that there are 2035 individuals at 65 villages.</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="hazards.html#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gambia)</span></code></pre></div>
<pre><code>##          x       y pos  age netuse treated green phc id_area
## 1 349631.3 1458055   1 1783      0       0 40.85   1       1
## 2 349631.3 1458055   0  404      1       0 40.85   1       1
## 3 349631.3 1458055   0  452      1       0 40.85   1       1
## 4 349631.3 1458055   1  566      1       0 40.85   1       1
## 5 349631.3 1458055   0  598      1       0 40.85   1       1
## 6 349631.3 1458055   1  590      1       0 40.85   1       1</code></pre>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="hazards.html#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(gambia)</span></code></pre></div>
<pre><code>## [1] 2035    9</code></pre>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="hazards.html#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(<span class="fu">unique</span>(gambia[, <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>)]))</span></code></pre></div>
<pre><code>## [1] 65  2</code></pre>
<p>We create a new data frame aggregated by village containing the coordinates, the number of malaria tests, and the prevalence.</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="hazards.html#cb244-1" aria-hidden="true" tabindex="-1"></a>malaria_village <span class="ot">&lt;-</span> <span class="fu">group_by</span>(gambia, x, y) <span class="sc">|&gt;</span></span>
<span id="cb244-2"><a href="hazards.html#cb244-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">total =</span> <span class="fu">n</span>(),</span>
<span id="cb244-3"><a href="hazards.html#cb244-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">positive =</span> <span class="fu">sum</span>(pos),</span>
<span id="cb244-4"><a href="hazards.html#cb244-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">prev =</span> positive <span class="sc">/</span> total) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span></code></pre></div>
<pre><code>## `summarise()` has grouped output by &#39;x&#39;. You can override using the
## `.groups` argument.</code></pre>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="hazards.html#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(malaria_village)</span></code></pre></div>
<pre><code>##          x       y total positive      prev
## 1 349631.3 1458055    33       17 0.5151515
## 2 358543.1 1460112    63       19 0.3015873
## 3 360308.1 1460026    17        7 0.4117647
## 4 363795.7 1496919    24        8 0.3333333
## 5 366400.5 1460248    26       10 0.3846154
## 6 366687.5 1463002    18        7 0.3888889</code></pre>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="hazards.html#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb248-2"><a href="hazards.html#cb248-2" aria-hidden="true" tabindex="-1"></a>malaria_utm <span class="ot">&lt;-</span> malaria_village</span>
<span id="cb248-3"><a href="hazards.html#cb248-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(malaria_utm) <span class="ot">&lt;-</span> <span class="er">~</span> x <span class="sc">+</span> y</span>
<span id="cb248-4"><a href="hazards.html#cb248-4" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(malaria_utm) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=28&quot;</span>)</span>
<span id="cb248-5"><a href="hazards.html#cb248-5" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to long lat </span></span>
<span id="cb248-6"><a href="hazards.html#cb248-6" aria-hidden="true" tabindex="-1"></a>malaria_geo <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(malaria_utm, <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>))</span>
<span id="cb248-7"><a href="hazards.html#cb248-7" aria-hidden="true" tabindex="-1"></a><span class="co"># add long lat coordinates to malaria dataframe</span></span>
<span id="cb248-8"><a href="hazards.html#cb248-8" aria-hidden="true" tabindex="-1"></a>malaria_village[, <span class="fu">c</span>(<span class="st">&quot;long&quot;</span>, <span class="st">&quot;lat&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">coordinates</span>(malaria_geo)</span>
<span id="cb248-9"><a href="hazards.html#cb248-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-10"><a href="hazards.html#cb248-10" aria-hidden="true" tabindex="-1"></a><span class="co"># specify the bounding box</span></span>
<span id="cb248-11"><a href="hazards.html#cb248-11" aria-hidden="true" tabindex="-1"></a>latLongBox <span class="ot">=</span> <span class="fu">bbox</span>(malaria_geo)</span>
<span id="cb248-12"><a href="hazards.html#cb248-12" aria-hidden="true" tabindex="-1"></a>location <span class="ot">=</span> <span class="fu">c</span>(latLongBox[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb248-13"><a href="hazards.html#cb248-13" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb248-14"><a href="hazards.html#cb248-14" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.05</span>,</span>
<span id="cb248-15"><a href="hazards.html#cb248-15" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.05</span>)</span>
<span id="cb248-16"><a href="hazards.html#cb248-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-17"><a href="hazards.html#cb248-17" aria-hidden="true" tabindex="-1"></a><span class="co"># create map with location dots marked on it in</span></span>
<span id="cb248-18"><a href="hazards.html#cb248-18" aria-hidden="true" tabindex="-1"></a>GambiaMap <span class="ot">&lt;-</span></span>
<span id="cb248-19"><a href="hazards.html#cb248-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_stamenmap</span>(<span class="at">bbox =</span>  location,</span>
<span id="cb248-20"><a href="hazards.html#cb248-20" aria-hidden="true" tabindex="-1"></a>                <span class="at">zoom =</span> <span class="dv">11</span>,</span>
<span id="cb248-21"><a href="hazards.html#cb248-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> terrain<span class="sc">-</span>background)</span>
<span id="cb248-22"><a href="hazards.html#cb248-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-23"><a href="hazards.html#cb248-23" aria-hidden="true" tabindex="-1"></a><span class="fu">ggmap</span>(GambiaMap) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">data =</span> malaria_village,</span>
<span id="cb248-24"><a href="hazards.html#cb248-24" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">aes</span>(<span class="at">x =</span> long,</span>
<span id="cb248-25"><a href="hazards.html#cb248-25" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">y =</span> lat,</span>
<span id="cb248-26"><a href="hazards.html#cb248-26" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">col =</span> prev),</span>
<span id="cb248-27"><a href="hazards.html#cb248-27" aria-hidden="true" tabindex="-1"></a>                              <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">scale_color_viridis</span>() <span class="sc">+</span> <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20plot%20prevalence-1.png" width="672" /></p>
<div id="nimble-6" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="hazards.html#nimble-6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="hazards.html#cb249-1" aria-hidden="true" tabindex="-1"></a>Example10_14_Nimble <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb249-2"><a href="hazards.html#cb249-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb249-3"><a href="hazards.html#cb249-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define priors</span></span>
<span id="cb249-4"><a href="hazards.html#cb249-4" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb249-5"><a href="hazards.html#cb249-5" aria-hidden="true" tabindex="-1"></a>  sigma_sq <span class="ot">&lt;-</span> sigma <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb249-6"><a href="hazards.html#cb249-6" aria-hidden="true" tabindex="-1"></a>  phi_inv <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="at">shape =</span>  <span class="dv">5</span>, <span class="at">rate =</span> <span class="dv">5</span>)</span>
<span id="cb249-7"><a href="hazards.html#cb249-7" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> phi_inv</span>
<span id="cb249-8"><a href="hazards.html#cb249-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-9"><a href="hazards.html#cb249-9" aria-hidden="true" tabindex="-1"></a>  Sigma[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span></span>
<span id="cb249-10"><a href="hazards.html#cb249-10" aria-hidden="true" tabindex="-1"></a>     sigma_sq<span class="sc">*</span>(<span class="dv">1</span> <span class="sc">+</span> (<span class="fu">sqrt</span>(<span class="dv">3</span>)<span class="sc">*</span>obs_dist_mat[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N])<span class="sc">/</span>phi) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">sqrt</span>(<span class="dv">3</span>)<span class="sc">*</span>obs_dist_mat[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="sc">/</span> phi) </span>
<span id="cb249-11"><a href="hazards.html#cb249-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-12"><a href="hazards.html#cb249-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#b0[1:N] ~ dmnorm(zeroes[1:N], cov = Id10[1:N, 1:N])</span></span>
<span id="cb249-13"><a href="hazards.html#cb249-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mean_S[1:N] &lt;- nimRep(b0, N)</span></span>
<span id="cb249-14"><a href="hazards.html#cb249-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb249-15"><a href="hazards.html#cb249-15" aria-hidden="true" tabindex="-1"></a>    mean_S[i] <span class="ot">&lt;-</span> b0</span>
<span id="cb249-16"><a href="hazards.html#cb249-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb249-17"><a href="hazards.html#cb249-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb249-18"><a href="hazards.html#cb249-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#S[1:N] ~ dmnorm(mean_S[1:N], cov = Sigma[1:N,1:N])</span></span>
<span id="cb249-19"><a href="hazards.html#cb249-19" aria-hidden="true" tabindex="-1"></a>    S[<span class="dv">1</span><span class="sc">:</span>N] <span class="sc">~</span> <span class="fu">dmnorm</span>(zeroes[<span class="dv">1</span><span class="sc">:</span>N], <span class="at">cov =</span> Sigma[<span class="dv">1</span><span class="sc">:</span>N,<span class="dv">1</span><span class="sc">:</span>N])</span>
<span id="cb249-20"><a href="hazards.html#cb249-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb249-21"><a href="hazards.html#cb249-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {  <span class="co"># by child</span></span>
<span id="cb249-22"><a href="hazards.html#cb249-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logit</span>(p[j])  <span class="ot">&lt;-</span> b0 <span class="sc">+</span> <span class="fu">inprod</span>(b[<span class="dv">1</span><span class="sc">:</span>k], X[j,<span class="dv">1</span><span class="sc">:</span>k]) <span class="sc">+</span> S[index_village[j]]</span>
<span id="cb249-23"><a href="hazards.html#cb249-23" aria-hidden="true" tabindex="-1"></a>    y[j] <span class="sc">~</span> <span class="fu">dbern</span>(p[j])</span>
<span id="cb249-24"><a href="hazards.html#cb249-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb249-25"><a href="hazards.html#cb249-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-26"><a href="hazards.html#cb249-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (l <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb249-27"><a href="hazards.html#cb249-27" aria-hidden="true" tabindex="-1"></a>    b[l] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">5</span>)</span>
<span id="cb249-28"><a href="hazards.html#cb249-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb249-29"><a href="hazards.html#cb249-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb249-30"><a href="hazards.html#cb249-30" aria-hidden="true" tabindex="-1"></a>  b0 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">5</span>)</span>
<span id="cb249-31"><a href="hazards.html#cb249-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb249-32"><a href="hazards.html#cb249-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-33"><a href="hazards.html#cb249-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-34"><a href="hazards.html#cb249-34" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="hazards.html#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="co"># distance specification</span></span>
<span id="cb250-2"><a href="hazards.html#cb250-2" aria-hidden="true" tabindex="-1"></a>coords_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(malaria_village[,<span class="fu">c</span>(<span class="st">&quot;long&quot;</span>,<span class="st">&quot;lat&quot;</span>)], </span>
<span id="cb250-3"><a href="hazards.html#cb250-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;long&quot;</span>,<span class="st">&quot;lat&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb250-4"><a href="hazards.html#cb250-4" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_set_crs</span>(<span class="dv">4326</span>)</span>
<span id="cb250-5"><a href="hazards.html#cb250-5" aria-hidden="true" tabindex="-1"></a>obs_dist_mat <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_distance</span>(coords_sf)</span>
<span id="cb250-6"><a href="hazards.html#cb250-6" aria-hidden="true" tabindex="-1"></a>obs_dist_mat <span class="ot">&lt;-</span> units<span class="sc">::</span><span class="fu">set_units</span>(obs_dist_mat, km)</span>
<span id="cb250-7"><a href="hazards.html#cb250-7" aria-hidden="true" tabindex="-1"></a>obs_dist_mat <span class="ot">&lt;-</span> units<span class="sc">::</span><span class="fu">set_units</span>(obs_dist_mat, <span class="cn">NULL</span>)</span>
<span id="cb250-8"><a href="hazards.html#cb250-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-9"><a href="hazards.html#cb250-9" aria-hidden="true" tabindex="-1"></a><span class="co"># define indicator variables for each village</span></span>
<span id="cb250-10"><a href="hazards.html#cb250-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-11"><a href="hazards.html#cb250-11" aria-hidden="true" tabindex="-1"></a>gambia_df <span class="ot">&lt;-</span> <span class="fu">mutate</span>(</span>
<span id="cb250-12"><a href="hazards.html#cb250-12" aria-hidden="true" tabindex="-1"></a>  gambia,</span>
<span id="cb250-13"><a href="hazards.html#cb250-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">id_child =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(gambia), <span class="co"># add an id for each child</span></span>
<span id="cb250-14"><a href="hazards.html#cb250-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="dv">1</span>, <span class="co"># this will be needed later for the villages</span></span>
<span id="cb250-15"><a href="hazards.html#cb250-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">id_village =</span> <span class="fu">as.numeric</span>(<span class="fu">interaction</span>( <span class="co"># add an id for the villages</span></span>
<span id="cb250-16"><a href="hazards.html#cb250-16" aria-hidden="true" tabindex="-1"></a>    x, y, <span class="at">drop =</span> <span class="cn">TRUE</span>, <span class="at">lex.order =</span> <span class="cn">TRUE</span></span>
<span id="cb250-17"><a href="hazards.html#cb250-17" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb250-18"><a href="hazards.html#cb250-18" aria-hidden="true" tabindex="-1"></a>)  <span class="sc">|&gt;</span> </span>
<span id="cb250-19"><a href="hazards.html#cb250-19" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">spread</span>(id_area, value, <span class="at">fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb250-20"><a href="hazards.html#cb250-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">area1 =</span> <span class="st">&#39;1&#39;</span>, <span class="at">area2 =</span> <span class="st">&#39;2&#39;</span>, <span class="at">area3 =</span> <span class="st">&#39;3&#39;</span>, <span class="at">area4 =</span> <span class="st">&#39;4&#39;</span>, <span class="at">area5 =</span> <span class="st">&#39;5&#39;</span>)</span>
<span id="cb250-21"><a href="hazards.html#cb250-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-22"><a href="hazards.html#cb250-22" aria-hidden="true" tabindex="-1"></a><span class="do">## Model specification</span></span>
<span id="cb250-23"><a href="hazards.html#cb250-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Variables matrix</span></span>
<span id="cb250-24"><a href="hazards.html#cb250-24" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">age =</span> <span class="fu">scale</span>(gambia_df[,<span class="st">&quot;age&quot;</span>], <span class="at">center =</span> <span class="cn">TRUE</span>, <span class="at">scale =</span> <span class="cn">FALSE</span>),</span>
<span id="cb250-25"><a href="hazards.html#cb250-25" aria-hidden="true" tabindex="-1"></a>                <span class="at">netuse =</span> gambia_df[,<span class="st">&quot;netuse&quot;</span>],</span>
<span id="cb250-26"><a href="hazards.html#cb250-26" aria-hidden="true" tabindex="-1"></a>                <span class="at">treated =</span> gambia_df[,<span class="st">&quot;treated&quot;</span>],</span>
<span id="cb250-27"><a href="hazards.html#cb250-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">green =</span> <span class="fu">scale</span>(gambia_df[,<span class="st">&quot;green&quot;</span>], <span class="at">center =</span> <span class="cn">TRUE</span>, <span class="at">scale =</span> <span class="cn">FALSE</span>),</span>
<span id="cb250-28"><a href="hazards.html#cb250-28" aria-hidden="true" tabindex="-1"></a>                <span class="at">phc =</span> gambia_df[,<span class="st">&quot;phc&quot;</span>],</span>
<span id="cb250-29"><a href="hazards.html#cb250-29" aria-hidden="true" tabindex="-1"></a>                <span class="at">area2 =</span> gambia_df[,<span class="st">&quot;area2&quot;</span>],</span>
<span id="cb250-30"><a href="hazards.html#cb250-30" aria-hidden="true" tabindex="-1"></a>                <span class="at">area3 =</span> gambia_df[,<span class="st">&quot;area3&quot;</span>],</span>
<span id="cb250-31"><a href="hazards.html#cb250-31" aria-hidden="true" tabindex="-1"></a>                <span class="at">area4 =</span> gambia_df[,<span class="st">&quot;area4&quot;</span>],</span>
<span id="cb250-32"><a href="hazards.html#cb250-32" aria-hidden="true" tabindex="-1"></a>                <span class="at">area5 =</span> gambia_df[,<span class="st">&quot;area5&quot;</span>]</span>
<span id="cb250-33"><a href="hazards.html#cb250-33" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb250-34"><a href="hazards.html#cb250-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-35"><a href="hazards.html#cb250-35" aria-hidden="true" tabindex="-1"></a>index_village <span class="ot">&lt;-</span> gambia_df[,<span class="st">&quot;id_village&quot;</span>]</span>
<span id="cb250-36"><a href="hazards.html#cb250-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-37"><a href="hazards.html#cb250-37" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X) <span class="co"># child number</span></span>
<span id="cb250-38"><a href="hazards.html#cb250-38" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(malaria_village) <span class="co"># number of villages</span></span>
<span id="cb250-39"><a href="hazards.html#cb250-39" aria-hidden="true" tabindex="-1"></a>zeroes <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, N) <span class="co"># auxiliary vector of zeroes for model</span></span>
<span id="cb250-40"><a href="hazards.html#cb250-40" aria-hidden="true" tabindex="-1"></a>ones <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, N)</span>
<span id="cb250-41"><a href="hazards.html#cb250-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-42"><a href="hazards.html#cb250-42" aria-hidden="true" tabindex="-1"></a>const_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">n =</span> n, <span class="co"># number of childs</span></span>
<span id="cb250-43"><a href="hazards.html#cb250-43" aria-hidden="true" tabindex="-1"></a>                   <span class="at">N =</span> N, <span class="co"># number of villages</span></span>
<span id="cb250-44"><a href="hazards.html#cb250-44" aria-hidden="true" tabindex="-1"></a>                   <span class="at">zeroes =</span> zeroes, <span class="co"># vector of zeroes </span></span>
<span id="cb250-45"><a href="hazards.html#cb250-45" aria-hidden="true" tabindex="-1"></a>                   <span class="at">prior_max_dist =</span> <span class="fu">max</span>(obs_dist_mat)<span class="sc">/</span><span class="dv">6</span>, <span class="co"># max dist for phi prior</span></span>
<span id="cb250-46"><a href="hazards.html#cb250-46" aria-hidden="true" tabindex="-1"></a>                   <span class="at">k =</span>  <span class="fu">ncol</span>(X),<span class="co"># number of predictors</span></span>
<span id="cb250-47"><a href="hazards.html#cb250-47" aria-hidden="true" tabindex="-1"></a>                   <span class="at">index_village =</span> index_village,</span>
<span id="cb250-48"><a href="hazards.html#cb250-48" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Id10 =</span> <span class="dv">10</span><span class="sc">*</span><span class="fu">diag</span>(N)) </span>
<span id="cb250-49"><a href="hazards.html#cb250-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-50"><a href="hazards.html#cb250-50" aria-hidden="true" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> gambia_df<span class="sc">$</span>pos, <span class="co"># malaria positive test </span></span>
<span id="cb250-51"><a href="hazards.html#cb250-51" aria-hidden="true" tabindex="-1"></a>                 <span class="at">obs_dist_mat =</span> obs_dist_mat, <span class="co"># distance matrix in km</span></span>
<span id="cb250-52"><a href="hazards.html#cb250-52" aria-hidden="true" tabindex="-1"></a>                 <span class="at">X =</span> X <span class="co"># predictors matrix</span></span>
<span id="cb250-53"><a href="hazards.html#cb250-53" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb250-54"><a href="hazards.html#cb250-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-55"><a href="hazards.html#cb250-55" aria-hidden="true" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">sigma =</span> <span class="fl">0.5</span>, </span>
<span id="cb250-56"><a href="hazards.html#cb250-56" aria-hidden="true" tabindex="-1"></a>                  <span class="at">p =</span> <span class="fu">rep</span>(<span class="fu">expit</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)), n), </span>
<span id="cb250-57"><a href="hazards.html#cb250-57" aria-hidden="true" tabindex="-1"></a>                  <span class="at">phi_inv =</span> <span class="dv">6</span><span class="sc">/</span><span class="fu">max</span>(obs_dist_mat),</span>
<span id="cb250-58"><a href="hazards.html#cb250-58" aria-hidden="true" tabindex="-1"></a>                  <span class="at">b =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">ncol</span>(X)), </span>
<span id="cb250-59"><a href="hazards.html#cb250-59" aria-hidden="true" tabindex="-1"></a>                  <span class="at">b0 =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb250-60"><a href="hazards.html#cb250-60" aria-hidden="true" tabindex="-1"></a>                  <span class="at">S =</span> <span class="fu">rnorm</span>(N, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb250-61"><a href="hazards.html#cb250-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-62"><a href="hazards.html#cb250-62" aria-hidden="true" tabindex="-1"></a><span class="co">#init_list &lt;- list(p = runif(n, 0, 1), b = rnorm(ncol(X), 0,  1), b0 = rnorm(1, 0, 1))</span></span>
<span id="cb250-63"><a href="hazards.html#cb250-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-64"><a href="hazards.html#cb250-64" aria-hidden="true" tabindex="-1"></a>Rmodel <span class="ot">&lt;-</span></span>
<span id="cb250-65"><a href="hazards.html#cb250-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nimbleModel</span>(</span>
<span id="cb250-66"><a href="hazards.html#cb250-66" aria-hidden="true" tabindex="-1"></a>    Example10_14_Nimble,</span>
<span id="cb250-67"><a href="hazards.html#cb250-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> const_list,</span>
<span id="cb250-68"><a href="hazards.html#cb250-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat_list,</span>
<span id="cb250-69"><a href="hazards.html#cb250-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> init_list</span>
<span id="cb250-70"><a href="hazards.html#cb250-70" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb250-71"><a href="hazards.html#cb250-71" aria-hidden="true" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">initializeInfo</span>()</span>
<span id="cb250-72"><a href="hazards.html#cb250-72" aria-hidden="true" tabindex="-1"></a>Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span>
<span id="cb250-73"><a href="hazards.html#cb250-73" aria-hidden="true" tabindex="-1"></a>conf <span class="ot">&lt;-</span></span>
<span id="cb250-74"><a href="hazards.html#cb250-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">configureMCMC</span>(Rmodel, <span class="at">monitors =</span> <span class="fu">c</span>( <span class="st">&quot;b0&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;p&quot;</span>, <span class="st">&quot;S&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>))</span>
<span id="cb250-75"><a href="hazards.html#cb250-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-76"><a href="hazards.html#cb250-76" aria-hidden="true" tabindex="-1"></a><span class="co"># conf$removeSamplers(c(&#39;S&#39;))</span></span>
<span id="cb250-77"><a href="hazards.html#cb250-77" aria-hidden="true" tabindex="-1"></a><span class="co"># conf$addSampler(target = c(&#39;S&#39;), type = &#39;AF_slice&#39;)</span></span>
<span id="cb250-78"><a href="hazards.html#cb250-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb250-79"><a href="hazards.html#cb250-79" aria-hidden="true" tabindex="-1"></a>Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf)</span>
<span id="cb250-80"><a href="hazards.html#cb250-80" aria-hidden="true" tabindex="-1"></a>Cmcmc <span class="ot">&lt;-</span></span>
<span id="cb250-81"><a href="hazards.html#cb250-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compileNimble</span>(</span>
<span id="cb250-82"><a href="hazards.html#cb250-82" aria-hidden="true" tabindex="-1"></a>    Rmcmc,</span>
<span id="cb250-83"><a href="hazards.html#cb250-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">project =</span> Cmodel,</span>
<span id="cb250-84"><a href="hazards.html#cb250-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">resetFunctions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb250-85"><a href="hazards.html#cb250-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">showCompilerOutput =</span> <span class="cn">TRUE</span></span>
<span id="cb250-86"><a href="hazards.html#cb250-86" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb250-87"><a href="hazards.html#cb250-87" aria-hidden="true" tabindex="-1"></a>niters <span class="ot">&lt;-</span> <span class="dv">80000</span></span>
<span id="cb250-88"><a href="hazards.html#cb250-88" aria-hidden="true" tabindex="-1"></a>nburnins <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> niters</span>
<span id="cb250-89"><a href="hazards.html#cb250-89" aria-hidden="true" tabindex="-1"></a>nchains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb250-90"><a href="hazards.html#cb250-90" aria-hidden="true" tabindex="-1"></a>nthins <span class="ot">&lt;-</span> <span class="dv">14</span></span>
<span id="cb250-91"><a href="hazards.html#cb250-91" aria-hidden="true" tabindex="-1"></a>post_samples <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb250-92"><a href="hazards.html#cb250-92" aria-hidden="true" tabindex="-1"></a>  Cmcmc,</span>
<span id="cb250-93"><a href="hazards.html#cb250-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> niters,</span>
<span id="cb250-94"><a href="hazards.html#cb250-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> nburnins,</span>
<span id="cb250-95"><a href="hazards.html#cb250-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> nthins,</span>
<span id="cb250-96"><a href="hazards.html#cb250-96" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> nchains,</span>
<span id="cb250-97"><a href="hazards.html#cb250-97" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb250-98"><a href="hazards.html#cb250-98" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span></span>
<span id="cb250-99"><a href="hazards.html#cb250-99" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="hazards.html#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b0&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b0&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-1.png" width="672" /></p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="hazards.html#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[1]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b[1]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-2.png" width="672" /></p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="hazards.html#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[2]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b[2]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-3.png" width="672" /></p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="hazards.html#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[3]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b[3]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-4.png" width="672" /></p>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="hazards.html#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[4]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b[4]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-5.png" width="672" /></p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="hazards.html#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[5]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b[5]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-6.png" width="672" /></p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="hazards.html#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[6]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b[6]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-7.png" width="672" /></p>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="hazards.html#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;sigma&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;sigma&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-8.png" width="672" /></p>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="hazards.html#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;phi&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-9.png" width="672" /></p>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="hazards.html#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;S[1]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;S[1]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-10.png" width="672" /></p>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="hazards.html#cb261-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;S[24]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;S[24]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-11.png" width="672" /></p>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="hazards.html#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;S[54]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;S[54]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-12.png" width="672" /></p>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="hazards.html#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;p[1]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;p[1]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-13.png" width="672" /></p>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="hazards.html#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;p[1805]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;p[1805]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-14.png" width="672" /></p>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="hazards.html#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get minimum effective size (ESS) and which variable has the min ESS</span></span>
<span id="cb265-2"><a href="hazards.html#cb265-2" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(post_samples<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 121.2351</code></pre>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="hazards.html#cb267-1" aria-hidden="true" tabindex="-1"></a>mcmc_variable_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(post_samples<span class="sc">$</span>samples<span class="sc">$</span>chain1)</span>
<span id="cb267-2"><a href="hazards.html#cb267-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-3"><a href="hazards.html#cb267-3" aria-hidden="true" tabindex="-1"></a>mcmc_variable_names[<span class="fu">which</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(post_samples<span class="sc">$</span>samples) <span class="sc">==</span> <span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(post_samples<span class="sc">$</span>samples)))]</span></code></pre></div>
<pre><code>## [1] &quot;b[7]&quot;</code></pre>
<div class="sourceCode" id="cb269"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb269-1"><a href="hazards.html#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb269-2"><a href="hazards.html#cb269-2" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;b0&quot;</span>, <span class="st">&quot;b[1]&quot;</span>, <span class="st">&quot;b[2]&quot;</span>, <span class="st">&quot;b[3]&quot;</span>, <span class="st">&quot;b[4]&quot;</span>, <span class="st">&quot;b[5]&quot;</span>, <span class="st">&quot;b[6]&quot;</span>, <span class="st">&quot;b[7]&quot;</span>, <span class="st">&quot;b[8]&quot;</span>, <span class="st">&quot;b[9]&quot;</span> ,<span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>)</span>
<span id="cb269-3"><a href="hazards.html#cb269-3" aria-hidden="true" tabindex="-1"></a>summary_nimble <span class="ot">&lt;-</span> post_samples<span class="sc">$</span>summary<span class="sc">$</span>all.chains</span>
<span id="cb269-4"><a href="hazards.html#cb269-4" aria-hidden="true" tabindex="-1"></a>summary_nimble[variables,]</span></code></pre></div>
<pre><code>##                Mean        Median      St.Dev.     95%CI_low
## b0     0.3315201138  0.3392450269 0.2505843962 -0.1729623331
## b[1]   0.0006860043  0.0006835488 0.0001234595  0.0004431429
## b[2]  -0.3896279125 -0.3888672550 0.1560999545 -0.7048920797
## b[3]  -0.3757735359 -0.3769547462 0.2116118487 -0.7882866024
## b[4]   0.0442854311  0.0440496333 0.0178257390  0.0087224925
## b[5]  -0.2100219775 -0.2056276065 0.2483450907 -0.7052031402
## b[6]  -0.5000700991 -0.4943813970 0.3424221174 -1.2308098244
## b[7]  -1.3233823781 -1.3263073092 0.2858536435 -1.8703937606
## b[8]  -0.7908411531 -0.7987714491 0.4042487749 -1.5835167007
## b[9]   0.0352274728  0.0345586394 0.4167655576 -0.7596146680
## sigma  0.7364758452  0.7317618930 0.1031994687  0.5487828612
## phi    1.2621830848  1.1370656814 0.5930172725  0.5070952884
##           95%CI_upp
## b0     0.8081442858
## b[1]   0.0009273262
## b[2]  -0.0819548994
## b[3]   0.0385847122
## b[4]   0.0792046195
## b[5]   0.2462629975
## b[6]   0.1291118929
## b[7]  -0.7468568056
## b[8]   0.0305095920
## b[9]   0.8762673597
## sigma  0.9489075739
## phi    2.7332364751</code></pre>
<div class="sourceCode" id="cb271"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb271-1"><a href="hazards.html#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot posterior summary for the spatial random effect by village</span></span>
<span id="cb271-2"><a href="hazards.html#cb271-2" aria-hidden="true" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> post_samples<span class="sc">$</span>summary<span class="sc">$</span>all.chains</span>
<span id="cb271-3"><a href="hazards.html#cb271-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-4"><a href="hazards.html#cb271-4" aria-hidden="true" tabindex="-1"></a>post_sum_S <span class="ot">&lt;-</span></span>
<span id="cb271-5"><a href="hazards.html#cb271-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(post_summary) <span class="sc">|&gt;</span>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb271-6"><a href="hazards.html#cb271-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(rowname, <span class="st">&quot;S&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb271-7"><a href="hazards.html#cb271-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(rowname, <span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>, Mean, <span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>)  <span class="sc">|&gt;</span></span>
<span id="cb271-8"><a href="hazards.html#cb271-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">village =</span> <span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, rowname))</span>
<span id="cb271-9"><a href="hazards.html#cb271-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-10"><a href="hazards.html#cb271-10" aria-hidden="true" tabindex="-1"></a>post_sum_S<span class="sc">$</span>village <span class="ot">&lt;-</span></span>
<span id="cb271-11"><a href="hazards.html#cb271-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">factor</span>(post_sum_S<span class="sc">$</span>village , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>)</span>
<span id="cb271-12"><a href="hazards.html#cb271-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-13"><a href="hazards.html#cb271-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_S, <span class="fu">aes</span>(<span class="at">x =</span> village)) <span class="sc">+</span></span>
<span id="cb271-14"><a href="hazards.html#cb271-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>, <span class="at">ymax =</span> <span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>, <span class="at">y =</span> Mean)) <span class="sc">+</span></span>
<span id="cb271-15"><a href="hazards.html#cb271-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>) <span class="sc">+</span></span>
<span id="cb271-16"><a href="hazards.html#cb271-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(</span>
<span id="cb271-17"><a href="hazards.html#cb271-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> post_sum_S<span class="sc">$</span>village[<span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(post_sum_S<span class="sc">$</span>village), <span class="at">by =</span> <span class="dv">5</span>)]) <span class="sc">+</span></span>
<span id="cb271-18"><a href="hazards.html#cb271-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;village&quot;</span>) <span class="sc">+</span></span>
<span id="cb271-19"><a href="hazards.html#cb271-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Posterior summary spatial random effect by village&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20summary%20p-1.png" width="672" /></p>
</div>
<div id="stan-6" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="hazards.html#stan-6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<pre><code>data {
  int&lt;lower=1&gt; n; //  number of children
  int&lt;lower=1&gt; k; // number of covariates
  int N; //  total number of villages
  int y[n]; //  tests
  matrix[N,N] dist_matrix; //  distance matrix
  matrix[n, k] X; // matrix with covariates
  int index_village[n];
}

parameters {
  real&lt;lower=0&gt; phi_inv;
  real&lt;lower=0&gt; sigma;
  vector[N] S; // spatial random effect
  vector[k] betas;
  real beta0;
}

transformed parameters {
  // vector[n] p = inv_logit(logit_p);
  real sigma_sq = square(sigma);
  real&lt;lower=0&gt; phi = 1/phi_inv;
}

model {
  matrix[N, N] L;
  matrix[N, N] Sigma;
  vector[N] zeroes; // vector of zeroes
  vector[n] logit_p;

 for(i in 1:(N-1)){
   for(j in (i+1):N){
     //Sigma[i,j] = sigma_sq*exp(-dist_matrix[i,j]/phi);
     Sigma[i,j] = sigma_sq*(1 + (sqrt(3)*dist_matrix[i,j])/phi) * exp(-sqrt(3)*dist_matrix[i,j] / phi);
     Sigma[j,i] = Sigma[i,j];
   }
 }
   // diagonal elements covariances
for(i in 1:N){
  Sigma[i,i] = sigma_sq;
}

// sample spatial random effect
  L = cholesky_decompose(Sigma);
  zeroes = rep_vector(0, N);
  S ~ multi_normal_cholesky(zeroes, L);

  for(i in 1:n) {
    logit_p[i] = beta0 + X[i,]*betas + S[index_village[i]];
    y[i] ~ binomial_logit(1, logit_p[i]);
  }

  beta0 ~ normal(0,10);
  betas ~ normal(0,10);
  phi_inv ~ gamma(5, 5);
  sigma ~ cauchy(0,1);
  

}</code></pre>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="hazards.html#cb273-1" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>( <span class="at">n =</span> <span class="fu">nrow</span>(gambia), <span class="co"># number of children</span></span>
<span id="cb273-2"><a href="hazards.html#cb273-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">k =</span> <span class="fu">ncol</span>(X), <span class="co"># number of covariates</span></span>
<span id="cb273-3"><a href="hazards.html#cb273-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">N =</span> N, <span class="co"># number of villages</span></span>
<span id="cb273-4"><a href="hazards.html#cb273-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">y =</span> gambia<span class="sc">$</span>pos, <span class="co"># positive tests</span></span>
<span id="cb273-5"><a href="hazards.html#cb273-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">dist_matrix =</span> obs_dist_mat, <span class="co"># distance matrix in km</span></span>
<span id="cb273-6"><a href="hazards.html#cb273-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">X =</span> X, <span class="co"># altitude per village</span></span>
<span id="cb273-7"><a href="hazards.html#cb273-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">index_village =</span> index_village</span>
<span id="cb273-8"><a href="hazards.html#cb273-8" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb273-9"><a href="hazards.html#cb273-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-10"><a href="hazards.html#cb273-10" aria-hidden="true" tabindex="-1"></a>Example10_14Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb273-11"><a href="hazards.html#cb273-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example10_14.stan&quot;</span>,</span>
<span id="cb273-12"><a href="hazards.html#cb273-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb273-13"><a href="hazards.html#cb273-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">15000</span>,</span>
<span id="cb273-14"><a href="hazards.html#cb273-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">30000</span>,</span>
<span id="cb273-15"><a href="hazards.html#cb273-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb273-16"><a href="hazards.html#cb273-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb273-17"><a href="hazards.html#cb273-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;betas&quot;</span>,<span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;S&quot;</span>),</span>
<span id="cb273-18"><a href="hazards.html#cb273-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb273-19"><a href="hazards.html#cb273-19" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb274-1"><a href="hazards.html#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="co">#computing WAIC using the package loo</span></span>
<span id="cb274-2"><a href="hazards.html#cb274-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb274-3"><a href="hazards.html#cb274-3" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example10_14Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;betas&quot;</span>,<span class="st">&quot;sigma&quot;</span>,  <span class="st">&quot;phi&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20stan%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb275"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb275-1"><a href="hazards.html#cb275-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb275-2"><a href="hazards.html#cb275-2" aria-hidden="true" tabindex="-1"></a>summary_stan <span class="ot">&lt;-</span></span>
<span id="cb275-3"><a href="hazards.html#cb275-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb275-4"><a href="hazards.html#cb275-4" aria-hidden="true" tabindex="-1"></a>    Example10_14Stan,</span>
<span id="cb275-5"><a href="hazards.html#cb275-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;betas&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>),</span>
<span id="cb275-6"><a href="hazards.html#cb275-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb275-7"><a href="hazards.html#cb275-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb275-8"><a href="hazards.html#cb275-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb275-9"><a href="hazards.html#cb275-9" aria-hidden="true" tabindex="-1"></a>summary_stan<span class="sc">$</span>summary</span></code></pre></div>
<pre><code>##                   mean      se_mean           sd          2.5%
## beta0     0.3458755538 4.778216e-03 0.2510986221 -0.1362639241
## betas[1]  0.0006871207 2.273556e-06 0.0001224843  0.0004482812
## betas[2] -0.3937790344 2.994197e-03 0.1630352170 -0.7217402843
## betas[3] -0.3690088984 3.969896e-03 0.2141993706 -0.7771861338
## betas[4]  0.0441686717 3.655065e-04 0.0204927583  0.0038759447
## betas[5] -0.2188864063 4.524898e-03 0.2445430055 -0.6915407489
## betas[6] -0.5146223013 7.075673e-03 0.3790193760 -1.2623443596
## betas[7] -1.3569507901 5.737837e-03 0.3113742252 -1.9752438918
## betas[8] -0.8086446199 7.945203e-03 0.4441463825 -1.6942523608
## betas[9]  0.0102733351 8.134941e-03 0.4361173159 -0.8699648369
## sigma     0.7474663299 2.086654e-03 0.1094484302  0.5576156752
## phi       1.2278687030 1.059571e-02 0.5680543393  0.5086054757
##                  97.5%    n_eff      Rhat
## beta0     0.8442035273 2761.576 0.9994923
## betas[1]  0.0009307211 2902.347 0.9995322
## betas[2] -0.0793440251 2964.847 0.9994596
## betas[3]  0.0585086866 2911.241 0.9993715
## betas[4]  0.0849912336 3143.479 1.0007034
## betas[5]  0.2553282584 2920.740 0.9994372
## betas[6]  0.2154029130 2869.375 0.9999332
## betas[7] -0.7549112373 2944.889 0.9995635
## betas[8]  0.0389549590 3124.944 0.9998981
## betas[9]  0.8558910589 2874.074 0.9998750
## sigma     0.9798656966 2751.176 0.9995793
## phi       2.6412794837 2874.216 0.9995888</code></pre>
<div class="sourceCode" id="cb277"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb277-1"><a href="hazards.html#cb277-1" aria-hidden="true" tabindex="-1"></a>S_summary <span class="ot">&lt;-</span></span>
<span id="cb277-2"><a href="hazards.html#cb277-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(Example10_14Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;S&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb277-3"><a href="hazards.html#cb277-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-4"><a href="hazards.html#cb277-4" aria-hidden="true" tabindex="-1"></a>S_summary_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(S_summary) <span class="sc">|&gt;</span></span>
<span id="cb277-5"><a href="hazards.html#cb277-5" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb277-6"><a href="hazards.html#cb277-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;S[&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>, <span class="st">&quot;]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb277-7"><a href="hazards.html#cb277-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">village =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>) <span class="sc">|&gt;</span></span>
<span id="cb277-8"><a href="hazards.html#cb277-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(mean,  X2.<span class="fl">5.</span>, X97.<span class="fl">5.</span>, village)</span>
<span id="cb277-9"><a href="hazards.html#cb277-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-10"><a href="hazards.html#cb277-10" aria-hidden="true" tabindex="-1"></a>S_summary_df<span class="sc">$</span>village <span class="ot">&lt;-</span></span>
<span id="cb277-11"><a href="hazards.html#cb277-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">factor</span>(S_summary_df<span class="sc">$</span>village , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>)</span>
<span id="cb277-12"><a href="hazards.html#cb277-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-13"><a href="hazards.html#cb277-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-14"><a href="hazards.html#cb277-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(S_summary_df, <span class="fu">aes</span>(<span class="at">x =</span> village, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb277-15"><a href="hazards.html#cb277-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>, <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb277-16"><a href="hazards.html#cb277-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>) <span class="sc">+</span></span>
<span id="cb277-17"><a href="hazards.html#cb277-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(</span>
<span id="cb277-18"><a href="hazards.html#cb277-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> S_summary_df<span class="sc">$</span>village[<span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(S_summary_df<span class="sc">$</span>village), <span class="at">by =</span> <span class="dv">5</span>)]) <span class="sc">+</span></span>
<span id="cb277-19"><a href="hazards.html#cb277-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;village&quot;</span>) <span class="sc">+</span></span>
<span id="cb277-20"><a href="hazards.html#cb277-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Posterior summary spatial random effect by village&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20stan%20posterior%20plots-1.png" width="672" /></p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="Disease.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="Time.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/10-Chpt10.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
