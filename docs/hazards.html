<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 10 Environmental hazards-spatial models | Spatio-Temporal Methods in Environmental Epidemiology with R</title>
  <meta name="description" content="Chapter 10 Environmental hazards-spatial models | Spatio-Temporal Methods in Environmental Epidemiology with R" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 10 Environmental hazards-spatial models | Spatio-Temporal Methods in Environmental Epidemiology with R" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/img/cover.jpg" />
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 10 Environmental hazards-spatial models | Spatio-Temporal Methods in Environmental Epidemiology with R" />
  
  
  <meta name="twitter:image" content="/img/cover.jpg" />

<meta name="author" content="Gavin Shaddick, James V. Zidek, and Alexandra M. Schmidt" />


<meta name="date" content="2023-07-05" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<link rel="prev" href="Disease.html"/>
<link rel="next" href="Time.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatio-temporal methods in environmental epidemiology</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="preface-2nd-edition.html"><a href="preface-2nd-edition.html"><i class="fa fa-check"></i>Preface (2nd edition)</a></li>
<li class="chapter" data-level="1" data-path="why.html"><a href="why.html"><i class="fa fa-check"></i><b>1</b> Why spatio-temporal epidemiology?</a></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> Epidemiology-the basics</a>
<ul>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.7-estimating-the-smr-using-a-poisson-glm"><i class="fa fa-check"></i>Example 2.7: Estimating the SMR using a Poisson GLM</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.8-estimating-the-smr-using-quasi-likelihood"><i class="fa fa-check"></i>Example 2.8: Estimating the SMR using quasi-likelihood</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.9-modelling-differences-in-smrs-in-relation-to-differences-in-exposures"><i class="fa fa-check"></i>Example 2.9: Modelling differences in SMRs in relation to differences in exposures</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.10-modelling-the-risks-associated-with-lagged-effects-of-air-pollution"><i class="fa fa-check"></i>Example 2.10: Modelling the risks associated with lagged effects of air pollution</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.10-estimating-the-odds-ratio-in-a-case-control-study-using-a-logistic-model"><i class="fa fa-check"></i>Example 2.10: Estimating the odds ratio in a case-control study using a logistic model</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.11-estimating-the-odds-ratio-of-asthma-associated-with-proximity-to-roads"><i class="fa fa-check"></i>Example 2.11: Estimating the odds ratio of asthma associated with proximity to roads</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="uncertainty.html"><a href="uncertainty.html"><i class="fa fa-check"></i><b>3</b> Uncertainty and its reduction</a>
<ul>
<li class="chapter" data-level="" data-path="uncertainty.html"><a href="uncertainty.html#supplementary-material"><i class="fa fa-check"></i>Supplementary Material</a>
<ul>
<li class="chapter" data-level="" data-path="uncertainty.html"><a href="uncertainty.html#more-on-qualitative-uncertainty"><i class="fa fa-check"></i>More on qualitative uncertainty</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>4</b> Data: increasing information and reducing uncertainty</a>
<ul>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#getting-to-know-the-structure-of-dataframes"><i class="fa fa-check"></i>Getting to know the structure of dataframes</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#extracting-and-creating-variables"><i class="fa fa-check"></i>Extracting and creating variables</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="embracing.html"><a href="embracing.html"><i class="fa fa-check"></i><b>5</b> Embracing uncertainty: the Bayesian approach</a></li>
<li class="chapter" data-level="6" data-path="tactics.html"><a href="tactics.html"><i class="fa fa-check"></i><b>6</b> Tactics-implementing uncertainty models</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.2-chronic-obstructive-pulmonary-disease-copd-in-england"><i class="fa fa-check"></i>Example 6.2: Chronic obstructive pulmonary disease (COPD) in England</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-the-raw-standardized-mortality-rates-smrs"><i class="fa fa-check"></i>Modelling the raw standardized mortality rates (SMRs)</a></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-a-poisson-gamma-with-an-mcmc-implemented-in-r"><i class="fa fa-check"></i>Modelling a Poisson-Gamma with an MCMC implemented in <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.3-fitting-a-poisson-regression-model"><i class="fa fa-check"></i>Example 6.3: Fitting a Poisson regression model</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#nimble"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#stan"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Strategies.html"><a href="Strategies.html"><i class="fa fa-check"></i><b>7</b> Strategies implementing uncertainty models</a>
<ul>
<li class="chapter" data-level="" data-path="Strategies.html"><a href="Strategies.html#example-7.6-model-choice-in-studies-of-air-pollution-and-health"><i class="fa fa-check"></i>Example 7.6 Model choice in studies of air pollution and health</a>
<ul>
<li class="chapter" data-level="" data-path="Strategies.html"><a href="Strategies.html#nimble-1"><i class="fa fa-check"></i>Nimble</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="trusted.html"><a href="trusted.html"><i class="fa fa-check"></i><b>8</b> But can the data be trusted</a>
<ul>
<li class="chapter" data-level="" data-path="trusted.html"><a href="trusted.html#solutions-to-selected-exercises"><i class="fa fa-check"></i>Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="trusted.html"><a href="trusted.html#placeholder-repeat-the-black-smoke-analysis-conducted-in-watson-et-al.-2019.-in-the-naive-model."><i class="fa fa-check"></i>PLACEHOLDER: Repeat the Black Smoke analysis conducted in Watson et al. 2019. in the “naive” model.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="Disease.html"><a href="Disease.html"><i class="fa fa-check"></i><b>9</b> Disease-spatial patterns</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010"><i class="fa fa-check"></i>Example 9.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-2"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-1"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-stan"><i class="fa fa-check"></i>Example 9.3: Fitting a conditional spatial model in <code>nimble</code> and <code>stan</code></a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-3"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-2"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.4-fitting-a-conditional-spatial-model-using-carbayes"><i class="fa fa-check"></i>Example 9.4: Fitting a conditional spatial model using CARBayes</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.5-fitting-a-conditional-model-using-inla"><i class="fa fa-check"></i>Example 9.5: Fitting a conditional model using INLA</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="hazards.html"><a href="hazards.html"><i class="fa fa-check"></i><b>10</b> Environmental hazards-spatial models</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.1-spatial-patterns-in-lead-concentrations-in-the-soil-of-the-meuse-river-flood-plain"><i class="fa fa-check"></i>Example 10.1 Spatial patterns in lead concentrations in the soil of the Meuse River flood plain</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.2-examining-the-log-concentrations-of-lead-in-the-meuse-river-flood-plain"><i class="fa fa-check"></i>Example 10.2: Examining the log concentrations of lead in the Meuse River flood plain</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state"><i class="fa fa-check"></i>Example 10.3: Mapping the locations of ozone monitoring sites in New York State</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.6-spatial-prediction-of-temperatures-in-california"><i class="fa fa-check"></i>Example 10.6: Spatial prediction of temperatures in California</a></li>
<li class="chapter" data-level="10.1" data-path="hazards.html"><a href="hazards.html#example-10.8-spatial-prediction-of-no2-in-europe"><i class="fa fa-check"></i><b>10.1</b> Example 10.8 Spatial prediction of NO2 in Europe</a></li>
<li class="chapter" data-level="10.2" data-path="hazards.html"><a href="hazards.html#example-10.12-plotting-directional-variograms-for-temperatures-in-california"><i class="fa fa-check"></i><b>10.2</b> Example 10.12 Plotting directional variograms for temperatures in California</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.14-spatial-modeling-of-malaria-in-gambia"><i class="fa fa-check"></i>Example 10.14: Spatial modeling of malaria in Gambia</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-4"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-3"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#supplementary-material-1"><i class="fa fa-check"></i>Supplementary Material</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada"><i class="fa fa-check"></i>Extra 10.1: Spatial patterns of benzene concentrations in Montreal, QC, Canada</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.2-examining-the-log-concentrations-of-benzene-in-montreal"><i class="fa fa-check"></i>Extra 10.2: Examining the log concentrations of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.5-variogram"><i class="fa fa-check"></i>Extra 10.5: Variogram</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal"><i class="fa fa-check"></i>Extra 10.6 Basic spatial modelling and prediction of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.8-spatial-modelling-of-benzene-in-montreal"><i class="fa fa-check"></i>Extra 10.8 Spatial modelling of Benzene in Montreal</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-5"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-4"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.9-spatial-predictions"><i class="fa fa-check"></i>Extra 10.9: Spatial predictions</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-6"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-5"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.10-inla-creating-a-mesh"><i class="fa fa-check"></i>Extra 10.10: INLA, creating a mesh</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal"><i class="fa fa-check"></i>Extra 10.12: Fitting an SPDE model using R–INLA: benzene concentration in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.13-directional-variograms"><i class="fa fa-check"></i>Extra 10.13: Directional variograms</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="Time.html"><a href="Time.html"><i class="fa fa-check"></i><b>11</b> Time-why it also matters</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.1-ground-level-ozone-concentrations"><i class="fa fa-check"></i>Example 11.1 Ground level ozone concentrations</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.2-low-pass-filtering-of-carbon-monoxide-levels-using-the-moving-average"><i class="fa fa-check"></i>Example 11.2 Low-pass filtering of carbon monoxide levels using the moving average</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.13-forecasting-ozone-levels"><i class="fa fa-check"></i>Example 11.13 Forecasting ozone levels</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.14-forecasting-volcanic-ash"><i class="fa fa-check"></i>Example 11.14 Forecasting volcanic ash</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="exposure.html"><a href="exposure.html"><i class="fa fa-check"></i><b>12</b> Exposure assessment-over space and time</a>
<ul>
<li class="chapter" data-level="" data-path="exposure.html"><a href="exposure.html#example-idk-spatio-temporal-model-for-the-uk-ozone-data"><i class="fa fa-check"></i>Example IDK: Spatio-temporal model for the UK ozone data</a>
<ul>
<li class="chapter" data-level="" data-path="exposure.html"><a href="exposure.html#nimble-7"><i class="fa fa-check"></i>Nimble</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="causality.html"><a href="causality.html"><i class="fa fa-check"></i><b>13</b> Causality-roadblocks on the way to it</a>
<ul>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#solutions-to-selected-exercises-1"><i class="fa fa-check"></i>Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.16-load-the-italy-and-china-data-described-in-example-13.3-and-included-in-the-supplementary-bookdown-material-into-r."><i class="fa fa-check"></i>Question 13.16: Load the Italy and China data, described in Example 13.3, and included in the supplementary Bookdown material into R.</a></li>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.17-using-the-italy-and-china-data-stratified-by-the-age-groups-70-and-geq-70-obtain-empirical-estimates-of-p_1-and-p_2-as-defined-in-an-sdis.-in-the-following-questions-assume-that-p_1-and-p_2-are-the-population-values."><i class="fa fa-check"></i>Question 13.17: Using the Italy and China data stratified by the age groups <span class="math inline">\(&lt;70\)</span> and <span class="math inline">\(\geq 70\)</span>, obtain empirical estimates of <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span>, as defined in an SDis. In the following questions, assume that <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> are the population values.</a></li>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.18-stratify-the-italy-and-china-data-by-the-age-groups-50-and-geq-50.-display-the-corresponding-contingency-tables."><i class="fa fa-check"></i>Question 13.18: Stratify the Italy and China data by the age groups <span class="math inline">\(&lt;50\)</span> and <span class="math inline">\(\geq 50\)</span>. Display the corresponding contingency tables.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="monitoring.html"><a href="monitoring.html"><i class="fa fa-check"></i><b>14</b> Better monitoring network design-getting better measurements</a></li>
<li class="chapter" data-level="15" data-path="frontiers.html"><a href="frontiers.html"><i class="fa fa-check"></i><b>15</b> Current frontiers</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html"><i class="fa fa-check"></i>Course</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatio-Temporal Methods in Environmental Epidemiology with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="hazards" class="section level1 hasAnchor" number="10">
<h1><span class="header-section-number">Chapter 10</span> Environmental hazards-spatial models<a href="hazards.html#hazards" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter contains the basic theory for spatial processes and a number of approaches to modelling point-referenced spatial data. From this chapter, the reader will have gained an understanding of the following topics:</p>
<ul>
<li>Visualization techniques needed for both exploring and analyzing spatial data and communicating its features through the use of maps.</li>
<li>Exploring the underlying structure of spatial data and methods for characterizing dependence over space.</li>
<li>Second-order theory for spatial processes including the covariance. The variogram for measuring spatial associations.</li>
<li>Stationarity and isotropy.</li>
<li>Methods for spatial prediction, using both classical methods (kriging) as well as modern methods (Bayesian kriging).</li>
<li>Non-stationarity fields.</li>
</ul>
<!-- NOTE: Unlike some of the other chapters you have to run this code sequentially -->
<div id="example-10.1-spatial-patterns-in-lead-concentrations-in-the-soil-of-the-meuse-river-flood-plain" class="section level2 unnumbered hasAnchor">
<h2>Example 10.1 Spatial patterns in lead concentrations in the soil of the Meuse River flood plain<a href="hazards.html#example-10.1-spatial-patterns-in-lead-concentrations-in-the-soil-of-the-meuse-river-flood-plain" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="hazards.html#cb181-1" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb181-2"><a href="hazards.html#cb181-2" tabindex="-1"></a><span class="fu">library</span>(ggmap)</span>
<span id="cb181-3"><a href="hazards.html#cb181-3" tabindex="-1"></a><span class="fu">library</span>(sp)</span>
<span id="cb181-4"><a href="hazards.html#cb181-4" tabindex="-1"></a></span>
<span id="cb181-5"><a href="hazards.html#cb181-5" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb181-6"><a href="hazards.html#cb181-6" tabindex="-1"></a><span class="fu">data</span>(meuse) </span>
<span id="cb181-7"><a href="hazards.html#cb181-7" tabindex="-1"></a><span class="fu">coordinates</span>(meuse)<span class="ot">&lt;-</span><span class="er">~</span>x<span class="sc">+</span>y <span class="co"># convert to SPDF </span></span>
<span id="cb181-8"><a href="hazards.html#cb181-8" tabindex="-1"></a></span>
<span id="cb181-9"><a href="hazards.html#cb181-9" tabindex="-1"></a><span class="co"># Assign Netherlands reference system </span></span>
<span id="cb181-10"><a href="hazards.html#cb181-10" tabindex="-1"></a><span class="fu">proj4string</span>(meuse) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&#39;+init=epsg:28992&#39;</span>) </span>
<span id="cb181-11"><a href="hazards.html#cb181-11" tabindex="-1"></a></span>
<span id="cb181-12"><a href="hazards.html#cb181-12" tabindex="-1"></a><span class="co"># Convert to longlat reference system </span></span>
<span id="cb181-13"><a href="hazards.html#cb181-13" tabindex="-1"></a>meuse_geo <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(meuse,<span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>))</span></code></pre></div>
<pre><code>## Warning: PROJ support is provided by the sf and terra packages among others</code></pre>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="hazards.html#cb183-1" tabindex="-1"></a>meuse_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(meuse_geo)</span></code></pre></div>
<p>Plot Figure 10.1 Bubble map</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="hazards.html#cb184-1" tabindex="-1"></a>latLongBox <span class="ot">=</span> <span class="fu">bbox</span>(meuse_geo)</span>
<span id="cb184-2"><a href="hazards.html#cb184-2" tabindex="-1"></a>location <span class="ot">=</span> <span class="fu">c</span>(latLongBox[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.01</span>,</span>
<span id="cb184-3"><a href="hazards.html#cb184-3" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.01</span>,</span>
<span id="cb184-4"><a href="hazards.html#cb184-4" tabindex="-1"></a>             latLongBox[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.01</span>,</span>
<span id="cb184-5"><a href="hazards.html#cb184-5" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.01</span>)</span>
<span id="cb184-6"><a href="hazards.html#cb184-6" tabindex="-1"></a><span class="co"># create map with location dots marked on it in</span></span>
<span id="cb184-7"><a href="hazards.html#cb184-7" tabindex="-1"></a>MeuseMap <span class="ot">&lt;-</span></span>
<span id="cb184-8"><a href="hazards.html#cb184-8" tabindex="-1"></a>  <span class="fu">get_stamenmap</span>(<span class="at">bbox =</span>  location,</span>
<span id="cb184-9"><a href="hazards.html#cb184-9" tabindex="-1"></a>                <span class="at">zoom =</span> <span class="dv">14</span>)</span></code></pre></div>
<pre><code>## ℹ Map tiles by Stamen Design, under CC BY 3.0. Data by OpenStreetMap, under ODbL.</code></pre>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="hazards.html#cb186-1" tabindex="-1"></a><span class="fu">ggmap</span>(MeuseMap) <span class="sc">+</span> <span class="fu">geom_point</span>(</span>
<span id="cb186-2"><a href="hazards.html#cb186-2" tabindex="-1"></a>  <span class="at">data =</span> meuse_df,</span>
<span id="cb186-3"><a href="hazards.html#cb186-3" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> x,</span>
<span id="cb186-4"><a href="hazards.html#cb186-4" tabindex="-1"></a>      <span class="at">y =</span> y,</span>
<span id="cb186-5"><a href="hazards.html#cb186-5" tabindex="-1"></a>      <span class="at">size =</span> lead),</span>
<span id="cb186-6"><a href="hazards.html#cb186-6" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">&quot;#011f4b&quot;</span>,</span>
<span id="cb186-7"><a href="hazards.html#cb186-7" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="fl">0.45</span></span>
<span id="cb186-8"><a href="hazards.html#cb186-8" tabindex="-1"></a>) <span class="sc">+</span> <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Figure%2010.1%20bubble%20map-1.png" width="672" /></p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="hazards.html#cb187-1" tabindex="-1"></a>meuse_geodata <span class="ot">&lt;-</span> <span class="fu">as.geodata</span>(<span class="fu">as.data.frame</span>(meuse), <span class="at">coords.col =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">data.col =</span> <span class="dv">5</span>)</span>
<span id="cb187-2"><a href="hazards.html#cb187-2" tabindex="-1"></a><span class="fu">plot</span>(meuse_geodata)</span></code></pre></div>
<p><img src="_main_files/figure-html/Figure%2010.2-1.png" width="672" /></p>
</div>
<div id="example-10.2-examining-the-log-concentrations-of-lead-in-the-meuse-river-flood-plain" class="section level2 unnumbered hasAnchor">
<h2>Example 10.2: Examining the log concentrations of lead in the Meuse River flood plain<a href="hazards.html#example-10.2-examining-the-log-concentrations-of-lead-in-the-meuse-river-flood-plain" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="hazards.html#cb188-1" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb188-2"><a href="hazards.html#cb188-2" tabindex="-1"></a>log_histogram <span class="ot">&lt;-</span></span>
<span id="cb188-3"><a href="hazards.html#cb188-3" tabindex="-1"></a>  <span class="fu">hist</span>(<span class="fu">log</span>(meuse<span class="sc">$</span>lead), <span class="at">main =</span> <span class="st">&quot;&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;log(lead)&quot;</span>)</span>
<span id="cb188-4"><a href="hazards.html#cb188-4" tabindex="-1"></a><span class="fu">qqnorm</span>(<span class="fu">log</span>(meuse<span class="sc">$</span>lead), <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb188-5"><a href="hazards.html#cb188-5" tabindex="-1"></a><span class="fu">qqline</span>(<span class="fu">log</span>(meuse<span class="sc">$</span>lead))</span></code></pre></div>
<p><img src="_main_files/figure-html/Figure%2010.3-1.png" width="672" /></p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="hazards.html#cb189-1" tabindex="-1"></a>meuse_df <span class="ot">&lt;-</span>  <span class="fu">as.data.frame</span>(meuse)</span>
<span id="cb189-2"><a href="hazards.html#cb189-2" tabindex="-1"></a><span class="fu">coplot</span>( lead <span class="sc">~</span> y <span class="sc">|</span> x, <span class="at">data =</span> meuse_df)</span></code></pre></div>
<p><img src="_main_files/figure-html/Figure%2010.4-1.png" width="672" /></p>
</div>
<div id="example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state" class="section level2 unnumbered hasAnchor">
<h2>Example 10.3: Mapping the locations of ozone monitoring sites in New York State<a href="hazards.html#example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This example uses the coordinates in the <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/ozone/NY_metadata.txt">NY_metadata.txt</a> file.</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="hazards.html#cb190-1" tabindex="-1"></a><span class="co"># Load the metadata giving the site coordinates </span></span>
<span id="cb190-2"><a href="hazards.html#cb190-2" tabindex="-1"></a>ny_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/ozone/NY_metadata.txt&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb190-3"><a href="hazards.html#cb190-3" tabindex="-1"></a><span class="co"># Now copy ny_data into ny_data_sp and convert data to &quot;sp&quot; format</span></span>
<span id="cb190-4"><a href="hazards.html#cb190-4" tabindex="-1"></a>ny_data_sp <span class="ot">&lt;-</span> ny_data</span>
<span id="cb190-5"><a href="hazards.html#cb190-5" tabindex="-1"></a><span class="fu">coordinates</span>(ny_data_sp) <span class="ot">&lt;-</span> <span class="er">~</span> Longitude <span class="sc">+</span> Latitude</span>
<span id="cb190-6"><a href="hazards.html#cb190-6" tabindex="-1"></a></span>
<span id="cb190-7"><a href="hazards.html#cb190-7" tabindex="-1"></a><span class="co"># assign a reference system to ny_data_sp</span></span>
<span id="cb190-8"><a href="hazards.html#cb190-8" tabindex="-1"></a><span class="fu">proj4string</span>(ny_data_sp) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +ellps=WGS84&quot;</span>)</span>
<span id="cb190-9"><a href="hazards.html#cb190-9" tabindex="-1"></a></span>
<span id="cb190-10"><a href="hazards.html#cb190-10" tabindex="-1"></a><span class="co"># We next specify a bounding box - a 2 x 2 matrix of corners of the geographic</span></span>
<span id="cb190-11"><a href="hazards.html#cb190-11" tabindex="-1"></a><span class="co"># area. Then specify the range of locations within the box.</span></span>
<span id="cb190-12"><a href="hazards.html#cb190-12" tabindex="-1"></a><span class="co"># Note:  location must be in left-bottom-right-top bounding box format</span></span>
<span id="cb190-13"><a href="hazards.html#cb190-13" tabindex="-1"></a>latLongBox  <span class="ot">&lt;-</span>  <span class="fu">bbox</span>(ny_data_sp)</span>
<span id="cb190-14"><a href="hazards.html#cb190-14" tabindex="-1"></a>location <span class="ot">&lt;-</span>  <span class="fu">c</span>(latLongBox [<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.2</span> ,</span>
<span id="cb190-15"><a href="hazards.html#cb190-15" tabindex="-1"></a>               latLongBox [<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.2</span>,</span>
<span id="cb190-16"><a href="hazards.html#cb190-16" tabindex="-1"></a>               latLongBox [<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.2</span> ,</span>
<span id="cb190-17"><a href="hazards.html#cb190-17" tabindex="-1"></a>               latLongBox [<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.2</span>)</span>
<span id="cb190-18"><a href="hazards.html#cb190-18" tabindex="-1"></a></span>
<span id="cb190-19"><a href="hazards.html#cb190-19" tabindex="-1"></a><span class="co"># Now create the map with location dots</span></span>
<span id="cb190-20"><a href="hazards.html#cb190-20" tabindex="-1"></a>NYmap <span class="ot">&lt;-</span> <span class="fu">get_stamenmap</span>(<span class="at">bbox =</span> location, <span class="at">zoom =</span> <span class="dv">8</span>)</span>
<span id="cb190-21"><a href="hazards.html#cb190-21" tabindex="-1"></a></span>
<span id="cb190-22"><a href="hazards.html#cb190-22" tabindex="-1"></a><span class="fu">ggmap</span>(NYmap) <span class="sc">+</span> <span class="fu">geom_point</span>(</span>
<span id="cb190-23"><a href="hazards.html#cb190-23" tabindex="-1"></a>  <span class="at">data =</span> ny_data,</span>
<span id="cb190-24"><a href="hazards.html#cb190-24" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> Longitude , <span class="at">y =</span> Latitude),</span>
<span id="cb190-25"><a href="hazards.html#cb190-25" tabindex="-1"></a>  <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb190-26"><a href="hazards.html#cb190-26" tabindex="-1"></a>  <span class="at">color =</span> <span class="st">&quot;darkred&quot;</span></span>
<span id="cb190-27"><a href="hazards.html#cb190-27" tabindex="-1"></a>) <span class="sc">+</span> <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.3%20plot%20ozone%20sites%20NY-1.png" width="672" /></p>
</div>
<div id="example-10.6-spatial-prediction-of-temperatures-in-california" class="section level2 unnumbered hasAnchor">
<h2>Example 10.6: Spatial prediction of temperatures in California<a href="hazards.html#example-10.6-spatial-prediction-of-temperatures-in-california" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="hazards.html#cb191-1" tabindex="-1"></a><span class="co"># REVIEW: There is something wrong with this dataset, it is impossible to have this temperatures</span></span>
<span id="cb191-2"><a href="hazards.html#cb191-2" tabindex="-1"></a><span class="co"># most likely all the data has to be divided by 10</span></span>
<span id="cb191-3"><a href="hazards.html#cb191-3" tabindex="-1"></a></span>
<span id="cb191-4"><a href="hazards.html#cb191-4" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb191-5"><a href="hazards.html#cb191-5" tabindex="-1"></a><span class="fu">library</span>(gstat)</span>
<span id="cb191-6"><a href="hazards.html#cb191-6" tabindex="-1"></a><span class="fu">library</span>(sp)</span>
<span id="cb191-7"><a href="hazards.html#cb191-7" tabindex="-1"></a></span>
<span id="cb191-8"><a href="hazards.html#cb191-8" tabindex="-1"></a><span class="do">### First we load the data</span></span>
<span id="cb191-9"><a href="hazards.html#cb191-9" tabindex="-1"></a>CAmetadata <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;data/metadataCA.txt&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-10"><a href="hazards.html#cb191-10" tabindex="-1"></a>CATemp <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/MaxCaliforniaTemp.csv&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-11"><a href="hazards.html#cb191-11" tabindex="-1"></a>CATemp_20120901 <span class="ot">&lt;-</span> CATemp[CATemp<span class="sc">$</span>X <span class="sc">==</span> <span class="dv">20120901</span>, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">14</span>)]</span>
<span id="cb191-12"><a href="hazards.html#cb191-12" tabindex="-1"></a>CATemp_20120901 <span class="ot">&lt;-</span> <span class="fu">t</span>(CATemp_20120901)</span>
<span id="cb191-13"><a href="hazards.html#cb191-13" tabindex="-1"></a><span class="do">### Change names of lat, long</span></span>
<span id="cb191-14"><a href="hazards.html#cb191-14" tabindex="-1"></a><span class="fu">names</span>(CAmetadata)[<span class="fu">names</span>(CAmetadata)<span class="sc">==</span><span class="st">&quot;Long&quot;</span>]<span class="ot">&lt;-</span><span class="st">&quot;x&quot;</span></span>
<span id="cb191-15"><a href="hazards.html#cb191-15" tabindex="-1"></a><span class="fu">names</span>(CAmetadata)[<span class="fu">names</span>(CAmetadata)<span class="sc">==</span><span class="st">&quot;Lat&quot;</span>]<span class="ot">&lt;-</span><span class="st">&quot;y&quot;</span></span>
<span id="cb191-16"><a href="hazards.html#cb191-16" tabindex="-1"></a></span>
<span id="cb191-17"><a href="hazards.html#cb191-17" tabindex="-1"></a><span class="do">### Augment data file with coordinates</span></span>
<span id="cb191-18"><a href="hazards.html#cb191-18" tabindex="-1"></a>CATemp_20120901 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(CAmetadata, CATemp_20120901<span class="sc">/</span><span class="dv">10</span>)</span>
<span id="cb191-19"><a href="hazards.html#cb191-19" tabindex="-1"></a><span class="fu">names</span>(CATemp_20120901)[<span class="fu">names</span>(CATemp_20120901) <span class="sc">==</span> <span class="st">&quot;245&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;Temp&quot;</span></span>
<span id="cb191-20"><a href="hazards.html#cb191-20" tabindex="-1"></a><span class="fu">coordinates</span>(CATemp_20120901) <span class="ot">&lt;-</span> <span class="er">~</span>x <span class="sc">+</span>y</span>
<span id="cb191-21"><a href="hazards.html#cb191-21" tabindex="-1"></a></span>
<span id="cb191-22"><a href="hazards.html#cb191-22" tabindex="-1"></a>CAgstat.vario <span class="ot">&lt;-</span> <span class="fu">variogram</span>(Temp <span class="sc">~</span> x<span class="sc">+</span>y, CATemp_20120901)</span>
<span id="cb191-23"><a href="hazards.html#cb191-23" tabindex="-1"></a><span class="co">#CAgstat.vario &lt;- variogram(Temp ~ 1, CATemp_20120501, print.SSE = TRUE)</span></span>
<span id="cb191-24"><a href="hazards.html#cb191-24" tabindex="-1"></a></span>
<span id="cb191-25"><a href="hazards.html#cb191-25" tabindex="-1"></a>CATemp.variofit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(CAgstat.vario,</span>
<span id="cb191-26"><a href="hazards.html#cb191-26" tabindex="-1"></a><span class="fu">vgm</span>(<span class="dv">10</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">1</span>, <span class="fl">0.1</span>))</span>
<span id="cb191-27"><a href="hazards.html#cb191-27" tabindex="-1"></a></span>
<span id="cb191-28"><a href="hazards.html#cb191-28" tabindex="-1"></a><span class="co"># Plot variogram and fit</span></span>
<span id="cb191-29"><a href="hazards.html#cb191-29" tabindex="-1"></a></span>
<span id="cb191-30"><a href="hazards.html#cb191-30" tabindex="-1"></a><span class="fu">plot</span>(CAgstat.vario, CATemp.variofit, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.6%20plot%20variogram-1.png" width="672" /></p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="hazards.html#cb192-1" tabindex="-1"></a><span class="do">### Examine the fit</span></span>
<span id="cb192-2"><a href="hazards.html#cb192-2" tabindex="-1"></a><span class="fu">summary</span>(CATemp.variofit)</span></code></pre></div>
<pre><code>##      model       psill            range            kappa            ang1  
##  Nug    :1   Min.   : 0.000   Min.   :0.0000   Min.   :0.000   Min.   :0  
##  Exp    :1   1st Qu.: 3.713   1st Qu.:0.2813   1st Qu.:0.125   1st Qu.:0  
##  Sph    :0   Median : 7.425   Median :0.5627   Median :0.250   Median :0  
##  Gau    :0   Mean   : 7.425   Mean   :0.5627   Mean   :0.250   Mean   :0  
##  Exc    :0   3rd Qu.:11.138   3rd Qu.:0.8440   3rd Qu.:0.375   3rd Qu.:0  
##  Mat    :0   Max.   :14.851   Max.   :1.1254   Max.   :0.500   Max.   :0  
##  (Other):0                                                                
##       ang2        ang3       anis1       anis2  
##  Min.   :0   Min.   :0   Min.   :1   Min.   :1  
##  1st Qu.:0   1st Qu.:0   1st Qu.:1   1st Qu.:1  
##  Median :0   Median :0   Median :1   Median :1  
##  Mean   :0   Mean   :0   Mean   :1   Mean   :1  
##  3rd Qu.:0   3rd Qu.:0   3rd Qu.:1   3rd Qu.:1  
##  Max.   :0   Max.   :0   Max.   :1   Max.   :1  
## </code></pre>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="hazards.html#cb194-1" tabindex="-1"></a><span class="co"># Create the grid on which to make the spatial predictions</span></span>
<span id="cb194-2"><a href="hazards.html#cb194-2" tabindex="-1"></a>CAPred.loci <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">125</span>, <span class="sc">-</span><span class="dv">115</span>, <span class="fl">0.1</span>), <span class="fu">seq</span>(<span class="dv">32</span>, <span class="dv">42</span>, <span class="fl">0.1</span>))</span>
<span id="cb194-3"><a href="hazards.html#cb194-3" tabindex="-1"></a><span class="fu">names</span>(CAPred.loci)[<span class="fu">names</span>(CAPred.loci) <span class="sc">==</span> <span class="st">&quot;Var1&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;x&quot;</span></span>
<span id="cb194-4"><a href="hazards.html#cb194-4" tabindex="-1"></a><span class="fu">names</span>(CAPred.loci)[<span class="fu">names</span>(CAPred.loci) <span class="sc">==</span> <span class="st">&quot;Var2&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;y&quot;</span></span>
<span id="cb194-5"><a href="hazards.html#cb194-5" tabindex="-1"></a><span class="fu">coordinates</span>(CAPred.loci) <span class="ot">=</span> <span class="er">~</span> x <span class="sc">+</span> y</span>
<span id="cb194-6"><a href="hazards.html#cb194-6" tabindex="-1"></a><span class="fu">gridded</span>(CAPred.loci) <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb194-7"><a href="hazards.html#cb194-7" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="dv">14</span>, <span class="st">&quot;Exp&quot;</span>, <span class="fl">1.1</span>, <span class="fl">0.01</span>)</span>
<span id="cb194-8"><a href="hazards.html#cb194-8" tabindex="-1"></a></span>
<span id="cb194-9"><a href="hazards.html#cb194-9" tabindex="-1"></a><span class="co"># Get the monitoring locations</span></span>
<span id="cb194-10"><a href="hazards.html#cb194-10" tabindex="-1"></a>monitor_loc <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&#39;sp.points&#39;</span>, CATemp_20120901, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">cex=</span>.<span class="dv">8</span>, <span class="at">col=</span><span class="st">&#39;cornsilk4&#39;</span>)</span>
<span id="cb194-11"><a href="hazards.html#cb194-11" tabindex="-1"></a></span>
<span id="cb194-12"><a href="hazards.html#cb194-12" tabindex="-1"></a></span>
<span id="cb194-13"><a href="hazards.html#cb194-13" tabindex="-1"></a><span class="co"># ordinary kriging:</span></span>
<span id="cb194-14"><a href="hazards.html#cb194-14" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">krige</span>(Temp <span class="sc">~</span> <span class="dv">1</span>, CATemp_20120901, CAPred.loci, <span class="at">model =</span> mod)</span></code></pre></div>
<pre><code>## [using ordinary kriging]</code></pre>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="hazards.html#cb196-1" tabindex="-1"></a><span class="fu">spplot</span>(x[<span class="st">&quot;var1.pred&quot;</span>], <span class="at">main =</span> <span class="st">&quot;ordinary kriging predictions&quot;</span>, <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc), )</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.6%20grid%20predictions-1.png" width="672" /></p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="hazards.html#cb197-1" tabindex="-1"></a><span class="fu">spplot</span>(x[<span class="st">&quot;var1.var&quot;</span>], <span class="at">main =</span> <span class="st">&quot;ordinary kriging variance&quot;</span>, <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc), )</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.6%20grid%20predictions-2.png" width="672" /></p>
</div>
<div id="example-10.8-spatial-prediction-of-no2-in-europe" class="section level2 hasAnchor" number="10.1">
<h2><span class="header-section-number">10.1</span> Example 10.8 Spatial prediction of NO2 in Europe<a href="hazards.html#example-10.8-spatial-prediction-of-no2-in-europe" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="hazards.html#cb198-1" tabindex="-1"></a><span class="fu">library</span>(gdata)</span>
<span id="cb198-2"><a href="hazards.html#cb198-2" tabindex="-1"></a><span class="fu">library</span>(ggmap)</span>
<span id="cb198-3"><a href="hazards.html#cb198-3" tabindex="-1"></a><span class="fu">library</span>(gstat)</span>
<span id="cb198-4"><a href="hazards.html#cb198-4" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb198-5"><a href="hazards.html#cb198-5" tabindex="-1"></a><span class="fu">library</span>(sp)</span>
<span id="cb198-6"><a href="hazards.html#cb198-6" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb198-7"><a href="hazards.html#cb198-7" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb198-8"><a href="hazards.html#cb198-8" tabindex="-1"></a></span>
<span id="cb198-9"><a href="hazards.html#cb198-9" tabindex="-1"></a>ditch_the_axes <span class="ot">&lt;-</span> <span class="fu">theme</span>(</span>
<span id="cb198-10"><a href="hazards.html#cb198-10" tabindex="-1"></a>  <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb198-11"><a href="hazards.html#cb198-11" tabindex="-1"></a>  <span class="at">axis.line =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb198-12"><a href="hazards.html#cb198-12" tabindex="-1"></a>  <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb198-13"><a href="hazards.html#cb198-13" tabindex="-1"></a>  <span class="at">panel.border =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb198-14"><a href="hazards.html#cb198-14" tabindex="-1"></a>  <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb198-15"><a href="hazards.html#cb198-15" tabindex="-1"></a>  <span class="at">axis.title =</span> <span class="fu">element_blank</span>())</span>
<span id="cb198-16"><a href="hazards.html#cb198-16" tabindex="-1"></a></span>
<span id="cb198-17"><a href="hazards.html#cb198-17" tabindex="-1"></a><span class="co">#perl &lt;- &quot;C:/Perl64/bin/perl5.28.1.exe&quot; # add location of perl exe for read.xls</span></span>
<span id="cb198-18"><a href="hazards.html#cb198-18" tabindex="-1"></a>perl <span class="ot">&lt;-</span> (<span class="st">&quot;C:/Strawberry/perl/bin/perl5.32.1.exe&quot;</span>)</span>
<span id="cb198-19"><a href="hazards.html#cb198-19" tabindex="-1"></a>no2 <span class="ot">&lt;-</span> <span class="fu">read.xls</span>(<span class="st">&quot;data/no2_europe/NO2Europe.xlsx&quot;</span>, <span class="at">perl =</span> perl)</span>
<span id="cb198-20"><a href="hazards.html#cb198-20" tabindex="-1"></a>no2<span class="sc">$</span>AirPollutionLevel <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(no2<span class="sc">$</span>AirPollutionLevel)</span>
<span id="cb198-21"><a href="hazards.html#cb198-21" tabindex="-1"></a><span class="fu">colnames</span>(no2)</span></code></pre></div>
<pre><code>##  [1] &quot;Country&quot;                         &quot;CountryCode&quot;                    
##  [3] &quot;City&quot;                            &quot;AirQualityNetwork&quot;              
##  [5] &quot;AirQualityNetworkName&quot;           &quot;AirQualityStation&quot;              
##  [7] &quot;AirQualityStationEoICode&quot;        &quot;AQStationName&quot;                  
##  [9] &quot;AirPollutant&quot;                    &quot;AirPollutantCode&quot;               
## [11] &quot;DataAggregationProcess&quot;          &quot;YearOfStatistics&quot;               
## [13] &quot;AirPollutionLevel&quot;               &quot;UnitOfAirpollutionLevel&quot;        
## [15] &quot;DataCoverage&quot;                    &quot;Verification&quot;                   
## [17] &quot;AirQualityStationType&quot;           &quot;AirQualityStationArea&quot;          
## [19] &quot;Longitude&quot;                       &quot;Latitude&quot;                       
## [21] &quot;Altitude&quot;                        &quot;CountryName&quot;                    
## [23] &quot;CountryType&quot;                     &quot;DataAggregationProcess_original&quot;
## [25] &quot;AirPollutantCode_original&quot;       &quot;AirPollutant_original&quot;          
## [27] &quot;cut&quot;</code></pre>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="hazards.html#cb200-1" tabindex="-1"></a>summary_no2 <span class="ot">&lt;-</span> <span class="fu">group_by</span>(no2, Country) <span class="sc">|&gt;</span></span>
<span id="cb200-2"><a href="hazards.html#cb200-2" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">total =</span> <span class="fu">n</span>(),</span>
<span id="cb200-3"><a href="hazards.html#cb200-3" tabindex="-1"></a>            <span class="at">mean_country =</span> <span class="fu">mean</span>(AirPollutionLevel, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb200-4"><a href="hazards.html#cb200-4" tabindex="-1"></a></span>
<span id="cb200-5"><a href="hazards.html#cb200-5" tabindex="-1"></a>summary_no2[<span class="fu">order</span>(summary_no2<span class="sc">$</span>total, <span class="at">decreasing =</span> <span class="cn">TRUE</span>),]</span></code></pre></div>
<pre><code>##            Country total mean_country
## 30           Spain   465    15.544086
## 12         Germany   396    21.464646
## 11          France   330    18.215152
## 17           Italy   280    21.771429
## 33  United Kingdom   153    22.581699
## 25          Poland   147    16.319728
## 2          Austria   141    18.787234
## 3          Belgium    70    19.571429
## 7          Czechia    63    16.761905
## 26        Portugal    45    18.044444
## 24          Norway    40    22.625000
## 22     Netherlands    39    18.564103
## 32     Switzerland    32    21.312500
## 31          Sweden    29    19.793103
## 28        Slovakia    25    17.600000
## 10         Finland    23    11.173913
## 4         Bulgaria    20    20.650000
## 14         Hungary    19    22.052632
## 19       Lithuania    14    15.142857
## 5          Croatia    12    17.250000
## 16         Ireland    11    15.818182
## 8          Denmark    10    14.600000
## 23 North Macedonia    10    18.600000
## 9          Estonia     9     7.111111
## 15         Iceland     9     5.888889
## 29        Slovenia     9    18.777778
## 13          Greece     8    30.375000
## 20      Luxembourg     6    18.000000
## 27          Serbia     5    21.200000
## 6           Cyprus     3    19.666667
## 18          Latvia     3    22.000000
## 1          Andorra     1    31.000000
## 21           Malta     1     3.000000</code></pre>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="hazards.html#cb202-1" tabindex="-1"></a>europe_map <span class="ot">&lt;-</span> <span class="fu">get_stamenmap</span>(<span class="fu">c</span>(<span class="at">left =</span> <span class="sc">-</span><span class="dv">25</span>, <span class="at">bottom =</span> <span class="dv">30</span>, <span class="at">right =</span> <span class="dv">30</span>, <span class="at">top =</span> <span class="dv">70</span>),</span>
<span id="cb202-2"><a href="hazards.html#cb202-2" tabindex="-1"></a>                            <span class="at">zoom =</span> <span class="dv">5</span>)</span>
<span id="cb202-3"><a href="hazards.html#cb202-3" tabindex="-1"></a></span>
<span id="cb202-4"><a href="hazards.html#cb202-4" tabindex="-1"></a></span>
<span id="cb202-5"><a href="hazards.html#cb202-5" tabindex="-1"></a><span class="fu">ggmap</span>(europe_map, <span class="at">darken =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="st">&quot;white&quot;</span>)) <span class="sc">+</span></span>
<span id="cb202-6"><a href="hazards.html#cb202-6" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> no2,</span>
<span id="cb202-7"><a href="hazards.html#cb202-7" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> Longitude, <span class="at">y =</span> Latitude, <span class="at">color =</span> Country),</span>
<span id="cb202-8"><a href="hazards.html#cb202-8" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> ditch_the_axes <span class="sc">+</span></span>
<span id="cb202-9"><a href="hazards.html#cb202-9" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">15</span>)) </span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.8%20plot%20map-1.png" width="672" /></p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="hazards.html#cb203-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">321</span>)</span>
<span id="cb203-2"><a href="hazards.html#cb203-2" tabindex="-1"></a></span>
<span id="cb203-3"><a href="hazards.html#cb203-3" tabindex="-1"></a>no2_sample <span class="ot">&lt;-</span> no2 <span class="sc">|&gt;</span> </span>
<span id="cb203-4"><a href="hazards.html#cb203-4" tabindex="-1"></a>  <span class="fu">filter</span>(Longitude <span class="sc">&lt;</span> <span class="dv">30</span> <span class="sc">&amp;</span> Longitude <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">25</span> <span class="sc">&amp;</span> Latitude <span class="sc">&gt;</span> <span class="dv">30</span> <span class="sc">&amp;</span> Latitude <span class="sc">&lt;</span> <span class="dv">70</span>)</span>
<span id="cb203-5"><a href="hazards.html#cb203-5" tabindex="-1"></a></span>
<span id="cb203-6"><a href="hazards.html#cb203-6" tabindex="-1"></a></span>
<span id="cb203-7"><a href="hazards.html#cb203-7" tabindex="-1"></a>no2_sample <span class="ot">&lt;-</span> no2_sample <span class="sc">|&gt;</span></span>
<span id="cb203-8"><a href="hazards.html#cb203-8" tabindex="-1"></a>  <span class="fu">filter</span>(Country <span class="sc">==</span> <span class="st">&quot;Spain&quot;</span> <span class="sc">|</span> Country <span class="sc">==</span> <span class="st">&quot;Germany&quot;</span> <span class="sc">|</span> Country <span class="sc">==</span> <span class="st">&quot;France&quot;</span> <span class="sc">|</span> </span>
<span id="cb203-9"><a href="hazards.html#cb203-9" tabindex="-1"></a>           Country <span class="sc">==</span> <span class="st">&quot;Italy&quot;</span> <span class="sc">|</span> Country <span class="sc">==</span> <span class="st">&quot;United Kingdom&quot;</span> <span class="sc">|</span> </span>
<span id="cb203-10"><a href="hazards.html#cb203-10" tabindex="-1"></a>           Country <span class="sc">==</span> <span class="st">&quot;Poland&quot;</span> <span class="sc">|</span> Country <span class="sc">==</span> <span class="st">&quot;Austria&quot;</span> )</span>
<span id="cb203-11"><a href="hazards.html#cb203-11" tabindex="-1"></a></span>
<span id="cb203-12"><a href="hazards.html#cb203-12" tabindex="-1"></a>no2_subsample <span class="ot">&lt;-</span> no2_sample <span class="sc">|&gt;</span> <span class="fu">group_by</span>(Country) <span class="sc">|&gt;</span>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">128</span>)</span>
<span id="cb203-13"><a href="hazards.html#cb203-13" tabindex="-1"></a><span class="fu">dim</span>(no2_subsample)</span></code></pre></div>
<pre><code>## [1] 896  27</code></pre>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="hazards.html#cb205-1" tabindex="-1"></a><span class="fu">ggmap</span>(europe_map, <span class="at">darken =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="st">&quot;white&quot;</span>)) <span class="sc">+</span></span>
<span id="cb205-2"><a href="hazards.html#cb205-2" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> no2_subsample,</span>
<span id="cb205-3"><a href="hazards.html#cb205-3" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> Longitude, <span class="at">y =</span> Latitude, <span class="at">color =</span> Country),</span>
<span id="cb205-4"><a href="hazards.html#cb205-4" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> ditch_the_axes <span class="sc">+</span></span>
<span id="cb205-5"><a href="hazards.html#cb205-5" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">15</span>)) </span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.8%20subsample%20no2%20data-1.png" width="672" /></p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="hazards.html#cb206-1" tabindex="-1"></a><span class="co"># Function to get utm coordinates since we have different utm zones</span></span>
<span id="cb206-2"><a href="hazards.html#cb206-2" tabindex="-1"></a><span class="co"># This function was obtained from: https://stackoverflow.com/questions/71573206/converting-latitude-and-longitude-data-to-utm-with-points-from-multiple-utm-zone</span></span>
<span id="cb206-3"><a href="hazards.html#cb206-3" tabindex="-1"></a></span>
<span id="cb206-4"><a href="hazards.html#cb206-4" tabindex="-1"></a>get_utm <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y, zone, loc){</span>
<span id="cb206-5"><a href="hazards.html#cb206-5" tabindex="-1"></a>  points <span class="ot">=</span> <span class="fu">SpatialPoints</span>(<span class="fu">cbind</span>(x, y), </span>
<span id="cb206-6"><a href="hazards.html#cb206-6" tabindex="-1"></a>                         <span class="at">proj4string =</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>))</span>
<span id="cb206-7"><a href="hazards.html#cb206-7" tabindex="-1"></a>  points_utm <span class="ot">=</span> <span class="fu">spTransform</span>(points, </span>
<span id="cb206-8"><a href="hazards.html#cb206-8" tabindex="-1"></a>                           <span class="fu">CRS</span>(<span class="fu">paste0</span>(<span class="st">&quot;+proj=utm +zone=&quot;</span>, </span>
<span id="cb206-9"><a href="hazards.html#cb206-9" tabindex="-1"></a>                                      zone[<span class="dv">1</span>],<span class="st">&quot; +ellps=WGS84&quot;</span>)))</span>
<span id="cb206-10"><a href="hazards.html#cb206-10" tabindex="-1"></a>  <span class="cf">if</span> (loc <span class="sc">==</span> <span class="st">&quot;x&quot;</span>) {</span>
<span id="cb206-11"><a href="hazards.html#cb206-11" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">coordinates</span>(points_utm)[,<span class="dv">1</span>])</span>
<span id="cb206-12"><a href="hazards.html#cb206-12" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (loc <span class="sc">==</span> <span class="st">&quot;y&quot;</span>) {</span>
<span id="cb206-13"><a href="hazards.html#cb206-13" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">coordinates</span>(points_utm)[,<span class="dv">2</span>])</span>
<span id="cb206-14"><a href="hazards.html#cb206-14" tabindex="-1"></a>  }</span>
<span id="cb206-15"><a href="hazards.html#cb206-15" tabindex="-1"></a>}</span>
<span id="cb206-16"><a href="hazards.html#cb206-16" tabindex="-1"></a></span>
<span id="cb206-17"><a href="hazards.html#cb206-17" tabindex="-1"></a>no2_utm <span class="ot">&lt;-</span> <span class="fu">rename</span>(no2_subsample, <span class="at">x =</span> Longitude, <span class="at">y =</span> Latitude)</span>
<span id="cb206-18"><a href="hazards.html#cb206-18" tabindex="-1"></a></span>
<span id="cb206-19"><a href="hazards.html#cb206-19" tabindex="-1"></a>no2_utm <span class="ot">&lt;-</span></span>
<span id="cb206-20"><a href="hazards.html#cb206-20" tabindex="-1"></a>  <span class="fu">mutate</span>(no2_utm, <span class="at">zone2 =</span> (<span class="fu">floor</span>((x <span class="sc">+</span> <span class="dv">180</span>)<span class="sc">/</span><span class="dv">6</span>) <span class="sc">%%</span> <span class="dv">60</span>) <span class="sc">+</span> <span class="dv">1</span>, <span class="at">keep =</span> <span class="st">&quot;all&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb206-21"><a href="hazards.html#cb206-21" tabindex="-1"></a>  <span class="fu">group_by</span>(zone2) <span class="sc">|&gt;</span> </span>
<span id="cb206-22"><a href="hazards.html#cb206-22" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">utm_x =</span> <span class="fu">get_utm</span>(x, y, zone2, <span class="at">loc =</span> <span class="st">&quot;x&quot;</span>),</span>
<span id="cb206-23"><a href="hazards.html#cb206-23" tabindex="-1"></a>         <span class="at">utm_y =</span> <span class="fu">get_utm</span>(x, y, zone2, <span class="at">loc =</span> <span class="st">&quot;y&quot;</span>))<span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb206-24"><a href="hazards.html#cb206-24" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(utm_x, utm_y, Altitude, Country, AirPollutionLevel)  <span class="sc">|&gt;</span> </span>
<span id="cb206-25"><a href="hazards.html#cb206-25" tabindex="-1"></a> <span class="fu">mutate</span>( <span class="at">ID =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">896</span>))</span>
<span id="cb206-26"><a href="hazards.html#cb206-26" tabindex="-1"></a></span>
<span id="cb206-27"><a href="hazards.html#cb206-27" tabindex="-1"></a>no2_utm_geo <span class="ot">&lt;-</span> no2_utm  </span>
<span id="cb206-28"><a href="hazards.html#cb206-28" tabindex="-1"></a><span class="co"># change coordinates to kms and turn into a Spatial object</span></span>
<span id="cb206-29"><a href="hazards.html#cb206-29" tabindex="-1"></a>no2_utm_geo[,<span class="fu">c</span>(<span class="st">&quot;utm_x&quot;</span>, <span class="st">&quot;utm_y&quot;</span>)] <span class="ot">&lt;-</span> no2_utm_geo[,<span class="fu">c</span>(<span class="st">&quot;utm_x&quot;</span>, <span class="st">&quot;utm_y&quot;</span>)]<span class="sc">/</span><span class="dv">1000</span></span>
<span id="cb206-30"><a href="hazards.html#cb206-30" tabindex="-1"></a><span class="fu">coordinates</span>(no2_utm_geo) <span class="ot">&lt;-</span> <span class="er">~</span> utm_x <span class="sc">+</span> utm_y</span></code></pre></div>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="hazards.html#cb207-1" tabindex="-1"></a><span class="co"># Estimate variogram intercept only</span></span>
<span id="cb207-2"><a href="hazards.html#cb207-2" tabindex="-1"></a>no2_inter_vgm <span class="ot">&lt;-</span> <span class="fu">variogram</span>(<span class="fu">log</span>(AirPollutionLevel) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb207-3"><a href="hazards.html#cb207-3" tabindex="-1"></a>                               <span class="at">data =</span> no2_utm_geo,</span>
<span id="cb207-4"><a href="hazards.html#cb207-4" tabindex="-1"></a>                              <span class="at">cutoff =</span> <span class="dv">200</span>,<span class="co"># cutoff distance</span></span>
<span id="cb207-5"><a href="hazards.html#cb207-5" tabindex="-1"></a>                               <span class="at">width =</span> <span class="dv">200</span> <span class="sc">/</span> <span class="dv">10</span>) <span class="co"># bins width </span></span>
<span id="cb207-6"><a href="hazards.html#cb207-6" tabindex="-1"></a></span>
<span id="cb207-7"><a href="hazards.html#cb207-7" tabindex="-1"></a>no2_vgm_inter_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(no2_inter_vgm,</span>
<span id="cb207-8"><a href="hazards.html#cb207-8" tabindex="-1"></a>                                       <span class="at">model =</span> <span class="fu">vgm</span>(<span class="fl">0.8</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">15</span>, <span class="fl">0.007</span>))</span>
<span id="cb207-9"><a href="hazards.html#cb207-9" tabindex="-1"></a></span>
<span id="cb207-10"><a href="hazards.html#cb207-10" tabindex="-1"></a>no2_vgm_inter_fit</span></code></pre></div>
<pre><code>##   model     psill    range
## 1   Nug 0.1260258  0.00000
## 2   Exp 0.2119263 28.07435</code></pre>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="hazards.html#cb209-1" tabindex="-1"></a><span class="co"># Estimate variogram with coordinates and altitude</span></span>
<span id="cb209-2"><a href="hazards.html#cb209-2" tabindex="-1"></a>no2_utm_vgm <span class="ot">&lt;-</span> <span class="fu">variogram</span>(<span class="fu">log</span>(AirPollutionLevel) <span class="sc">~</span> utm_x <span class="sc">+</span> utm_y <span class="sc">+</span> Altitude,</span>
<span id="cb209-3"><a href="hazards.html#cb209-3" tabindex="-1"></a>                               <span class="at">data =</span> no2_utm_geo,</span>
<span id="cb209-4"><a href="hazards.html#cb209-4" tabindex="-1"></a>                              <span class="at">cutoff =</span> <span class="dv">200</span>,<span class="co"># cutoff distance</span></span>
<span id="cb209-5"><a href="hazards.html#cb209-5" tabindex="-1"></a>                               <span class="at">width =</span> <span class="dv">200</span> <span class="sc">/</span> <span class="dv">10</span>) <span class="co"># bins width </span></span>
<span id="cb209-6"><a href="hazards.html#cb209-6" tabindex="-1"></a></span>
<span id="cb209-7"><a href="hazards.html#cb209-7" tabindex="-1"></a>no2_vgm_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(no2_utm_vgm,</span>
<span id="cb209-8"><a href="hazards.html#cb209-8" tabindex="-1"></a>                                       <span class="at">model =</span> <span class="fu">vgm</span>(<span class="fl">0.8</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">15</span>, <span class="fl">0.007</span>))</span>
<span id="cb209-9"><a href="hazards.html#cb209-9" tabindex="-1"></a></span>
<span id="cb209-10"><a href="hazards.html#cb209-10" tabindex="-1"></a>no2_vgm_fit</span></code></pre></div>
<pre><code>##   model     psill    range
## 1   Nug 0.1350376  0.00000
## 2   Exp 0.1667001 36.06112</code></pre>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="hazards.html#cb211-1" tabindex="-1"></a>plot_inter_variog <span class="ot">&lt;-</span> <span class="fu">plot</span>(no2_inter_vgm, no2_vgm_inter_fit, </span>
<span id="cb211-2"><a href="hazards.html#cb211-2" tabindex="-1"></a>                          <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.4</span>), <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb211-3"><a href="hazards.html#cb211-3" tabindex="-1"></a>plot_coord_variog <span class="ot">&lt;-</span> <span class="fu">plot</span>(no2_utm_vgm, no2_vgm_fit, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.4</span>), <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb211-4"><a href="hazards.html#cb211-4" tabindex="-1"></a></span>
<span id="cb211-5"><a href="hazards.html#cb211-5" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(plot_inter_variog, plot_coord_variog, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.8%20plot%20variogram%20covariates-1.png" width="672" /></p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="hazards.html#cb212-1" tabindex="-1"></a><span class="co"># Change coordinates to kilometers and observations to the log scale</span></span>
<span id="cb212-2"><a href="hazards.html#cb212-2" tabindex="-1"></a>no2_df <span class="ot">&lt;-</span></span>
<span id="cb212-3"><a href="hazards.html#cb212-3" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb212-4"><a href="hazards.html#cb212-4" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">log</span>(no2_utm<span class="sc">$</span>AirPollutionLevel),</span>
<span id="cb212-5"><a href="hazards.html#cb212-5" tabindex="-1"></a>    <span class="at">easting =</span>  no2_utm<span class="sc">$</span>utm_x <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb212-6"><a href="hazards.html#cb212-6" tabindex="-1"></a>    <span class="at">northing =</span> no2_utm<span class="sc">$</span>utm_y <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb212-7"><a href="hazards.html#cb212-7" tabindex="-1"></a>    <span class="at">altitude =</span> no2_utm<span class="sc">$</span>Altitude</span>
<span id="cb212-8"><a href="hazards.html#cb212-8" tabindex="-1"></a>  )</span>
<span id="cb212-9"><a href="hazards.html#cb212-9" tabindex="-1"></a><span class="co"># Compute the distance matrix</span></span>
<span id="cb212-10"><a href="hazards.html#cb212-10" tabindex="-1"></a>obsCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(no2_df[,<span class="fu">c</span>(<span class="st">&quot;easting&quot;</span>, <span class="st">&quot;northing&quot;</span>)]))</span>
<span id="cb212-11"><a href="hazards.html#cb212-11" tabindex="-1"></a></span>
<span id="cb212-12"><a href="hazards.html#cb212-12" tabindex="-1"></a>obsDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(obsCoords)</span>
<span id="cb212-13"><a href="hazards.html#cb212-13" tabindex="-1"></a></span>
<span id="cb212-14"><a href="hazards.html#cb212-14" tabindex="-1"></a>easting_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(no2_df<span class="sc">$</span>easting))</span>
<span id="cb212-15"><a href="hazards.html#cb212-15" tabindex="-1"></a>northing_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(no2_df<span class="sc">$</span>northing))</span>
<span id="cb212-16"><a href="hazards.html#cb212-16" tabindex="-1"></a>altitude_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(no2_df<span class="sc">$</span>altitude))</span></code></pre></div>
<div class="blackbox">
<div class="center">
<p><strong>WARNING</strong></p>
</div>
<p>Due to the number of locations this model can take a long time to run in a regular computer (more than 3 hours)</p>
</div>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="hazards.html#cb213-1" tabindex="-1"></a>NO2Code <span class="ot">&lt;-</span>  <span class="fu">nimbleCode</span> ({</span>
<span id="cb213-2"><a href="hazards.html#cb213-2" tabindex="-1"></a>  <span class="co"># Covariance matrix spatial effect</span></span>
<span id="cb213-3"><a href="hazards.html#cb213-3" tabindex="-1"></a>  Sigma[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n] <span class="ot">&lt;-</span></span>
<span id="cb213-4"><a href="hazards.html#cb213-4" tabindex="-1"></a>    sigma_sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>distMatrix[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n] <span class="sc">/</span> phi) <span class="sc">+</span> tau_sq <span class="sc">*</span> <span class="fu">identityMatrix</span>(<span class="at">d =</span> n)</span>
<span id="cb213-5"><a href="hazards.html#cb213-5" tabindex="-1"></a></span>
<span id="cb213-6"><a href="hazards.html#cb213-6" tabindex="-1"></a>    <span class="cf">for</span> (site <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb213-7"><a href="hazards.html#cb213-7" tabindex="-1"></a>    mean.site[site] <span class="ot">&lt;-</span></span>
<span id="cb213-8"><a href="hazards.html#cb213-8" tabindex="-1"></a>      beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> easting[site] <span class="sc">+</span> beta2 <span class="sc">*</span> northing[site] <span class="sc">+</span> beta3 <span class="sc">*</span> altitude[site]</span>
<span id="cb213-9"><a href="hazards.html#cb213-9" tabindex="-1"></a>  }</span>
<span id="cb213-10"><a href="hazards.html#cb213-10" tabindex="-1"></a>  y[<span class="dv">1</span><span class="sc">:</span>n]  <span class="sc">~</span>  <span class="fu">dmnorm</span>(mean.site[<span class="dv">1</span><span class="sc">:</span>n], <span class="at">cov =</span> Sigma[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n])</span>
<span id="cb213-11"><a href="hazards.html#cb213-11" tabindex="-1"></a>  <span class="co"># Set up the priors for the spatial model</span></span>
<span id="cb213-12"><a href="hazards.html#cb213-12" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb213-13"><a href="hazards.html#cb213-13" tabindex="-1"></a>  sigma_sq <span class="ot">&lt;-</span> sigma<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb213-14"><a href="hazards.html#cb213-14" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb213-15"><a href="hazards.html#cb213-15" tabindex="-1"></a>  tau_sq <span class="ot">&lt;-</span> tau<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb213-16"><a href="hazards.html#cb213-16" tabindex="-1"></a>  phi_inv <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="at">shape =</span>  <span class="dv">5</span>, <span class="at">rate =</span> <span class="dv">5</span>)</span>
<span id="cb213-17"><a href="hazards.html#cb213-17" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> phi_inv</span>
<span id="cb213-18"><a href="hazards.html#cb213-18" tabindex="-1"></a>  <span class="co"># prior for the coefficients</span></span>
<span id="cb213-19"><a href="hazards.html#cb213-19" tabindex="-1"></a>  beta0 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb213-20"><a href="hazards.html#cb213-20" tabindex="-1"></a>  beta1 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb213-21"><a href="hazards.html#cb213-21" tabindex="-1"></a>  beta2 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb213-22"><a href="hazards.html#cb213-22" tabindex="-1"></a>  beta3 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb213-23"><a href="hazards.html#cb213-23" tabindex="-1"></a>  </span>
<span id="cb213-24"><a href="hazards.html#cb213-24" tabindex="-1"></a>}) </span>
<span id="cb213-25"><a href="hazards.html#cb213-25" tabindex="-1"></a></span>
<span id="cb213-26"><a href="hazards.html#cb213-26" tabindex="-1"></a><span class="co"># Define the constants, data, parameters and initial values</span></span>
<span id="cb213-27"><a href="hazards.html#cb213-27" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb213-28"><a href="hazards.html#cb213-28" tabindex="-1"></a></span>
<span id="cb213-29"><a href="hazards.html#cb213-29" tabindex="-1"></a>constants <span class="ot">&lt;-</span></span>
<span id="cb213-30"><a href="hazards.html#cb213-30" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">n =</span> <span class="fu">nrow</span>(no2_df))</span>
<span id="cb213-31"><a href="hazards.html#cb213-31" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span></span>
<span id="cb213-32"><a href="hazards.html#cb213-32" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">y =</span> no2_df<span class="sc">$</span>y,</span>
<span id="cb213-33"><a href="hazards.html#cb213-33" tabindex="-1"></a>       <span class="at">easting =</span> easting_scaled,</span>
<span id="cb213-34"><a href="hazards.html#cb213-34" tabindex="-1"></a>       <span class="at">northing =</span> northing_scaled,</span>
<span id="cb213-35"><a href="hazards.html#cb213-35" tabindex="-1"></a>       <span class="at">altitude =</span> altitude_scaled,</span>
<span id="cb213-36"><a href="hazards.html#cb213-36" tabindex="-1"></a>       <span class="at">distMatrix =</span> obsDist)</span>
<span id="cb213-37"><a href="hazards.html#cb213-37" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="st">&quot;beta0&quot;</span>,  <span class="st">&quot;beta1&quot;</span>,<span class="st">&quot;beta2&quot;</span>,<span class="st">&quot;beta3&quot;</span> ,<span class="st">&quot;phi&quot;</span>,  <span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>)</span>
<span id="cb213-38"><a href="hazards.html#cb213-38" tabindex="-1"></a>inits <span class="ot">&lt;-</span> <span class="fu">list</span>( <span class="at">sigma =</span> <span class="fl">0.1</span>, <span class="at">phi_inv =</span> <span class="dv">6</span><span class="sc">/</span><span class="fu">max</span>(obsDist), <span class="at">tau =</span> <span class="fl">0.1</span>)</span>
<span id="cb213-39"><a href="hazards.html#cb213-39" tabindex="-1"></a><span class="co"># Run model in nimble</span></span>
<span id="cb213-40"><a href="hazards.html#cb213-40" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb213-41"><a href="hazards.html#cb213-41" tabindex="-1"></a></span>
<span id="cb213-42"><a href="hazards.html#cb213-42" tabindex="-1"></a>mcmc.out <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb213-43"><a href="hazards.html#cb213-43" tabindex="-1"></a>  <span class="at">code =</span> NO2Code,</span>
<span id="cb213-44"><a href="hazards.html#cb213-44" tabindex="-1"></a>  <span class="at">constants =</span> constants,</span>
<span id="cb213-45"><a href="hazards.html#cb213-45" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb213-46"><a href="hazards.html#cb213-46" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb213-47"><a href="hazards.html#cb213-47" tabindex="-1"></a>  <span class="at">monitors =</span> params,</span>
<span id="cb213-48"><a href="hazards.html#cb213-48" tabindex="-1"></a>  <span class="at">niter =</span> <span class="dv">40000</span>,</span>
<span id="cb213-49"><a href="hazards.html#cb213-49" tabindex="-1"></a>  <span class="at">nburnin =</span> <span class="dv">20000</span>,</span>
<span id="cb213-50"><a href="hazards.html#cb213-50" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">14</span>,</span>
<span id="cb213-51"><a href="hazards.html#cb213-51" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb213-52"><a href="hazards.html#cb213-52" tabindex="-1"></a>  <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb213-53"><a href="hazards.html#cb213-53" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb213-54"><a href="hazards.html#cb213-54" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb213-55"><a href="hazards.html#cb213-55" tabindex="-1"></a>)</span>
<span id="cb213-56"><a href="hazards.html#cb213-56" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb213-57"><a href="hazards.html#cb213-57" tabindex="-1"></a>run_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb213-58"><a href="hazards.html#cb213-58" tabindex="-1"></a>run_time</span></code></pre></div>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="hazards.html#cb214-1" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(mcmc.out<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 686.3596</code></pre>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="hazards.html#cb216-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta0&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.8%20eff%20traceplots%20and%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="hazards.html#cb217-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta1&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta1&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.8%20eff%20traceplots%20and%20summary-2.png" width="672" /></p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="hazards.html#cb218-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta2&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta2&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.8%20eff%20traceplots%20and%20summary-3.png" width="672" /></p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="hazards.html#cb219-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta3&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta3&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.8%20eff%20traceplots%20and%20summary-4.png" width="672" /></p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="hazards.html#cb220-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;sigma&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;sigma&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.8%20eff%20traceplots%20and%20summary-5.png" width="672" /></p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="hazards.html#cb221-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;tau&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.8%20eff%20traceplots%20and%20summary-6.png" width="672" /></p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="hazards.html#cb222-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;phi&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.8%20eff%20traceplots%20and%20summary-7.png" width="672" /></p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="hazards.html#cb223-1" tabindex="-1"></a>mcmc.out<span class="sc">$</span>summary<span class="sc">$</span>all.chains[<span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta1&quot;</span>, <span class="st">&quot;beta2&quot;</span>, <span class="st">&quot;beta3&quot;</span>,<span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;tau&quot;</span>, <span class="st">&quot;phi&quot;</span>), ]</span></code></pre></div>
<pre><code>##               Mean       Median      St.Dev.   95%CI_low    95%CI_upp
## beta0   0.39364392   0.39277941   0.35719331  -0.3016104    1.1088945
## beta1   0.02804111   0.02476766   0.14864272  -0.2668795    0.3173510
## beta2  -0.03237002  -0.02862977   0.23275470  -0.4791750    0.4258925
## beta3  -0.27094361  -0.27115308   0.02261553  -0.3151008   -0.2270682
## sigma   1.31724434   1.27765984   0.24708799   0.9322191    1.8713042
## tau     0.43624410   0.43606721   0.01611994   0.4056233    0.4675887
## phi   966.33919625 874.35628803 421.02076899 446.1835680 1979.0718225</code></pre>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="hazards.html#cb225-1" tabindex="-1"></a><span class="fu">library</span>(rgdal)</span>
<span id="cb225-2"><a href="hazards.html#cb225-2" tabindex="-1"></a></span>
<span id="cb225-3"><a href="hazards.html#cb225-3" tabindex="-1"></a>grid <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(<span class="st">&quot;data/no2_europe/10km_grid.shp&quot;</span>)</span>
<span id="cb225-4"><a href="hazards.html#cb225-4" tabindex="-1"></a>covs_grid <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/no2_europe/centroids_altitude.csv&quot;</span>)</span>
<span id="cb225-5"><a href="hazards.html#cb225-5" tabindex="-1"></a></span>
<span id="cb225-6"><a href="hazards.html#cb225-6" tabindex="-1"></a>covs_grid_utm <span class="ot">&lt;-</span> <span class="fu">rename</span>(covs_grid, <span class="at">x =</span> lon, <span class="at">y =</span> lat)</span>
<span id="cb225-7"><a href="hazards.html#cb225-7" tabindex="-1"></a></span>
<span id="cb225-8"><a href="hazards.html#cb225-8" tabindex="-1"></a>covs_grid_utm <span class="ot">&lt;-</span></span>
<span id="cb225-9"><a href="hazards.html#cb225-9" tabindex="-1"></a>  <span class="fu">mutate</span>(covs_grid_utm, <span class="at">zone2 =</span> (<span class="fu">floor</span>((x <span class="sc">+</span> <span class="dv">180</span>)<span class="sc">/</span><span class="dv">6</span>) <span class="sc">%%</span> <span class="dv">60</span>) <span class="sc">+</span> <span class="dv">1</span>, <span class="at">keep =</span> <span class="st">&quot;all&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb225-10"><a href="hazards.html#cb225-10" tabindex="-1"></a>  <span class="fu">group_by</span>(zone2) <span class="sc">|&gt;</span> </span>
<span id="cb225-11"><a href="hazards.html#cb225-11" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">utm_x =</span> <span class="fu">get_utm</span>(x, y, zone2, <span class="at">loc =</span> <span class="st">&quot;x&quot;</span>),</span>
<span id="cb225-12"><a href="hazards.html#cb225-12" tabindex="-1"></a>         <span class="at">utm_y =</span> <span class="fu">get_utm</span>(x, y, zone2, <span class="at">loc =</span> <span class="st">&quot;y&quot;</span>))<span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb225-13"><a href="hazards.html#cb225-13" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(id, utm_x, utm_y, <span class="fu">starts_with</span>(<span class="st">&quot;eu_dem_v11&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb225-14"><a href="hazards.html#cb225-14" tabindex="-1"></a>  <span class="fu">gather</span>(layer, altitude, <span class="sc">-</span><span class="fu">c</span>(id, utm_x, utm_y), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) </span>
<span id="cb225-15"><a href="hazards.html#cb225-15" tabindex="-1"></a></span>
<span id="cb225-16"><a href="hazards.html#cb225-16" tabindex="-1"></a></span>
<span id="cb225-17"><a href="hazards.html#cb225-17" tabindex="-1"></a><span class="co"># Scale covariates grid</span></span>
<span id="cb225-18"><a href="hazards.html#cb225-18" tabindex="-1"></a>covs_grid_sc <span class="ot">&lt;-</span> covs_grid_utm[,<span class="fu">c</span>(<span class="st">&quot;utm_x&quot;</span>, <span class="st">&quot;utm_y&quot;</span>, <span class="st">&quot;altitude&quot;</span>)]</span>
<span id="cb225-19"><a href="hazards.html#cb225-19" tabindex="-1"></a>predCoords <span class="ot">&lt;-</span> covs_grid_utm[,<span class="fu">c</span>(<span class="st">&quot;utm_x&quot;</span>, <span class="st">&quot;utm_y&quot;</span>)]<span class="sc">/</span><span class="dv">1000</span></span>
<span id="cb225-20"><a href="hazards.html#cb225-20" tabindex="-1"></a></span>
<span id="cb225-21"><a href="hazards.html#cb225-21" tabindex="-1"></a></span>
<span id="cb225-22"><a href="hazards.html#cb225-22" tabindex="-1"></a>covs_grid_sc<span class="sc">$</span>utm_x <span class="ot">&lt;-</span> ((covs_grid_sc<span class="sc">$</span>utm_x<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">-</span> <span class="fu">mean</span>(no2_df<span class="sc">$</span>easting))<span class="sc">/</span><span class="fu">sd</span>(no2_df<span class="sc">$</span>easting)</span>
<span id="cb225-23"><a href="hazards.html#cb225-23" tabindex="-1"></a>covs_grid_sc<span class="sc">$</span>utm_y <span class="ot">&lt;-</span> ((covs_grid_sc<span class="sc">$</span>utm_y<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">-</span> <span class="fu">mean</span>(no2_df<span class="sc">$</span>northing))<span class="sc">/</span><span class="fu">sd</span>(no2_df<span class="sc">$</span>northing)</span>
<span id="cb225-24"><a href="hazards.html#cb225-24" tabindex="-1"></a>covs_grid_sc<span class="sc">$</span>altitude <span class="ot">&lt;-</span> (covs_grid_sc<span class="sc">$</span>altitude <span class="sc">-</span> <span class="fu">mean</span>(no2_df<span class="sc">$</span>altitude))<span class="sc">/</span><span class="fu">sd</span>(no2_df<span class="sc">$</span>altitude)</span></code></pre></div>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="hazards.html#cb226-1" tabindex="-1"></a><span class="co"># Extract samples from nimble model</span></span>
<span id="cb226-2"><a href="hazards.html#cb226-2" tabindex="-1"></a>tidy_post_samples <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>samples <span class="sc">|&gt;</span> <span class="fu">tidy_draws</span>()</span>
<span id="cb226-3"><a href="hazards.html#cb226-3" tabindex="-1"></a></span>
<span id="cb226-4"><a href="hazards.html#cb226-4" tabindex="-1"></a><span class="co"># Extract posterior samples for each of the parameters of interest</span></span>
<span id="cb226-5"><a href="hazards.html#cb226-5" tabindex="-1"></a>post_beta0 <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>beta0 <span class="sc">|&gt;</span> <span class="fu">median</span>()</span>
<span id="cb226-6"><a href="hazards.html#cb226-6" tabindex="-1"></a>post_beta1 <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>beta1 <span class="sc">|&gt;</span> <span class="fu">median</span>()</span>
<span id="cb226-7"><a href="hazards.html#cb226-7" tabindex="-1"></a>post_beta2 <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>beta2 <span class="sc">|&gt;</span> <span class="fu">median</span>()</span>
<span id="cb226-8"><a href="hazards.html#cb226-8" tabindex="-1"></a>post_beta3 <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>beta3 <span class="sc">|&gt;</span> <span class="fu">median</span>()</span>
<span id="cb226-9"><a href="hazards.html#cb226-9" tabindex="-1"></a></span>
<span id="cb226-10"><a href="hazards.html#cb226-10" tabindex="-1"></a>post_sigmasq <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>sigma_sq <span class="sc">|&gt;</span> <span class="fu">median</span>()</span>
<span id="cb226-11"><a href="hazards.html#cb226-11" tabindex="-1"></a>post_phi <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>phi <span class="sc">|&gt;</span> <span class="fu">median</span>()</span>
<span id="cb226-12"><a href="hazards.html#cb226-12" tabindex="-1"></a>post_tausq <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>tau_sq <span class="sc">|&gt;</span> <span class="fu">median</span>()</span>
<span id="cb226-13"><a href="hazards.html#cb226-13" tabindex="-1"></a></span>
<span id="cb226-14"><a href="hazards.html#cb226-14" tabindex="-1"></a>n0 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(covs_grid_sc)</span>
<span id="cb226-15"><a href="hazards.html#cb226-15" tabindex="-1"></a><span class="co"># L &lt;- length(post_tausq)</span></span>
<span id="cb226-16"><a href="hazards.html#cb226-16" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb226-17"><a href="hazards.html#cb226-17" tabindex="-1"></a></span>
<span id="cb226-18"><a href="hazards.html#cb226-18" tabindex="-1"></a>obsMu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, easting_scaled, northing_scaled, altitude_scaled) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(post_beta0, post_beta1, post_beta2, post_beta3))</span>
<span id="cb226-19"><a href="hazards.html#cb226-19" tabindex="-1"></a></span>
<span id="cb226-20"><a href="hazards.html#cb226-20" tabindex="-1"></a>predMu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, <span class="fu">as.matrix</span>(covs_grid_sc)) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(post_beta0, post_beta1, post_beta2, post_beta3))</span>
<span id="cb226-21"><a href="hazards.html#cb226-21" tabindex="-1"></a></span>
<span id="cb226-22"><a href="hazards.html#cb226-22" tabindex="-1"></a>pred2obsDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(predCoords, obsCoords)</span>
<span id="cb226-23"><a href="hazards.html#cb226-23" tabindex="-1"></a></span>
<span id="cb226-24"><a href="hazards.html#cb226-24" tabindex="-1"></a></span>
<span id="cb226-25"><a href="hazards.html#cb226-25" tabindex="-1"></a>Rcpp<span class="sc">::</span><span class="fu">sourceCpp</span>(<span class="st">&quot;functions/prediction_marginal_gp12.cpp&quot;</span>)</span>
<span id="cb226-26"><a href="hazards.html#cb226-26" tabindex="-1"></a><span class="fu">args</span>(prediction_marginal_gp12)</span></code></pre></div>
<pre><code>## function (y, obsMu, predMu, obsDistMat, pred2ObsDistMat, sigmasq, 
##     phi, tausq, iterprint) 
## NULL</code></pre>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="hazards.html#cb228-1" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb228-2"><a href="hazards.html#cb228-2" tabindex="-1"></a>  pred_samples <span class="ot">&lt;-</span> <span class="fu">prediction_marginal_gp12</span>(</span>
<span id="cb228-3"><a href="hazards.html#cb228-3" tabindex="-1"></a>    <span class="at">y =</span> no2_df<span class="sc">$</span>y,</span>
<span id="cb228-4"><a href="hazards.html#cb228-4" tabindex="-1"></a>    <span class="at">obsMu =</span> obsMu,</span>
<span id="cb228-5"><a href="hazards.html#cb228-5" tabindex="-1"></a>    <span class="at">predMu =</span> predMu,</span>
<span id="cb228-6"><a href="hazards.html#cb228-6" tabindex="-1"></a>    <span class="at">obsDistMat =</span> obsDist,</span>
<span id="cb228-7"><a href="hazards.html#cb228-7" tabindex="-1"></a>    <span class="at">pred2ObsDistMat =</span> pred2obsDist,</span>
<span id="cb228-8"><a href="hazards.html#cb228-8" tabindex="-1"></a>    <span class="at">sigmasq =</span> post_sigmasq,</span>
<span id="cb228-9"><a href="hazards.html#cb228-9" tabindex="-1"></a>    <span class="at">phi =</span> post_phi,</span>
<span id="cb228-10"><a href="hazards.html#cb228-10" tabindex="-1"></a>    <span class="at">tausq =</span> post_tausq,</span>
<span id="cb228-11"><a href="hazards.html#cb228-11" tabindex="-1"></a>    <span class="at">iterprint =</span> <span class="dv">100</span></span>
<span id="cb228-12"><a href="hazards.html#cb228-12" tabindex="-1"></a>  )</span>
<span id="cb228-13"><a href="hazards.html#cb228-13" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Prediction upto the 0th MCMC sample is completed</code></pre>
<pre><code>##    user  system elapsed 
##    4.36    0.16   29.20</code></pre>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="hazards.html#cb231-1" tabindex="-1"></a>covs_grid_utm <span class="ot">&lt;-</span> <span class="fu">mutate</span>(covs_grid_utm, <span class="at">pred =</span> pred_samples)</span>
<span id="cb231-2"><a href="hazards.html#cb231-2" tabindex="-1"></a></span>
<span id="cb231-3"><a href="hazards.html#cb231-3" tabindex="-1"></a>cut_grid <span class="ot">&lt;-</span> grid[(grid<span class="sc">$</span>id <span class="sc">%in%</span> covs_grid_utm<span class="sc">$</span>id),]</span>
<span id="cb231-4"><a href="hazards.html#cb231-4" tabindex="-1"></a>cut_grid <span class="ot">&lt;-</span> cut_grid[<span class="fu">order</span>(cut_grid<span class="sc">$</span>id, <span class="at">decreasing =</span> <span class="cn">FALSE</span>),]</span>
<span id="cb231-5"><a href="hazards.html#cb231-5" tabindex="-1"></a>covs_grid_utm <span class="ot">&lt;-</span> covs_grid_utm[<span class="fu">order</span>(covs_grid_utm<span class="sc">$</span>id, <span class="at">decreasing =</span> <span class="cn">FALSE</span>),]</span>
<span id="cb231-6"><a href="hazards.html#cb231-6" tabindex="-1"></a>cut_grid<span class="sc">$</span>pred <span class="ot">&lt;-</span> covs_grid_utm<span class="sc">$</span>pred</span>
<span id="cb231-7"><a href="hazards.html#cb231-7" tabindex="-1"></a></span>
<span id="cb231-8"><a href="hazards.html#cb231-8" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_sf</span>(<span class="at">data =</span> cut_grid, <span class="at">colour =</span> <span class="cn">NA</span>, <span class="fu">aes</span>(<span class="at">fill =</span> pred)) <span class="sc">+</span> </span>
<span id="cb231-9"><a href="hazards.html#cb231-9" tabindex="-1"></a>  ditch_the_axes <span class="sc">+</span> <span class="fu">scale_fill_viridis_c</span>(<span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">name =</span> <span class="fu">bquote</span>(<span class="st">&quot;log&quot;</span> <span class="sc">~</span>NO[<span class="dv">2</span>]<span class="sc">*</span> <span class="st">&quot; concentration&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.8%20spatial%20predictions%20using%20Rcpp-1.png" width="672" />
## Example 10.10 Creating a mesh: black smoke monitoring locations in the UK</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="hazards.html#cb232-1" tabindex="-1"></a>mesh <span class="ot">=</span> <span class="fu">inla.mesh.create</span>(</span>
<span id="cb232-2"><a href="hazards.html#cb232-2" tabindex="-1"></a>  locations[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],</span>
<span id="cb232-3"><a href="hazards.html#cb232-3" tabindex="-1"></a>  <span class="at">extend =</span> <span class="fu">list</span>(<span class="at">offset =</span> <span class="sc">-</span><span class="fl">0.1</span>),</span>
<span id="cb232-4"><a href="hazards.html#cb232-4" tabindex="-1"></a>  <span class="at">cutoff =</span> <span class="dv">1</span>,</span>
<span id="cb232-5"><a href="hazards.html#cb232-5" tabindex="-1"></a>  <span class="co"># Refined triangulation, minimal angles &gt;=26 degrees ,</span></span>
<span id="cb232-6"><a href="hazards.html#cb232-6" tabindex="-1"></a>  <span class="co"># interior maximal edge lengths 0.08,</span></span>
<span id="cb232-7"><a href="hazards.html#cb232-7" tabindex="-1"></a>  <span class="co"># exterior maximal edge lengths 0.2:</span></span>
<span id="cb232-8"><a href="hazards.html#cb232-8" tabindex="-1"></a>  <span class="at">refine =</span> (<span class="fu">list</span>(</span>
<span id="cb232-9"><a href="hazards.html#cb232-9" tabindex="-1"></a>    <span class="at">min.angle =</span> <span class="dv">26</span>,</span>
<span id="cb232-10"><a href="hazards.html#cb232-10" tabindex="-1"></a>    <span class="at">max.edge.data =</span> <span class="dv">100</span>,</span>
<span id="cb232-11"><a href="hazards.html#cb232-11" tabindex="-1"></a>    <span class="at">max.edge.extra =</span> <span class="dv">200</span></span>
<span id="cb232-12"><a href="hazards.html#cb232-12" tabindex="-1"></a>  ))</span>
<span id="cb232-13"><a href="hazards.html#cb232-13" tabindex="-1"></a>)</span>
<span id="cb232-14"><a href="hazards.html#cb232-14" tabindex="-1"></a></span>
<span id="cb232-15"><a href="hazards.html#cb232-15" tabindex="-1"></a>ukmap <span class="ot">&lt;-</span></span>
<span id="cb232-16"><a href="hazards.html#cb232-16" tabindex="-1"></a>  <span class="fu">readShapeLines</span>(<span class="st">&quot;uk_BNG.shp&quot;</span>) <span class="fu">plot</span>(mesh , <span class="at">col =</span> <span class="st">&quot;gray&quot;</span>, <span class="at">main =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb232-17"><a href="hazards.html#cb232-17" tabindex="-1"></a><span class="fu">lines</span>(ukmap)</span>
<span id="cb232-18"><a href="hazards.html#cb232-18" tabindex="-1"></a><span class="fu">points</span>(locations ,</span>
<span id="cb232-19"><a href="hazards.html#cb232-19" tabindex="-1"></a>       <span class="at">col =</span> <span class="st">&quot;red&quot;</span>,</span>
<span id="cb232-20"><a href="hazards.html#cb232-20" tabindex="-1"></a>       <span class="at">pch =</span> <span class="dv">20</span>,</span>
<span id="cb232-21"><a href="hazards.html#cb232-21" tabindex="-1"></a>       <span class="at">bg =</span> <span class="st">&quot;red&quot;</span>) </span></code></pre></div>
</div>
<div id="example-10.12-plotting-directional-variograms-for-temperatures-in-california" class="section level2 hasAnchor" number="10.2">
<h2><span class="header-section-number">10.2</span> Example 10.12 Plotting directional variograms for temperatures in California<a href="hazards.html#example-10.12-plotting-directional-variograms-for-temperatures-in-california" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="hazards.html#cb233-1" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb233-2"><a href="hazards.html#cb233-2" tabindex="-1"></a><span class="fu">library</span>(sp)</span>
<span id="cb233-3"><a href="hazards.html#cb233-3" tabindex="-1"></a></span>
<span id="cb233-4"><a href="hazards.html#cb233-4" tabindex="-1"></a><span class="do">### First we load the data</span></span>
<span id="cb233-5"><a href="hazards.html#cb233-5" tabindex="-1"></a>CAmetadata<span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;data/metadataCA.txt&quot;</span>,<span class="at">header=</span><span class="cn">TRUE</span>)</span>
<span id="cb233-6"><a href="hazards.html#cb233-6" tabindex="-1"></a>CATemp<span class="ot">&lt;-</span><span class="fu">read.csv</span>(<span class="st">&quot;data/MaxCaliforniaTemp.csv&quot;</span>,<span class="at">header=</span><span class="cn">TRUE</span>)</span>
<span id="cb233-7"><a href="hazards.html#cb233-7" tabindex="-1"></a>CATemp_20120401<span class="ot">&lt;-</span>CATemp[CATemp<span class="sc">$</span>X<span class="sc">==</span><span class="dv">20120401</span>, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">14</span>)]</span>
<span id="cb233-8"><a href="hazards.html#cb233-8" tabindex="-1"></a>CATemp_20120401<span class="ot">&lt;-</span><span class="fu">t</span>(CATemp_20120401)</span>
<span id="cb233-9"><a href="hazards.html#cb233-9" tabindex="-1"></a></span>
<span id="cb233-10"><a href="hazards.html#cb233-10" tabindex="-1"></a><span class="do">### Change names of lat, long</span></span>
<span id="cb233-11"><a href="hazards.html#cb233-11" tabindex="-1"></a><span class="fu">names</span>(CAmetadata)[<span class="fu">names</span>(CAmetadata)<span class="sc">==</span><span class="st">&quot;Long&quot;</span>]<span class="ot">&lt;-</span><span class="st">&quot;x&quot;</span></span>
<span id="cb233-12"><a href="hazards.html#cb233-12" tabindex="-1"></a><span class="fu">names</span>(CAmetadata)[<span class="fu">names</span>(CAmetadata)<span class="sc">==</span><span class="st">&quot;Lat&quot;</span>]<span class="ot">&lt;-</span><span class="st">&quot;y&quot;</span></span>
<span id="cb233-13"><a href="hazards.html#cb233-13" tabindex="-1"></a></span>
<span id="cb233-14"><a href="hazards.html#cb233-14" tabindex="-1"></a><span class="do">### Augment data file with coordinates</span></span>
<span id="cb233-15"><a href="hazards.html#cb233-15" tabindex="-1"></a>CATemp_20120401 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(CAmetadata, CATemp_20120401<span class="sc">/</span><span class="dv">10</span>)</span>
<span id="cb233-16"><a href="hazards.html#cb233-16" tabindex="-1"></a><span class="fu">names</span>(CATemp_20120401)[<span class="fu">names</span>(CATemp_20120401) <span class="sc">==</span> <span class="st">&quot;92&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;Temp&quot;</span></span>
<span id="cb233-17"><a href="hazards.html#cb233-17" tabindex="-1"></a></span>
<span id="cb233-18"><a href="hazards.html#cb233-18" tabindex="-1"></a>CATempOri.geo <span class="ot">&lt;-</span></span>
<span id="cb233-19"><a href="hazards.html#cb233-19" tabindex="-1"></a>  <span class="fu">as.geodata</span>(CATemp_20120401,</span>
<span id="cb233-20"><a href="hazards.html#cb233-20" tabindex="-1"></a>             <span class="at">coords.col =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>,</span>
<span id="cb233-21"><a href="hazards.html#cb233-21" tabindex="-1"></a>             <span class="at">data.col =</span> <span class="dv">7</span>)</span>
<span id="cb233-22"><a href="hazards.html#cb233-22" tabindex="-1"></a></span>
<span id="cb233-23"><a href="hazards.html#cb233-23" tabindex="-1"></a><span class="do">### Compute empirical variograms for the residual process with geoR. </span></span>
<span id="cb233-24"><a href="hazards.html#cb233-24" tabindex="-1"></a><span class="do">###  The power variogram seemed best</span></span>
<span id="cb233-25"><a href="hazards.html#cb233-25" tabindex="-1"></a><span class="do">### although this points to nonstationarity in the process</span></span>
<span id="cb233-26"><a href="hazards.html#cb233-26" tabindex="-1"></a>CA.vario4 <span class="ot">&lt;-</span> <span class="fu">variog4</span>(CATempOri.geo, <span class="at">uvec =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">8</span>, <span class="at">l =</span> <span class="dv">8</span>))</span></code></pre></div>
<pre><code>## variog: computing variogram for direction = 0 degrees (0 radians)
##         tolerance angle = 22.5 degrees (0.393 radians)
## variog: computing variogram for direction = 45 degrees (0.785 radians)
##         tolerance angle = 22.5 degrees (0.393 radians)
## variog: computing variogram for direction = 90 degrees (1.571 radians)
##         tolerance angle = 22.5 degrees (0.393 radians)
## variog: computing variogram for direction = 135 degrees (2.356 radians)
##         tolerance angle = 22.5 degrees (0.393 radians)
## variog: computing omnidirectional variogram</code></pre>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="hazards.html#cb235-1" tabindex="-1"></a><span class="fu">plot</span>(CA.vario4)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.12%20directional%20variogram-1.png" width="672" /></p>
<!-- REVIEW: I am not sure where this example goes -->
</div>
<div id="example-10.14-spatial-modeling-of-malaria-in-gambia" class="section level2 unnumbered hasAnchor">
<h2>Example 10.14: Spatial modeling of malaria in Gambia<a href="hazards.html#example-10.14-spatial-modeling-of-malaria-in-gambia" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Note: There might be a warning when loading the <span class="math inline">\(\texttt{raster}\)</span> package, if necessary, uninstall and re-install the package.</p>
<p>For this example we are using the same <span class="math inline">\(\texttt{gambia}\)</span> data set from the <span class="math inline">\(\texttt{geoR}\)</span> package but an <span class="math inline">\(\texttt{id_area}\)</span> column was added using QGIS to differentiate the different areas as in the original paper. Therefore, we need to load the <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/malaria_gambia/gambia_area.csv">gambia_area.csv</a> file.</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="hazards.html#cb236-1" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># to manipulate the data</span></span>
<span id="cb236-2"><a href="hazards.html#cb236-2" tabindex="-1"></a><span class="fu">library</span>(geoR) <span class="co"># to get the dataset</span></span>
<span id="cb236-3"><a href="hazards.html#cb236-3" tabindex="-1"></a><span class="fu">library</span>(ggmap) <span class="co"># to plot the map</span></span>
<span id="cb236-4"><a href="hazards.html#cb236-4" tabindex="-1"></a><span class="fu">library</span>(nimble) <span class="co"># for modeling</span></span>
<span id="cb236-5"><a href="hazards.html#cb236-5" tabindex="-1"></a><span class="co">#library(raster) # to get the environmental data</span></span>
<span id="cb236-6"><a href="hazards.html#cb236-6" tabindex="-1"></a><span class="fu">library</span>(rgdal) <span class="co"># for adding and transforming coordinates</span></span>
<span id="cb236-7"><a href="hazards.html#cb236-7" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># manipulate spatial data</span></span>
<span id="cb236-8"><a href="hazards.html#cb236-8" tabindex="-1"></a><span class="fu">library</span>(sp) <span class="co"># for manipulating spatial data</span></span>
<span id="cb236-9"><a href="hazards.html#cb236-9" tabindex="-1"></a><span class="fu">library</span>(stringr) <span class="co"># to analyze posterior</span></span>
<span id="cb236-10"><a href="hazards.html#cb236-10" tabindex="-1"></a><span class="fu">library</span>(viridis) <span class="co"># for a more cheerful color palette</span></span>
<span id="cb236-11"><a href="hazards.html#cb236-11" tabindex="-1"></a></span>
<span id="cb236-12"><a href="hazards.html#cb236-12" tabindex="-1"></a><span class="co"># Note, we are using the same Gambia dataset as in the geoR package but an id_area</span></span>
<span id="cb236-13"><a href="hazards.html#cb236-13" tabindex="-1"></a><span class="co"># attribute has been added using QGIS to a</span></span>
<span id="cb236-14"><a href="hazards.html#cb236-14" tabindex="-1"></a>gambia <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/malaria_gambia/gambia_area.csv&quot;</span>) <span class="co"># gambia dataset from geoR package</span></span></code></pre></div>
<p>Since the data is given at the individual level, we want to aggregate the malaria tests by village.
If we explore the data frame we see that there are 2035 individuals at 65 villages.</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="hazards.html#cb237-1" tabindex="-1"></a><span class="fu">head</span>(gambia)</span></code></pre></div>
<pre><code>##          x       y pos  age netuse treated green phc id_area
## 1 349631.3 1458055   1 1783      0       0 40.85   1       1
## 2 349631.3 1458055   0  404      1       0 40.85   1       1
## 3 349631.3 1458055   0  452      1       0 40.85   1       1
## 4 349631.3 1458055   1  566      1       0 40.85   1       1
## 5 349631.3 1458055   0  598      1       0 40.85   1       1
## 6 349631.3 1458055   1  590      1       0 40.85   1       1</code></pre>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="hazards.html#cb239-1" tabindex="-1"></a><span class="fu">dim</span>(gambia)</span></code></pre></div>
<pre><code>## [1] 2035    9</code></pre>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="hazards.html#cb241-1" tabindex="-1"></a><span class="fu">dim</span>(<span class="fu">unique</span>(gambia[, <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>)]))</span></code></pre></div>
<pre><code>## [1] 65  2</code></pre>
<p>We create a new data frame aggregated by village containing the coordinates, the number of malaria tests, and the prevalence.</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="hazards.html#cb243-1" tabindex="-1"></a>malaria_village <span class="ot">&lt;-</span> <span class="fu">group_by</span>(gambia, x, y) <span class="sc">|&gt;</span></span>
<span id="cb243-2"><a href="hazards.html#cb243-2" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">total =</span> <span class="fu">n</span>(),</span>
<span id="cb243-3"><a href="hazards.html#cb243-3" tabindex="-1"></a>            <span class="at">positive =</span> <span class="fu">sum</span>(pos),</span>
<span id="cb243-4"><a href="hazards.html#cb243-4" tabindex="-1"></a>            <span class="at">prev =</span> positive <span class="sc">/</span> total) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span></code></pre></div>
<pre><code>## `summarise()` has grouped output by &#39;x&#39;. You can override
## using the `.groups` argument.</code></pre>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="hazards.html#cb245-1" tabindex="-1"></a><span class="fu">head</span>(malaria_village)</span></code></pre></div>
<pre><code>##          x       y total positive      prev
## 1 349631.3 1458055    33       17 0.5151515
## 2 358543.1 1460112    63       19 0.3015873
## 3 360308.1 1460026    17        7 0.4117647
## 4 363795.7 1496919    24        8 0.3333333
## 5 366400.5 1460248    26       10 0.3846154
## 6 366687.5 1463002    18        7 0.3888889</code></pre>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="hazards.html#cb247-1" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb247-2"><a href="hazards.html#cb247-2" tabindex="-1"></a>malaria_utm <span class="ot">&lt;-</span> malaria_village</span>
<span id="cb247-3"><a href="hazards.html#cb247-3" tabindex="-1"></a><span class="fu">coordinates</span>(malaria_utm) <span class="ot">&lt;-</span> <span class="er">~</span> x <span class="sc">+</span> y</span>
<span id="cb247-4"><a href="hazards.html#cb247-4" tabindex="-1"></a><span class="fu">proj4string</span>(malaria_utm) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=28&quot;</span>)</span>
<span id="cb247-5"><a href="hazards.html#cb247-5" tabindex="-1"></a><span class="co"># convert to long lat </span></span>
<span id="cb247-6"><a href="hazards.html#cb247-6" tabindex="-1"></a>malaria_geo <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(malaria_utm, <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>))</span>
<span id="cb247-7"><a href="hazards.html#cb247-7" tabindex="-1"></a><span class="co"># add long lat coordinates to malaria dataframe</span></span>
<span id="cb247-8"><a href="hazards.html#cb247-8" tabindex="-1"></a>malaria_village[, <span class="fu">c</span>(<span class="st">&quot;long&quot;</span>, <span class="st">&quot;lat&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">coordinates</span>(malaria_geo)</span>
<span id="cb247-9"><a href="hazards.html#cb247-9" tabindex="-1"></a></span>
<span id="cb247-10"><a href="hazards.html#cb247-10" tabindex="-1"></a><span class="co"># specify the bounding box</span></span>
<span id="cb247-11"><a href="hazards.html#cb247-11" tabindex="-1"></a>latLongBox <span class="ot">=</span> <span class="fu">bbox</span>(malaria_geo)</span>
<span id="cb247-12"><a href="hazards.html#cb247-12" tabindex="-1"></a>location <span class="ot">=</span> <span class="fu">c</span>(latLongBox[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb247-13"><a href="hazards.html#cb247-13" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb247-14"><a href="hazards.html#cb247-14" tabindex="-1"></a>             latLongBox[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.05</span>,</span>
<span id="cb247-15"><a href="hazards.html#cb247-15" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.05</span>)</span>
<span id="cb247-16"><a href="hazards.html#cb247-16" tabindex="-1"></a></span>
<span id="cb247-17"><a href="hazards.html#cb247-17" tabindex="-1"></a><span class="co"># create map with location dots marked on it in</span></span>
<span id="cb247-18"><a href="hazards.html#cb247-18" tabindex="-1"></a>GambiaMap <span class="ot">&lt;-</span></span>
<span id="cb247-19"><a href="hazards.html#cb247-19" tabindex="-1"></a>  <span class="fu">get_stamenmap</span>(<span class="at">bbox =</span>  location,</span>
<span id="cb247-20"><a href="hazards.html#cb247-20" tabindex="-1"></a>                <span class="at">zoom =</span> <span class="dv">11</span>,</span>
<span id="cb247-21"><a href="hazards.html#cb247-21" tabindex="-1"></a>                <span class="at">type =</span> terrain<span class="sc">-</span>background)</span>
<span id="cb247-22"><a href="hazards.html#cb247-22" tabindex="-1"></a></span>
<span id="cb247-23"><a href="hazards.html#cb247-23" tabindex="-1"></a><span class="fu">ggmap</span>(GambiaMap) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">data =</span> malaria_village,</span>
<span id="cb247-24"><a href="hazards.html#cb247-24" tabindex="-1"></a>                              <span class="fu">aes</span>(<span class="at">x =</span> long,</span>
<span id="cb247-25"><a href="hazards.html#cb247-25" tabindex="-1"></a>                                  <span class="at">y =</span> lat,</span>
<span id="cb247-26"><a href="hazards.html#cb247-26" tabindex="-1"></a>                                  <span class="at">col =</span> prev),</span>
<span id="cb247-27"><a href="hazards.html#cb247-27" tabindex="-1"></a>                              <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">scale_color_viridis</span>() <span class="sc">+</span> <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20plot%20prevalence-1.png" width="672" /></p>
<div id="nimble-4" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="hazards.html#nimble-4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="hazards.html#cb248-1" tabindex="-1"></a>Example10_14_Nimble <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb248-2"><a href="hazards.html#cb248-2" tabindex="-1"></a>  </span>
<span id="cb248-3"><a href="hazards.html#cb248-3" tabindex="-1"></a>  <span class="co"># Define priors</span></span>
<span id="cb248-4"><a href="hazards.html#cb248-4" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb248-5"><a href="hazards.html#cb248-5" tabindex="-1"></a>  sigma_sq <span class="ot">&lt;-</span> sigma <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb248-6"><a href="hazards.html#cb248-6" tabindex="-1"></a>  phi_inv <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="at">shape =</span>  <span class="dv">5</span>, <span class="at">rate =</span> <span class="dv">5</span>)</span>
<span id="cb248-7"><a href="hazards.html#cb248-7" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> phi_inv</span>
<span id="cb248-8"><a href="hazards.html#cb248-8" tabindex="-1"></a></span>
<span id="cb248-9"><a href="hazards.html#cb248-9" tabindex="-1"></a>  Sigma[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span></span>
<span id="cb248-10"><a href="hazards.html#cb248-10" tabindex="-1"></a>     sigma_sq<span class="sc">*</span>(<span class="dv">1</span> <span class="sc">+</span> (<span class="fu">sqrt</span>(<span class="dv">3</span>)<span class="sc">*</span>obs_dist_mat[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N])<span class="sc">/</span>phi) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">sqrt</span>(<span class="dv">3</span>)<span class="sc">*</span>obs_dist_mat[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="sc">/</span> phi) </span>
<span id="cb248-11"><a href="hazards.html#cb248-11" tabindex="-1"></a></span>
<span id="cb248-12"><a href="hazards.html#cb248-12" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb248-13"><a href="hazards.html#cb248-13" tabindex="-1"></a>    mean_S[i] <span class="ot">&lt;-</span> b0</span>
<span id="cb248-14"><a href="hazards.html#cb248-14" tabindex="-1"></a>    }</span>
<span id="cb248-15"><a href="hazards.html#cb248-15" tabindex="-1"></a>  </span>
<span id="cb248-16"><a href="hazards.html#cb248-16" tabindex="-1"></a>  S[<span class="dv">1</span><span class="sc">:</span>N] <span class="sc">~</span> <span class="fu">dmnorm</span>(mean_S[<span class="dv">1</span><span class="sc">:</span>N], <span class="at">cov =</span> Sigma[<span class="dv">1</span><span class="sc">:</span>N,<span class="dv">1</span><span class="sc">:</span>N])</span>
<span id="cb248-17"><a href="hazards.html#cb248-17" tabindex="-1"></a></span>
<span id="cb248-18"><a href="hazards.html#cb248-18" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {  <span class="co"># by child</span></span>
<span id="cb248-19"><a href="hazards.html#cb248-19" tabindex="-1"></a>    <span class="fu">logit</span>(p[j])  <span class="ot">&lt;-</span> <span class="fu">inprod</span>(b[<span class="dv">1</span><span class="sc">:</span>k], X[j,<span class="dv">1</span><span class="sc">:</span>k]) <span class="sc">+</span> S[index_village[j]]</span>
<span id="cb248-20"><a href="hazards.html#cb248-20" tabindex="-1"></a>    y[j] <span class="sc">~</span> <span class="fu">dbern</span>(p[j])</span>
<span id="cb248-21"><a href="hazards.html#cb248-21" tabindex="-1"></a>    }</span>
<span id="cb248-22"><a href="hazards.html#cb248-22" tabindex="-1"></a></span>
<span id="cb248-23"><a href="hazards.html#cb248-23" tabindex="-1"></a>  <span class="cf">for</span> (l <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb248-24"><a href="hazards.html#cb248-24" tabindex="-1"></a>    b[l] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">5</span>)</span>
<span id="cb248-25"><a href="hazards.html#cb248-25" tabindex="-1"></a>  }</span>
<span id="cb248-26"><a href="hazards.html#cb248-26" tabindex="-1"></a>  </span>
<span id="cb248-27"><a href="hazards.html#cb248-27" tabindex="-1"></a>  b0 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">5</span>)</span>
<span id="cb248-28"><a href="hazards.html#cb248-28" tabindex="-1"></a>  </span>
<span id="cb248-29"><a href="hazards.html#cb248-29" tabindex="-1"></a></span>
<span id="cb248-30"><a href="hazards.html#cb248-30" tabindex="-1"></a></span>
<span id="cb248-31"><a href="hazards.html#cb248-31" tabindex="-1"></a>})</span></code></pre></div>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="hazards.html#cb249-1" tabindex="-1"></a><span class="co"># distance specification</span></span>
<span id="cb249-2"><a href="hazards.html#cb249-2" tabindex="-1"></a>coords_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(malaria_village[,<span class="fu">c</span>(<span class="st">&quot;long&quot;</span>,<span class="st">&quot;lat&quot;</span>)], </span>
<span id="cb249-3"><a href="hazards.html#cb249-3" tabindex="-1"></a>                          <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;long&quot;</span>,<span class="st">&quot;lat&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb249-4"><a href="hazards.html#cb249-4" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_set_crs</span>(<span class="dv">4326</span>)</span>
<span id="cb249-5"><a href="hazards.html#cb249-5" tabindex="-1"></a>obs_dist_mat <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_distance</span>(coords_sf)</span>
<span id="cb249-6"><a href="hazards.html#cb249-6" tabindex="-1"></a>obs_dist_mat <span class="ot">&lt;-</span> units<span class="sc">::</span><span class="fu">set_units</span>(obs_dist_mat, km)</span>
<span id="cb249-7"><a href="hazards.html#cb249-7" tabindex="-1"></a>obs_dist_mat <span class="ot">&lt;-</span> units<span class="sc">::</span><span class="fu">set_units</span>(obs_dist_mat, <span class="cn">NULL</span>)</span>
<span id="cb249-8"><a href="hazards.html#cb249-8" tabindex="-1"></a></span>
<span id="cb249-9"><a href="hazards.html#cb249-9" tabindex="-1"></a><span class="co"># define indicator variables for each village</span></span>
<span id="cb249-10"><a href="hazards.html#cb249-10" tabindex="-1"></a></span>
<span id="cb249-11"><a href="hazards.html#cb249-11" tabindex="-1"></a>gambia_df <span class="ot">&lt;-</span> <span class="fu">mutate</span>(</span>
<span id="cb249-12"><a href="hazards.html#cb249-12" tabindex="-1"></a>  gambia,</span>
<span id="cb249-13"><a href="hazards.html#cb249-13" tabindex="-1"></a>  <span class="at">id_child =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(gambia), <span class="co"># add an id for each child</span></span>
<span id="cb249-14"><a href="hazards.html#cb249-14" tabindex="-1"></a>  <span class="at">value =</span> <span class="dv">1</span>, <span class="co"># this will be needed later for the villages</span></span>
<span id="cb249-15"><a href="hazards.html#cb249-15" tabindex="-1"></a>  <span class="at">id_village =</span> <span class="fu">as.numeric</span>(<span class="fu">interaction</span>( <span class="co"># add an id for the villages</span></span>
<span id="cb249-16"><a href="hazards.html#cb249-16" tabindex="-1"></a>    x, y, <span class="at">drop =</span> <span class="cn">TRUE</span>, <span class="at">lex.order =</span> <span class="cn">TRUE</span></span>
<span id="cb249-17"><a href="hazards.html#cb249-17" tabindex="-1"></a>  ))</span>
<span id="cb249-18"><a href="hazards.html#cb249-18" tabindex="-1"></a>)  <span class="sc">|&gt;</span> </span>
<span id="cb249-19"><a href="hazards.html#cb249-19" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">spread</span>(id_area, value, <span class="at">fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb249-20"><a href="hazards.html#cb249-20" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">area1 =</span> <span class="st">&#39;1&#39;</span>, <span class="at">area2 =</span> <span class="st">&#39;2&#39;</span>, <span class="at">area3 =</span> <span class="st">&#39;3&#39;</span>, <span class="at">area4 =</span> <span class="st">&#39;4&#39;</span>, <span class="at">area5 =</span> <span class="st">&#39;5&#39;</span>)</span>
<span id="cb249-21"><a href="hazards.html#cb249-21" tabindex="-1"></a></span>
<span id="cb249-22"><a href="hazards.html#cb249-22" tabindex="-1"></a><span class="do">## Model specification</span></span>
<span id="cb249-23"><a href="hazards.html#cb249-23" tabindex="-1"></a><span class="co"># Variables matrix</span></span>
<span id="cb249-24"><a href="hazards.html#cb249-24" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">age =</span> <span class="fu">scale</span>(gambia_df[,<span class="st">&quot;age&quot;</span>], <span class="at">center =</span> <span class="cn">TRUE</span>, <span class="at">scale =</span> <span class="cn">FALSE</span>),</span>
<span id="cb249-25"><a href="hazards.html#cb249-25" tabindex="-1"></a>                <span class="at">netuse =</span> gambia_df[,<span class="st">&quot;netuse&quot;</span>],</span>
<span id="cb249-26"><a href="hazards.html#cb249-26" tabindex="-1"></a>                <span class="at">treated =</span> gambia_df[,<span class="st">&quot;treated&quot;</span>],</span>
<span id="cb249-27"><a href="hazards.html#cb249-27" tabindex="-1"></a>                <span class="at">green =</span> <span class="fu">scale</span>(gambia_df[,<span class="st">&quot;green&quot;</span>], <span class="at">center =</span> <span class="cn">TRUE</span>, <span class="at">scale =</span> <span class="cn">FALSE</span>),</span>
<span id="cb249-28"><a href="hazards.html#cb249-28" tabindex="-1"></a>                <span class="at">phc =</span> gambia_df[,<span class="st">&quot;phc&quot;</span>],</span>
<span id="cb249-29"><a href="hazards.html#cb249-29" tabindex="-1"></a>                <span class="at">area2 =</span> gambia_df[,<span class="st">&quot;area2&quot;</span>],</span>
<span id="cb249-30"><a href="hazards.html#cb249-30" tabindex="-1"></a>                <span class="at">area3 =</span> gambia_df[,<span class="st">&quot;area3&quot;</span>],</span>
<span id="cb249-31"><a href="hazards.html#cb249-31" tabindex="-1"></a>                <span class="at">area4 =</span> gambia_df[,<span class="st">&quot;area4&quot;</span>],</span>
<span id="cb249-32"><a href="hazards.html#cb249-32" tabindex="-1"></a>                <span class="at">area5 =</span> gambia_df[,<span class="st">&quot;area5&quot;</span>]</span>
<span id="cb249-33"><a href="hazards.html#cb249-33" tabindex="-1"></a>                )</span>
<span id="cb249-34"><a href="hazards.html#cb249-34" tabindex="-1"></a></span>
<span id="cb249-35"><a href="hazards.html#cb249-35" tabindex="-1"></a>index_village <span class="ot">&lt;-</span> gambia_df[,<span class="st">&quot;id_village&quot;</span>]</span>
<span id="cb249-36"><a href="hazards.html#cb249-36" tabindex="-1"></a></span>
<span id="cb249-37"><a href="hazards.html#cb249-37" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X) <span class="co"># child number</span></span>
<span id="cb249-38"><a href="hazards.html#cb249-38" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(malaria_village) <span class="co"># number of villages</span></span>
<span id="cb249-39"><a href="hazards.html#cb249-39" tabindex="-1"></a>zeroes <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, N) <span class="co"># auxiliary vector of zeroes for model</span></span>
<span id="cb249-40"><a href="hazards.html#cb249-40" tabindex="-1"></a>ones <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, N)</span>
<span id="cb249-41"><a href="hazards.html#cb249-41" tabindex="-1"></a></span>
<span id="cb249-42"><a href="hazards.html#cb249-42" tabindex="-1"></a>const_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">n =</span> n, <span class="co"># number of childs</span></span>
<span id="cb249-43"><a href="hazards.html#cb249-43" tabindex="-1"></a>                   <span class="at">N =</span> N, <span class="co"># number of villages</span></span>
<span id="cb249-44"><a href="hazards.html#cb249-44" tabindex="-1"></a>                   <span class="at">zeroes =</span> zeroes, <span class="co"># vector of zeroes </span></span>
<span id="cb249-45"><a href="hazards.html#cb249-45" tabindex="-1"></a>                   <span class="at">prior_max_dist =</span> <span class="fu">max</span>(obs_dist_mat)<span class="sc">/</span><span class="dv">6</span>, <span class="co"># max dist for phi prior</span></span>
<span id="cb249-46"><a href="hazards.html#cb249-46" tabindex="-1"></a>                   <span class="at">k =</span>  <span class="fu">ncol</span>(X),<span class="co"># number of predictors</span></span>
<span id="cb249-47"><a href="hazards.html#cb249-47" tabindex="-1"></a>                   <span class="at">index_village =</span> index_village,</span>
<span id="cb249-48"><a href="hazards.html#cb249-48" tabindex="-1"></a>                   <span class="at">Id10 =</span> <span class="dv">10</span><span class="sc">*</span><span class="fu">diag</span>(N)) </span>
<span id="cb249-49"><a href="hazards.html#cb249-49" tabindex="-1"></a></span>
<span id="cb249-50"><a href="hazards.html#cb249-50" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> gambia_df<span class="sc">$</span>pos, <span class="co"># malaria positive test </span></span>
<span id="cb249-51"><a href="hazards.html#cb249-51" tabindex="-1"></a>                 <span class="at">obs_dist_mat =</span> obs_dist_mat, <span class="co"># distance matrix in km</span></span>
<span id="cb249-52"><a href="hazards.html#cb249-52" tabindex="-1"></a>                 <span class="at">X =</span> X <span class="co"># predictors matrix</span></span>
<span id="cb249-53"><a href="hazards.html#cb249-53" tabindex="-1"></a>                 )</span>
<span id="cb249-54"><a href="hazards.html#cb249-54" tabindex="-1"></a></span>
<span id="cb249-55"><a href="hazards.html#cb249-55" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">sigma =</span> <span class="fl">0.5</span>, </span>
<span id="cb249-56"><a href="hazards.html#cb249-56" tabindex="-1"></a>                  <span class="at">p =</span> <span class="fu">rep</span>(<span class="fu">expit</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)), n), </span>
<span id="cb249-57"><a href="hazards.html#cb249-57" tabindex="-1"></a>                  <span class="at">phi_inv =</span> <span class="dv">6</span><span class="sc">/</span><span class="fu">max</span>(obs_dist_mat),</span>
<span id="cb249-58"><a href="hazards.html#cb249-58" tabindex="-1"></a>                  <span class="at">b =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">ncol</span>(X)), </span>
<span id="cb249-59"><a href="hazards.html#cb249-59" tabindex="-1"></a>                  <span class="at">b0 =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb249-60"><a href="hazards.html#cb249-60" tabindex="-1"></a>                  <span class="at">S =</span> <span class="fu">rnorm</span>(N, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb249-61"><a href="hazards.html#cb249-61" tabindex="-1"></a></span>
<span id="cb249-62"><a href="hazards.html#cb249-62" tabindex="-1"></a><span class="co">#init_list &lt;- list(p = runif(n, 0, 1), b = rnorm(ncol(X), 0,  1), b0 = rnorm(1, 0, 1))</span></span>
<span id="cb249-63"><a href="hazards.html#cb249-63" tabindex="-1"></a></span>
<span id="cb249-64"><a href="hazards.html#cb249-64" tabindex="-1"></a>Rmodel <span class="ot">&lt;-</span></span>
<span id="cb249-65"><a href="hazards.html#cb249-65" tabindex="-1"></a>  <span class="fu">nimbleModel</span>(</span>
<span id="cb249-66"><a href="hazards.html#cb249-66" tabindex="-1"></a>    Example10_14_Nimble,</span>
<span id="cb249-67"><a href="hazards.html#cb249-67" tabindex="-1"></a>    <span class="at">constants =</span> const_list,</span>
<span id="cb249-68"><a href="hazards.html#cb249-68" tabindex="-1"></a>    <span class="at">data =</span> dat_list,</span>
<span id="cb249-69"><a href="hazards.html#cb249-69" tabindex="-1"></a>    <span class="at">inits =</span> init_list</span>
<span id="cb249-70"><a href="hazards.html#cb249-70" tabindex="-1"></a>  )</span>
<span id="cb249-71"><a href="hazards.html#cb249-71" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">initializeInfo</span>()</span>
<span id="cb249-72"><a href="hazards.html#cb249-72" tabindex="-1"></a>Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span>
<span id="cb249-73"><a href="hazards.html#cb249-73" tabindex="-1"></a>conf <span class="ot">&lt;-</span></span>
<span id="cb249-74"><a href="hazards.html#cb249-74" tabindex="-1"></a>  <span class="fu">configureMCMC</span>(Rmodel, <span class="at">monitors =</span> <span class="fu">c</span>( <span class="st">&quot;b0&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;p&quot;</span>, <span class="st">&quot;S&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>))</span>
<span id="cb249-75"><a href="hazards.html#cb249-75" tabindex="-1"></a></span>
<span id="cb249-76"><a href="hazards.html#cb249-76" tabindex="-1"></a><span class="co"># conf$removeSamplers(c(&#39;S&#39;))</span></span>
<span id="cb249-77"><a href="hazards.html#cb249-77" tabindex="-1"></a><span class="co"># conf$addSampler(target = c(&#39;S&#39;), type = &#39;AF_slice&#39;)</span></span>
<span id="cb249-78"><a href="hazards.html#cb249-78" tabindex="-1"></a></span>
<span id="cb249-79"><a href="hazards.html#cb249-79" tabindex="-1"></a>Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf)</span>
<span id="cb249-80"><a href="hazards.html#cb249-80" tabindex="-1"></a>Cmcmc <span class="ot">&lt;-</span></span>
<span id="cb249-81"><a href="hazards.html#cb249-81" tabindex="-1"></a>  <span class="fu">compileNimble</span>(</span>
<span id="cb249-82"><a href="hazards.html#cb249-82" tabindex="-1"></a>    Rmcmc,</span>
<span id="cb249-83"><a href="hazards.html#cb249-83" tabindex="-1"></a>    <span class="at">project =</span> Cmodel,</span>
<span id="cb249-84"><a href="hazards.html#cb249-84" tabindex="-1"></a>    <span class="at">resetFunctions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb249-85"><a href="hazards.html#cb249-85" tabindex="-1"></a>    <span class="at">showCompilerOutput =</span> <span class="cn">TRUE</span></span>
<span id="cb249-86"><a href="hazards.html#cb249-86" tabindex="-1"></a>  )</span>
<span id="cb249-87"><a href="hazards.html#cb249-87" tabindex="-1"></a>niters <span class="ot">&lt;-</span> <span class="dv">80000</span></span>
<span id="cb249-88"><a href="hazards.html#cb249-88" tabindex="-1"></a>nburnins <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> niters</span>
<span id="cb249-89"><a href="hazards.html#cb249-89" tabindex="-1"></a>nchains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb249-90"><a href="hazards.html#cb249-90" tabindex="-1"></a>nthins <span class="ot">&lt;-</span> <span class="dv">14</span></span>
<span id="cb249-91"><a href="hazards.html#cb249-91" tabindex="-1"></a>post_samples <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb249-92"><a href="hazards.html#cb249-92" tabindex="-1"></a>  Cmcmc,</span>
<span id="cb249-93"><a href="hazards.html#cb249-93" tabindex="-1"></a>  <span class="at">niter =</span> niters,</span>
<span id="cb249-94"><a href="hazards.html#cb249-94" tabindex="-1"></a>  <span class="at">nburnin =</span> nburnins,</span>
<span id="cb249-95"><a href="hazards.html#cb249-95" tabindex="-1"></a>  <span class="at">thin =</span> nthins,</span>
<span id="cb249-96"><a href="hazards.html#cb249-96" tabindex="-1"></a>  <span class="at">nchains =</span> nchains,</span>
<span id="cb249-97"><a href="hazards.html#cb249-97" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb249-98"><a href="hazards.html#cb249-98" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span></span>
<span id="cb249-99"><a href="hazards.html#cb249-99" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="hazards.html#cb250-1" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b0&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b0&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-1.png" width="672" /></p>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="hazards.html#cb251-1" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[1]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b[1]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-2.png" width="672" /></p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="hazards.html#cb252-1" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[2]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b[2]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-3.png" width="672" /></p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="hazards.html#cb253-1" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[3]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b[3]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-4.png" width="672" /></p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="hazards.html#cb254-1" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[4]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b[4]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-5.png" width="672" /></p>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="hazards.html#cb255-1" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[5]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b[5]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-6.png" width="672" /></p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="hazards.html#cb256-1" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[6]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b[6]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-7.png" width="672" /></p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="hazards.html#cb257-1" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;sigma&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;sigma&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-8.png" width="672" /></p>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="hazards.html#cb258-1" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;phi&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-9.png" width="672" /></p>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="hazards.html#cb259-1" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;S[1]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;S[1]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-10.png" width="672" /></p>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="hazards.html#cb260-1" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;S[24]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;S[24]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-11.png" width="672" /></p>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="hazards.html#cb261-1" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;S[54]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;S[54]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-12.png" width="672" /></p>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="hazards.html#cb262-1" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;p[1]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;p[1]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-13.png" width="672" /></p>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="hazards.html#cb263-1" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;p[1805]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;p[1805]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-14.png" width="672" /></p>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="hazards.html#cb264-1" tabindex="-1"></a><span class="co"># Get minimum effective size (ESS) and which variable has the min ESS</span></span>
<span id="cb264-2"><a href="hazards.html#cb264-2" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(post_samples<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 121.2351</code></pre>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="hazards.html#cb266-1" tabindex="-1"></a>mcmc_variable_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(post_samples<span class="sc">$</span>samples<span class="sc">$</span>chain1)</span>
<span id="cb266-2"><a href="hazards.html#cb266-2" tabindex="-1"></a></span>
<span id="cb266-3"><a href="hazards.html#cb266-3" tabindex="-1"></a>mcmc_variable_names[<span class="fu">which</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(post_samples<span class="sc">$</span>samples) <span class="sc">==</span> <span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(post_samples<span class="sc">$</span>samples)))]</span></code></pre></div>
<pre><code>## [1] &quot;b[7]&quot;</code></pre>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="hazards.html#cb268-1" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb268-2"><a href="hazards.html#cb268-2" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;b0&quot;</span>, <span class="st">&quot;b[1]&quot;</span>, <span class="st">&quot;b[2]&quot;</span>, <span class="st">&quot;b[3]&quot;</span>, <span class="st">&quot;b[4]&quot;</span>, <span class="st">&quot;b[5]&quot;</span>, <span class="st">&quot;b[6]&quot;</span>, <span class="st">&quot;b[7]&quot;</span>, <span class="st">&quot;b[8]&quot;</span>, <span class="st">&quot;b[9]&quot;</span> ,<span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>)</span>
<span id="cb268-3"><a href="hazards.html#cb268-3" tabindex="-1"></a>summary_nimble <span class="ot">&lt;-</span> post_samples<span class="sc">$</span>summary<span class="sc">$</span>all.chains</span>
<span id="cb268-4"><a href="hazards.html#cb268-4" tabindex="-1"></a>summary_nimble[variables,]</span></code></pre></div>
<pre><code>##                Mean        Median      St.Dev.     95%CI_low     95%CI_upp
## b0     0.3315201138  0.3392450269 0.2505843962 -0.1729623331  0.8081442858
## b[1]   0.0006860043  0.0006835488 0.0001234595  0.0004431429  0.0009273262
## b[2]  -0.3896279125 -0.3888672550 0.1560999545 -0.7048920797 -0.0819548994
## b[3]  -0.3757735359 -0.3769547462 0.2116118487 -0.7882866024  0.0385847122
## b[4]   0.0442854311  0.0440496333 0.0178257390  0.0087224925  0.0792046195
## b[5]  -0.2100219775 -0.2056276065 0.2483450907 -0.7052031402  0.2462629975
## b[6]  -0.5000700991 -0.4943813970 0.3424221174 -1.2308098244  0.1291118929
## b[7]  -1.3233823781 -1.3263073092 0.2858536435 -1.8703937606 -0.7468568056
## b[8]  -0.7908411531 -0.7987714491 0.4042487749 -1.5835167007  0.0305095920
## b[9]   0.0352274728  0.0345586394 0.4167655576 -0.7596146680  0.8762673597
## sigma  0.7364758452  0.7317618930 0.1031994687  0.5487828612  0.9489075739
## phi    1.2621830848  1.1370656814 0.5930172725  0.5070952884  2.7332364751</code></pre>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="hazards.html#cb270-1" tabindex="-1"></a><span class="co"># Plot posterior summary for the spatial random effect by village</span></span>
<span id="cb270-2"><a href="hazards.html#cb270-2" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> post_samples<span class="sc">$</span>summary<span class="sc">$</span>all.chains</span>
<span id="cb270-3"><a href="hazards.html#cb270-3" tabindex="-1"></a></span>
<span id="cb270-4"><a href="hazards.html#cb270-4" tabindex="-1"></a>post_sum_S <span class="ot">&lt;-</span></span>
<span id="cb270-5"><a href="hazards.html#cb270-5" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(post_summary) <span class="sc">|&gt;</span>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb270-6"><a href="hazards.html#cb270-6" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(rowname, <span class="st">&quot;S&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb270-7"><a href="hazards.html#cb270-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(rowname, <span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>, Mean, <span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>)  <span class="sc">|&gt;</span></span>
<span id="cb270-8"><a href="hazards.html#cb270-8" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">village =</span> <span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, rowname))</span>
<span id="cb270-9"><a href="hazards.html#cb270-9" tabindex="-1"></a></span>
<span id="cb270-10"><a href="hazards.html#cb270-10" tabindex="-1"></a>post_sum_S<span class="sc">$</span>village <span class="ot">&lt;-</span></span>
<span id="cb270-11"><a href="hazards.html#cb270-11" tabindex="-1"></a>  <span class="fu">factor</span>(post_sum_S<span class="sc">$</span>village , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>)</span>
<span id="cb270-12"><a href="hazards.html#cb270-12" tabindex="-1"></a></span>
<span id="cb270-13"><a href="hazards.html#cb270-13" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_S, <span class="fu">aes</span>(<span class="at">x =</span> village)) <span class="sc">+</span></span>
<span id="cb270-14"><a href="hazards.html#cb270-14" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>, <span class="at">ymax =</span> <span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>, <span class="at">y =</span> Mean)) <span class="sc">+</span></span>
<span id="cb270-15"><a href="hazards.html#cb270-15" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>) <span class="sc">+</span></span>
<span id="cb270-16"><a href="hazards.html#cb270-16" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(</span>
<span id="cb270-17"><a href="hazards.html#cb270-17" tabindex="-1"></a>    <span class="at">breaks =</span> post_sum_S<span class="sc">$</span>village[<span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(post_sum_S<span class="sc">$</span>village), <span class="at">by =</span> <span class="dv">5</span>)]) <span class="sc">+</span></span>
<span id="cb270-18"><a href="hazards.html#cb270-18" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;village&quot;</span>) <span class="sc">+</span></span>
<span id="cb270-19"><a href="hazards.html#cb270-19" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Posterior summary spatial random effect by village&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20summary%20p-1.png" width="672" /></p>
</div>
<div id="stan-3" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="hazards.html#stan-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<pre><code>data {
  int&lt;lower=1&gt; n; //  number of children
  int&lt;lower=1&gt; k; // number of covariates
  int N; //  total number of villages
  int y[n]; //  tests
  matrix[N,N] dist_matrix; //  distance matrix
  matrix[n, k] X; // matrix with covariates
  int index_village[n];
}

parameters {
  real&lt;lower=0&gt; phi_inv;
  real&lt;lower=0&gt; sigma;
  vector[N] S; // spatial random effect
  vector[k] betas;
  real beta0;
}

transformed parameters {
  // vector[n] p = inv_logit(logit_p);
  real sigma_sq = square(sigma);
  real&lt;lower=0&gt; phi = 1/phi_inv;
}

model {
  matrix[N, N] L;
  matrix[N, N] Sigma;
  vector[N] zeroes; // vector of zeroes
  vector[n] logit_p;

 for(i in 1:(N-1)){
   for(j in (i+1):N){
     //Sigma[i,j] = sigma_sq*exp(-dist_matrix[i,j]/phi);
     Sigma[i,j] = sigma_sq*(1 + (sqrt(3)*dist_matrix[i,j])/phi) * exp(-sqrt(3)*dist_matrix[i,j] / phi);
     Sigma[j,i] = Sigma[i,j];
   }
 }
   // diagonal elements covariances
for(i in 1:N){
  Sigma[i,i] = sigma_sq;
}

// sample spatial random effect
  L = cholesky_decompose(Sigma);
  zeroes = rep_vector(0, N);
  S ~ multi_normal_cholesky(zeroes, L);

  for(i in 1:n) {
    logit_p[i] = beta0 + X[i,]*betas + S[index_village[i]];
    y[i] ~ binomial_logit(1, logit_p[i]);
  }

  beta0 ~ normal(0,10);
  betas ~ normal(0,10);
  phi_inv ~ gamma(5, 5);
  sigma ~ cauchy(0,1);
  

}</code></pre>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb272-1"><a href="hazards.html#cb272-1" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>( <span class="at">n =</span> <span class="fu">nrow</span>(gambia), <span class="co"># number of children</span></span>
<span id="cb272-2"><a href="hazards.html#cb272-2" tabindex="-1"></a>                 <span class="at">k =</span> <span class="fu">ncol</span>(X), <span class="co"># number of covariates</span></span>
<span id="cb272-3"><a href="hazards.html#cb272-3" tabindex="-1"></a>                 <span class="at">N =</span> N, <span class="co"># number of villages</span></span>
<span id="cb272-4"><a href="hazards.html#cb272-4" tabindex="-1"></a>                 <span class="at">y =</span> gambia<span class="sc">$</span>pos, <span class="co"># positive tests</span></span>
<span id="cb272-5"><a href="hazards.html#cb272-5" tabindex="-1"></a>                 <span class="at">dist_matrix =</span> obs_dist_mat, <span class="co"># distance matrix in km</span></span>
<span id="cb272-6"><a href="hazards.html#cb272-6" tabindex="-1"></a>                 <span class="at">X =</span> X, <span class="co"># altitude per village</span></span>
<span id="cb272-7"><a href="hazards.html#cb272-7" tabindex="-1"></a>                 <span class="at">index_village =</span> index_village</span>
<span id="cb272-8"><a href="hazards.html#cb272-8" tabindex="-1"></a>                 )</span>
<span id="cb272-9"><a href="hazards.html#cb272-9" tabindex="-1"></a></span>
<span id="cb272-10"><a href="hazards.html#cb272-10" tabindex="-1"></a>Example10_14Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb272-11"><a href="hazards.html#cb272-11" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example10_14.stan&quot;</span>,</span>
<span id="cb272-12"><a href="hazards.html#cb272-12" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb272-13"><a href="hazards.html#cb272-13" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">15000</span>,</span>
<span id="cb272-14"><a href="hazards.html#cb272-14" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">30000</span>,</span>
<span id="cb272-15"><a href="hazards.html#cb272-15" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb272-16"><a href="hazards.html#cb272-16" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb272-17"><a href="hazards.html#cb272-17" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;betas&quot;</span>,<span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;S&quot;</span>),</span>
<span id="cb272-18"><a href="hazards.html#cb272-18" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb272-19"><a href="hazards.html#cb272-19" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="hazards.html#cb273-1" tabindex="-1"></a><span class="co">#computing WAIC using the package loo</span></span>
<span id="cb273-2"><a href="hazards.html#cb273-2" tabindex="-1"></a></span>
<span id="cb273-3"><a href="hazards.html#cb273-3" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example10_14Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;betas&quot;</span>,<span class="st">&quot;sigma&quot;</span>,  <span class="st">&quot;phi&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20stan%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb274-1"><a href="hazards.html#cb274-1" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb274-2"><a href="hazards.html#cb274-2" tabindex="-1"></a>summary_stan <span class="ot">&lt;-</span></span>
<span id="cb274-3"><a href="hazards.html#cb274-3" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb274-4"><a href="hazards.html#cb274-4" tabindex="-1"></a>    Example10_14Stan,</span>
<span id="cb274-5"><a href="hazards.html#cb274-5" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;betas&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>),</span>
<span id="cb274-6"><a href="hazards.html#cb274-6" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb274-7"><a href="hazards.html#cb274-7" tabindex="-1"></a>  )</span>
<span id="cb274-8"><a href="hazards.html#cb274-8" tabindex="-1"></a></span>
<span id="cb274-9"><a href="hazards.html#cb274-9" tabindex="-1"></a>summary_stan<span class="sc">$</span>summary</span></code></pre></div>
<pre><code>##                   mean      se_mean           sd          2.5%         97.5%
## beta0     0.3458755538 4.778216e-03 0.2510986221 -0.1362639241  0.8442035273
## betas[1]  0.0006871207 2.273556e-06 0.0001224843  0.0004482812  0.0009307211
## betas[2] -0.3937790344 2.994197e-03 0.1630352170 -0.7217402843 -0.0793440251
## betas[3] -0.3690088984 3.969896e-03 0.2141993706 -0.7771861338  0.0585086866
## betas[4]  0.0441686717 3.655065e-04 0.0204927583  0.0038759447  0.0849912336
## betas[5] -0.2188864063 4.524898e-03 0.2445430055 -0.6915407489  0.2553282584
## betas[6] -0.5146223013 7.075673e-03 0.3790193760 -1.2623443596  0.2154029130
## betas[7] -1.3569507901 5.737837e-03 0.3113742252 -1.9752438918 -0.7549112373
## betas[8] -0.8086446199 7.945203e-03 0.4441463825 -1.6942523608  0.0389549590
## betas[9]  0.0102733351 8.134941e-03 0.4361173159 -0.8699648369  0.8558910589
## sigma     0.7474663299 2.086654e-03 0.1094484302  0.5576156752  0.9798656966
## phi       1.2278687030 1.059571e-02 0.5680543393  0.5086054757  2.6412794837
##             n_eff      Rhat
## beta0    2761.576 0.9994923
## betas[1] 2902.347 0.9995322
## betas[2] 2964.847 0.9994596
## betas[3] 2911.241 0.9993715
## betas[4] 3143.479 1.0007034
## betas[5] 2920.740 0.9994372
## betas[6] 2869.375 0.9999332
## betas[7] 2944.889 0.9995635
## betas[8] 3124.944 0.9998981
## betas[9] 2874.074 0.9998750
## sigma    2751.176 0.9995793
## phi      2874.216 0.9995888</code></pre>
<div class="sourceCode" id="cb276"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb276-1"><a href="hazards.html#cb276-1" tabindex="-1"></a>S_summary <span class="ot">&lt;-</span></span>
<span id="cb276-2"><a href="hazards.html#cb276-2" tabindex="-1"></a>  <span class="fu">summary</span>(Example10_14Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;S&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb276-3"><a href="hazards.html#cb276-3" tabindex="-1"></a></span>
<span id="cb276-4"><a href="hazards.html#cb276-4" tabindex="-1"></a>S_summary_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(S_summary) <span class="sc">|&gt;</span></span>
<span id="cb276-5"><a href="hazards.html#cb276-5" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb276-6"><a href="hazards.html#cb276-6" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;S[&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>, <span class="st">&quot;]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb276-7"><a href="hazards.html#cb276-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">village =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>) <span class="sc">|&gt;</span></span>
<span id="cb276-8"><a href="hazards.html#cb276-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(mean,  X2.<span class="fl">5.</span>, X97.<span class="fl">5.</span>, village)</span>
<span id="cb276-9"><a href="hazards.html#cb276-9" tabindex="-1"></a></span>
<span id="cb276-10"><a href="hazards.html#cb276-10" tabindex="-1"></a>S_summary_df<span class="sc">$</span>village <span class="ot">&lt;-</span></span>
<span id="cb276-11"><a href="hazards.html#cb276-11" tabindex="-1"></a>  <span class="fu">factor</span>(S_summary_df<span class="sc">$</span>village , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>)</span>
<span id="cb276-12"><a href="hazards.html#cb276-12" tabindex="-1"></a></span>
<span id="cb276-13"><a href="hazards.html#cb276-13" tabindex="-1"></a></span>
<span id="cb276-14"><a href="hazards.html#cb276-14" tabindex="-1"></a>  <span class="fu">ggplot</span>(S_summary_df, <span class="fu">aes</span>(<span class="at">x =</span> village, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb276-15"><a href="hazards.html#cb276-15" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>, <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb276-16"><a href="hazards.html#cb276-16" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>) <span class="sc">+</span></span>
<span id="cb276-17"><a href="hazards.html#cb276-17" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(</span>
<span id="cb276-18"><a href="hazards.html#cb276-18" tabindex="-1"></a>    <span class="at">breaks =</span> S_summary_df<span class="sc">$</span>village[<span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(S_summary_df<span class="sc">$</span>village), <span class="at">by =</span> <span class="dv">5</span>)]) <span class="sc">+</span></span>
<span id="cb276-19"><a href="hazards.html#cb276-19" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;village&quot;</span>) <span class="sc">+</span></span>
<span id="cb276-20"><a href="hazards.html#cb276-20" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Posterior summary spatial random effect by village&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20stan%20posterior%20plots-1.png" width="672" /></p>
</div>
</div>
<div id="supplementary-material-1" class="section level2 unnumbered hasAnchor">
<h2>Supplementary Material<a href="hazards.html#supplementary-material-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
</div>
<div id="extra-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada" class="section level2 unnumbered hasAnchor">
<h2>Extra 10.1: Spatial patterns of benzene concentrations in Montreal, QC, Canada<a href="hazards.html#extra-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Map the locations of the monitoring stations in Montreal.</p>
<p>This example uses the <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/voc/montreal_benzene_apr.csv">montreal_benzene_apr.csv</a></p>
<div class="sourceCode" id="cb277"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb277-1"><a href="hazards.html#cb277-1" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb277-2"><a href="hazards.html#cb277-2" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb277-3"><a href="hazards.html#cb277-3" tabindex="-1"></a><span class="fu">library</span>(ggmap)</span>
<span id="cb277-4"><a href="hazards.html#cb277-4" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb277-5"><a href="hazards.html#cb277-5" tabindex="-1"></a><span class="co"># Load data on benzene concentration in Montreal</span></span>
<span id="cb277-6"><a href="hazards.html#cb277-6" tabindex="-1"></a>benzene <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/voc/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb277-7"><a href="hazards.html#cb277-7" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Add description of the data, this is the April campaign</span></span></code></pre></div>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="hazards.html#cb278-1" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb278-2"><a href="hazards.html#cb278-2" tabindex="-1"></a>benzene_geo <span class="ot">&lt;-</span> benzene</span>
<span id="cb278-3"><a href="hazards.html#cb278-3" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb278-4"><a href="hazards.html#cb278-4" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb278-5"><a href="hazards.html#cb278-5" tabindex="-1"></a><span class="co"># specify the bounding box</span></span>
<span id="cb278-6"><a href="hazards.html#cb278-6" tabindex="-1"></a>latLongBox <span class="ot">=</span> <span class="fu">bbox</span>(benzene_geo)</span>
<span id="cb278-7"><a href="hazards.html#cb278-7" tabindex="-1"></a>location <span class="ot">=</span> <span class="fu">c</span>(latLongBox[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb278-8"><a href="hazards.html#cb278-8" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb278-9"><a href="hazards.html#cb278-9" tabindex="-1"></a>             latLongBox[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.1</span>,</span>
<span id="cb278-10"><a href="hazards.html#cb278-10" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.05</span>)</span>
<span id="cb278-11"><a href="hazards.html#cb278-11" tabindex="-1"></a><span class="co"># create map with location dots marked on it in</span></span>
<span id="cb278-12"><a href="hazards.html#cb278-12" tabindex="-1"></a>MontrelBenzeneMap <span class="ot">&lt;-</span></span>
<span id="cb278-13"><a href="hazards.html#cb278-13" tabindex="-1"></a>  <span class="fu">get_stamenmap</span>(<span class="at">bbox =</span>  location,</span>
<span id="cb278-14"><a href="hazards.html#cb278-14" tabindex="-1"></a>                <span class="at">zoom =</span> <span class="dv">10</span>)</span>
<span id="cb278-15"><a href="hazards.html#cb278-15" tabindex="-1"></a><span class="fu">ggmap</span>(MontrelBenzeneMap) <span class="sc">+</span> <span class="fu">geom_point</span>(</span>
<span id="cb278-16"><a href="hazards.html#cb278-16" tabindex="-1"></a>  <span class="at">data =</span> benzene,</span>
<span id="cb278-17"><a href="hazards.html#cb278-17" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> lon,</span>
<span id="cb278-18"><a href="hazards.html#cb278-18" tabindex="-1"></a>      <span class="at">y =</span> lat,</span>
<span id="cb278-19"><a href="hazards.html#cb278-19" tabindex="-1"></a>      <span class="at">size =</span> Benzene),</span>
<span id="cb278-20"><a href="hazards.html#cb278-20" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">&quot;#011f4b&quot;</span>,</span>
<span id="cb278-21"><a href="hazards.html#cb278-21" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="fl">0.45</span></span>
<span id="cb278-22"><a href="hazards.html#cb278-22" tabindex="-1"></a>) <span class="sc">+</span> <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.1%20map%20data-1.png" width="672" /></p>
<p>Using the <code>geoR</code> package we can also plot the following:</p>
<ul>
<li>the locations of the sampling sites</li>
<li>the concentrations of ozone in relation to the x and y coordinates</li>
<li>and a histogram of the concentrations indicating the distribution of concentrations together with an estimate of the density.</li>
</ul>
<div class="sourceCode" id="cb279"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb279-1"><a href="hazards.html#cb279-1" tabindex="-1"></a><span class="co"># convert data to utm coordinates</span></span>
<span id="cb279-2"><a href="hazards.html#cb279-2" tabindex="-1"></a>benzene_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_geo,</span>
<span id="cb279-3"><a href="hazards.html#cb279-3" tabindex="-1"></a>                           <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb279-4"><a href="hazards.html#cb279-4" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb279-5"><a href="hazards.html#cb279-5" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_utm)</span>
<span id="cb279-6"><a href="hazards.html#cb279-6" tabindex="-1"></a><span class="fu">colnames</span>(benzene_utm_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Benzene&quot;</span>, <span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>)</span>
<span id="cb279-7"><a href="hazards.html#cb279-7" tabindex="-1"></a><span class="co"># Save as geodata to generate the geodata plot</span></span>
<span id="cb279-8"><a href="hazards.html#cb279-8" tabindex="-1"></a>benzene_geodata <span class="ot">&lt;-</span> <span class="fu">as.geodata</span>(benzene_utm_df,</span>
<span id="cb279-9"><a href="hazards.html#cb279-9" tabindex="-1"></a>                              <span class="at">coords.col =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">data.col =</span> <span class="dv">1</span>)</span>
<span id="cb279-10"><a href="hazards.html#cb279-10" tabindex="-1"></a><span class="fu">plot</span>(benzene_geodata)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.1%20geoR%20plot-1.png" width="672" /></p>
</div>
<div id="extra-10.2-examining-the-log-concentrations-of-benzene-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Extra 10.2: Examining the log concentrations of benzene in Montreal<a href="hazards.html#extra-10.2-examining-the-log-concentrations-of-benzene-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb280-1"><a href="hazards.html#cb280-1" tabindex="-1"></a><span class="co"># Histogram for the log of the benzene concentration</span></span>
<span id="cb280-2"><a href="hazards.html#cb280-2" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb280-3"><a href="hazards.html#cb280-3" tabindex="-1"></a>log_histogram <span class="ot">&lt;-</span></span>
<span id="cb280-4"><a href="hazards.html#cb280-4" tabindex="-1"></a>  <span class="fu">hist</span>(<span class="fu">log</span>(benzene<span class="sc">$</span>Benzene), <span class="at">main =</span> <span class="st">&quot;&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;log(Benzene)&quot;</span>)</span>
<span id="cb280-5"><a href="hazards.html#cb280-5" tabindex="-1"></a><span class="fu">qqnorm</span>(<span class="fu">log</span>(benzene<span class="sc">$</span>Benzene), <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb280-6"><a href="hazards.html#cb280-6" tabindex="-1"></a><span class="fu">qqline</span>(<span class="fu">log</span>(benzene<span class="sc">$</span>Benzene))</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.2%20plot%20hist%20and%20qqplot%20log-1.png" width="672" /></p>
</div>
<div id="extra-10.5-variogram" class="section level2 unnumbered hasAnchor">
<h2>Extra 10.5: Variogram<a href="hazards.html#extra-10.5-variogram" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb281"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb281-1"><a href="hazards.html#cb281-1" tabindex="-1"></a><span class="fu">library</span>(gstat)</span>
<span id="cb281-2"><a href="hazards.html#cb281-2" tabindex="-1"></a>benzene_utm_geo <span class="ot">&lt;-</span> benzene_utm_df</span>
<span id="cb281-3"><a href="hazards.html#cb281-3" tabindex="-1"></a><span class="co"># get the coordinates in kms and turn into a Spatial object</span></span>
<span id="cb281-4"><a href="hazards.html#cb281-4" tabindex="-1"></a>benzene_utm_geo[,<span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>)] <span class="ot">&lt;-</span> benzene_utm_geo[,<span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>)]<span class="sc">/</span><span class="dv">1000</span></span>
<span id="cb281-5"><a href="hazards.html#cb281-5" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_utm_geo) <span class="ot">&lt;-</span> <span class="er">~</span> X <span class="sc">+</span> Y</span>
<span id="cb281-6"><a href="hazards.html#cb281-6" tabindex="-1"></a><span class="co"># Estimate variogram intercept only</span></span>
<span id="cb281-7"><a href="hazards.html#cb281-7" tabindex="-1"></a>benzene_inter_vgm <span class="ot">&lt;-</span> <span class="fu">variogram</span>(<span class="fu">log</span>(Benzene) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb281-8"><a href="hazards.html#cb281-8" tabindex="-1"></a>                               <span class="at">data =</span> benzene_utm_geo,</span>
<span id="cb281-9"><a href="hazards.html#cb281-9" tabindex="-1"></a>                               <span class="at">cutoff =</span> <span class="dv">20</span>,<span class="co"># cutoff distance</span></span>
<span id="cb281-10"><a href="hazards.html#cb281-10" tabindex="-1"></a>                               <span class="at">width =</span> <span class="dv">20</span> <span class="sc">/</span> <span class="dv">10</span>) <span class="co"># bins width </span></span>
<span id="cb281-11"><a href="hazards.html#cb281-11" tabindex="-1"></a></span>
<span id="cb281-12"><a href="hazards.html#cb281-12" tabindex="-1"></a></span>
<span id="cb281-13"><a href="hazards.html#cb281-13" tabindex="-1"></a>benzene_inter_vgm_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(benzene_inter_vgm,</span>
<span id="cb281-14"><a href="hazards.html#cb281-14" tabindex="-1"></a>                                       <span class="at">model =</span> <span class="fu">vgm</span>(<span class="fl">0.1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">15</span>, <span class="fl">0.02</span>))</span>
<span id="cb281-15"><a href="hazards.html#cb281-15" tabindex="-1"></a></span>
<span id="cb281-16"><a href="hazards.html#cb281-16" tabindex="-1"></a>benzene_inter_vgm_fit</span></code></pre></div>
<pre><code>##   model      psill    range
## 1   Nug 0.01616521  0.00000
## 2   Exp 0.17301314 23.97153</code></pre>
<div class="sourceCode" id="cb283"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb283-1"><a href="hazards.html#cb283-1" tabindex="-1"></a><span class="co"># Estimate variogram using coordinates</span></span>
<span id="cb283-2"><a href="hazards.html#cb283-2" tabindex="-1"></a>benzene_vgm <span class="ot">&lt;-</span> <span class="fu">variogram</span>(<span class="fu">log</span>(Benzene) <span class="sc">~</span> X <span class="sc">+</span> Y, </span>
<span id="cb283-3"><a href="hazards.html#cb283-3" tabindex="-1"></a>                         <span class="at">data =</span> benzene_utm_geo,</span>
<span id="cb283-4"><a href="hazards.html#cb283-4" tabindex="-1"></a>                         <span class="at">cutoff =</span> <span class="dv">20</span>, <span class="co"># cutoff distance</span></span>
<span id="cb283-5"><a href="hazards.html#cb283-5" tabindex="-1"></a>                         <span class="at">width =</span> <span class="dv">20</span> <span class="sc">/</span> <span class="dv">10</span>) <span class="co"># bins width</span></span>
<span id="cb283-6"><a href="hazards.html#cb283-6" tabindex="-1"></a></span>
<span id="cb283-7"><a href="hazards.html#cb283-7" tabindex="-1"></a></span>
<span id="cb283-8"><a href="hazards.html#cb283-8" tabindex="-1"></a>benzene_vgm_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(benzene_vgm, <span class="at">model =</span> <span class="fu">vgm</span>(<span class="fl">0.1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">3</span>, <span class="fl">0.02</span>))</span>
<span id="cb283-9"><a href="hazards.html#cb283-9" tabindex="-1"></a>benzene_vgm_fit</span></code></pre></div>
<pre><code>##   model      psill    range
## 1   Nug 0.01638881 0.000000
## 2   Exp 0.05598753 7.365469</code></pre>
<div class="sourceCode" id="cb285"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb285-1"><a href="hazards.html#cb285-1" tabindex="-1"></a>plot_inter_variog <span class="ot">&lt;-</span> <span class="fu">plot</span>(benzene_inter_vgm, benzene_inter_vgm_fit, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb285-2"><a href="hazards.html#cb285-2" tabindex="-1"></a>plot_coord_variog <span class="ot">&lt;-</span> <span class="fu">plot</span>(benzene_vgm, benzene_vgm_fit, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb285-3"><a href="hazards.html#cb285-3" tabindex="-1"></a></span>
<span id="cb285-4"><a href="hazards.html#cb285-4" tabindex="-1"></a><span class="fu">plot_grid</span>(plot_inter_variog, plot_coord_variog, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.5%20plot%20variogram-1.png" width="672" /></p>
</div>
<div id="extra-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Extra 10.6 Basic spatial modelling and prediction of benzene in Montreal<a href="hazards.html#extra-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb286"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb286-1"><a href="hazards.html#cb286-1" tabindex="-1"></a><span class="co"># Generate grid</span></span>
<span id="cb286-2"><a href="hazards.html#cb286-2" tabindex="-1"></a>MtlPred <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="fu">seq</span> (<span class="dv">580</span>, <span class="dv">615</span> , <span class="fl">0.5</span>),</span>
<span id="cb286-3"><a href="hazards.html#cb286-3" tabindex="-1"></a>                             <span class="fu">seq</span> (<span class="dv">5020</span>, <span class="dv">5060</span> , <span class="fl">0.5</span>) )</span>
<span id="cb286-4"><a href="hazards.html#cb286-4" tabindex="-1"></a><span class="co"># change names grid</span></span>
<span id="cb286-5"><a href="hazards.html#cb286-5" tabindex="-1"></a><span class="fu">names</span>(MtlPred)[ <span class="fu">names</span>(MtlPred)<span class="sc">==</span><span class="st">&quot;Var1&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;X&quot;</span></span>
<span id="cb286-6"><a href="hazards.html#cb286-6" tabindex="-1"></a><span class="fu">names</span>(MtlPred)[ <span class="fu">names</span>(MtlPred)<span class="sc">==</span><span class="st">&quot;Var2&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;Y&quot;</span></span>
<span id="cb286-7"><a href="hazards.html#cb286-7" tabindex="-1"></a><span class="co"># make the grid a Spatial object</span></span>
<span id="cb286-8"><a href="hazards.html#cb286-8" tabindex="-1"></a><span class="fu">coordinates</span> (MtlPred) <span class="ot">=</span> <span class="er">~</span> X <span class="sc">+</span> Y</span>
<span id="cb286-9"><a href="hazards.html#cb286-9" tabindex="-1"></a><span class="fu">gridded</span>(MtlPred) <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb286-10"><a href="hazards.html#cb286-10" tabindex="-1"></a><span class="co"># define the model based on the variogram fit from the previous example</span></span>
<span id="cb286-11"><a href="hazards.html#cb286-11" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">vgm</span> (<span class="fl">0.053</span> , <span class="st">&quot;Exp&quot;</span>, <span class="fl">5.54</span>, <span class="fl">0.0122</span>)</span>
<span id="cb286-12"><a href="hazards.html#cb286-12" tabindex="-1"></a><span class="co"># use ordinary kriging to predict values in the grid</span></span>
<span id="cb286-13"><a href="hazards.html#cb286-13" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">krige</span>(<span class="fu">log</span>(Benzene) <span class="sc">~</span> X <span class="sc">+</span> Y, benzene_utm_geo , MtlPred , <span class="at">model =</span> mod )</span></code></pre></div>
<pre><code>## [using universal kriging]</code></pre>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb288-1"><a href="hazards.html#cb288-1" tabindex="-1"></a><span class="co"># Plot the ordinary kriging predictions and their variance</span></span>
<span id="cb288-2"><a href="hazards.html#cb288-2" tabindex="-1"></a></span>
<span id="cb288-3"><a href="hazards.html#cb288-3" tabindex="-1"></a>monitor_loc <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&#39;sp.points&#39;</span>, benzene_utm_geo, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">cex=</span>.<span class="dv">8</span>, <span class="at">col=</span><span class="st">&#39;cornsilk4&#39;</span>)</span>
<span id="cb288-4"><a href="hazards.html#cb288-4" tabindex="-1"></a></span>
<span id="cb288-5"><a href="hazards.html#cb288-5" tabindex="-1"></a>krig_pred <span class="ot">&lt;-</span></span>
<span id="cb288-6"><a href="hazards.html#cb288-6" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb288-7"><a href="hazards.html#cb288-7" tabindex="-1"></a>    x[<span class="st">&quot;var1.pred&quot;</span>],</span>
<span id="cb288-8"><a href="hazards.html#cb288-8" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Ordinary kriging predictions &quot;</span>,</span>
<span id="cb288-9"><a href="hazards.html#cb288-9" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb288-10"><a href="hazards.html#cb288-10" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb288-11"><a href="hazards.html#cb288-11" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.8</span>, <span class="fl">0.02</span>)</span>
<span id="cb288-12"><a href="hazards.html#cb288-12" tabindex="-1"></a>  )</span>
<span id="cb288-13"><a href="hazards.html#cb288-13" tabindex="-1"></a>krig_var <span class="ot">&lt;-</span></span>
<span id="cb288-14"><a href="hazards.html#cb288-14" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb288-15"><a href="hazards.html#cb288-15" tabindex="-1"></a>    x[<span class="st">&quot;var1.var&quot;</span>],</span>
<span id="cb288-16"><a href="hazards.html#cb288-16" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Ordinary kriging variance &quot;</span>,</span>
<span id="cb288-17"><a href="hazards.html#cb288-17" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb288-18"><a href="hazards.html#cb288-18" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb288-19"><a href="hazards.html#cb288-19" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span>)</span>
<span id="cb288-20"><a href="hazards.html#cb288-20" tabindex="-1"></a>  )</span>
<span id="cb288-21"><a href="hazards.html#cb288-21" tabindex="-1"></a></span>
<span id="cb288-22"><a href="hazards.html#cb288-22" tabindex="-1"></a><span class="fu">plot_grid</span>(krig_pred, krig_var, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.6%20kriging%20predictions-1.png" width="672" /></p>
</div>
<div id="extra-10.8-spatial-modelling-of-benzene-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Extra 10.8 Spatial modelling of Benzene in Montreal<a href="hazards.html#extra-10.8-spatial-modelling-of-benzene-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This example uses the <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/voc/montreal_benzene_apr.csv">montreal_benzene_apr.csv</a></p>
<div id="nimble-5" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="hazards.html#nimble-5" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb289"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb289-1"><a href="hazards.html#cb289-1" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb289-2"><a href="hazards.html#cb289-2" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb289-3"><a href="hazards.html#cb289-3" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb289-4"><a href="hazards.html#cb289-4" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb289-5"><a href="hazards.html#cb289-5" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb289-6"><a href="hazards.html#cb289-6" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb289-7"><a href="hazards.html#cb289-7" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span></code></pre></div>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb290-1"><a href="hazards.html#cb290-1" tabindex="-1"></a><span class="co"># Load data on benzene concentration in Montreal</span></span>
<span id="cb290-2"><a href="hazards.html#cb290-2" tabindex="-1"></a>benzene <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/voc/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb290-3"><a href="hazards.html#cb290-3" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb290-4"><a href="hazards.html#cb290-4" tabindex="-1"></a>benzene_geo <span class="ot">&lt;-</span> benzene</span>
<span id="cb290-5"><a href="hazards.html#cb290-5" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb290-6"><a href="hazards.html#cb290-6" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb290-7"><a href="hazards.html#cb290-7" tabindex="-1"></a></span>
<span id="cb290-8"><a href="hazards.html#cb290-8" tabindex="-1"></a>benzene_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_geo,</span>
<span id="cb290-9"><a href="hazards.html#cb290-9" tabindex="-1"></a>                        <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb290-10"><a href="hazards.html#cb290-10" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb290-11"><a href="hazards.html#cb290-11" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_utm)</span>
<span id="cb290-12"><a href="hazards.html#cb290-12" tabindex="-1"></a><span class="co"># Change coordinates to kilometers and observations to the log scale</span></span>
<span id="cb290-13"><a href="hazards.html#cb290-13" tabindex="-1"></a>Mtl_benzene_sample <span class="ot">&lt;-</span></span>
<span id="cb290-14"><a href="hazards.html#cb290-14" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb290-15"><a href="hazards.html#cb290-15" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">log</span>(benzene_utm_df<span class="sc">$</span>Benzene),</span>
<span id="cb290-16"><a href="hazards.html#cb290-16" tabindex="-1"></a>    <span class="at">easting =</span>  benzene_utm_df<span class="sc">$</span>lon <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb290-17"><a href="hazards.html#cb290-17" tabindex="-1"></a>    <span class="at">northing =</span> benzene_utm_df<span class="sc">$</span>lat <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb290-18"><a href="hazards.html#cb290-18" tabindex="-1"></a>  )</span>
<span id="cb290-19"><a href="hazards.html#cb290-19" tabindex="-1"></a><span class="co"># Compute the distance matrix</span></span>
<span id="cb290-20"><a href="hazards.html#cb290-20" tabindex="-1"></a>obsCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_benzene_sample[,<span class="fu">c</span>(<span class="st">&quot;easting&quot;</span>, <span class="st">&quot;northing&quot;</span>)]))</span>
<span id="cb290-21"><a href="hazards.html#cb290-21" tabindex="-1"></a></span>
<span id="cb290-22"><a href="hazards.html#cb290-22" tabindex="-1"></a>obsDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(obsCoords)</span></code></pre></div>
<div class="sourceCode" id="cb291"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb291-1"><a href="hazards.html#cb291-1" tabindex="-1"></a>Extra10_9Code <span class="ot">&lt;-</span>  <span class="fu">nimbleCode</span> ({</span>
<span id="cb291-2"><a href="hazards.html#cb291-2" tabindex="-1"></a>  <span class="co"># Covariance matrix spatial effect</span></span>
<span id="cb291-3"><a href="hazards.html#cb291-3" tabindex="-1"></a>  Sigma[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n] <span class="ot">&lt;-</span></span>
<span id="cb291-4"><a href="hazards.html#cb291-4" tabindex="-1"></a>    sigma_sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>distMatrix[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n] <span class="sc">/</span> phi) <span class="sc">+</span> tau_sq <span class="sc">*</span> <span class="fu">identityMatrix</span>(<span class="at">d =</span> n)</span>
<span id="cb291-5"><a href="hazards.html#cb291-5" tabindex="-1"></a></span>
<span id="cb291-6"><a href="hazards.html#cb291-6" tabindex="-1"></a>    <span class="cf">for</span> (site <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb291-7"><a href="hazards.html#cb291-7" tabindex="-1"></a>    mean.site[site] <span class="ot">&lt;-</span></span>
<span id="cb291-8"><a href="hazards.html#cb291-8" tabindex="-1"></a>      beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> easting[site] <span class="sc">+</span> beta2 <span class="sc">*</span> northing[site]</span>
<span id="cb291-9"><a href="hazards.html#cb291-9" tabindex="-1"></a>  }</span>
<span id="cb291-10"><a href="hazards.html#cb291-10" tabindex="-1"></a>  y[<span class="dv">1</span><span class="sc">:</span>n]  <span class="sc">~</span>  <span class="fu">dmnorm</span>(mean.site[<span class="dv">1</span><span class="sc">:</span>n], <span class="at">cov =</span> Sigma[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n])</span>
<span id="cb291-11"><a href="hazards.html#cb291-11" tabindex="-1"></a>  <span class="co"># Set up the priors for the spatial model</span></span>
<span id="cb291-12"><a href="hazards.html#cb291-12" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb291-13"><a href="hazards.html#cb291-13" tabindex="-1"></a>  sigma_sq <span class="ot">&lt;-</span> sigma<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb291-14"><a href="hazards.html#cb291-14" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb291-15"><a href="hazards.html#cb291-15" tabindex="-1"></a>  tau_sq <span class="ot">&lt;-</span> tau<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb291-16"><a href="hazards.html#cb291-16" tabindex="-1"></a>  phi_inv <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="at">shape =</span>  <span class="dv">5</span>, <span class="at">rate =</span> <span class="dv">5</span>)</span>
<span id="cb291-17"><a href="hazards.html#cb291-17" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> phi_inv</span>
<span id="cb291-18"><a href="hazards.html#cb291-18" tabindex="-1"></a>  <span class="co"># prior for the coefficients</span></span>
<span id="cb291-19"><a href="hazards.html#cb291-19" tabindex="-1"></a>  beta0 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb291-20"><a href="hazards.html#cb291-20" tabindex="-1"></a>  beta1 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb291-21"><a href="hazards.html#cb291-21" tabindex="-1"></a>  beta2 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb291-22"><a href="hazards.html#cb291-22" tabindex="-1"></a>  </span>
<span id="cb291-23"><a href="hazards.html#cb291-23" tabindex="-1"></a>}) </span>
<span id="cb291-24"><a href="hazards.html#cb291-24" tabindex="-1"></a></span>
<span id="cb291-25"><a href="hazards.html#cb291-25" tabindex="-1"></a><span class="co"># Define the constants, data, parameters and initial values</span></span>
<span id="cb291-26"><a href="hazards.html#cb291-26" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb291-27"><a href="hazards.html#cb291-27" tabindex="-1"></a>easting_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>easting))</span>
<span id="cb291-28"><a href="hazards.html#cb291-28" tabindex="-1"></a>northing_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>northing))</span>
<span id="cb291-29"><a href="hazards.html#cb291-29" tabindex="-1"></a></span>
<span id="cb291-30"><a href="hazards.html#cb291-30" tabindex="-1"></a>constants <span class="ot">&lt;-</span></span>
<span id="cb291-31"><a href="hazards.html#cb291-31" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">n =</span> <span class="fu">nrow</span>(Mtl_benzene_sample))</span>
<span id="cb291-32"><a href="hazards.html#cb291-32" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span></span>
<span id="cb291-33"><a href="hazards.html#cb291-33" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">y =</span> Mtl_benzene_sample<span class="sc">$</span>y,</span>
<span id="cb291-34"><a href="hazards.html#cb291-34" tabindex="-1"></a>       <span class="at">easting =</span> easting_scaled,</span>
<span id="cb291-35"><a href="hazards.html#cb291-35" tabindex="-1"></a>       <span class="at">northing =</span> northing_scaled,</span>
<span id="cb291-36"><a href="hazards.html#cb291-36" tabindex="-1"></a>       <span class="at">distMatrix =</span> obsDist)</span>
<span id="cb291-37"><a href="hazards.html#cb291-37" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="st">&quot;beta0&quot;</span>,  <span class="st">&quot;beta1&quot;</span>,<span class="st">&quot;beta2&quot;</span>, <span class="st">&quot;phi&quot;</span>,  <span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>)</span>
<span id="cb291-38"><a href="hazards.html#cb291-38" tabindex="-1"></a>inits <span class="ot">&lt;-</span> <span class="fu">list</span>( <span class="at">sigma =</span> <span class="fl">0.1</span>, <span class="at">phi_inv =</span> <span class="dv">6</span><span class="sc">/</span><span class="fu">max</span>(obsDist), <span class="at">tau =</span> <span class="fl">0.1</span>)</span>
<span id="cb291-39"><a href="hazards.html#cb291-39" tabindex="-1"></a><span class="co"># Run model in nimble</span></span>
<span id="cb291-40"><a href="hazards.html#cb291-40" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb291-41"><a href="hazards.html#cb291-41" tabindex="-1"></a></span>
<span id="cb291-42"><a href="hazards.html#cb291-42" tabindex="-1"></a>mcmc.out <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb291-43"><a href="hazards.html#cb291-43" tabindex="-1"></a>  <span class="at">code =</span> Extra10_9Code,</span>
<span id="cb291-44"><a href="hazards.html#cb291-44" tabindex="-1"></a>  <span class="at">constants =</span> constants,</span>
<span id="cb291-45"><a href="hazards.html#cb291-45" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb291-46"><a href="hazards.html#cb291-46" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb291-47"><a href="hazards.html#cb291-47" tabindex="-1"></a>  <span class="at">monitors =</span> params,</span>
<span id="cb291-48"><a href="hazards.html#cb291-48" tabindex="-1"></a>  <span class="at">niter =</span> <span class="dv">40000</span>,</span>
<span id="cb291-49"><a href="hazards.html#cb291-49" tabindex="-1"></a>  <span class="at">nburnin =</span> <span class="dv">20000</span>,</span>
<span id="cb291-50"><a href="hazards.html#cb291-50" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">14</span>,</span>
<span id="cb291-51"><a href="hazards.html#cb291-51" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb291-52"><a href="hazards.html#cb291-52" tabindex="-1"></a>  <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb291-53"><a href="hazards.html#cb291-53" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb291-54"><a href="hazards.html#cb291-54" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb291-55"><a href="hazards.html#cb291-55" tabindex="-1"></a>)</span>
<span id="cb291-56"><a href="hazards.html#cb291-56" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb291-57"><a href="hazards.html#cb291-57" tabindex="-1"></a>run_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb291-58"><a href="hazards.html#cb291-58" tabindex="-1"></a>run_time</span></code></pre></div>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb292-1"><a href="hazards.html#cb292-1" tabindex="-1"></a>mcmc.out<span class="sc">$</span>WAIC</span></code></pre></div>
<pre><code>## nimbleList object of type waicList
## Field &quot;WAIC&quot;:
## [1] -32.37684
## Field &quot;lppd&quot;:
## [1] 19.03084
## Field &quot;pWAIC&quot;:
## [1] 2.842421</code></pre>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb294-1"><a href="hazards.html#cb294-1" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(mcmc.out<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 985.2176</code></pre>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb296-1"><a href="hazards.html#cb296-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta0&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.8%20nimble%20WAIC,%20ESS%20and%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb297"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb297-1"><a href="hazards.html#cb297-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta1&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta1&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.8%20nimble%20WAIC,%20ESS%20and%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb298-1"><a href="hazards.html#cb298-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta2&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta2&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.8%20nimble%20WAIC,%20ESS%20and%20traceplots-3.png" width="672" /></p>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb299-1"><a href="hazards.html#cb299-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;sigma&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;sigma&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.8%20nimble%20WAIC,%20ESS%20and%20traceplots-4.png" width="672" /></p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb300-1"><a href="hazards.html#cb300-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;tau&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.8%20nimble%20WAIC,%20ESS%20and%20traceplots-5.png" width="672" /></p>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb301-1"><a href="hazards.html#cb301-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;phi&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.8%20nimble%20WAIC,%20ESS%20and%20traceplots-6.png" width="672" /></p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="hazards.html#cb302-1" tabindex="-1"></a>mcmc.out<span class="sc">$</span>summary<span class="sc">$</span>all.chains[<span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta1&quot;</span>, <span class="st">&quot;beta2&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;phi&quot;</span>), ]</span></code></pre></div>
<pre><code>##                 Mean     Median     St.Dev.     95%CI_low  95%CI_upp
## beta0    0.143589662 0.15187505 0.081381727 -4.284934e-02 0.27866526
## beta1    0.051028164 0.04806334 0.060619017 -6.338295e-02 0.17328888
## beta2    0.077775628 0.08250220 0.068519017 -7.013084e-02 0.20323633
## sigma_sq 0.056087887 0.05202343 0.022624353  2.770244e-02 0.11140808
## tau_sq   0.009128758 0.00841011 0.006709036  5.744089e-05 0.02380432
## phi      3.697646345 3.09115863 2.228726265  1.463844e+00 9.40053808</code></pre>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb304-1"><a href="hazards.html#cb304-1" tabindex="-1"></a><span class="co"># Obtain coordinates for predictions </span></span>
<span id="cb304-2"><a href="hazards.html#cb304-2" tabindex="-1"></a><span class="co"># note that we are using the same coordinates as the one generated for </span></span>
<span id="cb304-3"><a href="hazards.html#cb304-3" tabindex="-1"></a><span class="co"># the kriging example</span></span>
<span id="cb304-4"><a href="hazards.html#cb304-4" tabindex="-1"></a>Mtl_centroids_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(MtlPred)</span>
<span id="cb304-5"><a href="hazards.html#cb304-5" tabindex="-1"></a>predCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_centroids_df))</span></code></pre></div>
<p>Following the posterior predictive distribution we have to define a model for the predictions.</p>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb305-1"><a href="hazards.html#cb305-1" tabindex="-1"></a><span class="co"># Extract samples from nimble model</span></span>
<span id="cb305-2"><a href="hazards.html#cb305-2" tabindex="-1"></a>tidy_post_samples <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>samples <span class="sc">|&gt;</span> <span class="fu">tidy_draws</span>()</span>
<span id="cb305-3"><a href="hazards.html#cb305-3" tabindex="-1"></a></span>
<span id="cb305-4"><a href="hazards.html#cb305-4" tabindex="-1"></a><span class="co"># Extract posterior samples for each of the parameters of interest</span></span>
<span id="cb305-5"><a href="hazards.html#cb305-5" tabindex="-1"></a>post_beta0 <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>beta0</span>
<span id="cb305-6"><a href="hazards.html#cb305-6" tabindex="-1"></a>post_beta1 <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>beta1</span>
<span id="cb305-7"><a href="hazards.html#cb305-7" tabindex="-1"></a>post_beta2 <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>beta2</span>
<span id="cb305-8"><a href="hazards.html#cb305-8" tabindex="-1"></a>post_sigmasq <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>sigma_sq</span>
<span id="cb305-9"><a href="hazards.html#cb305-9" tabindex="-1"></a>post_phi <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>phi</span>
<span id="cb305-10"><a href="hazards.html#cb305-10" tabindex="-1"></a>post_tausq <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>tau_sq</span>
<span id="cb305-11"><a href="hazards.html#cb305-11" tabindex="-1"></a></span>
<span id="cb305-12"><a href="hazards.html#cb305-12" tabindex="-1"></a><span class="co"># Scale coordinates for predictive locations</span></span>
<span id="cb305-13"><a href="hazards.html#cb305-13" tabindex="-1"></a>predCoords_sc <span class="ot">&lt;-</span> predCoords </span>
<span id="cb305-14"><a href="hazards.html#cb305-14" tabindex="-1"></a>predCoords_sc[,<span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb305-15"><a href="hazards.html#cb305-15" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>easting)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>easting)</span>
<span id="cb305-16"><a href="hazards.html#cb305-16" tabindex="-1"></a>predCoords_sc[,<span class="dv">2</span>] <span class="ot">&lt;-</span> </span>
<span id="cb305-17"><a href="hazards.html#cb305-17" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>northing)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>northing)</span>
<span id="cb305-18"><a href="hazards.html#cb305-18" tabindex="-1"></a>  </span>
<span id="cb305-19"><a href="hazards.html#cb305-19" tabindex="-1"></a>n0 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(predCoords_sc)</span>
<span id="cb305-20"><a href="hazards.html#cb305-20" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="fu">length</span>(post_tausq)</span>
<span id="cb305-21"><a href="hazards.html#cb305-21" tabindex="-1"></a></span>
<span id="cb305-22"><a href="hazards.html#cb305-22" tabindex="-1"></a>obsMu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, easting_scaled, northing_scaled) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(post_beta0, post_beta1, post_beta2))</span>
<span id="cb305-23"><a href="hazards.html#cb305-23" tabindex="-1"></a></span>
<span id="cb305-24"><a href="hazards.html#cb305-24" tabindex="-1"></a>predMu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, <span class="fu">as.matrix</span>(predCoords_sc)) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(post_beta0, post_beta1, post_beta2))</span>
<span id="cb305-25"><a href="hazards.html#cb305-25" tabindex="-1"></a></span>
<span id="cb305-26"><a href="hazards.html#cb305-26" tabindex="-1"></a>pred2obsDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(predCoords, obsCoords)</span>
<span id="cb305-27"><a href="hazards.html#cb305-27" tabindex="-1"></a></span>
<span id="cb305-28"><a href="hazards.html#cb305-28" tabindex="-1"></a></span>
<span id="cb305-29"><a href="hazards.html#cb305-29" tabindex="-1"></a>Rcpp<span class="sc">::</span><span class="fu">sourceCpp</span>(<span class="st">&quot;functions/prediction_marginal_gp12.cpp&quot;</span>)</span>
<span id="cb305-30"><a href="hazards.html#cb305-30" tabindex="-1"></a><span class="fu">args</span>(prediction_marginal_gp12)</span></code></pre></div>
<pre><code>## function (y, obsMu, predMu, obsDistMat, pred2ObsDistMat, sigmasq, 
##     phi, tausq, iterprint) 
## NULL</code></pre>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb307-1"><a href="hazards.html#cb307-1" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb307-2"><a href="hazards.html#cb307-2" tabindex="-1"></a>  pred_samples <span class="ot">&lt;-</span> <span class="fu">prediction_marginal_gp12</span>(</span>
<span id="cb307-3"><a href="hazards.html#cb307-3" tabindex="-1"></a>    <span class="at">y =</span> Mtl_benzene_sample<span class="sc">$</span>y,</span>
<span id="cb307-4"><a href="hazards.html#cb307-4" tabindex="-1"></a>    <span class="at">obsMu =</span> obsMu,</span>
<span id="cb307-5"><a href="hazards.html#cb307-5" tabindex="-1"></a>    <span class="at">predMu =</span> predMu,</span>
<span id="cb307-6"><a href="hazards.html#cb307-6" tabindex="-1"></a>    <span class="at">obsDistMat =</span> obsDist,</span>
<span id="cb307-7"><a href="hazards.html#cb307-7" tabindex="-1"></a>    <span class="at">pred2ObsDistMat =</span> pred2obsDist,</span>
<span id="cb307-8"><a href="hazards.html#cb307-8" tabindex="-1"></a>    <span class="at">sigmasq =</span> post_sigmasq,</span>
<span id="cb307-9"><a href="hazards.html#cb307-9" tabindex="-1"></a>    <span class="at">phi =</span> post_phi,</span>
<span id="cb307-10"><a href="hazards.html#cb307-10" tabindex="-1"></a>    <span class="at">tausq =</span> post_tausq,</span>
<span id="cb307-11"><a href="hazards.html#cb307-11" tabindex="-1"></a>    <span class="at">iterprint =</span> <span class="dv">1000</span></span>
<span id="cb307-12"><a href="hazards.html#cb307-12" tabindex="-1"></a>  )</span>
<span id="cb307-13"><a href="hazards.html#cb307-13" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Prediction upto the 0th MCMC sample is completed
## Prediction upto the 1000th MCMC sample is completed
## Prediction upto the 2000th MCMC sample is completed</code></pre>
<pre><code>##    user  system elapsed 
##  149.52    0.09  178.07</code></pre>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb310-1"><a href="hazards.html#cb310-1" tabindex="-1"></a>predict_res_dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb310-2"><a href="hazards.html#cb310-2" tabindex="-1"></a>  <span class="at">xcoord =</span> predCoords[, <span class="dv">1</span>],</span>
<span id="cb310-3"><a href="hazards.html#cb310-3" tabindex="-1"></a>  <span class="at">ycoord =</span> predCoords[, <span class="dv">2</span>],</span>
<span id="cb310-4"><a href="hazards.html#cb310-4" tabindex="-1"></a>  <span class="at">post.mean =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, mean),</span>
<span id="cb310-5"><a href="hazards.html#cb310-5" tabindex="-1"></a>  <span class="at">post.var =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, var),</span>
<span id="cb310-6"><a href="hazards.html#cb310-6" tabindex="-1"></a>  <span class="at">q2.5 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb310-7"><a href="hazards.html#cb310-7" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.025</span>)),</span>
<span id="cb310-8"><a href="hazards.html#cb310-8" tabindex="-1"></a>  <span class="at">q50 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb310-9"><a href="hazards.html#cb310-9" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.5</span>)),</span>
<span id="cb310-10"><a href="hazards.html#cb310-10" tabindex="-1"></a>  <span class="at">q97.5 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb310-11"><a href="hazards.html#cb310-11" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.975</span>))</span>
<span id="cb310-12"><a href="hazards.html#cb310-12" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb311-1"><a href="hazards.html#cb311-1" tabindex="-1"></a>x<span class="sc">$</span>nimble.pred <span class="ot">&lt;-</span> predict_res_dt<span class="sc">$</span>post.mean</span>
<span id="cb311-2"><a href="hazards.html#cb311-2" tabindex="-1"></a>x<span class="sc">$</span>nimble.var <span class="ot">&lt;-</span> predict_res_dt<span class="sc">$</span>post.var</span>
<span id="cb311-3"><a href="hazards.html#cb311-3" tabindex="-1"></a></span>
<span id="cb311-4"><a href="hazards.html#cb311-4" tabindex="-1"></a>nimble_pred <span class="ot">&lt;-</span></span>
<span id="cb311-5"><a href="hazards.html#cb311-5" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb311-6"><a href="hazards.html#cb311-6" tabindex="-1"></a>    x[<span class="st">&quot;nimble.pred&quot;</span>],</span>
<span id="cb311-7"><a href="hazards.html#cb311-7" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Nimble spatial predictions &quot;</span>,</span>
<span id="cb311-8"><a href="hazards.html#cb311-8" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb311-9"><a href="hazards.html#cb311-9" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb311-10"><a href="hazards.html#cb311-10" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.8</span>, <span class="fl">0.02</span>)</span>
<span id="cb311-11"><a href="hazards.html#cb311-11" tabindex="-1"></a>  )</span>
<span id="cb311-12"><a href="hazards.html#cb311-12" tabindex="-1"></a>nimble_var <span class="ot">&lt;-</span></span>
<span id="cb311-13"><a href="hazards.html#cb311-13" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb311-14"><a href="hazards.html#cb311-14" tabindex="-1"></a>    x[<span class="st">&quot;nimble.var&quot;</span>],</span>
<span id="cb311-15"><a href="hazards.html#cb311-15" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Nimble predictions variance &quot;</span>,</span>
<span id="cb311-16"><a href="hazards.html#cb311-16" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb311-17"><a href="hazards.html#cb311-17" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb311-18"><a href="hazards.html#cb311-18" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span>)</span>
<span id="cb311-19"><a href="hazards.html#cb311-19" tabindex="-1"></a></span>
<span id="cb311-20"><a href="hazards.html#cb311-20" tabindex="-1"></a>  )</span>
<span id="cb311-21"><a href="hazards.html#cb311-21" tabindex="-1"></a></span>
<span id="cb311-22"><a href="hazards.html#cb311-22" tabindex="-1"></a><span class="fu">plot_grid</span>(nimble_pred, nimble_var, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.8%20nimble%20plot%20predictions-1.png" width="672" /></p>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="hazards.html#cb312-1" tabindex="-1"></a>predict_res_dt<span class="sc">$</span>post.mean[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>## [1] -0.2748897 -0.2610339 -0.2629892 -0.2617884 -0.2446157</code></pre>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb314-1"><a href="hazards.html#cb314-1" tabindex="-1"></a>predict_res_dt<span class="sc">$</span>post.var[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>## [1] 0.08898525 0.09035693 0.08581058 0.08874131 0.08585555</code></pre>
</div>
<div id="stan-4" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="hazards.html#stan-4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb316-1"><a href="hazards.html#cb316-1" tabindex="-1"></a>benzene_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/voc/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb316-2"><a href="hazards.html#cb316-2" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb316-3"><a href="hazards.html#cb316-3" tabindex="-1"></a>benzene_data_geo <span class="ot">&lt;-</span> benzene_data</span>
<span id="cb316-4"><a href="hazards.html#cb316-4" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_data_geo) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb316-5"><a href="hazards.html#cb316-5" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_data_geo) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb316-6"><a href="hazards.html#cb316-6" tabindex="-1"></a></span>
<span id="cb316-7"><a href="hazards.html#cb316-7" tabindex="-1"></a>benzene_data_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_data_geo,</span>
<span id="cb316-8"><a href="hazards.html#cb316-8" tabindex="-1"></a>                        <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb316-9"><a href="hazards.html#cb316-9" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb316-10"><a href="hazards.html#cb316-10" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_data_utm)</span>
<span id="cb316-11"><a href="hazards.html#cb316-11" tabindex="-1"></a><span class="co"># change the observed values to the log scale and the coordinates to km&#39;s</span></span>
<span id="cb316-12"><a href="hazards.html#cb316-12" tabindex="-1"></a>Mtl_benzene_sample <span class="ot">&lt;-</span></span>
<span id="cb316-13"><a href="hazards.html#cb316-13" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb316-14"><a href="hazards.html#cb316-14" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">log</span>(benzene_utm_df<span class="sc">$</span>Benzene),</span>
<span id="cb316-15"><a href="hazards.html#cb316-15" tabindex="-1"></a>    <span class="at">easting =</span>  benzene_utm_df<span class="sc">$</span>lon <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb316-16"><a href="hazards.html#cb316-16" tabindex="-1"></a>    <span class="at">northing =</span> benzene_utm_df<span class="sc">$</span>lat <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb316-17"><a href="hazards.html#cb316-17" tabindex="-1"></a>  )</span>
<span id="cb316-18"><a href="hazards.html#cb316-18" tabindex="-1"></a><span class="co"># Compute the distance matrix</span></span>
<span id="cb316-19"><a href="hazards.html#cb316-19" tabindex="-1"></a>obsCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_benzene_sample[,<span class="fu">c</span>(<span class="st">&quot;easting&quot;</span>, <span class="st">&quot;northing&quot;</span>)]))</span>
<span id="cb316-20"><a href="hazards.html#cb316-20" tabindex="-1"></a></span>
<span id="cb316-21"><a href="hazards.html#cb316-21" tabindex="-1"></a>obsDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(obsCoords)</span></code></pre></div>
<pre><code>
data {
  int&lt;lower=1&gt; N;
  int&lt;lower=0&gt; p;
  vector[N] y;
  matrix[N,N] dist_matrix;
  matrix[N,p] X; 
}

parameters {
  real&lt;lower=0&gt; phi;
  real&lt;lower=0&gt; tau;
  real&lt;lower=0&gt; sigma;
  vector[p] beta;
  real beta0;

}
transformed parameters{
  real&lt;lower=0&gt; sigma_sq = square(sigma);
  real&lt;lower=0&gt; tau_sq = square(tau);
}
model {
  vector[N] mu;
  matrix[N, N] L;
  matrix[N, N] Sigma;
  
  Sigma = sigma_sq * exp(-dist_matrix/ phi) + tau_sq *diag_matrix(rep_vector(1, N));


  for(i in 1:N) {
    mu[i] = beta0 + X[i,]*beta;
  }
  
  L = cholesky_decompose(Sigma);
  
  beta0 ~ normal(0,10);
  beta ~ normal(0,10);
  phi ~ inv_gamma(5, 5);
  tau ~ cauchy(0,1);
  sigma ~ cauchy(0,1);

  y ~ multi_normal_cholesky(mu, L);
}</code></pre>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb318-1"><a href="hazards.html#cb318-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb318-2"><a href="hazards.html#cb318-2" tabindex="-1"></a>easting_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>easting))</span>
<span id="cb318-3"><a href="hazards.html#cb318-3" tabindex="-1"></a>northing_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>northing))</span>
<span id="cb318-4"><a href="hazards.html#cb318-4" tabindex="-1"></a></span>
<span id="cb318-5"><a href="hazards.html#cb318-5" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(benzene_utm_df)</span>
<span id="cb318-6"><a href="hazards.html#cb318-6" tabindex="-1"></a><span class="co"># Change coordinates to kilometers</span></span>
<span id="cb318-7"><a href="hazards.html#cb318-7" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">easting =</span> easting_scaled,</span>
<span id="cb318-8"><a href="hazards.html#cb318-8" tabindex="-1"></a>                <span class="at">northing =</span> northing_scaled) </span>
<span id="cb318-9"><a href="hazards.html#cb318-9" tabindex="-1"></a></span>
<span id="cb318-10"><a href="hazards.html#cb318-10" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb318-11"><a href="hazards.html#cb318-11" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb318-12"><a href="hazards.html#cb318-12" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">2</span>,</span>
<span id="cb318-13"><a href="hazards.html#cb318-13" tabindex="-1"></a>  <span class="at">y =</span>   <span class="fu">log</span>(benzene_utm_df<span class="sc">$</span>Benzene),</span>
<span id="cb318-14"><a href="hazards.html#cb318-14" tabindex="-1"></a>  <span class="at">dist_matrix =</span> obsDist,</span>
<span id="cb318-15"><a href="hazards.html#cb318-15" tabindex="-1"></a>  <span class="at">X =</span> <span class="fu">as.matrix</span>(X)</span>
<span id="cb318-16"><a href="hazards.html#cb318-16" tabindex="-1"></a>)</span>
<span id="cb318-17"><a href="hazards.html#cb318-17" tabindex="-1"></a></span>
<span id="cb318-18"><a href="hazards.html#cb318-18" tabindex="-1"></a>Example10_9Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb318-19"><a href="hazards.html#cb318-19" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example10_9.stan&quot;</span>,</span>
<span id="cb318-20"><a href="hazards.html#cb318-20" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb318-21"><a href="hazards.html#cb318-21" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">10000</span>,</span>
<span id="cb318-22"><a href="hazards.html#cb318-22" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">20000</span>,</span>
<span id="cb318-23"><a href="hazards.html#cb318-23" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb318-24"><a href="hazards.html#cb318-24" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb318-25"><a href="hazards.html#cb318-25" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;phi&quot;</span>),</span>
<span id="cb318-26"><a href="hazards.html#cb318-26" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb318-27"><a href="hazards.html#cb318-27" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb319"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb319-1"><a href="hazards.html#cb319-1" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example10_9Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;phi&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.8%20stan%20exp%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb320-1"><a href="hazards.html#cb320-1" tabindex="-1"></a>summary_exp_stan <span class="ot">&lt;-</span></span>
<span id="cb320-2"><a href="hazards.html#cb320-2" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb320-3"><a href="hazards.html#cb320-3" tabindex="-1"></a>    Example10_9Stan,</span>
<span id="cb320-4"><a href="hazards.html#cb320-4" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>,  <span class="st">&quot;phi&quot;</span>),</span>
<span id="cb320-5"><a href="hazards.html#cb320-5" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb320-6"><a href="hazards.html#cb320-6" tabindex="-1"></a>  )</span>
<span id="cb320-7"><a href="hazards.html#cb320-7" tabindex="-1"></a></span>
<span id="cb320-8"><a href="hazards.html#cb320-8" tabindex="-1"></a>summary_exp_stan<span class="sc">$</span>summary</span></code></pre></div>
<pre><code>##                 mean      se_mean         sd          2.5%      97.5%    n_eff
## beta0    0.146457291 0.0018562983 0.07997902 -3.023587e-02 0.28132110 1856.336
## beta[1]  0.047496231 0.0013261678 0.05957233 -6.496270e-02 0.17626742 2017.866
## beta[2]  0.080290249 0.0014607308 0.06744570 -5.992676e-02 0.19665262 2131.906
## sigma_sq 0.055772229 0.0004686651 0.02109726  2.831741e-02 0.10389363 2026.408
## tau_sq   0.009142795 0.0001523047 0.00674511  6.533636e-05 0.02383244 1961.335
## phi      3.666760755 0.0513903964 2.24757184  1.501948e+00 9.25712051 1912.772
##               Rhat
## beta0    0.9994055
## beta[1]  0.9991897
## beta[2]  0.9993034
## sigma_sq 1.0000657
## tau_sq   1.0016241
## phi      0.9994019</code></pre>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb322-1"><a href="hazards.html#cb322-1" tabindex="-1"></a><span class="co"># Obtain coordinates for predictions </span></span>
<span id="cb322-2"><a href="hazards.html#cb322-2" tabindex="-1"></a><span class="co"># note that we are using the same coordinates as the one generated for </span></span>
<span id="cb322-3"><a href="hazards.html#cb322-3" tabindex="-1"></a><span class="co"># the kriging example</span></span>
<span id="cb322-4"><a href="hazards.html#cb322-4" tabindex="-1"></a>Mtl_centroids_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(MtlPred)</span>
<span id="cb322-5"><a href="hazards.html#cb322-5" tabindex="-1"></a>predCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_centroids_df))</span></code></pre></div>
<div class="sourceCode" id="cb323"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb323-1"><a href="hazards.html#cb323-1" tabindex="-1"></a><span class="co"># Extract samples from nimble model</span></span>
<span id="cb323-2"><a href="hazards.html#cb323-2" tabindex="-1"></a>stan_post_samples <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">extract</span>(Example10_9Stan,</span>
<span id="cb323-3"><a href="hazards.html#cb323-3" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>))</span>
<span id="cb323-4"><a href="hazards.html#cb323-4" tabindex="-1"></a></span>
<span id="cb323-5"><a href="hazards.html#cb323-5" tabindex="-1"></a><span class="co"># Extract posterior samples for each of the parameters of interest</span></span>
<span id="cb323-6"><a href="hazards.html#cb323-6" tabindex="-1"></a>post_beta0 <span class="ot">&lt;-</span> stan_post_samples<span class="sc">$</span>beta0</span>
<span id="cb323-7"><a href="hazards.html#cb323-7" tabindex="-1"></a>post_beta <span class="ot">&lt;-</span> stan_post_samples<span class="sc">$</span>beta</span>
<span id="cb323-8"><a href="hazards.html#cb323-8" tabindex="-1"></a><span class="co"># post_beta2 &lt;- stan_post_samples$beta2</span></span>
<span id="cb323-9"><a href="hazards.html#cb323-9" tabindex="-1"></a>post_sigmasq <span class="ot">&lt;-</span> stan_post_samples<span class="sc">$</span>sigma_sq</span>
<span id="cb323-10"><a href="hazards.html#cb323-10" tabindex="-1"></a>post_phi <span class="ot">&lt;-</span> stan_post_samples<span class="sc">$</span>phi</span>
<span id="cb323-11"><a href="hazards.html#cb323-11" tabindex="-1"></a>post_tausq <span class="ot">&lt;-</span> stan_post_samples<span class="sc">$</span>tau_sq</span>
<span id="cb323-12"><a href="hazards.html#cb323-12" tabindex="-1"></a></span>
<span id="cb323-13"><a href="hazards.html#cb323-13" tabindex="-1"></a><span class="co"># Scale coordinates for predictive locations</span></span>
<span id="cb323-14"><a href="hazards.html#cb323-14" tabindex="-1"></a>predCoords_sc <span class="ot">&lt;-</span> predCoords </span>
<span id="cb323-15"><a href="hazards.html#cb323-15" tabindex="-1"></a>predCoords_sc[,<span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb323-16"><a href="hazards.html#cb323-16" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>easting)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>easting)</span>
<span id="cb323-17"><a href="hazards.html#cb323-17" tabindex="-1"></a>predCoords_sc[,<span class="dv">2</span>] <span class="ot">&lt;-</span> </span>
<span id="cb323-18"><a href="hazards.html#cb323-18" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>northing)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>northing)</span>
<span id="cb323-19"><a href="hazards.html#cb323-19" tabindex="-1"></a>  </span>
<span id="cb323-20"><a href="hazards.html#cb323-20" tabindex="-1"></a>n0 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(predCoords_sc)</span>
<span id="cb323-21"><a href="hazards.html#cb323-21" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="fu">length</span>(post_tausq)</span>
<span id="cb323-22"><a href="hazards.html#cb323-22" tabindex="-1"></a></span>
<span id="cb323-23"><a href="hazards.html#cb323-23" tabindex="-1"></a>obsMu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, easting_scaled, northing_scaled) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(post_beta0, post_beta))</span>
<span id="cb323-24"><a href="hazards.html#cb323-24" tabindex="-1"></a></span>
<span id="cb323-25"><a href="hazards.html#cb323-25" tabindex="-1"></a>predMu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, <span class="fu">as.matrix</span>(predCoords_sc)) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(post_beta0, post_beta))</span>
<span id="cb323-26"><a href="hazards.html#cb323-26" tabindex="-1"></a></span>
<span id="cb323-27"><a href="hazards.html#cb323-27" tabindex="-1"></a>pred2obsDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(predCoords, obsCoords)</span>
<span id="cb323-28"><a href="hazards.html#cb323-28" tabindex="-1"></a></span>
<span id="cb323-29"><a href="hazards.html#cb323-29" tabindex="-1"></a>Rcpp<span class="sc">::</span><span class="fu">sourceCpp</span>(<span class="st">&quot;functions/prediction_marginal_gp12.cpp&quot;</span>)</span>
<span id="cb323-30"><a href="hazards.html#cb323-30" tabindex="-1"></a><span class="fu">args</span>(prediction_marginal_gp12)</span></code></pre></div>
<pre><code>## function (y, obsMu, predMu, obsDistMat, pred2ObsDistMat, sigmasq, 
##     phi, tausq, iterprint) 
## NULL</code></pre>
<div class="sourceCode" id="cb325"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb325-1"><a href="hazards.html#cb325-1" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb325-2"><a href="hazards.html#cb325-2" tabindex="-1"></a>  pred_samples <span class="ot">&lt;-</span> <span class="fu">prediction_marginal_gp12</span>(</span>
<span id="cb325-3"><a href="hazards.html#cb325-3" tabindex="-1"></a>    <span class="at">y =</span> Mtl_benzene_sample<span class="sc">$</span>y,</span>
<span id="cb325-4"><a href="hazards.html#cb325-4" tabindex="-1"></a>    <span class="at">obsMu =</span> obsMu,</span>
<span id="cb325-5"><a href="hazards.html#cb325-5" tabindex="-1"></a>    <span class="at">predMu =</span> predMu,</span>
<span id="cb325-6"><a href="hazards.html#cb325-6" tabindex="-1"></a>    <span class="at">obsDistMat =</span> obsDist,</span>
<span id="cb325-7"><a href="hazards.html#cb325-7" tabindex="-1"></a>    <span class="at">pred2ObsDistMat =</span> pred2obsDist,</span>
<span id="cb325-8"><a href="hazards.html#cb325-8" tabindex="-1"></a>    <span class="at">sigmasq =</span> post_sigmasq,</span>
<span id="cb325-9"><a href="hazards.html#cb325-9" tabindex="-1"></a>    <span class="at">phi =</span> post_phi,</span>
<span id="cb325-10"><a href="hazards.html#cb325-10" tabindex="-1"></a>    <span class="at">tausq =</span> post_tausq,</span>
<span id="cb325-11"><a href="hazards.html#cb325-11" tabindex="-1"></a>    <span class="at">iterprint =</span> <span class="dv">1000</span></span>
<span id="cb325-12"><a href="hazards.html#cb325-12" tabindex="-1"></a>  )</span>
<span id="cb325-13"><a href="hazards.html#cb325-13" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Prediction upto the 0th MCMC sample is completed
## Prediction upto the 1000th MCMC sample is completed</code></pre>
<pre><code>##    user  system elapsed 
##  107.44    0.09  126.70</code></pre>
<div class="sourceCode" id="cb328"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb328-1"><a href="hazards.html#cb328-1" tabindex="-1"></a>predict_res_dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb328-2"><a href="hazards.html#cb328-2" tabindex="-1"></a>  <span class="at">xcoord =</span> predCoords[, <span class="dv">1</span>],</span>
<span id="cb328-3"><a href="hazards.html#cb328-3" tabindex="-1"></a>  <span class="at">ycoord =</span> predCoords[, <span class="dv">2</span>],</span>
<span id="cb328-4"><a href="hazards.html#cb328-4" tabindex="-1"></a>  <span class="at">post.mean =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, mean),</span>
<span id="cb328-5"><a href="hazards.html#cb328-5" tabindex="-1"></a>  <span class="at">post.var =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, var),</span>
<span id="cb328-6"><a href="hazards.html#cb328-6" tabindex="-1"></a>  <span class="at">q2.5 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb328-7"><a href="hazards.html#cb328-7" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.025</span>)),</span>
<span id="cb328-8"><a href="hazards.html#cb328-8" tabindex="-1"></a>  <span class="at">q50 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb328-9"><a href="hazards.html#cb328-9" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.5</span>)),</span>
<span id="cb328-10"><a href="hazards.html#cb328-10" tabindex="-1"></a>  <span class="at">q97.5 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb328-11"><a href="hazards.html#cb328-11" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.975</span>))</span>
<span id="cb328-12"><a href="hazards.html#cb328-12" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb329-1"><a href="hazards.html#cb329-1" tabindex="-1"></a>x<span class="sc">$</span>stan.pred <span class="ot">&lt;-</span> predict_res_dt<span class="sc">$</span>post.mean</span>
<span id="cb329-2"><a href="hazards.html#cb329-2" tabindex="-1"></a>x<span class="sc">$</span>stan.var <span class="ot">&lt;-</span> predict_res_dt<span class="sc">$</span>post.var</span>
<span id="cb329-3"><a href="hazards.html#cb329-3" tabindex="-1"></a></span>
<span id="cb329-4"><a href="hazards.html#cb329-4" tabindex="-1"></a></span>
<span id="cb329-5"><a href="hazards.html#cb329-5" tabindex="-1"></a>stan_pred <span class="ot">&lt;-</span></span>
<span id="cb329-6"><a href="hazards.html#cb329-6" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb329-7"><a href="hazards.html#cb329-7" tabindex="-1"></a>    x[<span class="st">&quot;stan.pred&quot;</span>],</span>
<span id="cb329-8"><a href="hazards.html#cb329-8" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Stan spatial predictions &quot;</span>,</span>
<span id="cb329-9"><a href="hazards.html#cb329-9" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb329-10"><a href="hazards.html#cb329-10" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb329-11"><a href="hazards.html#cb329-11" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.8</span>, <span class="fl">0.02</span>)</span>
<span id="cb329-12"><a href="hazards.html#cb329-12" tabindex="-1"></a>  )</span>
<span id="cb329-13"><a href="hazards.html#cb329-13" tabindex="-1"></a>stan_var <span class="ot">&lt;-</span></span>
<span id="cb329-14"><a href="hazards.html#cb329-14" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb329-15"><a href="hazards.html#cb329-15" tabindex="-1"></a>    x[<span class="st">&quot;stan.var&quot;</span>],</span>
<span id="cb329-16"><a href="hazards.html#cb329-16" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Stan predictions variance &quot;</span>,</span>
<span id="cb329-17"><a href="hazards.html#cb329-17" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb329-18"><a href="hazards.html#cb329-18" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb329-19"><a href="hazards.html#cb329-19" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span>)</span>
<span id="cb329-20"><a href="hazards.html#cb329-20" tabindex="-1"></a>  )</span>
<span id="cb329-21"><a href="hazards.html#cb329-21" tabindex="-1"></a></span>
<span id="cb329-22"><a href="hazards.html#cb329-22" tabindex="-1"></a><span class="fu">plot_grid</span>(stan_pred, stan_var, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.8%20stan%20plot%20predictions-1.png" width="672" /></p>
</div>
</div>
<div id="extra-10.9-spatial-predictions" class="section level2 unnumbered hasAnchor">
<h2>Extra 10.9: Spatial predictions<a href="hazards.html#extra-10.9-spatial-predictions" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="nimble-6" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="hazards.html#nimble-6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb330"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb330-1"><a href="hazards.html#cb330-1" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: I am just doing for 5 locations (please double-check my equations) and it instead of running in 2 minutes it runs in 6 (in case you want to highlight that). But we should discuss the order of this cause I am doing the predictions with Paritosh&#39;s code in the previous section.</span></span>
<span id="cb330-2"><a href="hazards.html#cb330-2" tabindex="-1"></a></span>
<span id="cb330-3"><a href="hazards.html#cb330-3" tabindex="-1"></a><span class="co"># Obtain coordinates for predictions </span></span>
<span id="cb330-4"><a href="hazards.html#cb330-4" tabindex="-1"></a><span class="co"># note that we are using the same coordinates as the one generated for </span></span>
<span id="cb330-5"><a href="hazards.html#cb330-5" tabindex="-1"></a><span class="co"># the kriging example</span></span>
<span id="cb330-6"><a href="hazards.html#cb330-6" tabindex="-1"></a>Mtl_centroids_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(MtlPred)</span>
<span id="cb330-7"><a href="hazards.html#cb330-7" tabindex="-1"></a>predCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_centroids_df))</span>
<span id="cb330-8"><a href="hazards.html#cb330-8" tabindex="-1"></a></span>
<span id="cb330-9"><a href="hazards.html#cb330-9" tabindex="-1"></a><span class="co"># Scale coordinates for predictive locations</span></span>
<span id="cb330-10"><a href="hazards.html#cb330-10" tabindex="-1"></a>predCoords_sc <span class="ot">&lt;-</span> predCoords </span>
<span id="cb330-11"><a href="hazards.html#cb330-11" tabindex="-1"></a>predCoords_sc[,<span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb330-12"><a href="hazards.html#cb330-12" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>easting)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>easting)</span>
<span id="cb330-13"><a href="hazards.html#cb330-13" tabindex="-1"></a>predCoords_sc[,<span class="dv">2</span>] <span class="ot">&lt;-</span> </span>
<span id="cb330-14"><a href="hazards.html#cb330-14" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>northing)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>northing)</span>
<span id="cb330-15"><a href="hazards.html#cb330-15" tabindex="-1"></a></span>
<span id="cb330-16"><a href="hazards.html#cb330-16" tabindex="-1"></a><span class="co"># As an example we are only going to predict 5 locations  </span></span>
<span id="cb330-17"><a href="hazards.html#cb330-17" tabindex="-1"></a></span>
<span id="cb330-18"><a href="hazards.html#cb330-18" tabindex="-1"></a>nu <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb330-19"><a href="hazards.html#cb330-19" tabindex="-1"></a>predCoords_five <span class="ot">&lt;-</span> predCoords_sc[<span class="dv">1</span><span class="sc">:</span>nu,]</span>
<span id="cb330-20"><a href="hazards.html#cb330-20" tabindex="-1"></a></span>
<span id="cb330-21"><a href="hazards.html#cb330-21" tabindex="-1"></a>obs2predDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(obsCoords, predCoords[<span class="dv">1</span><span class="sc">:</span>nu,])</span>
<span id="cb330-22"><a href="hazards.html#cb330-22" tabindex="-1"></a>pred2predDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(predCoords[<span class="dv">1</span><span class="sc">:</span>nu,])</span></code></pre></div>
<div class="sourceCode" id="cb331"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb331-1"><a href="hazards.html#cb331-1" tabindex="-1"></a>Example10_10Code <span class="ot">&lt;-</span>  <span class="fu">nimbleCode</span> ({</span>
<span id="cb331-2"><a href="hazards.html#cb331-2" tabindex="-1"></a>  <span class="co"># Covariance matrix spatial effect</span></span>
<span id="cb331-3"><a href="hazards.html#cb331-3" tabindex="-1"></a>  Sigma_obs[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n] <span class="ot">&lt;-</span></span>
<span id="cb331-4"><a href="hazards.html#cb331-4" tabindex="-1"></a>    sigma_sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>distMatrix[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n] <span class="sc">/</span> phi) <span class="sc">+</span> tau_sq <span class="sc">*</span> <span class="fu">identityMatrix</span>(<span class="at">d =</span> n)</span>
<span id="cb331-5"><a href="hazards.html#cb331-5" tabindex="-1"></a>  </span>
<span id="cb331-6"><a href="hazards.html#cb331-6" tabindex="-1"></a>  Sigma_pred[<span class="dv">1</span><span class="sc">:</span>nu, <span class="dv">1</span><span class="sc">:</span>nu] <span class="ot">&lt;-</span></span>
<span id="cb331-7"><a href="hazards.html#cb331-7" tabindex="-1"></a>    sigma_sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>distMatrixUnobs[<span class="dv">1</span><span class="sc">:</span>nu, <span class="dv">1</span><span class="sc">:</span>nu] <span class="sc">/</span> phi) <span class="sc">+</span> tau_sq <span class="sc">*</span> <span class="fu">identityMatrix</span>(<span class="at">d =</span> nu)</span>
<span id="cb331-8"><a href="hazards.html#cb331-8" tabindex="-1"></a>  </span>
<span id="cb331-9"><a href="hazards.html#cb331-9" tabindex="-1"></a>  Sigma_obs_pred[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>nu] <span class="ot">&lt;-</span></span>
<span id="cb331-10"><a href="hazards.html#cb331-10" tabindex="-1"></a>    sigma_sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>distMatrixObsUnobs[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>nu] <span class="sc">/</span> phi) </span>
<span id="cb331-11"><a href="hazards.html#cb331-11" tabindex="-1"></a>  </span>
<span id="cb331-12"><a href="hazards.html#cb331-12" tabindex="-1"></a>  <span class="cf">for</span> (site <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb331-13"><a href="hazards.html#cb331-13" tabindex="-1"></a>    mean.site[site] <span class="ot">&lt;-</span></span>
<span id="cb331-14"><a href="hazards.html#cb331-14" tabindex="-1"></a>      beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> easting[site] <span class="sc">+</span> beta2 <span class="sc">*</span> northing[site]</span>
<span id="cb331-15"><a href="hazards.html#cb331-15" tabindex="-1"></a>  }</span>
<span id="cb331-16"><a href="hazards.html#cb331-16" tabindex="-1"></a>  y[<span class="dv">1</span><span class="sc">:</span>n]  <span class="sc">~</span>  <span class="fu">dmnorm</span>(mean.site[<span class="dv">1</span><span class="sc">:</span>n], <span class="at">cov =</span> Sigma_obs[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n])</span>
<span id="cb331-17"><a href="hazards.html#cb331-17" tabindex="-1"></a>  </span>
<span id="cb331-18"><a href="hazards.html#cb331-18" tabindex="-1"></a>  <span class="co"># Spatial predictions</span></span>
<span id="cb331-19"><a href="hazards.html#cb331-19" tabindex="-1"></a>  </span>
<span id="cb331-20"><a href="hazards.html#cb331-20" tabindex="-1"></a>  <span class="cf">for</span> (usite <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nu) {</span>
<span id="cb331-21"><a href="hazards.html#cb331-21" tabindex="-1"></a>    mean.pred.site[usite] <span class="ot">&lt;-</span></span>
<span id="cb331-22"><a href="hazards.html#cb331-22" tabindex="-1"></a>      beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> easting_pred[usite] <span class="sc">+</span> beta2 <span class="sc">*</span> northing_pred[usite]</span>
<span id="cb331-23"><a href="hazards.html#cb331-23" tabindex="-1"></a>  }</span>
<span id="cb331-24"><a href="hazards.html#cb331-24" tabindex="-1"></a>  </span>
<span id="cb331-25"><a href="hazards.html#cb331-25" tabindex="-1"></a>  mean_sigma[<span class="dv">1</span><span class="sc">:</span>nu] <span class="ot">&lt;-</span> <span class="fu">t</span>(Sigma_obs_pred[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>nu])<span class="sc">%*%</span> </span>
<span id="cb331-26"><a href="hazards.html#cb331-26" tabindex="-1"></a>    <span class="fu">inverse</span>(Sigma_obs[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n])<span class="sc">%*%</span>(y[<span class="dv">1</span><span class="sc">:</span>n] <span class="sc">-</span> mean.site[<span class="dv">1</span><span class="sc">:</span>n])</span>
<span id="cb331-27"><a href="hazards.html#cb331-27" tabindex="-1"></a>  </span>
<span id="cb331-28"><a href="hazards.html#cb331-28" tabindex="-1"></a>  mu_pred[<span class="dv">1</span><span class="sc">:</span>nu] <span class="ot">&lt;-</span></span>
<span id="cb331-29"><a href="hazards.html#cb331-29" tabindex="-1"></a>    mean.pred.site[<span class="dv">1</span><span class="sc">:</span>nu] <span class="sc">+</span> mean_sigma[<span class="dv">1</span><span class="sc">:</span>nu]</span>
<span id="cb331-30"><a href="hazards.html#cb331-30" tabindex="-1"></a>  </span>
<span id="cb331-31"><a href="hazards.html#cb331-31" tabindex="-1"></a>  cov_pred[<span class="dv">1</span><span class="sc">:</span>nu, <span class="dv">1</span><span class="sc">:</span>nu] <span class="ot">&lt;-</span></span>
<span id="cb331-32"><a href="hazards.html#cb331-32" tabindex="-1"></a>    Sigma_pred[<span class="dv">1</span><span class="sc">:</span>nu, <span class="dv">1</span><span class="sc">:</span>nu] <span class="sc">-</span> <span class="fu">t</span>(Sigma_obs_pred[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>nu]) <span class="sc">%*%</span> <span class="fu">inverse</span>(Sigma_obs[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n]) <span class="sc">%*%</span> Sigma_obs_pred[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>nu]</span>
<span id="cb331-33"><a href="hazards.html#cb331-33" tabindex="-1"></a>  </span>
<span id="cb331-34"><a href="hazards.html#cb331-34" tabindex="-1"></a>  y_pred[<span class="dv">1</span><span class="sc">:</span>nu]  <span class="sc">~</span>  <span class="fu">dmnorm</span>(mu_pred[<span class="dv">1</span><span class="sc">:</span>nu], <span class="at">cov =</span> cov_pred[<span class="dv">1</span><span class="sc">:</span>nu, <span class="dv">1</span><span class="sc">:</span>nu])</span>
<span id="cb331-35"><a href="hazards.html#cb331-35" tabindex="-1"></a>  </span>
<span id="cb331-36"><a href="hazards.html#cb331-36" tabindex="-1"></a>  <span class="co"># Set up the priors for the spatial model</span></span>
<span id="cb331-37"><a href="hazards.html#cb331-37" tabindex="-1"></a>  </span>
<span id="cb331-38"><a href="hazards.html#cb331-38" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb331-39"><a href="hazards.html#cb331-39" tabindex="-1"></a>  sigma_sq <span class="ot">&lt;-</span> sigma <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb331-40"><a href="hazards.html#cb331-40" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb331-41"><a href="hazards.html#cb331-41" tabindex="-1"></a>  tau_sq <span class="ot">&lt;-</span> tau <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb331-42"><a href="hazards.html#cb331-42" tabindex="-1"></a>  phi_inv <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="at">shape =</span>  <span class="dv">5</span>, <span class="at">rate =</span> <span class="dv">5</span>)</span>
<span id="cb331-43"><a href="hazards.html#cb331-43" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> phi_inv</span>
<span id="cb331-44"><a href="hazards.html#cb331-44" tabindex="-1"></a>  <span class="co"># prior for the coefficients</span></span>
<span id="cb331-45"><a href="hazards.html#cb331-45" tabindex="-1"></a>  beta0 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb331-46"><a href="hazards.html#cb331-46" tabindex="-1"></a>  beta1 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb331-47"><a href="hazards.html#cb331-47" tabindex="-1"></a>  beta2 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb331-48"><a href="hazards.html#cb331-48" tabindex="-1"></a>  </span>
<span id="cb331-49"><a href="hazards.html#cb331-49" tabindex="-1"></a>}) </span>
<span id="cb331-50"><a href="hazards.html#cb331-50" tabindex="-1"></a></span>
<span id="cb331-51"><a href="hazards.html#cb331-51" tabindex="-1"></a><span class="co"># Define the constants, data, parameters and initial values</span></span>
<span id="cb331-52"><a href="hazards.html#cb331-52" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb331-53"><a href="hazards.html#cb331-53" tabindex="-1"></a>easting_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>easting))</span>
<span id="cb331-54"><a href="hazards.html#cb331-54" tabindex="-1"></a>northing_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>northing))</span>
<span id="cb331-55"><a href="hazards.html#cb331-55" tabindex="-1"></a></span>
<span id="cb331-56"><a href="hazards.html#cb331-56" tabindex="-1"></a>constants <span class="ot">&lt;-</span></span>
<span id="cb331-57"><a href="hazards.html#cb331-57" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">n =</span> <span class="fu">nrow</span>(Mtl_benzene_sample), <span class="at">nu =</span> nu)</span>
<span id="cb331-58"><a href="hazards.html#cb331-58" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span></span>
<span id="cb331-59"><a href="hazards.html#cb331-59" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb331-60"><a href="hazards.html#cb331-60" tabindex="-1"></a>    <span class="at">y =</span> Mtl_benzene_sample<span class="sc">$</span>y,</span>
<span id="cb331-61"><a href="hazards.html#cb331-61" tabindex="-1"></a>    <span class="at">easting =</span> easting_scaled,</span>
<span id="cb331-62"><a href="hazards.html#cb331-62" tabindex="-1"></a>    <span class="at">northing =</span> northing_scaled,</span>
<span id="cb331-63"><a href="hazards.html#cb331-63" tabindex="-1"></a>    <span class="at">easting_pred =</span> predCoords_five[,<span class="dv">1</span>],</span>
<span id="cb331-64"><a href="hazards.html#cb331-64" tabindex="-1"></a>    <span class="at">northing_pred =</span> predCoords_five[,<span class="dv">2</span>],</span>
<span id="cb331-65"><a href="hazards.html#cb331-65" tabindex="-1"></a>    <span class="at">distMatrix =</span> obsDist,</span>
<span id="cb331-66"><a href="hazards.html#cb331-66" tabindex="-1"></a>    <span class="at">distMatrixUnobs =</span> pred2predDist,</span>
<span id="cb331-67"><a href="hazards.html#cb331-67" tabindex="-1"></a>    <span class="at">distMatrixObsUnobs =</span> obs2predDist</span>
<span id="cb331-68"><a href="hazards.html#cb331-68" tabindex="-1"></a>  )</span>
<span id="cb331-69"><a href="hazards.html#cb331-69" tabindex="-1"></a>params <span class="ot">&lt;-</span></span>
<span id="cb331-70"><a href="hazards.html#cb331-70" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,</span>
<span id="cb331-71"><a href="hazards.html#cb331-71" tabindex="-1"></a>    <span class="st">&quot;beta1&quot;</span>,</span>
<span id="cb331-72"><a href="hazards.html#cb331-72" tabindex="-1"></a>    <span class="st">&quot;beta2&quot;</span>,</span>
<span id="cb331-73"><a href="hazards.html#cb331-73" tabindex="-1"></a>    <span class="st">&quot;phi&quot;</span>,</span>
<span id="cb331-74"><a href="hazards.html#cb331-74" tabindex="-1"></a>    <span class="st">&quot;tau&quot;</span>,</span>
<span id="cb331-75"><a href="hazards.html#cb331-75" tabindex="-1"></a>    <span class="st">&quot;sigma&quot;</span>,</span>
<span id="cb331-76"><a href="hazards.html#cb331-76" tabindex="-1"></a>    <span class="st">&quot;tau_sq&quot;</span>,</span>
<span id="cb331-77"><a href="hazards.html#cb331-77" tabindex="-1"></a>    <span class="st">&quot;y_pred&quot;</span>,</span>
<span id="cb331-78"><a href="hazards.html#cb331-78" tabindex="-1"></a>    <span class="st">&quot;sigma_sq&quot;</span>)</span>
<span id="cb331-79"><a href="hazards.html#cb331-79" tabindex="-1"></a>inits <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">sigma =</span> <span class="fl">0.1</span>,</span>
<span id="cb331-80"><a href="hazards.html#cb331-80" tabindex="-1"></a>              <span class="at">phi_inv =</span> <span class="dv">6</span> <span class="sc">/</span> <span class="fu">max</span>(obsDist),</span>
<span id="cb331-81"><a href="hazards.html#cb331-81" tabindex="-1"></a>              <span class="at">tau =</span> <span class="fl">0.1</span>)</span>
<span id="cb331-82"><a href="hazards.html#cb331-82" tabindex="-1"></a><span class="co"># Run model in nimble</span></span>
<span id="cb331-83"><a href="hazards.html#cb331-83" tabindex="-1"></a></span>
<span id="cb331-84"><a href="hazards.html#cb331-84" tabindex="-1"></a>mcmc.out <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb331-85"><a href="hazards.html#cb331-85" tabindex="-1"></a>  <span class="at">code =</span> Example10_10Code,</span>
<span id="cb331-86"><a href="hazards.html#cb331-86" tabindex="-1"></a>  <span class="at">constants =</span> constants,</span>
<span id="cb331-87"><a href="hazards.html#cb331-87" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb331-88"><a href="hazards.html#cb331-88" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb331-89"><a href="hazards.html#cb331-89" tabindex="-1"></a>  <span class="at">monitors =</span> params,</span>
<span id="cb331-90"><a href="hazards.html#cb331-90" tabindex="-1"></a>  <span class="at">niter =</span> <span class="dv">40000</span>,</span>
<span id="cb331-91"><a href="hazards.html#cb331-91" tabindex="-1"></a>  <span class="at">nburnin =</span> <span class="dv">20000</span>,</span>
<span id="cb331-92"><a href="hazards.html#cb331-92" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">14</span>,</span>
<span id="cb331-93"><a href="hazards.html#cb331-93" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb331-94"><a href="hazards.html#cb331-94" tabindex="-1"></a>  <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb331-95"><a href="hazards.html#cb331-95" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb331-96"><a href="hazards.html#cb331-96" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb331-97"><a href="hazards.html#cb331-97" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb332"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb332-1"><a href="hazards.html#cb332-1" tabindex="-1"></a>mcmc.out<span class="sc">$</span>WAIC</span></code></pre></div>
<pre><code>## nimbleList object of type waicList
## Field &quot;WAIC&quot;:
## [1] -32.28445
## Field &quot;lppd&quot;:
## [1] 19.03747
## Field &quot;pWAIC&quot;:
## [1] 2.895244</code></pre>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb334-1"><a href="hazards.html#cb334-1" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(mcmc.out<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 849.3096</code></pre>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb336-1"><a href="hazards.html#cb336-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta0&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb337"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb337-1"><a href="hazards.html#cb337-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta1&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta1&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb338-1"><a href="hazards.html#cb338-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta2&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta2&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-3.png" width="672" /></p>
<div class="sourceCode" id="cb339"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb339-1"><a href="hazards.html#cb339-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;sigma&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;sigma&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-4.png" width="672" /></p>
<div class="sourceCode" id="cb340"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb340-1"><a href="hazards.html#cb340-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;tau&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-5.png" width="672" /></p>
<div class="sourceCode" id="cb341"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb341-1"><a href="hazards.html#cb341-1" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;phi&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-6.png" width="672" /></p>
<div class="sourceCode" id="cb342"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb342-1"><a href="hazards.html#cb342-1" tabindex="-1"></a>mcmc.out<span class="sc">$</span>summary<span class="sc">$</span>all.chains</span></code></pre></div>
<pre><code>##                   Mean       Median     St.Dev.     95%CI_low  95%CI_upp
## beta0      0.143282027  0.151098526 0.080210901 -4.320255e-02 0.28188251
## beta1      0.047132468  0.045714893 0.059074146 -7.036740e-02 0.16808769
## beta2      0.078236153  0.083129502 0.067977770 -6.927811e-02 0.19791770
## phi        3.672082520  3.089047660 2.158752561  1.484596e+00 9.20444422
## sigma      0.233174608  0.227937419 0.040783337  1.687427e-01 0.33073631
## sigma_sq   0.056033096  0.051955467 0.021212336  2.847411e-02 0.10938656
## tau        0.086925465  0.091948800 0.039612987  5.328545e-03 0.15319110
## tau_sq     0.009124676  0.008454582 0.006622246  2.839674e-05 0.02346751
## y_pred[1] -0.255307410 -0.262034854 0.307921711 -8.442072e-01 0.36678929
## y_pred[2] -0.255612451 -0.263067874 0.306518102 -8.718905e-01 0.36502437
## y_pred[3] -0.247526801 -0.251652153 0.299628925 -8.238475e-01 0.37022723
## y_pred[4] -0.248606948 -0.257696742 0.303087157 -8.451291e-01 0.37558929
## y_pred[5] -0.246847841 -0.246510211 0.301927586 -8.437388e-01 0.35702082</code></pre>
</div>
<div id="stan-5" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="hazards.html#stan-5" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb344"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb344-1"><a href="hazards.html#cb344-1" tabindex="-1"></a><span class="co"># Load data predictions</span></span>
<span id="cb344-2"><a href="hazards.html#cb344-2" tabindex="-1"></a><span class="co"># Obtain coordinates for predictions </span></span>
<span id="cb344-3"><a href="hazards.html#cb344-3" tabindex="-1"></a><span class="co"># note that we are using the same coordinates as the one generated for </span></span>
<span id="cb344-4"><a href="hazards.html#cb344-4" tabindex="-1"></a><span class="co"># the kriging example</span></span>
<span id="cb344-5"><a href="hazards.html#cb344-5" tabindex="-1"></a>Mtl_centroids_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(MtlPred)</span>
<span id="cb344-6"><a href="hazards.html#cb344-6" tabindex="-1"></a>predCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_centroids_df))</span>
<span id="cb344-7"><a href="hazards.html#cb344-7" tabindex="-1"></a></span>
<span id="cb344-8"><a href="hazards.html#cb344-8" tabindex="-1"></a><span class="co"># Scale coordinates for predictive locations</span></span>
<span id="cb344-9"><a href="hazards.html#cb344-9" tabindex="-1"></a>predCoords_sc <span class="ot">&lt;-</span> predCoords </span>
<span id="cb344-10"><a href="hazards.html#cb344-10" tabindex="-1"></a>predCoords_sc[,<span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb344-11"><a href="hazards.html#cb344-11" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>easting)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>easting)</span>
<span id="cb344-12"><a href="hazards.html#cb344-12" tabindex="-1"></a>predCoords_sc[,<span class="dv">2</span>] <span class="ot">&lt;-</span> </span>
<span id="cb344-13"><a href="hazards.html#cb344-13" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>northing)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>northing)</span>
<span id="cb344-14"><a href="hazards.html#cb344-14" tabindex="-1"></a></span>
<span id="cb344-15"><a href="hazards.html#cb344-15" tabindex="-1"></a><span class="co"># As an example we are only going to predict 5 locations  </span></span>
<span id="cb344-16"><a href="hazards.html#cb344-16" tabindex="-1"></a></span>
<span id="cb344-17"><a href="hazards.html#cb344-17" tabindex="-1"></a>nu <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb344-18"><a href="hazards.html#cb344-18" tabindex="-1"></a>predCoords_five <span class="ot">&lt;-</span> predCoords_sc[<span class="dv">1</span><span class="sc">:</span>nu,]</span>
<span id="cb344-19"><a href="hazards.html#cb344-19" tabindex="-1"></a></span>
<span id="cb344-20"><a href="hazards.html#cb344-20" tabindex="-1"></a>obs2predDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(obsCoords, predCoords[<span class="dv">1</span><span class="sc">:</span>nu,])</span>
<span id="cb344-21"><a href="hazards.html#cb344-21" tabindex="-1"></a>pred2predDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(predCoords[<span class="dv">1</span><span class="sc">:</span>nu,])</span></code></pre></div>
<pre><code>data {
  int&lt;lower=1&gt; N;
  int&lt;lower = 0&gt; N_pred;
  int&lt;lower=0&gt; p;
  vector[N] y;
  matrix[N,N] obs_dist_matrix;
  matrix[N,N_pred] obs_pred_dist_matrix;
  matrix[N_pred, N_pred] pred_dist_matrix;
  matrix[N,p] X; 
  matrix[N_pred,p] X_pred; 
}
parameters {
  real&lt;lower=0&gt; phi;
  real&lt;lower=0&gt; tau;
  real&lt;lower=0&gt; sigma;
  vector[p] beta;
  real beta0;
}
transformed parameters{
  real&lt;lower=0&gt; sigma_sq = square(sigma);
  real&lt;lower=0&gt; tau_sq = square(tau);
}
model {
  matrix[N, N] L;
  matrix[N, N] Sigma;
  vector[N] mu;

  Sigma = sigma_sq * exp(-obs_dist_matrix/ phi) + tau_sq *diag_matrix(rep_vector(1, N));
   // diagonal elements

  for(i in 1:N) {
    mu[i] = beta0 + X[i,]*beta;
  }
  
  L = cholesky_decompose(Sigma);
  
  beta0 ~ normal(0,10);
  beta ~ normal(0,10);
  phi ~ inv_gamma(5, 5);
  tau ~ cauchy(0,1);
  sigma ~ cauchy(0,1);

  y ~ multi_normal_cholesky(mu, L);
}

generated quantities {
  matrix[N_pred, N_pred] L;
  matrix[N, N] Sigma_obs;
  matrix[N_pred, N_pred] Sigma_pred;
  matrix[N_pred, N_pred] Cov_pred;
  matrix[N, N_pred] Sigma_obs_pred;
  vector[N] mu;
  vector[N_pred] mu_unobs;
  vector[N_pred] mu_pred;
  vector[N_pred] y_pred;

 Sigma_obs = sigma_sq * exp(-obs_dist_matrix/ phi) + tau_sq *diag_matrix(rep_vector(1, N));
 Sigma_pred = sigma_sq * exp(-pred_dist_matrix/ phi) + tau_sq *diag_matrix(rep_vector(1, N_pred));
 Sigma_obs_pred =  sigma_sq * exp(-obs_pred_dist_matrix/ phi);

 for (j in 1:N_pred) {
    mu_unobs[j] = beta0 + X_pred[j,]*beta;
  }
  
  for(i in 1:N) {
    mu[i] = beta0 + X[i,]*beta;
  }
  
  mu_pred = mu_unobs + Sigma_obs_pred&#39;*inverse(Sigma_obs)*(y - mu);
  Cov_pred = Sigma_pred - Sigma_obs_pred&#39;*inverse(Sigma_obs)*Sigma_obs_pred;
  L = cholesky_decompose(Cov_pred);
  y_pred  = multi_normal_cholesky_rng(mu_pred, L);
  
 
  
}</code></pre>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb346-1"><a href="hazards.html#cb346-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb346-2"><a href="hazards.html#cb346-2" tabindex="-1"></a>easting_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>easting))</span>
<span id="cb346-3"><a href="hazards.html#cb346-3" tabindex="-1"></a>northing_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>northing))</span>
<span id="cb346-4"><a href="hazards.html#cb346-4" tabindex="-1"></a></span>
<span id="cb346-5"><a href="hazards.html#cb346-5" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(benzene_utm_df)</span>
<span id="cb346-6"><a href="hazards.html#cb346-6" tabindex="-1"></a><span class="co"># Change coordinates to kilometers</span></span>
<span id="cb346-7"><a href="hazards.html#cb346-7" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">easting =</span> easting_scaled,</span>
<span id="cb346-8"><a href="hazards.html#cb346-8" tabindex="-1"></a>                <span class="at">northing =</span> northing_scaled) </span>
<span id="cb346-9"><a href="hazards.html#cb346-9" tabindex="-1"></a></span>
<span id="cb346-10"><a href="hazards.html#cb346-10" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb346-11"><a href="hazards.html#cb346-11" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb346-12"><a href="hazards.html#cb346-12" tabindex="-1"></a>  <span class="at">N_pred =</span> <span class="fu">nrow</span>(predCoords_five),</span>
<span id="cb346-13"><a href="hazards.html#cb346-13" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">2</span>,</span>
<span id="cb346-14"><a href="hazards.html#cb346-14" tabindex="-1"></a>  <span class="at">y =</span>   <span class="fu">log</span>(benzene_utm_df<span class="sc">$</span>Benzene),</span>
<span id="cb346-15"><a href="hazards.html#cb346-15" tabindex="-1"></a>  <span class="at">obs_dist_matrix =</span> obsDist,</span>
<span id="cb346-16"><a href="hazards.html#cb346-16" tabindex="-1"></a>  <span class="at">obs_pred_dist_matrix =</span> obs2predDist,</span>
<span id="cb346-17"><a href="hazards.html#cb346-17" tabindex="-1"></a>  <span class="at">pred_dist_matrix =</span> pred2predDist,</span>
<span id="cb346-18"><a href="hazards.html#cb346-18" tabindex="-1"></a>  <span class="at">X =</span> <span class="fu">as.matrix</span>(X),</span>
<span id="cb346-19"><a href="hazards.html#cb346-19" tabindex="-1"></a>  <span class="at">X_pred =</span> predCoords_five</span>
<span id="cb346-20"><a href="hazards.html#cb346-20" tabindex="-1"></a>)</span>
<span id="cb346-21"><a href="hazards.html#cb346-21" tabindex="-1"></a></span>
<span id="cb346-22"><a href="hazards.html#cb346-22" tabindex="-1"></a>Example10_10Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb346-23"><a href="hazards.html#cb346-23" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example10_10.stan&quot;</span>,</span>
<span id="cb346-24"><a href="hazards.html#cb346-24" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb346-25"><a href="hazards.html#cb346-25" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">10000</span>,</span>
<span id="cb346-26"><a href="hazards.html#cb346-26" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">20000</span>,</span>
<span id="cb346-27"><a href="hazards.html#cb346-27" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb346-28"><a href="hazards.html#cb346-28" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb346-29"><a href="hazards.html#cb346-29" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;y_pred&quot;</span>),</span>
<span id="cb346-30"><a href="hazards.html#cb346-30" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb346-31"><a href="hazards.html#cb346-31" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb347"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb347-1"><a href="hazards.html#cb347-1" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example10_10Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;y_pred[1]&quot;</span>, <span class="st">&quot;y_pred[5]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%20109%20stan%20exp%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb348-1"><a href="hazards.html#cb348-1" tabindex="-1"></a>summary_exp_stan <span class="ot">&lt;-</span></span>
<span id="cb348-2"><a href="hazards.html#cb348-2" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb348-3"><a href="hazards.html#cb348-3" tabindex="-1"></a>    Example10_10Stan,</span>
<span id="cb348-4"><a href="hazards.html#cb348-4" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>,  <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;y_pred&quot;</span>),</span>
<span id="cb348-5"><a href="hazards.html#cb348-5" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb348-6"><a href="hazards.html#cb348-6" tabindex="-1"></a>  )</span>
<span id="cb348-7"><a href="hazards.html#cb348-7" tabindex="-1"></a></span>
<span id="cb348-8"><a href="hazards.html#cb348-8" tabindex="-1"></a>summary_exp_stan<span class="sc">$</span>summary</span></code></pre></div>
<pre><code>##                  mean      se_mean          sd          2.5%      97.5%
## beta0      0.15258643 0.0018234279 0.079308240 -2.001743e-02 0.28617872
## beta[1]    0.05045002 0.0014848444 0.060158681 -5.797474e-02 0.17469632
## beta[2]    0.08097296 0.0015480754 0.068716147 -6.234031e-02 0.19892439
## sigma_sq   0.05490898 0.0004512223 0.019765362  2.856358e-02 0.09963885
## tau_sq     0.00908246 0.0001454411 0.006536201  7.628813e-05 0.02330783
## phi        3.53683130 0.0439541748 1.944669225  1.459591e+00 8.51153142
## y_pred[1] -0.27171824 0.0064573238 0.301755582 -8.662022e-01 0.32660398
## y_pred[2] -0.27014241 0.0062501053 0.298996379 -8.465919e-01 0.34943459
## y_pred[3] -0.27137893 0.0065656694 0.304186203 -8.428175e-01 0.36845440
## y_pred[4] -0.26958521 0.0066000702 0.301509144 -8.596208e-01 0.33281974
## y_pred[5] -0.26371260 0.0065379338 0.304303176 -8.687426e-01 0.37264053
##              n_eff      Rhat
## beta0     1891.731 1.0012130
## beta[1]   1641.477 1.0027991
## beta[2]   1970.305 1.0025511
## sigma_sq  1918.794 0.9998376
## tau_sq    2019.653 1.0003639
## phi       1957.452 1.0003897
## y_pred[1] 2183.763 1.0000693
## y_pred[2] 2288.533 0.9998625
## y_pred[3] 2146.451 0.9993365
## y_pred[4] 2086.911 0.9999384
## y_pred[5] 2166.366 1.0000249</code></pre>
</div>
</div>
<div id="extra-10.10-inla-creating-a-mesh" class="section level2 unnumbered hasAnchor">
<h2>Extra 10.10: INLA, creating a mesh<a href="hazards.html#extra-10.10-inla-creating-a-mesh" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This example uses the <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/voc/montreal_benzene_apr.csv">montreal_benzene_apr.csv</a></p>
<div class="sourceCode" id="cb350"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb350-1"><a href="hazards.html#cb350-1" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb350-2"><a href="hazards.html#cb350-2" tabindex="-1"></a><span class="fu">library</span>(INLA)</span>
<span id="cb350-3"><a href="hazards.html#cb350-3" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb350-4"><a href="hazards.html#cb350-4" tabindex="-1"></a></span>
<span id="cb350-5"><a href="hazards.html#cb350-5" tabindex="-1"></a>benzene_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/voc/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb350-6"><a href="hazards.html#cb350-6" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb350-7"><a href="hazards.html#cb350-7" tabindex="-1"></a>benzene_data_loc <span class="ot">&lt;-</span> benzene_data</span>
<span id="cb350-8"><a href="hazards.html#cb350-8" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_data_loc) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb350-9"><a href="hazards.html#cb350-9" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_data_loc) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb350-10"><a href="hazards.html#cb350-10" tabindex="-1"></a></span>
<span id="cb350-11"><a href="hazards.html#cb350-11" tabindex="-1"></a>benzene_data_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_data_loc,</span>
<span id="cb350-12"><a href="hazards.html#cb350-12" tabindex="-1"></a>                        <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb350-13"><a href="hazards.html#cb350-13" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb350-14"><a href="hazards.html#cb350-14" tabindex="-1"></a>locations_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_data_utm<span class="sc">@</span>coords)</span>
<span id="cb350-15"><a href="hazards.html#cb350-15" tabindex="-1"></a></span>
<span id="cb350-16"><a href="hazards.html#cb350-16" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(benzene_data),</span>
<span id="cb350-17"><a href="hazards.html#cb350-17" tabindex="-1"></a>                              <span class="at">X =</span> benzene_data_utm<span class="sc">@</span>coords[,<span class="dv">1</span>]<span class="sc">/</span><span class="dv">1000</span>,</span>
<span id="cb350-18"><a href="hazards.html#cb350-18" tabindex="-1"></a>                              <span class="at">Y =</span> benzene_data_utm<span class="sc">@</span>coords[,<span class="dv">2</span>]<span class="sc">/</span><span class="dv">1000</span>,</span>
<span id="cb350-19"><a href="hazards.html#cb350-19" tabindex="-1"></a>                              <span class="at">logbenzene =</span> <span class="fu">log</span>(benzene_data_utm<span class="sc">$</span>Benzene))</span>
<span id="cb350-20"><a href="hazards.html#cb350-20" tabindex="-1"></a>  </span>
<span id="cb350-21"><a href="hazards.html#cb350-21" tabindex="-1"></a><span class="co"># change the observed values to the log scale and the coordinates to km&#39;s</span></span>
<span id="cb350-22"><a href="hazards.html#cb350-22" tabindex="-1"></a></span>
<span id="cb350-23"><a href="hazards.html#cb350-23" tabindex="-1"></a>mesh <span class="ot">=</span> <span class="fu">inla.mesh.create</span>(locations_df, <span class="at">cutoff =</span> <span class="fl">0.01</span>, </span>
<span id="cb350-24"><a href="hazards.html#cb350-24" tabindex="-1"></a>                       <span class="at">refine =</span>(<span class="fu">list</span>(<span class="at">min.angle =</span><span class="dv">20</span>)))</span>
<span id="cb350-25"><a href="hazards.html#cb350-25" tabindex="-1"></a><span class="fu">plot</span>(mesh , <span class="at">col=</span><span class="st">&quot;gray&quot;</span>, <span class="at">main=</span><span class="st">&quot;&quot;</span>) </span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.11%20load%20data%20for%20INLA-1.png" width="672" /></p>
</div>
<div id="extra-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Extra 10.12: Fitting an SPDE model using R–INLA: benzene concentration in Montreal<a href="hazards.html#extra-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb351"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb351-1"><a href="hazards.html#cb351-1" tabindex="-1"></a><span class="co"># Field std . dev . for theta =0</span></span>
<span id="cb351-2"><a href="hazards.html#cb351-2" tabindex="-1"></a>sigma0 <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb351-3"><a href="hazards.html#cb351-3" tabindex="-1"></a><span class="co"># find the range of the location data</span></span>
<span id="cb351-4"><a href="hazards.html#cb351-4" tabindex="-1"></a>size <span class="ot">=</span> <span class="fu">min</span>(<span class="fu">c</span>(<span class="fu">diff</span>(<span class="fu">range</span>(mesh<span class="sc">$</span>loc[, <span class="dv">1</span>])),</span>
<span id="cb351-5"><a href="hazards.html#cb351-5" tabindex="-1"></a>             <span class="fu">diff</span> (<span class="fu">range</span>(mesh<span class="sc">$</span>loc[, <span class="dv">2</span>]))))</span>
<span id="cb351-6"><a href="hazards.html#cb351-6" tabindex="-1"></a><span class="co"># A fifth of the approximate domain width .</span></span>
<span id="cb351-7"><a href="hazards.html#cb351-7" tabindex="-1"></a>range0 <span class="ot">=</span> size<span class="sc">/</span><span class="dv">5</span></span>
<span id="cb351-8"><a href="hazards.html#cb351-8" tabindex="-1"></a>kappa0 <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="dv">8</span>)<span class="sc">/</span>range0</span>
<span id="cb351-9"><a href="hazards.html#cb351-9" tabindex="-1"></a>tau0 <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(<span class="fu">sqrt</span> (<span class="dv">4</span><span class="sc">*</span>pi)<span class="sc">*</span>kappa0<span class="sc">*</span>sigma0)</span>
<span id="cb351-10"><a href="hazards.html#cb351-10" tabindex="-1"></a>spde <span class="ot">=</span> <span class="fu">inla.spde2.matern</span> (</span>
<span id="cb351-11"><a href="hazards.html#cb351-11" tabindex="-1"></a>  mesh,</span>
<span id="cb351-12"><a href="hazards.html#cb351-12" tabindex="-1"></a>  <span class="at">B.tau =</span> <span class="fu">cbind</span>(<span class="fu">log</span> (tau0), <span class="sc">-</span><span class="dv">1</span>, <span class="sc">+</span><span class="dv">1</span>),</span>
<span id="cb351-13"><a href="hazards.html#cb351-13" tabindex="-1"></a>  <span class="at">B.kappa =</span> <span class="fu">cbind</span>(<span class="fu">log</span> (kappa0), <span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb351-14"><a href="hazards.html#cb351-14" tabindex="-1"></a>  <span class="at">theta.prior.mean =</span> <span class="fu">c</span>(<span class="dv">0</span> , <span class="dv">0</span>),</span>
<span id="cb351-15"><a href="hazards.html#cb351-15" tabindex="-1"></a>  <span class="at">constr =</span> <span class="cn">TRUE</span></span>
<span id="cb351-16"><a href="hazards.html#cb351-16" tabindex="-1"></a>)</span>
<span id="cb351-17"><a href="hazards.html#cb351-17" tabindex="-1"></a></span>
<span id="cb351-18"><a href="hazards.html#cb351-18" tabindex="-1"></a>formula <span class="ot">=</span> logbenzene  <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> X <span class="sc">+</span> Y <span class="sc">+</span> <span class="fu">f</span>(ID , <span class="at">model =</span> spde)</span>
<span id="cb351-19"><a href="hazards.html#cb351-19" tabindex="-1"></a>model <span class="ot">=</span> <span class="fu">inla</span>(</span>
<span id="cb351-20"><a href="hazards.html#cb351-20" tabindex="-1"></a>  formula,</span>
<span id="cb351-21"><a href="hazards.html#cb351-21" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb351-22"><a href="hazards.html#cb351-22" tabindex="-1"></a>  <span class="at">data =</span> benzene_utm_df ,</span>
<span id="cb351-23"><a href="hazards.html#cb351-23" tabindex="-1"></a>  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>),</span>
<span id="cb351-24"><a href="hazards.html#cb351-24" tabindex="-1"></a>  <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> <span class="cn">TRUE</span> , <span class="at">config =</span> <span class="cn">TRUE</span>)</span>
<span id="cb351-25"><a href="hazards.html#cb351-25" tabindex="-1"></a>)</span>
<span id="cb351-26"><a href="hazards.html#cb351-26" tabindex="-1"></a></span>
<span id="cb351-27"><a href="hazards.html#cb351-27" tabindex="-1"></a>model<span class="sc">$</span>summary.fixed</span></code></pre></div>
<pre><code>##                     mean           sd    0.025quant     0.5quant   0.975quant
## (Intercept)  8.263245418 118.01725386 -189.26676108 -5.472126510 298.73628481
## X            0.014532837   0.02130264   -0.02563712  0.013291090   0.06340346
## Y           -0.003363593   0.02371938   -0.06108402 -0.000648258   0.03642512
##                      mode          kld
## (Intercept) -20.057233541 5.350248e-05
## X             0.011915234 7.754876e-05
## Y             0.002407345 3.418529e-05</code></pre>
</div>
<div id="extra-10.13-directional-variograms" class="section level2 unnumbered hasAnchor">
<h2>Extra 10.13: Directional variograms<a href="hazards.html#extra-10.13-directional-variograms" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb353"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb353-1"><a href="hazards.html#cb353-1" tabindex="-1"></a><span class="do">### Compute and plot the directional variogram</span></span>
<span id="cb353-2"><a href="hazards.html#cb353-2" tabindex="-1"></a>CA.geo <span class="ot">&lt;-</span> <span class="fu">as.geodata</span>( benzene_utm_df , <span class="at">coords.col =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span> , <span class="at">data.col=</span><span class="dv">1</span>)</span>
<span id="cb353-3"><a href="hazards.html#cb353-3" tabindex="-1"></a>CA.vario4 <span class="ot">&lt;-</span> <span class="fu">variog4</span>(CA.geo )</span>
<span id="cb353-4"><a href="hazards.html#cb353-4" tabindex="-1"></a><span class="fu">plot</span>(CA.vario4)</span></code></pre></div>
<p><img src="_main_files/figure-html/Extra%2010.13%20directional%20variogram-1.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="Disease.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="Time.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/10-Chpt10.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
