<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 11 Modelling temporal data: time series analysis and forecasting | Spatio-Temporal Methods in Environmental Epidemiology with R. Second Edition</title>
  <meta name="description" content="Chapter 11 Modelling temporal data: time series analysis and forecasting | Spatio-Temporal Methods in Environmental Epidemiology with R. Second Edition" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 11 Modelling temporal data: time series analysis and forecasting | Spatio-Temporal Methods in Environmental Epidemiology with R. Second Edition" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/img/cover.jpg" />
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 11 Modelling temporal data: time series analysis and forecasting | Spatio-Temporal Methods in Environmental Epidemiology with R. Second Edition" />
  
  
  <meta name="twitter:image" content="/img/cover.jpg" />

<meta name="author" content="Gavin Shaddick, James V. Zidek, and Alexandra M. Schmidt" />


<meta name="date" content="2024-05-05" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<link rel="prev" href="hazards.html"/>
<link rel="next" href="exposure.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatio-temporal methods in environmental epidemiology</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="preface-to-second-edition.html"><a href="preface-to-second-edition.html"><i class="fa fa-check"></i>PREFACE TO SECOND EDITION</a></li>
<li class="chapter" data-level="1" data-path="why.html"><a href="why.html"><i class="fa fa-check"></i><b>1</b> An overview of spatio-temporal epidemiology and knowledge discovery?</a></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> An introduction to modelling health risks and impacts</a>
<ul>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.7-estimating-the-smr-using-a-poisson-glm"><i class="fa fa-check"></i>Example 2.7: Estimating the SMR using a Poisson GLM</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.8-estimating-the-smr-using-quasi-likelihood"><i class="fa fa-check"></i>Example 2.8: Estimating the SMR using quasi-likelihood</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.9-modelling-differences-in-smrs-in-relation-to-differences-in-exposures"><i class="fa fa-check"></i>Example 2.9: Modelling differences in SMRs in relation to differences in exposures</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.10-modelling-the-risks-associated-with-lagged-effects-of-air-pollution"><i class="fa fa-check"></i>Example 2.10: Modelling the risks associated with lagged effects of air pollution</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.10-estimating-the-odds-ratio-in-a-case-control-study-using-a-logistic-model"><i class="fa fa-check"></i>Example 2.10: Estimating the odds ratio in a case-control study using a logistic model</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.11-estimating-the-odds-ratio-of-asthma-associated-with-proximity-to-roads"><i class="fa fa-check"></i>Example 2.11: Estimating the odds ratio of asthma associated with proximity to roads</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="uncertainty.html"><a href="uncertainty.html"><i class="fa fa-check"></i><b>3</b> The importance of uncertainty: assessment and quantification</a>
<ul>
<li class="chapter" data-level="" data-path="uncertainty.html"><a href="uncertainty.html#supplementary-material"><i class="fa fa-check"></i>Supplementary Material</a>
<ul>
<li class="chapter" data-level="" data-path="uncertainty.html"><a href="uncertainty.html#more-on-qualitative-uncertainty"><i class="fa fa-check"></i>More on qualitative uncertainty</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>4</b> Extracting information from data</a>
<ul>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#getting-to-know-the-structure-of-dataframes"><i class="fa fa-check"></i>Getting to know the structure of dataframes</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#extracting-and-creating-variables"><i class="fa fa-check"></i>Extracting and creating variables</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#simple-manipulations-using-tidyverse"><i class="fa fa-check"></i>Simple manipulations using Tidyverse</a>
<ul>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#filter-rows-in-tidyverse"><i class="fa fa-check"></i>Filter rows in Tidyverse</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#sorting-rows-in-tidyverse"><i class="fa fa-check"></i>Sorting rows in Tidyverse</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#select-columns-in-tidyverse"><i class="fa fa-check"></i>Select columns in Tidyverse</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#adding-columns"><i class="fa fa-check"></i>Adding columns</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#pipes"><i class="fa fa-check"></i>Pipes</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#chaining-pipes"><i class="fa fa-check"></i>Chaining pipes</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#grouping-and-summarizing"><i class="fa fa-check"></i>Grouping and summarizing</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#summarize"><i class="fa fa-check"></i>Summarize</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#example-4.1-health-impacts-associated-with-outdoor-air-pollution"><i class="fa fa-check"></i>Example 4.1: Health impacts associated with outdoor air pollution</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#example-4.3.-mapping-cancer-incidence-in-southern-and-eastern-serbia"><i class="fa fa-check"></i>Example 4.3. Mapping cancer incidence in Southern and Eastern Serbia</a>
<ul>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#creating-maps-of-southern-and-eastern-serbia"><i class="fa fa-check"></i>Creating maps of Southern and Eastern Serbia</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#example-4.4-cancer-in-bor"><i class="fa fa-check"></i>Example 4.4 Cancer in Bor</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#calculating-smrs"><i class="fa fa-check"></i>Calculating SMRs</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="embracing.html"><a href="embracing.html"><i class="fa fa-check"></i><b>5</b> Embracing uncertainty: the Bayesian approach</a></li>
<li class="chapter" data-level="6" data-path="computation.html"><a href="computation.html"><i class="fa fa-check"></i><b>6</b> Approaches to Bayesian Computation</a>
<ul>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#example-6.2-gibbs-sampling-with-a-poisson-gamma-model---hospital-admissions-for-chronic-obstructive-pulmonary-disease-copd-for-england-between-2001-2010"><i class="fa fa-check"></i>Example 6.2: Gibbs sampling with a Poisson-Gamma model - hospital admissions for chronic obstructive pulmonary disease (COPD) for England between 2001-2010</a>
<ul>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#modelling-the-raw-standardized-mortality-rates-smrs"><i class="fa fa-check"></i>Modelling the raw standardized mortality rates (SMRs)</a></li>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#mcmc-implementation-of-the-poisson-gamma-model-in-r"><i class="fa fa-check"></i>MCMC implementation of the Poisson-Gamma model in <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#code-for-the-poisson-gamma-model-in-nimble"><i class="fa fa-check"></i>Code for the Poisson-Gamma model in Nimble</a></li>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#example-6.3-fitting-a-poisson-regression-model"><i class="fa fa-check"></i>Example 6.3: Fitting a Poisson regression model</a>
<ul>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#nimble"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#stan"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Strategies.html"><a href="Strategies.html"><i class="fa fa-check"></i><b>7</b> Strategies for modelling</a>
<ul>
<li class="chapter" data-level="" data-path="Strategies.html"><a href="Strategies.html#example-7.6-variable-selection-in-land-use-regression-using-lasso-and-horseshoe-priors"><i class="fa fa-check"></i>Example 7.6 Variable selection in land use regression using lasso and horseshoe priors</a>
<ul>
<li class="chapter" data-level="" data-path="Strategies.html"><a href="Strategies.html#nimble-1"><i class="fa fa-check"></i>Nimble</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="trusted.html"><a href="trusted.html"><i class="fa fa-check"></i><b>8</b> The challenges of working with real-world data</a>
<ul>
<li class="chapter" data-level="" data-path="trusted.html"><a href="trusted.html#solutions-to-selected-exercises"><i class="fa fa-check"></i>Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="trusted.html"><a href="trusted.html#placeholder-repeat-the-black-smoke-analysis-conducted-in-watson-et-al.-2019.-in-the-naive-model."><i class="fa fa-check"></i>PLACEHOLDER: Repeat the Black Smoke analysis conducted in Watson et al. 2019. in the “naive” model.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="Disease.html"><a href="Disease.html"><i class="fa fa-check"></i><b>9</b> Disease-spatial patterns</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010"><i class="fa fa-check"></i>Example 9.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010</a>
<ul>
<li class="chapter" data-level="9.0.1" data-path="Disease.html"><a href="Disease.html#empirical-bayes-estimate-using-spatialepi"><i class="fa fa-check"></i><b>9.0.1</b> Empirical Bayes estimate using <code>SpatialEpi</code></a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-2"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-1"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-rstan"><i class="fa fa-check"></i>Example 9.3: Fitting a conditional spatial model in <code>NIMBLE</code> and <code>RStan</code></a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-3"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-2"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.4-fitting-a-conditional-spatial-model-using-carbayes"><i class="fa fa-check"></i>Example 9.4: Fitting a conditional spatial model using CARBayes</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.5-fitting-a-conditional-model-using-inla"><i class="fa fa-check"></i>Example 9.5: Fitting a conditional model using INLA</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#supplementary-example-fitting-a-leroux-model-to-the-copd-dataset-using-nimble-stan-and-carbayes"><i class="fa fa-check"></i>Supplementary Example: Fitting a Leroux model to the COPD dataset using Nimble, Stan and CARBayes</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="hazards.html"><a href="hazards.html"><i class="fa fa-check"></i><b>10</b> Environmental hazards-spatial models</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.1-spatial-patterns-in-lead-concentrations-in-the-soil-of-the-meuse-river-flood-plain"><i class="fa fa-check"></i>Example 10.1 Spatial patterns in lead concentrations in the soil of the Meuse River flood plain</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.2-examining-the-log-concentrations-of-lead-in-the-meuse-river-flood-plain"><i class="fa fa-check"></i>Example 10.2: Examining the log concentrations of lead in the Meuse River flood plain</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state"><i class="fa fa-check"></i>Example 10.3: Mapping the locations of ozone monitoring sites in New York State</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.5-spatial-prediction-of-temperatures-in-california"><i class="fa fa-check"></i>Example 10.5: Spatial prediction of temperatures in California</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.6-fitting-a-bayesian-exponential-spatial-model-using-nimble"><i class="fa fa-check"></i>Example 10.6 Fitting a Bayesian exponential spatial model using NIMBLE</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.7-spatial-prediction-of-pm_2.5-in-europe"><i class="fa fa-check"></i>Example 10.7 Spatial prediction of <span class="math inline">\(PM_{2.5}\)</span> in Europe</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.10-creating-a-mesh-black-smoke-monitoring-locations-in-the-uk"><i class="fa fa-check"></i>Example 10.10 Creating a mesh: black smoke monitoring locations in the UK</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.12-plotting-directional-variograms-for-temperatures-in-california"><i class="fa fa-check"></i>Example 10.12 Plotting directional variograms for temperatures in California</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.14-spatial-modeling-of-malaria-in-gambia"><i class="fa fa-check"></i>Example 10.14: Spatial modeling of malaria in Gambia</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-4"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-3"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#supplementary-material-1"><i class="fa fa-check"></i>Supplementary Material</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-analysis-of-benzene-concentrations-across-montreal-qc-canada"><i class="fa fa-check"></i>Example: Analysis of benzene concentrations across Montreal, QC, Canada</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.2-examining-the-log-concentrations-of-benzene-in-montreal"><i class="fa fa-check"></i>Extra 10.2: Examining the log concentrations of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.5-variogram"><i class="fa fa-check"></i>Extra 10.5: Variogram</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal"><i class="fa fa-check"></i>Extra 10.6 Basic spatial modelling and prediction of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.8-spatial-modelling-of-benzene-in-montreal"><i class="fa fa-check"></i>Extra 10.8 Spatial modelling of Benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.9-spatial-predictions"><i class="fa fa-check"></i>Extra 10.9: Spatial predictions</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.10-inla-creating-a-mesh"><i class="fa fa-check"></i>Extra 10.10: INLA, creating a mesh</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal"><i class="fa fa-check"></i>Extra 10.12: Fitting an SPDE model using R–INLA: benzene concentration in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.13-directional-variograms"><i class="fa fa-check"></i>Extra 10.13: Directional variograms</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="Time.html"><a href="Time.html"><i class="fa fa-check"></i><b>11</b> Modelling temporal data: time series analysis and forecasting</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.1-ground-level-ozone-concentrations"><i class="fa fa-check"></i>Example 11.1 Ground level ozone concentrations</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.2-low-pass-filtering-of-ozone-levels-using-the-moving-average"><i class="fa fa-check"></i>Example 11.2 Low-pass filtering of ozone levels using the moving average</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.12-forecasting-ozone-levels"><i class="fa fa-check"></i>Example 11.12 Forecasting ozone levels</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.13-forecasting-volcanic-ash"><i class="fa fa-check"></i>Example 11.13 Forecasting volcanic ash</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.17-implementation-of-a-dynamic-linear-model-uk-ozone-data"><i class="fa fa-check"></i>Example 11.17 Implementation of a dynamic linear model: UK ozone data</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#nimble-7"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#stan-6"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="11.1" data-path="Time.html"><a href="Time.html#example-11.18-dynamic-glms-for-daily-counts-of-carbon-monoxide-on-counts-of-infant-deaths-in-são-paulo-brazil"><i class="fa fa-check"></i><b>11.1</b> Example 11.18 Dynamic GLMs for daily counts of carbon monoxide on counts of infant deaths in São Paulo, Brazil</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#solutions-to-selected-exercises-1"><i class="fa fa-check"></i>Solutions to Selected Exercises</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#exercise-11.11"><i class="fa fa-check"></i>Exercise 11.11</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#exercise-11.13"><i class="fa fa-check"></i>Exercise 11.13</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="exposure.html"><a href="exposure.html"><i class="fa fa-check"></i><b>12</b> Exposure assessment-over space and time</a>
<ul>
<li class="chapter" data-level="" data-path="exposure.html"><a href="exposure.html#example-idk-spatio-temporal-model-for-the-uk-ozone-data"><i class="fa fa-check"></i>Example IDK: Spatio-temporal model for the UK ozone data</a>
<ul>
<li class="chapter" data-level="" data-path="exposure.html"><a href="exposure.html#nimble-8"><i class="fa fa-check"></i>Nimble</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="causality.html"><a href="causality.html"><i class="fa fa-check"></i><b>13</b> Causality-roadblocks on the way to it</a>
<ul>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#solutions-to-selected-exercises-2"><i class="fa fa-check"></i>Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.16-load-the-italy-and-china-data-described-in-example-13.3-and-included-in-the-supplementary-bookdown-material-into-r."><i class="fa fa-check"></i>Question 13.16: Load the Italy and China data, described in Example 13.3, and included in the supplementary Bookdown material into R.</a></li>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.17-using-the-italy-and-china-data-stratified-by-the-age-groups-70-and-geq-70-obtain-empirical-estimates-of-p_1-and-p_2-as-defined-in-an-sdis.-in-the-following-questions-assume-that-p_1-and-p_2-are-the-population-values."><i class="fa fa-check"></i>Question 13.17: Using the Italy and China data stratified by the age groups <span class="math inline">\(&lt;70\)</span> and <span class="math inline">\(\geq 70\)</span>, obtain empirical estimates of <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span>, as defined in an SDis. In the following questions, assume that <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> are the population values.</a></li>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.18-stratify-the-italy-and-china-data-by-the-age-groups-50-and-geq-50.-display-the-corresponding-contingency-tables."><i class="fa fa-check"></i>Question 13.18: Stratify the Italy and China data by the age groups <span class="math inline">\(&lt;50\)</span> and <span class="math inline">\(\geq 50\)</span>. Display the corresponding contingency tables.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="monitoring.html"><a href="monitoring.html"><i class="fa fa-check"></i><b>14</b> Better monitoring network design-getting better measurements</a></li>
<li class="chapter" data-level="15" data-path="frontiers.html"><a href="frontiers.html"><i class="fa fa-check"></i><b>15</b> Current frontiers</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html"><i class="fa fa-check"></i>Course</a>
<ul>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#course-description-spatio-temporal-methods-in-environmental-epidemiology"><i class="fa fa-check"></i>Course description: Spatio-temporal methods in environmental epidemiology</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#course-lectures"><i class="fa fa-check"></i>Course lectures</a>
<ul>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lecture-1-introduction"><i class="fa fa-check"></i>Lecture 1: Introduction</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lecture-2-spatial-epidemiology"><i class="fa fa-check"></i>Lecture 2: Spatial Epidemiology</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lectures-3-and-4-disease-mapping"><i class="fa fa-check"></i>Lectures 3 and 4: Disease Mapping</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lectures-5-and-6-diseases-spatial-patterns"><i class="fa fa-check"></i>Lectures 5 and 6: Diseases spatial-patterns</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lectures-7-and-8-spatial-models"><i class="fa fa-check"></i>Lectures 7 and 8: Spatial models</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lectures-9-and-11-spatio-and-temporal-processes"><i class="fa fa-check"></i>Lectures 9 and 11: Spatio and temporal processes</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lecture-12-spatio-temporal-processes"><i class="fa fa-check"></i>Lecture 12: Spatio-temporal processes</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lectures-13-and-14-spatio-temporal-processes-cont."><i class="fa fa-check"></i>Lectures 13 and 14: Spatio-temporal processes cont.</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lecture-15-introduction-to-bayesian-analysis-and-winbugs"><i class="fa fa-check"></i>Lecture 15: Introduction to Bayesian Analysis and WinBUGS</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lecture-16-bayesian-methods"><i class="fa fa-check"></i>Lecture 16: Bayesian Methods</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lecture-17-why-is-computation-important"><i class="fa fa-check"></i>Lecture 17: Why is computation important?</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lecture-18-generalised-linear-regression-models"><i class="fa fa-check"></i>Lecture 18: Generalised Linear regression Models</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lecture-19-time-series-epidemiology"><i class="fa fa-check"></i>Lecture 19: Time series epidemiology</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lecture-20-spatio-temporal-modelling-of-exposures"><i class="fa fa-check"></i>Lecture 20: Spatio-temporal modelling of exposures</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lecture-21-environmental-health-risk-assessment"><i class="fa fa-check"></i>Lecture 21: Environmental health risk assessment</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lecture-22-measurement-error"><i class="fa fa-check"></i>Lecture 22: Measurement error</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lecture-23-designing-good-monitoring-networks"><i class="fa fa-check"></i>Lecture 23: Designing good monitoring networks</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html#lecture-24-dealing-with-high-dimensional-data"><i class="fa fa-check"></i>Lecture 24: Dealing with high dimensional data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="suggested-projects.html"><a href="suggested-projects.html"><i class="fa fa-check"></i>Suggested projects</a>
<ul>
<li class="chapter" data-level="" data-path="suggested-projects.html"><a href="suggested-projects.html#project-1"><i class="fa fa-check"></i>Project 1</a>
<ul>
<li class="chapter" data-level="" data-path="suggested-projects.html"><a href="suggested-projects.html#introduction-1"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="suggested-projects.html"><a href="suggested-projects.html#the-problem"><i class="fa fa-check"></i>The Problem</a></li>
<li class="chapter" data-level="" data-path="suggested-projects.html"><a href="suggested-projects.html#solution"><i class="fa fa-check"></i>Solution</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="suggested-projects.html"><a href="suggested-projects.html#project-2"><i class="fa fa-check"></i>Project 2</a>
<ul>
<li class="chapter" data-level="" data-path="suggested-projects.html"><a href="suggested-projects.html#introduction-2"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="suggested-projects.html"><a href="suggested-projects.html#the-problem-1"><i class="fa fa-check"></i>The Problem</a></li>
<li class="chapter" data-level="" data-path="suggested-projects.html"><a href="suggested-projects.html#solution-1"><i class="fa fa-check"></i>Solution</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatio-Temporal Methods in Environmental Epidemiology with R. Second Edition</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="Time" class="section level1 hasAnchor" number="11">
<h1><span class="header-section-number">Chapter 11</span> Modelling temporal data: time series analysis and forecasting<a href="Time.html#Time" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The chapter contains the theory required for handling time series data. The reader will have gained an understanding of the following topics:</p>
<ul>
<li>that a temporal process consists of both low and high frequency components, the former playing a key role in determining long-term trends while the latter may be associated with shorter-term changes;</li>
<li>techniques for the exploratory analysis of the data generated by the temporal process, including the ACF (correlogram) and PACF (periodogram);</li>
<li>models for irregular (high frequency) components after the regular components (trend) have been removed;</li>
<li>methods for forecasting, including exponential smoothing and ARIMA modelling;</li>
<li>state space modelling approach, which sits naturally within a Bayesian setting and provides a general framework within which a wide class of models, including many classical time series models, can be expressed.</li>
</ul>
<div id="example-11.1-ground-level-ozone-concentrations" class="section level2 unnumbered hasAnchor">
<h2>Example 11.1 Ground level ozone concentrations<a href="Time.html#example-11.1-ground-level-ozone-concentrations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Ozone is a colorless gas produced through a combination of photochemistry, sunlight, high temperatures, oxides of nitrogen, NO<span class="math inline">\(_x\)</span>,<br />
emitted by motor vehicles. Levels are especially high during morning and evening commute hours
in urban areas. It is one of the criteria pollutants regulated by the US Clean Air Act (1970)
because of a substantial body of literature that shows a strong association with human morbidity, notably respiratory diseases such as
asthma, emphysema, and chronic obstructive pulmonary disorder (COPD) (EPA, 2005). Periods of high ozone concentrations can lead to acute asthma attacks leading to increased numbers of deaths, hospital admissions, and school absences. High levels of ozone concentrations can also lead to reduced
lung capacity.</p>
<p>Let’s start by loading the daily and hourly data for one site.</p>
<div class="sourceCode" id="cb464"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb464-1"><a href="Time.html#cb464-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb464-2"><a href="Time.html#cb464-2" tabindex="-1"></a></span>
<span id="cb464-3"><a href="Time.html#cb464-3" tabindex="-1"></a><span class="co"># Load data for one site</span></span>
<span id="cb464-4"><a href="Time.html#cb464-4" tabindex="-1"></a>site_daily <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/ozone/LA_ozone_daily.csv&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb464-5"><a href="Time.html#cb464-5" tabindex="-1"></a></span>
<span id="cb464-6"><a href="Time.html#cb464-6" tabindex="-1"></a><span class="co"># change the format of the date column</span></span>
<span id="cb464-7"><a href="Time.html#cb464-7" tabindex="-1"></a>site_daily<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(site_daily<span class="sc">$</span>date, <span class="st">&quot;%m/%d/%Y&quot;</span>)</span>
<span id="cb464-8"><a href="Time.html#cb464-8" tabindex="-1"></a></span>
<span id="cb464-9"><a href="Time.html#cb464-9" tabindex="-1"></a><span class="co"># load hourly data from that same site</span></span>
<span id="cb464-10"><a href="Time.html#cb464-10" tabindex="-1"></a>site_hourly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/ozone/LA_ozone_hourly.csv&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>The following plot shows daily concentrations
of ozone measured at sites located in the geographical region of Los Angeles, California.
Clear seasonal patterns can be observed due to the higher temperatures in summer.</p>
<div class="sourceCode" id="cb465"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb465-1"><a href="Time.html#cb465-1" tabindex="-1"></a><span class="co"># Plot daily data</span></span>
<span id="cb465-2"><a href="Time.html#cb465-2" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> site_daily) <span class="sc">+</span></span>
<span id="cb465-3"><a href="Time.html#cb465-3" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> max.ozone, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb465-4"><a href="Time.html#cb465-4" tabindex="-1"></a>  <span class="co"># draw a line at the first data</span></span>
<span id="cb465-5"><a href="Time.html#cb465-5" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.Date</span>(<span class="st">&quot;2013-01-01&quot;</span>), <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb465-6"><a href="Time.html#cb465-6" tabindex="-1"></a>  <span class="co"># 8 hour regulatory standard of 0.075 (ppm)</span></span>
<span id="cb465-7"><a href="Time.html#cb465-7" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.075</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb465-8"><a href="Time.html#cb465-8" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Day in 2013 at Los Angeles Site 060379033&quot;</span>) <span class="sc">+</span></span>
<span id="cb465-9"><a href="Time.html#cb465-9" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Max Daily 8hr Ozone Level (ppm)&quot;</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.1a%20plot%20time%20series-1.png" width="672" /></p>
<p>And the next plot depicts the same series
at the hourly level, but restricted to the so-called `ozone season’, which is taken to be May 1 – Sep 30. Here a clear 24-hour daily cycle can be seen
along with a period of missing data. The latter
is likely due to the monitoring systems being checked each night by the injection of a calibrated sample of air. If the instrument reports the ozone incorrectly, an alert is sounded and that instrument
is taken off-line until it is repaired. This can lead to gaps in the series, as seen around hour 1100.</p>
<div class="sourceCode" id="cb466"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb466-1"><a href="Time.html#cb466-1" tabindex="-1"></a><span class="co"># Plot hourly data</span></span>
<span id="cb466-2"><a href="Time.html#cb466-2" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> site_hourly,) <span class="sc">+</span></span>
<span id="cb466-3"><a href="Time.html#cb466-3" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> ozone, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb466-4"><a href="Time.html#cb466-4" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb466-5"><a href="Time.html#cb466-5" tabindex="-1"></a>   <span class="co"># 8 hour regulatory standard of 0.075 (ppm).</span></span>
<span id="cb466-6"><a href="Time.html#cb466-6" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.075</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb466-7"><a href="Time.html#cb466-7" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Hour in 2013&#39;s ozone season&quot;</span>) <span class="sc">+</span></span>
<span id="cb466-8"><a href="Time.html#cb466-8" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Hourly Ozone Concentration (ppm)&quot;</span>) <span class="sc">+</span>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.1b%20plot%20time%20series-1.png" width="672" /></p>
</div>
<div id="example-11.2-low-pass-filtering-of-ozone-levels-using-the-moving-average" class="section level2 unnumbered hasAnchor">
<h2>Example 11.2 Low-pass filtering of ozone levels using the moving average<a href="Time.html#example-11.2-low-pass-filtering-of-ozone-levels-using-the-moving-average" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We use the Ozone data of example 11.1 to look at moving averages of daily as done for carbon monoxide in example 11.3 discussed in the book.</p>
<p>For this example we will use the TTR package (Technical Trading Rules). This allow us to manipulate objects like time series for forecasting.</p>
<div class="sourceCode" id="cb467"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb467-1"><a href="Time.html#cb467-1" tabindex="-1"></a><span class="fu">library</span>(TTR)</span>
<span id="cb467-2"><a href="Time.html#cb467-2" tabindex="-1"></a><span class="co"># Load daily data</span></span>
<span id="cb467-3"><a href="Time.html#cb467-3" tabindex="-1"></a>site_daily <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/ozone/LA_ozone_daily.csv&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb467-4"><a href="Time.html#cb467-4" tabindex="-1"></a><span class="co"># add an identifier column for each day in the sample</span></span>
<span id="cb467-5"><a href="Time.html#cb467-5" tabindex="-1"></a>site_daily<span class="sc">$</span>day <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily)</span></code></pre></div>
<div class="sourceCode" id="cb468"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb468-1"><a href="Time.html#cb468-1" tabindex="-1"></a><span class="co"># Add loess smooth</span></span>
<span id="cb468-2"><a href="Time.html#cb468-2" tabindex="-1"></a><span class="co"># Single day moving average</span></span>
<span id="cb468-3"><a href="Time.html#cb468-3" tabindex="-1"></a>ozone.loess <span class="ot">&lt;-</span> <span class="fu">loess</span>(max.ozone <span class="sc">~</span> day, <span class="at">span =</span> <span class="fl">0.75</span>, <span class="at">data =</span> site_daily[,<span class="fu">c</span>(<span class="st">&quot;max.ozone&quot;</span>, <span class="st">&quot;day&quot;</span>)])</span>
<span id="cb468-4"><a href="Time.html#cb468-4" tabindex="-1"></a>ozone.predict <span class="ot">&lt;-</span> <span class="fu">predict</span>(ozone.loess, <span class="fu">data.frame</span>(<span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily)))</span>
<span id="cb468-5"><a href="Time.html#cb468-5" tabindex="-1"></a>ozone.predict_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily),</span>
<span id="cb468-6"><a href="Time.html#cb468-6" tabindex="-1"></a>                               <span class="at">ozone.prediction =</span> ozone.predict)</span>
<span id="cb468-7"><a href="Time.html#cb468-7" tabindex="-1"></a></span>
<span id="cb468-8"><a href="Time.html#cb468-8" tabindex="-1"></a>plot_SMA1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> site_daily) <span class="sc">+</span></span>
<span id="cb468-9"><a href="Time.html#cb468-9" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> max.ozone, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb468-10"><a href="Time.html#cb468-10" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> ozone.predict_df, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> ozone.predict)) <span class="sc">+</span></span>
<span id="cb468-11"><a href="Time.html#cb468-11" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Day in 2013 at LA Site 060379033&quot;</span>) <span class="sc">+</span></span>
<span id="cb468-12"><a href="Time.html#cb468-12" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb468-13"><a href="Time.html#cb468-13" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Single day&quot;</span>) <span class="sc">+</span></span>
<span id="cb468-14"><a href="Time.html#cb468-14" tabindex="-1"></a> <span class="fu">theme_classic</span>()</span>
<span id="cb468-15"><a href="Time.html#cb468-15" tabindex="-1"></a><span class="co"># Three day moving average</span></span>
<span id="cb468-16"><a href="Time.html#cb468-16" tabindex="-1"></a>ozone_SMA3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sma =</span> <span class="fu">SMA</span>(site_daily<span class="sc">$</span>max.ozone, <span class="at">n =</span> <span class="dv">3</span>),</span>
<span id="cb468-17"><a href="Time.html#cb468-17" tabindex="-1"></a>                         <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily))</span>
<span id="cb468-18"><a href="Time.html#cb468-18" tabindex="-1"></a></span>
<span id="cb468-19"><a href="Time.html#cb468-19" tabindex="-1"></a>plot_SMA3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> ozone_SMA3) <span class="sc">+</span></span>
<span id="cb468-20"><a href="Time.html#cb468-20" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sma, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb468-21"><a href="Time.html#cb468-21" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> ozone.predict_df, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> ozone.predict)) <span class="sc">+</span></span>
<span id="cb468-22"><a href="Time.html#cb468-22" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Day in 2013 at LA Site 060379033&quot;</span>) <span class="sc">+</span></span>
<span id="cb468-23"><a href="Time.html#cb468-23" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb468-24"><a href="Time.html#cb468-24" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Three days&quot;</span>) <span class="sc">+</span></span>
<span id="cb468-25"><a href="Time.html#cb468-25" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb468-26"><a href="Time.html#cb468-26" tabindex="-1"></a></span>
<span id="cb468-27"><a href="Time.html#cb468-27" tabindex="-1"></a></span>
<span id="cb468-28"><a href="Time.html#cb468-28" tabindex="-1"></a><span class="co"># Six day moving average</span></span>
<span id="cb468-29"><a href="Time.html#cb468-29" tabindex="-1"></a>ozone_SMA6 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sma =</span> <span class="fu">SMA</span>(site_daily<span class="sc">$</span>max.ozone, <span class="at">n =</span> <span class="dv">6</span>),</span>
<span id="cb468-30"><a href="Time.html#cb468-30" tabindex="-1"></a>                         <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily))</span>
<span id="cb468-31"><a href="Time.html#cb468-31" tabindex="-1"></a></span>
<span id="cb468-32"><a href="Time.html#cb468-32" tabindex="-1"></a>plot_SMA6 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> ozone_SMA6) <span class="sc">+</span></span>
<span id="cb468-33"><a href="Time.html#cb468-33" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sma, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb468-34"><a href="Time.html#cb468-34" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> ozone.predict_df, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> ozone.predict)) <span class="sc">+</span></span>
<span id="cb468-35"><a href="Time.html#cb468-35" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Day in 2013 at LA Site 060379033&quot;</span>) <span class="sc">+</span></span>
<span id="cb468-36"><a href="Time.html#cb468-36" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb468-37"><a href="Time.html#cb468-37" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Six days&quot;</span>) <span class="sc">+</span></span>
<span id="cb468-38"><a href="Time.html#cb468-38" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb468-39"><a href="Time.html#cb468-39" tabindex="-1"></a></span>
<span id="cb468-40"><a href="Time.html#cb468-40" tabindex="-1"></a></span>
<span id="cb468-41"><a href="Time.html#cb468-41" tabindex="-1"></a><span class="co"># Twelve day moving average</span></span>
<span id="cb468-42"><a href="Time.html#cb468-42" tabindex="-1"></a>ozone_SMA12 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sma =</span> <span class="fu">SMA</span>(site_daily<span class="sc">$</span>max.ozone, <span class="at">n =</span> <span class="dv">12</span>),</span>
<span id="cb468-43"><a href="Time.html#cb468-43" tabindex="-1"></a>                         <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily))</span>
<span id="cb468-44"><a href="Time.html#cb468-44" tabindex="-1"></a></span>
<span id="cb468-45"><a href="Time.html#cb468-45" tabindex="-1"></a>plot_SMA12 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> ozone_SMA12) <span class="sc">+</span></span>
<span id="cb468-46"><a href="Time.html#cb468-46" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sma, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb468-47"><a href="Time.html#cb468-47" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> ozone.predict_df, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> ozone.predict)) <span class="sc">+</span></span>
<span id="cb468-48"><a href="Time.html#cb468-48" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Day in 2013 at LA Site 060379033&quot;</span>) <span class="sc">+</span></span>
<span id="cb468-49"><a href="Time.html#cb468-49" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb468-50"><a href="Time.html#cb468-50" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Twelve days&quot;</span>) <span class="sc">+</span></span>
<span id="cb468-51"><a href="Time.html#cb468-51" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb468-52"><a href="Time.html#cb468-52" tabindex="-1"></a></span>
<span id="cb468-53"><a href="Time.html#cb468-53" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(plot_SMA1, plot_SMA3, plot_SMA6, plot_SMA12, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.2%20moving%20averages%20plot-1.png" width="672" /></p>
</div>
<div id="example-11.12-forecasting-ozone-levels" class="section level2 unnumbered hasAnchor">
<h2>Example 11.12 Forecasting ozone levels<a href="Time.html#example-11.12-forecasting-ozone-levels" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We return to Example 11.1 with the objective of forecasting ozone concentrations for the next twenty-four hours. These forecasts are based
on measured concentrations in Los Angeles from the first week of July 2013. We first fit the Holt – Winters model and see the results in the first panel of the next Figure. The plot that follows shows the twenty-four-hour ahead forecast on day eight.\</p>
<div class="sourceCode" id="cb469"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb469-1"><a href="Time.html#cb469-1" tabindex="-1"></a><span class="fu">library</span>(TTR)</span>
<span id="cb469-2"><a href="Time.html#cb469-2" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb469-3"><a href="Time.html#cb469-3" tabindex="-1"></a><span class="co"># Load hourly data for site 060379033</span></span>
<span id="cb469-4"><a href="Time.html#cb469-4" tabindex="-1"></a>site_hourly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/ozone/LA_ozone_hourly.csv&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb469-5"><a href="Time.html#cb469-5" tabindex="-1"></a><span class="co"># one night hour per day missing for instrument calibration - imputed for simplicity</span></span>
<span id="cb469-6"><a href="Time.html#cb469-6" tabindex="-1"></a>imputeNA <span class="ot">&lt;-</span> <span class="fu">mean</span>(site_hourly<span class="sc">$</span>ozone, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb469-7"><a href="Time.html#cb469-7" tabindex="-1"></a>site_hourly<span class="sc">$</span>ozone[<span class="fu">is.na</span>(site_hourly<span class="sc">$</span>ozone)] <span class="ot">&lt;-</span> imputeNA</span></code></pre></div>
<div class="sourceCode" id="cb470"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb470-1"><a href="Time.html#cb470-1" tabindex="-1"></a><span class="co"># Select the first seven days in july</span></span>
<span id="cb470-2"><a href="Time.html#cb470-2" tabindex="-1"></a><span class="co"># days_pattern contains the dates for the first seven days</span></span>
<span id="cb470-3"><a href="Time.html#cb470-3" tabindex="-1"></a>days_pattern <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;^2013070&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">collapse=</span><span class="st">&quot;|&quot;</span>)</span>
<span id="cb470-4"><a href="Time.html#cb470-4" tabindex="-1"></a></span>
<span id="cb470-5"><a href="Time.html#cb470-5" tabindex="-1"></a><span class="co"># select all the rows that follow that pattern using grepl</span></span>
<span id="cb470-6"><a href="Time.html#cb470-6" tabindex="-1"></a>july_seven_days <span class="ot">&lt;-</span> site_hourly[<span class="fu">grepl</span>(days_pattern, site_hourly<span class="sc">$</span>datetime),]</span>
<span id="cb470-7"><a href="Time.html#cb470-7" tabindex="-1"></a>july_seven_days<span class="sc">$</span>hours <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(july_seven_days)</span>
<span id="cb470-8"><a href="Time.html#cb470-8" tabindex="-1"></a></span>
<span id="cb470-9"><a href="Time.html#cb470-9" tabindex="-1"></a><span class="co"># Holt-Winters model fitting</span></span>
<span id="cb470-10"><a href="Time.html#cb470-10" tabindex="-1"></a><span class="co"># Turn this into a time series object to use Holt-Winters forecast</span></span>
<span id="cb470-11"><a href="Time.html#cb470-11" tabindex="-1"></a>level_ts <span class="ot">&lt;-</span> <span class="fu">ts</span>(july_seven_days<span class="sc">$</span>ozone,</span>
<span id="cb470-12"><a href="Time.html#cb470-12" tabindex="-1"></a>               <span class="at">frequency =</span> <span class="dv">24</span>,</span>
<span id="cb470-13"><a href="Time.html#cb470-13" tabindex="-1"></a>               <span class="at">start =</span> <span class="fu">c</span>(<span class="dv">1</span>))</span>
<span id="cb470-14"><a href="Time.html#cb470-14" tabindex="-1"></a>ozone_forecast <span class="ot">&lt;-</span> <span class="fu">HoltWinters</span>(level_ts)</span>
<span id="cb470-15"><a href="Time.html#cb470-15" tabindex="-1"></a></span>
<span id="cb470-16"><a href="Time.html#cb470-16" tabindex="-1"></a><span class="co"># Plot using the default function</span></span>
<span id="cb470-17"><a href="Time.html#cb470-17" tabindex="-1"></a><span class="fu">plot</span>(ozone_forecast,</span>
<span id="cb470-18"><a href="Time.html#cb470-18" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Hours - First Week -July 2013&quot;</span>,</span>
<span id="cb470-19"><a href="Time.html#cb470-19" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;O3 (ppm)&quot;</span>,</span>
<span id="cb470-20"><a href="Time.html#cb470-20" tabindex="-1"></a>  <span class="at">col.predicted =</span> <span class="dv">1</span>,</span>
<span id="cb470-21"><a href="Time.html#cb470-21" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb470-22"><a href="Time.html#cb470-22" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb470-23"><a href="Time.html#cb470-23" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb470-24"><a href="Time.html#cb470-24" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.13%20data%20munge-1.png" width="672" /></p>
<div class="sourceCode" id="cb471"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb471-1"><a href="Time.html#cb471-1" tabindex="-1"></a><span class="co"># Holt- Winters 24 ahead forast on Day 8</span></span>
<span id="cb471-2"><a href="Time.html#cb471-2" tabindex="-1"></a><span class="co"># no need to specify Holt-Winters forecast as the object is already HoltWinters class</span></span>
<span id="cb471-3"><a href="Time.html#cb471-3" tabindex="-1"></a>ozoneforecast_day8 <span class="ot">&lt;-</span> <span class="fu">forecast</span>(ozone_forecast, <span class="at">h=</span><span class="dv">24</span>)</span>
<span id="cb471-4"><a href="Time.html#cb471-4" tabindex="-1"></a></span>
<span id="cb471-5"><a href="Time.html#cb471-5" tabindex="-1"></a><span class="co"># Plot using default function</span></span>
<span id="cb471-6"><a href="Time.html#cb471-6" tabindex="-1"></a><span class="fu">plot</span>(ozoneforecast_day8, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.13%20data%20munge-2.png" width="672" /></p>
</div>
<div id="example-11.13-forecasting-volcanic-ash" class="section level2 unnumbered hasAnchor">
<h2>Example 11.13 Forecasting volcanic ash<a href="Time.html#example-11.13-forecasting-volcanic-ash" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Volcanic ash is not a substance that is commonly encountered in
environmental epidemiology, however it can be widely distributed by winds
and it can be a significant health hazard. A study<br />
of the Mount St. Helens volcanic eruption in May and June 1980 reports thirty-five deaths due to the
initial blast and landslide. Others are reported to have died from asphyxiation from
ash inhalation (Baxter et al., 1981). The respirable portion of the ash was found to contain a small percentage of crystalline free silica, a potential pneumoconiosis hazard, and a number of acute health effects were found in those visiting emergency rooms including asthma, bronchitis
and ash-related eye problems.</p>
<p>The data in this example consists of atmospheric levels of volcanic ash from 1500AD to 2000AD.</p>
<div class="sourceCode" id="cb472"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb472-1"><a href="Time.html#cb472-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb472-2"><a href="Time.html#cb472-2" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb472-3"><a href="Time.html#cb472-3" tabindex="-1"></a><span class="fu">library</span>(TTR)</span>
<span id="cb472-4"><a href="Time.html#cb472-4" tabindex="-1"></a></span>
<span id="cb472-5"><a href="Time.html#cb472-5" tabindex="-1"></a><span class="co"># Load volcano dust data</span></span>
<span id="cb472-6"><a href="Time.html#cb472-6" tabindex="-1"></a><span class="do">## REVIEW: Data source: Hyndman, R.J.  Time Series Data Library, http://data.is/TSDLdemo</span></span>
<span id="cb472-7"><a href="Time.html#cb472-7" tabindex="-1"></a><span class="co"># Data cover the period from 1500AD to 2000AD</span></span>
<span id="cb472-8"><a href="Time.html#cb472-8" tabindex="-1"></a>volcano_dust <span class="ot">&lt;-</span></span>
<span id="cb472-9"><a href="Time.html#cb472-9" tabindex="-1"></a>  <span class="fu">scan</span>(<span class="st">&quot;https://robjhyndman.com/tsdldata/annual/dvi.dat&quot;</span>, <span class="at">skip =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>The following figure shows the plot of the original time series.</p>
<div class="sourceCode" id="cb473"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb473-1"><a href="Time.html#cb473-1" tabindex="-1"></a><span class="co"># Turn data into data frame to plot it in ggplot</span></span>
<span id="cb473-2"><a href="Time.html#cb473-2" tabindex="-1"></a>volcano_dust_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">year =</span> <span class="dv">1500</span><span class="sc">:</span>(<span class="dv">1500</span><span class="sc">+</span><span class="fu">length</span>(volcano_dust)<span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb473-3"><a href="Time.html#cb473-3" tabindex="-1"></a>                              <span class="at">dust =</span> volcano_dust)</span>
<span id="cb473-4"><a href="Time.html#cb473-4" tabindex="-1"></a></span>
<span id="cb473-5"><a href="Time.html#cb473-5" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> volcano_dust_df) <span class="sc">+</span></span>
<span id="cb473-6"><a href="Time.html#cb473-6" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> dust, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb473-7"><a href="Time.html#cb473-7" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Year&quot;</span>) <span class="sc">+</span></span>
<span id="cb473-8"><a href="Time.html#cb473-8" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Atmospheric levels of volcanic ash&quot;</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.14%20plot%20time%20series%20ACF%20and%20PACF-1.png" width="672" /></p>
<p>From the plot of the time series a complex pattern can be seen which is the result of eruptions occurring at random times. The large spikes suggest the possibility of moving average components, this is a way that the ARMA process has of incorporating
shocks that abate over the period following
their occurrence.</p>
<p>There are no obvious regular components in the series that would induce autocorrelation, so we turn to analysis of the ACF and PACF.</p>
<div class="sourceCode" id="cb474"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb474-1"><a href="Time.html#cb474-1" tabindex="-1"></a><span class="co"># convert data into a time series object</span></span>
<span id="cb474-2"><a href="Time.html#cb474-2" tabindex="-1"></a>volcano_dust_series <span class="ot">&lt;-</span> <span class="fu">ts</span>(volcano_dust, <span class="at">start =</span> <span class="fu">c</span>(<span class="dv">1500</span>))</span>
<span id="cb474-3"><a href="Time.html#cb474-3" tabindex="-1"></a><span class="co"># Compute autocorrelogram with max lag 20</span></span>
<span id="cb474-4"><a href="Time.html#cb474-4" tabindex="-1"></a><span class="fu">acf</span>(</span>
<span id="cb474-5"><a href="Time.html#cb474-5" tabindex="-1"></a>  volcano_dust_series,</span>
<span id="cb474-6"><a href="Time.html#cb474-6" tabindex="-1"></a>  <span class="at">lag.max =</span> <span class="dv">20</span>,</span>
<span id="cb474-7"><a href="Time.html#cb474-7" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb474-8"><a href="Time.html#cb474-8" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">&quot;Autocorrelogram volcano dust&quot;</span></span>
<span id="cb474-9"><a href="Time.html#cb474-9" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.13%20acf%20and%20pacf-1.png" width="672" /></p>
<div class="sourceCode" id="cb475"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb475-1"><a href="Time.html#cb475-1" tabindex="-1"></a><span class="co"># Compute the partial autocorrelogram with max lag 20</span></span>
<span id="cb475-2"><a href="Time.html#cb475-2" tabindex="-1"></a><span class="fu">pacf</span>(</span>
<span id="cb475-3"><a href="Time.html#cb475-3" tabindex="-1"></a>  volcano_dust_series,</span>
<span id="cb475-4"><a href="Time.html#cb475-4" tabindex="-1"></a>  <span class="at">lag.max =</span> <span class="dv">20</span>,</span>
<span id="cb475-5"><a href="Time.html#cb475-5" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb475-6"><a href="Time.html#cb475-6" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">&quot;Partial autocorrelogram volcano dust&quot;</span></span>
<span id="cb475-7"><a href="Time.html#cb475-7" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.13%20acf%20and%20pacf-2.png" width="672" /></p>
<p>The correlogram is the first panel and it points
to a significant autocorrelation at lag three and the possibility of an ARMA(0,3) model to capture the persistence in the ash level following a shock, and hence an MA(3) component or a mixture of an AR and MA model, might be considered. The PACF plot suggests a
significant lag 2 effect, suggesting an
ARMA(2,0) model.</p>
<p>The lack of obvious regular components, together with the correlogram plots, suggests the ARIMA approach differences may be used to achieve a
stationary process. The <code>auto.arima</code> function in the
R <code>forecast</code> library gives the following results (using the BIC criterion).</p>
<div class="sourceCode" id="cb476"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb476-1"><a href="Time.html#cb476-1" tabindex="-1"></a><span class="co"># Finding an ARIMA model</span></span>
<span id="cb476-2"><a href="Time.html#cb476-2" tabindex="-1"></a><span class="fu">auto.arima</span>(volcano_dust_series, <span class="at">ic =</span> <span class="st">&quot;bic&quot;</span>)</span></code></pre></div>
<pre><code>## Series: volcano_dust_series 
## ARIMA(2,0,0) with non-zero mean 
## 
## Coefficients:
##          ar1      ar2     mean
##       0.7533  -0.1268  57.5274
## s.e.  0.0457   0.0458   8.5958
## 
## sigma^2 = 4901:  log likelihood = -2662.54
## AIC=5333.09   AICc=5333.17   BIC=5349.7</code></pre>
<div class="sourceCode" id="cb478"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb478-1"><a href="Time.html#cb478-1" tabindex="-1"></a><span class="co"># fitting the ARIMA(2,0,0) model</span></span>
<span id="cb478-2"><a href="Time.html#cb478-2" tabindex="-1"></a>volcano_dust_arima <span class="ot">&lt;-</span> <span class="fu">arima</span>(volcano_dust_series, <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb478-3"><a href="Time.html#cb478-3" tabindex="-1"></a></span>
<span id="cb478-4"><a href="Time.html#cb478-4" tabindex="-1"></a><span class="co"># forecast 31 years with the ARIMA(2,0,0) model</span></span>
<span id="cb478-5"><a href="Time.html#cb478-5" tabindex="-1"></a>volcano_dust_forecast <span class="ot">&lt;-</span> <span class="fu">forecast</span>(volcano_dust_arima, <span class="at">h =</span> <span class="dv">31</span>)</span>
<span id="cb478-6"><a href="Time.html#cb478-6" tabindex="-1"></a><span class="fu">plot</span>(volcano_dust_forecast, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.14%20arima%20model-1.png" width="672" /></p>
<div class="blackbox">
<div class="center">
<p><strong>NOTE</strong></p>
</div>
<p>The code for the implementation of DLMs in Stan and Nimble was developed by Paritosh Kumar Roy. This code and other more complex DLM structures are available through his <a href="https://github.com/paritoshkroy">github</a>.</p>
</div>
</div>
<div id="example-11.17-implementation-of-a-dynamic-linear-model-uk-ozone-data" class="section level2 unnumbered hasAnchor">
<h2>Example 11.17 Implementation of a dynamic linear model: UK ozone data<a href="Time.html#example-11.17-implementation-of-a-dynamic-linear-model-uk-ozone-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this section we analyze the ozone concentration at one monitoring site in Aberdeen, UK from March to November 2017.</p>
<div id="nimble-7" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="Time.html#nimble-7" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb479"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb479-1"><a href="Time.html#cb479-1" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb479-2"><a href="Time.html#cb479-2" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb479-3"><a href="Time.html#cb479-3" tabindex="-1"></a><span class="co">#library(sf)</span></span>
<span id="cb479-4"><a href="Time.html#cb479-4" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb479-5"><a href="Time.html#cb479-5" tabindex="-1"></a><span class="fu">library</span>(nimble, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb479-6"><a href="Time.html#cb479-6" tabindex="-1"></a><span class="fu">library</span>(nleqslv)</span>
<span id="cb479-7"><a href="Time.html#cb479-7" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb479-8"><a href="Time.html#cb479-8" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb479-9"><a href="Time.html#cb479-9" tabindex="-1"></a></span>
<span id="cb479-10"><a href="Time.html#cb479-10" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;functions/FFBS_functions_nimble.R&quot;</span>)</span>
<span id="cb479-11"><a href="Time.html#cb479-11" tabindex="-1"></a></span>
<span id="cb479-12"><a href="Time.html#cb479-12" tabindex="-1"></a>UK_ozone <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/ozone/uk_ozone_one_site.csv&quot;</span>)</span>
<span id="cb479-13"><a href="Time.html#cb479-13" tabindex="-1"></a><span class="fu">head</span>(UK_ozone)</span></code></pre></div>
<pre><code>##      ozone     temp     wind       date
## 1 81.86627 2.433333 5.116667 2017-03-01
## 2 80.81055 2.754167 6.716667 2017-03-02
## 3 90.12082 2.716667 3.495833 2017-03-03
## 4 90.53892 5.320833 6.537500 2017-03-04
## 5 70.61635 4.920833 3.825000 2017-03-05
## 6 76.80751 2.479167 1.612500 2017-03-06</code></pre>
<div class="sourceCode" id="cb481"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb481-1"><a href="Time.html#cb481-1" tabindex="-1"></a>Example11_16_O3_Nimble <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb481-2"><a href="Time.html#cb481-2" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb481-3"><a href="Time.html#cb481-3" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Tt) {</span>
<span id="cb481-4"><a href="Time.html#cb481-4" tabindex="-1"></a>    Vt[t] <span class="ot">&lt;-</span> tau <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb481-5"><a href="Time.html#cb481-5" tabindex="-1"></a>  }</span>
<span id="cb481-6"><a href="Time.html#cb481-6" tabindex="-1"></a></span>
<span id="cb481-7"><a href="Time.html#cb481-7" tabindex="-1"></a>   <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb481-8"><a href="Time.html#cb481-8" tabindex="-1"></a>    sqrt_Wt_diag[j] <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb481-9"><a href="Time.html#cb481-9" tabindex="-1"></a>  }</span>
<span id="cb481-10"><a href="Time.html#cb481-10" tabindex="-1"></a></span>
<span id="cb481-11"><a href="Time.html#cb481-11" tabindex="-1"></a>  Wt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span> <span class="fu">nim_diag</span>(<span class="at">x =</span> sqrt_Wt_diag[<span class="dv">1</span><span class="sc">:</span>p] <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb481-12"><a href="Time.html#cb481-12" tabindex="-1"></a></span>
<span id="cb481-13"><a href="Time.html#cb481-13" tabindex="-1"></a>  mt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span>] <span class="ot">&lt;-</span> m0[<span class="dv">1</span><span class="sc">:</span>p]</span>
<span id="cb481-14"><a href="Time.html#cb481-14" tabindex="-1"></a>  Ct[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span>] <span class="ot">&lt;-</span> C0[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p]</span>
<span id="cb481-15"><a href="Time.html#cb481-15" tabindex="-1"></a></span>
<span id="cb481-16"><a href="Time.html#cb481-16" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Tt) {</span>
<span id="cb481-17"><a href="Time.html#cb481-17" tabindex="-1"></a>    at[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="ot">&lt;-</span> (Gt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> mt[<span class="dv">1</span><span class="sc">:</span>p, t])[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span>]</span>
<span id="cb481-18"><a href="Time.html#cb481-18" tabindex="-1"></a>    Rt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t] <span class="ot">&lt;-</span></span>
<span id="cb481-19"><a href="Time.html#cb481-19" tabindex="-1"></a>      Gt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> Ct[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">%*%</span> <span class="fu">t</span>(Gt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p]) <span class="sc">+</span> Wt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p]</span>
<span id="cb481-20"><a href="Time.html#cb481-20" tabindex="-1"></a>    ft[t] <span class="ot">&lt;-</span> (<span class="fu">t</span>(Ft[<span class="dv">1</span><span class="sc">:</span>p, t]) <span class="sc">%*%</span> at[<span class="dv">1</span><span class="sc">:</span>p, t])[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb481-21"><a href="Time.html#cb481-21" tabindex="-1"></a>    Qt[t] <span class="ot">&lt;-</span></span>
<span id="cb481-22"><a href="Time.html#cb481-22" tabindex="-1"></a>      (<span class="fu">t</span>(Ft[<span class="dv">1</span><span class="sc">:</span>p, t]) <span class="sc">%*%</span> Rt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">%*%</span> Ft[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">+</span> Vt[t])[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb481-23"><a href="Time.html#cb481-23" tabindex="-1"></a>    yt[t] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="at">mean =</span> ft[t], <span class="at">var =</span> Qt[t])</span>
<span id="cb481-24"><a href="Time.html#cb481-24" tabindex="-1"></a>    At[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="ot">&lt;-</span> (Rt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">%*%</span> Ft[<span class="dv">1</span><span class="sc">:</span>p, t])[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span>] <span class="sc">/</span> Qt[t]</span>
<span id="cb481-25"><a href="Time.html#cb481-25" tabindex="-1"></a>    mt[<span class="dv">1</span><span class="sc">:</span>p, t <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> at[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">+</span> (At[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">*</span> (yt[t] <span class="sc">-</span> ft[t]))</span>
<span id="cb481-26"><a href="Time.html#cb481-26" tabindex="-1"></a>    Ct[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb481-27"><a href="Time.html#cb481-27" tabindex="-1"></a>      Rt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">-</span> (At[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">%*%</span> <span class="fu">t</span>(At[<span class="dv">1</span><span class="sc">:</span>p, t])) <span class="sc">*</span> Qt[t]</span>
<span id="cb481-28"><a href="Time.html#cb481-28" tabindex="-1"></a>  }</span>
<span id="cb481-29"><a href="Time.html#cb481-29" tabindex="-1"></a></span>
<span id="cb481-30"><a href="Time.html#cb481-30" tabindex="-1"></a>  theta[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>(Tt <span class="sc">+</span> <span class="dv">1</span>)] <span class="ot">&lt;-</span></span>
<span id="cb481-31"><a href="Time.html#cb481-31" tabindex="-1"></a>    <span class="fu">nim_bsample</span>(</span>
<span id="cb481-32"><a href="Time.html#cb481-32" tabindex="-1"></a>      <span class="at">mt =</span> mt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>(Tt <span class="sc">+</span> <span class="dv">1</span>)],</span>
<span id="cb481-33"><a href="Time.html#cb481-33" tabindex="-1"></a>      <span class="at">Ct =</span> Ct[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>(Tt <span class="sc">+</span> <span class="dv">1</span>)],</span>
<span id="cb481-34"><a href="Time.html#cb481-34" tabindex="-1"></a>      <span class="at">at =</span> at[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>Tt],</span>
<span id="cb481-35"><a href="Time.html#cb481-35" tabindex="-1"></a>      <span class="at">Gt =</span> Gt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p],</span>
<span id="cb481-36"><a href="Time.html#cb481-36" tabindex="-1"></a>      <span class="at">Rt =</span> Rt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>Tt]</span>
<span id="cb481-37"><a href="Time.html#cb481-37" tabindex="-1"></a>    )</span>
<span id="cb481-38"><a href="Time.html#cb481-38" tabindex="-1"></a></span>
<span id="cb481-39"><a href="Time.html#cb481-39" tabindex="-1"></a>})</span></code></pre></div>
<div id="time-varying-level-model" class="section level4 unnumbered hasAnchor">
<h4>Time-varying level model<a href="Time.html#time-varying-level-model" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We first fit a time-varying level model such that,</p>
<p><span class="math display">\[\begin{aligned} Y_t &amp;= F_t\theta_t + v_t, \qquad &amp;v_t \sim \mathcal{N}(0, \tau^2) \\ \theta_t &amp;= G_t\theta_{t-1} + \omega_t  \qquad &amp;\omega_t \sim \mathcal{N}(0, W^2) \end{aligned}\]</span>
For the time-varying mean model <span class="math inline">\(F_t = (1, \ wind_t, \ temp_t)\)</span>, and <span class="math inline">\(G_t = I_3\)</span>.</p>
<div class="sourceCode" id="cb482"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb482-1"><a href="Time.html#cb482-1" tabindex="-1"></a><span class="co"># Model specification</span></span>
<span id="cb482-2"><a href="Time.html#cb482-2" tabindex="-1"></a>yt <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(UK_ozone<span class="sc">$</span>ozone)</span>
<span id="cb482-3"><a href="Time.html#cb482-3" tabindex="-1"></a>temp <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>temp</span>
<span id="cb482-4"><a href="Time.html#cb482-4" tabindex="-1"></a>wind <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>wind</span>
<span id="cb482-5"><a href="Time.html#cb482-5" tabindex="-1"></a></span>
<span id="cb482-6"><a href="Time.html#cb482-6" tabindex="-1"></a>Tt <span class="ot">&lt;-</span> <span class="fu">length</span>(yt)</span>
<span id="cb482-7"><a href="Time.html#cb482-7" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># (intercept, wind, temp)</span></span>
<span id="cb482-8"><a href="Time.html#cb482-8" tabindex="-1"></a></span>
<span id="cb482-9"><a href="Time.html#cb482-9" tabindex="-1"></a>Ft <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>( p, Tt))</span>
<span id="cb482-10"><a href="Time.html#cb482-10" tabindex="-1"></a>Ft[ <span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb482-11"><a href="Time.html#cb482-11" tabindex="-1"></a>Ft[ <span class="dv">2</span>,] <span class="ot">&lt;-</span> (wind[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb482-12"><a href="Time.html#cb482-12" tabindex="-1"></a>Ft[ <span class="dv">3</span>,] <span class="ot">&lt;-</span> (temp[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb482-13"><a href="Time.html#cb482-13" tabindex="-1"></a></span>
<span id="cb482-14"><a href="Time.html#cb482-14" tabindex="-1"></a>Gt <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb482-15"><a href="Time.html#cb482-15" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yt), <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb482-16"><a href="Time.html#cb482-16" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb482-17"><a href="Time.html#cb482-17" tabindex="-1"></a></span>
<span id="cb482-18"><a href="Time.html#cb482-18" tabindex="-1"></a></span>
<span id="cb482-19"><a href="Time.html#cb482-19" tabindex="-1"></a>const_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Tt =</span> Tt,</span>
<span id="cb482-20"><a href="Time.html#cb482-20" tabindex="-1"></a>                   <span class="at">p =</span> p)</span>
<span id="cb482-21"><a href="Time.html#cb482-21" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb482-22"><a href="Time.html#cb482-22" tabindex="-1"></a>  <span class="at">yt =</span> yt,</span>
<span id="cb482-23"><a href="Time.html#cb482-23" tabindex="-1"></a>  <span class="at">Ft =</span> Ft,</span>
<span id="cb482-24"><a href="Time.html#cb482-24" tabindex="-1"></a>  <span class="at">Gt =</span> Gt,</span>
<span id="cb482-25"><a href="Time.html#cb482-25" tabindex="-1"></a>  <span class="at">m0 =</span> m0,</span>
<span id="cb482-26"><a href="Time.html#cb482-26" tabindex="-1"></a>  <span class="at">C0 =</span> C0</span>
<span id="cb482-27"><a href="Time.html#cb482-27" tabindex="-1"></a>)</span>
<span id="cb482-28"><a href="Time.html#cb482-28" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tau =</span> <span class="fl">0.01</span>, <span class="at">sqrt_Wt_diag =</span> <span class="fu">sqrt</span>(<span class="fu">rep</span>(<span class="fl">0.1</span>, p)))</span>
<span id="cb482-29"><a href="Time.html#cb482-29" tabindex="-1"></a></span>
<span id="cb482-30"><a href="Time.html#cb482-30" tabindex="-1"></a>Rmodel <span class="ot">&lt;-</span></span>
<span id="cb482-31"><a href="Time.html#cb482-31" tabindex="-1"></a>  <span class="fu">nimbleModel</span>(</span>
<span id="cb482-32"><a href="Time.html#cb482-32" tabindex="-1"></a>    Example11_16_O3_Nimble,</span>
<span id="cb482-33"><a href="Time.html#cb482-33" tabindex="-1"></a>    <span class="at">constants =</span> const_list,</span>
<span id="cb482-34"><a href="Time.html#cb482-34" tabindex="-1"></a>    <span class="at">data =</span> dat_list,</span>
<span id="cb482-35"><a href="Time.html#cb482-35" tabindex="-1"></a>    <span class="at">inits =</span> init_list</span>
<span id="cb482-36"><a href="Time.html#cb482-36" tabindex="-1"></a>  )</span>
<span id="cb482-37"><a href="Time.html#cb482-37" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">initializeInfo</span>()</span>
<span id="cb482-38"><a href="Time.html#cb482-38" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">calculate</span>()</span>
<span id="cb482-39"><a href="Time.html#cb482-39" tabindex="-1"></a>Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span>
<span id="cb482-40"><a href="Time.html#cb482-40" tabindex="-1"></a>conf <span class="ot">&lt;-</span></span>
<span id="cb482-41"><a href="Time.html#cb482-41" tabindex="-1"></a>  <span class="fu">configureMCMC</span>(Rmodel, <span class="at">monitors =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_Wt_diag&quot;</span>, <span class="st">&quot;theta&quot;</span>, <span class="st">&quot;ft&quot;</span>))</span>
<span id="cb482-42"><a href="Time.html#cb482-42" tabindex="-1"></a></span>
<span id="cb482-43"><a href="Time.html#cb482-43" tabindex="-1"></a>Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf)</span>
<span id="cb482-44"><a href="Time.html#cb482-44" tabindex="-1"></a>Cmcmc <span class="ot">&lt;-</span></span>
<span id="cb482-45"><a href="Time.html#cb482-45" tabindex="-1"></a>  <span class="fu">compileNimble</span>(</span>
<span id="cb482-46"><a href="Time.html#cb482-46" tabindex="-1"></a>    Rmcmc,</span>
<span id="cb482-47"><a href="Time.html#cb482-47" tabindex="-1"></a>    <span class="at">project =</span> Cmodel,</span>
<span id="cb482-48"><a href="Time.html#cb482-48" tabindex="-1"></a>    <span class="at">resetFunctions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb482-49"><a href="Time.html#cb482-49" tabindex="-1"></a>    <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span></span>
<span id="cb482-50"><a href="Time.html#cb482-50" tabindex="-1"></a>  )</span>
<span id="cb482-51"><a href="Time.html#cb482-51" tabindex="-1"></a>niter <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb482-52"><a href="Time.html#cb482-52" tabindex="-1"></a>nburnin <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> niter</span>
<span id="cb482-53"><a href="Time.html#cb482-53" tabindex="-1"></a>nthin <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb482-54"><a href="Time.html#cb482-54" tabindex="-1"></a>nchains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb482-55"><a href="Time.html#cb482-55" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb482-56"><a href="Time.html#cb482-56" tabindex="-1"></a>post_samples <span class="ot">&lt;-</span></span>
<span id="cb482-57"><a href="Time.html#cb482-57" tabindex="-1"></a>  <span class="fu">runMCMC</span>(</span>
<span id="cb482-58"><a href="Time.html#cb482-58" tabindex="-1"></a>    Cmcmc,</span>
<span id="cb482-59"><a href="Time.html#cb482-59" tabindex="-1"></a>    <span class="at">niter =</span> niter,</span>
<span id="cb482-60"><a href="Time.html#cb482-60" tabindex="-1"></a>    <span class="at">nburnin =</span> nburnin,</span>
<span id="cb482-61"><a href="Time.html#cb482-61" tabindex="-1"></a>    <span class="at">thin =</span> nthin,</span>
<span id="cb482-62"><a href="Time.html#cb482-62" tabindex="-1"></a>    <span class="at">nchains =</span> nchains,</span>
<span id="cb482-63"><a href="Time.html#cb482-63" tabindex="-1"></a>    <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb482-64"><a href="Time.html#cb482-64" tabindex="-1"></a>  )</span>
<span id="cb482-65"><a href="Time.html#cb482-65" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb482-66"><a href="Time.html#cb482-66" tabindex="-1"></a>run_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb482-67"><a href="Time.html#cb482-67" tabindex="-1"></a>run_time</span></code></pre></div>
<div class="sourceCode" id="cb483"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb483-1"><a href="Time.html#cb483-1" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> <span class="fu">nimSummary</span>(post_samples)</span>
<span id="cb483-2"><a href="Time.html#cb483-2" tabindex="-1"></a>tidy_post_samples <span class="ot">&lt;-</span> post_samples <span class="sc">|&gt;</span> <span class="fu">tidy_draws</span>()</span>
<span id="cb483-3"><a href="Time.html#cb483-3" tabindex="-1"></a></span>
<span id="cb483-4"><a href="Time.html#cb483-4" tabindex="-1"></a>tidy_post_samples <span class="sc">|&gt;</span></span>
<span id="cb483-5"><a href="Time.html#cb483-5" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb483-6"><a href="Time.html#cb483-6" tabindex="-1"></a>    .chain,</span>
<span id="cb483-7"><a href="Time.html#cb483-7" tabindex="-1"></a>    .iteration,</span>
<span id="cb483-8"><a href="Time.html#cb483-8" tabindex="-1"></a>    .draw,</span>
<span id="cb483-9"><a href="Time.html#cb483-9" tabindex="-1"></a>    <span class="st">&#39;tau&#39;</span>,</span>
<span id="cb483-10"><a href="Time.html#cb483-10" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[1]&#39;</span>,</span>
<span id="cb483-11"><a href="Time.html#cb483-11" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[2]&#39;</span>,</span>
<span id="cb483-12"><a href="Time.html#cb483-12" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[3]&#39;</span></span>
<span id="cb483-13"><a href="Time.html#cb483-13" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb483-14"><a href="Time.html#cb483-14" tabindex="-1"></a>  <span class="fu">gather</span>(vars, value, <span class="sc">-</span>.chain, <span class="sc">-</span>.iteration, <span class="sc">-</span>.draw) <span class="sc">|&gt;</span></span>
<span id="cb483-15"><a href="Time.html#cb483-15" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .iteration, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb483-16"><a href="Time.html#cb483-16" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(.chain)), <span class="at">linewidth =</span> <span class="fl">0.25</span>,</span>
<span id="cb483-17"><a href="Time.html#cb483-17" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb483-18"><a href="Time.html#cb483-18" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> vars, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb483-19"><a href="Time.html#cb483-19" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb483-20"><a href="Time.html#cb483-20" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb483-21"><a href="Time.html#cb483-21" tabindex="-1"></a>        <span class="at">strip.background =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20nimble%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb484"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb484-1"><a href="Time.html#cb484-1" tabindex="-1"></a>post_summary[<span class="fu">c</span>(<span class="st">&#39;tau&#39;</span>,</span>
<span id="cb484-2"><a href="Time.html#cb484-2" tabindex="-1"></a>               <span class="st">&#39;sqrt_Wt_diag[1]&#39;</span>,</span>
<span id="cb484-3"><a href="Time.html#cb484-3" tabindex="-1"></a>               <span class="st">&#39;sqrt_Wt_diag[2]&#39;</span>,</span>
<span id="cb484-4"><a href="Time.html#cb484-4" tabindex="-1"></a>               <span class="st">&#39;sqrt_Wt_diag[3]&#39;</span>), ]</span></code></pre></div>
<pre><code>##                 post.mean post.sd  q2.5   q50 q97.5 f0    n.eff  Rhat
## tau                 0.550   0.033 0.487 0.551 0.614  1 1288.971 1.001
## sqrt_Wt_diag[1]     0.117   0.040 0.051 0.113 0.202  1 1161.622 1.001
## sqrt_Wt_diag[2]     0.017   0.009 0.004 0.016 0.039  1 1666.705 1.007
## sqrt_Wt_diag[3]     0.034   0.031 0.001 0.025 0.118  1  724.404 1.004</code></pre>
<div class="sourceCode" id="cb486"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb486-1"><a href="Time.html#cb486-1" tabindex="-1"></a>post_sum_theta <span class="ot">&lt;-</span></span>
<span id="cb486-2"><a href="Time.html#cb486-2" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(post_summary) <span class="sc">|&gt;</span>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb486-3"><a href="Time.html#cb486-3" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(rowname, <span class="st">&quot;theta&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb486-4"><a href="Time.html#cb486-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(rowname, q2<span class="fl">.5</span>, q50, q97<span class="fl">.5</span>) <span class="sc">|&gt;</span></span>
<span id="cb486-5"><a href="Time.html#cb486-5" tabindex="-1"></a>  <span class="fu">separate</span>(rowname, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;x1&quot;</span>, <span class="st">&quot;x2&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb486-6"><a href="Time.html#cb486-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">component =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, x1))) <span class="sc">|&gt;</span></span>
<span id="cb486-7"><a href="Time.html#cb486-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, x2))) <span class="sc">|&gt;</span></span>
<span id="cb486-8"><a href="Time.html#cb486-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(component, time, q2<span class="fl">.5</span>, q50, q97<span class="fl">.5</span>)</span>
<span id="cb486-9"><a href="Time.html#cb486-9" tabindex="-1"></a></span>
<span id="cb486-10"><a href="Time.html#cb486-10" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_theta, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb486-11"><a href="Time.html#cb486-11" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q2<span class="fl">.5</span>, <span class="at">ymax =</span> q97<span class="fl">.5</span>),</span>
<span id="cb486-12"><a href="Time.html#cb486-12" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">&quot;lightgray&quot;</span>,</span>
<span id="cb486-13"><a href="Time.html#cb486-13" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb486-14"><a href="Time.html#cb486-14" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> q50), <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb486-15"><a href="Time.html#cb486-15" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb486-16"><a href="Time.html#cb486-16" tabindex="-1"></a>    <span class="sc">~</span> component,</span>
<span id="cb486-17"><a href="Time.html#cb486-17" tabindex="-1"></a>    <span class="at">nrow =</span> <span class="dv">2</span>,</span>
<span id="cb486-18"><a href="Time.html#cb486-18" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>,</span>
<span id="cb486-19"><a href="Time.html#cb486-19" tabindex="-1"></a>    <span class="at">labeller =</span> <span class="fu">label_bquote</span>(theta[.(component)])</span>
<span id="cb486-20"><a href="Time.html#cb486-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb486-21"><a href="Time.html#cb486-21" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb486-22"><a href="Time.html#cb486-22" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20nimble%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb487"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb487-1"><a href="Time.html#cb487-1" tabindex="-1"></a>npsample <span class="ot">&lt;-</span> <span class="fu">floor</span>((niter <span class="sc">-</span> nburnin)<span class="sc">/</span>nthin)</span>
<span id="cb487-2"><a href="Time.html#cb487-2" tabindex="-1"></a><span class="co"># str(tidy_post_samples)</span></span>
<span id="cb487-3"><a href="Time.html#cb487-3" tabindex="-1"></a></span>
<span id="cb487-4"><a href="Time.html#cb487-4" tabindex="-1"></a>Cnim_postfit_uoms <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(nim_postfit_uoms, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## Compiling
##   [Note] This may take a minute.
##   [Note] Use &#39;showCompilerOutput = TRUE&#39; to see C++ compilation details.</code></pre>
<div class="sourceCode" id="cb489"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb489-1"><a href="Time.html#cb489-1" tabindex="-1"></a>post_tau <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>tau</span>
<span id="cb489-2"><a href="Time.html#cb489-2" tabindex="-1"></a>post_sqrt_Wt_diag <span class="ot">&lt;-</span></span>
<span id="cb489-3"><a href="Time.html#cb489-3" tabindex="-1"></a>  tidy_post_samples  <span class="sc">|&gt;</span>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;sqrt_Wt_diag&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb489-4"><a href="Time.html#cb489-4" tabindex="-1"></a>  <span class="fu">as.matrix</span>()<span class="sc">|&gt;</span>  <span class="fu">unname</span>()</span>
<span id="cb489-5"><a href="Time.html#cb489-5" tabindex="-1"></a></span>
<span id="cb489-6"><a href="Time.html#cb489-6" tabindex="-1"></a>post_ft_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>(nchains<span class="sc">*</span>npsample), <span class="cf">function</span>(i) {</span>
<span id="cb489-7"><a href="Time.html#cb489-7" tabindex="-1"></a>  post_Vt <span class="ot">&lt;-</span> post_tau[i]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb489-8"><a href="Time.html#cb489-8" tabindex="-1"></a>  post_Wt <span class="ot">&lt;-</span> <span class="fu">nim_diag</span>(post_sqrt_Wt_diag[i,]<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb489-9"><a href="Time.html#cb489-9" tabindex="-1"></a>  post_ft <span class="ot">&lt;-</span> <span class="fu">Cnim_postfit_uoms</span>(<span class="at">yt =</span> dat_list<span class="sc">$</span>yt,</span>
<span id="cb489-10"><a href="Time.html#cb489-10" tabindex="-1"></a>                               <span class="at">Ft =</span> dat_list<span class="sc">$</span>Ft,</span>
<span id="cb489-11"><a href="Time.html#cb489-11" tabindex="-1"></a>                               <span class="at">Vt =</span> post_Vt,</span>
<span id="cb489-12"><a href="Time.html#cb489-12" tabindex="-1"></a>                               <span class="at">Gt =</span> dat_list<span class="sc">$</span>Gt,</span>
<span id="cb489-13"><a href="Time.html#cb489-13" tabindex="-1"></a>                               <span class="at">Wt =</span> post_Wt,</span>
<span id="cb489-14"><a href="Time.html#cb489-14" tabindex="-1"></a>                               <span class="at">m0 =</span> dat_list<span class="sc">$</span>m0,</span>
<span id="cb489-15"><a href="Time.html#cb489-15" tabindex="-1"></a>                               <span class="at">C0 =</span> dat_list<span class="sc">$</span>C0)</span>
<span id="cb489-16"><a href="Time.html#cb489-16" tabindex="-1"></a>  post_ft <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">ft =</span> post_ft) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">row_number</span>())</span>
<span id="cb489-17"><a href="Time.html#cb489-17" tabindex="-1"></a>  <span class="fu">return</span>(post_ft)</span>
<span id="cb489-18"><a href="Time.html#cb489-18" tabindex="-1"></a>})</span>
<span id="cb489-19"><a href="Time.html#cb489-19" tabindex="-1"></a></span>
<span id="cb489-20"><a href="Time.html#cb489-20" tabindex="-1"></a>tidy_post_ft <span class="ot">&lt;-</span> <span class="fu">do.call</span>(<span class="st">&quot;rbind&quot;</span>, post_ft_list)</span>
<span id="cb489-21"><a href="Time.html#cb489-21" tabindex="-1"></a><span class="fu">str</span>(tidy_post_ft)</span></code></pre></div>
<pre><code>## &#39;data.frame&#39;:    2750000 obs. of  2 variables:
##  $ ft  : num  10.67 10.06 9.77 8.48 9.02 ...
##  $ time: int  1 2 3 4 5 6 7 8 9 10 ...</code></pre>
<div class="sourceCode" id="cb491"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb491-1"><a href="Time.html#cb491-1" tabindex="-1"></a><span class="fu">head</span>(tidy_post_ft)</span></code></pre></div>
<pre><code>##          ft time
## 1 10.673309    1
## 2 10.055283    2
## 3  9.772315    3
## 4  8.479460    4
## 5  9.019850    5
## 6  8.055427    6</code></pre>
<div class="sourceCode" id="cb493"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb493-1"><a href="Time.html#cb493-1" tabindex="-1"></a><span class="do">## posterior summaries of ft</span></span>
<span id="cb493-2"><a href="Time.html#cb493-2" tabindex="-1"></a><span class="fu">head</span>(tidy_post_ft)</span></code></pre></div>
<pre><code>##          ft time
## 1 10.673309    1
## 2 10.055283    2
## 3  9.772315    3
## 4  8.479460    4
## 5  9.019850    5
## 6  8.055427    6</code></pre>
<div class="sourceCode" id="cb495"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb495-1"><a href="Time.html#cb495-1" tabindex="-1"></a>post_sum_ft <span class="ot">&lt;-</span> tidy_post_ft <span class="sc">|&gt;</span> <span class="fu">group_by</span>(time) <span class="sc">|&gt;</span></span>
<span id="cb495-2"><a href="Time.html#cb495-2" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">post.mean =</span> <span class="fu">mean</span>(ft),</span>
<span id="cb495-3"><a href="Time.html#cb495-3" tabindex="-1"></a>            <span class="at">post.sd =</span> <span class="fu">sd</span>(ft),</span>
<span id="cb495-4"><a href="Time.html#cb495-4" tabindex="-1"></a>            <span class="at">q2.5 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb495-5"><a href="Time.html#cb495-5" tabindex="-1"></a>            <span class="at">q50 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.50</span>),</span>
<span id="cb495-6"><a href="Time.html#cb495-6" tabindex="-1"></a>            <span class="at">q97.5 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.975</span>)) <span class="sc">|&gt;</span></span>
<span id="cb495-7"><a href="Time.html#cb495-7" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb495-8"><a href="Time.html#cb495-8" tabindex="-1"></a><span class="fu">str</span>(post_sum_ft)</span></code></pre></div>
<pre><code>## tibble [275 × 6] (S3: tbl_df/tbl/data.frame)
##  $ time     : int [1:275] 1 2 3 4 5 6 7 8 9 10 ...
##  $ post.mean: num [1:275] 8.14 8.96 8.95 8.66 9.2 ...
##  $ post.sd  : num [1:275] 2.296 1.277 1.139 0.789 0.761 ...
##  $ q2.5     : Named num [1:275] 3.67 6.48 6.73 7.1 7.68 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:275] &quot;2.5%&quot; &quot;2.5%&quot; &quot;2.5%&quot; &quot;2.5%&quot; ...
##  $ q50      : Named num [1:275] 8.13 8.96 8.95 8.65 9.2 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:275] &quot;50%&quot; &quot;50%&quot; &quot;50%&quot; &quot;50%&quot; ...
##  $ q97.5    : Named num [1:275] 12.6 11.5 11.2 10.2 10.7 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:275] &quot;97.5%&quot; &quot;97.5%&quot; &quot;97.5%&quot; &quot;97.5%&quot; ...</code></pre>
<div class="sourceCode" id="cb497"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb497-1"><a href="Time.html#cb497-1" tabindex="-1"></a>post_sum_ft <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code></pre></div>
<pre><code>## # A tibble: 6 × 6
##    time post.mean post.sd  q2.5   q50 q97.5
##   &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     1      8.14   2.30   3.67  8.13  12.6
## 2     2      8.96   1.28   6.48  8.96  11.5
## 3     3      8.95   1.14   6.73  8.95  11.2
## 4     4      8.66   0.789  7.10  8.65  10.2
## 5     5      9.20   0.761  7.68  9.20  10.7
## 6     6      8.90   0.909  7.08  8.89  10.7</code></pre>
<div class="sourceCode" id="cb499"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb499-1"><a href="Time.html#cb499-1" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_ft, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb499-2"><a href="Time.html#cb499-2" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q2<span class="fl">.5</span>,<span class="at">ymax =</span> q97<span class="fl">.5</span>), <span class="at">fill =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb499-3"><a href="Time.html#cb499-3" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> post.mean),  <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb499-4"><a href="Time.html#cb499-4" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y=</span>yt), <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb499-5"><a href="Time.html#cb499-5" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb499-6"><a href="Time.html#cb499-6" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Fitted values Ozone level UK&quot;</span>) <span class="sc">+</span></span>
<span id="cb499-7"><a href="Time.html#cb499-7" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20%20nimble%20fitted%20values-1.png" width="672" /></p>
<div class="sourceCode" id="cb500"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb500-1"><a href="Time.html#cb500-1" tabindex="-1"></a><span class="co"># Residuals plot</span></span>
<span id="cb500-2"><a href="Time.html#cb500-2" tabindex="-1"></a>res <span class="ot">&lt;-</span> post_sum_ft<span class="sc">$</span>post.mean <span class="sc">-</span> dat_list<span class="sc">$</span>yt</span>
<span id="cb500-3"><a href="Time.html#cb500-3" tabindex="-1"></a><span class="fu">acf</span>(res, <span class="at">lag.max =</span> <span class="dv">35</span>,<span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20%20nimble%20fitted%20values-2.png" width="672" /></p>
</div>
<div id="trend-model" class="section level4 unnumbered hasAnchor">
<h4>Trend model<a href="Time.html#trend-model" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>In this case we include a trend then, <span class="math inline">\(F_t = (1, 0, \ wind_t, \ temp_t)\)</span> and <span class="math inline">\(G_t = \begin{pmatrix} 1 &amp; 1 \\ 0 &amp; 1\end{pmatrix}\)</span>.</p>
<div class="sourceCode" id="cb501"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb501-1"><a href="Time.html#cb501-1" tabindex="-1"></a><span class="co"># Model specification</span></span>
<span id="cb501-2"><a href="Time.html#cb501-2" tabindex="-1"></a>yt <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(UK_ozone<span class="sc">$</span>ozone)</span>
<span id="cb501-3"><a href="Time.html#cb501-3" tabindex="-1"></a>temp <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>temp</span>
<span id="cb501-4"><a href="Time.html#cb501-4" tabindex="-1"></a>wind <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>wind</span>
<span id="cb501-5"><a href="Time.html#cb501-5" tabindex="-1"></a></span>
<span id="cb501-6"><a href="Time.html#cb501-6" tabindex="-1"></a>Tt <span class="ot">&lt;-</span> <span class="fu">length</span>(yt)</span>
<span id="cb501-7"><a href="Time.html#cb501-7" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co"># (intercept, trend, wind, temp)</span></span>
<span id="cb501-8"><a href="Time.html#cb501-8" tabindex="-1"></a></span>
<span id="cb501-9"><a href="Time.html#cb501-9" tabindex="-1"></a>Ft <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>( p, Tt))</span>
<span id="cb501-10"><a href="Time.html#cb501-10" tabindex="-1"></a>Ft[<span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb501-11"><a href="Time.html#cb501-11" tabindex="-1"></a>Ft[<span class="dv">2</span>,] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb501-12"><a href="Time.html#cb501-12" tabindex="-1"></a>Ft[<span class="dv">3</span>,] <span class="ot">&lt;-</span> (wind[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb501-13"><a href="Time.html#cb501-13" tabindex="-1"></a>Ft[<span class="dv">4</span>,] <span class="ot">&lt;-</span> (temp[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb501-14"><a href="Time.html#cb501-14" tabindex="-1"></a></span>
<span id="cb501-15"><a href="Time.html#cb501-15" tabindex="-1"></a></span>
<span id="cb501-16"><a href="Time.html#cb501-16" tabindex="-1"></a>Gt <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb501-17"><a href="Time.html#cb501-17" tabindex="-1"></a>Gt[<span class="dv">1</span>, <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb501-18"><a href="Time.html#cb501-18" tabindex="-1"></a></span>
<span id="cb501-19"><a href="Time.html#cb501-19" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yt), <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb501-20"><a href="Time.html#cb501-20" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb501-21"><a href="Time.html#cb501-21" tabindex="-1"></a></span>
<span id="cb501-22"><a href="Time.html#cb501-22" tabindex="-1"></a>const_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Tt =</span> Tt,</span>
<span id="cb501-23"><a href="Time.html#cb501-23" tabindex="-1"></a>                   <span class="at">p =</span> p)</span>
<span id="cb501-24"><a href="Time.html#cb501-24" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb501-25"><a href="Time.html#cb501-25" tabindex="-1"></a>  <span class="at">yt =</span> yt,</span>
<span id="cb501-26"><a href="Time.html#cb501-26" tabindex="-1"></a>  <span class="at">Ft =</span> Ft,</span>
<span id="cb501-27"><a href="Time.html#cb501-27" tabindex="-1"></a>  <span class="at">Gt =</span> Gt,</span>
<span id="cb501-28"><a href="Time.html#cb501-28" tabindex="-1"></a>  <span class="at">m0 =</span> m0,</span>
<span id="cb501-29"><a href="Time.html#cb501-29" tabindex="-1"></a>  <span class="at">C0 =</span> C0</span>
<span id="cb501-30"><a href="Time.html#cb501-30" tabindex="-1"></a>)</span>
<span id="cb501-31"><a href="Time.html#cb501-31" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tau =</span> <span class="fl">0.01</span>, <span class="at">sqrt_Wt_diag =</span> <span class="fu">sqrt</span>(<span class="fu">rep</span>(<span class="fl">0.1</span>, p)))</span>
<span id="cb501-32"><a href="Time.html#cb501-32" tabindex="-1"></a></span>
<span id="cb501-33"><a href="Time.html#cb501-33" tabindex="-1"></a>Rmodel <span class="ot">&lt;-</span></span>
<span id="cb501-34"><a href="Time.html#cb501-34" tabindex="-1"></a>  <span class="fu">nimbleModel</span>(</span>
<span id="cb501-35"><a href="Time.html#cb501-35" tabindex="-1"></a>    Example11_16_O3_Nimble,</span>
<span id="cb501-36"><a href="Time.html#cb501-36" tabindex="-1"></a>    <span class="at">constants =</span> const_list,</span>
<span id="cb501-37"><a href="Time.html#cb501-37" tabindex="-1"></a>    <span class="at">data =</span> dat_list,</span>
<span id="cb501-38"><a href="Time.html#cb501-38" tabindex="-1"></a>    <span class="at">inits =</span> init_list</span>
<span id="cb501-39"><a href="Time.html#cb501-39" tabindex="-1"></a>  )</span>
<span id="cb501-40"><a href="Time.html#cb501-40" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">initializeInfo</span>()</span>
<span id="cb501-41"><a href="Time.html#cb501-41" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">calculate</span>()</span>
<span id="cb501-42"><a href="Time.html#cb501-42" tabindex="-1"></a>Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span>
<span id="cb501-43"><a href="Time.html#cb501-43" tabindex="-1"></a>conf <span class="ot">&lt;-</span></span>
<span id="cb501-44"><a href="Time.html#cb501-44" tabindex="-1"></a>  <span class="fu">configureMCMC</span>(Rmodel, <span class="at">monitors =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_Wt_diag&quot;</span>, <span class="st">&quot;theta&quot;</span>, <span class="st">&quot;ft&quot;</span>))</span>
<span id="cb501-45"><a href="Time.html#cb501-45" tabindex="-1"></a></span>
<span id="cb501-46"><a href="Time.html#cb501-46" tabindex="-1"></a>Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf)</span>
<span id="cb501-47"><a href="Time.html#cb501-47" tabindex="-1"></a>Cmcmc <span class="ot">&lt;-</span></span>
<span id="cb501-48"><a href="Time.html#cb501-48" tabindex="-1"></a>  <span class="fu">compileNimble</span>(</span>
<span id="cb501-49"><a href="Time.html#cb501-49" tabindex="-1"></a>    Rmcmc,</span>
<span id="cb501-50"><a href="Time.html#cb501-50" tabindex="-1"></a>    <span class="at">project =</span> Cmodel,</span>
<span id="cb501-51"><a href="Time.html#cb501-51" tabindex="-1"></a>    <span class="at">resetFunctions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb501-52"><a href="Time.html#cb501-52" tabindex="-1"></a>    <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span></span>
<span id="cb501-53"><a href="Time.html#cb501-53" tabindex="-1"></a>  )</span>
<span id="cb501-54"><a href="Time.html#cb501-54" tabindex="-1"></a>niter <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb501-55"><a href="Time.html#cb501-55" tabindex="-1"></a>nburnin <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> niter</span>
<span id="cb501-56"><a href="Time.html#cb501-56" tabindex="-1"></a>nthin <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb501-57"><a href="Time.html#cb501-57" tabindex="-1"></a>nchains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb501-58"><a href="Time.html#cb501-58" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb501-59"><a href="Time.html#cb501-59" tabindex="-1"></a>post_samples <span class="ot">&lt;-</span></span>
<span id="cb501-60"><a href="Time.html#cb501-60" tabindex="-1"></a>  <span class="fu">runMCMC</span>(</span>
<span id="cb501-61"><a href="Time.html#cb501-61" tabindex="-1"></a>    Cmcmc,</span>
<span id="cb501-62"><a href="Time.html#cb501-62" tabindex="-1"></a>    <span class="at">niter =</span> niter,</span>
<span id="cb501-63"><a href="Time.html#cb501-63" tabindex="-1"></a>    <span class="at">nburnin =</span> nburnin,</span>
<span id="cb501-64"><a href="Time.html#cb501-64" tabindex="-1"></a>    <span class="at">thin =</span> nthin,</span>
<span id="cb501-65"><a href="Time.html#cb501-65" tabindex="-1"></a>    <span class="at">nchains =</span> nchains,</span>
<span id="cb501-66"><a href="Time.html#cb501-66" tabindex="-1"></a>    <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb501-67"><a href="Time.html#cb501-67" tabindex="-1"></a>  )</span>
<span id="cb501-68"><a href="Time.html#cb501-68" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb501-69"><a href="Time.html#cb501-69" tabindex="-1"></a>run_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb501-70"><a href="Time.html#cb501-70" tabindex="-1"></a>run_time</span></code></pre></div>
<div class="sourceCode" id="cb502"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb502-1"><a href="Time.html#cb502-1" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> <span class="fu">nimSummary</span>(post_samples)</span>
<span id="cb502-2"><a href="Time.html#cb502-2" tabindex="-1"></a>tidy_post_samples <span class="ot">&lt;-</span> post_samples <span class="sc">|&gt;</span> <span class="fu">tidy_draws</span>()</span>
<span id="cb502-3"><a href="Time.html#cb502-3" tabindex="-1"></a></span>
<span id="cb502-4"><a href="Time.html#cb502-4" tabindex="-1"></a>tidy_post_samples <span class="sc">|&gt;</span></span>
<span id="cb502-5"><a href="Time.html#cb502-5" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb502-6"><a href="Time.html#cb502-6" tabindex="-1"></a>    .chain,</span>
<span id="cb502-7"><a href="Time.html#cb502-7" tabindex="-1"></a>    .iteration,</span>
<span id="cb502-8"><a href="Time.html#cb502-8" tabindex="-1"></a>    .draw,</span>
<span id="cb502-9"><a href="Time.html#cb502-9" tabindex="-1"></a>    <span class="st">&#39;tau&#39;</span>,</span>
<span id="cb502-10"><a href="Time.html#cb502-10" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[1]&#39;</span>,</span>
<span id="cb502-11"><a href="Time.html#cb502-11" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[2]&#39;</span>,</span>
<span id="cb502-12"><a href="Time.html#cb502-12" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[3]&#39;</span>,</span>
<span id="cb502-13"><a href="Time.html#cb502-13" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[4]&#39;</span></span>
<span id="cb502-14"><a href="Time.html#cb502-14" tabindex="-1"></a></span>
<span id="cb502-15"><a href="Time.html#cb502-15" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb502-16"><a href="Time.html#cb502-16" tabindex="-1"></a>  <span class="fu">gather</span>(vars, value, <span class="sc">-</span>.chain, <span class="sc">-</span>.iteration, <span class="sc">-</span>.draw) <span class="sc">|&gt;</span></span>
<span id="cb502-17"><a href="Time.html#cb502-17" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .iteration, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb502-18"><a href="Time.html#cb502-18" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(.chain)), <span class="at">linewidth =</span> <span class="fl">0.25</span>,</span>
<span id="cb502-19"><a href="Time.html#cb502-19" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb502-20"><a href="Time.html#cb502-20" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> vars, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb502-21"><a href="Time.html#cb502-21" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb502-22"><a href="Time.html#cb502-22" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb502-23"><a href="Time.html#cb502-23" tabindex="-1"></a>        <span class="at">strip.background =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20nimble%20trend%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb503"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb503-1"><a href="Time.html#cb503-1" tabindex="-1"></a>post_summary[<span class="fu">c</span>(<span class="st">&#39;tau&#39;</span>,</span>
<span id="cb503-2"><a href="Time.html#cb503-2" tabindex="-1"></a>               <span class="st">&#39;sqrt_Wt_diag[1]&#39;</span>,</span>
<span id="cb503-3"><a href="Time.html#cb503-3" tabindex="-1"></a>               <span class="st">&#39;sqrt_Wt_diag[2]&#39;</span>,</span>
<span id="cb503-4"><a href="Time.html#cb503-4" tabindex="-1"></a>               <span class="st">&#39;sqrt_Wt_diag[3]&#39;</span>,</span>
<span id="cb503-5"><a href="Time.html#cb503-5" tabindex="-1"></a>               <span class="st">&#39;sqrt_Wt_diag[4]&#39;</span>), ]</span></code></pre></div>
<pre><code>##                 post.mean post.sd  q2.5   q50 q97.5 f0    n.eff  Rhat
## tau                 0.544   0.037 0.471 0.543 0.615  1  875.124 1.004
## sqrt_Wt_diag[1]     0.131   0.055 0.030 0.128 0.244  1  850.247 1.002
## sqrt_Wt_diag[2]     0.002   0.002 0.000 0.002 0.007  1  930.546 1.000
## sqrt_Wt_diag[3]     0.017   0.009 0.004 0.016 0.040  1 1694.931 1.009
## sqrt_Wt_diag[4]     0.036   0.032 0.001 0.027 0.120  1 1002.860 1.023</code></pre>
<div class="sourceCode" id="cb505"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb505-1"><a href="Time.html#cb505-1" tabindex="-1"></a>post_sum_theta <span class="ot">&lt;-</span></span>
<span id="cb505-2"><a href="Time.html#cb505-2" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(post_summary) <span class="sc">|&gt;</span>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb505-3"><a href="Time.html#cb505-3" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(rowname, <span class="st">&quot;theta&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb505-4"><a href="Time.html#cb505-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(rowname, q2<span class="fl">.5</span>, q50, q97<span class="fl">.5</span>) <span class="sc">|&gt;</span></span>
<span id="cb505-5"><a href="Time.html#cb505-5" tabindex="-1"></a>  <span class="fu">separate</span>(rowname, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;x1&quot;</span>, <span class="st">&quot;x2&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb505-6"><a href="Time.html#cb505-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">component =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, x1))) <span class="sc">|&gt;</span></span>
<span id="cb505-7"><a href="Time.html#cb505-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, x2))) <span class="sc">|&gt;</span></span>
<span id="cb505-8"><a href="Time.html#cb505-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(component, time, q2<span class="fl">.5</span>, q50, q97<span class="fl">.5</span>)</span>
<span id="cb505-9"><a href="Time.html#cb505-9" tabindex="-1"></a></span>
<span id="cb505-10"><a href="Time.html#cb505-10" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_theta, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb505-11"><a href="Time.html#cb505-11" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q2<span class="fl">.5</span>, <span class="at">ymax =</span> q97<span class="fl">.5</span>),</span>
<span id="cb505-12"><a href="Time.html#cb505-12" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">&quot;lightgray&quot;</span>,</span>
<span id="cb505-13"><a href="Time.html#cb505-13" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb505-14"><a href="Time.html#cb505-14" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> q50), <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb505-15"><a href="Time.html#cb505-15" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb505-16"><a href="Time.html#cb505-16" tabindex="-1"></a>    <span class="sc">~</span> component,</span>
<span id="cb505-17"><a href="Time.html#cb505-17" tabindex="-1"></a>    <span class="at">nrow =</span> <span class="dv">2</span>,</span>
<span id="cb505-18"><a href="Time.html#cb505-18" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>,</span>
<span id="cb505-19"><a href="Time.html#cb505-19" tabindex="-1"></a>    <span class="at">labeller =</span> <span class="fu">label_bquote</span>(theta[.(component)])</span>
<span id="cb505-20"><a href="Time.html#cb505-20" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb505-21"><a href="Time.html#cb505-21" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb505-22"><a href="Time.html#cb505-22" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb505-23"><a href="Time.html#cb505-23" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20nimble%20trend%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb506"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb506-1"><a href="Time.html#cb506-1" tabindex="-1"></a>npsample <span class="ot">&lt;-</span> <span class="fu">floor</span>((niter <span class="sc">-</span> nburnin)<span class="sc">/</span>nthin)</span>
<span id="cb506-2"><a href="Time.html#cb506-2" tabindex="-1"></a></span>
<span id="cb506-3"><a href="Time.html#cb506-3" tabindex="-1"></a>Cnim_postfit_uoms <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(nim_postfit_uoms, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## Compiling
##   [Note] This may take a minute.
##   [Note] Use &#39;showCompilerOutput = TRUE&#39; to see C++ compilation details.</code></pre>
<div class="sourceCode" id="cb508"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb508-1"><a href="Time.html#cb508-1" tabindex="-1"></a>post_tau <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>tau</span>
<span id="cb508-2"><a href="Time.html#cb508-2" tabindex="-1"></a>post_sqrt_Wt_diag <span class="ot">&lt;-</span></span>
<span id="cb508-3"><a href="Time.html#cb508-3" tabindex="-1"></a>  tidy_post_samples  <span class="sc">|&gt;</span>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;sqrt_Wt_diag&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb508-4"><a href="Time.html#cb508-4" tabindex="-1"></a>  <span class="fu">as.matrix</span>()<span class="sc">|&gt;</span>  <span class="fu">unname</span>()</span>
<span id="cb508-5"><a href="Time.html#cb508-5" tabindex="-1"></a></span>
<span id="cb508-6"><a href="Time.html#cb508-6" tabindex="-1"></a>post_ft_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>(nchains<span class="sc">*</span>npsample), <span class="cf">function</span>(i) {</span>
<span id="cb508-7"><a href="Time.html#cb508-7" tabindex="-1"></a>  post_Vt <span class="ot">&lt;-</span> post_tau[i]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb508-8"><a href="Time.html#cb508-8" tabindex="-1"></a>  post_Wt <span class="ot">&lt;-</span> <span class="fu">nim_diag</span>(post_sqrt_Wt_diag[i,]<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb508-9"><a href="Time.html#cb508-9" tabindex="-1"></a>  post_ft <span class="ot">&lt;-</span> <span class="fu">Cnim_postfit_uoms</span>(<span class="at">yt =</span> dat_list<span class="sc">$</span>yt,</span>
<span id="cb508-10"><a href="Time.html#cb508-10" tabindex="-1"></a>                               <span class="at">Ft =</span> dat_list<span class="sc">$</span>Ft,</span>
<span id="cb508-11"><a href="Time.html#cb508-11" tabindex="-1"></a>                               <span class="at">Vt =</span> post_Vt,</span>
<span id="cb508-12"><a href="Time.html#cb508-12" tabindex="-1"></a>                               <span class="at">Gt =</span> dat_list<span class="sc">$</span>Gt,</span>
<span id="cb508-13"><a href="Time.html#cb508-13" tabindex="-1"></a>                               <span class="at">Wt =</span> post_Wt,</span>
<span id="cb508-14"><a href="Time.html#cb508-14" tabindex="-1"></a>                               <span class="at">m0 =</span> dat_list<span class="sc">$</span>m0,</span>
<span id="cb508-15"><a href="Time.html#cb508-15" tabindex="-1"></a>                               <span class="at">C0 =</span> dat_list<span class="sc">$</span>C0)</span>
<span id="cb508-16"><a href="Time.html#cb508-16" tabindex="-1"></a>  post_ft <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">ft =</span> post_ft) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">row_number</span>())</span>
<span id="cb508-17"><a href="Time.html#cb508-17" tabindex="-1"></a>  <span class="fu">return</span>(post_ft)</span>
<span id="cb508-18"><a href="Time.html#cb508-18" tabindex="-1"></a>})</span>
<span id="cb508-19"><a href="Time.html#cb508-19" tabindex="-1"></a></span>
<span id="cb508-20"><a href="Time.html#cb508-20" tabindex="-1"></a>tidy_post_ft <span class="ot">&lt;-</span> <span class="fu">do.call</span>(<span class="st">&quot;rbind&quot;</span>, post_ft_list)</span>
<span id="cb508-21"><a href="Time.html#cb508-21" tabindex="-1"></a></span>
<span id="cb508-22"><a href="Time.html#cb508-22" tabindex="-1"></a><span class="do">## posterior summaries of ft</span></span>
<span id="cb508-23"><a href="Time.html#cb508-23" tabindex="-1"></a>post_sum_ft <span class="ot">&lt;-</span> tidy_post_ft <span class="sc">|&gt;</span> <span class="fu">group_by</span>(time) <span class="sc">|&gt;</span></span>
<span id="cb508-24"><a href="Time.html#cb508-24" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">post.mean =</span> <span class="fu">mean</span>(ft),</span>
<span id="cb508-25"><a href="Time.html#cb508-25" tabindex="-1"></a>            <span class="at">post.sd =</span> <span class="fu">sd</span>(ft),</span>
<span id="cb508-26"><a href="Time.html#cb508-26" tabindex="-1"></a>            <span class="at">q2.5 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb508-27"><a href="Time.html#cb508-27" tabindex="-1"></a>            <span class="at">q50 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.50</span>),</span>
<span id="cb508-28"><a href="Time.html#cb508-28" tabindex="-1"></a>            <span class="at">q97.5 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.975</span>)) <span class="sc">|&gt;</span></span>
<span id="cb508-29"><a href="Time.html#cb508-29" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb508-30"><a href="Time.html#cb508-30" tabindex="-1"></a></span>
<span id="cb508-31"><a href="Time.html#cb508-31" tabindex="-1"></a></span>
<span id="cb508-32"><a href="Time.html#cb508-32" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_ft, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb508-33"><a href="Time.html#cb508-33" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q2<span class="fl">.5</span>,<span class="at">ymax =</span> q97<span class="fl">.5</span>), <span class="at">fill =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb508-34"><a href="Time.html#cb508-34" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> post.mean),  <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb508-35"><a href="Time.html#cb508-35" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y=</span>yt), <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb508-36"><a href="Time.html#cb508-36" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb508-37"><a href="Time.html#cb508-37" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Fitted values Ozone level UK&quot;</span>) <span class="sc">+</span></span>
<span id="cb508-38"><a href="Time.html#cb508-38" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<pre><code>## Warning: Using `size` aesthetic for lines was deprecated
## in ggplot2 3.4.0.
## ℹ Please use `linewidth` instead.</code></pre>
<p><img src="_main_files/figure-html/Ex%2011.16%20nimble%20trend%20fitted%20values-1.png" width="672" /></p>
<div class="sourceCode" id="cb510"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb510-1"><a href="Time.html#cb510-1" tabindex="-1"></a><span class="co"># Residuals plot</span></span>
<span id="cb510-2"><a href="Time.html#cb510-2" tabindex="-1"></a>res <span class="ot">&lt;-</span> post_sum_ft<span class="sc">$</span>post.mean <span class="sc">-</span> dat_list<span class="sc">$</span>yt</span>
<span id="cb510-3"><a href="Time.html#cb510-3" tabindex="-1"></a><span class="fu">acf</span>(res, <span class="at">lag.max =</span> <span class="dv">35</span>,<span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20nimble%20trend%20fitted%20values-2.png" width="672" /></p>
</div>
</div>
<div id="stan-6" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="Time.html#stan-6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb511"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb511-1"><a href="Time.html#cb511-1" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb511-2"><a href="Time.html#cb511-2" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb511-3"><a href="Time.html#cb511-3" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb511-4"><a href="Time.html#cb511-4" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb511-5"><a href="Time.html#cb511-5" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb511-6"><a href="Time.html#cb511-6" tabindex="-1"></a></span>
<span id="cb511-7"><a href="Time.html#cb511-7" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb511-8"><a href="Time.html#cb511-8" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb511-9"><a href="Time.html#cb511-9" tabindex="-1"></a></span>
<span id="cb511-10"><a href="Time.html#cb511-10" tabindex="-1"></a><span class="co"># Load data for RW case</span></span>
<span id="cb511-11"><a href="Time.html#cb511-11" tabindex="-1"></a>UK_ozone <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/ozone/uk_ozone_one_site.csv&quot;</span>)</span></code></pre></div>
<div id="time-varying-level-model-1" class="section level4 unnumbered hasAnchor">
<h4>Time-varying level model<a href="Time.html#time-varying-level-model-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb512"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb512-1"><a href="Time.html#cb512-1" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(UK_ozone<span class="sc">$</span>ozone)</span>
<span id="cb512-2"><a href="Time.html#cb512-2" tabindex="-1"></a>temp <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>temp</span>
<span id="cb512-3"><a href="Time.html#cb512-3" tabindex="-1"></a>wind <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>wind</span>
<span id="cb512-4"><a href="Time.html#cb512-4" tabindex="-1"></a></span>
<span id="cb512-5"><a href="Time.html#cb512-5" tabindex="-1"></a>Tt <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb512-6"><a href="Time.html#cb512-6" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># (intercept, wind, temp)</span></span>
<span id="cb512-7"><a href="Time.html#cb512-7" tabindex="-1"></a></span>
<span id="cb512-8"><a href="Time.html#cb512-8" tabindex="-1"></a>Ft <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(Tt, p))</span>
<span id="cb512-9"><a href="Time.html#cb512-9" tabindex="-1"></a>Ft[, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb512-10"><a href="Time.html#cb512-10" tabindex="-1"></a>Ft[, <span class="dv">2</span>] <span class="ot">&lt;-</span> (wind[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb512-11"><a href="Time.html#cb512-11" tabindex="-1"></a>Ft[, <span class="dv">3</span>] <span class="ot">&lt;-</span> (temp[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb512-12"><a href="Time.html#cb512-12" tabindex="-1"></a></span>
<span id="cb512-13"><a href="Time.html#cb512-13" tabindex="-1"></a>Gt <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb512-14"><a href="Time.html#cb512-14" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y), <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb512-15"><a href="Time.html#cb512-15" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb512-16"><a href="Time.html#cb512-16" tabindex="-1"></a></span>
<span id="cb512-17"><a href="Time.html#cb512-17" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">T =</span> Tt, <span class="at">p =</span> p, <span class="at">y =</span> y, <span class="at">F =</span> Ft, <span class="at">G =</span> Gt, <span class="at">m0=</span> m0, <span class="at">C0 =</span> C0)</span></code></pre></div>
<pre><code>functions {
  
  // FFBS for DLM with univariate observation equation and univariate system equation
  array[] vector uoms_ffbs_rng(array[] real y, array[] vector F, matrix G, real V, matrix W, vector m0, matrix C0, int T, int p){
    
    array[T] vector[p] theta;
    array[T] vector[p] a;
    array[T] matrix[p,p] R;
    array[T] vector[p] m;
    array[T] matrix[p,p] C;
    
    // Kalman filtering
    
    vector[p] mt = m0;
    matrix[p,p] Ct = C0;
    
    for(i in 1:T){
      
      real ft;
      real Qt;
      vector[p] at;
      matrix[p,p] Rt;
      vector[p] At;
      
      at = G * mt;
      Rt = G * Ct * G&#39; + W;
      ft = F[i]&#39; * at;
      Qt = quad_form(Rt, F[i]) + V; //F[i]&#39; * Rt * F[i] + V;
      At = Rt * F[i] * inv(Qt);
      mt = at + At * (y[i] - ft);
      Ct = Rt - At * Qt * At&#39;;
      
      //store for backward sampling
      a[i] = at;
      R[i] = Rt;
      m[i] = mt;
      C[i] = Ct;
  }
    // backward sampling
    array[T-1] int ind = sort_indices_desc(linspaced_int_array(T-1,1,T-1));
    theta[T] = multi_normal_rng(m[T], C[T]);
    for(i in ind) {
      matrix[p,p] Bt;
      vector[p] ht;
      matrix[p,p] Ht;
      Bt = C[i] * G&#39; * inverse(R[i+1]);
      ht = m[i] + Bt * (theta[i+1] - a[i+1]);
      Ht = C[i] - Bt * R[i+1] * Bt&#39;;
      theta[i] = multi_normal_rng(ht, Ht);
    }
  return theta;
}

  real uoms_dlm_ldensity(array[] real y, array[] vector F, matrix G, real V, matrix W, vector m0, matrix C0, int T, int p){
    array[T+1] vector[p] a;
    array[T+1] matrix[p, p] R;
    array[T] real lldata;
    a[1] = m0;
    R[1] = C0;
    for (i in 1:T) {
      real u;
      real Q;
      real Qinv;
      vector[p] A;
      matrix[p, p] L;
      u = y[i] - F[i]&#39; * a[i];
      Q = quad_form(R[i],F[i]) + V; //F[i]&#39; * R[i] * F[i] + V;
      Qinv = inv(Q); //
      A = G * R[i] * F[i] * Qinv;
      L = G - A * F[i]&#39;;
      //lldata[i] = -0.5 * (log(2 * pi()) + log(Q) + Qinv*square(u));
      lldata[i] = normal_lpdf(u | 0, sqrt(Q)); // univariate
      a[i+1] = G * a[i] + A * u;
      R[i+1] = G * R[i] * L&#39; + W;
    }
  return sum(lldata);
  }
  
  array[] real uoms_dlm_one_step_ahead_rng(array[] real y, array[] vector F, matrix G, real V, matrix W, vector m0, matrix C0, int T, int p){
    array[T] real yfit;
    array[T+1] vector[p] a;
    array[T+1] matrix[p, p] R;
    array[T] real lldata;
    a[1] = m0;
    R[1] = C0;
    for (i in 1:T) {
      real u;
      real Q;
      real Qinv;
      vector[p] A;
      matrix[p, p] L;
      u = y[i] - F[i]&#39; * a[i];
      Q = quad_form(R[i],F[i]) + V; //F[i]&#39; * R[i] * F[i] + V;
      Qinv = inv(Q); //
      A = G * R[i] * F[i] * Qinv;
      L = G - A * F[i]&#39;;
      yfit[i] = normal_rng(F[i]&#39; * a[i], sqrt(Q)); // univariate
      a[i+1] = G * a[i] + A * u;
      R[i+1] = G * R[i] * L&#39; + W;
    }
  return yfit;
  }
}

data{
  int T;
  int p;
  array[T] real y;
  array[T] vector[p] F;
  matrix[p, p] G;
  vector[p] m0;
  cov_matrix[p] C0;
}

parameters{
  real&lt;lower=0&gt; tau;
  vector&lt;lower=0&gt;[p] sqrt_W_diag;
}

model {
  real V = square(tau);
  matrix[p, p] W = diag_matrix(square(sqrt_W_diag));
  tau ~ std_normal();
  sqrt_W_diag ~ std_normal();
  target += uoms_dlm_ldensity(y, F, G, V, W, m0, C0, T, p);
}

generated quantities{
  array[T] vector[p] theta;
  array[T] real yfit;
  real V = square(tau);
  matrix[p, p] W = diag_matrix(square(sqrt_W_diag));
  theta = uoms_ffbs_rng(y, F, G, V, W, m0, C0, T, p);
  yfit = uoms_dlm_one_step_ahead_rng(y, F, G, V, W, m0, C0, T, p);
}</code></pre>
<div class="sourceCode" id="cb514"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb514-1"><a href="Time.html#cb514-1" tabindex="-1"></a>Example11_16_UK_Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb514-2"><a href="Time.html#cb514-2" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example11_16_UK.stan&quot;</span>,</span>
<span id="cb514-3"><a href="Time.html#cb514-3" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb514-4"><a href="Time.html#cb514-4" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">5000</span>,</span>
<span id="cb514-5"><a href="Time.html#cb514-5" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb514-6"><a href="Time.html#cb514-6" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb514-7"><a href="Time.html#cb514-7" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb514-8"><a href="Time.html#cb514-8" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb515"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb515-1"><a href="Time.html#cb515-1" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_Stan,</span>
<span id="cb515-2"><a href="Time.html#cb515-2" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_W_diag&quot;</span>, <span class="st">&quot;theta[1,1]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20stan-1.png" width="672" /></p>
<div class="sourceCode" id="cb516"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb516-1"><a href="Time.html#cb516-1" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_Stan,</span>
<span id="cb516-2"><a href="Time.html#cb516-2" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(Tt, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,1]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20stan-2.png" width="672" /></p>
<div class="sourceCode" id="cb517"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb517-1"><a href="Time.html#cb517-1" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_Stan,</span>
<span id="cb517-2"><a href="Time.html#cb517-2" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(Tt, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,2]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20stan-3.png" width="672" /></p>
<div class="sourceCode" id="cb518"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb518-1"><a href="Time.html#cb518-1" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_Stan,</span>
<span id="cb518-2"><a href="Time.html#cb518-2" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(Tt, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,3]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20stan-4.png" width="672" /></p>
<div class="sourceCode" id="cb519"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb519-1"><a href="Time.html#cb519-1" tabindex="-1"></a>fixedpars_summary <span class="ot">&lt;-</span></span>
<span id="cb519-2"><a href="Time.html#cb519-2" tabindex="-1"></a>  <span class="fu">summary</span>(Example11_16_UK_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_W_diag&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb519-3"><a href="Time.html#cb519-3" tabindex="-1"></a>fixedpars_summary</span></code></pre></div>
<pre><code>##                      mean      se_mean          sd        2.5%        25%
## tau            0.54952783 3.456478e-04 0.033200616 0.483950759 0.52724045
## sqrt_W_diag[1] 0.11879062 4.682828e-04 0.042765301 0.051417741 0.08668241
## sqrt_W_diag[2] 0.01702899 8.180045e-05 0.008928214 0.003498400 0.01079707
## sqrt_W_diag[3] 0.03420662 3.088344e-04 0.030751202 0.001145905 0.01123936
##                       50%        75%      97.5%     n_eff      Rhat
## tau            0.54963949 0.57140419 0.61408371  9226.237 1.0003090
## sqrt_W_diag[1] 0.11341398 0.14535262 0.21426583  8340.013 1.0000506
## sqrt_W_diag[2] 0.01557511 0.02165377 0.03841738 11912.906 0.9999899
## sqrt_W_diag[3] 0.02543997 0.04824451 0.11442124  9914.543 1.0001423</code></pre>
<div class="sourceCode" id="cb521"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb521-1"><a href="Time.html#cb521-1" tabindex="-1"></a>theta_summary <span class="ot">&lt;-</span></span>
<span id="cb521-2"><a href="Time.html#cb521-2" tabindex="-1"></a>  <span class="fu">summary</span>(Example11_16_UK_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb521-3"><a href="Time.html#cb521-3" tabindex="-1"></a></span>
<span id="cb521-4"><a href="Time.html#cb521-4" tabindex="-1"></a>yfit_summary <span class="ot">&lt;-</span></span>
<span id="cb521-5"><a href="Time.html#cb521-5" tabindex="-1"></a>  <span class="fu">summary</span>(Example11_16_UK_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;yfit&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb521-6"><a href="Time.html#cb521-6" tabindex="-1"></a></span>
<span id="cb521-7"><a href="Time.html#cb521-7" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb521-8"><a href="Time.html#cb521-8" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb521-9"><a href="Time.html#cb521-9" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Tt, <span class="st">&quot;,1]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb521-10"><a href="Time.html#cb521-10" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">|&gt;</span></span>
<span id="cb521-11"><a href="Time.html#cb521-11" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb521-12"><a href="Time.html#cb521-12" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb521-13"><a href="Time.html#cb521-13" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb521-14"><a href="Time.html#cb521-14" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb521-15"><a href="Time.html#cb521-15" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb521-16"><a href="Time.html#cb521-16" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Intercept&quot;</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb521-17"><a href="Time.html#cb521-17" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb521-18"><a href="Time.html#cb521-18" tabindex="-1"></a></span>
<span id="cb521-19"><a href="Time.html#cb521-19" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb521-20"><a href="Time.html#cb521-20" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb521-21"><a href="Time.html#cb521-21" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Tt, <span class="st">&quot;,2]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb521-22"><a href="Time.html#cb521-22" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">|&gt;</span></span>
<span id="cb521-23"><a href="Time.html#cb521-23" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb521-24"><a href="Time.html#cb521-24" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb521-25"><a href="Time.html#cb521-25" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb521-26"><a href="Time.html#cb521-26" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb521-27"><a href="Time.html#cb521-27" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb521-28"><a href="Time.html#cb521-28" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Wind&quot;</span>) <span class="sc">+</span>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb521-29"><a href="Time.html#cb521-29" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb521-30"><a href="Time.html#cb521-30" tabindex="-1"></a></span>
<span id="cb521-31"><a href="Time.html#cb521-31" tabindex="-1"></a></span>
<span id="cb521-32"><a href="Time.html#cb521-32" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb521-33"><a href="Time.html#cb521-33" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb521-34"><a href="Time.html#cb521-34" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Tt, <span class="st">&quot;,3]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb521-35"><a href="Time.html#cb521-35" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">|&gt;</span></span>
<span id="cb521-36"><a href="Time.html#cb521-36" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb521-37"><a href="Time.html#cb521-37" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb521-38"><a href="Time.html#cb521-38" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb521-39"><a href="Time.html#cb521-39" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb521-40"><a href="Time.html#cb521-40" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb521-41"><a href="Time.html#cb521-41" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Temperature&quot;</span>) <span class="sc">+</span>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb521-42"><a href="Time.html#cb521-42" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb521-43"><a href="Time.html#cb521-43" tabindex="-1"></a></span>
<span id="cb521-44"><a href="Time.html#cb521-44" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1,p2,p3, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20stan-5.png" width="672" /></p>
<div class="sourceCode" id="cb522"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb522-1"><a href="Time.html#cb522-1" tabindex="-1"></a><span class="co"># Fitted values</span></span>
<span id="cb522-2"><a href="Time.html#cb522-2" tabindex="-1"></a>yfit_summary_dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(yfit_summary) <span class="sc">|&gt;</span></span>
<span id="cb522-3"><a href="Time.html#cb522-3" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb522-4"><a href="Time.html#cb522-4" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, rowname)))</span>
<span id="cb522-5"><a href="Time.html#cb522-5" tabindex="-1"></a></span>
<span id="cb522-6"><a href="Time.html#cb522-6" tabindex="-1"></a><span class="fu">ggplot</span>(yfit_summary_dt, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb522-7"><a href="Time.html#cb522-7" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb522-8"><a href="Time.html#cb522-8" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb522-9"><a href="Time.html#cb522-9" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;gray99&quot;</span>) <span class="sc">+</span></span>
<span id="cb522-10"><a href="Time.html#cb522-10" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb522-11"><a href="Time.html#cb522-11" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">linewidth =</span> <span class="fl">0.1</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb522-12"><a href="Time.html#cb522-12" tabindex="-1"></a> <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb522-13"><a href="Time.html#cb522-13" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Fitted values Ozone level UK&quot;</span>) <span class="sc">+</span></span>
<span id="cb522-14"><a href="Time.html#cb522-14" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<pre><code>## Warning: Using `size` aesthetic for lines was deprecated
## in ggplot2 3.4.0.
## ℹ Please use `linewidth` instead.</code></pre>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20stan-6.png" width="672" /></p>
</div>
<div id="trend-model-1" class="section level4 unnumbered hasAnchor">
<h4>Trend model<a href="Time.html#trend-model-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb524"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb524-1"><a href="Time.html#cb524-1" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(UK_ozone<span class="sc">$</span>ozone)</span>
<span id="cb524-2"><a href="Time.html#cb524-2" tabindex="-1"></a>temp <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>temp</span>
<span id="cb524-3"><a href="Time.html#cb524-3" tabindex="-1"></a>wind <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>wind</span>
<span id="cb524-4"><a href="Time.html#cb524-4" tabindex="-1"></a></span>
<span id="cb524-5"><a href="Time.html#cb524-5" tabindex="-1"></a>Tt <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb524-6"><a href="Time.html#cb524-6" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co"># (intercept, trend, wind, temp)</span></span>
<span id="cb524-7"><a href="Time.html#cb524-7" tabindex="-1"></a></span>
<span id="cb524-8"><a href="Time.html#cb524-8" tabindex="-1"></a>Ft <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(Tt, p))</span>
<span id="cb524-9"><a href="Time.html#cb524-9" tabindex="-1"></a>Ft[, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb524-10"><a href="Time.html#cb524-10" tabindex="-1"></a>Ft[, <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb524-11"><a href="Time.html#cb524-11" tabindex="-1"></a>Ft[, <span class="dv">3</span>] <span class="ot">&lt;-</span> (wind[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb524-12"><a href="Time.html#cb524-12" tabindex="-1"></a>Ft[, <span class="dv">4</span>] <span class="ot">&lt;-</span> (temp[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb524-13"><a href="Time.html#cb524-13" tabindex="-1"></a></span>
<span id="cb524-14"><a href="Time.html#cb524-14" tabindex="-1"></a>Gt <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb524-15"><a href="Time.html#cb524-15" tabindex="-1"></a>Gt[<span class="dv">1</span>, <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb524-16"><a href="Time.html#cb524-16" tabindex="-1"></a></span>
<span id="cb524-17"><a href="Time.html#cb524-17" tabindex="-1"></a></span>
<span id="cb524-18"><a href="Time.html#cb524-18" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y), <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb524-19"><a href="Time.html#cb524-19" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb524-20"><a href="Time.html#cb524-20" tabindex="-1"></a></span>
<span id="cb524-21"><a href="Time.html#cb524-21" tabindex="-1"></a>stan_data_trend <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb524-22"><a href="Time.html#cb524-22" tabindex="-1"></a>  <span class="at">T =</span> Tt,</span>
<span id="cb524-23"><a href="Time.html#cb524-23" tabindex="-1"></a>  <span class="at">p =</span> p,</span>
<span id="cb524-24"><a href="Time.html#cb524-24" tabindex="-1"></a>  <span class="at">y =</span> y,</span>
<span id="cb524-25"><a href="Time.html#cb524-25" tabindex="-1"></a>  <span class="at">F =</span> Ft,</span>
<span id="cb524-26"><a href="Time.html#cb524-26" tabindex="-1"></a>  <span class="at">G =</span> Gt,</span>
<span id="cb524-27"><a href="Time.html#cb524-27" tabindex="-1"></a>  <span class="at">m0 =</span> m0,</span>
<span id="cb524-28"><a href="Time.html#cb524-28" tabindex="-1"></a>  <span class="at">C0 =</span> C0</span>
<span id="cb524-29"><a href="Time.html#cb524-29" tabindex="-1"></a>)</span>
<span id="cb524-30"><a href="Time.html#cb524-30" tabindex="-1"></a></span>
<span id="cb524-31"><a href="Time.html#cb524-31" tabindex="-1"></a>Example11_16_UK_trend_Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb524-32"><a href="Time.html#cb524-32" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example11_16_UK.stan&quot;</span>,</span>
<span id="cb524-33"><a href="Time.html#cb524-33" tabindex="-1"></a>  <span class="at">data =</span> stan_data_trend,</span>
<span id="cb524-34"><a href="Time.html#cb524-34" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">5000</span>,</span>
<span id="cb524-35"><a href="Time.html#cb524-35" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb524-36"><a href="Time.html#cb524-36" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb524-37"><a href="Time.html#cb524-37" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb524-38"><a href="Time.html#cb524-38" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb525"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb525-1"><a href="Time.html#cb525-1" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_trend_Stan,</span>
<span id="cb525-2"><a href="Time.html#cb525-2" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_W_diag&quot;</span>, <span class="st">&quot;theta[1,1]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20traceplots%20trend%20stan-1.png" width="672" /></p>
<div class="sourceCode" id="cb526"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb526-1"><a href="Time.html#cb526-1" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_trend_Stan,</span>
<span id="cb526-2"><a href="Time.html#cb526-2" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(Tt, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,1]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20traceplots%20trend%20stan-2.png" width="672" /></p>
<div class="sourceCode" id="cb527"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb527-1"><a href="Time.html#cb527-1" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_trend_Stan,</span>
<span id="cb527-2"><a href="Time.html#cb527-2" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(Tt, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,2]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20traceplots%20trend%20stan-3.png" width="672" /></p>
<div class="sourceCode" id="cb528"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb528-1"><a href="Time.html#cb528-1" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_trend_Stan,</span>
<span id="cb528-2"><a href="Time.html#cb528-2" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(Tt, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,3]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20traceplots%20trend%20stan-4.png" width="672" /></p>
<div class="sourceCode" id="cb529"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb529-1"><a href="Time.html#cb529-1" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_trend_Stan,</span>
<span id="cb529-2"><a href="Time.html#cb529-2" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(Tt, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,4]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20traceplots%20trend%20stan-5.png" width="672" /></p>
<div class="sourceCode" id="cb530"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb530-1"><a href="Time.html#cb530-1" tabindex="-1"></a>fixedpars_summary <span class="ot">&lt;-</span></span>
<span id="cb530-2"><a href="Time.html#cb530-2" tabindex="-1"></a>  <span class="fu">summary</span>(Example11_16_UK_trend_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_W_diag&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb530-3"><a href="Time.html#cb530-3" tabindex="-1"></a>fixedpars_summary</span></code></pre></div>
<pre><code>##                       mean      se_mean          sd         2.5%          25%
## tau            0.543609759 4.244185e-04 0.034916177 4.759466e-01 0.5198417513
## sqrt_W_diag[1] 0.131495609 6.716602e-04 0.052039444 3.354044e-02 0.0950301137
## sqrt_W_diag[2] 0.002097407 1.780222e-05 0.001951722 7.149022e-05 0.0007203768
## sqrt_W_diag[3] 0.016756008 8.775711e-05 0.008939004 3.193146e-03 0.0104914524
## sqrt_W_diag[4] 0.035244960 3.018273e-04 0.031556739 1.061907e-03 0.0115224492
##                        50%         75%       97.5%     n_eff      Rhat
## tau            0.543855509 0.566994280 0.612394177  6768.068 1.0005912
## sqrt_W_diag[1] 0.129907861 0.165821794 0.237108079  6002.968 1.0005880
## sqrt_W_diag[2] 0.001565133 0.002890185 0.007144111 12019.539 0.9998917
## sqrt_W_diag[3] 0.015321489 0.021433185 0.037871038 10375.611 1.0001893
## sqrt_W_diag[4] 0.026463865 0.049436417 0.118025666 10931.186 1.0000489</code></pre>
<div class="sourceCode" id="cb532"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb532-1"><a href="Time.html#cb532-1" tabindex="-1"></a>theta_summary <span class="ot">&lt;-</span></span>
<span id="cb532-2"><a href="Time.html#cb532-2" tabindex="-1"></a>  <span class="fu">summary</span>(Example11_16_UK_trend_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb532-3"><a href="Time.html#cb532-3" tabindex="-1"></a></span>
<span id="cb532-4"><a href="Time.html#cb532-4" tabindex="-1"></a>yfit_summary <span class="ot">&lt;-</span></span>
<span id="cb532-5"><a href="Time.html#cb532-5" tabindex="-1"></a>  <span class="fu">summary</span>(Example11_16_UK_trend_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;yfit&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb532-6"><a href="Time.html#cb532-6" tabindex="-1"></a></span>
<span id="cb532-7"><a href="Time.html#cb532-7" tabindex="-1"></a></span>
<span id="cb532-8"><a href="Time.html#cb532-8" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb532-9"><a href="Time.html#cb532-9" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb532-10"><a href="Time.html#cb532-10" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Tt, <span class="st">&quot;,1]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb532-11"><a href="Time.html#cb532-11" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">|&gt;</span></span>
<span id="cb532-12"><a href="Time.html#cb532-12" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb532-13"><a href="Time.html#cb532-13" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb532-14"><a href="Time.html#cb532-14" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb532-15"><a href="Time.html#cb532-15" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb532-16"><a href="Time.html#cb532-16" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb532-17"><a href="Time.html#cb532-17" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Intercept&quot;</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb532-18"><a href="Time.html#cb532-18" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb532-19"><a href="Time.html#cb532-19" tabindex="-1"></a></span>
<span id="cb532-20"><a href="Time.html#cb532-20" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb532-21"><a href="Time.html#cb532-21" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb532-22"><a href="Time.html#cb532-22" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Tt, <span class="st">&quot;,4]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb532-23"><a href="Time.html#cb532-23" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">|&gt;</span></span>
<span id="cb532-24"><a href="Time.html#cb532-24" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb532-25"><a href="Time.html#cb532-25" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb532-26"><a href="Time.html#cb532-26" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb532-27"><a href="Time.html#cb532-27" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb532-28"><a href="Time.html#cb532-28" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb532-29"><a href="Time.html#cb532-29" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Trend&quot;</span>) <span class="sc">+</span>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb532-30"><a href="Time.html#cb532-30" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb532-31"><a href="Time.html#cb532-31" tabindex="-1"></a></span>
<span id="cb532-32"><a href="Time.html#cb532-32" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb532-33"><a href="Time.html#cb532-33" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb532-34"><a href="Time.html#cb532-34" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Tt, <span class="st">&quot;,2]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb532-35"><a href="Time.html#cb532-35" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">|&gt;</span></span>
<span id="cb532-36"><a href="Time.html#cb532-36" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb532-37"><a href="Time.html#cb532-37" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb532-38"><a href="Time.html#cb532-38" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb532-39"><a href="Time.html#cb532-39" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb532-40"><a href="Time.html#cb532-40" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb532-41"><a href="Time.html#cb532-41" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Wind&quot;</span>) <span class="sc">+</span>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb532-42"><a href="Time.html#cb532-42" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb532-43"><a href="Time.html#cb532-43" tabindex="-1"></a></span>
<span id="cb532-44"><a href="Time.html#cb532-44" tabindex="-1"></a></span>
<span id="cb532-45"><a href="Time.html#cb532-45" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb532-46"><a href="Time.html#cb532-46" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb532-47"><a href="Time.html#cb532-47" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Tt, <span class="st">&quot;,3]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb532-48"><a href="Time.html#cb532-48" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">|&gt;</span></span>
<span id="cb532-49"><a href="Time.html#cb532-49" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb532-50"><a href="Time.html#cb532-50" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb532-51"><a href="Time.html#cb532-51" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb532-52"><a href="Time.html#cb532-52" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb532-53"><a href="Time.html#cb532-53" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb532-54"><a href="Time.html#cb532-54" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Temperature&quot;</span>) <span class="sc">+</span>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb532-55"><a href="Time.html#cb532-55" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb532-56"><a href="Time.html#cb532-56" tabindex="-1"></a></span>
<span id="cb532-57"><a href="Time.html#cb532-57" tabindex="-1"></a></span>
<span id="cb532-58"><a href="Time.html#cb532-58" tabindex="-1"></a></span>
<span id="cb532-59"><a href="Time.html#cb532-59" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1,p2,p3, p4, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20trend%20stan-1.png" width="672" /></p>
<div class="sourceCode" id="cb533"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb533-1"><a href="Time.html#cb533-1" tabindex="-1"></a><span class="co"># Fitted values</span></span>
<span id="cb533-2"><a href="Time.html#cb533-2" tabindex="-1"></a>yfit_summary_dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(yfit_summary) <span class="sc">|&gt;</span></span>
<span id="cb533-3"><a href="Time.html#cb533-3" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb533-4"><a href="Time.html#cb533-4" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, rowname)))</span>
<span id="cb533-5"><a href="Time.html#cb533-5" tabindex="-1"></a></span>
<span id="cb533-6"><a href="Time.html#cb533-6" tabindex="-1"></a><span class="fu">ggplot</span>(yfit_summary_dt, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb533-7"><a href="Time.html#cb533-7" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb533-8"><a href="Time.html#cb533-8" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb533-9"><a href="Time.html#cb533-9" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;gray99&quot;</span>) <span class="sc">+</span></span>
<span id="cb533-10"><a href="Time.html#cb533-10" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb533-11"><a href="Time.html#cb533-11" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">linewidth =</span> <span class="fl">0.1</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb533-12"><a href="Time.html#cb533-12" tabindex="-1"></a> <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb533-13"><a href="Time.html#cb533-13" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Fitted values Ozone level UK&quot;</span>) <span class="sc">+</span></span>
<span id="cb533-14"><a href="Time.html#cb533-14" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20trend%20stan-2.png" width="672" /></p>
</div>
</div>
</div>
<div id="example-11.18-dynamic-glms-for-daily-counts-of-carbon-monoxide-on-counts-of-infant-deaths-in-são-paulo-brazil" class="section level2 hasAnchor" number="11.1">
<h2><span class="header-section-number">11.1</span> Example 11.18 Dynamic GLMs for daily counts of carbon monoxide on counts of infant deaths in São Paulo, Brazil<a href="Time.html#example-11.18-dynamic-glms-for-daily-counts-of-carbon-monoxide-on-counts-of-infant-deaths-in-são-paulo-brazil" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This dataset was analyzed by Alves et al. (2010) and is related to daily
counts of deaths of infants under 5 years old due to respiratory causes in
São Paulo, Brazil. The sampling period is from January 1, 1994, until 31
December 1997. We fit a simplified version of the model fitted in Alves et al.
(2010),</p>
</div>
<div id="solutions-to-selected-exercises-1" class="section level2 unnumbered hasAnchor">
<h2>Solutions to Selected Exercises<a href="Time.html#solutions-to-selected-exercises-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
</div>
<div id="exercise-11.11" class="section level2 unnumbered hasAnchor">
<h2>Exercise 11.11<a href="Time.html#exercise-11.11" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The joint distribution of <span class="math inline">\(\mathbf{\gamma} = \{\gamma_1, \gamma_2, \dots, \gamma_{N_T}\}\)</span> can be written as:
<span class="math display">\[
p(\mathbf{\gamma}) = p(\gamma_1) \prod_{t=1}^{N_T-1}p(\gamma_{t+1}\mid\gamma)\\
= p(\gamma_1)(2\pi\sigma_w^2)^{-(N_T-1)/2}\exp\{- \frac{1}{2\sigma_w^2} \sum_{t=1}^{N_T-1} (\gamma_{t+1} - \gamma)^2) \}\\
\propto p(\gamma_1) \exp\{-\frac{1}{2\sigma_w^2}\mathbf{\gamma}^\top M \mathbf{\gamma}\},
\]</span>
where the entries of <span class="math inline">\(M\)</span> are:
<span class="math display">\[
M_{ij} = \begin{cases}
1, &amp; i = j = 1, N_T\\
2, &amp; i = j = 2, 3, \dots, N_T - 1 \\
-1 &amp; i = (j-1), \text{where } j = 2, 3, \dots, N_T\\
-1 &amp; i = (j+1), \text{where } j = 1, 2, \dots, N_T - 1 \\
0 &amp; \text{else}
\end{cases}.
\]</span>
Now, if we assume that <span class="math inline">\(p(\gamma_1) \propto 1\)</span>, i.e., an uninformative, improper prior, we have that
<span class="math display">\[
p(\mathbf{\gamma}) \propto \exp\{-\frac{1}{2\sigma_w^2}\mathbf{\gamma}^\top M \mathbf{\gamma}\},
\]</span>
which implies that, for any <span class="math inline">\(t\)</span>, by Bayes rule,</p>
<p><span class="math display">\[
p(\gamma_t|\mathbf{\gamma}_{-t}) = \frac{p(\mathbf{\gamma})}{p(\mathbf{\gamma}_{-t})} \propto p(\mathbf{\gamma}).
\]</span></p>
<p>Eliminating terms in the joint distribution <span class="math inline">\(P(\gamma)\)</span> not related to <span class="math inline">\(\gamma_t\)</span>, we obtain</p>
<p><span class="math display">\[
p(\gamma_t|\mathbf{\gamma}_{-t}) \propto
\begin{cases}
\exp\{-\frac{1}{2\sigma_w^2}(\gamma_t^2 - 2\gamma_t\gamma_{t+1})\}, &amp; t = 1\\
\exp\{-\frac{1}{2\sigma_w^2}(2\gamma_t^2 - 2\gamma_t\gamma_{t+1} - 2\gamma_{t-1}\gamma_t)\}, &amp; t = 2, 3, \dots, N_T-1 \\
\exp\{-\frac{1}{2\sigma_w^2}(\gamma_t^2 - 2\gamma_{t-1}\gamma_{t})\}, &amp; t = N_T
\end{cases}.
\]</span></p>
<p>The proportional form implies that these are Normal densities. By completing the square, we can obtain</p>
<p><span class="math display">\[
p(\gamma|\gamma_{-t}) \propto \begin{cases}
N(\gamma_{t+1}, \sigma_w^2), &amp; t = 1 \\
N(\frac{\gamma_{t-1}+\gamma_{t+1}}{2}, \sigma^2_w/2), &amp; t = 2, 3 \dots, N_T-1 \\
N(\gamma_{t-1}, \sigma_w^2), &amp; t = N_T
\end{cases},
\]</span>
as required. A necessary assumption for this conclusion was that <span class="math inline">\(p(\gamma_1) \propto 1\)</span>.
## Exercise 11.12 {-}</p>
<p>The joint density of <span class="math inline">\(\gamma_t\)</span> and <span class="math inline">\(\tau_w\)</span>, given <span class="math inline">\(\gamma_{t-1}\)</span> is given by
<span class="math display">\[
p(\gamma_t, \tau_w \mid \gamma_{t-1}) = \frac{\tau_w^{1/2}}{\sqrt{2\pi}}\exp \left(-\frac{\tau(\gamma_t - \gamma_{t-1})^2}{2} \right) \frac{b^a}{\Gamma(a)}\tau_w^{a-1}\exp(-b\tau_w).
\]</span>
Marginalizing <span class="math inline">\(\tau_w\)</span> gives
<span class="math display">\[
p(\gamma_t \mid \gamma_{t-1}) = \int_{0}^{\infty} \frac{\tau_2^{1/2}}{\sqrt{2\pi}}\exp \left(-\frac{\tau(\gamma_t - \gamma_{t-1})^2}{2} \right) \frac{b^a}{\Gamma(a)}\tau_w^{a-1}\exp(-b\tau_w) d\tau_w \\
= \frac{b^2}{\Gamma(a)\sqrt{2\pi}} \int_{0}^\infty \tau_w^{a-0.5} \exp \left(-\tau_w \left[ \frac{(\gamma_t - \gamma_{t-1})^2}{2} + b\right] \right) d\tau_w \\
= \frac{b^a \Gamma(a+0.5)}{\gamma(a)\sqrt{2\pi} ((\gamma_t - \gamma_{t-1})^2/2+b)^{a+0.5}} \int_{0}^\infty \frac{(\gamma_t - \gamma_{t-1})^2/2+b)^{a+0.5}}{\Gamma(a+0.5)} \tau_w^{(a +0.5) - 1} \exp\left( -\tau_w \left[ \frac{(\gamma_t - \gamma_{t-1})^2}{2} + b\right]\right)\\
= \frac{b^a \Gamma(a+0.5)}{\gamma(a)\sqrt{2\pi} ((\gamma_t - \gamma_{t-1})^2/2+b)^{a+0.5}},
\]</span>
where the last equality follows because the integrand was the density of a Gamma distribution. Now, by Bayes rule, we have the following expression for the posterior:
<span class="math display">\[
p(\tau_{w}|\gamma_t, \gamma_{t-1}) = \frac{p(\gamma_t, \tau_w \mid \gamma_{t-1})}{p(\gamma_t \mid \gamma_{t-1}) } = \frac{((\gamma_t - \gamma_{t-1})^2/2+b)^{a+0.5}}{\Gamma(a + 0.5)}\tau^{(a+0.5)-1} \exp \left(-\tau_w \left[\frac{(\gamma_t - \gamma_{t-1})^2}{2} + b \right] \right),
\]</span>
which is the density function of the <span class="math inline">\(Ga(a + 0.5, (\gamma_t - \gamma_{t-1})^2/2 + b)\)</span> distribution. The shape parameter of the posterior is the prior shape parameter shifted by <span class="math inline">\(0.5\)</span>, and the rate parameter is the prior rate parameter shifted by the term <span class="math inline">\((\gamma_t - \gamma_{t-1})^2/2\)</span>.</p>
</div>
<div id="exercise-11.13" class="section level2 unnumbered hasAnchor">
<h2>Exercise 11.13<a href="Time.html#exercise-11.13" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We use the <code>rjags</code> package here, as it most closely resembles WinBUGS, but is compatible with all operating systems.</p>
<div class="sourceCode" id="cb534"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb534-1"><a href="Time.html#cb534-1" tabindex="-1"></a><span class="fu">library</span>(rjags)</span></code></pre></div>
<pre><code>## Warning: package &#39;rjags&#39; was built under R version 4.2.3</code></pre>
<div class="sourceCode" id="cb536"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb536-1"><a href="Time.html#cb536-1" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div>
<div class="sourceCode" id="cb537"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb537-1"><a href="Time.html#cb537-1" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">source</span>(<span class="st">&quot;data/pm_london/pm10_London.txt&quot;</span>)</span>
<span id="cb537-2"><a href="Time.html#cb537-2" tabindex="-1"></a>inits1 <span class="ot">&lt;-</span> <span class="fu">source</span>(<span class="st">&quot;data/pm_london/11_13_model1_inits1.txt&quot;</span>)</span>
<span id="cb537-3"><a href="Time.html#cb537-3" tabindex="-1"></a>model_ar <span class="ot">&lt;-</span> <span class="fu">jags.model</span>(<span class="at">file =</span> <span class="st">&quot;data/pm_london/11_13_model1.txt&quot;</span>,</span>
<span id="cb537-4"><a href="Time.html#cb537-4" tabindex="-1"></a>                    <span class="at">data =</span> data<span class="sc">$</span>value,</span>
<span id="cb537-5"><a href="Time.html#cb537-5" tabindex="-1"></a>                    <span class="at">inits =</span> inits1<span class="sc">$</span>value,</span>
<span id="cb537-6"><a href="Time.html#cb537-6" tabindex="-1"></a>                    <span class="at">n.chains =</span> <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## Compiling model graph
##    Resolving undeclared variables
##    Allocating nodes
## Graph information:
##    Observed stochastic nodes: 1410
##    Unobserved stochastic nodes: 1514
##    Total graph size: 2934
## 
## Initializing model</code></pre>
<div class="sourceCode" id="cb539"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb539-1"><a href="Time.html#cb539-1" tabindex="-1"></a><span class="fu">update</span>(model_ar, <span class="dv">5000</span>) <span class="do">## burn in</span></span>
<span id="cb539-2"><a href="Time.html#cb539-2" tabindex="-1"></a>samples_sigmas <span class="ot">&lt;-</span> <span class="fu">coda.samples</span>(model_ar,</span>
<span id="cb539-3"><a href="Time.html#cb539-3" tabindex="-1"></a>                           <span class="at">variable.names =</span> <span class="fu">c</span>(</span>
<span id="cb539-4"><a href="Time.html#cb539-4" tabindex="-1"></a>                                              <span class="st">&quot;sigma.v&quot;</span>,</span>
<span id="cb539-5"><a href="Time.html#cb539-5" tabindex="-1"></a>                                              <span class="st">&quot;sigma.w&quot;</span></span>
<span id="cb539-6"><a href="Time.html#cb539-6" tabindex="-1"></a>                                              ),</span>
<span id="cb539-7"><a href="Time.html#cb539-7" tabindex="-1"></a>                           <span class="at">n.iter =</span> <span class="dv">2000</span>,</span>
<span id="cb539-8"><a href="Time.html#cb539-8" tabindex="-1"></a>                           <span class="at">thin =</span> <span class="dv">2</span>)</span>
<span id="cb539-9"><a href="Time.html#cb539-9" tabindex="-1"></a><span class="fu">plot</span>(samples_sigmas)</span></code></pre></div>
<p><img src="_main_files/figure-html/Exercise%2011.13-1.png" width="672" /></p>
<div class="sourceCode" id="cb540"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb540-1"><a href="Time.html#cb540-1" tabindex="-1"></a><span class="fu">apply</span>(samples_sigmas[[<span class="dv">1</span>]], <span class="dv">2</span>, quantile)</span></code></pre></div>
<pre><code>##          sigma.v   sigma.w
## 0%   0.009440187 0.3604371
## 25%  0.010027101 0.4239586
## 50%  0.010254047 0.4472214
## 75%  0.010486342 0.4706450
## 100% 0.011485331 0.6060564</code></pre>
<div class="sourceCode" id="cb542"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb542-1"><a href="Time.html#cb542-1" tabindex="-1"></a>samples_gamma <span class="ot">&lt;-</span> <span class="fu">coda.samples</span>(model_ar,</span>
<span id="cb542-2"><a href="Time.html#cb542-2" tabindex="-1"></a>                              <span class="at">variable.names =</span> <span class="fu">c</span>(</span>
<span id="cb542-3"><a href="Time.html#cb542-3" tabindex="-1"></a>                                <span class="st">&quot;gamma&quot;</span>,</span>
<span id="cb542-4"><a href="Time.html#cb542-4" tabindex="-1"></a>                                <span class="st">&quot;y&quot;</span></span>
<span id="cb542-5"><a href="Time.html#cb542-5" tabindex="-1"></a>                              ),</span>
<span id="cb542-6"><a href="Time.html#cb542-6" tabindex="-1"></a>                              <span class="at">n.iter =</span> <span class="dv">2000</span>,</span>
<span id="cb542-7"><a href="Time.html#cb542-7" tabindex="-1"></a>                              <span class="at">thin =</span> <span class="dv">1</span>)</span>
<span id="cb542-8"><a href="Time.html#cb542-8" tabindex="-1"></a>missings <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(data<span class="sc">$</span>value<span class="sc">$</span>y))</span>
<span id="cb542-9"><a href="Time.html#cb542-9" tabindex="-1"></a>nonmissing <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">var =</span> <span class="st">&quot;y&quot;</span>, <span class="at">time =</span> <span class="fu">as.double</span>(<span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(data<span class="sc">$</span>value<span class="sc">$</span>y))),</span>
<span id="cb542-10"><a href="Time.html#cb542-10" tabindex="-1"></a>                         <span class="at">value =</span> data<span class="sc">$</span>value<span class="sc">$</span>y) <span class="sc">|&gt;</span></span>
<span id="cb542-11"><a href="Time.html#cb542-11" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(time <span class="sc">%in%</span> missings))</span>
<span id="cb542-12"><a href="Time.html#cb542-12" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(samples_gamma[[<span class="dv">1</span>]])</span>
<span id="cb542-13"><a href="Time.html#cb542-13" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> plot_df <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb542-14"><a href="Time.html#cb542-14" tabindex="-1"></a>                                   <span class="at">names_to =</span> <span class="st">&quot;variable&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb542-15"><a href="Time.html#cb542-15" tabindex="-1"></a>  <span class="fu">separate</span>(variable, <span class="fu">c</span>(<span class="st">&quot;var&quot;</span>, <span class="st">&quot;time&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb542-16"><a href="Time.html#cb542-16" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(time)) <span class="sc">|&gt;</span></span>
<span id="cb542-17"><a href="Time.html#cb542-17" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(var <span class="sc">==</span> <span class="st">&quot;y&quot;</span> <span class="sc">&amp;</span> <span class="sc">!</span>(time <span class="sc">%in%</span> missings))) <span class="sc">|&gt;</span></span>
<span id="cb542-18"><a href="Time.html#cb542-18" tabindex="-1"></a>  <span class="fu">rbind</span>(nonmissing) <span class="sc">|&gt;</span></span>
<span id="cb542-19"><a href="Time.html#cb542-19" tabindex="-1"></a>  <span class="fu">group_by</span>(var, time) <span class="sc">|&gt;</span></span>
<span id="cb542-20"><a href="Time.html#cb542-20" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">q025 =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb542-21"><a href="Time.html#cb542-21" tabindex="-1"></a>            <span class="at">q975 =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.975</span>),</span>
<span id="cb542-22"><a href="Time.html#cb542-22" tabindex="-1"></a>            <span class="at">median =</span> <span class="fu">median</span>(value))<span class="sc">|&gt;</span></span>
<span id="cb542-23"><a href="Time.html#cb542-23" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">range =</span> q975<span class="sc">-</span>q025)</span></code></pre></div>
<pre><code>## Warning: Expected 2 pieces. Additional pieces discarded in 5844000 rows [1, 2,
## 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, ...].</code></pre>
<pre><code>## `summarise()` has grouped output by &#39;var&#39;. You
## can override using the `.groups` argument.</code></pre>
<div class="sourceCode" id="cb545"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb545-1"><a href="Time.html#cb545-1" tabindex="-1"></a>plot_scatter_df <span class="ot">&lt;-</span> plot_df <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(var, time, median) <span class="sc">|&gt;</span></span>
<span id="cb545-2"><a href="Time.html#cb545-2" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> var, <span class="at">values_from =</span> median)</span>
<span id="cb545-3"><a href="Time.html#cb545-3" tabindex="-1"></a>plot_scatter <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_scatter_df, <span class="fu">aes</span>(<span class="at">x =</span> y, <span class="at">y =</span> gamma)) <span class="sc">+</span></span>
<span id="cb545-4"><a href="Time.html#cb545-4" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>)</span>
<span id="cb545-5"><a href="Time.html#cb545-5" tabindex="-1"></a>plot_scatter</span></code></pre></div>
<p><img src="_main_files/figure-html/Exercise%2011.13-2.png" width="672" /></p>
<div class="sourceCode" id="cb546"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb546-1"><a href="Time.html#cb546-1" tabindex="-1"></a>plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">filter</span>(plot_df, var <span class="sc">==</span> <span class="st">&quot;gamma&quot;</span>), <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb546-2"><a href="Time.html#cb546-2" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> median), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb546-3"><a href="Time.html#cb546-3" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> q025), <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>)<span class="sc">+</span></span>
<span id="cb546-4"><a href="Time.html#cb546-4" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> q975), <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>)<span class="sc">+</span></span>
<span id="cb546-5"><a href="Time.html#cb546-5" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_df, (var <span class="sc">==</span> <span class="st">&quot;y&quot;</span> <span class="sc">&amp;</span> time <span class="sc">%in%</span> missings)),</span>
<span id="cb546-6"><a href="Time.html#cb546-6" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> <span class="dv">0</span>), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>)</span>
<span id="cb546-7"><a href="Time.html#cb546-7" tabindex="-1"></a>plot</span></code></pre></div>
<p><img src="_main_files/figure-html/Exercise%2011.13-3.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="hazards.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="exposure.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/11-Chpt11.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
