<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 The challenges of working with real-world data | Spatio-Temporal Methods in Environmental Epidemiology with R. Second Edition</title>
  <meta name="description" content="Chapter 8 The challenges of working with real-world data | Spatio-Temporal Methods in Environmental Epidemiology with R. Second Edition" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 The challenges of working with real-world data | Spatio-Temporal Methods in Environmental Epidemiology with R. Second Edition" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/img/cover.jpg" />
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 The challenges of working with real-world data | Spatio-Temporal Methods in Environmental Epidemiology with R. Second Edition" />
  
  
  <meta name="twitter:image" content="/img/cover.jpg" />

<meta name="author" content="Gavin Shaddick, James V. Zidek, and Alexandra M. Schmidt" />


<meta name="date" content="2023-08-18" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<link rel="prev" href="Strategies.html"/>
<link rel="next" href="Disease.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatio-temporal methods in environmental epidemiology</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="preface-to-second-edition.html"><a href="preface-to-second-edition.html"><i class="fa fa-check"></i>PREFACE TO SECOND EDITION</a></li>
<li class="chapter" data-level="1" data-path="why.html"><a href="why.html"><i class="fa fa-check"></i><b>1</b> An overview of spatio-temporal epidemiology and knowledge discovery?</a></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> An introduction to modelling health risks and impacts</a>
<ul>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.7-estimating-the-smr-using-a-poisson-glm"><i class="fa fa-check"></i>Example 2.7: Estimating the SMR using a Poisson GLM</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.8-estimating-the-smr-using-quasi-likelihood"><i class="fa fa-check"></i>Example 2.8: Estimating the SMR using quasi-likelihood</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.9-modelling-differences-in-smrs-in-relation-to-differences-in-exposures"><i class="fa fa-check"></i>Example 2.9: Modelling differences in SMRs in relation to differences in exposures</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.10-modelling-the-risks-associated-with-lagged-effects-of-air-pollution"><i class="fa fa-check"></i>Example 2.10: Modelling the risks associated with lagged effects of air pollution</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.10-estimating-the-odds-ratio-in-a-case-control-study-using-a-logistic-model"><i class="fa fa-check"></i>Example 2.10: Estimating the odds ratio in a case-control study using a logistic model</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.11-estimating-the-odds-ratio-of-asthma-associated-with-proximity-to-roads"><i class="fa fa-check"></i>Example 2.11: Estimating the odds ratio of asthma associated with proximity to roads</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="uncertainty.html"><a href="uncertainty.html"><i class="fa fa-check"></i><b>3</b> The importance of uncertainty: assessment and quantification</a>
<ul>
<li class="chapter" data-level="" data-path="uncertainty.html"><a href="uncertainty.html#supplementary-material"><i class="fa fa-check"></i>Supplementary Material</a>
<ul>
<li class="chapter" data-level="" data-path="uncertainty.html"><a href="uncertainty.html#more-on-qualitative-uncertainty"><i class="fa fa-check"></i>More on qualitative uncertainty</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>4</b> Extracting information from data</a>
<ul>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#getting-to-know-the-structure-of-dataframes"><i class="fa fa-check"></i>Getting to know the structure of dataframes</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#extracting-and-creating-variables"><i class="fa fa-check"></i>Extracting and creating variables</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#simple-manipulations-using-tidyverse"><i class="fa fa-check"></i>Simple manipulations using Tidyverse</a>
<ul>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#filter-rows-in-tidyverse"><i class="fa fa-check"></i>Filter rows in Tidyverse</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#sorting-rows-in-tidyverse"><i class="fa fa-check"></i>Sorting rows in Tidyverse</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#select-columns-in-tidyverse"><i class="fa fa-check"></i>Select columns in Tidyverse</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#adding-columns"><i class="fa fa-check"></i>Adding columns</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#pipes"><i class="fa fa-check"></i>Pipes</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#chaining-pipes"><i class="fa fa-check"></i>Chaining pipes</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#grouping-and-summarizing"><i class="fa fa-check"></i>Grouping and summarizing</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#summarize"><i class="fa fa-check"></i>Summarize</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#example-4.1-health-impacts-associated-with-outdoor-air-pollution"><i class="fa fa-check"></i>Example 4.1: Health impacts associated with outdoor air pollution</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#example-4.3.-mapping-cancer-incidence-in-southern-and-eastern-serbia"><i class="fa fa-check"></i>Example 4.3. Mapping cancer incidence in Southern and Eastern Serbia</a>
<ul>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#creating-maps-of-southern-and-eastern-serbia"><i class="fa fa-check"></i>Creating maps of Southern and Eastern Serbia</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#example-4.4-cancer-in-bor"><i class="fa fa-check"></i>Example 4.4 Cancer in Bor</a></li>
<li class="chapter" data-level="" data-path="data.html"><a href="data.html#calculating-smrs"><i class="fa fa-check"></i>Calculating SMRs</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="embracing.html"><a href="embracing.html"><i class="fa fa-check"></i><b>5</b> Embracing uncertainty: the Bayesian approach</a></li>
<li class="chapter" data-level="6" data-path="computation.html"><a href="computation.html"><i class="fa fa-check"></i><b>6</b> Approaches to Bayesian Computation</a>
<ul>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#example-6.2-gibbs-sampling-with-a-poisson-gamma-model---hospital-admissions-for-chronic-obstructive-pulmonary-disease-copd-for-england-between-2001-2010"><i class="fa fa-check"></i>Example 6.2: Gibbs sampling with a Poisson-Gamma model - hospital admissions for chronic obstructive pulmonary disease (COPD) for England between 2001-2010</a>
<ul>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#modelling-the-raw-standardized-mortality-rates-smrs"><i class="fa fa-check"></i>Modelling the raw standardized mortality rates (SMRs)</a></li>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#mcmc-implementation-of-the-poisson-gamma-model-in-r"><i class="fa fa-check"></i>MCMC implementation of the Poisson-Gamma model in <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#code-for-the-poisson-gamma-model-in-nimble"><i class="fa fa-check"></i>Code for the Poisson-Gamma model in Nimble</a></li>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#example-6.3-fitting-a-poisson-regression-model"><i class="fa fa-check"></i>Example 6.3: Fitting a Poisson regression model</a>
<ul>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#nimble"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="computation.html"><a href="computation.html#stan"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Strategies.html"><a href="Strategies.html"><i class="fa fa-check"></i><b>7</b> Strategies for modelling</a>
<ul>
<li class="chapter" data-level="" data-path="Strategies.html"><a href="Strategies.html#example-7.6-variable-selection-in-land-use-regression-using-lasso-and-horseshoe-priors"><i class="fa fa-check"></i>Example 7.6 Variable selection in land use regression using lasso and horseshoe priors</a>
<ul>
<li class="chapter" data-level="" data-path="Strategies.html"><a href="Strategies.html#nimble-1"><i class="fa fa-check"></i>Nimble</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="trusted.html"><a href="trusted.html"><i class="fa fa-check"></i><b>8</b> The challenges of working with real-world data</a>
<ul>
<li class="chapter" data-level="" data-path="trusted.html"><a href="trusted.html#solutions-to-selected-exercises"><i class="fa fa-check"></i>Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="trusted.html"><a href="trusted.html#placeholder-repeat-the-black-smoke-analysis-conducted-in-watson-et-al.-2019.-in-the-naive-model."><i class="fa fa-check"></i>PLACEHOLDER: Repeat the Black Smoke analysis conducted in Watson et al. 2019. in the “naive” model.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="Disease.html"><a href="Disease.html"><i class="fa fa-check"></i><b>9</b> Disease-spatial patterns</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010"><i class="fa fa-check"></i>Example 9.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-2"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-1"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-stan"><i class="fa fa-check"></i>Example 9.3: Fitting a conditional spatial model in <code>nimble</code> and <code>stan</code></a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-3"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-2"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.4-fitting-a-conditional-spatial-model-using-carbayes"><i class="fa fa-check"></i>Example 9.4: Fitting a conditional spatial model using CARBayes</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.5-fitting-a-conditional-model-using-inla"><i class="fa fa-check"></i>Example 9.5: Fitting a conditional model using INLA</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="hazards.html"><a href="hazards.html"><i class="fa fa-check"></i><b>10</b> Environmental hazards-spatial models</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.1-spatial-patterns-in-lead-concentrations-in-the-soil-of-the-meuse-river-flood-plain"><i class="fa fa-check"></i>Example 10.1 Spatial patterns in lead concentrations in the soil of the Meuse River flood plain</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.2-examining-the-log-concentrations-of-lead-in-the-meuse-river-flood-plain"><i class="fa fa-check"></i>Example 10.2: Examining the log concentrations of lead in the Meuse River flood plain</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state"><i class="fa fa-check"></i>Example 10.3: Mapping the locations of ozone monitoring sites in New York State</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.6-spatial-prediction-of-temperatures-in-california"><i class="fa fa-check"></i>Example 10.6: Spatial prediction of temperatures in California</a></li>
<li class="chapter" data-level="10.1" data-path="hazards.html"><a href="hazards.html#example-10.8-spatial-prediction-of-no2-in-europe"><i class="fa fa-check"></i><b>10.1</b> Example 10.8 Spatial prediction of NO2 in Europe</a></li>
<li class="chapter" data-level="10.2" data-path="hazards.html"><a href="hazards.html#example-10.12-plotting-directional-variograms-for-temperatures-in-california"><i class="fa fa-check"></i><b>10.2</b> Example 10.12 Plotting directional variograms for temperatures in California</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.14-spatial-modeling-of-malaria-in-gambia"><i class="fa fa-check"></i>Example 10.14: Spatial modeling of malaria in Gambia</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-4"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-3"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#supplementary-material-1"><i class="fa fa-check"></i>Supplementary Material</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada"><i class="fa fa-check"></i>Extra 10.1: Spatial patterns of benzene concentrations in Montreal, QC, Canada</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.2-examining-the-log-concentrations-of-benzene-in-montreal"><i class="fa fa-check"></i>Extra 10.2: Examining the log concentrations of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.5-variogram"><i class="fa fa-check"></i>Extra 10.5: Variogram</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal"><i class="fa fa-check"></i>Extra 10.6 Basic spatial modelling and prediction of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.8-spatial-modelling-of-benzene-in-montreal"><i class="fa fa-check"></i>Extra 10.8 Spatial modelling of Benzene in Montreal</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-5"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-4"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.9-spatial-predictions"><i class="fa fa-check"></i>Extra 10.9: Spatial predictions</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-6"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-5"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.10-inla-creating-a-mesh"><i class="fa fa-check"></i>Extra 10.10: INLA, creating a mesh</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal"><i class="fa fa-check"></i>Extra 10.12: Fitting an SPDE model using R–INLA: benzene concentration in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#extra-10.13-directional-variograms"><i class="fa fa-check"></i>Extra 10.13: Directional variograms</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="Time.html"><a href="Time.html"><i class="fa fa-check"></i><b>11</b> Time-why it also matters</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.1-ground-level-ozone-concentrations"><i class="fa fa-check"></i>Example 11.1 Ground level ozone concentrations</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.2-low-pass-filtering-of-carbon-monoxide-levels-using-the-moving-average"><i class="fa fa-check"></i>Example 11.2 Low-pass filtering of carbon monoxide levels using the moving average</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.13-forecasting-ozone-levels"><i class="fa fa-check"></i>Example 11.13 Forecasting ozone levels</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.14-forecasting-volcanic-ash"><i class="fa fa-check"></i>Example 11.14 Forecasting volcanic ash</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="exposure.html"><a href="exposure.html"><i class="fa fa-check"></i><b>12</b> Exposure assessment-over space and time</a>
<ul>
<li class="chapter" data-level="" data-path="exposure.html"><a href="exposure.html#example-idk-spatio-temporal-model-for-the-uk-ozone-data"><i class="fa fa-check"></i>Example IDK: Spatio-temporal model for the UK ozone data</a>
<ul>
<li class="chapter" data-level="" data-path="exposure.html"><a href="exposure.html#nimble-7"><i class="fa fa-check"></i>Nimble</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="causality.html"><a href="causality.html"><i class="fa fa-check"></i><b>13</b> Causality-roadblocks on the way to it</a>
<ul>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#solutions-to-selected-exercises-1"><i class="fa fa-check"></i>Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.16-load-the-italy-and-china-data-described-in-example-13.3-and-included-in-the-supplementary-bookdown-material-into-r."><i class="fa fa-check"></i>Question 13.16: Load the Italy and China data, described in Example 13.3, and included in the supplementary Bookdown material into R.</a></li>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.17-using-the-italy-and-china-data-stratified-by-the-age-groups-70-and-geq-70-obtain-empirical-estimates-of-p_1-and-p_2-as-defined-in-an-sdis.-in-the-following-questions-assume-that-p_1-and-p_2-are-the-population-values."><i class="fa fa-check"></i>Question 13.17: Using the Italy and China data stratified by the age groups <span class="math inline">\(&lt;70\)</span> and <span class="math inline">\(\geq 70\)</span>, obtain empirical estimates of <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span>, as defined in an SDis. In the following questions, assume that <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> are the population values.</a></li>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.18-stratify-the-italy-and-china-data-by-the-age-groups-50-and-geq-50.-display-the-corresponding-contingency-tables."><i class="fa fa-check"></i>Question 13.18: Stratify the Italy and China data by the age groups <span class="math inline">\(&lt;50\)</span> and <span class="math inline">\(\geq 50\)</span>. Display the corresponding contingency tables.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="monitoring.html"><a href="monitoring.html"><i class="fa fa-check"></i><b>14</b> Better monitoring network design-getting better measurements</a></li>
<li class="chapter" data-level="15" data-path="frontiers.html"><a href="frontiers.html"><i class="fa fa-check"></i><b>15</b> Current frontiers</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html"><i class="fa fa-check"></i>Course</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatio-Temporal Methods in Environmental Epidemiology with R. Second Edition</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="trusted" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">Chapter 8</span> The challenges of working with real-world data<a href="trusted.html#trusted" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter considers some of the issues that will arise when dealing with ‘real data’. Data will commonly have missing
values and may be measured with error. This error might be random or may be due to systematic patterns in how it was
collected. From this chapter, the reader will have gained an understanding of the following topics:</p>
<ul>
<li>Classification of missing values into missing at random or not at random.</li>
<li>Methods for imputing missing values.</li>
<li>Various measurement models including classical and Berkson.</li>
<li>The attenuation of regression coefficients under measurement error.</li>
<li>Preferential sampling, where the process that determines the locations of monitoring sites and the process being modelled are in some ways dependent.</li>
<li>How preferential sampling can bias the measurements that arise from environmental monitoring networks</li>
</ul>
<div id="solutions-to-selected-exercises" class="section level2 unnumbered hasAnchor">
<h2>Solutions to Selected Exercises<a href="trusted.html#solutions-to-selected-exercises" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="placeholder-repeat-the-black-smoke-analysis-conducted-in-watson-et-al.-2019.-in-the-naive-model." class="section level3 unnumbered hasAnchor">
<h3>PLACEHOLDER: Repeat the Black Smoke analysis conducted in Watson et al. 2019. in the “naive” model.<a href="trusted.html#placeholder-repeat-the-black-smoke-analysis-conducted-in-watson-et-al.-2019.-in-the-naive-model." class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If INLA is not already installed, it needs to be done manually (<a href="https://www.r-inla.org/download-install" class="uri">https://www.r-inla.org/download-install</a>):</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="trusted.html#cb200-1" tabindex="-1"></a><span class="fu">install.packages</span>(</span>
<span id="cb200-2"><a href="trusted.html#cb200-2" tabindex="-1"></a>  <span class="st">&quot;INLA&quot;</span>,</span>
<span id="cb200-3"><a href="trusted.html#cb200-3" tabindex="-1"></a>  <span class="at">repos =</span> <span class="fu">c</span>(<span class="fu">getOption</span>(<span class="st">&quot;repos&quot;</span>), <span class="at">INLA =</span> <span class="st">&quot;https://inla.r-inla-download.org/R/stable&quot;</span>),</span>
<span id="cb200-4"><a href="trusted.html#cb200-4" tabindex="-1"></a>  <span class="at">dep =</span> <span class="cn">TRUE</span></span>
<span id="cb200-5"><a href="trusted.html#cb200-5" tabindex="-1"></a>)</span></code></pre></div>
<p>After INLA is installed load all the necessary packages.</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="trusted.html#cb201-1" tabindex="-1"></a><span class="fu">library</span>(INLA)</span></code></pre></div>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## 
## Attaching package: &#39;Matrix&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:tidyr&#39;:
## 
##     expand, pack, unpack</code></pre>
<pre><code>## Loading required package: foreach</code></pre>
<pre><code>## 
## Attaching package: &#39;foreach&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:purrr&#39;:
## 
##     accumulate, when</code></pre>
<pre><code>## Loading required package: parallel</code></pre>
<pre><code>## This is INLA_22.12.16 built 2022-12-23 13:24:10 UTC.
##  - See www.r-inla.org/contact-us for how to get help.</code></pre>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="trusted.html#cb210-1" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span>
<span id="cb210-2"><a href="trusted.html#cb210-2" tabindex="-1"></a><span class="fu">library</span>(boot)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;boot&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:nimble&#39;:
## 
##     logit</code></pre>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="trusted.html#cb213-1" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb213-2"><a href="trusted.html#cb213-2" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;reshape2&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:tidyr&#39;:
## 
##     smiths</code></pre>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="trusted.html#cb216-1" tabindex="-1"></a><span class="fu">library</span>(sp)</span>
<span id="cb216-2"><a href="trusted.html#cb216-2" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code></pre></div>
<p>This example uses the <a href="https://github.com/spacetime-environ/stepi2/blob/main/data/black_smoke/BlackSmokePrefData.csv">BlackSmokePrefData.csv</a> file.</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="trusted.html#cb217-1" tabindex="-1"></a>BlackSmokePrefData <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/black_smoke/BlackSmokePrefData.csv&quot;</span>)</span>
<span id="cb217-2"><a href="trusted.html#cb217-2" tabindex="-1"></a></span>
<span id="cb217-3"><a href="trusted.html#cb217-3" tabindex="-1"></a><span class="fu">head</span>(BlackSmokePrefData)</span></code></pre></div>
<pre><code>##           site   east  north AMEAN66 AMEAN67 AMEAN68 AMEAN69 AMEAN70 AMEAN71
## 1 ADDLESTONE 1 505200 164600      92     103      68      47      47      45
## 2   BARNSLEY 8 434800 409400      NA      NA      NA      NA      NA      NA
## 3   BARNSLEY 9 437000 405500      NA      NA      NA      NA      NA      NA
## 4    BOLTON 24 371500 409200     132     108      75      77      78      74
## 5   BRADFORD 6 416300 432900     202     151     122     110      90     118
## 6   CARDIFF 12 319300 177300      NA      NA      NA      NA      NA      NA
##   AMEAN72 AMEAN73 AMEAN74 AMEAN75 AMEAN76 AMEAN77 AMEAN78 AMEAN79 AMEAN80
## 1      52      41      36      31      33      24      20      17      11
## 2      NA      NA      NA      NA      NA      NA      NA      NA      NA
## 3      NA      NA      NA      NA      23      18      19      19      12
## 4     149     137      NA      NA      NA      NA      NA      NA      NA
## 5     172     191      74      NA      NA      NA      NA      NA      NA
## 6      NA      NA      NA      NA      NA      NA      24      19      12
##   AMEAN81 AMEAN82 AMEAN83 AMEAN84 AMEAN85 AMEAN86 AMEAN87 AMEAN88 AMEAN89
## 1      15       9       8      15      12      10      13       7       9
## 2      NA      NA      NA      NA      NA      NA      NA      NA      NA
## 3      19      NA      NA      NA      NA      NA      NA      NA      NA
## 4      NA      NA      NA      NA      NA      NA      NA      NA      NA
## 5      NA      NA      NA      NA      NA      NA      NA      NA      NA
## 6      10      11      16      19      18      14      11       9      11
##   AMEAN90 AMEAN91 AMEAN92 AMEAN93 AMEAN94 AMEAN95 AMEAN96
## 1      11       6      NA      NA      NA      NA      NA
## 2      NA      13       6      11       6       6       5
## 3      NA      NA      NA      NA      NA      NA      NA
## 4      NA      NA      NA      NA      NA      NA      NA
## 5      NA      NA      NA      NA      NA      NA      NA
## 6      12      12       9      11       9      19      11</code></pre>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="trusted.html#cb219-1" tabindex="-1"></a><span class="do">## standardize location coordinates</span></span>
<span id="cb219-2"><a href="trusted.html#cb219-2" tabindex="-1"></a></span>
<span id="cb219-3"><a href="trusted.html#cb219-3" tabindex="-1"></a>sd_x <span class="ot">&lt;-</span> <span class="fu">sd</span>(BlackSmokePrefData[, <span class="fu">c</span>(<span class="dv">2</span>)])</span>
<span id="cb219-4"><a href="trusted.html#cb219-4" tabindex="-1"></a>sd_y <span class="ot">&lt;-</span> <span class="fu">sd</span>(BlackSmokePrefData[, <span class="fu">c</span>(<span class="dv">3</span>)])</span>
<span id="cb219-5"><a href="trusted.html#cb219-5" tabindex="-1"></a></span>
<span id="cb219-6"><a href="trusted.html#cb219-6" tabindex="-1"></a>BlackSmokePrefData[, <span class="dv">2</span>] <span class="ot">&lt;-</span> BlackSmokePrefData[, <span class="dv">2</span>] <span class="sc">/</span> sd_x</span>
<span id="cb219-7"><a href="trusted.html#cb219-7" tabindex="-1"></a>BlackSmokePrefData[, <span class="dv">3</span>] <span class="ot">&lt;-</span> BlackSmokePrefData[, <span class="dv">3</span>] <span class="sc">/</span> sd_y </span></code></pre></div>
<p>We need to reshape the data to have one observation per row, as required by INLA.</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="trusted.html#cb220-1" tabindex="-1"></a>yearmeans <span class="ot">=</span> <span class="fu">colMeans</span>(BlackSmokePrefData[, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)], <span class="at">na.rm =</span> T)  <span class="do">## save means for each year</span></span>
<span id="cb220-2"><a href="trusted.html#cb220-2" tabindex="-1"></a></span>
<span id="cb220-3"><a href="trusted.html#cb220-3" tabindex="-1"></a>BlackSmokePrefData <span class="ot">&lt;-</span></span>
<span id="cb220-4"><a href="trusted.html#cb220-4" tabindex="-1"></a>  <span class="fu">melt</span>(</span>
<span id="cb220-5"><a href="trusted.html#cb220-5" tabindex="-1"></a>    BlackSmokePrefData,</span>
<span id="cb220-6"><a href="trusted.html#cb220-6" tabindex="-1"></a>    <span class="at">id.vars =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb220-7"><a href="trusted.html#cb220-7" tabindex="-1"></a>    <span class="at">variable.name =</span> <span class="st">&#39;year&#39;</span>,</span>
<span id="cb220-8"><a href="trusted.html#cb220-8" tabindex="-1"></a>    <span class="at">value.name =</span> <span class="st">&#39;bsmoke&#39;</span></span>
<span id="cb220-9"><a href="trusted.html#cb220-9" tabindex="-1"></a>  )</span>
<span id="cb220-10"><a href="trusted.html#cb220-10" tabindex="-1"></a>BlackSmokePrefData<span class="sc">$</span>year <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(<span class="fu">factor</span>(BlackSmokePrefData<span class="sc">$</span>year, <span class="at">labels =</span></span>
<span id="cb220-11"><a href="trusted.html#cb220-11" tabindex="-1"></a>                                                           <span class="dv">66</span><span class="sc">:</span><span class="dv">96</span>)))</span>
<span id="cb220-12"><a href="trusted.html#cb220-12" tabindex="-1"></a><span class="do">## standardize by mean of mean of each year to make it unitless</span></span>
<span id="cb220-13"><a href="trusted.html#cb220-13" tabindex="-1"></a>BlackSmokePrefData<span class="sc">$</span>bsmoke <span class="ot">=</span> BlackSmokePrefData<span class="sc">$</span>bsmoke <span class="sc">/</span> <span class="fu">mean</span>(yearmeans)</span>
<span id="cb220-14"><a href="trusted.html#cb220-14" tabindex="-1"></a><span class="do">## log-transform to eliminate right skew</span></span>
<span id="cb220-15"><a href="trusted.html#cb220-15" tabindex="-1"></a>BlackSmokePrefData<span class="sc">$</span>bsmoke <span class="ot">=</span> <span class="fu">log</span>(BlackSmokePrefData<span class="sc">$</span>bsmoke)</span></code></pre></div>
<p>Producing the 2-d mesh of the UK:</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="trusted.html#cb221-1" tabindex="-1"></a>no_sites <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">length</span>(<span class="fu">unique</span>(BlackSmokePrefData<span class="sc">$</span>site))) <span class="co"># number of sites</span></span>
<span id="cb221-2"><a href="trusted.html#cb221-2" tabindex="-1"></a>no_T <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">length</span>(<span class="fu">unique</span>(BlackSmokePrefData<span class="sc">$</span>year))) <span class="co"># number of years</span></span>
<span id="cb221-3"><a href="trusted.html#cb221-3" tabindex="-1"></a></span>
<span id="cb221-4"><a href="trusted.html#cb221-4" tabindex="-1"></a>ncol <span class="ot">=</span> <span class="dv">100</span> <span class="co"># grid for projection</span></span>
<span id="cb221-5"><a href="trusted.html#cb221-5" tabindex="-1"></a>nrow <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb221-6"><a href="trusted.html#cb221-6" tabindex="-1"></a>L <span class="ot">=</span> nrow <span class="sc">*</span> ncol <span class="co"># number of grid sites</span></span>
<span id="cb221-7"><a href="trusted.html#cb221-7" tabindex="-1"></a></span>
<span id="cb221-8"><a href="trusted.html#cb221-8" tabindex="-1"></a><span class="co"># Form the regular mesh #</span></span>
<span id="cb221-9"><a href="trusted.html#cb221-9" tabindex="-1"></a><span class="co"># Create a rough convex boundary for the UK #</span></span>
<span id="cb221-10"><a href="trusted.html#cb221-10" tabindex="-1"></a><span class="co"># Form the grid independently from the sites to avoid preferential grid selection #</span></span>
<span id="cb221-11"><a href="trusted.html#cb221-11" tabindex="-1"></a>UK_domain <span class="ot">=</span> <span class="fu">cbind</span>(<span class="fu">c</span>(<span class="dv">2</span>, <span class="fl">7.7</span>, <span class="fl">7.7</span>, <span class="dv">6</span>, <span class="dv">4</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="dv">6</span>, <span class="fl">13.5</span>, <span class="fl">13.5</span>, <span class="dv">12</span>))</span>
<span id="cb221-12"><a href="trusted.html#cb221-12" tabindex="-1"></a>hull <span class="ot">=</span> <span class="fu">inla.nonconvex.hull</span>(<span class="fu">cbind</span>(BlackSmokePrefData<span class="sc">$</span>east, BlackSmokePrefData<span class="sc">$</span>north))</span>
<span id="cb221-13"><a href="trusted.html#cb221-13" tabindex="-1"></a></span>
<span id="cb221-14"><a href="trusted.html#cb221-14" tabindex="-1"></a>cutoff_dist <span class="ot">=</span> <span class="dv">16000</span> <span class="sc">/</span> sd_x <span class="co"># 16km as min edge</span></span>
<span id="cb221-15"><a href="trusted.html#cb221-15" tabindex="-1"></a>max.edge <span class="ot">=</span> <span class="dv">100000</span> <span class="sc">/</span> sd_x <span class="co"># 100km max edge as in Shaddick and Zidek</span></span>
<span id="cb221-16"><a href="trusted.html#cb221-16" tabindex="-1"></a></span>
<span id="cb221-17"><a href="trusted.html#cb221-17" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: JOHNNY, I HAD TO COMMENT THE CUTOFF VARIABLE CAUSE OTHERWISE IT WOULDN&#39;T WORK</span></span>
<span id="cb221-18"><a href="trusted.html#cb221-18" tabindex="-1"></a></span>
<span id="cb221-19"><a href="trusted.html#cb221-19" tabindex="-1"></a>mesh <span class="ot">=</span> <span class="fu">inla.mesh.2d</span>(</span>
<span id="cb221-20"><a href="trusted.html#cb221-20" tabindex="-1"></a>  <span class="at">loc =</span> <span class="fu">cbind</span>(BlackSmokePrefData<span class="sc">$</span>east, BlackSmokePrefData<span class="sc">$</span>north),</span>
<span id="cb221-21"><a href="trusted.html#cb221-21" tabindex="-1"></a>  <span class="at">boundary =</span> hull,</span>
<span id="cb221-22"><a href="trusted.html#cb221-22" tabindex="-1"></a>  <span class="at">offset =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.2</span>),</span>
<span id="cb221-23"><a href="trusted.html#cb221-23" tabindex="-1"></a>  <span class="at">max.edge =</span> <span class="fu">c</span>(cutoff_dist, <span class="fl">0.5</span>),</span>
<span id="cb221-24"><a href="trusted.html#cb221-24" tabindex="-1"></a>  <span class="co">#cutoff = c(cutoff_dist, 1),</span></span>
<span id="cb221-25"><a href="trusted.html#cb221-25" tabindex="-1"></a>  <span class="at">min.angle =</span> <span class="dv">26</span></span>
<span id="cb221-26"><a href="trusted.html#cb221-26" tabindex="-1"></a>)</span>
<span id="cb221-27"><a href="trusted.html#cb221-27" tabindex="-1"></a></span>
<span id="cb221-28"><a href="trusted.html#cb221-28" tabindex="-1"></a><span class="fu">plot</span>(mesh)</span>
<span id="cb221-29"><a href="trusted.html#cb221-29" tabindex="-1"></a><span class="fu">points</span>(BlackSmokePrefData<span class="sc">$</span>east, BlackSmokePrefData<span class="sc">$</span>north, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Exercise%20mesh%20analysis-1.png" width="672" /></p>
<p>Now we define and fit our INLA model.</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="trusted.html#cb222-1" tabindex="-1"></a>spde_obj <span class="ot">=</span> <span class="fu">inla.spde2.pcmatern</span>(</span>
<span id="cb222-2"><a href="trusted.html#cb222-2" tabindex="-1"></a>  <span class="at">mesh =</span> mesh,</span>
<span id="cb222-3"><a href="trusted.html#cb222-3" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="dv">2</span>,</span>
<span id="cb222-4"><a href="trusted.html#cb222-4" tabindex="-1"></a>  <span class="at">prior.range =</span> <span class="fu">c</span>(<span class="fl">0.04</span>, <span class="fl">0.05</span>),</span>
<span id="cb222-5"><a href="trusted.html#cb222-5" tabindex="-1"></a>  <span class="at">prior.sigma =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.01</span>),</span>
<span id="cb222-6"><a href="trusted.html#cb222-6" tabindex="-1"></a>  <span class="at">constr =</span> T</span>
<span id="cb222-7"><a href="trusted.html#cb222-7" tabindex="-1"></a>)</span>
<span id="cb222-8"><a href="trusted.html#cb222-8" tabindex="-1"></a>A_proj <span class="ot">=</span> <span class="fu">inla.spde.make.A</span>(</span>
<span id="cb222-9"><a href="trusted.html#cb222-9" tabindex="-1"></a>  <span class="at">mesh =</span> mesh,</span>
<span id="cb222-10"><a href="trusted.html#cb222-10" tabindex="-1"></a>  <span class="at">loc =</span> <span class="fu">as.matrix</span>(<span class="fu">cbind</span>(</span>
<span id="cb222-11"><a href="trusted.html#cb222-11" tabindex="-1"></a>    BlackSmokePrefData<span class="sc">$</span>east, BlackSmokePrefData<span class="sc">$</span>north</span>
<span id="cb222-12"><a href="trusted.html#cb222-12" tabindex="-1"></a>  )),</span>
<span id="cb222-13"><a href="trusted.html#cb222-13" tabindex="-1"></a>  <span class="at">group =</span> BlackSmokePrefData<span class="sc">$</span>year <span class="sc">-</span> <span class="dv">65</span>,</span>
<span id="cb222-14"><a href="trusted.html#cb222-14" tabindex="-1"></a>  <span class="co"># group membership needs to be 1:no_T</span></span>
<span id="cb222-15"><a href="trusted.html#cb222-15" tabindex="-1"></a>  <span class="at">n.group =</span> no_T</span>
<span id="cb222-16"><a href="trusted.html#cb222-16" tabindex="-1"></a>)</span>
<span id="cb222-17"><a href="trusted.html#cb222-17" tabindex="-1"></a></span>
<span id="cb222-18"><a href="trusted.html#cb222-18" tabindex="-1"></a>s_index <span class="ot">=</span> <span class="fu">inla.spde.make.index</span>(<span class="at">name =</span> <span class="st">&quot;spatial.field&quot;</span>,</span>
<span id="cb222-19"><a href="trusted.html#cb222-19" tabindex="-1"></a>                               <span class="at">n.spde =</span> spde_obj<span class="sc">$</span>n.spde,</span>
<span id="cb222-20"><a href="trusted.html#cb222-20" tabindex="-1"></a>                               <span class="at">n.group =</span> no_T)</span>
<span id="cb222-21"><a href="trusted.html#cb222-21" tabindex="-1"></a>time <span class="ot">=</span> (<span class="dv">1</span><span class="sc">:</span>no_T) <span class="sc">/</span> no_T</span>
<span id="cb222-22"><a href="trusted.html#cb222-22" tabindex="-1"></a>time2 <span class="ot">=</span> time <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb222-23"><a href="trusted.html#cb222-23" tabindex="-1"></a></span>
<span id="cb222-24"><a href="trusted.html#cb222-24" tabindex="-1"></a><span class="co"># create the stack object for estimating observation process y #</span></span>
<span id="cb222-25"><a href="trusted.html#cb222-25" tabindex="-1"></a></span>
<span id="cb222-26"><a href="trusted.html#cb222-26" tabindex="-1"></a>cov_y <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb222-27"><a href="trusted.html#cb222-27" tabindex="-1"></a>  <span class="at">year =</span> <span class="fu">rep</span>(time, <span class="at">each =</span> no_sites),</span>
<span id="cb222-28"><a href="trusted.html#cb222-28" tabindex="-1"></a>  <span class="at">year_2 =</span> <span class="fu">rep</span>(time2, <span class="at">each =</span> no_sites),</span>
<span id="cb222-29"><a href="trusted.html#cb222-29" tabindex="-1"></a>  <span class="at">spatial_ind =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>no_sites, <span class="at">times =</span> no_T),</span>
<span id="cb222-30"><a href="trusted.html#cb222-30" tabindex="-1"></a>  <span class="at">spatial_ind2 =</span> no_sites <span class="sc">+</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>no_sites, <span class="at">times =</span> no_T)</span>
<span id="cb222-31"><a href="trusted.html#cb222-31" tabindex="-1"></a>) <span class="co"># site-specific random intercepts</span></span>
<span id="cb222-32"><a href="trusted.html#cb222-32" tabindex="-1"></a></span>
<span id="cb222-33"><a href="trusted.html#cb222-33" tabindex="-1"></a><span class="co"># Needs copies to include covariate twice</span></span>
<span id="cb222-34"><a href="trusted.html#cb222-34" tabindex="-1"></a></span>
<span id="cb222-35"><a href="trusted.html#cb222-35" tabindex="-1"></a>s_index_copy <span class="ot">=</span> s_index</span>
<span id="cb222-36"><a href="trusted.html#cb222-36" tabindex="-1"></a><span class="fu">names</span>(s_index_copy) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&#39;spatial.field.copy&#39;</span>,</span>
<span id="cb222-37"><a href="trusted.html#cb222-37" tabindex="-1"></a>                        <span class="st">&quot;spatial.field.group.copy&quot;</span>,</span>
<span id="cb222-38"><a href="trusted.html#cb222-38" tabindex="-1"></a>                        <span class="st">&quot;spatial.field.repl.copy&quot;</span>)</span>
<span id="cb222-39"><a href="trusted.html#cb222-39" tabindex="-1"></a></span>
<span id="cb222-40"><a href="trusted.html#cb222-40" tabindex="-1"></a>s_index_copy2 <span class="ot">=</span> s_index</span>
<span id="cb222-41"><a href="trusted.html#cb222-41" tabindex="-1"></a><span class="fu">names</span>(s_index_copy2) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&#39;spatial.field.copy2&#39;</span>,</span>
<span id="cb222-42"><a href="trusted.html#cb222-42" tabindex="-1"></a>                         <span class="st">&quot;spatial.field.group.copy2&quot;</span>,</span>
<span id="cb222-43"><a href="trusted.html#cb222-43" tabindex="-1"></a>                         <span class="st">&quot;spatial.field.repl.copy2&quot;</span>)</span>
<span id="cb222-44"><a href="trusted.html#cb222-44" tabindex="-1"></a></span>
<span id="cb222-45"><a href="trusted.html#cb222-45" tabindex="-1"></a></span>
<span id="cb222-46"><a href="trusted.html#cb222-46" tabindex="-1"></a>stack_y_est <span class="ot">=</span> <span class="fu">inla.stack</span>(</span>
<span id="cb222-47"><a href="trusted.html#cb222-47" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">list</span>(</span>
<span id="cb222-48"><a href="trusted.html#cb222-48" tabindex="-1"></a>    <span class="at">y =</span> BlackSmokePrefData<span class="sc">$</span>bsmoke,</span>
<span id="cb222-49"><a href="trusted.html#cb222-49" tabindex="-1"></a>    <span class="co">#single model</span></span>
<span id="cb222-50"><a href="trusted.html#cb222-50" tabindex="-1"></a>    <span class="at">alldata =</span> <span class="fu">cbind</span>(BlackSmokePrefData<span class="sc">$</span>bsmoke, <span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb222-51"><a href="trusted.html#cb222-51" tabindex="-1"></a>    <span class="at">Ntrials =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="at">times =</span> <span class="fu">length</span>(BlackSmokePrefData<span class="sc">$</span>bsmoke))</span>
<span id="cb222-52"><a href="trusted.html#cb222-52" tabindex="-1"></a>  ),</span>
<span id="cb222-53"><a href="trusted.html#cb222-53" tabindex="-1"></a>  <span class="co">#joint model</span></span>
<span id="cb222-54"><a href="trusted.html#cb222-54" tabindex="-1"></a>  <span class="at">A =</span> <span class="fu">list</span>(A_proj, A_proj, A_proj, <span class="dv">1</span>),</span>
<span id="cb222-55"><a href="trusted.html#cb222-55" tabindex="-1"></a>  <span class="at">effects =</span> <span class="fu">list</span>(</span>
<span id="cb222-56"><a href="trusted.html#cb222-56" tabindex="-1"></a>    <span class="fu">c</span>(s_index, <span class="fu">list</span>(<span class="at">Intercept =</span> <span class="dv">1</span>)),</span>
<span id="cb222-57"><a href="trusted.html#cb222-57" tabindex="-1"></a>    <span class="fu">c</span>(s_index_copy, <span class="fu">list</span>(<span class="at">Intercept_copy =</span> <span class="dv">1</span>)),</span>
<span id="cb222-58"><a href="trusted.html#cb222-58" tabindex="-1"></a>    <span class="fu">c</span>(s_index_copy2, <span class="fu">list</span>(<span class="at">Intercept_copy2 =</span> <span class="dv">1</span>)),</span>
<span id="cb222-59"><a href="trusted.html#cb222-59" tabindex="-1"></a>    cov_y</span>
<span id="cb222-60"><a href="trusted.html#cb222-60" tabindex="-1"></a>  ),</span>
<span id="cb222-61"><a href="trusted.html#cb222-61" tabindex="-1"></a>  <span class="at">tag =</span> <span class="st">&#39;y_est&#39;</span></span>
<span id="cb222-62"><a href="trusted.html#cb222-62" tabindex="-1"></a>)</span>
<span id="cb222-63"><a href="trusted.html#cb222-63" tabindex="-1"></a></span>
<span id="cb222-64"><a href="trusted.html#cb222-64" tabindex="-1"></a>formula_naive <span class="ot">=</span> y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> Intercept <span class="sc">+</span></span>
<span id="cb222-65"><a href="trusted.html#cb222-65" tabindex="-1"></a>  <span class="fu">f</span>(spatial.field, <span class="at">model =</span> spde_obj) <span class="sc">+</span></span>
<span id="cb222-66"><a href="trusted.html#cb222-66" tabindex="-1"></a>  <span class="fu">f</span>(spatial.field.copy, <span class="fu">I</span>(spatial.field.group.copy <span class="sc">/</span> no_T), <span class="at">model =</span> spde_obj) <span class="sc">+</span></span>
<span id="cb222-67"><a href="trusted.html#cb222-67" tabindex="-1"></a>  <span class="fu">f</span>(spatial.field.copy2, <span class="fu">I</span>((spatial.field.group.copy2 <span class="sc">/</span> no_T) <span class="sc">^</span> <span class="dv">2</span>), <span class="at">model =</span> spde_obj) <span class="sc">+</span></span>
<span id="cb222-68"><a href="trusted.html#cb222-68" tabindex="-1"></a>  <span class="fu">I</span>(spatial.field.group <span class="sc">/</span> no_T) <span class="sc">+</span> <span class="fu">I</span>((spatial.field.group <span class="sc">/</span> no_T) <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb222-69"><a href="trusted.html#cb222-69" tabindex="-1"></a>  <span class="fu">f</span>(year, <span class="at">model =</span> <span class="st">&#39;ar1&#39;</span>) <span class="sc">+</span></span>
<span id="cb222-70"><a href="trusted.html#cb222-70" tabindex="-1"></a>  <span class="fu">f</span>(spatial_ind,</span>
<span id="cb222-71"><a href="trusted.html#cb222-71" tabindex="-1"></a>    <span class="at">model =</span> <span class="st">&quot;iid2d&quot;</span>,</span>
<span id="cb222-72"><a href="trusted.html#cb222-72" tabindex="-1"></a>    <span class="at">n =</span> no_sites <span class="sc">*</span> <span class="dv">2</span>,</span>
<span id="cb222-73"><a href="trusted.html#cb222-73" tabindex="-1"></a>    <span class="at">constr =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="co">#random site-specific intercepts</span></span>
<span id="cb222-74"><a href="trusted.html#cb222-74" tabindex="-1"></a>  <span class="fu">f</span>(spatial_ind2, year, <span class="at">copy =</span> <span class="st">&quot;spatial_ind&quot;</span>)</span>
<span id="cb222-75"><a href="trusted.html#cb222-75" tabindex="-1"></a></span>
<span id="cb222-76"><a href="trusted.html#cb222-76" tabindex="-1"></a>theta.ini <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb222-77"><a href="trusted.html#cb222-77" tabindex="-1"></a>  <span class="fl">1.597900</span>,<span class="sc">-</span><span class="fl">1.277423</span>,<span class="sc">-</span><span class="fl">0.443820</span>,<span class="sc">-</span><span class="fl">1.441220</span>,</span>
<span id="cb222-78"><a href="trusted.html#cb222-78" tabindex="-1"></a>  <span class="fl">0.036510</span>,<span class="sc">-</span><span class="fl">1.441336</span>, <span class="fl">0.016919</span>, <span class="fl">4.462918</span>,</span>
<span id="cb222-79"><a href="trusted.html#cb222-79" tabindex="-1"></a>  <span class="fl">1.437147</span>, <span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb222-80"><a href="trusted.html#cb222-80" tabindex="-1"></a>out.naive <span class="ot">=</span> <span class="fu">inla</span>(</span>
<span id="cb222-81"><a href="trusted.html#cb222-81" tabindex="-1"></a>  formula_naive,</span>
<span id="cb222-82"><a href="trusted.html#cb222-82" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">&#39;gaussian&#39;</span>,</span>
<span id="cb222-83"><a href="trusted.html#cb222-83" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">inla.stack.data</span>(stack_y_est),</span>
<span id="cb222-84"><a href="trusted.html#cb222-84" tabindex="-1"></a>  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">A =</span> <span class="fu">inla.stack.A</span>(stack_y_est), <span class="at">compute =</span> F),</span>
<span id="cb222-85"><a href="trusted.html#cb222-85" tabindex="-1"></a>  <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> F, <span class="at">config =</span> T, <span class="at">cpo =</span> F),</span>
<span id="cb222-86"><a href="trusted.html#cb222-86" tabindex="-1"></a>  <span class="at">control.inla =</span> <span class="fu">list</span>(<span class="at">strategy =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="at">int.strategy =</span> <span class="st">&#39;eb&#39;</span>),</span>
<span id="cb222-87"><a href="trusted.html#cb222-87" tabindex="-1"></a>  <span class="at">control.mode =</span> <span class="fu">list</span>(<span class="at">theta =</span> theta.ini, <span class="at">restart =</span> T),</span>
<span id="cb222-88"><a href="trusted.html#cb222-88" tabindex="-1"></a>  <span class="at">verbose =</span> T,</span>
<span id="cb222-89"><a href="trusted.html#cb222-89" tabindex="-1"></a>  <span class="at">num.threads =</span> <span class="dv">2</span></span>
<span id="cb222-90"><a href="trusted.html#cb222-90" tabindex="-1"></a>)</span></code></pre></div>
<p>We can now take posteriors from the model.</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="trusted.html#cb223-1" tabindex="-1"></a>m_samples <span class="ot">=</span> <span class="dv">50</span></span>
<span id="cb223-2"><a href="trusted.html#cb223-2" tabindex="-1"></a></span>
<span id="cb223-3"><a href="trusted.html#cb223-3" tabindex="-1"></a>samp <span class="ot">&lt;-</span> <span class="fu">inla.posterior.sample</span>(m_samples, out.naive)</span>
<span id="cb223-4"><a href="trusted.html#cb223-4" tabindex="-1"></a></span>
<span id="cb223-5"><a href="trusted.html#cb223-5" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m_samples)</span>
<span id="cb223-6"><a href="trusted.html#cb223-6" tabindex="-1"></a>{</span>
<span id="cb223-7"><a href="trusted.html#cb223-7" tabindex="-1"></a>  samp[[i]]<span class="sc">$</span>latent <span class="ot">=</span> samp[[i]]<span class="sc">$</span>latent[<span class="sc">-</span><span class="fu">c</span>(<span class="fu">grep</span>(<span class="st">&#39;Predictor&#39;</span>, <span class="fu">rownames</span>(samp[[i]]<span class="sc">$</span>latent), <span class="at">fixed =</span> T)),]</span>
<span id="cb223-8"><a href="trusted.html#cb223-8" tabindex="-1"></a>}</span></code></pre></div>
<p>Finally, summarize and plot the outputs:</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="trusted.html#cb224-1" tabindex="-1"></a>stepsize <span class="ot">=</span> <span class="dv">5000</span> <span class="sc">/</span> sd_x</span>
<span id="cb224-2"><a href="trusted.html#cb224-2" tabindex="-1"></a>nxy <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="fu">diff</span>(<span class="fu">range</span>(</span>
<span id="cb224-3"><a href="trusted.html#cb224-3" tabindex="-1"></a>  BlackSmokePrefData<span class="sc">$</span>east</span>
<span id="cb224-4"><a href="trusted.html#cb224-4" tabindex="-1"></a>)),</span>
<span id="cb224-5"><a href="trusted.html#cb224-5" tabindex="-1"></a><span class="fu">diff</span>(<span class="fu">range</span>(</span>
<span id="cb224-6"><a href="trusted.html#cb224-6" tabindex="-1"></a>  BlackSmokePrefData<span class="sc">$</span>north</span>
<span id="cb224-7"><a href="trusted.html#cb224-7" tabindex="-1"></a>))) <span class="sc">/</span> stepsize)  <span class="do">## how many points?</span></span>
<span id="cb224-8"><a href="trusted.html#cb224-8" tabindex="-1"></a>proj_grid <span class="ot">=</span> <span class="fu">inla.mesh.projector</span>(</span>
<span id="cb224-9"><a href="trusted.html#cb224-9" tabindex="-1"></a>  mesh,</span>
<span id="cb224-10"><a href="trusted.html#cb224-10" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">range</span>(BlackSmokePrefData<span class="sc">$</span>east),</span>
<span id="cb224-11"><a href="trusted.html#cb224-11" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">range</span>(BlackSmokePrefData<span class="sc">$</span>north),</span>
<span id="cb224-12"><a href="trusted.html#cb224-12" tabindex="-1"></a>  <span class="at">dims =</span> nxy</span>
<span id="cb224-13"><a href="trusted.html#cb224-13" tabindex="-1"></a>)</span>
<span id="cb224-14"><a href="trusted.html#cb224-14" tabindex="-1"></a>A.grid <span class="ot">=</span> <span class="fu">inla.spde.make.A</span>(mesh,</span>
<span id="cb224-15"><a href="trusted.html#cb224-15" tabindex="-1"></a>                          <span class="at">loc =</span> <span class="fu">cbind</span>(BlackSmokePrefData<span class="sc">$</span>east, BlackSmokePrefData<span class="sc">$</span>north))</span></code></pre></div>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="trusted.html#cb225-1" tabindex="-1"></a><span class="do">## define placeholders</span></span>
<span id="cb225-2"><a href="trusted.html#cb225-2" tabindex="-1"></a></span>
<span id="cb225-3"><a href="trusted.html#cb225-3" tabindex="-1"></a>tmp2 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> no_T, <span class="at">ncol =</span> mesh<span class="sc">$</span>n)</span>
<span id="cb225-4"><a href="trusted.html#cb225-4" tabindex="-1"></a>year <span class="ot">=</span> (<span class="dv">1</span><span class="sc">:</span>no_T) <span class="sc">/</span> no_T</span>
<span id="cb225-5"><a href="trusted.html#cb225-5" tabindex="-1"></a>year2 <span class="ot">=</span> year <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb225-6"><a href="trusted.html#cb225-6" tabindex="-1"></a>Post_Array2 <span class="ot">=</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(m_samples, no_T, mesh<span class="sc">$</span>n))</span>
<span id="cb225-7"><a href="trusted.html#cb225-7" tabindex="-1"></a>Post_Sites_Array2 <span class="ot">=</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(m_samples, no_T, <span class="fu">dim</span>(BlackSmokePrefData)[<span class="dv">1</span>]))</span>
<span id="cb225-8"><a href="trusted.html#cb225-8" tabindex="-1"></a>residuals_array <span class="ot">=</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(m_samples, no_T, <span class="fu">dim</span>(BlackSmokePrefData)[<span class="dv">1</span>]))</span>
<span id="cb225-9"><a href="trusted.html#cb225-9" tabindex="-1"></a>RI_array <span class="ot">=</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(m_samples, no_T, <span class="fu">dim</span>(BlackSmokePrefData)[<span class="dv">1</span>])) <span class="co"># random intercepts</span></span>
<span id="cb225-10"><a href="trusted.html#cb225-10" tabindex="-1"></a>RS_array <span class="ot">=</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(m_samples, no_T, <span class="fu">dim</span>(BlackSmokePrefData)[<span class="dv">1</span>])) <span class="co"># random slopes</span></span>
<span id="cb225-11"><a href="trusted.html#cb225-11" tabindex="-1"></a></span>
<span id="cb225-12"><a href="trusted.html#cb225-12" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m_samples) {</span>
<span id="cb225-13"><a href="trusted.html#cb225-13" tabindex="-1"></a>  <span class="co"># Creating predictions for Y process</span></span>
<span id="cb225-14"><a href="trusted.html#cb225-14" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>no_T)</span>
<span id="cb225-15"><a href="trusted.html#cb225-15" tabindex="-1"></a>    <span class="co"># loop over the years</span></span>
<span id="cb225-16"><a href="trusted.html#cb225-16" tabindex="-1"></a>  {</span>
<span id="cb225-17"><a href="trusted.html#cb225-17" tabindex="-1"></a>    Post_Array2[i, j,] <span class="ot">&lt;-</span> samp[[i]]<span class="sc">$</span>latent[<span class="st">&#39;Intercept:1&#39;</span>] <span class="sc">+</span> <span class="co"># Intercept</span></span>
<span id="cb225-18"><a href="trusted.html#cb225-18" tabindex="-1"></a>      samp[[i]]<span class="sc">$</span>latent[<span class="fu">which</span>(base<span class="sc">::</span><span class="fu">startsWith</span>(<span class="at">prefix =</span> <span class="st">&#39;year:&#39;</span>, </span>
<span id="cb225-19"><a href="trusted.html#cb225-19" tabindex="-1"></a>                                        <span class="at">x =</span> <span class="fu">names</span>(samp[[i]]<span class="sc">$</span>latent)))][j] <span class="sc">*</span> year[j] <span class="sc">+</span> <span class="co"># linear fixed effect</span></span>
<span id="cb225-20"><a href="trusted.html#cb225-20" tabindex="-1"></a>      <span class="co">#samp[[i]]$latent[&#39;year_2&#39;] * year2[j] + # quadratic fixed effect</span></span>
<span id="cb225-21"><a href="trusted.html#cb225-21" tabindex="-1"></a>      <span class="fu">as.numeric</span>(samp[[i]]<span class="sc">$</span>latent[<span class="fu">which</span>(base<span class="sc">::</span><span class="fu">startsWith</span>(<span class="at">prefix =</span> <span class="st">&#39;spatial.field:&#39;</span>, <span class="at">x =</span> <span class="fu">names</span>(samp[[i]]<span class="sc">$</span>latent)))]) <span class="sc">+</span> <span class="co"># Spatial Intercept</span></span>
<span id="cb225-22"><a href="trusted.html#cb225-22" tabindex="-1"></a>      <span class="fu">as.numeric</span>(samp[[i]]<span class="sc">$</span>latent[base<span class="sc">::</span><span class="fu">which</span>(<span class="fu">startsWith</span>(<span class="at">prefix =</span> <span class="st">&#39;spatial.field.copy:&#39;</span>, <span class="at">x =</span> <span class="fu">names</span>(samp[[i]]<span class="sc">$</span>latent)))]) <span class="sc">*</span> year[j] <span class="sc">+</span> <span class="co"># Spatial linear slope</span></span>
<span id="cb225-23"><a href="trusted.html#cb225-23" tabindex="-1"></a>      <span class="fu">as.numeric</span>(samp[[i]]<span class="sc">$</span>latent[<span class="fu">which</span>(base<span class="sc">::</span><span class="fu">startsWith</span>(<span class="at">prefix =</span> <span class="st">&#39;spatial.field.copy2:&#39;</span>, <span class="at">x =</span> <span class="fu">names</span>(samp[[i]]<span class="sc">$</span>latent)))]) <span class="sc">*</span> year2[j]  <span class="co"># Spatial quadratic slope</span></span>
<span id="cb225-24"><a href="trusted.html#cb225-24" tabindex="-1"></a>    <span class="co"># Project onto the site locations and add random site-specific effects #</span></span>
<span id="cb225-25"><a href="trusted.html#cb225-25" tabindex="-1"></a>    Post_Sites_Array2[i, j,] <span class="ot">=</span> <span class="fu">as.numeric</span>(A.grid <span class="sc">%*%</span> Post_Array2[i, j,]) <span class="sc">+</span></span>
<span id="cb225-26"><a href="trusted.html#cb225-26" tabindex="-1"></a>      <span class="fu">as.numeric</span>(samp[[i]]<span class="sc">$</span>latent[<span class="fu">which</span>(base<span class="sc">::</span><span class="fu">startsWith</span>(<span class="at">prefix =</span> <span class="st">&#39;spatial_ind:&#39;</span>, <span class="at">x =</span> <span class="fu">names</span>(samp[[i]]<span class="sc">$</span>latent)))[<span class="dv">1</span><span class="sc">:</span>no_sites]]) <span class="sc">+</span> <span class="co"># random Intercept</span></span>
<span id="cb225-27"><a href="trusted.html#cb225-27" tabindex="-1"></a>      <span class="fu">as.numeric</span>(samp[[i]]<span class="sc">$</span>latent[<span class="fu">which</span>(base<span class="sc">::</span><span class="fu">startsWith</span>(<span class="at">prefix =</span> <span class="st">&#39;spatial_ind2:&#39;</span>, <span class="at">x =</span> <span class="fu">names</span>(samp[[i]]<span class="sc">$</span>latent)))[no_sites <span class="sc">+</span></span>
<span id="cb225-28"><a href="trusted.html#cb225-28" tabindex="-1"></a>                                                                                                             (<span class="dv">1</span><span class="sc">:</span>no_sites)]]) <span class="sc">*</span> year[j] <span class="co"># random slope</span></span>
<span id="cb225-29"><a href="trusted.html#cb225-29" tabindex="-1"></a>    <span class="co"># Extract the random intercepts #</span></span>
<span id="cb225-30"><a href="trusted.html#cb225-30" tabindex="-1"></a>    RI_array[i, j,] <span class="ot">=</span> <span class="fu">as.numeric</span>(samp[[i]]<span class="sc">$</span>latent[<span class="fu">which</span>(base<span class="sc">::</span><span class="fu">startsWith</span>(<span class="at">prefix =</span> <span class="st">&#39;spatial_ind:&#39;</span>, <span class="at">x =</span> <span class="fu">names</span>(samp[[i]]<span class="sc">$</span>latent)))[<span class="dv">1</span><span class="sc">:</span>no_sites]])</span>
<span id="cb225-31"><a href="trusted.html#cb225-31" tabindex="-1"></a>    </span>
<span id="cb225-32"><a href="trusted.html#cb225-32" tabindex="-1"></a>    <span class="co"># Extract the random slopes #</span></span>
<span id="cb225-33"><a href="trusted.html#cb225-33" tabindex="-1"></a>    RS_array[i, j,] <span class="ot">=</span> <span class="fu">as.numeric</span>(samp[[i]]<span class="sc">$</span>latent[<span class="fu">which</span>(base<span class="sc">::</span><span class="fu">startsWith</span>(<span class="at">prefix =</span> <span class="st">&#39;spatial_ind2:&#39;</span>, <span class="at">x =</span> <span class="fu">names</span>(samp[[i]]<span class="sc">$</span>latent)))[no_sites <span class="sc">+</span></span>
<span id="cb225-34"><a href="trusted.html#cb225-34" tabindex="-1"></a>                                                                                                                             (<span class="dv">1</span><span class="sc">:</span>no_sites)]])</span>
<span id="cb225-35"><a href="trusted.html#cb225-35" tabindex="-1"></a>  }</span>
<span id="cb225-36"><a href="trusted.html#cb225-36" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="trusted.html#cb226-1" tabindex="-1"></a><span class="do">## summarizing</span></span>
<span id="cb226-2"><a href="trusted.html#cb226-2" tabindex="-1"></a></span>
<span id="cb226-3"><a href="trusted.html#cb226-3" tabindex="-1"></a>Post_mean2 <span class="ot">&lt;-</span></span>
<span id="cb226-4"><a href="trusted.html#cb226-4" tabindex="-1"></a>  <span class="fu">t</span>(<span class="fu">apply</span>(Post_Array2, <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="cf">function</span>(x) {</span>
<span id="cb226-5"><a href="trusted.html#cb226-5" tabindex="-1"></a>    <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb226-6"><a href="trusted.html#cb226-6" tabindex="-1"></a>  }))</span>
<span id="cb226-7"><a href="trusted.html#cb226-7" tabindex="-1"></a>Post_sd2 <span class="ot">&lt;-</span></span>
<span id="cb226-8"><a href="trusted.html#cb226-8" tabindex="-1"></a>  <span class="fu">t</span>(<span class="fu">apply</span>(Post_Array2, <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="cf">function</span>(x) {</span>
<span id="cb226-9"><a href="trusted.html#cb226-9" tabindex="-1"></a>    <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb226-10"><a href="trusted.html#cb226-10" tabindex="-1"></a>  }))</span>
<span id="cb226-11"><a href="trusted.html#cb226-11" tabindex="-1"></a>Post_LCL2 <span class="ot">&lt;-</span></span>
<span id="cb226-12"><a href="trusted.html#cb226-12" tabindex="-1"></a>  <span class="fu">apply</span>((<span class="fu">apply</span>(Post_Array2, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="cf">function</span>(x) {</span>
<span id="cb226-13"><a href="trusted.html#cb226-13" tabindex="-1"></a>    <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb226-14"><a href="trusted.html#cb226-14" tabindex="-1"></a>  })), <span class="dv">2</span>, quantile, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>))</span>
<span id="cb226-15"><a href="trusted.html#cb226-15" tabindex="-1"></a>Post_UCL2 <span class="ot">&lt;-</span></span>
<span id="cb226-16"><a href="trusted.html#cb226-16" tabindex="-1"></a>  <span class="fu">apply</span>((<span class="fu">apply</span>(Post_Array2, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="cf">function</span>(x) {</span>
<span id="cb226-17"><a href="trusted.html#cb226-17" tabindex="-1"></a>    <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb226-18"><a href="trusted.html#cb226-18" tabindex="-1"></a>  })), <span class="dv">2</span>, quantile, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.975</span>))</span>
<span id="cb226-19"><a href="trusted.html#cb226-19" tabindex="-1"></a>RI_array <span class="ot">&lt;-</span></span>
<span id="cb226-20"><a href="trusted.html#cb226-20" tabindex="-1"></a>  <span class="fu">t</span>(<span class="fu">apply</span>(RI_array, <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="cf">function</span>(x) {</span>
<span id="cb226-21"><a href="trusted.html#cb226-21" tabindex="-1"></a>    <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb226-22"><a href="trusted.html#cb226-22" tabindex="-1"></a>  }))</span>
<span id="cb226-23"><a href="trusted.html#cb226-23" tabindex="-1"></a>RS_array <span class="ot">&lt;-</span></span>
<span id="cb226-24"><a href="trusted.html#cb226-24" tabindex="-1"></a>  <span class="fu">t</span>(<span class="fu">apply</span>(RS_array, <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="cf">function</span>(x) {</span>
<span id="cb226-25"><a href="trusted.html#cb226-25" tabindex="-1"></a>    <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb226-26"><a href="trusted.html#cb226-26" tabindex="-1"></a>  }))</span></code></pre></div>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="trusted.html#cb227-1" tabindex="-1"></a><span class="do">## placeholders for uniform grid posterior blacksmoke values (not necessarily in dataset)</span></span>
<span id="cb227-2"><a href="trusted.html#cb227-2" tabindex="-1"></a></span>
<span id="cb227-3"><a href="trusted.html#cb227-3" tabindex="-1"></a>post_Matrix_grid_mean2 <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(nxy[<span class="dv">1</span>], nxy[<span class="dv">2</span>], no_T))</span>
<span id="cb227-4"><a href="trusted.html#cb227-4" tabindex="-1"></a>post_Matrix_grid_sd2 <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(nxy[<span class="dv">1</span>], nxy[<span class="dv">2</span>], no_T))</span>
<span id="cb227-5"><a href="trusted.html#cb227-5" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>no_T)</span>
<span id="cb227-6"><a href="trusted.html#cb227-6" tabindex="-1"></a>{</span>
<span id="cb227-7"><a href="trusted.html#cb227-7" tabindex="-1"></a>  post_Matrix_grid_mean2[, , i] <span class="ot">=</span> <span class="fu">inla.mesh.project</span>(proj_grid, Post_mean2[, i])</span>
<span id="cb227-8"><a href="trusted.html#cb227-8" tabindex="-1"></a>  post_Matrix_grid_sd2[, , i] <span class="ot">=</span> <span class="fu">inla.mesh.project</span>(proj_grid, Post_sd2[, i])</span>
<span id="cb227-9"><a href="trusted.html#cb227-9" tabindex="-1"></a>}</span>
<span id="cb227-10"><a href="trusted.html#cb227-10" tabindex="-1"></a></span>
<span id="cb227-11"><a href="trusted.html#cb227-11" tabindex="-1"></a><span class="do">## placeholders for observed (R1 = active, R0 = inactive) site blacksmoke values</span></span>
<span id="cb227-12"><a href="trusted.html#cb227-12" tabindex="-1"></a></span>
<span id="cb227-13"><a href="trusted.html#cb227-13" tabindex="-1"></a>R1_results2 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> no_T, <span class="at">ncol =</span> <span class="dv">4</span>) <span class="co"># prediction means, sd, LCL, UCL</span></span>
<span id="cb227-14"><a href="trusted.html#cb227-14" tabindex="-1"></a><span class="fu">colnames</span>(R1_results2) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&#39;prediction mean&#39;</span>, <span class="st">&#39;prediction sd&#39;</span>, <span class="st">&#39;LCL&#39;</span>, <span class="st">&#39;UCL&#39;</span>)</span>
<span id="cb227-15"><a href="trusted.html#cb227-15" tabindex="-1"></a>R0_results2 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> no_T, <span class="at">ncol =</span> <span class="dv">4</span>) <span class="co"># prediction means, sd, LCL, UCL</span></span>
<span id="cb227-16"><a href="trusted.html#cb227-16" tabindex="-1"></a><span class="fu">colnames</span>(R0_results2) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&#39;prediction mean&#39;</span>, <span class="st">&#39;prediction sd&#39;</span>, <span class="st">&#39;LCL&#39;</span>, <span class="st">&#39;UCL&#39;</span>)</span>
<span id="cb227-17"><a href="trusted.html#cb227-17" tabindex="-1"></a>Grid_results2 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> no_T, <span class="at">ncol =</span> <span class="dv">4</span>) <span class="co"># prediction means, sd, LCL, UCL</span></span>
<span id="cb227-18"><a href="trusted.html#cb227-18" tabindex="-1"></a><span class="fu">colnames</span>(Grid_results2) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&#39;prediction mean&#39;</span>, <span class="st">&#39;prediction sd&#39;</span>, <span class="st">&#39;LCL&#39;</span>, <span class="st">&#39;UCL&#39;</span>)</span>
<span id="cb227-19"><a href="trusted.html#cb227-19" tabindex="-1"></a></span>
<span id="cb227-20"><a href="trusted.html#cb227-20" tabindex="-1"></a>BlackSmokePrefData_original <span class="ot">&lt;-</span></span>
<span id="cb227-21"><a href="trusted.html#cb227-21" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="st">&quot;data/black_smoke/BlackSmokePrefData.csv&quot;</span>) <span class="do">## need original columns here</span></span>
<span id="cb227-22"><a href="trusted.html#cb227-22" tabindex="-1"></a></span>
<span id="cb227-23"><a href="trusted.html#cb227-23" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>no_T)</span>
<span id="cb227-24"><a href="trusted.html#cb227-24" tabindex="-1"></a>{</span>
<span id="cb227-25"><a href="trusted.html#cb227-25" tabindex="-1"></a>  R1_results2[j, <span class="dv">1</span>] <span class="ot">=</span> <span class="fu">mean</span>(Post_Sites_Array2[, j, <span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(BlackSmokePrefData_original[, <span class="dv">3</span> <span class="sc">+</span></span>
<span id="cb227-26"><a href="trusted.html#cb227-26" tabindex="-1"></a>                                                                                             j]))], <span class="at">na.rm =</span> T)</span>
<span id="cb227-27"><a href="trusted.html#cb227-27" tabindex="-1"></a>  R1_results2[j, <span class="dv">2</span>] <span class="ot">=</span> <span class="fu">sd</span>(<span class="fu">apply</span>(Post_Sites_Array2[, j, <span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(BlackSmokePrefData_original[, <span class="dv">3</span> <span class="sc">+</span></span>
<span id="cb227-28"><a href="trusted.html#cb227-28" tabindex="-1"></a>                                                                                                 j]))], <span class="fu">c</span>(<span class="dv">1</span>), mean, <span class="at">na.rm =</span> T))</span>
<span id="cb227-29"><a href="trusted.html#cb227-29" tabindex="-1"></a>  R1_results2[j, <span class="dv">3</span>] <span class="ot">=</span> <span class="fu">quantile</span>(<span class="fu">apply</span>(Post_Sites_Array2[, j, <span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(BlackSmokePrefData_original[, <span class="dv">3</span> <span class="sc">+</span></span>
<span id="cb227-30"><a href="trusted.html#cb227-30" tabindex="-1"></a>                                                                                                       j]))], <span class="dv">1</span>, mean, <span class="at">na.rm =</span> T), <span class="at">probs =</span> <span class="fl">0.025</span>)</span>
<span id="cb227-31"><a href="trusted.html#cb227-31" tabindex="-1"></a>  R1_results2[j, <span class="dv">4</span>] <span class="ot">=</span> <span class="fu">quantile</span>(<span class="fu">apply</span>(Post_Sites_Array2[, j, <span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(BlackSmokePrefData_original[, <span class="dv">3</span> <span class="sc">+</span></span>
<span id="cb227-32"><a href="trusted.html#cb227-32" tabindex="-1"></a>                                                                                                       j]))], <span class="dv">1</span>, mean, <span class="at">na.rm =</span> T), <span class="at">probs =</span> <span class="fl">0.975</span>)</span>
<span id="cb227-33"><a href="trusted.html#cb227-33" tabindex="-1"></a>  </span>
<span id="cb227-34"><a href="trusted.html#cb227-34" tabindex="-1"></a>  R0_results2[j, <span class="dv">1</span>] <span class="ot">=</span> <span class="fu">mean</span>(Post_Sites_Array2[, j, <span class="fu">which</span>(<span class="fu">is.na</span>(BlackSmokePrefData_original[, <span class="dv">3</span> <span class="sc">+</span></span>
<span id="cb227-35"><a href="trusted.html#cb227-35" tabindex="-1"></a>                                                                                            j]))], <span class="at">na.rm =</span> T)</span>
<span id="cb227-36"><a href="trusted.html#cb227-36" tabindex="-1"></a>  R0_results2[j, <span class="dv">2</span>] <span class="ot">=</span> <span class="fu">sd</span>(<span class="fu">apply</span>(Post_Sites_Array2[, j, <span class="fu">which</span>(<span class="fu">is.na</span>(BlackSmokePrefData_original[, <span class="dv">3</span> <span class="sc">+</span></span>
<span id="cb227-37"><a href="trusted.html#cb227-37" tabindex="-1"></a>                                                                                                j]))], <span class="fu">c</span>(<span class="dv">1</span>), mean, <span class="at">na.rm =</span> T))</span>
<span id="cb227-38"><a href="trusted.html#cb227-38" tabindex="-1"></a>  R0_results2[j, <span class="dv">3</span>] <span class="ot">=</span> <span class="fu">quantile</span>(<span class="fu">apply</span>(Post_Sites_Array2[, j, <span class="fu">which</span>(<span class="fu">is.na</span>(BlackSmokePrefData_original[, <span class="dv">3</span> <span class="sc">+</span></span>
<span id="cb227-39"><a href="trusted.html#cb227-39" tabindex="-1"></a>                                                                                                      j]))], <span class="dv">1</span>, mean, <span class="at">na.rm =</span> T), <span class="at">probs =</span> <span class="fl">0.025</span>)</span>
<span id="cb227-40"><a href="trusted.html#cb227-40" tabindex="-1"></a>  R0_results2[j, <span class="dv">4</span>] <span class="ot">=</span> <span class="fu">quantile</span>(<span class="fu">apply</span>(Post_Sites_Array2[, j, <span class="fu">which</span>(<span class="fu">is.na</span>(BlackSmokePrefData_original[, <span class="dv">3</span> <span class="sc">+</span></span>
<span id="cb227-41"><a href="trusted.html#cb227-41" tabindex="-1"></a>                                                                                                      j]))], <span class="dv">1</span>, mean, <span class="at">na.rm =</span> T), <span class="at">probs =</span> <span class="fl">0.975</span>)</span>
<span id="cb227-42"><a href="trusted.html#cb227-42" tabindex="-1"></a>}</span>
<span id="cb227-43"><a href="trusted.html#cb227-43" tabindex="-1"></a></span>
<span id="cb227-44"><a href="trusted.html#cb227-44" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>no_T)</span>
<span id="cb227-45"><a href="trusted.html#cb227-45" tabindex="-1"></a>{</span>
<span id="cb227-46"><a href="trusted.html#cb227-46" tabindex="-1"></a>  Grid_results2[i, <span class="dv">1</span>] <span class="ot">=</span> <span class="fu">mean</span>(post_Matrix_grid_mean2[, , i], <span class="at">na.rm =</span> T)</span>
<span id="cb227-47"><a href="trusted.html#cb227-47" tabindex="-1"></a>  Grid_results2[i, <span class="dv">2</span>] <span class="ot">=</span> <span class="fu">mean</span>(post_Matrix_grid_sd2[, , i], <span class="at">na.rm =</span> T)</span>
<span id="cb227-48"><a href="trusted.html#cb227-48" tabindex="-1"></a>}</span>
<span id="cb227-49"><a href="trusted.html#cb227-49" tabindex="-1"></a>Grid_results2[, <span class="dv">3</span>] <span class="ot">=</span> Post_LCL2</span>
<span id="cb227-50"><a href="trusted.html#cb227-50" tabindex="-1"></a>Grid_results2[, <span class="dv">4</span>] <span class="ot">=</span> Post_UCL2</span>
<span id="cb227-51"><a href="trusted.html#cb227-51" tabindex="-1"></a></span>
<span id="cb227-52"><a href="trusted.html#cb227-52" tabindex="-1"></a><span class="do">## Revert to the original scale (exponentiating and scaling up)</span></span>
<span id="cb227-53"><a href="trusted.html#cb227-53" tabindex="-1"></a>Grid_df_2 <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb227-54"><a href="trusted.html#cb227-54" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">exp</span>(<span class="fu">c</span>(</span>
<span id="cb227-55"><a href="trusted.html#cb227-55" tabindex="-1"></a>    Grid_results2[, <span class="dv">1</span>], R1_results2[, <span class="dv">1</span>], R0_results2[, <span class="dv">1</span>]</span>
<span id="cb227-56"><a href="trusted.html#cb227-56" tabindex="-1"></a>  )) <span class="sc">*</span> <span class="fu">mean</span>(yearmeans),</span>
<span id="cb227-57"><a href="trusted.html#cb227-57" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">rep</span>(<span class="dv">66</span><span class="sc">:</span><span class="dv">96</span>, <span class="at">times =</span> <span class="dv">3</span>),</span>
<span id="cb227-58"><a href="trusted.html#cb227-58" tabindex="-1"></a>  <span class="at">ymin =</span> <span class="fu">exp</span>(<span class="fu">c</span>(Post_LCL2, R1_results2[, <span class="dv">3</span>], R0_results2[, <span class="dv">3</span>])) <span class="sc">*</span></span>
<span id="cb227-59"><a href="trusted.html#cb227-59" tabindex="-1"></a>    <span class="fu">mean</span>(yearmeans),</span>
<span id="cb227-60"><a href="trusted.html#cb227-60" tabindex="-1"></a>  <span class="at">ymax =</span> <span class="fu">exp</span>(<span class="fu">c</span>(Post_UCL2, R1_results2[, <span class="dv">4</span>], R0_results2[, <span class="dv">4</span>])) <span class="sc">*</span></span>
<span id="cb227-61"><a href="trusted.html#cb227-61" tabindex="-1"></a>    <span class="fu">mean</span>(yearmeans),</span>
<span id="cb227-62"><a href="trusted.html#cb227-62" tabindex="-1"></a>  <span class="at">group =</span> <span class="fu">c</span>(</span>
<span id="cb227-63"><a href="trusted.html#cb227-63" tabindex="-1"></a>    <span class="fu">rep</span>(<span class="st">&#39;Whole UK&#39;</span>, <span class="at">times =</span> <span class="dv">31</span>),</span>
<span id="cb227-64"><a href="trusted.html#cb227-64" tabindex="-1"></a>    <span class="fu">rep</span>(<span class="st">&#39;R1&#39;</span>, <span class="at">times =</span> <span class="dv">31</span>),</span>
<span id="cb227-65"><a href="trusted.html#cb227-65" tabindex="-1"></a>    <span class="fu">rep</span>(<span class="st">&#39;R0&#39;</span>, <span class="at">times =</span> <span class="dv">31</span>)</span>
<span id="cb227-66"><a href="trusted.html#cb227-66" tabindex="-1"></a>  )</span>
<span id="cb227-67"><a href="trusted.html#cb227-67" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="trusted.html#cb228-1" tabindex="-1"></a><span class="do">## plotting</span></span>
<span id="cb228-2"><a href="trusted.html#cb228-2" tabindex="-1"></a></span>
<span id="cb228-3"><a href="trusted.html#cb228-3" tabindex="-1"></a>Grid_plot_2 <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb228-4"><a href="trusted.html#cb228-4" tabindex="-1"></a>  <span class="at">x =</span> x,</span>
<span id="cb228-5"><a href="trusted.html#cb228-5" tabindex="-1"></a>  <span class="at">y =</span> y,</span>
<span id="cb228-6"><a href="trusted.html#cb228-6" tabindex="-1"></a>  <span class="at">ymin =</span> ymin,</span>
<span id="cb228-7"><a href="trusted.html#cb228-7" tabindex="-1"></a>  <span class="at">ymax =</span> ymax,</span>
<span id="cb228-8"><a href="trusted.html#cb228-8" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="fl">0.05</span></span>
<span id="cb228-9"><a href="trusted.html#cb228-9" tabindex="-1"></a>), <span class="at">data =</span> Grid_df_2) <span class="sc">+</span></span>
<span id="cb228-10"><a href="trusted.html#cb228-10" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(</span>
<span id="cb228-11"><a href="trusted.html#cb228-11" tabindex="-1"></a>    <span class="at">colour =</span> group,</span>
<span id="cb228-12"><a href="trusted.html#cb228-12" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.05</span>,</span>
<span id="cb228-13"><a href="trusted.html#cb228-13" tabindex="-1"></a>    <span class="at">fill =</span> group</span>
<span id="cb228-14"><a href="trusted.html#cb228-14" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb228-15"><a href="trusted.html#cb228-15" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&#39;year&#39;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&#39;posterior mean bs on transformed scale&#39;</span>) <span class="sc">+</span></span>
<span id="cb228-16"><a href="trusted.html#cb228-16" tabindex="-1"></a>  <span class="fu">ggtitle</span>(</span>
<span id="cb228-17"><a href="trusted.html#cb228-17" tabindex="-1"></a>    <span class="st">&#39;Naive posterior means of BS at the selected, unselected sites and across the UK (R1, R0 and Whole UK resp.). &#39;</span></span>
<span id="cb228-18"><a href="trusted.html#cb228-18" tabindex="-1"></a>  )</span>
<span id="cb228-19"><a href="trusted.html#cb228-19" tabindex="-1"></a>Grid_plot_2</span></code></pre></div>
<p><img src="_main_files/figure-html/Exercise%20plotting-1.png" width="672" /></p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="Strategies.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="Disease.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/08-Chpt8.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
